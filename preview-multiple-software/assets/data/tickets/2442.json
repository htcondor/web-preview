{"id": 2442, "title": "Ticket #2442: submitter records deleted when prio-factor set to DEFAULT_PRIO_FACTOR", "description": "<blockquote>\nThe accountant has logic for detecting when a submitter record has an explicit priority factor set on it, to prevent record deletion.  This is to preserve the explicit setting.\n\n<p>However, this check currently is keyed off of whether the priority-factor == the default factor, which causes incorrect deletion if the user explicitly sets the factor to that default value.  This is particularly evident if there is a group priority factor default set, which is different than DEFAULT_PRIO_FACTOR.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-07 16:23:07 by eje:</em> <br/>\n\nREPRO/TEST\n\n<p>Using the following configuration:\n</p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nNEGOTIATOR_INTERVAL = 30\nSCHEDD_INTERVAL\t= 15\nNEGOTIATOR_USE_SLOT_WEIGHTS = FALSE\nGROUP_QUOTA_MAX_ALLOCATION_ROUNDS = 1\n\nNUM_CPUS = 10\n\nGROUP_NAMES = a\nGROUP_QUOTA_a = 10\nGROUP_PRIO_FACTOR_a = 4.0\nGROUP_ACCEPT_SURPLUS_a = TRUE\n</pre></div>\n\n\n<p>To reproduce, set the prio-factor on \"a.u1\" to be 1, and \"a.u2\" to be 2.  Before the fix, the entry for \"a.u1\" will be deleted on the next accountant update, because its prio-factor was set to DEFAULT_PRIO_FACTOR (=1):\n</p><div class=\"code\">\n<pre class=\"code\"># when the pool starts up, we have only entries for \"a\" and \"&lt;none&gt;\"\n[eje@rorschach ~]$ condor_userprio -l | grep -e '^Name' -e '^PriorityFactor'\nName1 = \"a\"\nName2 = \"&lt;none&gt;\"\nPriorityFactor1 = 4.000000\nPriorityFactor2 = 1.000000\n\n# now set prio-factor for \"a.u1\" and \"a.u2\"\n[eje@rorschach ~]$ condor_userprio -setfactor a.u1@localdomain 1\nThe priority factor of a.u1@localdomain was set to 1.000000\n[eje@rorschach ~]$ condor_userprio -setfactor a.u2@localdomain 2\nThe priority factor of a.u2@localdomain was set to 2.000000\n\n# immediately after setting, we see entries for \"a.u1\" and \"a.u2\"\n[eje@rorschach ~]$ condor_userprio -l | grep -e '^Name' -e '^PriorityFactor'\nName1 = \"a\"\nName2 = \"&lt;none&gt;\"\nName3 = \"a.u2@localdomain\"\nName4 = \"a.u1@localdomain\"\nPriorityFactor1 = 4.000000\nPriorityFactor2 = 1.000000\nPriorityFactor3 = 2.000000\nPriorityFactor4 = 1.000000\n\n# next time the accountant updates, the entry for \"a.u1\" is erased, because its prio factor happened to be equal to DEFAULT_PRIO_FACTOR.  \"a.u2\" still exists.\n[eje@rorschach ~]$ condor_userprio -l | grep -e '^Name' -e '^PriorityFactor'\nName1 = \"a\"\nName2 = \"&lt;none&gt;\"\nName3 = \"a.u2@localdomain\"\nPriorityFactor1 = 4.000000\nPriorityFactor2 = 1.000000\nPriorityFactor3 = 2.000000\n</pre></div>\n\n\n<p>After the fix, we see that the entry for \"a.u1\" does not get removed, which is the correct behavior\n</p><div class=\"code\">\n<pre class=\"code\"># accountant entries before any submitters:\n[eje@rorschach ~]$ condor_userprio -l | grep -e '^Name' -e '^PriorityFactor'\nName1 = \"a\"\nName2 = \"&lt;none&gt;\"\nPriorityFactor1 = 4.000000\nPriorityFactor2 = 1.000000\n\n# set prio factor for \"a.u1\" and \"a.u2\" as before:\n[eje@rorschach ~]$ condor_userprio -setfactor a.u1@localdomain 1\nThe priority factor of a.u1@localdomain was set to 1.000000\n[eje@rorschach ~]$ condor_userprio -setfactor a.u2@localdomain 2\nThe priority factor of a.u2@localdomain was set to 2.000000\n\n# entries immediately after setting prio factors:\n[eje@rorschach ~]$ condor_userprio -l | grep -e '^Name' -e '^PriorityFactor'\nName1 = \"a\"\nName2 = \"&lt;none&gt;\"\nName3 = \"a.u2@localdomain\"\nName4 = \"a.u1@localdomain\"\nPriorityFactor1 = 4.000000\nPriorityFactor2 = 1.000000\nPriorityFactor3 = 2.000000\nPriorityFactor4 = 1.000000\n\n# Now we see that both \"a.u1\" and \"a.u2\" still exist after update, as expected:\n[eje@rorschach ~]$ condor_userprio -l | grep -e '^Name' -e '^PriorityFactor'\nName1 = \"a\"\nName2 = \"&lt;none&gt;\"\nName3 = \"a.u2@localdomain\"\nName4 = \"a.u1@localdomain\"\nPriorityFactor1 = 4.000000\nPriorityFactor2 = 1.000000\nPriorityFactor3 = 2.000000\nPriorityFactor4 = 1.000000\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Sep-23 16:06:07 by danb:</em> <br/>\n\nCode review: looks good.  Thanks, Erik!\n\n<p>--Dan</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-18 10:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e8189688013c74b94c82e60962b8ecb38fec2497\">[27876]</a></span>: edit of 7.6.4 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2442\" onclick=\"get_ticket_and_populate_wrapper('2442'); return false;\" title=\"submitter records deleted when prio-factor set to DEFAULT_PRIO_FACTOR\">#2442</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2522\" onclick=\"get_ticket_and_populate_wrapper('2522'); return false;\" title='document the \"accountant\" so manual readers know what it is'>#2522</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-07 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89de85ab2875ff472de457d58d1af083b8b21bbf\">[27122]</a></span>: Corrected check in the acct that allowed submitter records to be deleted if the submitter's prio-factor was explicitly set and the value was equal to DEFAULT_PRIO_FACTOR. ===VersionHistory:Complete=== ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2442\" onclick=\"get_ticket_and_populate_wrapper('2442'); return false;\" title=\"submitter records deleted when prio-factor set to DEFAULT_PRIO_FACTOR\">#2442</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Sep-23 16:06", "status": "resolved", "created": "2011-Sep-07 15:48", "fixed_version": "2011-Sep-07 15:48", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, dan@hep.wisc.edu, eje@cs.wisc.edu", "due_date": ""}