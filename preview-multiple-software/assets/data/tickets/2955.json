{"id": 2955, "title": "Ticket #2955: JobRouter sandbox management", "description": "<blockquote>\nI've got the following setup:\n<ol>\n<li>Condor-C job submits to a remote schedd.\n</li><li>Remote schedd has <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> running.\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> transforms the job to another vanilla universe job.\n</li></ol>\n\n<p>Let's call these jobs (1), (2), and (3) respectively.  The remote schedd will create a spool for job (2), owned by user condor.  However, when job (3) finishes, it will stageout to the spool for job (2) as the target user (bbockelm in this case).  As the directory is owned by condor and the shadow is running as bbockelm... no dice.\n\n</p><p>On advice of Dan, I added \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobShouldBeSandboxed\" title=\"Job Should Be Sandboxed\">JobShouldBeSandboxed</a></span> = true\" to have the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> create a separate sandbox.  This <strong>almost</strong> works, except the Iwd for job (3) is still set to the spool of job (2).</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-27 15:12:26 by danb:</em> <br/>\n\nWhen using <code>JobShouldBeSandboxed</code> when routing spooled jobs, I found that it is necessary to include the following command in the routing table:\n\n<p></p><pre>    delete_SUBMIT_Iwd = true\n</pre>\n\n<p>Without that, the schedd skips over its usual rewriting of the Iwd for the newly spooled job, because it thinks it has already done it.\n\n</p><p>Brian and I previously found that we needed to also add the following line:\n\n</p><p></p><pre>    delete_StageInFinish = true\n</pre>\n\n<p>I will make it work out of the box and also continue to investigate the problem of sandbox ownership when not using <code>JobShouldBeSandboxed</code>.\n\n</p><p></p><hr/>\n<em>2012-Apr-27 18:31:34 by bbockelm:</em> <br/>\n\nHi Dan,\n\n<p>Getting closer.  Instead of the job (3) getting held, it now exits cleanly, but job (2) causes the following in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddLog\" title=\"Schedd Log\">ScheddLog</a></span>.\n\n</p><p></p><div class=\"verbatim\">\n<pre>04/27/12 18:25:39 (pid:15523) DoUpload: (Condor error code 12, subcode 13) SCHEDD at 129.93.239.174 failed to send file(s) to &lt;129.93.239.174:49101&gt;; JOB_ROUTER at 129.93.239.174 failed to write to file /var/lib/condor/spool/5030/0/cluster25030.proc0.subproc0/test_c.out: (errno 13) Permission denied\n</pre></div>\n\n\n<p>In the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> log:\n\n</p><p></p><div class=\"verbatim\">\n<pre>\n04/27/12 18:25:39 Sending GoAhead for 129.93.239.174 to send /var/lib/condor/spool/5030/0/cluster25030.proc0.subproc0/test_c.err and all further files.\n04/27/12 18:25:39 Received GoAhead from peer to receive /var/lib/condor/spool/5030/0/cluster25030.proc0.subproc0/test_c.err and all further files.\n04/27/12 18:25:39 get_file(): Failed to open file /var/lib/condor/spool/5030/0/cluster25030.proc0.subproc0/test_c.err, errno = 13: Permission denied.\n04/27/12 18:25:39 get_file: Receiving 0 bytes\n04/27/12 18:25:39 get_file(): consumed 0 bytes of file transmission\n04/27/12 18:25:39 DoDownload: consuming rest of transfer and failing after encountering the following error: JOB_ROUTER at 129.93.239.174 failed to write to file /var/lib/condor/spool/5030/0/cluster25030.proc0.subproc0/test_c.err: (errno 13) Permission denied\n04/27/12 18:25:39 get_file(): Failed to open file /var/lib/condor/spool/5030/0/cluster25030.proc0.subproc0/test_c.out, errno = 13: Permission denied.\n</pre></div>\n\n\n<p>The job (2) goes on idle for awhile, then the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> restarts it.  I think we'll really need to address the sandbox issue.\n\n</p><p></p><hr/>\n<em>2012-Apr-27 19:08:37 by danb:</em> <br/>\n\nThe sandbox is now appropriately chowned when the source job is spooled and the target job is not separately spooled.\n\n<p></p><hr/>\n<em>2012-Apr-27 20:01:44 by bbockelm:</em> <br/>\n\nHi Dan,\n\n<p>I tried out the new code and the JR is segfaulting on me.  Due to issues with my core-dump setup, I don't have much more information than this.  Will try to get some more.\n\n</p><p>Regardless, re-opening the ticket.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2012-Apr-27 21:34:58 by bbockelm:</em> <br/>\n\nScratch that - just issues with my local libcondor_utils.  Seems to be working.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-28 23:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2d98a0c104e09d6d9f82754db6cef79b8ecee165\">[31853]</a></span>: Make <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2955\" onclick=\"get_ticket_and_populate_wrapper('2955'); return false;\" title=\"JobRouter sandbox management\">#2955</a></span> safe for Windows  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-27 19:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/423ea0da637de28a4101465335bb3066608ac3b8\">[31851]</a></span>: Documented fix for routing of spool jobs whether or not the target job is separately spooled. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2955\" onclick=\"get_ticket_and_populate_wrapper('2955'); return false;\" title=\"JobRouter sandbox management\">#2955</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-27 19:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4523f4e87a571ca8f7661a9df7f392e7dbcc1ff9\">[31850]</a></span>: Fixed routing of spooled jobs when the target job shares the same spool directory. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2955\" onclick=\"get_ticket_and_populate_wrapper('2955'); return false;\" title=\"JobRouter sandbox management\">#2955</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-27 16:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fa58a5c5b6096da5cde130642fd721ae823e7eee\">[31848]</a></span>: Documented fix for routing spooled jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2955\" onclick=\"get_ticket_and_populate_wrapper('2955'); return false;\" title=\"JobRouter sandbox management\">#2955</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-27 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6546347cac1f397d94640d84f3e5a504d17acf5d\">[31847]</a></span>: Fix for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> when routing spooled jobs using <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobShouldBeSandboxed\" title=\"Job Should Be Sandboxed\">JobShouldBeSandboxed</a></span> mode. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2955\" onclick=\"get_ticket_and_populate_wrapper('2955'); return false;\" title=\"JobRouter sandbox management\">#2955</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Apr-27 21:35", "status": "resolved", "created": "2012-Apr-24 18:50", "fixed_version": "2012-Apr-24 18:50", "broken_version": "v070600", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}