{"id": 6824, "title": "Ticket #6824: Update processing of ALLOW lists", "description": "<blockquote>\nIn conjunction with <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6788\" onclick=\"get_ticket_and_populate_wrapper('6788'); return false;\" title=\"Add process family security session\">#6788</a></span>, we need to change the default processing of ALLOW_* lists.\n\n<p>If there are no configuration files, the default is for HTCondor to DENY all requests. The previous default was to DENY configuration requests, but ALLOW all others. In addition, if ALLOW_DAEMON was not specified, then the ALLOW_WRITE permission was used.\n\n</p><p>To return to the previous behavior, the following to your configuration will work in most cases:\n</p><div class=\"code\">\n<pre class=\"code\">ALLOW_READ = *\nALLOW_DAEMON = $(ALLOW_WRITE)\n</pre></div>\n\n\n<p>The metaknob <code>use SECURITY:HOST_BASED</code> applies these two changes. It is invoked in the default configuation file <code>/etc/condor/condor_config</code>.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Nov-14 15:41:06 by tim:</em> <br/>\n\nZach proposes the following change\n\n<p></p><div class=\"code\">\n<pre class=\"code\">diff --git a/src/condor_io/condor_ipverify.cpp b/src/condor_io/condor_ipverify.cpp\nindex 2128c8e..6e6a01d 100644\n--- a/src/condor_io/condor_ipverify.cpp\n+++ b/src/condor_io/condor_ipverify.cpp\n@@ -184,8 +184,30 @@ IpVerify::Init()\n                                pAllow = NULL;\n                        }\n                }\n+\n+               // new for 8.8.0: if no allow or deny lists are set, then deny\n+               // DAEMON and ADMINISTRATOR by default.\n+               //\n+               // this has always been true for CONFIG perm.  but since the\n+               // dawn of time, we treated an empty list for any other level\n+               // as \"allow everything\".  now, with family sessions, daemons\n+               // in the same \"family\" (i.e. under the same master) will have\n+               // a session to communicate, and so we deny all others by\n+               // default.  this will prevent, for example, a rogue schedd or\n+               // startd joining the pool if no authentication is configured.\n+               //\n+               // for ADMINISTRATOR, it prevents a random user from doing a\n+               // condor_off unless the admin has set up user authentication.\n+\n                if ( !pAllow &amp;&amp; !pDeny ) {\n-                       if (perm == CONFIG_PERM) {        // deny all CONFIG requests\n+                       if (\n+                               perm == CONFIG_PERM ||\n+                               perm == ADMINISTRATOR ||\n+                               perm == DAEMON ||\n+                               perm == ADVERTISE_MASTER_PERM ||\n+                               perm == ADVERTISE_SCHEDD_PERM ||\n+                               perm == ADVERTISE_STARTD_PERM\n+                       ) {\n                                pentry-&gt;behavior = USERVERIFY_DENY; // by default\n                                dprintf( D_SECURITY, \"ipverify: %s optimized to deny everyone\\n\", PermString(perm) );\n                        } else {\n</pre></div>\n\n\n<p></p><hr/>\n<em>2018-Nov-14 16:06:15 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>I don't like the idea of having a mish-mash of default behaviors for the different permission levels. That's going to lead to admin confusion. Could we have all levels default to deny?\n\n</p><p></p><hr/>\n<em>2018-Nov-14 16:19:49 by zmiller:</em> <br/>\n\nWell,\n\n<p>If you want to run 'condor_q' (i.e. a READ level command) then you'll have to set 'ALLOW_READ = *'\n\n</p><p>If you want to run 'condor_submit' (i.e. a WRITE level command),  then you'll have to set 'ALLOW_WRITE = *'\n\n</p><p>You can add those to the param table I suppose.  I thought the idea was to change it in the code, specifically for daemons, and not do it via the param table.  However, your point is well taken and I'll leave that on the table for discussion.\n\n</p><p></p><hr/>\n<em>2018-Nov-14 16:37:17 by jfrey:</em> <br/>\n\nIn my test setup, I put the following in my config file:\n\n<p></p><div class=\"verbatim\">\n<pre>ALLOW_DAEMON = bogus.cs.wisc.edu\nALLOW_WRITE = bogus.cs.wisc.edu\n</pre></div>\n\n\n<p>The family session code allowed the daemons to communicate with each other. And I was able to submit and remove jobs. I don't know why the latter worked. I assumed the schedd had some special code to augment the normal security rules. Does anyone know what could be going on there?\n\n</p><p></p><hr/>\n<em>2018-Nov-14 17:42:57 by zmiller:</em> <br/>\n\nIt is odd that you can submit jobs with the only allowed host being \"bogus.cs.wisc.edu\".  I was able to reproduce this.\n\n<p>A fresh 8.7.10 also exhibits the same behavior.\n\n</p><p>That appears to be a serious problem, but I think it is unrelated to this ticket.\n\n</p><p></p><hr/>\n<em>2018-Nov-15 09:41:45 by jfrey:</em> <br/>\n\nI found the reason for me being able to submit jobs. ADMINISTRATOR access implies WRITE access. And the param table default for ALLOW_ADMINISTRATOR is $(CONDOR_HOST). So anyone on the on system can submit jobs in a personal condor.\n\n<p></p><hr/>\n<em>2018-Nov-15 09:43:33 by jfrey:</em> <br/>\n\nSide note: The manual does a horrible job of documenting when an authorization level implies other levels.\n\n<p></p><hr/>\n<em>2019-Feb-15 11:45:19 by tannenba:</em> <br/>\n\nThe ticket description essentially just says \"make things more secure\".\n\n<p>The ticket description needs to clearly and concisely state what this ticket intends to change, and the motivation for each change.  One should not have to piece together what \"make more secure\" means from code git commit messages.\n\n</p><p></p><hr/>\n<em>2019-Feb-21 09:35:13 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>These changes look good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-27 14:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a1b6fbcae7f588c3bf36183109a29c095b9b4a73\">[56252]</a></span>: Documentation for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>, Also re-order version history for release  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-19 11:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b4e533cd8373c6e644e9cf7cf84a36727b825e00\">[56217]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) Revert removing HOSTALLOW and HOSTDENY  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-24 06:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1dfa2336e3cf096ae343fd01ac23300124c8a243\">[56071]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) More complete and understandable mapping of optimized cases  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-10 18:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/93fd87cc4f22110b5d716809ec4e6a3c532067be\">[55974]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) More complete and understandable mapping of optimized cases  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-05 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/12ea8289b9d6b3cef7b7b79969b54190cf794698\">[55946]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) Remove deprecated HOSTALLOW and HOSTDENY  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-05 16:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0ac68034828f45715e9f27a8131d1fcb82039d14\">[55945]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) Break promotion of ALLOW_WRITE config to ALLOW_DAEMON  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-05 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/53c1e0fc7f5b3a0d53932a5f57f94795b7c1b364\">[55944]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) Continue running tests after failure and report number of fails  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-15 15:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ca0a9a856c07a61f6b36accc4ae991a65f8a6773\">[55739]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) Continue testing after failure and exit with known value  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-15 15:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a36da6f8c23afade96cf07e5507704d3af1bd86a\">[55737]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6824\" onclick=\"get_ticket_and_populate_wrapper('6824'); return false;\" title=\"Update processing of ALLOW lists\">#6824</a></span>) Work in progress  (By Tim Theisen )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Feb-27 14:31", "status": "resolved", "created": "2018-Nov-14 15:38", "fixed_version": "2018-Nov-14 15:38", "broken_version": "", "priority": "1", "subsystem": "Security", "assigned_to": "tim", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "other", "visibility": "public", "notify": "jfrey@cs.wisc.edu tannenba@cs.wisc.edu zmiller@cs.wisc.edu tim@cs.wisc.edu", "due_date": ""}