{"id": 6798, "title": "Ticket #6798: negotiator core dump with meta if-defined operator", "description": "<blockquote>\nUse of the new <code>?:</code> classad operator introduced in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5782\" onclick=\"get_ticket_and_populate_wrapper('5782'); return false;\" title=\"Add new classad ? : meta if-defined operator\">#5782</a></span> in a startd START expression caused the negotiator to drop core with a segmentation fault.  Looks like the problem is related to flattening expressions with this operator, which is something the negotiator does to optimize an ad for matchmaking.\n\n<p>How I can reproduce the problem:\n\n</p><p>In a personal condor setup, I configured my startd as follows:\n\n</p><p></p><pre>   USE FEATURE:PARTITIONABLESLOT\n   START = $(START) &amp;&amp; ((CurrentTime - (max(ChildEnteredCurrentState)=?=UNDEFINED ? 0 : max(ChildEnteredCurrentState))) &gt; 60 )\n</pre>\n\n<p>The above works fine.  However, the negotiator will core dump during matchamking if I replace the above conditional to do the same thing with the <code>?:</code> operator like so:\n\n</p><p></p><pre>   USE FEATURE:PARTITIONABLESLOT\n   START = $(START) &amp;&amp; ((CurrentTime - (max(ChildEnteredCurrentState) ?: 0)) &gt; 60 )\n</pre>\n\n<p>Here is the tail of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NegotiatorLog\" title=\"Negotiator Log\">NegotiatorLog</a></span>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">10/11/18 16:53:56 ---------- Started Negotiation Cycle ----------\n10/11/18 16:53:56 Phase 1:  Obtaining ads from collector ...\n10/11/18 16:53:56   Getting startd private ads ...\n10/11/18 16:53:56 Trying to query collector &lt;127.0.0.1:9618&gt;\n10/11/18 16:53:56   Getting Scheduler, Submitter and Machine ads ...\n10/11/18 16:53:56 Trying to query collector &lt;127.0.0.1:9618&gt;\n10/11/18 16:53:56   Sorting 3 ads ...\n10/11/18 16:53:56 Intercepting an unhandled exception.\n10/11/18 16:53:56 Dropping a core file.\n</pre></div>\n\n\n<p>And resulting <code>core.NEGOTIATOR.WIN32</code> file when running <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersion\" title=\"Condor Version\">CondorVersion</a></span>: 8.6.12 Jun 19 2018 PRE-RELEASE-UWCS on Win32:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">//=====================================================\nPID: 8392\nException code: C0000005 ACCESS_VIOLATION\nFault address:  014726C4 01:002D16C4 C:\\condor\\bin\\condor_negotiator.exe\n\nRegisters:\nEAX:0014E2F8\nEBX:7EFDE000\nECX:00000000\nEDX:0014D210\nESI:0014D124\nEDI:0014D264\nCS:EIP:0023:014726C4\nSS:ESP:002B:0014D114  EBP:0014D12C\nDS:002B  ES:002B  FS:0053  GS:002B\nFlags:00010206\n\nCall stack:\nAddress   Frame\n014726C4  0014D12C  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n0149564A  0014D270  classad::Operation3::flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2292)\n01491269  0014D290  classad::Operation::flattenSpecials (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2153)\n01490175  0014D3B4  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:895)\n014726CE  0014D3D4  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n01494525  0014D448  classad::OperationParens::flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2192)\n0149121B  0014D468  classad::Operation::flattenSpecials (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2149)\n01490175  0014D58C  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:895)\n014726CE  0014D5AC  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n0148FE79  0014D6D4  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:869)\n014726CE  0014D6F4  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n01494525  0014D768  classad::OperationParens::flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2192)\n0149121B  0014D788  classad::Operation::flattenSpecials (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2149)\n01490175  0014D8AC  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:895)\n014726CE  0014D8CC  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n0148FE55  0014D9F4  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:869)\n014726CE  0014DA14  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n01494525  0014DA88  classad::OperationParens::flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2192)\n0149121B  0014DAA8  classad::Operation::flattenSpecials (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2149)\n01490175  0014DBCC  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:895)\n014726CE  0014DBEC  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n01490203  0014DD14  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:901)\n014726CE  0014DD34  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n014A612F  0014DD54  classad::CachedExprEnvelope::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\classadcache.cpp:498)\n014726CE  0014DD74  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n0148DB31  0014DE0C  classad::AttributeReference::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\attrrefs.cpp:341)\n014726CE  0014DE2C  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n01494525  0014DEA0  classad::OperationParens::flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2192)\n0149121B  0014DEC0  classad::Operation::flattenSpecials (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:2149)\n01490175  0014DFE4  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:895)\n014726CE  0014E004  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n014901D4  0014E12C  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:901)\n014726CE  0014E14C  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n014901D4  0014E274  classad::Operation::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\operators.cpp:901)\n014726CE  0014E294  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n014A612F  0014E2B4  classad::CachedExprEnvelope::_Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\classadcache.cpp:498)\n014726CE  0014E2D4  classad::ExprTree::Flatten (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\exprtree.cpp:259)\n0146541A  0014E31C  classad::ClassAd::FlattenAndInline (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\classad.cpp:2044)\n0148C6F7  0014E5C4  classad::MatchClassAd::OptimizeAdForMatchmaking (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\matchclassad.cpp:324)\n0148C152  0014E5D8  classad::MatchClassAd::OptimizeRightAdForMatchmaking (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\classad\\matchclassad.cpp:271)\n011EA539  0014E648  Matchmaker::OptimizeMachineAdForMatchmaking (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_negotiator.v6\\matchmaker.cpp:3706)\n011E0A1E  0014EB18  Matchmaker::obtainAdsFromCollector (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_negotiator.v6\\matchmaker.cpp:3602)\n011DBF19  0014F130  Matchmaker::negotiationTime (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_negotiator.v6\\matchmaker.cpp:1371)\n013FF65E  0014F188  TimerManager::Timeout (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_daemon_core.v6\\timer_manager.cpp:449)\n01305723  0014F6EC  DaemonCore::Driver (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_daemon_core.v6\\daemon_core.cpp:3466)\n012AAB44  0014F804  dc_main (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_daemon_core.v6\\daemon_core_main.cpp:2761)\n011D8627  0014F814  main (c:\\home\\tannenba\\condor\\condor_src_three\\condor_src\\src\\condor_negotiator.v6\\main.cpp:78)\n014BFB09  0014F864  __tmainCRTStartup (f:\\dd\\vctools\\crt_bld\\self_x86\\crt\\src\\crtexe.c:536)\n014BFC4D  0014F86C  mainCRTStartup (f:\\dd\\vctools\\crt_bld\\self_x86\\crt\\src\\crtexe.c:377)\n764F343D  0014F878  BaseThreadInitThunk+12\n77719802  0014F8B8  RtlInitializeExceptionChain+63\n777197D5  0014F8D0  RtlInitializeExceptionChain+36\n\n//=====================================================\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2018-Oct-24 16:42:58 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-23 17:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d8fed399022ff9b586102007b944cad1a0ab7dab\">[55612]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6740\" onclick=\"get_ticket_and_populate_wrapper('6740'); return false;\" title=\"Singularity doesn't allow MOUNT_UNDER_SCRATCH to be an expression\">#6740</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6772\" onclick=\"get_ticket_and_populate_wrapper('6772'); return false;\" title=\"SingularityVersion isn't advertised when docker is not configured\">#6772</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6776\" onclick=\"get_ticket_and_populate_wrapper('6776'); return false;\" title=\"docker universe doesn't bind mount scratch dir with file xfer off\">#6776</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6798\" onclick=\"get_ticket_and_populate_wrapper('6798'); return false;\" title=\"negotiator core dump with meta if-defined operator\">#6798</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-12 11:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7ae55acead9d15c40c08aaf47bfb69ef8ead0299\">[55557]</a></span>: Fix bug that prevented classad flattening of ?: expressions <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6798\" onclick=\"get_ticket_and_populate_wrapper('6798'); return false;\" title=\"negotiator core dump with meta if-defined operator\">#6798</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Oct-24 16:43", "status": "resolved", "created": "2018-Oct-11 17:08", "fixed_version": "2018-Oct-11 17:08", "broken_version": "v080612", "priority": "3", "subsystem": "ClassAd", "assigned_to": "gthain", "derived_from": "#5782", "creator": "tannenba", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}