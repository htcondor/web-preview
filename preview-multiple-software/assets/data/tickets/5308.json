{"id": 5308, "title": "Ticket #5308: Docker Universe should allow admin to specify volume mounts", "description": "<blockquote>\nDocker containers provide, by default, complete file system isolation -- jobs running in containers see only the files in the filesytem image they booted from, and processes on the host machine outside of the container can't see any files within the container.  While is is good for isolation, it is problematic for sharing datasets prestaged on a host, or accessing remote filesystems, which the container may not have credentials to mount.\n\n<p>Docker containers can optionally share a directory with the host filesystem via a \"volume mount\".  This is a Linux bind-mount that makes a directory tree on the host visible, readable and writeable by the processes running in the container.  Today, Docker Universe always bind-mounts the condor scratch directory into the container.\n\n</p><p>Several users have expressed a desire to have directories other than the scratch directory volume mounted into the docker universe container.  One use case is a large dataset prestaged on the host, too big to put into an image.  Another use case is access to a network file system that is mounted on the host, because admins are unwilling or unable to grant access to that filesystem to an arbitrary container.\n\n</p><p>Although the requirement to use a volume-mounted filesystem is really an aspect of the job, we'd like to make it easy for administrators to say \"always volume mount these directories for any docker universe job that lands on this machine\".  At the same time, we'd like to provide advanced users the ability to say \"this machine can volume mount any of these directories, but will only mount those the user requests\".  Because these requests will be first class job attributes, the machine will also be able to say \"Even though I have volume A, I won't allow user u to access it\".  We assume there will be a small, fixed number of these.\n\n</p><p>The first set of configuration knobs will be on the startd side.  The first will list names of filesystems available to mount:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">DOCKER_VOLUMES = NAME1, NAME2</pre></div>\n\n\n<p>Each Volume will then need a path\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">DOCKER_VOLUME_DIR_NAME1 = /path/to/name1:/optional/mount_point\nDOCKER_VOLUME_DIR_NAME2 = /path/to/name2:/optional/mount_point</pre></div>\n\n\n<p>If the colon and following optional mount point is ommitted, condor treats the entry as if the optional mount point is the same path as the source path.\n\n</p><p>The admin can then tell the start which volumes to always mount:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">DOCKER_MOUNT_VOLUMES = NAME1</pre></div>\n\n\n<p>this will cause the condor_start to add the command line parameter <code>--volume /path/to/name1:/optional/mount_point</code> to the docker run command.\n\n</p><p>The above will be the first milestone.\n\n</p><p>Then, we will add to the submit file the ability for the job to request additional volume mounts:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">docker_volume_mount = name1:/override_default_mount_point, name2</pre></div>\n\n\n<p>Where the optiona /override_default_mount_point tells condor to mount this volume in a non-default directory in the container.\n\n</p><p>For this to work, the startd will advertise each of its available docker volume mounts as separate entities\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">HasDockerVolumeName1 = true\nHasDockerVolumeName2 = true</pre></div>\n\n\n<p>and the job's requirements will be modified by condor_submit to require these:  <code>Requirements = ... &amp;&amp; HasDockerVolumeName1</code>\n\n</p><p>When the job lands on the machine, the starter will double check the volume mounts, and mount the correct volumes at runtime.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-30 13:38:49 by wenger:</em> <br/>\n\nGreg, do you have any example config and submit files you could send me for this?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-20 11:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3eefd70c9239edc6ff42563dfaa30ce8fd8c897c\">[46033]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5308\" onclick=\"get_ticket_and_populate_wrapper('5308'); return false;\" title=\"Docker Universe should allow admin to specify volume mounts\">#5308</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-20 11:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cbfe26f2ff5e03b5011921febcc6b43248e01328\">[46032]</a></span>: Add version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5308\" onclick=\"get_ticket_and_populate_wrapper('5308'); return false;\" title=\"Docker Universe should allow admin to specify volume mounts\">#5308</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-20 09:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/07e3840a03e76cb9025aeb5647ab551199de5112\">[46029]</a></span>: Fix last push for older C++ compilers <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5308\" onclick=\"get_ticket_and_populate_wrapper('5308'); return false;\" title=\"Docker Universe should allow admin to specify volume mounts\">#5308</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-20 09:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/355e95ccdac0ca6561d2fb38da2abb0be66fe111\">[46028]</a></span>: Allow admins to add additition docker volumes to mount in docker uni jobs <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5308\" onclick=\"get_ticket_and_populate_wrapper('5308'); return false;\" title=\"Docker Universe should allow admin to specify volume mounts\">#5308</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-14 16:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6e3f8257f4b0dd2af3661fd6c1ccb6b8e92b1b2\">[45978]</a></span>: Fix last push for older C++ compilers <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5308\" onclick=\"get_ticket_and_populate_wrapper('5308'); return false;\" title=\"Docker Universe should allow admin to specify volume mounts\">#5308</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-14 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5681f42eea370c4fe4b4c341553a64bf91a4cf6a\">[45977]</a></span>: Allow admins to add additition docker volumes to mount in docker uni jobs <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5308\" onclick=\"get_ticket_and_populate_wrapper('5308'); return false;\" title=\"Docker Universe should allow admin to specify volume mounts\">#5308</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-30 13:38", "status": "resolved", "created": "2015-Oct-14 11:50", "fixed_version": "2015-Oct-14 11:50", "broken_version": "v080400", "priority": "1", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "", "due_date": "20151016"}