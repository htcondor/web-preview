{"id": 5530, "title": "Ticket #5530: condor_q does not respect QUEUE_SUPER_USERS from CERTIFICATE_MAPFILE", "description": "<blockquote>\nWith the change in <code>condor_q</code> (8.5.2) to default to only showing each user their jobs, running <code>condor_q</code> as root against an HTCondor-CE does not show any jobs. Jobs are shown when running <code>condor_q -allusers</code>.\n\n<p></p><ul>\n<li>HTCondor-CE makes extensive use of the <code>CERTIFICATE_MAPFILE</code> and TJ mentioned that the new <code>condor_q</code> behavior does not play well with mapfiles:\n</li></ul>\n\n<p></p><div class=\"verbatim\">\n<pre>GSI \"^\\/DC\\=com\\/DC\\=DigiCert-Grid\\/O=Open Science Grid\\/OU\\=Services\\/CN\\=(host\\/)?([A-Za-z0-9.\\-]*)$\" \\2@daemon.opensciencegrid.org\nGSI \"^\\/DC\\=DigiCert-Grid\\/DC\\=com\\/O=Open Science Grid\\/OU\\=Services\\/CN\\=(host\\/)?([A-Za-z0-9.\\-]*)$\" \\2@daemon.opensciencegrid.org\nGSI \"^\\/DC\\=org\\/DC\\=opensciencegrid\\/O=Open Science Grid\\/OU\\=Services\\/CN\\=(host\\/)?([A-Za-z0-9.\\-]*)$\" \\2@daemon.opensciencegrid.org\nGSI \"^\\/DC\\=ch\\/DC\\=cern\\/OU\\=computers\\/CN\\=(host\\/)?([A-Za-z0-9.\\-]*)$\" \\2@cern.ch\nGSI (.*) GSS_ASSIST_GRIDMAP\nGSI \"(/CN=[-.A-Za-z0-9/= ]+)\" \\1@unmapped.opensciencegrid.org\nCLAIMTOBE .* anonymous@claimtobe\nFS (.*) \\1\n</pre></div>\n\n\n<p></p><ul>\n<li>root appears to be a queue super user: I can qedit and remove any job as root. We set <code>QUEUE_SUPER_USERS</code> in our config, overriding the default: <code>QUEUE_SUPER_USERS = $(FULL_HOSTNAME)</code>. We use GSI auth as our default auth method (<code>SEC_DEFAULT_AUTHENTICATION_METHODS = GSI</code>), so the root user gets mapped via the hostcert (<code>GSI_DAEMON_CERT = /etc/grid-security/hostcert.pem</code>). When I set <code>QUEUE_SUPER_USERS</code> to a non-root user, I'm still able to remove jobs as root. Does that mean root is always a queue super user?\n\n<p></p></li><li>Adding 'root' to the list of <code>QUEUE_SUPER_USERS</code> results in <code>condor_q</code> showing all jobs. So root is being treated as a queue super user except for the condor_q case?\n</li></ul>\n\n<p>I'm opening this as a support ticket for now because the items listed above are not clear to me and so this could all just be a configuration error.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Mar-22 14:26:23 by tannenba:</em> <br/>\n\nTJ - bump\n\n<p></p><hr/>\n<em>2016-Mar-23 10:54:36 by tannenba:</em> <br/>\n\nBrian, why did you feel the need to override the default setting for <code>QUEUE_SUPER_USERS</code> for the HTCondor-CE config?  I cannot think of a reason for why you needed to change this.\n\n<p></p><hr/>\n<em>2016-Mar-23 11:01:50 by blin:</em> <br/>\n\nI'll have to defer to Brian Bockelman on that question as he originally wrote this part of the CE configuration. I think it's because of what I mentioned above: using GSI in the mapfile so that the root user gets mapped via the hostcert.\n\n<p></p><hr/>\n<em>2016-Apr-06 15:10:56 by tannenba:</em> <br/>\n\nI understand that TJ and Brian met in person on this and decided it was a config issue.  Could one of you please leave a remark in this ticket with the wisdom of what was wrong, and if the default OSG CE config should change.  Then resolve.\n\n<p></p><hr/>\n<em>2016-Apr-06 15:21:48 by blin:</em> <br/>\n\nWe did meet but I don't believe we agreed that it was a configuration issue. We came to the conclusion that <code>condor_q</code> doesn't respect the <code>CERTIFICATE_MAPFILE</code> when getting its list of <code>QUEUE_SUPER_USERS</code> and that TJ would need to consult someone that knew the auth code to resolve it.\n\n<p></p><hr/>\n<em>2016-May-23 15:14:09 by johnkn:</em> <br/>\n\nSo the fundamental problem is that the condor_q only-my-jobs feature that was added in 8.5.2 <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4976\" onclick=\"get_ticket_and_populate_wrapper('4976'); return false;\" title=\"Improvements to condor_q for 8.5 series\">#4976</a></span> only works when the value of 'me' that condor_q inserts is the correct value.  Where there is a mapfile in place, it it (usually) isn't the correct value.\n\n<p>The fix is to have condor_q authenticate when only-my-jobs is desired.  There was some discussion have having this authentication happen the middle of the condor_q command handling when it was discovered to be needed, but it's hard to make that sort of authentication non-blocking. So instead a new command will be registered that behaves just like the current condor_q v3 command, but this command will be registed as authentication required.  Then condor_q will send that command int rather than the normal condor_q command int when only-my-jobs is desired and the schedd is known to be version 8.5.6 or later.\n\n</p><p></p><hr/>\n<em>2016-May-25 11:25:49 by johnkn:</em> <br/>\n\npatch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b2e9dd72597810726327e0482260a19744294af1\">[48411]</a></span> is insufficient for the CE. detected owner is not being treated as a queue superuser even though it is.  This log fragment shows that the owner== constraint is being added, even though it should not be for a queue superuser.\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">ce schedd log</pre>\n<pre class=\"snip\">05/25/16 11:15:39 QUERY_JOB_ADS_WITH_AUTH command was already authenticated.\n05/25/16 11:15:39 QUERY_JOB_ADS detected owner = $(FULL_HOSTNAME)\n05/25/16 11:15:39 QUERY_JOB_ADS 1 formal requirements without excess parens: true\n05/25/16 11:15:39 QUERY_JOB_ADS 1 effective requirements: ( owner == \"$(FULLHOSTNAME)\" ) &amp;&amp; true\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-20 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0010acdbf71b43ac60ce16a258e1f95b778d1c0c\">[48820]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5530\" onclick=\"get_ticket_and_populate_wrapper('5530'); return false;\" title=\"condor_q does not respect QUEUE_SUPER_USERS from CERTIFICATE_MAPFILE\">#5530</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5721\" onclick=\"get_ticket_and_populate_wrapper('5721'); return false;\" title=\"config/submit language should support multiline values\">#5721</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5507\" onclick=\"get_ticket_and_populate_wrapper('5507'); return false;\" title=\"Expose condor_drain functionality in the Python bindings\">#5507</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5751\" onclick=\"get_ticket_and_populate_wrapper('5751'); return false;\" title=\"add a userMap function to condor ClassAds\">#5751</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-25 15:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/48e82f2ac2fe924dc3f9dd279634827c5afeaba2\">[48419]</a></span>: fix to previous commit for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5530\" onclick=\"get_ticket_and_populate_wrapper('5530'); return false;\" title=\"condor_q does not respect QUEUE_SUPER_USERS from CERTIFICATE_MAPFILE\">#5530</a></span>, compare the authenticated owner to the queue superusers list  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-24 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b2e9dd72597810726327e0482260a19744294af1\">[48411]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5530\" onclick=\"get_ticket_and_populate_wrapper('5530'); return false;\" title=\"condor_q does not respect QUEUE_SUPER_USERS from CERTIFICATE_MAPFILE\">#5530</a></span>, condor_q only-my-jobs does not repect the CERTIFICATE_MAPFILE for determining 'me' The fix is to add a new command to the schedd that returns the same ads as QUERY_JOB_ADS, but is registered to require authentication. This allows the schedd to correctly know who 'me' is. condor_q will\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jul-20 15:29", "status": "resolved", "created": "2016-Feb-25 13:28", "fixed_version": "2016-Feb-25 13:28", "broken_version": "v080502", "priority": "2", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "#4555", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu, blin@cs.wisc.edu", "due_date": ""}