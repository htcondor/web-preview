{"id": 3686, "title": "Ticket #3686: condor_off fails to find startds", "description": "<blockquote>\nJohn Hover reports:\n\n<p></p><div class=\"verbatim\">\n<pre>I'm to the point of wanting to programmatically retire startds on nodes on\nEC2, and I'm running into trouble.\n\nThe wiki\n\n https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=HowToShutDownCondor\n\nsays to use\n condor_off -startd -peaceful &lt;hostname&gt;\n\nbut,\n\n[root@gridtest03 sysconfig]# condor_status\nName               OpSys      Arch   State     Activity LoadAv Mem ActvtyTime\n\nip-10-12-75-199    LINUX      X86_64 Claimed   Busy      1.000 3759 0+01:24:20\nip-10-196-219-15   LINUX      X86_64 Claimed   Busy      1.020 3759 0+01:09:33\nslot1@ip-10-29-147 LINUX      X86_64 Claimed   Busy      0.910 2144 0+00:44:34\nslot2@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.190 2144 0+01:09:38\nslot3@ip-10-29-147 LINUX      X86_64 Claimed   Busy      0.370 2144 0+01:06:35\nslot4@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.170 2144 0+00:56:01\nslot5@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.080 2144 0+01:09:39\nslot6@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.110 2144 0+00:44:29\nslot7@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.170 2144 0+02:12:53\n\n                     Total Owner Claimed Unclaimed Matched Preempting Backfill\n\n        X86_64/LINUX     9     0       9         0       0          0        0\n\n               Total     9     0       9         0       0          0        0\n[root@gridtest03 sysconfig]# condor_off -startd -peaceful ip-10-12-75-199\nCan't find address for startd\nPerhaps you need to query another pool.\n\n[root@gridtest03 sysconfig]# condor_off -startd -peaceful -name \"ip-10-29-147-9\"\nCan't find address for startd\nPerhaps you need to query another pool.\n\nThis seems to send a message:\n\n[root@gridtest03 sysconfig]# condor_off -startd -peaceful\n\"slot4@ip-10-29-147-9\"\nSent \"Set-Peaceful-Shutdown\" command to startd slot4@ip-10-29-147-9\nCan't find address for master slot4@ip-10-29-147-9\nPerhaps you need to query another pool.\n\nBut the node never enters \"Retiring\" state.\n\nI'm on a schedd with the collector on another host, but all these command\nbehave the same there.\n\nWhat am I doing wrong?\n</pre></div>\n\n\n<p>and also\n\n</p><p></p><div class=\"verbatim\">\n<pre>BTW, this worked before on this same setup. So something must have changed.\nI'm just asking for guidance on how to troubleshoot it. I'm guessing it has\nto do with looking up startd names in the multi-collector/shared-port/CCB\nenvironment.\n\nI was hoping to present on this Thursday (I'm at CERN). :-)\n</pre></div>\n\n\n<p>To which I replied:\n\n</p><p></p><div class=\"verbatim\">\n<pre>I can't help but noticing you never tried the FQDN.  I have all\nsorts of trouble all the time with HTCondor seemingly being unable to look\nup its own names for things; I don't what the deal is, but I've been having\ntrouble for years.\n\n        Also, IIRC, the ip-* names are Amazon's internal DNS names; you may\nhave better luck using the job-ad attribute EC2RemoteVirtualMachineName,\nwhich will be the public DNS names.\n</pre></div>\n\n\n<p>To which he replied:\n\n</p><p></p><div class=\"verbatim\">\n<pre>I have tried the public IP and public FQDN, with and without quotes. Same\nanswer on those.\n\nThis sounds like a real problem, especially if you have faced it too. Can\nyou escalate this to the appropriate people (Todd T., Dan Bradley, others?).\nIf I can get an answer then you will have one too.\n\nIt would be great to get something definitive today on something as basic as\nreferring to a startd by name.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Jun-10 11:32:17 by tlmiller:</em> <br/>\n\nNext step: confirm that the appropriate ad(s) exist in the primary collector.\n\n<p></p><hr/>\n<em>2013-Jun-10 14:01:33 by tlmiller:</em> <br/>\n\nThe attached master_condor_status.xml file was generated by:\n\n<p></p><div class=\"verbatim\">\n<pre>condor_status -master -xml\n</pre></div>\n\n\n<p>and the other two *.xml files probably by\n\n</p><p></p><div class=\"verbatim\">\n<pre>condor_status -xml\n</pre></div>\n\n\n<p>The attached *.txt files were generated by:\n\n</p><p></p><div class=\"verbatim\">\n<pre>OK, attached is the output of...\n\n condor_status -any -l\n\nfrom both the schedd (gridtest03.racf.bnl.gov) and the collector host\n(gridui09.usatlas.bnl.gov).\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Jun-10 14:05:29 by tlmiller:</em> <br/>\n\nThe master ads are present and (at least at first glance) appear to be sane, so the problem is probably elsewhere, which means it's time to look at what condor_off is doing.  I've also asked John what might have changed, since this used to work...\n\n<p></p><hr/>\n<em>2013-Jun-12 10:08:41 by zmiller:</em> <br/>\n\nAfter further testing and looking at the code, it turns out that:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">condor_off -peaceful -startd REMOTENODE</pre></div>\n\n\n<p>has always been broken since it was introduced in 2006.  It should be noted that it works fine locally.  I am changing this ticket from \"incident\" to \"defect\".  John has a workaround for now, which is to ssh to the execute node and run the command there (since it works fine locally).  This is kludgy and there's no guarantee of ssh access in general, so this definitely needs to be fixed.\n\n</p><p>Proposed fix is to not have the tool be responsible for sending the \"Set-Peaceful-Shutdown\" message to any startds (or schedds or other daemons for that matter) and instead have the master do it before it sends the TERM signal.\n\n</p><p></p><hr/>\n<em>2013-Jun-12 10:37:48 by danb:</em> <br/>\n\nDC_OFF_PEACEFUL is currently registered as an ADMINISTRATOR level command.  If it works locally, then does this mean local administrator operations are allowed?  Can jobs send administrative commands to condor??\n\n<p>Anyway, the reason I had the tool send the DC_OFF_PEACEFUL command instead of having the master do it is that the master is not necessarily authorized to send administrative commands to its children and I didn't think we had another signal available for the purpose.  I agree that it would be good to solve the authorization problem so the master can send the command.  Now that we pass a security session down to the child, this could be a simple matter of registering the command for DAEMON level access.  Then the master should be authorized.\n\n</p><p>I am surprised though that the existing implementation never worked.  What is broken?  I think I have used it in the past successfully.\n\n</p><p></p><hr/>\n<em>2013-Jun-12 10:53:48 by zmiller:</em> <br/>\n\nMaybe it works if the name of the startd and master are: 1) identical, and 2) the fully qualified hostname.  It definitely does not work if they are different (which name are you specifying on the command line, the master or the startd?) or if the advertised name is different than the hostname (in John's case) or if you set STARTD_NAME and/or MASTER_NAME (how i tested).\n\n<p></p><hr/>\n<em>2014-Feb-07 14:16:34 by jfrey:</em> <br/>\n\nWhat's going on with this ticket? Zach committed some changes for 8.1.0, but the ticket is still active and marked for 8.1.4. Someone on condor-users noticed a bug. When giving multiple names, names beyond the 7th or 8th or following an invalid name aren't found in the list of ads. I'm attaching a patch.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4207\" onclick=\"get_ticket_and_populate_wrapper('4207'); return false;\" title=\"Giving multiple names to The Tool can lead to incorrect failures\">#4207</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nGiving multiple names to The Tool can lead to incorrect failures</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/747/schedd_condor_status.xml\">schedd_condor_status.xml</a>\n16380 bytes added by tlmiller on 2013-Jun-10 18:30:36 UTC.\n</li><li><a href=\"../files/748/master_condor_status.xml\">master_condor_status.xml</a>\n10824 bytes added by tlmiller on 2013-Jun-10 18:30:44 UTC.\n</li><li><a href=\"../files/749/collector_condor_status.xml\">collector_condor_status.xml</a>\n16381 bytes added by tlmiller on 2013-Jun-10 18:30:52 UTC.\n</li><li><a href=\"../files/750/schedd-status-any.txt\">schedd-status-any.txt</a>\n46205 bytes added by tlmiller on 2013-Jun-10 18:59:22 UTC.\n</li><li><a href=\"../files/751/collector-status-any.txt\">collector-status-any.txt</a>\n46210 bytes added by tlmiller on 2013-Jun-10 18:59:29 UTC.\n</li><li><a href=\"../files/771/gt3686_ShutdownDesignDoc_v2.doc\">gt3686_ShutdownDesignDoc_v2.doc</a>\n29696 bytes added by tannenba on 2013-Jun-28 19:29:16 UTC.\n<br/>\nDesign Document for gt <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3686\" onclick=\"get_ticket_and_populate_wrapper('3686'); return false;\" title=\"condor_off fails to find startds\">#3686</a></span> version 2<br/>\n</li><li><a href=\"../files/822/tool.patch\">tool.patch</a>\n867 bytes added by jfrey on 2014-Feb-07 20:17:31 UTC.\n<br/>\nFix bug when providing multiple names of daemons to affect with The Tool.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-19 20:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ec5bbb672a1ad8d79c65f60d8cc887ec05b528e3\">[37283]</a></span>: Fix the resolution of \"names\" given to \"the tool\" when they aren't actual hostnames. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3686\" onclick=\"get_ticket_and_populate_wrapper('3686'); return false;\" title=\"condor_off fails to find startds\">#3686</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-17 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1f6d50f04bbef143e605983f786e571064620254\">[36936]</a></span>: Changes to condor_off (and other tools) to make it more tolerant of differing Name vs. Machine. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3686\" onclick=\"get_ticket_and_populate_wrapper('3686'); return false;\" title=\"condor_off fails to find startds\">#3686</a></span>  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-10 16:29", "status": "resolved", "created": "2013-Jun-10 11:02", "fixed_version": "2013-Jun-10 11:02", "broken_version": "v080000", "priority": "1", "subsystem": "Tools", "assigned_to": "zmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu, danb@cs.wisc.edu, jhover@bnl.gov, tlmiller@cs.wisc.edu,jfrey@cs.wisc.edu", "due_date": ""}