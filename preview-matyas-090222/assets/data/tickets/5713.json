{"id": 5713, "title": "Ticket #5713: master leaks inherited SharedPortEndpoints on Windows", "description": "<blockquote>\nUsing sysinternals Process Explorer, I discovered that the condor_master is holding open handles to shared point endpoints that belong to it's children.  I discovered this while testing some configuration error handling. The situation was:\n\n<p></p><ol>\n<li>start a personal condor\n</li><li>change the config so that only the schedd will see an invalid config\n</li><li>reconfig the schedd\n</li><li>wait for the master to restart the schedd several times\n</li><li>correct the config\n</li><li>wait for the schedd to start with the valid config\n</li></ol>\n\n<p>After this, I noticed that the master could no longer be contacted (I was using <code>condor_who -daemons -quick</code> which sends a command to the master)\n\n</p><p>Looking at the <span class=\"quote\">SharedPortLog</span> I saw that it was stuck trying to hand off a socket to the schedd using an old value for the endpoint id <strong>9388_efce_5</strong>.  The current value of the schedd endpoint should be <strong>9388_efce_12</strong>\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">grepping the SchedLog for endpoint id's</pre>\n<pre class=\"snip\">D:\\scratch\\condor\\master\\test\\log&gt;findstr /C:\"command socket\" SchedLog\n06/07/16 10:44:39.250 (D_ALWAYS) DaemonCore: command socket at &lt;128.105.136.34:6909?addrs=128.105.136.34-6909&amp;noUDP&amp;sock=9388_efce_5&gt;\n06/07/16 10:44:39.250 (D_ALWAYS) DaemonCore: private command socket at &lt;128.105.136.34:6909?addrs=128.105.136.34-6909&amp;noUDP&amp;sock=9388_efce_5&gt;\n06/07/16 10:48:51.424 (D_ALWAYS) DaemonCore: command socket at &lt;128.105.136.34:6909?addrs=128.105.136.34-6909&amp;noUDP&amp;sock=9388_efce_12&gt;\n06/07/16 10:48:51.424 (D_ALWAYS) DaemonCore: private command socket at &lt;128.105.136.34:6909?addrs=128.105.136.34-6909&amp;noUDP&amp;sock=9388_efce_12&gt;\n</pre></div>\n\n\n<p>Using Process Explorer, I see that the master and the schedd both have multiple endpoint pipes open:\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">ProcessExplorer handle search for 9388_efce</pre>\n<pre class=\"snip\">condor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_6\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_9\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_11\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_12\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_10\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_4\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_4\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_6\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_5\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_5\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_7\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_7\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_8\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_8\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_9\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_11\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_10\ncondor_master.exe      9388   File  \\Device\\NamedPipe\\condor\\9388_efce_12\ncondor_shared_port.exe 11364  File  \\Device\\NamedPipe\\condor\\9388_efce_5\ncondor_startd.exe      11528  File  \\Device\\NamedPipe\\condor\\9388_efce_4\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_11\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_4\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_6\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_5\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_7\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_8\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_9\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_10\ncondor_schedd.exe      15060  File  \\Device\\NamedPipe\\condor\\9388_efce_12\n</pre></div>\n\n\n<p>It seems clear that the Master is not closing its endpoint pipe handle after it creates the child.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-07 15:53:40 by tlmiller:</em> <br/>\n\nTJ and I found and fixed a number of problems with shared point endpoint clean-up on Windows.  Primarily, the endpoint doesn't close its pipe handle on destruction unless its listener thread was active, but the Create_Process() doesn't activate the listener thread for the endpoints it creates (because, of course, that thread needs to be in the child).  Additionally, in order to force the endpoint pipe handle to be inherited, we duplicate it with the inherit flag set; the duplicated pipe handle was never being closed at all.\n\n<p>A patch against 8.4 is being tested.\n\n</p><p></p><hr/>\n<em>2016-Jun-08 12:06:35 by tlmiller:</em> <br/>\n\nSee build IDs 369696, 369707, and 369804.\n\n<p></p><hr/>\n<em>2016-Jun-18 13:50:50 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This patch still looks good. :)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-28 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4bde1a1353c3b77fd385c195999e158fd6bdc25a\">[48675]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5713\" onclick=\"get_ticket_and_populate_wrapper('5713'); return false;\" title=\"master leaks inherited SharedPortEndpoints on Windows\">#5713</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5735\" onclick=\"get_ticket_and_populate_wrapper('5735'); return false;\" title=\"condor_history_helper ignores first argument if it starts with -\">#5735</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5706\" onclick=\"get_ticket_and_populate_wrapper('5706'); return false;\" title=\"condor_history doesn't reject unrecognized arguments\">#5706</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-08 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/23f4685221b5043f04176859731112a9f10eacaf\">[48517]</a></span>: fix two handle leaks in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortEndpoint\" title=\"Shared Port Endpoint\">SharedPortEndpoint</a></span> code on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5713\" onclick=\"get_ticket_and_populate_wrapper('5713'); return false;\" title=\"master leaks inherited SharedPortEndpoints on Windows\">#5713</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Jun-28 11:08", "status": "resolved", "created": "2016-Jun-07 11:59", "fixed_version": "2016-Jun-07 11:59", "broken_version": "v080000", "priority": "2", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}