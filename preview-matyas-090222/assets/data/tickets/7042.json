{"id": 7042, "title": "Ticket #7042: Allow files to be checkpointed via plugins", "description": "<blockquote>\nOur friendly gravitational wave enthusiasts at Syracuse have an interesting challenge -- they'd like to use the self-checkpointing job features but their checkpoints are too large to bring back to the schedd without overwhelming it.\n\n<p>Instead, they'd like to use the power of the file transfer plugins to manage the data movement for them.\n\n</p><p>However, on the worker node, we only invoke stageout plugins when it is the \"final transfer\" - the job has completed successfully.\n\n</p><p>It's pretty trivial (I think) to enable file transfer plugins for all stageouts.  It's even straightforward to only enable this behavior behind a job attribute.\n\n</p><p>However, is it the complete solution?  What happens when the job starts up again?  Unlike the case where we are restoring from spool, we don't keep a record of which stageout files should be staged back in.  Duncan will have his checkpoints on his webserver - but HTCondor won't know to pull them back.  I suppose it's possible to put the same file on the transfer_input_files list (pre-creating an empty checkpoint), but that seems unnecessarily user-unfriendly.\n\n</p><p>Anyhow, we promised Duncan we would allow him to invoke the plugins on all stageouts.  I'll do that for now -- but it's not entirely clear that it solves the problem.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-May-14 14:12:27 by tlmiller:</em> <br/>\n\nThe user-friendlier solutions seems like <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=5238\" onclick=\"get_ticket_and_populate_wrapper('5238'); return false;\" title=\"Implement transfer_[checkpoint|intermediate]_files.\">#5238</a></span> (an explicit list of checkpoint file(s)); the obvious implementation would be to assume that the file transfer uploads go to unique directories.  (This also allows the checkpoint transfer list to include directories.)  It also assumes symmetric file transfer plug-ins, but I don't know how big of a problem that really is.  The former restriction may be relaxable when we implement manifest files.\n\n<p></p><hr/>\n<em>2019-May-14 14:24:34 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>It seems like it would be clearer to go\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">bool tmp;\nbool should_invoke_output_\u200bplugins = m_final_transfer_flag;\nif( jobAd.\u200bEvaluateAttrBool(\"Out\u200bputPluginsOnlyOnExit\"\u200b,\u200b tmp ) ) {\n    InitDownloadFilenameR\u200bemaps(&amp;jobAd)\u200b;\u200b\n    should_invoke_output_plugins = !tmp;\n}\n</pre></div>\n\n\n<p>especially if EvaluateAttrBool() does the right thing and doesn't set (or unset) tmp if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OutputPluginsOnlyOnExit\" title=\"Output Plugins Only On Exit\">OutputPluginsOnlyOnExit</a></span> is undefined.\n\n</p><p>However, I'm not sure why you invoke InitDownloadFilenameRemaps() only if file transfer using output plugins -- why do the two have anything to do with each other?  According to the commentary:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">    // The case where we want to apply them is when we are the shadow\n    // or anybody else who is writing the files to their final\n    // location.\n</pre></div>\n\n\n<p>which is certainly not what's happening if we're checkpointing.\n\n</p><p></p><hr/>\n<em>2019-May-30 13:21:51 by tim:</em> <br/>\n\nNot documenting this for now. Let the Syracuse folks kick the tires first.\n\n<p></p><hr/>\n<em>2019-May-30 14:06:40 by tlmiller:</em> <br/>\n\nBrian remarks that <code>InitDownloadFilenameRemaps()</code> is just really terribly named.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7078\" onclick=\"get_ticket_and_populate_wrapper('7078'); return false;\" title=\"Address code review: Allow files to be checkpointed via plugins\">#7078</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAddress code review: Allow files to be checkpointed via plugins</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-05 09:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b49b2e16443b925473e59060fe4367242e1309c\">[58698]</a></span>: Bugfix: invoke stageout plugin at job end. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7078\" onclick=\"get_ticket_and_populate_wrapper('7078'); return false;\" title=\"Address code review: Allow files to be checkpointed via plugins\">#7078</a></span> When `OutputPluginsOnlyOnExit` is set to `true` (the default value; there would have been no reason why someone would set the undocumented knob to this value either), output plugins were not being invoked on exit. This corrects the logic to ensure plugins\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-22 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d0452f16b4e78bf7750ab308f0bbf193de5f753\">[58556]</a></span>: Bugfix: invoke stageout plugin at job end. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7078\" onclick=\"get_ticket_and_populate_wrapper('7078'); return false;\" title=\"Address code review: Allow files to be checkpointed via plugins\">#7078</a></span> When `OutputPluginsOnlyOnExit` is set to `true` (the default value; there would have been no reason why someone would set the undocumented knob to this value either), output plugins were not being invoked on exit. This corrects the logic to ensure plugins\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-09 09:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a345c0edcf291619717a786f0da236b5a8a58e2b\">[56861]</a></span>: Allow jobs to use transfer plugins on evict. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7042\" onclick=\"get_ticket_and_populate_wrapper('7042'); return false;\" title=\"Allow files to be checkpointed via plugins\">#7042</a></span> With this change, the job can set `OutputPluginsOnlyOnExit` to `false` (defaults to `true`) to cause file transfer plugins to be used whenever the job stages out.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-May-30 14:06", "status": "resolved", "created": "2019-May-09 02:06", "fixed_version": "2019-May-09 02:06", "broken_version": "", "priority": "3", "subsystem": "FileTransfer", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelman@morgridge.org tannenba@cs.wisc.edu tlmiller@cs.wisc.edu dabrown@syr.edu", "due_date": ""}