{"id": 6458, "title": "Ticket #6458: DEFAULT_MASTER_SHUTDOWN_SCRIPT ignored on Windows", "description": "<blockquote>\nWhen running on Windows as a service, the condor_master ignores the shutdown script, this includes the <code>DEFAULT_MASTER_SHUTDOWN_SCRIPT</code> knob, as well as the <code>MASTER_SHUTDOWN_xxx</code> configuration variables and associated condor_set_shutdown command.\n\n<p>When not running as a service, the condor_master does attempt to run the shutdown script, but it just hangs, most likely because execl() in the Windows C-runtime can only be used by programs that don't use most of the other c-runtime calls - this is documented behavior.\n\n</p><p>The fix is to have the master do an explicit <code>CreateProcess</code> call and then just exit rather than try and use execl(), and the code to do this needs to be in the exit path for running as a service as well as the normal exit path.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-26 15:57:50 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Code looks good.  The code in <code>master_exit()</code> looks like it should be one stanza further down (that is, after the <code>defined(WIN32)</code>), but if that's a problem, this isn't making in any worse.\n\n</p><p><strong>Doc Review</strong>\n\n</p><p>Needs a version history item.  May also want to update the <code>MASTER_SHUTDOWN_*</code> entries in section 3.5 of the manual (in case it matters that we're not using _execl() on Windows.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-31 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5bb26fd3756ff036d2fad4f40c0fff4ece7beb3f\">[52727]</a></span>: Late version history edit for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6458\" onclick=\"get_ticket_and_populate_wrapper('6458'); return false;\" title=\"DEFAULT_MASTER_SHUTDOWN_SCRIPT ignored on Windows\">#6458</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-28 18:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bfdcbd8fc2bef9cb91122ec2653b3645a3f8836f\">[52698]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6458\" onclick=\"get_ticket_and_populate_wrapper('6458'); return false;\" title=\"DEFAULT_MASTER_SHUTDOWN_SCRIPT ignored on Windows\">#6458</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-27 15:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/287fc05a28c59f84d7ca03a9767f4dcb483e9baf\">[52724]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6458\" onclick=\"get_ticket_and_populate_wrapper('6458'); return false;\" title=\"DEFAULT_MASTER_SHUTDOWN_SCRIPT ignored on Windows\">#6458</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-18 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a307737420ffa4c0bdc09bad5703b21ef1871d8\">[52607]</a></span>: fix <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6458\" onclick=\"get_ticket_and_populate_wrapper('6458'); return false;\" title=\"DEFAULT_MASTER_SHUTDOWN_SCRIPT ignored on Windows\">#6458</a></span>, DEFAULT_MASTER_SHUTDOWN_SCRIPT ignored on Windows when running as a serice. this commit fixes MASTER_SHUTDOWN_xxx and condor_set_shutdown command also. The invocation of the shutdown script now uses <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreateProcess\" title=\"Create Process\">CreateProcess</a></span> rather than execl. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Oct-28 18:57", "status": "resolved", "created": "2017-Oct-18 14:22", "fixed_version": "2017-Oct-18 14:22", "broken_version": "", "priority": "3", "subsystem": "DaemonMaster", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}