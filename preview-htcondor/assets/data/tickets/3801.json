{"id": 3801, "title": "Ticket #3801: Negotiator excepts sending match_info with CCB enabled", "description": "<blockquote>\nConfigure a personal condor with 200 static slots, and ccb with\n<div class=\"code\">\n<pre class=\"code\">STARTD.CCB_ADDRESS = $(COLLECTOR_HOST)\nSTARTD.PRIVATE_NETWORK_NAME = cs.wisc.edu\n</pre></div>\n\n\n<p>submit a cluster of 200 long running sleep jobs, and eventually the negotiator aborts with\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/23/13 16:42:47 matchmakingAlgorithm: limit 187.000000 used 0.000000 pieLeft 187.000000\n07/23/13 16:42:47 Start of sorting MatchList (len=187)\n07/23/13 16:42:47 Finished sorting MatchList\n07/23/13 16:42:47       Connecting to startd slot47@chevre.cs.wisc.edu at &lt;128.105.14.141:44882?CCBID=128.105.14.141:4210#2694&amp;PrivNet=cs.wisc.edu&gt;\n07/23/13 16:42:47       Sending PERMISSION, claim id, startdAd to schedd\n07/23/13 16:42:47       Matched 114.50 gthain@chevre.cs.wisc.edu &lt;128.105.14.141:35038&gt; preempting none &lt;128.105.14.141:44882?CCBID=128.105.14.141:4210#2694&amp;PrivNet=cs.wisc.edu&gt; slot47@chevre.cs.wisc.edu\n07/23/13 16:42:47       Notifying the accountant\n07/23/13 16:42:47       Successfully matched with slot47@chevre.cs.wisc.edu\n07/23/13 16:42:47 ERROR \"Selector::add_fd(): fd -1 outside valid range 0-1023\" at line 196 in file /scratch/gthain/CONDOR_SRC/src/condor_utils/selector.cpp\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Jul-23 16:56:06 by danb:</em> <br/>\n\nThe problematic code comes from <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/800eb6cd5a3265e30d9786384d415b73c80ea1cf\">[35432]</a></span> in <code>DaemonCore::ServiceCommandSock()</code>:\n<div class=\"verbatim\">\n<pre>        else if( ((*sockTable)[i].iosock) &amp;&amp;\n                 (i != initial_command_sock) &amp;&amp;\n                 ((*sockTable)[i].waiting_for_data) &amp;&amp;\n                 ((*sockTable)[i].is_connect_pending == false)) {\n            selector.add_fd( (*sockTable)[i].iosock-&gt;get_file_desc(), Selector::IO_READ );\n        }\n</pre></div>\n\n\n<p>This code does not reproduce the logic in <code>DaemonCore::Driver()</code> when adding sockets to the selector.  In this specific case, it does not check for is_reverse_connect_pending.  There appear to be other inconsistencies.\n\n</p><p></p><hr/>\n<em>2013-Jul-24 17:06:17 by gthain:</em> <br/>\n\nPresumably, setting\n\n<p>SERVICE_COMMAND_SOCKET_MAX_SOCKET_INDEX to -2 should also work around the problem.\n\n</p><p></p><hr/>\n<em>2013-Jul-25 10:11:01 by tstclair:</em> <br/>\n\nHow old is this?\n\n<p></p><hr/>\n<em>2013-Jul-25 10:37:18 by gthain:</em> <br/>\n\nThe bug came into 7.9.6 from <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3535\" onclick=\"get_ticket_and_populate_wrapper('3535'); return false;\" title=\"Fetching user priorities from negotiator takes a long time\">#3535</a></span>\n\n<p></p><hr/>\n<em>2013-Jul-26 11:09:09 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  This looks good.  Can we also put a comment in DaemonCore::Driver that if code changes in the main loop there, that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ServiceCommandSocket\" title=\"Service Command Socket\">ServiceCommandSocket</a></span> might also need to be changed?\n\n<p></p><hr/>\n<em>2013-Aug-06 15:06:22 by danb:</em> <br/>\n\nI added a comment in the code.\n\n<p></p><hr/>\n<em>2013-Aug-14 12:43:27 by danb:</em> <br/>\n\nI just discovered that the schedd is also affected by this bug.  \"But the schedd doesn't call <code>ServiceCommandSocket()</code>!,\" you say.  To my surprise, this is not true.  <code>DaemonCore</code> itself calls <code>ServiceCommandSocket()</code> in <code>HungChildTimeout()</code>:\n\n<p></p><div class=\"verbatim\">\n<pre>    // now we give the child one last chance to save itself.  we do this by\n    // servicing any waiting commands, since there could be a child_alive\n    // command sitting there in our receive buffer.  the reason we do this\n    // is to handle the case where both the child _and_ the parent have been\n    // hung for a period of time (e.g. perhaps the log files are on a hard\n    // mounted NFS volume, and everyone was blocked until the NFS server\n    // returned).  in this situation we should try to avoid killing the child.\n    // so service the buffered commands and check if the was_not_responding\n    // flag flips back to false.\n    ServiceCommandSocket();\n\nI actually observed an 8.0.1 schedd die because of this.\n\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-14 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d5bed9a5efb1f8d71e423ebbcca19552b07bf1af\">[37224]</a></span>: The schedd <em>is</em> impacted by the ServiceCommandSocket() bug. Revert \"Revert \"Updated version history to note additional impact of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ServiceCommandSocket\" title=\"Service Command Socket\">ServiceCommandSocket</a></span> bug. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3801\" onclick=\"get_ticket_and_populate_wrapper('3801'); return false;\" title=\"Negotiator excepts sending match_info with CCB enabled\">#3801</a></span>\"\" This reverts commit ea6beea6608dccc4e7f48e55645ac37ecb7ac96c. Conflicts: doc/version-history/8-0.history.tex  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-12 10:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2c4da276b4b9abccaca41e4e25b791d4895fda1d\">[37163]</a></span>: expand 8.0.2 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3801\" onclick=\"get_ticket_and_populate_wrapper('3801'); return false;\" title=\"Negotiator excepts sending match_info with CCB enabled\">#3801</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-06 15:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ea6beea6608dccc4e7f48e55645ac37ecb7ac96c\">[37110]</a></span>: Revert \"Updated version history to note additional impact of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ServiceCommandSocket\" title=\"Service Command Socket\">ServiceCommandSocket</a></span> bug. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3801\" onclick=\"get_ticket_and_populate_wrapper('3801'); return false;\" title=\"Negotiator excepts sending match_info with CCB enabled\">#3801</a></span>\" I was mistaken that this same bug impacts the schedd. The problem in the schedd is from some other cause. This reverts commit 1028436365dbe6fb5158c3d06518c0477a0ad356.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-06 15:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1028436365dbe6fb5158c3d06518c0477a0ad356\">[37108]</a></span>: Updated version history to note additional impact of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ServiceCommandSocket\" title=\"Service Command Socket\">ServiceCommandSocket</a></span> bug. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3801\" onclick=\"get_ticket_and_populate_wrapper('3801'); return false;\" title=\"Negotiator excepts sending match_info with CCB enabled\">#3801</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-06 15:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c17683760eb9274a32bfdaebbec9efe739ed2565\">[37107]</a></span>: Add comment in code about need for keeping DaemonCore::Driver() and DaemonCore::ServiceCommandSocket() in sync. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3801\" onclick=\"get_ticket_and_populate_wrapper('3801'); return false;\" title=\"Negotiator excepts sending match_info with CCB enabled\">#3801</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-24 17:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb0f950d1d8cb595e156b5042304543077fb35bb\">[36989]</a></span>: Fix negotiator crash when using CCB to connect to startds. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3801\" onclick=\"get_ticket_and_populate_wrapper('3801'); return false;\" title=\"Negotiator excepts sending match_info with CCB enabled\">#3801</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Aug-14 12:58", "status": "resolved", "created": "2013-Jul-23 16:50", "fixed_version": "2013-Jul-23 16:50", "broken_version": "v080000", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "gthain@cs.wisc.edu, tstclair@redhat.com, eje@cs.wisc.edu", "due_date": ""}