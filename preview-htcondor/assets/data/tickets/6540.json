{"id": 6540, "title": "Ticket #6540: Preen should clean up core dump files", "description": "<blockquote>\nBy default, preen does not clean up core dump files in the $(LOG) folder. This could lead to the file system filling up, if enough processes crash and nothing cleans out the core files.\n\n<p>Let's make preen clean these up. We need to figure a policy, since core dumps can also be useful for debugging and should not be erased indiscriminately. I propose that files older than 30 days get removed. Thoughts?</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Apr-23 15:14:48 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>Your commits have the wrong ticket number (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6520\" onclick=\"get_ticket_and_populate_wrapper('6520'); return false;\" title=\"starter crashes on update if it doesn't know the version of the shadow\">#6520</a></span> instead of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6540\" onclick=\"get_ticket_and_populate_wrapper('6540'); return false;\" title=\"Preen should clean up core dump files\">#6540</a></span>).\n\n<p></p></li><li>\"Process\" isn't the best term. Something like PROGRAM would be more\naccurate.\n\n<p></p></li><li>Should this code (particularly get_corefile_process()) be marked\nunix-only?\n\n<p></p></li><li>Use our my_popen() function instead of popen(). Our version doesn't\ninvoke the shell, so no one can play games with cleverly-crafted\nfilenames.\n\n<p></p></li><li>In get_corefile_process(), a unique_ptr would be better than a\nshared_ptr.\n\n<p></p></li><li>In get_corefile_process(), what if the output of 'file' is malformed?\nFor example, if the token after \"execfn:\" isn't something like\n'/foo/bar', then string::substr() can throw an exception.\n\n<p></p></li><li>In check_log_dir(), there are several situations in which a file\nisn't marked as good or bad. Is that the best action in these cases?\n<ul>\n<li>Two core files have the same timestamp.\n</li><li>Stat'ing the file fails.\n</li><li>get_corefile_process() fails to return an executable name.\n</li></ul>\n\n<p></p></li><li>10Mb seems like an awfully low default for max core file size. We'd\ndelete all core files for a moderately busy schedd, collector, or\nnegotiator.\n</li></ul>\n\n<p></p><hr/>\n<em>2018-Apr-24 14:10:53 by jfrey:</em> <br/>\n\n<strong>Code Review, cont.</strong>\n\n<p></p><ul>\n<li>You can get core files on windows, though they're little more than a stack trace. Running 'file' won't work there.\n\n<p></p></li><li>Consider using our run_command() function. It uses our my_popen() to run a command, then returns all of the output in a buffer. It also has a timeout.\n</li></ul>\n\n<p></p><hr/>\n<em>2018-Apr-27 15:45:23 by coatsworth:</em> <br/>\n\nI've fixed most of the things you mentioned, you can see them in the github comparison:\n\n<p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/compare/V8_6-branch...V8_6-gt6520-core-cleanup\">https://github.com/htcondor/htcondor/compare/V8_6-branch...V8_6-gt6520-core-cleanup</a>\n\n</p><p>A few comments:\n\n</p><p>* First, my main design philosophy here is we don't want to accidentally delete important files. If we're unsure about a file for whatever reason, we ignore it. If we can't stat a core file, or we can't identify who created it, ignore it. The the 'file' command returns weird output, ignore it. I don't want to flag the file as good because we don't actually know if it's good. But good files and ignored files get treated the same: they don't get erased.\n\n</p><p>* Sorry about the wrong ticket number, I named my branch wrong and then the error spilled over into my commit messages :( Is this a big deal? Should I nuke the branch and make a new one with new commits?\n\n</p><p>* We're not going to check core files on Windows. I've #ifdef-ed this all out.\n\n</p><p>* In get_corefile_process(), the shared_ptr constructor is much easier to construct with a pointer and deleter. I couldn't get unique_ptr to work. Is it okay if I leave as is?\n\n</p><p>* I decided not to use run_command because it's not used anywhere in the condor codebase, I figured there must be a reason for that.\n\n</p><p>* Default for max core file size is now 50 Mb, does that sound reasonable? If not let me know what's a good number.\n\n</p><p></p><hr/>\n<em>2018-May-03 11:49:05 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The current code looks ok.\n\n</p><p>In reply to your comments:\n\n</p><p></p><ul>\n<li>\"When in doubt, leave it alone\" sounds like the right approach.\n\n<p></p></li><li>No need to change anything due to the wrong ticket number. Making the branch name and commits visible in this ticket is sufficient.\n\n<p></p></li><li>shared_ptr is fine, if unique_ptr is being a butt. I haven't used a custom deleter with either, but the docs made it look like they would work the same.\n\n<p></p></li><li>TJ recommended run_command(), which he added not too long ago. Given that no other code is using it, avoiding it seems appropriate.\n\n<p></p></li><li>The default max core file size is something we should probably poll the rest of the FW team about.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-30 11:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/552b782213eb260856f7630304ebcd28cce87736\">[55234]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6540\" onclick=\"get_ticket_and_populate_wrapper('6540'); return false;\" title=\"Preen should clean up core dump files\">#6540</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-03 12:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/99d940557d86f9e831227bccd42c3bed99234d9c\">[54831]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d1626fd98b8c364b8668c2a8c1ae73343a721d7\">[52958]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54c26fff30110ea02169685355cc238e916e2160\">[52961]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/44a5364a6eff4905cb93bf534343a5afa68d2997\">[52964]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/caa01539d0c373f26cec76e0a888b58afdf33cb2\">[52967]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6da37e0e8fde0e0cf2d9e127d993736fef2033b0\">[52968]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f4f8b2278edb2d5ed6ed9b789021933818efebd8\">[52969]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1cc52f056a31bcc38ec89cc064159d82e121c717\">[52984]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37e74a9faf60771c81baaa4046cf19fafb89ad31\">[52985]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/91d330886d4943fff8498fc545b8347653026f22\">[52986]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2047dfc7bf23df77b70817bb740910d3eaa6f19e\">[52987]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/636d6cc1e0acabf03c21a95261e5c02957cd3891\">[52988]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d0489ddec3a27d59ff6990ac7f1f8645e3ac1c56\">[52989]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a7e526f60d5281b26b3551637fa26ea39d0a4de\">[52990]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92b90db80c9760a8a44ce39762ce266cf81e0168\">[52992]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0a755c930128e74b72de20c5b7016be286fc0bd3\">[52995]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a810412e6de5b0028cdfe667860669b2bca9960\">[52996]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d2526225e37234a6f91a0ddc24e91405fd4035c1\">[52997]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/02955fe54da1fdff82a4ffc644aedba18a4c750e\">[52999]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a845db6768a46bb8ca9781ced02a30574a63e5a6\">[53000]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37cdd039fd4a73d9b354fc6328e6125cd015789a\">[53018]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/22f073a5ce0eee973a01fc097bcb9875e11d8222\">[53019]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/29c3ac80eb6af63a60ff8209e61c45570e9197fe\">[53021]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/453989bd3a5e1c64936e4afefacf20e76a9aa249\">[53023]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9d2686e2f682473903a9735c34dcc3e950e8d68b\">[53025]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6fa4b723b23031b7ed54b6024c414478f757116\">[53027]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/be79550121fb630f237926dce64cc762c517d990\">[53046]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db9b5e1fa42589d34536953035a1a84a0e1153f8\">[53047]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4dfc3e01a7a71299332e44c4f223d9d481e34939\">[53079]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a836895a4d6e230e7759ce456e4d17cc85c19c42\">[53083]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/685d125f1b0bfc699aa886dd1cbacf7ba330ba41\">[53099]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/be7bf8482f085b0780971363c8dde1de783d87f6\">[53100]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b8d1060aa95b9589237a8ae1a96f6ec2597df52\">[53109]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c0ec1c213ee7f03f64ba3046533f67da3863bf74\">[53111]</a></span>,\u00a0[...]\n (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-27 15:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/acca2e9e7d5f918129430daecf7e57dd8e4d2dd3\">[54803]</a></span>: Added some fixes suggested in code review (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6540\" onclick=\"get_ticket_and_populate_wrapper('6540'); return false;\" title=\"Preen should clean up core dump files\">#6540</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-16 15:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/76dc4ff613315ba7d7e7417217ccea12c0ec7a92\">[54734]</a></span>: Fixed Windows build problems (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6540\" onclick=\"get_ticket_and_populate_wrapper('6540'); return false;\" title=\"Preen should clean up core dump files\">#6540</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-10 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/943a93ae99b348f8ea05cd9268c1a005ba96dc0d\">[54685]</a></span>: Added preen logic to clean up core files (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6540\" onclick=\"get_ticket_and_populate_wrapper('6540'); return false;\" title=\"Preen should clean up core dump files\">#6540</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Jul-30 13:46", "status": "resolved", "created": "2018-Jan-24 14:21", "fixed_version": "2018-Jan-24 14:21", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "coatsworth", "derived_from": "", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}