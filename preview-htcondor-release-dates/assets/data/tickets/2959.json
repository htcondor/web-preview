{"id": 2959, "title": "Ticket #2959: Autofs and MOUNT_UNDER_SCRATCH do not mix", "description": "<blockquote>\nThe MOUNT_UNDER_SCRATCH feature comes with one drawback - automount in Linux doesn't understand namespaces.  Hence, when automount triggers, it will mount the filesystem in the <strong>parent</strong> namespace and it's not available in the job.\n\n<p>You end up with an error message like this when mixing autofs and MOUNT_UNDER_SCRATCH:\n</p><div class=\"verbatim\">\n<pre>[bbockelm@rcf-bockelman condor]$ condor_run ls /cvmfs/cms.cern.ch\nls: cannot open directory /cvmfs/cms.cern.ch: Too many levels of symbolic links\n</pre></div>\n\n\n<p>While this is technically a problem with automount, I think it'll be quite awhile before a fixed version is widely available.  Hence, we should provide a workaround, such as upgrading autofs mountpoints to shared-subtrees.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-May-10 19:12:44 by bbockelm:</em> <br/>\n\nCrap.  Missed a hunk from this patch.  If only we had pull requests...\n\n<p></p><div class=\"verbatim\">\n<pre>diff --git a/build/cmake/CondorConfigure.cmake b/build/cmake/CondorConfigure.cmake\nindex 2b120b5..213426a 100644\n--- a/build/cmake/CondorConfigure.cmake\n+++ b/build/cmake/CondorConfigure.cmake\n@@ -146,6 +146,7 @@ if( NOT WINDOWS)\n        check_library_exists(dl dlopen \"\" HAVE_DLOPEN)\n        check_symbol_exists(res_init \"sys/types.h;netinet/in.h;arpa/nameser.h;resolv.h\" HAVE_DECL_RES_INIT)\n        check_symbol_exists(MS_PRIVATE \"sys/mount.h\" HAVE_MS_PRIVATE)\n+       check_symbol_exists(MS_SHARED  \"sys/mount.h\" HAVE_MS_SHARED)\n\n        check_function_exists(\"access\" HAVE_ACCESS)\n        check_function_exists(\"clone\" HAVE_CLONE)\n</pre></div>\n\n<hr/>\n<em>2012-Aug-23 14:09:08 by zmiller:</em> <br/>\n\nBulk change of target version from v070802 to v070803 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/559/condor_autofs.patch\">condor_autofs.patch</a>\n4152 bytes added by bbockelm on 2012-Apr-27 01:45:49 UTC.\n<br/>\nThe attached patch changes autofs mounts to shared-subtree.\n\n<p>NOTE this also fixes a bug where HAVE_MS_PRIVATE is left undefined even if it is detected.  That means the trick to have MOUNT_UNDER_SCRATCH mount points to be made private (essential for F16) doesn't work.<br/>\n</p></li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-11 07:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fba3446dd59410f23274a970ba17769352305c68\">[32023]</a></span>: Additional symbol check for Autofs &amp;&amp; MOUNT_UNDER_SCRATCH ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2959\" onclick=\"get_ticket_and_populate_wrapper('2959'); return false;\" title=\"Autofs and MOUNT_UNDER_SCRATCH do not mix\">#2959</a></span>  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-27 13:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c9db708cfc620f911b7b743233f5e5923ac5381a\">[31843]</a></span>: bbockelms modification to handle autofs and mount_under_scratch ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2959\" onclick=\"get_ticket_and_populate_wrapper('2959'); return false;\" title=\"Autofs and MOUNT_UNDER_SCRATCH do not mix\">#2959</a></span> ===VersionHistory:None===  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Aug-23 14:09", "status": "resolved", "created": "2012-Apr-26 20:43", "fixed_version": "2012-Apr-26 20:43", "broken_version": "v070705", "priority": "2", "subsystem": "Libs", "assigned_to": "gthain", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}