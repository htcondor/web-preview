{"id": 7613, "title": "Ticket #7613: condor_ssh_to_job inside container issue with different condor PATHs", "description": "<blockquote>\nWhen I try to use condor_submit -i, or condor_ssh_to_job into a job running using singularity containers, it fails with:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">[khurtado@camlnd ~]$ condor_ssh_to_job -debug 60.0\n04/22/20 10:37:01 SharedPortClient: sent connection request to schedd at &lt;x.x.x.x:9618&gt; for shared port id 1679808_2562_3\n04/22/20 10:37:01 SharedPortClient: sent connection request to local schedd for shared port id 1679808_2562_3\n04/22/20 10:37:01 Response for GET_JOB_CONNECT_INFO:\nServerTime = 1587566221\nResult = true\nStarterIpAddr = \"&lt;10.32.89.25:9618?addrs=10.32.89.25-9618&amp;noUDP&amp;sock=27245_512d_41&gt;\"\nRemoteHost = \"slot1_2@qa-rtx6k-026.crc.nd.edu\"\nCondorVersion = \"$CondorVersion: 8.8.8 Feb 17 2020 BuildID: 496171 $\"\n\n04/22/20 10:37:01 Got connect info for starter &lt;x.x.x.x:9618?addrs=x.x.x.x-9618&amp;noUDP&amp;sock=27245_512d_41&gt;\n04/22/20 10:37:01 SharedPortClient: sent connection request to starter at &lt;10.32.89.25:9618&gt; for shared port id 27245_512d_41\n04/22/20 10:37:01 Executing ssh command: ssh -oUser=khurtado -oIdentityFile=/tmp/khurtado.condor_ssh_to_job_ebeeac57/ssh_key -oStrictHostKeyChecking=yes -oUserKnownHostsFile=/tmp/khurtado.condor_ssh_to_job_ebeeac57/known_hosts -oGlobalKnownHostsFile=/tmp/khurtado.condor_ssh_to_job_ebeeac57/known_hosts -oProxyCommand=\"condor_ssh_to_job\"' '\"-debug\"' '\"-proxy\"' '\"/tmp/khurtado.condor_ssh_to_job_ebeeac57/fdpass\" condor-job.xx.crc.nd.edu\n04/22/20 10:37:01 Passed ssh connection to ssh proxy.\n04/22/20 10:37:01 Setting up ssh proxy on file descriptor 4\nWelcome to slot1_2@xx.nd.edu!\nYour condor job is running with pid(s) 63160.\n/opt/condor/RedHat7/libexec/condor_ssh_to_job_shell_setup: line 50: /usr/bin/condor_docker_enter: No such file or directory\nConnection to condor-job.x.x.x.crc.nd.edu closed.\n</pre></div>\n\nThis is because in the workers, we have the condor binaries located somewhere else and added to the environment via PATH. Specifically:\n\n<p>/opt/condor/RedHat7/bin/condor_docker_enter\n\n</p><p>Condor seems to expect this binary in /usr/bin only:\n\n</p><p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/e9fa217ada022108e5403092adfd9790f2ad0c5b/src/condor_starter.V6.1/condor_ssh_to_job_shell_setup#L50\">https://github.com/htcondor/htcondor/blob/e9fa217ada022108e5403092adfd9790f2ad0c5b/src/condor_starter.V6.1/condor_ssh_to_job_shell_setup#L50</a>\n\n</p><p>I think there should some logic that tries to find condor_docker_enter in the environment if it is not found inside /usr/bin, to better deal with this case.\n\n</p><p>For now, we are just creating a symlink to /usr/bin for this binary.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Apr-24 13:30:25 by tannenba:</em> <br/>\n\nThe issue is ssh_to_job helper script assumes HTCondor is installed in /usr/bin.  Pushing a patch to pass the value of the BIN config knob via the environment (we already pass lots of things that way), as\nI don't want to assume that HTCondor is already in the PATH of the ssh helper script... seems better to explicitly tell it where BIN is.  From there it can run condor_config_val to find out any value or path it may require.\n\n<p></p><hr/>\n<em>2020-Apr-24 13:32:46 by khurtado:</em> <br/>\n\nHello. I agree that would be the best approach to solve this!\n\n<p></p><hr/>\n<em>2020-Apr-27 17:13:38 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong> All good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-24 13:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1f82705568e4b1c52c81c6db72471556ed038b0b\">[59477]</a></span>: Documentation and version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7613\" onclick=\"get_ticket_and_populate_wrapper('7613'); return false;\" title=\"condor_ssh_to_job inside container issue with different condor PATHs\">#7613</a></span>.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-24 13:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fa0f7ef7ecb626a8ae3b6abaf1078b864f22839f\">[59476]</a></span>: Fix problems with ssh_to_job to container if BIN is not /usr/bin. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7613\" onclick=\"get_ticket_and_populate_wrapper('7613'); return false;\" title=\"condor_ssh_to_job inside container issue with different condor PATHs\">#7613</a></span> Note we now pass the value of config knob BIN to the job via the environment variable _CONDOR_BIN.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Aug-21 12:50", "status": "resolved", "created": "2020-Apr-22 09:51", "fixed_version": "2020-Apr-22 09:51", "broken_version": "v080800", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "tannenba", "derived_from": "", "creator": "khurtado", "rust": "", "customer_group": "other", "visibility": "public", "notify": "khurtado@nd.edu tannenba@cs.wisc.edu", "due_date": ""}