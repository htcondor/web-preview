{"id": 7131, "title": "Ticket #7131: Simpify WithinResourceLimits Expression", "description": "<blockquote>\nWhen configured to use partitionable slots, the startd and's into the Requirements expression <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WithinResourceLimits\" title=\"Within Resource Limits\">WithinResourceLimits</a></span>.  This expression is\n\n<p></p><div class=\"code\">\n<pre class=\"code\">WithinResourceLimits =\nifThenElse(TARGET._condor_RequestCpus =!= undefined,MY.Cpus &gt; 0 &amp;&amp; TARGET._condor_RequestCpus &lt;= MY.Cpus,\n                              ifThenElse(TARGET.RequestCpus =!= undefined,MY.Cpus &gt; 0 &amp;&amp; TARGET.RequestCpus &lt;= MY.Cpus,1 &lt;= MY.Cpus)) &amp;&amp;\nifThenElse(TARGET._condor_RequestMemory =!= undefined,MY.Memory &gt; 0 &amp;&amp; TARGET._condor_RequestMemory &lt;= MY.Memory,\n                              ifThenElse(TARGET.RequestMemory =!= undefined,MY.Memory &gt; 0 &amp;&amp; TARGET.RequestMemory &lt;= MY.Memory,false)) &amp;&amp;\nfThenElse(TARGET._condor_RequestDisk =!= undefined,MY.Disk &gt; 0 &amp;&amp; TARGET._condor_RequestDisk &lt;= MY.Disk,\n                              ifThenElse(TARGET.RequestDisk =!= undefined,MY.Disk &gt; 0 &amp;&amp; TARGET.RequestDisk &lt;= MY.Disk,false)))\n\n</pre></div>\n\n\n<p>This expression is large, unwieldy and slow to evaluate.  It looks at the values _condor_Request{CPUS,Memory,Disk}, which we never set.  There are future plans that the schedd may set this, but they aren't used today.  Also, it checks that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestCpus\" title=\"Request Cpus\">RequestCpus</a></span> is undefined, and if so, defaults it to 1 cpu.  <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestMemory\" title=\"Request Memory\">RequestMemory</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestDisk\" title=\"Request Disk\">RequestDisk</a></span> have no defaults.\n\n</p><p>Changing this to assume that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestCpus\" title=\"Request Cpus\">RequestCpus</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestMemory\" title=\"Request Memory\">RequestMemory</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestDisk\" title=\"Request Disk\">RequestDisk</a></span> are always set, and if they are undefined, to evaluated to undefined (and thus not match a job) significantly simplifies this expression.  Testing of classads in CHTC shows that this change doubles the speed of matchmaking.  In this ticket, we will define a knob STARTD_JOB_HAS_REQUEST_ATTRS that replaces this complicated expression with the much simpler\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">WithinResourceLimits =\n MY.Cpus &gt; 0 &amp;&amp; TARGET.RequestCpus &lt;= MY.Cpus &amp;&amp;\n MY.Memory &gt; 0 &amp;&amp; TARGET.RequestMemory &lt;= MY.Memory &amp;&amp;\n MY.Disk &gt; 0 &amp;&amp; TARGET.RequestDisk &lt;= MY.Disk\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Jul-25 13:18:45 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-04 12:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9e2a3ea7fe0ad76c355804f7079a5c032590a63e\">[57755]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7131\" onclick=\"get_ticket_and_populate_wrapper('7131'); return false;\" title=\"Simpify WithinResourceLimits Expression\">#7131</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-27 12:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0273dcbf64573214a80a3763298f2f5741e1f1b4\">[57238]</a></span>: Simply <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WithinResourceLimits\" title=\"Within Resource Limits\">WithinResourceLimits</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7131\" onclick=\"get_ticket_and_populate_wrapper('7131'); return false;\" title=\"Simpify WithinResourceLimits Expression\">#7131</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Sep-04 12:34", "status": "resolved", "created": "2019-Jun-27 12:30", "fixed_version": "2019-Jun-27 12:30", "broken_version": "v080900", "priority": "3", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}