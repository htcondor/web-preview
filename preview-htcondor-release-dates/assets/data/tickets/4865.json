{"id": 4865, "title": "Ticket #4865: cream_gahp fails at startup due to native package Globus", "description": "<blockquote>\nIn the cream_gahp, Globus uses lt_dlopen() to load a thread library. lt_dlopen() ignores the executable's RPATH, so it won't find the copy of the library that we include in UW builds of HTCondor. In <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4440\" onclick=\"get_ticket_and_populate_wrapper('4440'); return false;\" title=\"cream_gahp fails at startup due to lt_dlopen() search path\">#4440</a></span>, we attempted to solve this problem by using dlopen() to load the library at the top of main(). lt_dlopen() would then use the already-loaded copy of the library.\n\n<p>It turns out this only works if lt_dlopen() can't find the library in all of the places where it looks. If it finds a copy of the library under /usr/lib, it will load that copy of the library, in addition to the copy loaded by dlopen().\n\n</p><p>In the UW native packages for HTCondor, the RPATH is set to prefer libraries in /usr/lib/condor over any in /usr/lib. If Globus libraries are installed in /usr/lib, then the cream_gahp ends up using Globus libraries in /usr/lib/condor plus the Globus thread library in /usr/lib. The Globus libraries from EPEL appear to be incompatible with those we distribute with HTCondor. With Globus libraries from EPEL and the UW RPM of Condor 8.3.2 installed, the cream_gahp fails on startup with this error:\n</p><div class=\"verbatim\">\n<pre>dlsym: /usr/lib64/libglobus_thread_pthread.so: undefined symbol: globus_extension_module\n</pre></div>\n\n\n<p>We can fix this by modifying the RPATH in our native linux packages to explicitly list /usr/lib before /usr/lib/condor. Then, the cream_gahp and other HTCondor binaries will use Globus libraries in /usr/lib if they are present. The tarball release already works this way.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Apr-07 11:57:49 by adesmet:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Approved.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-07 10:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ba1381bfd48358ae07c4efa95ad9cd3d8c00a708\">[44545]</a></span>: super minor 8.2.8 version history item changes for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4865\" onclick=\"get_ticket_and_populate_wrapper('4865'); return false;\" title=\"cream_gahp fails at startup due to native package Globus\">#4865</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4938\" onclick=\"get_ticket_and_populate_wrapper('4938'); return false;\" title=\"Add missing config line in blahp lsf submit script\">#4938</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-07 09:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c380e4dfbc19da0d175229bd43f30ad3cad8252a\">[44543]</a></span>: Docs for cream_gahp Globus library jumble. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4865\" onclick=\"get_ticket_and_populate_wrapper('4865'); return false;\" title=\"cream_gahp fails at startup due to native package Globus\">#4865</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-16 11:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/caaac16cabb493678b347cdb8a5ff3f06c1c3d6f\">[43592]</a></span>: Prefer system libraries in linux native packages. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4865\" onclick=\"get_ticket_and_populate_wrapper('4865'); return false;\" title=\"cream_gahp fails at startup due to native package Globus\">#4865</a></span> For our RUNPATH, look for shared libraries in /usr/lib[64] before /usr/lib[64]/condor. This matches the RUNPATH in the tarball packaging. And it fixes a problem with the cream_gahp, where we can end up using two incompatible versions of the Globus\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Apr-07 11:58", "status": "resolved", "created": "2015-Feb-03 15:36", "fixed_version": "2015-Feb-03 15:36", "broken_version": "v080202", "priority": "3", "subsystem": "Grid", "assigned_to": "adesmet", "derived_from": "#4440", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}