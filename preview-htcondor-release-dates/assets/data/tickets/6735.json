{"id": 6735, "title": "Ticket #6735: Delay between execution of jobs on Windows with shared_port enabled", "description": "<blockquote>\nOn Windows, when using the default configuration of\n\n<p></p><pre>   USE_SHARED_PORT = True\n</pre>\n\n<p>there appears to be a significant delay between the execution successive of jobs on the same claim/slot.  This can add a lot of overhead if the jobs are short-running.\n\n</p><p>The problem appears to happen because the <code>condor_starter</code> takes a long time to exit after the job completes because the SIGTERM from the <code>condor_startd</code> to the <code>condor_starter</code> is not delivered.  Behold the following clue from the <code>StartLog</code>:\n\n</p><p></p><pre>   08/10/18 13:38:36 Send_Signal: Warning: could not send signal 15 (SIGTERM) to pid 6488 (still alive)\n   08/10/18 13:38:36 slot3: Error sending signal to starter, errno = 42 (Illegal byte sequence)\n   08/10/18 13:38:36 slot3: State change: Error sending signals to starter\n   08/10/18 13:38:36 slot3: Changing state and activity: Preempting/Vacating -&gt; Owner/Idle\n   08/10/18 13:38:36 slot3: State change: IS_OWNER is false\n   08/10/18 13:38:36 slot3: Changing state: Owner -&gt; Unclaimed\n   08/10/18 13:38:36 Starter pid 6488 exited with status 0\n   08/10/18 13:38:36 Warning: Starter pid 6488 is not associated with a claim. A slot may fail to transition to Idle.\n</pre>\n\n<p>followed by lots of <code>StartLog</code> messages like the following\n\n</p><p></p><pre>   08/10/18 13:38:22 slot3: Got activate claim while starter is still alive.\n   08/10/18 13:38:22 slot3: Telling shadow to try again later.\n   08/10/18 13:38:23 slot3: Got activate claim while starter is still alive.\n   08/10/18 13:38:23 slot3: Telling shadow to try again later.\n   ...\n</pre>\n\n<p><strong>Immediate Workaround</strong>\n\n</p><p>Until this bug is fixed, a suggested configuration based work around is to simply disable the shared_port daemon on Windows. So first stop the HTCondor service on Windows (<code>net stop condor</code>), then append <code>USE_SHARED_PORT=False</code> to the condor_config[.local] file, the restart the HTCondor service (<code>net start condor</code>).  Note this workaround means that HTCondor will no longer use a single well-known TCP port, and thus you may need to adjust firewall rules at your site accordingly.\n\n</p><p><strong>Reproduce</strong>\n\n</p><p>To reproduce the problem, simply start a personal condor on Windows with shared_port enabled and submit a cluster of short jobs, and time how it takes the cluster of jobs to complete.  Now re-run the same test with shared_port disabled, and behold the difference.  On my Windows 7 laptop with four cores running HTCondor v8.7.12, the job cluster below took 76 seconds (!!!) to complete with shared_port enabled and just 7 seconds with shared_port disabled :\n\n</p><p></p><pre>   executable = c:\\utils\\sleep.exe\n   arguments = 0\n   transfer_executable = false\n   log = fast.log\n   queue 20\n</pre>\n\n<p><strong>Suggested Source Code Patch</strong>\n\n</p><p>Suggest that we first get signals working again reliably on Windows, perhaps by always having <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> enable the UDP command port (even if shared_port is enabled) and then having the parent UDP signal directly to the child without going through shared port.\n\n</p><p>Longer term, we should also consider having the <code>condor_starter</code> simply exit when it is done instead of waiting around for the startd to tell it to exit.  This would have performance benefits on Linux as well.</p></blockquote>", "remarks": "<blockquote>\nThis is very likely to be a manifestation of the bug that was fixed in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6960\" onclick=\"get_ticket_and_populate_wrapper('6960'); return false;\" title=\"shared port on Windows can make damons slow to notice signals\">#6960</a></span></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2019-Apr-23 11:09", "status": "abandoned", "created": "2018-Aug-10 14:10", "fixed_version": "2018-Aug-10 14:10", "broken_version": "v080600", "priority": "3", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "#6960", "creator": "tannenba", "rust": "a93499", "customer_group": "users", "visibility": "public", "notify": "johnkn@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}