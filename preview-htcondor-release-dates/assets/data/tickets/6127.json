{"id": 6127, "title": "Ticket #6127: GSI hostname checks are broken, confusing, do not comply with RFC 2818", "description": "<blockquote>\nThe way GSI host certificates and their hostnames are used in HTCondor is confusing and incorrect when there isn't a one-to-one mapping between cert and host. (For example, if there are host aliases, or one cert used for multiple hosts, among other cases).\n\n<p>A work plan needs to be created to address Tom's observations, which I have below from ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5857\" onclick=\"get_ticket_and_populate_wrapper('5857'); return false;\" title=\"condor_q -global does not support IP-based security\">#5857</a></span>:\n\n</p><p></p><hr/>\n<em>2017-Feb-01 17:00:11 by tpdownes:</em> <br/>\n\nI have updated my certificate to include the private DNS name and condor's implementation of GSI authentication nevertheless does not work.\n\n<p></p><div class=\"verbatim\">\n<pre>[pcdev1:~] condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt; : pcdev2.nemo.uwm.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:We are trying to connect to a daemon with certificate DN (/DC=org/DC=incommon/C=US/postalCode=53211/ST=Wisconsin/L=Milwaukee/street=1900 E. Kenwood Blvd/O=University of Wisconsin-Milwaukee/OU=Physics/CN=pcdev2.ligo.uwm.edu), but the host name in the certificate does not match any DNS name associated with the host to which we are connecting (host name is 'pcdev2.nemo.uwm.edu', IP is '172.20.1.34', Condor connection address is '&lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt;').  Check that DNS is correctly configured.  If the certificate is for a DNS alias, configure HOST_ALIAS in the daemon's configuration.  If you wish to use a daemon certificate that does not match the daemon's host name, make GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or disable all host name checks by setting GSI_SKIP_HOST_CHECK=true or by defining GSI_DAEMON_NAME.\n</pre></div>\n\n\n<p>It seems like you're doing a \"dumb\": comparison of the subject DN rather than reading the subject alternative names.\n\n</p><p>From output of \"openssl x509 -in /etc/grid-security/hostcert.pem -noout -text\"\n</p><div class=\"verbatim\">\n<pre>            X509v3 Subject Alternative Name:\n                DNS:pcdev1.ligo.uwm.edu, DNS:pcdev1.cgca.uwm.edu, DNS:pcdev1.nemo.uwm.edu, DNS:pcdev1.phys.uwm.edu\n</pre></div>\n\n\n<p><a class=\"external\" href=\"https://docs.globus.org/security-bulletins/2015-12-strict-mode/\">https://docs.globus.org/security-bulletins/2015-12-strict-mode/</a>\n\n</p><p></p><hr/>\n<em>2017-Feb-02 09:43:46 by tpdownes:</em> <br/>\n\nEven disabling the comparison doesn't seem to fix the problem.\n<div class=\"verbatim\">\n<pre>root@pcdev1:~# condor_config_val GSI_SKIP_HOST_CHECK\ntrue\nroot@pcdev1:~# condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt; : pcdev2.nemo.uwm.edu\nSECMAN:2007:Failed to received post-auth ClassAd\nAUTHENTICATE:1004:Failed to authenticate using KERBEROS\nAUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n\n\n<p></p><hr/>\n<em>2017-Feb-02 09:46:05 by tpdownes:</em> <br/>\n\nSec. 3.5.25 of the Condor 8.6.0 manual \"Configuration File Entries Relating to Security\" begins with the text \"This section has not yet been written\" for many security-related knobs.\n\n<p></p><hr/>\n<em>2017-Feb-02 10:07:18 by tpdownes:</em> <br/>\n\nAdding the following configuration and rebooting the negotiator/collector\n<div class=\"verbatim\">\n<pre>root@pcdev2:~# condor_config_val HOST_ALIAS\npcdev2.ligo.uwm.edu\n</pre></div>\n\n\n<p>does not change the result\n\n</p><p></p><div class=\"verbatim\">\n<pre>[pcdev1:~] condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt; : pcdev2.nemo.uwm.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:We are trying to connect to a daemon with certificate DN (/DC=org/DC=incommon/C=US/postalCode=53211/ST=Wisconsin/L=Milwaukee/street=1900 E. Kenwood Blvd/O=University of Wisconsin-Milwaukee/OU=Physics/CN=pcdev2.ligo.uwm.edu), but the host name in the certificate does not match any DNS name associated with the host to which we are connecting (host name is 'pcdev2.nemo.uwm.edu', IP is '172.20.1.34', Condor connection address is '&lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt;').  Check that DNS is correctly configured.  If the certificate is for a DNS alias, configure HOST_ALIAS in the daemon's configuration.  If you wish to use a daemon certificate that does not match the daemon's host name, make GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or disable all host name checks by setting GSI_SKIP_HOST_CHECK=true or by defining GSI_DAEMON_NAME.\n</pre></div>\n\n\n<p>It should further be noted that the error message is advising the use of GSI_DAEMON_NAME which the manual (even in recent 8.5) advises is retired.\n\n</p><p></p><hr/>\n<em>2017-Feb-02 12:24:57 by tpdownes:</em> <br/>\n\nIt may be lost in the noise, but the way you read certificates and validate their hostnames is, very literally, not what the specification tells you to do. To workaround your choice, you've added a lot of knobs to allow one certificate to stand-in for other hotsnames that aren't in the certificate subject.\n\n<p>GSI_SKIP_HOST_CHECK_CERT_REGEX,GSI_SKIP_HOST_CHECK,HOST_ALIAS\n\n</p><p>But, in 2017, certificates have these features built-in. This is one of the ways that the world of high-availability on the web works - a certificate can represent many FQDNs easily with subject alternative names and wildcards. See, e.g. the cert from www.nytimes.com.\n\n</p><p>Maybe, long ago, you needed these knobs. Now they're very much in the way of security.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Feb-03 12:29:43 by tannenba:</em> <br/>\n\nSection 3.1 of RFC 2818 likely has relevant information\n\n<p></p><hr/>\n<em>2017-Feb-03 20:12:01 by bbockelm:</em> <br/>\n\n(note - from the <code>MyAddress</code> Tom copied above, this looks like <code>HOST_ALIAS</code> wasn't setup right on <code>pcdev2</code>: we should revisit that after I record my piece below...)\n\n<p>It's quite possible I'm the institutional memory on this part of the authentication infrastructure?\n\n</p><p>RFC 2818 certainly existed when we did the original implementation, but the key difficulty is the fact that HTCondor internally <strong>doesn't</strong> necessarily use host names but whatever string is evaluated in the <code>Name</code> attribute.  We can also use the IP address from <code>MyAddress</code>, but that then relies on reverse DNS.  The <code>HOST_ALIAS</code> allows the HTCondor pool administrator to provide a mechanism that better aligns with certificates that might be on the host.\n\n</p><p>Ok, where are our opportunities to make this better?\n</p><ul>\n<li>We should probably utilize the <code>Name</code> attribute in the ad, possibly even to populate the host alias if it's not set by default.  This is closest we have to the \"name the user types into the URL bar\" that RFC2818 suggests using -- but not guaranteed to work if you name your schedd \"Brian is great!\".\n</li><li>We should outright drop populating the hostname based reverse DNS.  It was only an OK-ish decision a few years back when we utilized it but generally understood to be a Really Bad Idea now.\n<ul>\n<li>Do the normal deprecation period, add hidden knob, etc, etc.\n</li></ul>\n</li><li>Once the user's desired hostname is established (via <code>Name</code>, via <code>HOST_ALIAS</code>, or preferably not reverse DNS), we should utilize OpenSSL's APIs to compare the name versus the certificate.  OpenSSL understands SANs, wildcards, etc.\n<ul>\n<li>Right now, we use Globus's <code>gss_compare_name</code>: this is more oriented toward the kerberos heritage of Globus than the X509 certificate state-of-the-art.\n</li><li>Fixing this is the most \"bang for the buck\" and likely to fix most of the cases, including Tom's.\n</li></ul>\n</li></ul>\n\n<p></p><hr/>\n<em>2017-Feb-03 20:19:16 by bbockelm:</em> <br/>\n\nWhoops - stand correct on <code>gss_compare_name</code>.  It actually should handle <code>subjectAltNames</code> like Tom is expecting.  Not clear if HTCondor is failing to invoke it correctly or we're hitting a very subtle bug.\n\n<p></p><hr/>\n<em>2017-Feb-03 20:34:13 by bbockelm:</em> <br/>\n\nTwo other comments after reading through the ticket again:\n<ul>\n<li>When you skipped the host check, the error message you post looks like it might be hitting a failure somewhere else, not necessarily in the GSI hostname checks.\n</li><li>What precise HTCondor version and compilation are you using?  The Globus libraries have evolved rapidly in their support for RFC 2818 over the last few years.  I'd really hate to chase down a solved bug by looking at a different Globus version.\n</li></ul>\n\n<p></p><hr/>\n<em>2017-Feb-08 15:44:30 by tannenba:</em> <br/>\n\nNote: I broke out the specific issue of supporting subject alternative names in x509 into a separate ticket, <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=6135\" onclick=\"get_ticket_and_populate_wrapper('6135'); return false;\" title=\"Support Subject Alternative Names in gsi and ssl handling\">#6135</a></span>, at the request of OSG.\n\n<p></p><hr/>\n<em>2017-Feb-10 15:30:59 by tpdownes:</em> <br/>\n\nIt is indeed the case that I'm hitting a different error after I set GSI_SKIP_HOST_CHECK. I think it's the new 8.6 normal for condor_q requiring authentication, which I have not setup.\n\n<p>I also note this: I've unset GSI_SKIP_HOST_CHECK and ensured that all of my head nodes have certificates which include the private DNS name as a subject alternative name. Now I only get that 2nd error:\n\n</p><p></p><div class=\"verbatim\">\n<pre>[pcdev3:~] condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=435444_4204_3&gt; : pcdev2.nemo.uwm.edu\nSECMAN:2007:Failed to received post-auth ClassAd\nAUTHENTICATE:1004:Failed to authenticate using KERBEROS\nAUTHENTICATE:1004:Failed to authenticate using FS\n\n-- Failed to fetch ads from: &lt;172.20.1.35:9618?addrs=172.20.1.35-9618&amp;noUDP&amp;sock=2463625_ba1e_3&gt; : pcdev1.nemo.uwm.edu\nSECMAN:2007:Failed to received post-auth ClassAd\nAUTHENTICATE:1004:Failed to authenticate using KERBEROS\nAUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n\n\n<p>This makes me think that the error message is misleading. Maybe it's a result of the client's copy of /etc/grid-secuirty/hostcert.pem (which I may not have updated at the time) not including the client's hostname, even though the error message was printing certificate information about the server. Looking at the code, is that possible?\n\n</p><p>I'm using HTCondor 8.5.8 and the globus libraries from Debian Jessie.\n\n</p><p><a class=\"external\" href=\"https://packages.debian.org/search?keywords=globus&amp;searchon=names&amp;suite=stable&amp;section=all\">https://packages.debian.org/search?keywords=globus&amp;searchon=names&amp;suite=stable&amp;section=all</a>\n\n</p><p>I believe these are GT6 and comply with the Subject Alternative Names. So it's possible this is a non-issue, but the error message misled me into believing that it is.\n\n</p><p></p><hr/>\n<em>2017-Dec-13 16:43:01 by jfrey:</em> <br/>\n\nMy testing indicates that GSI hostname checks in Condor 8.6 respect DNS type Subject Alternative Names as described in RFC 2818.\n\n<p>Condor is not in full compliance with RFC 2818, as the CEDAR GSI code takes the server's IP address, determines the hostname via reverse- then forward-DNS lookups, and looks for that hostname in the server's certificate. But making Condor adhere fully to RFC 2818 would cause it to reject most of our users' certificates, as they lack <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=IpAddress\" title=\"Ip Address\">IpAddress</a></span> SAN items.\n\n</p><p>We believe our current setup is sufficiently secure.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2017-Dec-13 16:43", "status": "defer", "created": "2017-Feb-03 12:21", "fixed_version": "2017-Feb-03 12:21", "broken_version": "v080600", "priority": "5", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#5857", "creator": "zmiller", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "tannenba@cs.wisc.edu downes@uwm.edu,pcouvare@caltech.edu", "due_date": ""}