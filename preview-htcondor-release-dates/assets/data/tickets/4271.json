{"id": 4271, "title": "Ticket #4271: Implement a knob to limit total time for a negotiation cycle", "description": "<blockquote>\nThe negotiator has a knob to limit the negotiation cycle time per user and per pie spin.  We want to add a knob <code>NEGOTIATOR_MAX_TIME_PER_CYCLE</code> which places an upper time limit on the total negotiation cycle across all users/spins.</blockquote>", "remarks": "<blockquote>\n<em>2014-Mar-21 14:24:40 by tannenba:</em> <br/>\n\n<strong>TESTING</strong>\n\n<p>Place the following into condor_config of a personal condor:\n</p><div class=\"code\">\n<pre class=\"code\"># Negotiation cycle should quit after 5 seconds\nNEGOTIATOR_MAX_TIME_PER_CYCLE = 5\n# For testing, tell negotiator to pause 1 second after considering\n# each request\nNEG_SLEEP = 1\n</pre></div>\n\n\n<p>Next, submit a bunch of jobs:\n</p><div class=\"code\">\n<pre class=\"code\">executable = c:\\utils\\sleep.exe\narguments = 6000\nrequirements = GlobalJobId =!= UNDEFINED &amp;&amp; NotThere =?= True\nqueue 20\n</pre></div>\n\nNote the <code>requirements</code> expression used above will a) cause the jobs to never match, and b) cause all the jobs to end up in their own autocluster.  This, combined with the <code>NEG_SLEEP</code> setting in the config file, will ensure that negotiation will take longer than 5 seconds, assuming we submit more than 5 jobs.\n\n<p>Finally, ensure in the negotiator log that negotiation indeed stops after 5 seconds (which will likely be after considering 5 jobs).  You will want to see a debug line saying something like \"Reached Deadline...Stopping\".  Here is an example:\n</p><div class=\"code\">\n<pre class=\"code\">03/21/14 13:52:29 ---------- Started Negotiation Cycle ----------\n03/21/14 13:52:29 Phase 1:  Obtaining ads from collector ...\n03/21/14 13:52:29   Getting startd private ads ...\n03/21/14 13:52:29 Trying to query collector &lt;127.0.0.1:9618&gt;\n03/21/14 13:52:29   Getting Scheduler, Submitter and Machine ads ...\n03/21/14 13:52:29 Trying to query collector &lt;127.0.0.1:9618&gt;\n03/21/14 13:52:29   Sorting 6 ads ...\n03/21/14 13:52:29 Got ads: 6 public and 4 private\n03/21/14 13:52:29 Public ads include 1 submitter, 4 startd\n03/21/14 13:52:29 Phase 2:  Performing accounting ...\n03/21/14 13:52:29 Entering compute_significant_attrs()\n03/21/14 13:52:29 Leaving compute_significant_attrs() - result=Owner,JobUniverse\n,LastCheckpointPlatform,NumCkpts,SubmitterUserPrio\n03/21/14 13:52:29 Phase 3:  Sorting submitter ads by priority ...\n03/21/14 13:52:29 Phase 4.1:  Negotiating with schedds ...\n03/21/14 13:52:29     numSlots = 4\n03/21/14 13:52:29     slotWeightTotal = 4.000000\n03/21/14 13:52:29     pieLeft = 4.000\n03/21/14 13:52:29     NormalFactor = 1.000000\n03/21/14 13:52:29     MaxPrioValue = 0.508464\n03/21/14 13:52:29     NumSubmitterAds = 1\n03/21/14 13:52:29   Negotiating with tannenba@ToddsThinkpad at &lt;128.105.136.23:6\n2625&gt;\n03/21/14 13:52:29 0 seconds so far\n03/21/14 13:52:29   Calculating submitter limit with the following parameters\n03/21/14 13:52:29     SubmitterPrio       = 0.508464\n03/21/14 13:52:29     SubmitterPrioFactor = 1.000000\n03/21/14 13:52:29     submitterShare      = 1.000000\n03/21/14 13:52:29     submitterAbsShare   = 1.000000\n03/21/14 13:52:29     submitterLimit    = 4.000000\n03/21/14 13:52:29     submitterUsage    = 0.000000\n03/21/14 13:52:29 Socket to tannenba@ToddsThinkpad (&lt;128.105.136.23:62625&gt;) not\nin cache, creating one\n03/21/14 13:52:29 SocketCache:  Found unused slot 0\n03/21/14 13:52:29 begin sleep: 1 seconds\n03/21/14 13:52:30 end sleep: 1 seconds\n03/21/14 13:52:30     Sending SEND_JOB_INFO/eom\n03/21/14 13:52:30     Getting reply from schedd ...\n03/21/14 13:52:30     Got JOB_INFO command; getting classad/eom\n03/21/14 13:52:30     Request 00055.00000:  (request count 1 of 1)\n03/21/14 13:52:30 matchmakingAlgorithm: limit 4.000000 used 0.000000 pieLeft 4.0\n00000\n03/21/14 13:52:30       Rejected 55.0 tannenba@ToddsThinkpad &lt;128.105.136.23:626\n25&gt;: no match found\n03/21/14 13:52:30 begin sleep: 1 seconds\n03/21/14 13:52:31 end sleep: 1 seconds\n03/21/14 13:52:31     Sending SEND_JOB_INFO/eom\n03/21/14 13:52:31     Getting reply from schedd ...\n03/21/14 13:52:31     Got JOB_INFO command; getting classad/eom\n03/21/14 13:52:31     Request 00055.00001:  (request count 1 of 1)\n03/21/14 13:52:31 matchmakingAlgorithm: limit 4.000000 used 0.000000 pieLeft 4.0\n00000\n03/21/14 13:52:31       Rejected 55.1 tannenba@ToddsThinkpad &lt;128.105.136.23:626\n25&gt;: no match found\n03/21/14 13:52:31 begin sleep: 1 seconds\n03/21/14 13:52:32 end sleep: 1 seconds\n03/21/14 13:52:32     Sending SEND_JOB_INFO/eom\n03/21/14 13:52:32     Getting reply from schedd ...\n03/21/14 13:52:32     Got JOB_INFO command; getting classad/eom\n03/21/14 13:52:32     Request 00055.00002:  (request count 1 of 1)\n03/21/14 13:52:32 matchmakingAlgorithm: limit 4.000000 used 0.000000 pieLeft 4.0\n00000\n03/21/14 13:52:32       Rejected 55.2 tannenba@ToddsThinkpad &lt;128.105.136.23:626\n25&gt;: no match found\n03/21/14 13:52:32 begin sleep: 1 seconds\n03/21/14 13:52:33 end sleep: 1 seconds\n03/21/14 13:52:33     Sending SEND_JOB_INFO/eom\n03/21/14 13:52:33     Getting reply from schedd ...\n03/21/14 13:52:33     Got JOB_INFO command; getting classad/eom\n03/21/14 13:52:33     Request 00055.00003:  (request count 1 of 1)\n03/21/14 13:52:33 matchmakingAlgorithm: limit 4.000000 used 0.000000 pieLeft 4.0\n00000\n03/21/14 13:52:33       Rejected 55.3 tannenba@ToddsThinkpad &lt;128.105.136.23:626\n25&gt;: no match found\n03/21/14 13:52:33 begin sleep: 1 seconds\n03/21/14 13:52:34 end sleep: 1 seconds\n03/21/14 13:52:34     Sending SEND_JOB_INFO/eom\n03/21/14 13:52:34     Getting reply from schedd ...\n03/21/14 13:52:34     Got JOB_INFO command; getting classad/eom\n03/21/14 13:52:34     Request 00055.00004:  (request count 1 of 1)\n03/21/14 13:52:34 matchmakingAlgorithm: limit 4.000000 used 0.000000 pieLeft 4.0\n00000\n03/21/14 13:52:34       Rejected 55.4 tannenba@ToddsThinkpad &lt;128.105.136.23:626\n25&gt;: no match found\n03/21/14 13:52:34     Reached deadline for tannenba@ToddsThinkpad (&lt;128.105.136.\n23:62625&gt;) after 5 sec... stopping\n       MAX_TIME_PER_SUBMITTER = 31536000 sec, MAX_TIME_PER_CYCLE = 5 sec, MAX_TI\nME_PER_PIESPIN = 31536000 sec\n03/21/14 13:52:34   This submitter hit its submitterLimit.\n03/21/14 13:52:34  resources used scheddUsed= 0.000000\n03/21/14 13:52:34  negotiateWithGroup resources used scheddAds length 1\n03/21/14 13:52:34 ---------- Finished Negotiation Cycle ----------\n</pre></div>\n\n\n<p></p><hr/>\n<em>2014-Mar-21 14:28:40 by tannenba:</em> <br/>\n\nAdded a entry to add a regression test into the list in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3594\" onclick=\"get_ticket_and_populate_wrapper('3594'); return false;\" title=\"Regression Test Ideas and Work\">#3594</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-24 17:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ad04e9808961bf05899caeb91a24078ea53493f4\">[39697]</a></span>: minor 8.1.5 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4271\" onclick=\"get_ticket_and_populate_wrapper('4271'); return false;\" title=\"Implement a knob to limit total time for a negotiation cycle\">#4271</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-21 14:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/73467ca1f9b96186bec8ed7bc3ab6b8eb16eead1\">[39684]</a></span>: Documentation for NEGOTIATOR_MAX_TIME_PER_CYCLE. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4271\" onclick=\"get_ticket_and_populate_wrapper('4271'); return false;\" title=\"Implement a knob to limit total time for a negotiation cycle\">#4271</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-21 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8e3c6e11678fb6a31302bbf8ae7e440b51309f7a\">[39683]</a></span>: Implement NEGOTIATOR_MAX_TIME_PER_CYCLE. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4271\" onclick=\"get_ticket_and_populate_wrapper('4271'); return false;\" title=\"Implement a knob to limit total time for a negotiation cycle\">#4271</a></span> This knob places an upper time limit on the total negotiation cycle across all users/spins.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Mar-21 14:29", "status": "resolved", "created": "2014-Mar-21 13:59", "fixed_version": "2014-Mar-21 13:59", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, isfiligoi@ucsd.edu", "due_date": ""}