{"id": 2316, "title": "Ticket #2316: Condor's use of glexec fails on EGI sites", "description": "<blockquote>\nDear Condor team.\n\n<p>I have noticed the glideins don't work in Europe with glexec.\nAfter some debugging, I nailed it down to condor setting X509_USER_PROXY to the user proxy during condor_glexec_run.\n\n</p><p>This is in violation of the glexec sematics:\n<a class=\"external\" href=\"https://www.nikhef.nl/pub/projects/grid/gridwiki/index.php/Proxy_file_handling_in_gLExec\">https://www.nikhef.nl/pub/projects/grid/gridwiki/index.php/Proxy_file_handling_in_gLExec</a>\nX509_USER_PROXY should remain pointed to the pilot proxy at all times, when invoking glexec.\n\n</p><p>BTW: The reason it worked on OSG is that OSG deploys an older version of glexec, where this semantics was slightly different.\n(i.e. X509_USER_PROXY was not used at all)\n\n</p><p>Can you please fix this, possibly in the 7.6.X series?\nThis is a high priority request, and I think I can speak in CMS's name.\nThis \"bug\" is preventing the use of glexec in Europe by CMS.\n\n</p><p>Thanks,\n   Igor</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Jul-19 10:22:50 by danb:</em> <br/>\n\nWe believe that when the lcmaps-plugins-scas-client is configured to use a hostcert for authentication to GUMS, the value of X509_USER_PROXY is ignored.  Therefore, it should not hurt to always have X509_USER_PROXY point to the pilot proxy when glexec is invoked.  There is no need for a different Condor configuration in sites that use a hostcert (OSG) verses sites that use the pilot proxy (EGI).\n\n<p></p><hr/>\n<em>2011-Jul-19 11:38:56 by danb:</em> <br/>\n\nI am worried by the following code in glexec_job_wrapper.linux.cpp:\n\n<p></p><pre>    // set up an Env object that we'll use for the job. we'll initialize\n    // it with the environment that Condor sends us then merge on top of\n    // that the environment that glexec prepared for us\n    //\n    Env env;\n    char* env_buf = read_env();\n    MyString merge_err;\n    if (!env.MergeFromV2Raw(env_buf, &amp;merge_err)) {\n        err.sprintf(\"Env::MergeFromV2Raw error: %s\", merge_err.Value());\n        fatal_error();\n    }\n    env.MergeFrom(environ);\n</pre>\n\n<p>This means that if glexec messes with X509_USER_PROXY, the job will run with the value set by glexec, not the value set by condor.  glexec versions &gt;= 0.7.0 point X509_USER_PROXY to a copy of the job's proxy that is not managed by condor and which therefore (as far as I understand things) does not receive updates.\n\n</p><p></p><hr/>\n<em>2011-Jul-21 14:24:32 by danb:</em> <br/>\n\nI have pushed a patch to 7.6.3.  It sets X509_USER_PROXY to the Condor daemon proxy when invoking glexec.  In condor's glexec job wrapper, it sets X509_USER_PROXY to point to the job proxy that is managed by condor.\n\n<p>For the development series I would like to make a more aggressive change in the way the job and glexec environment are managed.  See <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2096\" onclick=\"get_ticket_and_populate_wrapper('2096'); return false;\" title=\"Condor should rebuild environment post-gLexec\">#2096</a></span>.\n\n</p><p></p><hr/>\n<em>2011-Aug-11 11:39:09 by zmiller:</em> <br/>\n\nreviewed, looks good.  resolving.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-21 13:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dc3bf0142f2a6754e62617d7929d7c59878dc0ca\">[22569]</a></span>: Fixed management of X509_USER_PROXY for glexec. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2316\" onclick=\"get_ticket_and_populate_wrapper('2316'); return false;\" title=\"Condor's use of glexec fails on EGI sites\">#2316</a></span> ===VersionHistory=== Previously, Condor invoked glexec with the environment variable X509_USER_PROXY pointing to the job's proxy rather than the Condor daemon proxy. When glexec was configured to use X509_USER_PROXY to authenticate\u00a0[...]\n (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Aug-11 11:39", "status": "resolved", "created": "2011-Jul-19 10:18", "fixed_version": "2011-Jul-19 10:18", "broken_version": "v070600", "priority": "1", "subsystem": "", "assigned_to": "zmiller", "derived_from": "", "creator": "danb", "rust": "s8065", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,burt@fnal.gov", "due_date": "20110809"}