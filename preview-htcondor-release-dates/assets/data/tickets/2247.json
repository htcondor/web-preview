{"id": 2247, "title": "Ticket #2247: procd dies after hardkilling starter", "description": "<blockquote>\nI suspect that when the startd tells the procd to hard-kill the starter, there is a chance that the procd will hit an exception caused by a broken connection attempt from the starter.  This then causes both the procd and then the startd to exit, which means all running jobs are stopped.\n\n<p>This may explain some of the cases of \"ProcD has failed\" errors which have been reported by various sites for quite some time.  I observed this error in CHTC with a pre-release of 7.7.0.  I suspect the problem dates back much earlier than 7.7.0, so I am setting the broken version to be 7.6.0 in order to suggest fixing this in the stable series.\n\n</p><p><code>StartLog</code>:\n</p><div class=\"verbatim\">\n<pre>06/16/11 10:31:13 slot4: starter (pid 22119) is not responding to the request to\n hardkill its job.  The startd will now directly hard kill the starter and all i\nts decendents.\n06/16/11 10:31:13 slot4: In Starter::kill_kids() with pid 22119, sig 9 (SIGKILL)\n06/16/11 10:31:13 slot4: In Starter::kill_kids() with pid 22119, sig 9 (SIGKILL)\n06/16/11 10:31:14 error reading from named pipe: watchdog pipe has closed\n06/16/11 10:31:14 ProcFamilyClient: failed to read response from ProcD\n06/16/11 10:31:14 kill_family: ProcD communication error\n06/16/11 10:31:14 ERROR \"ProcD has failed\" at line 587 in file /home/condor/exec\nute/dir_31058/userdir/src/condor_utils/proc_family_proxy.cpp\n</pre></div>\n\n\n<p><code>ProcLog</code>:\n</p><div class=\"verbatim\">\n<pre>06/16/11 10:31:14 : sending signal 9 to family with root 22161\n06/16/11 10:31:14 : error opening /var/lock/condor/procd_pipe.STARTD.22119.0: No\n such device or address (6)\n06/16/11 10:31:14 : ERROR: ProcFamilyServer: failed trying to accept client\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Jun-16 12:46:07 by tstclair:</em> <br/>\n\nI've actually been tracing this exact issue, b/c of signal escalation issues.\n\n<p></p><hr/>\n<em>2011-Jun-16 14:05:42 by danb:</em> <br/>\n\nI confirmed the suspected sequence of events that leads to this problem.  I attached to the procd and set a breakpoint on the line where the server opens the pipe for writing to the client.  (I had to patch the procd to not die when gdb attaches, because the procd did not like having select() get interrupted.)  Here is the line in <code>LocalServer::accept_connection()</code> where I set the breakpoint:\n\n<p></p><pre>    if (!m_writer-&gt;initialize(client_addr)) {\n</pre>\n\n<p>When it got there, I then hard-killed the client (which was the starter).  The procd then failed to open the pipe and died.\n\n</p><p>The solution is to make the server resilient to communication errors that could be caused by a client that is interrupted.\n\n</p><p></p><hr/>\n<em>2011-Jun-16 14:38:18 by tstclair:</em> <br/>\n\nIt also appears that the startd is following non-happy path to killing the starter.  When searching through the procd it looked like it had it's own killing path.\n\n<p>Is there any reason to choose one method over the other?  Why does the startd fire indiscriminately without any notification to the procd?\n\n</p><p></p><hr/>\n<em>2011-Jun-16 15:00:25 by danb:</em> <br/>\n\nThe problem of the procd dying due to a dead client has been fixed, so I am closing this ticket.\n\n<p>I'll leave the cleanup of the startd killing logic for another ticket.  (I agree that it is suspiciously confusing.)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-16 14:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ddb6a135bea6b25b38d081f92f9cae34380000c9\">[22211]</a></span>: Fixed procd death when client dies. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2247\" onclick=\"get_ticket_and_populate_wrapper('2247'); return false;\" title=\"procd dies after hardkilling starter\">#2247</a></span> ===VersionHistory=== Fixed a problem that sometimes caused the condor_procd to die when the condor_startd killed the condor_starter, due to unresponsiveness. This resulted in the startd logging \"ProcD has failed\" and then exiting.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jun-16 15:01", "status": "resolved", "created": "2011-Jun-16 10:52", "fixed_version": "2011-Jun-16 10:52", "broken_version": "v070600", "priority": "3", "subsystem": "", "assigned_to": "danb", "derived_from": "#812", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu tstclair@redhat.com psilord@cs.wisc.edu", "due_date": ""}