{"id": 2403, "title": "Ticket #2403: negotiator spends lots of time in addRemoteUserPrios()", "description": "<blockquote>\nI profiled the negotiator in GLOW and found that it was spending most of its time in <code>addRemoteUserPrios()</code>.  I suspect this function is especially expensive in GLOW, because we have a lot of machines with O(100) slots, and this function loops over all slots.\n\n<p>This function gets called to insert user priority and usage information into the machine ad before each match test.  In days of old, this function only needed to be called once per startd per cycle, because the information did not change during the cycle, but now the usage of the user and group is included, and this can change during the cycle.\n\n</p><p>The proposed solution is to replace the insertion of actual values with classad function calls.  The function calls will call up custom functions that the negotiator registers with the classad library.  Once this is done, we can return to the good old days of only calling <code>addRemoteUserPrios()</code> once per startd per cycle.  We could go even further and not insert things into the machine ad at all.  Instead, people would call functions to retrieve the desired values.  However, I think the cost of calling this function once per startd per cycle is negligible, so for now I would just like to treat this as an internal optimization-only change.</p></blockquote>", "remarks": "<blockquote>\nI tested this patch on GLOW.  The negotiation cycle went from 20-30 minutes to 4 minutes. It is now spending most of its time in IsAMatch(), as one would expect.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-01 16:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5860e6801a7741a08d0deceb3de97c19b9255f03\">[27068]</a></span>: Documented matchmaking optimization. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2403\" onclick=\"get_ticket_and_populate_wrapper('2403'); return false;\" title=\"negotiator spends lots of time in addRemoteUserPrios()\">#2403</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-23 17:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2ece2ecbda7792a83f25e5f67adf28b13ae53b9d\">[26914]</a></span>: Optimized addRemoteUserPrios(). Now it is no longer necessary to call this function every time we test matchability of a startd, because the dynamic information in the ad is retrieved via custom classad function calls. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2403\" onclick=\"get_ticket_and_populate_wrapper('2403'); return false;\" title=\"negotiator spends lots of time in addRemoteUserPrios()\">#2403</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Aug-04 14:58", "status": "resolved", "created": "2011-Aug-19 18:35", "fixed_version": "2011-Aug-19 18:35", "broken_version": "v070000", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}