{"id": 5161, "title": "Ticket #5161: Serialize concurrent collector updates", "description": "<blockquote>\nWhen a \"condor_reconfig -schedd\" is done, current security sessions are flushed from the schedd and count_jobs is invoked.  It appears this is a poor combination.\n\n<p>If I'm reading our pstack correctly, this fires off a bunch of non-blocking updates to the collector.  Since there's no established session, many of these will start a new security handshake before the first one creates a new session.\n\n</p><p>This has turned out badly for CMS as our largest schedds have 400 submitters and we maintain two HA collectors (so, ~800 updates).  The resulting effect is our schedds block for a few minutes (all the callbacks appear to fire at once), especially as the <em>client-side</em> of GSI auth is blocking.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-20 21:49:50 by bbockelm:</em> <br/>\n\nAssigning to Jaime for review.\n\n<p><strong>Note</strong> the change in behavior for UDP updates (one per DC cycle instead of all in the same DC cycle).  Since we are changing the default updates to TCP, I'm not sure if we care deeply here.  I think it's possible to get the prior behavior if desired.\n\n</p><p></p><hr/>\n<em>2015-Jul-27 13:51:47 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>As noted in the code, if there's a cached TCP socket, then it is used to send all pending updates, including ones that request UDP. Assuming that and the other behavior changes described in the ticket are acceptable, the patch looks good to me.\n\n</p><p></p><hr/>\n<em>2015-Jul-28 14:28:34 by bbockelm:</em> <br/>\n\nPer discussion with Jaime, assigning to another set of eyes to think about potential pitfalls of this approach.\n\n<p></p><hr/>\n<em>2015-Aug-06 16:55:38 by tannenba:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good, thanks for the patch!!!!  The shortcomings mentioned above do not concern me, and the benefits are great.  Would like a few more comments in the code, I suppose I could add those.   Merged to v8.3.8 release.\n\n</p><p></p><hr/>\n<em>2015-Aug-13 15:29:48 by tannenba:</em> <br/>\n\nCoverity complained the code dereferences a freed pointer on line 419.  Commiting a fix.\n\n<p>From Coverity:\n\n</p><p></p><pre>   CID 10384 (#1 of 1): Use after free (USE_AFTER_FREE)\n   12. deref_arg: Calling get_sinful_peer dereferences freed pointer sock.\n   419         if(sock) who = sock-&gt;get_sinful_peer();</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-31 11:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/492556360a7bd9e5c70c480054dc22446fa3e39b\">[45771]</a></span>: Version history entry for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5161\" onclick=\"get_ticket_and_populate_wrapper('5161'); return false;\" title=\"Serialize concurrent collector updates\">#5161</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-13 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2aeaaf6c496bf1f0f91259cfb77d8236453a6c39\">[45618]</a></span>: Fix bad pointer dereference and add additional comments. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5161\" onclick=\"get_ticket_and_populate_wrapper('5161'); return false;\" title=\"Serialize concurrent collector updates\">#5161</a></span> Bad dereference discovered by Coverity before code was released, so no need for version history about this bugfix.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-20 21:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/124881ab9e6f1170cc2134479f81fb2e9d5ac604\">[45364]</a></span>: Serialize concurrent collector updates. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5161\" onclick=\"get_ticket_and_populate_wrapper('5161'); return false;\" title=\"Serialize concurrent collector updates\">#5161</a></span> This serializes concurrent collector updates; this prevents multiple auth sessions from being attempted simultaneously with a single collector.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Aug-31 11:42", "status": "resolved", "created": "2015-Jul-16 21:08", "fixed_version": "2015-Jul-16 21:08", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu jfrey@cs.wisc.edu", "due_date": ""}