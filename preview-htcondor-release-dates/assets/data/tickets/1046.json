{"id": 1046, "title": "Ticket #1046: Performance: job removal fsync for each job", "description": "<blockquote>\nJob removal is exceedingly slow, especially when removing tens of thousands of jobs.\n\n<p>A quick review of the Schedd code suggests that a single condor_rm should result in a single transaction and fsync, but that is not the case.\n\n</p><p>Generate some Schedd traffic:\n</p><div class=\"verbatim\">\n<pre>$ echo \"cmd=/bin/sleep\\nargs=1h\\nnotification=never\\nqueue 29\" | condor_submit\nSubmitting job(s).............................\n$ condor_rm -a\n</pre></div>\n\n\n<p>While watching the Schedd:\n</p><div class=\"verbatim\">\n<pre>$ strace -c -efsync -p $(pidof condor_schedd)\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.002000          65        31           fsync\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.002000                    31           total\n</pre></div>\n\n\n<p>The job_queue.log:\n</p><div class=\"verbatim\">\n<pre>105\n103 0.0 NextClusterNum 8\n101 07.-1 Job Machine\n101 7.0 Job Machine\n103 7.0 GlobalJobId \"robin.local#7.0#1260542935\"\n103 07.-1 ClusterId 7\n...\n103 7.1 GlobalJobId \"robin.local#7.1#1260542935\"\n103 7.1 ProcId 1\n103 7.1 LastJobStatus 0\n103 7.1 JobStatus 1\n101 7.2 Job Machine\n103 7.2 GlobalJobId \"robin.local#7.2#1260542935\"\n103 7.2 ProcId 2\n103 7.2 LastJobStatus 0\n103 7.2 JobStatus 1\n101 7.3 Job Machine\n...\n101 7.28 Job Machine\n103 7.28 GlobalJobId \"robin.local#7.28#1260542936\"\n103 7.28 ProcId 28\n103 7.28 LastJobStatus 0\n103 7.28 JobStatus 1\n103 7.28 EnteredCurrentStatus 1260542936\n106\n105\n103 7.10 LastJobStatus 1\n103 7.10 JobStatus 3\n103 7.10 RemoveReason \"via condor_rm (by user matt)\"\n103 7.10 EnteredCurrentStatus 1260542937\n104 7.10 JobStatusOnRelease\n103 7.11 LastJobStatus 1\n103 7.11 JobStatus 3\n103 7.11 RemoveReason \"via condor_rm (by user matt)\"\n103 7.11 EnteredCurrentStatus 1260542937\n104 7.11 JobStatusOnRelease\n...\n104 7.27 JobStatusOnRelease\n103 7.28 LastJobStatus 1\n103 7.28 JobStatus 3\n103 7.28 RemoveReason \"via condor_rm (by user matt)\"\n103 7.28 EnteredCurrentStatus 1260542937\n104 7.28 JobStatusOnRelease\n106\n103 7.10 JobFinishedHookDone 1260542937\n105\n102 7.10\n106\n103 7.11 JobFinishedHookDone 1260542937\n105\n102 7.11\n106\n...\n105\n102 7.28\n102 07.-1\n106\n</pre></div>\n\n\n<p>105 is <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BeginTransaction\" title=\"Begin Transaction\">BeginTransaction</a></span>, 106 is <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EndTransaction\" title=\"End Transaction\">EndTransaction</a></span>, 102 is <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DestroyClassAd\" title=\"Destroy Class Ad\">DestroyClassAd</a></span>\n\n</p><p>We are getting one transaction, and thus one fsync, for the submit (good), one for the removal (good), and one for each job to destroy it (bad).\n\n</p><p>Suggestion: Batch the job ad deletion.</p></blockquote>", "remarks": "<blockquote>\nI have made a 7.5-branch patch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/52193b75dc82ccb5d24652f42e34e9c5cacc82d9\">[17276]</a></span> that resolves this issue by simply converting the transaction in <code>DestroyProc</code> to be NONDURABLE.  I would like a second opinion (or maybe a group opinion during the next fw meeting) that this is an acceptable solution.  The commit message and a comment in the code describes my reasoning for why NONDURABLE is ok here.\n\n<p>The alternative solution of batching together deletes is complicated by the worry that batching together the job cleanup tasks for a lot of jobs could make the schedd less responsive to other events.  Perhaps some optimum batch size could be determined to balance the two concerns: cost of fsync vs. cost of long periods of unresponsiveness.\n\n</p><p></p><hr/>\n<em>2010-Feb-18 14:16:35 by matt:</em> <br/>\n\n+1\n\n<p></p><hr/>\n<em>2010-Feb-19 11:44:33 by matt:</em> <br/>\n\nSee <a class=\"external\" href=\"https://bugzilla.redhat.com/show_bug.cgi?id=546770\">https://bugzilla.redhat.com/show_bug.cgi?id=546770</a>\n<hr/>\n<em>2010-Oct-20 16:03:30 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n<hr/>\n<em>2011-Jan-27 14:46:04 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n<hr/>\n<em>2011-Feb-01 14:49:30 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 12:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/52193b75dc82ccb5d24652f42e34e9c5cacc82d9\">[17276]</a></span>: For performance, made <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DestroyProc\" title=\"Destroy Proc\">DestroyProc</a></span> use a NONDURABLE transaction. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1046\" onclick=\"get_ticket_and_populate_wrapper('1046'); return false;\" title=\"Performance: job removal fsync for each job\">#1046</a></span> The down side: by not immediately syncing the destroy proc event to the job queue log, we widen the window of time in which a system crash could cause the restarted schedd to redo job cleanup tasks that have already been done (e.g.\u00a0[...]\n (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Feb-01 16:19", "status": "resolved", "created": "2009-Dec-11 10:18", "fixed_version": "2009-Dec-11 10:18", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "matt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu,dan@hep.wisc.edu", "due_date": ""}