{"id": 3207, "title": "Ticket #3207: Jobs in scheduler universe ignore OnExitRemove", "description": "<blockquote>\nJobs in scheduler universe ignore <code>OnExitRemove</code>, and go directly to \"Completed\" state, disregarding policy expressions.\n\n<p>A job running under scheduler universe would improperly be marked as \"Completed\", instead of using the <code>OnExitRemove</code> attribute to decide if it should leave the queue.  The message below is a symptom of this bug.  To be explicit, the <code>OnExitRemove</code> expression for <code>condor_dagman</code> reads\n</p><div class=\"code\">\n<pre class=\"code\">on_exit_remove  = ( ExitSignal =?= 11 || (ExitCode =!= UNDEFINED &amp;&amp; ExitCode &gt;=0 &amp;&amp; ExitCode &lt;= 2))\n</pre></div>\n\nThus, when <code>condor_dagman</code> exits with status 3, the schedd should move it to \"Idle\" state and restart it.  But this was not happening because the schedd was moving it to \"Completed\" state, rather than \"Idle\". All scheduler jobs that exited would be marked as \"Completed\" state, regardless of the <code>OnExitRemove</code> expression.\n\n<p></p><div class=\"verbatim\">\n<pre>Begin forwarded message:\n\nFrom: John Veitch &lt;johnv@nikhef.nl&gt;\nSubject: [DASWG] Re: condor_schedd issue at LHO\nDate: August 23, 2012 1:53:25 AM PDT\nTo: daswg@sympa.ligo.org, daswg@ligo.org\nReply-To: johnv@nikhef.nl\n\nHi Dan, Vladimir,\n\nThis also happened to my running DAGs, which will require some manual\nintervention to figure out how to restart/resume without losing work.\nIf you need to restart condor again, would it be possible to kill the condor\njob that is running the DAG beforehand, so that it writes out a rescue DAG?\n\nCheers,\nJohn\n\nOn Wednesday 22 Aug 2012 16:03:25 Vladimir Dergachev wrote:\nHi Dan,\n\n  This crash (or restart) also had an unpleasant side effect of crashing\nmy run dagman without leaving a rescue file, though it did leave existing\njobs in the queue:\n\n-------------------------------------------\n...\n08/22/12 13:58:52 Event: ULOG_JOB_EVICTED for Condor Node A49571\n(6830606.0.0) 08/22/12 13:58:52 Number of idle job procs: 498\n08/22/12 13:58:52 Event: ULOG_JOB_EVICTED for Condor Node A46511\n(6830626.0.0) 08/22/12 13:58:52 Number of idle job procs: 499\n08/22/12 13:58:57 Currently monitoring 1 Condor log file(s)\n08/22/12 14:01:16 Got SIGTERM. Performing graceful shutdown.\n08/22/12 14:01:16 Warning: ReadMultipleUserLogs destructor called, but still\nmonitoring 1 log(s)! 08/22/12 14:01:16 **** condor_scheduniv_exec.6830513.0\n(condor_DAGMAN) pid 8018 EXITING WITH STATUS 3\n------------------------------------------\n\nI have an alternative way to find out which jobs have completed, but it\nwould be very nice if the condor team fixed whatever is causing this..\n\n                thank you\n\n                    Vladimir Dergachev\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-23 22:36:28 by nwp:</em> <br/>\n\n1st thought: check for the existence of a .lock file in the directory where DAGMan is running; if it exists, DAGMan will go into recovery mode and \"catch up\" to the running jobs.  In which case, this is simply an unhelpful message in the dagman.out file and everything is fine.\n\n<p></p><hr/>\n<em>2012-Aug-23 22:38:39 by nwp:</em> <br/>\n\nDAGMan exiting with exit value 3 indicates \"exit but indicate that we should be restarted\" (line 31 in src/condor_dagman/dagman_main.h)\n\n<p></p><hr/>\n<em>2012-Sep-04 15:01:47 by nwp:</em> <br/>\n\nAt today's LIGO phone call, Peter C. decided to try and gather more information about this ticket.\n<hr/>\n<em>2012-Sep-11 11:06:53 by johnkn:</em> <br/>\n\nBulk change of target version from v070803 to v070804 using ./ticket-target-mover.\n<hr/>\n<em>2012-Sep-19 16:15:53 by zmiller:</em> <br/>\n\nBulk change of target version from v070804 to v070805 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2012-Sep-25 12:16:02 by nwp:</em> <br/>\n\ngit bisect shows this is broken by <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b419571a8e1ff9e2e46758e57c4a10a29c0e0dc3\">[28938]</a></span>, or commit b419571.  So this bug affects condor version 7.7.5 and higher.\n\n<p></p><hr/>\n<em>2012-Sep-25 14:37:26 by johnkn:</em> <br/>\n\nreviewed by: tj\nthis fix re-introduces a bug in schedd statistics for scheduler universe jobs, but that was a much less serious bug.\n\n<p>the change to the log message is a bit more risky. Lets move that change into the master branch and out of the 7_8_5-branch.\n\n</p><p></p><hr/>\n<em>2012-Oct-03 10:55:53 by tstclair:</em> <br/>\n\nRegression tests?  We need regression tests on *this.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3250\" onclick=\"get_ticket_and_populate_wrapper('3250'); return false;\" title=\"Create script to preserve DAGs across 7.8.5 upgrade at LIGO\">#3250</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCreate script to preserve DAGs across 7.8.5 upgrade at LIGO</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-03 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b2e4ac2cd82ad09e2a575b55415b9fa45c6778f\">[33584]</a></span>: enhance 7.8.5 version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3207\" onclick=\"get_ticket_and_populate_wrapper('3207'); return false;\" title=\"Jobs in scheduler universe ignore OnExitRemove\">#3207</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-03 11:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8598b84a80c40dfeef3dcafb356ee2bf0e1dd562\">[33573]</a></span>: Update version history for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3207\" onclick=\"get_ticket_and_populate_wrapper('3207'); return false;\" title=\"Jobs in scheduler universe ignore OnExitRemove\">#3207</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-27 11:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3f7b3ad10438de8ec9068007aff92ee909e2ceb7\">[33520]</a></span>: small edit of 7.8.5 version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3207\" onclick=\"get_ticket_and_populate_wrapper('3207'); return false;\" title=\"Jobs in scheduler universe ignore OnExitRemove\">#3207</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-25 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/487b95e6ae33d5452f9a296a5cb8fcd4f30825e7\">[33477]</a></span>: Indicate that we are requeuing in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3207\" onclick=\"get_ticket_and_populate_wrapper('3207'); return false;\" title=\"Jobs in scheduler universe ignore OnExitRemove\">#3207</a></span> (cherry picked from commit 4f47cadeea9c655e80a906be9b97c0f90fcb2dad)  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-25 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b435a0edccaba8c20c4038e702c4763404b687c9\">[33472]</a></span>: Version history for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3207\" onclick=\"get_ticket_and_populate_wrapper('3207'); return false;\" title=\"Jobs in scheduler universe ignore OnExitRemove\">#3207</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-25 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/09c158160eae9f2387b73a7129e1f6c9d0cd4609\">[33471]</a></span>: Eliminate code that breaks DAGMan restart <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3207\" onclick=\"get_ticket_and_populate_wrapper('3207'); return false;\" title=\"Jobs in scheduler universe ignore OnExitRemove\">#3207</a></span>  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-03 10:55", "status": "defer", "created": "2012-Aug-23 10:42", "fixed_version": "2012-Aug-23 10:42", "broken_version": "v070705", "priority": "5", "subsystem": "Dag", "assigned_to": "nwp", "derived_from": "#2731", "creator": "pfc", "rust": "s8209", "customer_group": "ligo", "visibility": "public", "notify": "tstclair@redhat.com, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}