{"id": 1500, "title": "Ticket #1500: Shadow exception when shadow is recyled for use with another job", "description": "<blockquote>\nSeen in 7.5.3 but may exist in other versions.  The shadow blows up if it is recycled for use with another job.  This happens because of the way the user token on Windows is handled (i.e. it's <code>NULL</code> 'd out of existance before switching back to \"root\").  I've only seen this happen in the shadow for this reason, but it concevably it would happen any time the user is re-initialized the way it is done in the user log code: first it calls <code>uninit_user_ids()</code> followed imediatly by <code>init_user_ids()</code>.\n\n<p>Ultimatly what happens is that some piece of code calls <code>set_priv()</code> to switch to the user, when the user's token is <code>NULL</code>.  In the case of our shadow exception this happens in <code>dprintf()</code> (which is called by inside <code>init_user_ids()</code>) after it has done the actualy printing thing, and is reverting the the previous priv level.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Jul-12 20:03:15 by matt:</em> <br/>\n\nBen, do you have a test procedure that demonstrates the issue? Bonus points if it runs in the test suite.\n\n<p>Dan, will you code review?\n\n</p><p></p><hr/>\n<em>2010-Jul-12 21:38:59 by burnett:</em> <br/>\n\nIt can be reproduced with the <code>printname</code> example that is shipped with the Windows distribution.  All I did was add <code>+ShadowWaitForDebug=true</code> and <code>queue 20</code> so that I could track down the source of the error.\n\n<p>As far as I can tell it only will happened on a shadow recycle right now, so unless the shadow looks for another job, things will go on working fine.  So it shows up rather erratically if you don't use a debugger on it.  For instance, I used the same <code>printname</code> with just <code>queue 20</code> I only saw the exceptions start after the first 10 jobs had been run.\n\n</p><p></p><hr/>\n<em>2010-Oct-08 11:34:24 by tannenba:</em> <br/>\n\nIt may be that in order to reproduce this bug, you need dprintf set at a high-enough level.  The issue is the shadow blows up inside dprintf when priv stating, so if your dprintf level is not verbose enough, you may not step on the landmine.\n\n<p>I observed the bug with <code>SHADOW_DEBUG</code> set as follows:\n\n</p><p></p><pre>   SHADOW_DEBUG = D_FULLDEBUG D_SYSCALLS D_MACHINE</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/199/priv.diff\">priv.diff</a>\n1081 bytes added by burnett on 2010-Jul-13 02:32:47 UTC.\n<br/>\nPatch to fix shadow exception (quick update)<br/>\n</li><li><a href=\"../files/229/tj1500.v1.diff\">tj1500.v1.diff</a>\n900 bytes added by johnkn on 2010-Oct-05 22:17:38 UTC.\n<br/>\npatch to make the semantics of windows the same as 'nix: some bogus error messages are spit out on shadow re-use, just like 'nix.<br/>\n</li><li><a href=\"../files/234/tj1500.v2.diff\">tj1500.v2.diff</a>\n4642 bytes added by johnkn on 2010-Oct-11 18:58:49 UTC.\n<br/>\npatch to make the semantics of windows the same as 'nix: some bogus error messages are spit out on shadow re-use, just like 'nix. revised from the previous patch to fix race conditions in the init_user_ids function.\n<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Oct-11 16:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d87b906ebf6ecd3a51c36698dc2e5f1a0db56149\">[25718]</a></span>: Add to version-history for (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1500\" onclick=\"get_ticket_and_populate_wrapper('1500'); return false;\" title=\"Shadow exception when shadow is recyled for use with another job\">#1500</a></span>) shadow exception bug fix.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Oct-11 14:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b2d8cc567ccea2fb62be28968d43b58d86844e9e\">[19149]</a></span>: Change the semantics _set_priv and init_user_ids on Windows so that they match unix. During shadow re-use there is a period of time when the user ids are partially inited. unix tolerated this but Windows EXCEPTED. making it impossible to re-use the shadow process if debug logging was enabled. (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1500\" onclick=\"get_ticket_and_populate_wrapper('1500'); return false;\" title=\"Shadow exception when shadow is recyled for use with another job\">#1500</a></span>).\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Oct-11 17:20", "status": "resolved", "created": "2010-Jul-12 16:55", "fixed_version": "2010-Jul-12 16:55", "broken_version": "v070503", "priority": "2", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "#1375", "creator": "burnett", "rust": "", "customer_group": "other", "visibility": "public", "notify": "ben.burnett@uleth.ca matt@cs.wisc.edu dan@hep.wisc.edu tstclair@redhat.com", "due_date": ""}