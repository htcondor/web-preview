{"id": 5801, "title": "Ticket #5801: Master crashes after shared_port restart", "description": "<blockquote>\nThe master will crash immediately after it restarts the shared port daemon.\n\n<p>Immediately after restarting a daemon, the master sends an update of its ad to the collector. As part of the sinful rewriting code in ConvertDefaultIPToSocketIP(), it calls daemonCore-&gt;InfoCommandSinfulString() to fetch its sinful string. This method returns NULL for a short time after the shared port restarts, which the caller isn't expecting. We can change ConvertDefaultIPToSocketIP() to skip rewriting in this case.\n\n</p><p>With this fix, the master no longer crashes. But for a short period after the shared port restart, if the master gets a reconfig, its ad in the collector and its address file will have no useful sinful strings. Within a minute, it recovers from this state.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jul-27 15:54:13 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Code looks good.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5810\" onclick=\"get_ticket_and_populate_wrapper('5810'); return false;\" title=\"After shared_port restart, master should send update w/o addresses.\">#5810</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAfter shared_port restart, master should send update w/o addresses.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5811\" onclick=\"get_ticket_and_populate_wrapper('5811'); return false;\" title=\"After shared_port restart, endpoint should quickly check for addr.\">#5811</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAfter shared_port restart, endpoint should quickly check for addr.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5812\" onclick=\"get_ticket_and_populate_wrapper('5812'); return false;\" title=\"The master should increase the shared_port's FD limit.\">#5812</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nThe master should increase the shared_port's FD limit.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5813\" onclick=\"get_ticket_and_populate_wrapper('5813'); return false;\" title=\"shared_port daemon should be careful about FD use\">#5813</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nshared_port daemon should be careful about FD use</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-27 15:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/164ad04133a0e3006844fdb15922976480086822\">[48857]</a></span>: Docs for master crash after shared_port restart bugfix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5801\" onclick=\"get_ticket_and_populate_wrapper('5801'); return false;\" title=\"Master crashes after shared_port restart\">#5801</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-22 15:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/030d0cb98ab2b5a754e725bde675ecd8ba3708a1\">[48833]</a></span>: Don't rewrite sinful if daemoncore doesn't provide one. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5801\" onclick=\"get_ticket_and_populate_wrapper('5801'); return false;\" title=\"Master crashes after shared_port restart\">#5801</a></span> For a short time after shared_port is restarted, the master won't know its command port sinful string. Skip sinful address rewriting in this situation, instead of crashing on a NULL pointer.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Jul-28 14:03", "status": "resolved", "created": "2016-Jul-22 15:34", "fixed_version": "2016-Jul-22 15:34", "broken_version": "v080408", "priority": "1", "subsystem": "DaemonMaster", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}