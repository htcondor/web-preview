{"id": 6638, "title": "Ticket #6638: 49ec2-instance.sh does not retry or shutdown node on failures", "description": "<blockquote>\nHeath reports that when starting enough instances, the <code>49ec2-instance.sh</code> script will trigger Amazon's DoS defenses:\n\n<p></p><div class=\"verbatim\">\n<pre>I've been deploying 100 instances at a time in\n10-20 minute intervals.  One thing I notice on 1% of the instances is that\nthe condor-annex-ec2 service fails with a RequestLimitExceeded error from\nAWS and just gives up.  This causes the instance to not join the pool and\njust sit there.\n\nApr 02 20:41:49 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: Note: Forwarding request to 'systemctl is-enabled\ncondor.service'.\nApr 02 20:41:49 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: enabled\nApr 02 20:42:00 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: Configuring HTCondor to be an EC2 annex: waiting for\nSpot Fleet to tag me: OK\nApr 02 20:42:00 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: An error occurred (RequestLimitExceeded) when\ncalling the DescribeSpotFleetRequests o...ceeded.\nApr 02 20:42:02 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: failed!\n</pre></div>\n\n\n<p></p><ul>\n<li>The script should include several random seconds of splay on start-up to help avoid this problem.\n</li><li>The script should retry (with random and exponential back-off).\n</li><li>The script should [probably] just shut the machine down if it fails.  Think about this carefully, since it will make debugging nightmare.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2018-Apr-17 15:47:37 by tlmiller:</em> <br/>\n\nTesting with one round of 300.  One instance self-terminated.  All 299 others reported in.\n\n<p></p><hr/>\n<em>2018-Apr-17 15:52:32 by tlmiller:</em> <br/>\n\ngit cherry-pick into v8.7.8 approved by Tim and TJ.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-19 13:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ef92b3f13b75c0e449b479832a514c906e27fce\">[54764]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-19 13:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2f119776405039dc083227fb3424862517135739\">[54763]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-19 13:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/24bc4558b73dbfffdbbd7a5906e793f4f5e0514e\">[54762]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-19 13:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6f248c74f119e76311f94bb5dcaf5b4712a0d389\">[54759]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-17 15:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e4bc0abf8f4a99d8ab0563c1faa5cd987c6beb38\">[54750]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>) Retry if request limit exceeded in annex-ec2 start-up script. Updated AMIs, updating defaults.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-17 15:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2d8bd239b60a7713b46aa96d720d9c8d942d66d3\">[54748]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>) Retry if request limit exceeded in annex-ec2 start-up script. Updated AMIs, updating defaults.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Apr-19 13:15", "status": "resolved", "created": "2018-Apr-04 11:07", "fixed_version": "2018-Apr-04 11:07", "broken_version": "v080707", "priority": "2", "subsystem": "Annex", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}