{"id": 2819, "title": "Ticket #2819: fetchwork will claim existing dynamic slots but not allocate new ones", "description": "<blockquote>\nThe last we heard from Todd (and Pete before him), a fix has existed since Oct-2011 but is stalled on documentation.\n\n<p>This is important to us since SU would like to roll out partitionable slots + BOINC.\n\n</p><p>Goals:\n</p><ul>\n<li><code>2012-06-08</code> - Initial assessment.\n</li></ul>\n\n<p>At the moment, fetchwork works, but it claims the partitionable slot itself, not a new dynamic slot.  (It might also be willing to claim an unused dynamic slot, bu those typically fold back into the partitionable slot promptly.)\n\n</p><p></p><ol>\n<li>When fetchwork runs, carve off dynamic slot instead of claiming the partitionable slot\n<ul>\n<li>Start looking in StartdHookMgr::handleHookFetchWork(FetchClient* fetch_client) (<a class=\"file\" href=\"rlog?f=src/condor_startd.V6/StartdHookMgr.cpp\">/src/condor_startd.V6/StartdHookMgr.cpp</a> around line 228)\n</li></ul>\n</li><li>When fetchwork runs succesfully, immediately try again.\n</li></ol>\n\n<p>Keywords: fetch work hook</p></blockquote>", "remarks": "<blockquote>\nUpdated priority to match Todd's new scheme (1=fire, 2=soon, 3=time permitting, 4=not yet prioritized, 5=wishlist/ideas).\n\n<p></p><hr/>\n<em>2012-Apr-20 13:28:15 by pfc:</em> <br/>\n\nJust a note that we all agreed on the goal of having a fix to test by mid-June when Peter meets w/Todd &amp; Zach.\n\n<p></p><hr/>\n<em>2012-Jun-25 13:24:45 by adesmet:</em> <br/>\n\nDelayed by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3076\" onclick=\"get_ticket_and_populate_wrapper('3076'); return false;\" title=\"Startd slot stuck in Preempting/Vacating\">#3076</a></span>\n\n<p></p><hr/>\n<em>2012-Jun-26 14:17:56 by pfc:</em> <br/>\n\nAlan says there will probably be something to test by the week of 7/9.\n\n<p></p><hr/>\n<em>2012-Jul-05 16:19:40 by adesmet:</em> <br/>\n\nCurrent plan:\n<ol>\n<li>Extract everything in the \"if( Resource::PARTITIONABLE_SLOT == rip-&gt;get_feature() ) {\" block inside request_claim (<a class=\"file\" href=\"rlog?f=src/condor_startd.V6/command.cpp\">/src/condor_startd.V6/command.cpp</a> around line 1178) into its own function\n</li><li>Call this new function in StartdHookMgr::handleHookFetchWork, probably just before the call to rip-&gt;createOrUpdateFetchClaim (<a class=\"file\" href=\"rlog?f=src/condor_startd.V6/StartdHookMgr.cpp\">/src/condor_startd.V6/StartdHookMgr.cpp</a> around line 228)\n</li></ol>\n\n<p></p><hr/>\n<em>2012-Jul-09 16:24:24 by adesmet:</em> <br/>\n\nFix checked in on own branch V7_8-partitionable-fetchwork-branch but...\n<ul>\n<li>Sometimes the dynamic slots has a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteUser\" title=\"Remote User\">RemoteUser</a></span> from fetchwork's Owner, sometimes it's undefined.\n<ul>\n<li>Check if this is true for non-dynamic\n</li></ul>\n</li><li>Once while trying to shutdown, the startd got stuck waiting for a dynamic slot to do something.\n<ul>\n<li>See if I can reproduce.\n</li></ul>\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Jul-12 14:53:49 by adesmet:</em> <br/>\n\nStuck startd happened on branch without this change.  Can't reproduce. Ignoring for now.\n\n<p></p><hr/>\n<em>2012-Jul-12 16:49:52 by adesmet:</em> <br/>\n\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteUser\" title=\"Remote User\">RemoteUser</a></span> not getting set appears to happen even for the non-dynamic slot case. Worth investigating, but not here.\n\n<p></p><hr/>\n<em>2012-Jul-13 11:19:15 by adesmet:</em> <br/>\n\nPassing to jfrey for review.\n\n<p></p><hr/>\n<em>2012-Jul-16 12:08:36 by jfrey:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>The code looks good. I believe you also fixed a couple bugs where <code>refuse(stream)</code> wasn't being called when it should (in the code checking that the Request* attributes are present).\n\n</p><p></p><hr/>\n<em>2012-Jul-17 15:18:50 by adesmet:</em> <br/>\n\nMerged into V7_8-branch.  Merge to master delayed by conflict in the code. :-p\n\n<p></p><hr/>\n<em>2012-Jul-17 16:18:52 by adesmet:</em> <br/>\n\nConflict resolved. Code is in V7_8-branch and master. Should be present in 7.8.2 and 7.9.1.\n<hr/>\n<em>2012-Aug-23 14:09:08 by zmiller:</em> <br/>\n\nBulk change of target version from v070802 to v070803 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-26 09:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0d236d28a7a35a98b7e06e2f50e7319bd7e1987a\">[32914]</a></span>: Minor edit of 7.8.2 version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2819\" onclick=\"get_ticket_and_populate_wrapper('2819'); return false;\" title=\"fetchwork will claim existing dynamic slots but not allocate new ones\">#2819</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-17 15:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/979e76832883da9f25308f135c3f974cb1c2e6e6\">[32830]</a></span>: Fetchwork jobs now claim dynamic slots instead of claiming the whole partitionable slot. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2819\" onclick=\"get_ticket_and_populate_wrapper('2819'); return false;\" title=\"fetchwork will claim existing dynamic slots but not allocate new ones\">#2819</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-17 15:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2d45fb6f4fde1b8c0592f85edc7482d81638a270\">[32829]</a></span>: Document <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2819\" onclick=\"get_ticket_and_populate_wrapper('2819'); return false;\" title=\"fetchwork will claim existing dynamic slots but not allocate new ones\">#2819</a></span>: fetchwork will claim existing dynamic slots but not allocate new ones  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-09 14:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c8bd3882024acf731b882b4988f57463bcac46f\">[32663]</a></span>: Fetchwork jobs can now claim dynamic slots. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2819\" onclick=\"get_ticket_and_populate_wrapper('2819'); return false;\" title=\"fetchwork will claim existing dynamic slots but not allocate new ones\">#2819</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-09 13:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7f8a8ab034961267912346ebf85da15fa9e3bf8c\">[32662]</a></span>: Move initialize_resource into Resource.h/cpp, slightly better fit. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2819\" onclick=\"get_ticket_and_populate_wrapper('2819'); return false;\" title=\"fetchwork will claim existing dynamic slots but not allocate new ones\">#2819</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-06 14:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7090261a24a517a15cc94e6b332d5c87ce8642dc\">[32661]</a></span>: Extract partitionable slot carving into own function for reuse with fetchwork code path. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2819\" onclick=\"get_ticket_and_populate_wrapper('2819'); return false;\" title=\"fetchwork will claim existing dynamic slots but not allocate new ones\">#2819</a></span>  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Aug-23 14:09", "status": "defer", "created": "2012-Feb-09 23:21", "fixed_version": "2012-Feb-09 23:21", "broken_version": "v070606", "priority": "5", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "", "creator": "pfc", "rust": "a22035", "customer_group": "ligo", "visibility": "public", "notify": "tstclair@redhat.com, tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": "20120717"}