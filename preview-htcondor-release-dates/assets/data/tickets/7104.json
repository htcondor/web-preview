{"id": 7104, "title": "Ticket #7104: Custom resources sometimes not released from d-slot back to p-slot", "description": "<blockquote>\nIf a non-fungible custom resource has more than one entry with the same name,  when the second or subsequent instance of the resource should be released back to a p-slot when a d-slot is destroyed, the release fails.\n\n<p>Subsequent attempts to create a d-slot using that resource will fail with the message\n\n</p><p></p><pre>    ERROR \"Failed to bind local resource '%s'\" at line %d in %s\n</pre>\n\n<p>For example if the following slot resources assignments exist\n</p><div class=\"snip\">\n<pre class=\"sniplabel\">startd classad fragments</pre>\n<pre class=\"snip\">Name = \"Slot1\"\nSlotType = \"Partitionable\"\nAssignedGPUs = \"CUDA0,CUDA0\"\nGPUs = 0\n\nName = \"Slot1_1\"\nSlotType = \"Dynamic\"\nAssignedGPUs = \"CUDA0\"\nGPUs = 1\n\nName = \"Slot1_2\"\nSlotType = \"Dynamic\"\nAssignedGPUs = \"CUDA0\"\nGPUS = 1\n</pre></div>\n\n\n<p>And the STARTDs internal table of resource ownership will show </p><div class=\"code\">\n<pre class=\"code\">CUDA0:1_1, CUDA0:1_2</pre></div>\n\n\n<p>When <code>Slot1_2</code> is destroyed, the resource \"CUDA0\" will not be released back to the ownership of the p-slot - but the count of GPUs owned by the p-slot will still be updated. Only the first \"CUDA0\" will be released. So the situation will be\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">startd classad fragments</pre>\n<pre class=\"snip\">Name = \"Slot1\"\nSlotType = \"Partitionable\"\nAssignedGPUs = \"CUDA0,CUDA0\"\nGPUs = 2\n</pre></div>\n\n\n<p>And the STARTDs internal table of resource ownership will show </p><div class=\"code\">\n<pre class=\"code\">CUDA0:1, CUDA0:1_2</pre></div>\n\n\n<p>Indicating that the p-slot owns 2 GPUS, but that the second \"CUDA0\" is assigned to slot1_2.\n\n</p><p>Thus, when we try and hand out the second \"CUDA0\" resource to a new dslot, the assignment will fail and the STARTD will abort.</p></blockquote>", "remarks": "<blockquote>\nremoval of the break is the fix, the rest is some D_FULLDEBUG logging to help diagnose problems in the future.\n\n<p></p><hr/>\n<em>2019-Jun-20 08:48:07 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-01 11:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/43398ebb9e063fade6061eea788f0d494393af4f\">[57265]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7104\" onclick=\"get_ticket_and_populate_wrapper('7104'); return false;\" title=\"Custom resources sometimes not released from d-slot back to p-slot\">#7104</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-11 17:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aa72d8c7fc70199066bd8de8154c28b41314740a\">[57139]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7104\" onclick=\"get_ticket_and_populate_wrapper('7104'); return false;\" title=\"Custom resources sometimes not released from d-slot back to p-slot\">#7104</a></span>, custom resource not release from d-slot back to p-slot when there are multiple non-fungible resources with the same name ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Jul-01 11:24", "status": "resolved", "created": "2019-Jun-11 14:55", "fixed_version": "2019-Jun-11 14:55", "broken_version": "v080800", "priority": "2", "subsystem": "", "assigned_to": "johnkn", "derived_from": "#7005", "creator": "johnkn", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "", "due_date": ""}