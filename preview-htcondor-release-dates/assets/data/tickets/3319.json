{"id": 3319, "title": "Ticket #3319: add pthreads stubs (or green threads) to standard universe glibc", "description": "<blockquote>\nWe want to distribute a library (libfoo.a) linked with pthreads that people need to condor_compile against.  Pthreads do not actually need to work in the standard universe.</blockquote>", "remarks": "<blockquote>\n<em>2012-Nov-14 16:57:09 by tstclair:</em> <br/>\n\nIs this for real?\n\n<p></p><hr/>\n<em>2012-Nov-14 18:09:17 by pfc:</em> <br/>\n\nUm, yes.  Why wouldn't it be?\n\n<p></p><hr/>\n<em>2012-Nov-16 11:07:46 by samf:</em> <br/>\n\nI've started working with the library <a class=\"external\" href=\"http://www.gnu.org/software/pth/\">pth</a>. I have managed to compile the code, link against the library with <code>condor_compile</code>, and checkpoint and restart successfully. The only issue I have run into so far is that I'm using RHEL6 and I've encountered problems with address space randomization. Luckily, the HTCondor manual while discussing <a class=\"external\" href=\"http://research.cs.wisc.edu/htcondor/manual/v7.9/4_2Condor_s_Checkpoint.html#SECTION00521000000000000000\">standalone checkpointing</a> points out a <a class=\"external\" href=\"http://research.cs.wisc.edu/htcondor/manual/v7.9/6_1Linux.html#SECTION00712000000000000000\">solution</a>.\n\n<p>For setting up the library, I used:\n\n</p><p></p><pre>  ./configure --prefix=/scratch/samf/test/pth-install/ --enable-pthread\n</pre>\n\n<p>and several <code>make</code> commands later it was setup.\n\n</p><p>To compile, link, run, checkpoint, and restart the code respectively, I used:\n\n</p><p></p><pre>  gcc -c hello_arg1.c -I/scratch/samf/test/pth-install/include/\n  condor_compile gcc hello_arg1.o -o hello_arg1.exe -L /scratch/samf/test/pth-install/lib/ -lpthread\n  setarch x86_64 -L -R ./hello_arg1.exe\n  ^Z\n  setarch x86_64 -L -R ./hello_arg1.exe -_condor_restart hello_arg1.exe.ckpt\n</pre>\n\n<p>I've checkpointed with a second code successfully as well. I found my codes on <a class=\"external\" href=\"https://computing.llnl.gov/tutorials/pthreads/\">this tutorial page</a>. I'm still brainstorming ways that to break this. But this looks like the start of a solution.\n\n</p><p></p><hr/>\n<em>2012-Nov-16 14:00:31 by samf:</em> <br/>\n\nWhen I switched machines with my executable and checkpoint file, I indeed needed to use <code>-_condor_relocatable</code>.\n\n<p></p><pre>  setarch x86_64 -L -R ./hello_arg1.exe -_condor_restart hello_arg1.exe.ckpt -_condor_relocatable\n</pre>\n\n<p>and then the program would run. It is mentioned in the <a class=\"external\" href=\"http://research.cs.wisc.edu/htcondor/manual/v7.9/4_2Condor_s_Checkpoint.html#SECTION00521000000000000000\">manual</a> that this might be necessary.\n\n</p><p></p><hr/>\n<em>2012-Dec-17 13:56:19 by samf:</em> <br/>\n\nI have talked to the people at LIGO and am waiting for them to get back to me to let me know if pth is enough for them. pth does not seem to support some advanced realtime features, but Stuart said in an email regarding LIGO users:\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nFor most of them, I suspect all that is needed is to be able to successfully link against this library to resolve symbols and they will not actually make any pthreads calls when running in the Standard Universe, however, having a functional green threads library is a very nice bonus and I seriously doubt we will ever need realtime support from any green threads library.\n</td></tr></tbody></table></div>\n\n\n<p>There's also a possible request for a regression test, though we may want to wait until LIGO comes up with a better test case than essentially a hello world case.\n\n</p><p></p><hr/>\n<em>2013-Jan-10 15:00:53 by samf:</em> <br/>\n\nI've changed <code>condor_compile</code> to print a warning message when a user uses <code>-lpthread</code> with <code>condor_compile</code>. It says that <code>condor_compile</code> needs to find the Pth library installed having had the <code>--enable-pthread</code> flag used to build the library.\n\n<p></p><hr/>\n<em>2013-Jan-14 11:51:42 by samf:</em> <br/>\n\nI have tried to implement a warning message in <code>condor_compile</code> telling users that they need to use the library Pth when they use the flag <code>-lptrhead</code> or <code>-l pthread</code>. The error message is fine, but I'm having some problems with the code working correctly. I'm reverting the status type as well.\n\n<p></p><hr/>\n<em>2013-Jan-15 15:27:54 by samf:</em> <br/>\n\nFinally have a fix to this using sh commands only. Debain 6 uses dash instead of bash, which proved to be problematic. It parses everything and prints out a warning message saying that the user should have Pth installed and properly setup.\n\n<p>Additionally, I cleaned up <code>condor_compile</code> slightly when dealing with the <code>-c</code> command to have no linking occur. <code>condor_compile</code> now does not do any linking when it has the <code>-c</code> command in the command line arguments, regardless of the position of it in the command line.\n\n</p><p></p><hr/>\n<em>2013-Jan-22 16:57:19 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>If you have an odd number of arguments, the reference to $2 may be undefined, and should therefore be quoted to prevent a syntax error.  Otherwise fine.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-19 13:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fdd3aa3f9f5afccd2c4da836dbb0a67d01c2d979\">[34968]</a></span>: edit 7.9.4 version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-18 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6f121252893a24d3db4dcc507ac2c12f05fc33bf\">[34959]</a></span>: Tickets <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3386\" onclick=\"get_ticket_and_populate_wrapper('3386'); return false;\" title=\"RFE: GPU discovery and ClassAd Update\">#3386</a></span>. Doc commits for version history.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-29 15:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e8ca3a021cf774bc6992698feb805a6f4cd5c9c8\">[34787]</a></span>: Ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span>. Accidentally included \"support\" for Intel Fortran Compiler. We do not support it, though there is interest in supporting it.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-29 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/262abce61b1cf0501e29a545bf6c11830c649959\">[34785]</a></span>: Ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span>. Minor fixes for quotes and positional parameters in condor_compile with pthreads.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-15 12:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c827af983349f3c352a3236b7d3aab37ad64bd5c\">[34645]</a></span>: Ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span>. Changing condor_compile to handle pthreads. condor_compile now prints a warning message that says that the user should have the library pth installed somewhere with the enable-pthread flag and ensure that the compiler can find the library. Also, a change to how condor_compile handles the\u00a0[...]\n (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-14 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1b0c7d03fad26524ffe09431e641eda44fe4d91d\">[34632]</a></span>: Revert \"Ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span>. Changing condor_compile to handle pthreads. condor_compile\" This reverts commit 9a48c460f4a789240ae2fc096b94032f67903bc3.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-10 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9a48c460f4a789240ae2fc096b94032f67903bc3\">[34601]</a></span>: Ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3319\" onclick=\"get_ticket_and_populate_wrapper('3319'); return false;\" title=\"add pthreads stubs (or green threads) to standard universe glibc\">#3319</a></span>. Changing condor_compile to handle pthreads. condor_compile now prints a warning message that says that the user should have the library pth installed somewhere with the enable-pthread flag and ensure that the compiler can find the library. ===VersionHistory:Pending===  (By Samuel Friedman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Jan-29 14:49", "status": "defer", "created": "2012-Nov-13 14:25", "fixed_version": "2012-Nov-13 14:25", "broken_version": "v070901", "priority": "5", "subsystem": "Std", "assigned_to": "samf", "derived_from": "", "creator": "pfc", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pfcouvar@syr.edu, anderson@ligo.caltech.edu, dabrown@phy.syr.edu, tannenba@cs.wisc.edu, samf@cs.wisc.edu, tlmiller@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}