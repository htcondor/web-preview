{"id": 6153, "title": "Ticket #6153: Fix corruption of job queue log when write fails", "description": "<blockquote>\nThe code that writes the job queue log is very careful to detect write failures and refrain from writing any additional data. This makes it easy to recover after a restart, as any incomplete record occurs only at the end of the file and can be ignored.\n\n<p>We have seen several cases where this is not the case. A log record is truncated in the middle of a line, and is followed by other log records. Recovery fails, as the single line containing parts of two log records is invalid, but is followed by other data. The truncated record appeared to be caused by a full disk, with the additional entries occurring after some space became available. But the schedd should have aborted on the truncated write.\n\n</p><p>We have found a bug in Transaction::Commit() that explains this behavior. The function detects write failures, but doesn't act on them immediately. It continues playing the transaction, optionally writing all of the log records to a backup file. If the transaction is flagged as durable, it then tries to force the data to disk, and calls EXCEPT() if any of the I/O operations fail. If the transaction is non-durable, it silently ignores any failures.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Feb-22 15:04:35 by tannenba:</em> <br/>\n\nReaders of this ticket may also be interested in the Remarks on <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=6131\" onclick=\"get_ticket_and_populate_wrapper('6131'); return false;\" title=\"Location of corrupted log is unclear\">#6131</a></span>\n\n<p></p><hr/>\n<em>2017-Mar-01 10:13:58 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  Looks good.  Pet peeve:  I added a strerror to the message.  It is unfortunate that we don't have the file name of the transaction log at this point, and the error message presumes that it is a job log.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-01 10:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ca2b68c05b572347bb49c0f454c0366b3122fd1a\">[50239]</a></span>: Clarify error message <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6153\" onclick=\"get_ticket_and_populate_wrapper('6153'); return false;\" title=\"Fix corruption of job queue log when write fails\">#6153</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-16 14:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7ec81e80c4446416e2bf405641465794dc925a25\">[50171]</a></span>: Docs for job queue log corruption bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6153\" onclick=\"get_ticket_and_populate_wrapper('6153'); return false;\" title=\"Fix corruption of job queue log when write fails\">#6153</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-16 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/71aa33e1257589c9595a569ab8bcddae822654f5\">[50170]</a></span>: Always blow up on I/O failures when committing a transaction. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6153\" onclick=\"get_ticket_and_populate_wrapper('6153'); return false;\" title=\"Fix corruption of job queue log when write fails\">#6153</a></span> Previously, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log silently ignored write failures for nondurable transactions. This makes recovery impossible, as we only tolerate bad data at the very end of the log file.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Mar-01 12:38", "status": "resolved", "created": "2017-Feb-16 13:35", "fixed_version": "2017-Feb-16 13:35", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4555", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}