{"id": 2677, "title": "Ticket #2677: condor_softkill doesn't work reliably on Windows 7", "description": "<blockquote>\ncondor_softkill fails to enumerate desktops when run non-interatively on Windows 7 (and probabably Vista as well).  The softkill log shows\n<div class=\"verbatim\">\n<pre>entering enum_winsta_proc, winsta_name = msswindowstation\nOpenDesktop error: 2\n</pre></div>\n\nThis indicates that the \"mswindowstation\" does not have a desktop called \"default\".  Thus condor_softkill fails to find a window associated with the given pid and thus never tries to send a WM_CLOSE.  No other window stations show up in the enumeration (not even WinSta0 which is known to exist).\n\n<p>On windows XP, the log contains\n</p><div class=\"verbatim\">\n<pre>entering enum_winsta_proc, winsta_name = WinSta0\nOpenWindowStation error: 5\nentering enum_winsta_proc, winsta_name = Service-0x0-3e7$\nOpenWindowStation error: 5\nentering enum_winsta_proc, winsta_name = Service-0x0-3e4$\nOpenWindowStation error: 5\nentering enum_winsta_proc, winsta_name = Service-0x0-3e5$\nOpenWindowStation error: 5\nentering enum_winsta_proc, winsta_name = SAWinSta\nOpenWindowStation error: 5\nentering enum_winsta_proc, winsta_name = Service-0x0-39442180$\nentering enum_winsta_proc, winsta_name = Service-0x0-3ab729de$\nentering enum_winsta_proc, winsta_name = Service-0x0-3f9ccea7$\nentering enum_winsta_proc, winsta_name = Service-0x0-41a60219$\nentering enum_winsta_proc, winsta_name = Service-0x0-43973610$\nentering enum_winsta_proc, winsta_name = Service-0x0-45b7e4c4$\nentering enum_winsta_proc, winsta_name = Service-0x0-48ffeb71$\nentering enum_winsta_proc, winsta_name = Service-0x0-4b303c9a$\nentering enum_winsta_proc, winsta_name = Service-0x0-4cc682fc$\nentering enum_winsta_proc, winsta_name = Service-0x0-4fb2968b$\nentering enum_winsta_proc, winsta_name = Service-0x0-6d022906$\nentering enum_winsta_proc, winsta_name = Service-0x0-83367cfe$\nentering enum_winsta_proc, winsta_name = Service-0x1-5c993e20$\nentering enum_winsta_proc, winsta_name = Service-0x1-68ad4cd2$\nentering enum_winsta_proc, winsta_name = Service-0x1-6f835ca4$\nentering enum_winsta_proc, winsta_name = Service-0x1-73874238$\nposting WM_CLOSE to window 0x16D012E owned by thread of pid 1344\nexecutable for process is perl.exe\n</pre></div>\n\n\n<p>It seems likely that the more locked-down security model of Vista/Win7 had made the strategy of enumerating all window stations/desktops to find the window associated with a PID is no longer viable.\n\n</p><p>Since we KNOW what window station we created the process with in the first place, we should probably use that information.  At the very least we should start by checking the current desktop for rather than enumerating all desktops.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-05 12:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2c755bead037af872156ae0aec63cc826102ef53\">[28572]</a></span>: Close the process handle in condor_softkill, and write the version history item for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2677\" onclick=\"get_ticket_and_populate_wrapper('2677'); return false;\" title=\"condor_softkill doesn't work reliably on Windows 7\">#2677</a></span> ===VersionHistory:Complete===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-02 10:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8dedb19cb8dcc98a68b9e3f3ce386ec536e43660\">[28539]</a></span>: Fix condor_softkill to work on Vista/Win7 when run in as a personal condor inside a condor slot account. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2677\" onclick=\"get_ticket_and_populate_wrapper('2677'); return false;\" title=\"condor_softkill doesn't work reliably on Windows 7\">#2677</a></span> the fix is to have softkill to search for the process in the current window station before trying to enumerate all window stations. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-01 12:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3ed819f40e1eee01b8d44e384f31c1df310ef7f2\">[28528]</a></span>: have condor_softkill try the current desktop before enumerating all desktops <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2677\" onclick=\"get_ticket_and_populate_wrapper('2677'); return false;\" title=\"condor_softkill doesn't work reliably on Windows 7\">#2677</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-May-07 14:45", "status": "resolved", "created": "2011-Dec-01 12:38", "fixed_version": "2011-Dec-01 12:38", "broken_version": "v070600", "priority": "2", "subsystem": "Win32", "assigned_to": "tannenba", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20111208"}