{"id": 7565, "title": "Ticket #7565: propagate version of startd to schedd for non-negotiated sessions", "description": "<blockquote>\nIn the small <code>ClassAd</code> of exported attributes that is serialized for non-negotiated sessions, include the version of the daemon exporting the attributes.\n\n<p>Unfortunately, the parsing code for importing will choke on the spaces in the version string, so we send only a <code>\"ShortVersion\"</code> (e.g. <code>\"8.9.6\"</code>) instead of the full version string (e.g. <code>\"$CondorVersion: 8.9.6 Mar 16 2020 BuildID: UW_development PRE-RELEASE-UWCS $\"</code>).\n\n</p><p>On the import side we convert the <code>\"ShortVersion\"</code> back into a \"proper\" version string and stick it back into <code>\"RemoteVersion\"</code> attribute so it is compatible with all the existing code that looks for version info.</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-Apr-28 11:44:44 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>The <code>atoi()</code> calls will crash if a malicious source sends a <code>ShortVersion</code> with less than 3 dot-separated numbers.\n\n<p></p></li><li>When importing a <code>ShortVersion</code>, we construct the full version string twice (<code>CondorVersionInfo::get_version_stdstring()</code> builds it from scratch on every call).\n\n<p></p></li><li>Using a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span> to break apart the components of the version causes a lot of heap allocations. Changing the dots to spaces and then calling <code>strtol()</code> three times would be faster.\n</li></ul>\n\n<p></p><hr/>\n<em>2020-May-04 23:10:44 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Latest changes look good.\n\n<p></p><hr/>\n<em>2020-May-04 23:19:38 by zmiller:</em> <br/>\n\n<strong>DO NOT RESOLVE YET</strong>: Looking at daemon logs while testing, I noticed that there are yet more places where the version is not propagated.  Within a process family, which is not a big deal since we declare all should be the same version.  But the non-negotiated SchedD/Negotiator session looked like it was missing the version and we should definitely include it there.\n\n<p>After looking into it more thoroughly, I will either rework the scope of this ticket to include that (and any other places) or make a new ticket to address those issues.  Just adding this note quick so I don't forget.\n\n</p><p></p><hr/>\n<em>2020-May-05 09:57:21 by jfrey:</em> <br/>\n\nFor the schedd/negotiator session, the negotiator can (and does) get the schedd's version from the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersion\" title=\"Condor Version\">CondorVersion</a></span> attribute of the submitter ad. So having the version in the session capability is not an urgent need.\n\n<p></p><hr/>\n<em>2020-May-05 10:00:44 by jfrey:</em> <br/>\n\nThere's also the gridmanager/ft-gahp non-negotiated security session. The versions can differ. Encryption is not needed, since the connection is tunneled over an ssh session. But if the admin requires encryption via configuration, then these two daemons may fail to communicate.\n\n<p></p><hr/>\n<em>2020-May-06 08:01:26 by zmiller:</em> <br/>\n\nThanks for the comments on the other locations Jaime.  Seems like none of these other cases are \"big deals\" then.  I feel like I'd like to fix them for consistency and maybe one day we'll be happy we had the version info, but it's clearly not a big priority.  I'll make a new ticket and move those items into it and resolve this one.  [Placeholder: New Ticket Number]\n\n<p></p><hr/>\n<em>2020-May-15 10:06:21 by zmiller:</em> <br/>\n\nI made a new ticket for future work and am resolving this one.  No version history needed since this is not user visible.\n\n<p></p><hr/>\n<em>2020-May-15 10:06:51 by zmiller:</em> <br/>\n\nFollowup ticket:  <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7642\" onclick=\"get_ticket_and_populate_wrapper('7642'); return false;\" title=\"for ALL NonNegotiatedSessions make sure the version info is propagated\">#7642</a></span></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7642\" onclick=\"get_ticket_and_populate_wrapper('7642'); return false;\" title=\"for ALL NonNegotiatedSessions make sure the version info is propagated\">#7642</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nfor ALL <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NonNegotiatedSessions\" title=\"Non Negotiated Sessions\">NonNegotiatedSessions</a></span> make sure the version info is propagated</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-04 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cd33d5ec9ccb312c6519154d908208ab2053e125\">[59584]</a></span>: Fix parsing of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShortVersion\" title=\"Short Version\">ShortVersion</a></span> attribute. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7565\" onclick=\"get_ticket_and_populate_wrapper('7565'); return false;\" title=\"propagate version of startd to schedd for non-negotiated sessions\">#7565</a></span> No longer crashes if value is malformed. Also, more efficient.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-19 08:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55efbc7fea70bbfff8450d5b0ecafb246af04aa1\">[59177]</a></span>: Fix memory leak when printing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersion\" title=\"Condor Version\">CondorVersion</a></span>. <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=6992\" onclick=\"get_ticket_and_populate_wrapper('6992'); return false;\" title=\"Fix coverity-found problems in 8.9\">#6992</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7565\" onclick=\"get_ticket_and_populate_wrapper('7565'); return false;\" title=\"propagate version of startd to schedd for non-negotiated sessions\">#7565</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-17 11:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d15d1f46fba82b904181119f4e3981e47e9f7330\">[59172]</a></span>: Propagate version info in exported session attributes <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7565\" onclick=\"get_ticket_and_populate_wrapper('7565'); return false;\" title=\"propagate version of startd to schedd for non-negotiated sessions\">#7565</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-May-15 10:08", "status": "resolved", "created": "2020-Mar-17 11:29", "fixed_version": "2020-Mar-17 11:29", "broken_version": "", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "zmiller@cs.wisc.edu, tannenba.cs.wisc.edu", "due_date": "20200320"}