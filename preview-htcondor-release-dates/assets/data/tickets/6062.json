{"id": 6062, "title": "Ticket #6062: Fix blatant idiocies in Resource::update()", "description": "<blockquote>\nBy general acclaim, Resource::update() does a bunch of dumb things.\n\n<p>First, the commented as \"Send[ing] no more than 16 <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> per second to minimize the odds of overwhelming the collector\" can in fact send more than 16 <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> per second (when more 64 slots are present).  It also (a) gratuitously spreads an eight-core update out over eight seconds and (b) gratuitously updates the slots out of order (8, 1, 2, 3, 4, 5, 6, 7).  Replacing\n</p><div class=\"verbatim\">\n<pre>if ( r_id &gt; 0 ) { timeout += r_id % 8; }\n</pre></div>\n\nwith\n<div class=\"verbatim\">\n<pre>if( r_id &gt; 0 ) { timeout += (r_id + 1)/8; }\n</pre></div>\n\nwould eliminate both problems.\n\n<p>Second, we're more than a little suspicious of the idea of \"overwhelming\" the collector in this way in the first place.  Our proposal is to replace this code with a rate limiting knob (implemented as above) that defaults to off if USE_TCP_UPDATES is enabled, and to eight (public/private) pairs per second otherwise.  (The rate limit came from the UDP updates era, so we figure it was trying to avoid UDP buffer overflow drops.)\n\n</p><p>Third: although the initial delay of three seconds appears to be blatantly stupid, it (and the check for an existing timer) is actually there to force update batching.  That should probably be done at a higher level (don't send any updates until we're done with all of the updating we're doing), but we probably shouldn't change it until then.  Action item: add this comment to the codebase.\n\n</p><p>In the longer term, we should consider fixing the wire protocol so we can send chained ads efficiently, and do that so we can get all of a startd's updates done in a single efficient transaction.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Dec-21 15:22:47 by tlmiller:</em> <br/>\n\nRevised, more-conservative proposal, but for 8.6.0:\n\n<p>Add a knob, <code>UPDATE_SPREAD_TIME</code> (default value <code>USE_TCP_UPDATES ? 0 : 8</code>), where any positive number uses the old (broken and not actually rate-limiting) code.  The old code will only be modified to fix its off-by-one error.  This allows us to test fast updates in 8.6.0 (since <code>USE_TCP_UPDATES</code> is on by default) but also allows us to turn off the change if it proves problematic with only a configuration change.\n\n</p><p></p><hr/>\n<em>2016-Dec-21 15:50:52 by tlmiller:</em> <br/>\n\nToddT thought this sounded OK.\n\n<p></p><hr/>\n<em>2017-Jan-23 16:35:21 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : looks good to me.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-24 11:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b4b90010fdd61c03e8d924af4769cd140513906\">[50051]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6062\" onclick=\"get_ticket_and_populate_wrapper('6062'); return false;\" title=\"Fix blatant idiocies in Resource::update()\">#6062</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-22 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/326c5e158dc5548319e527be6dc32838ae7f6c8e\">[49870]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6062\" onclick=\"get_ticket_and_populate_wrapper('6062'); return false;\" title=\"Fix blatant idiocies in Resource::update()\">#6062</a></span>) Add the UPDATE_SPREAD_TIME knob.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-24 11:32", "status": "resolved", "created": "2016-Dec-20 11:38", "fixed_version": "2016-Dec-20 11:38", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, johnkn@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": ""}