{"id": 2187, "title": "Ticket #2187: schedd crashes in GSI auth", "description": "<blockquote>\nschedds in the CS pool, configured to condor-c to CHTC are crashing in the GSI code.  One example is simon.stat.wisc.edu, with a core in $(LOG):\n\n<p></p><div class=\"code\">\n<pre class=\"code\">(gdb) where\n#0  WriteCoreDump (file_name=0x7fff2919e950 \"\\177\\003\") at src/coredumper.c:136\n#1  0x00007fff291a4988 in ?? ()\n#2  0x000000000000000b in ?? ()\n#3  0x000000000059caab in linux_sig_coredump (signum=689588616)\n    at /home/condor/execute/dir_12420/userdir/src/condor_daemon_core.V6/daemon_core_main.cpp:700\n#4  &lt;signal handler called&gt;\n#5  0x0000000000792d88 in SSL_CIPHER_description ()\n#6  0x00000000006fefbe in globus_i_gsi_gss_handshake (minor_status=0x7fff291a510c, context_handle=0x223eb1d0)\n    at globus_i_gsi_gss_utils.c:1052\n#7  0x00000000006f9208 in gss_init_sec_context (minor_status=0x7fff291a527c, initiator_cred_handle=0x222fc360,\n    context_handle_P=0x223e6f38, target_name=0x0, mech_type=0x0, req_flags=2, time_req=0, input_chan_bindings=0x0,\n    input_token=0x7fff291a5260, actual_mech_type=0x0, output_token=0x7fff291a5250, ret_flags=0x223e6f44,\n    time_rec=0x7fff291a5244) at init_sec_context.c:188\n#8  0x00000000006f2bf4 in globus_gss_assist_init_sec_context (minor_status=0x7fff291a532c, cred_handle=0x222fc360,\n    context_handle=0x223e6f38, target_name_char=0x8bbec7 \"GSI-NO-TARGET\", req_flags=2, ret_flags=0x223e6f44,\n    token_status=0x223e6f40, gss_assist_get_token=0x5c3ae0 &lt;relisock_gsi_get(void*, void**, size_t*)&gt;,\n    gss_assist_get_context=0x222e2de0, gss_assist_send_token=0x5c3a40 &lt;relisock_gsi_put(void*, void*, size_t)&gt;,\n    gss_assist_send_context=0x222e2de0) at init.c:189\n#9  0x00000000005cea58 in Condor_Auth_X509::authenticate_client_gss (this=0x223e6ee0, errstack=0x223a7940)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/condor_auth_x509.cpp:667\n#10 0x00000000005cf04b in Condor_Auth_X509::authenticate (this=0x223e6ee0, errstack=0x223a7940)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/condor_auth_x509.cpp:160\n#11 0x00000000005c25ed in Authentication::authenticate_inner (this=0x7fff291a5510,\n    hostAddr=0x2239e820 \"&lt;128.104.59.136:9618&gt;\", auth_methods=&lt;value optimized out&gt;, errstack=0x223a7940, timeout=-1)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/authentication.cpp:252\n#12 0x00000000005c2d32 in Authentication::authenticate (this=0xb098816b56422f1d, hostAddr=0x7fff291a4f10 \"O\",\n    key=@0x223a7d18, auth_methods=0x223eb780 \"\", errstack=0x223a7940, timeout=2097152)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/authentication.cpp:91\n#13 0x00000000005df85c in ReliSock::perform_authenticate (this=0x222e2de0, with_key=true, key=@0x223a7d18,\n    methods=0x223e6e90 \"FS,GSI\", errstack=0x223a7940, auth_timeout=-1, method_used=0x0)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/reli_sock.cpp:976\n#14 0x00000000005df97e in ReliSock::authenticate (this=0xb098816b56422f1d, key=@0x100, methods=0x223eb5e0 \"XU\",\n    errstack=0x75, auth_timeout=2097152, method_used=&lt;value optimized out&gt;)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/reli_sock.cpp:1004\n#15 0x00000000005d6e91 in SecManStartCommand::authenticate_inner (this=0x223a7b20)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/condor_secman.cpp:1831\n#16 0x00000000005db89a in SecManStartCommand::startCommand_inner (this=0x223a7b20)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/condor_secman.cpp:1217\n#17 0x00000000005dbaf5 in SecManStartCommand::SocketCallback (this=0x223a7b20, stream=&lt;value optimized out&gt;)\n    at /home/condor/execute/dir_12420/userdir/src/condor_io/condor_secman.cpp:2330\n#18 0x000000000058f2c8 in DaemonCore::CallSocketHandler_worker (this=0x1fae7f90, i=&lt;value optimized out&gt;,\n    default_to_HandleCommand=&lt;value optimized out&gt;, asock=&lt;value optimized out&gt;)\n    at /home/condor/execute/dir_12420/userdir/src/condor_daemon_core.V6/daemon_core.cpp:3697\n#19 0x000000000058f76a in DaemonCore::CallSocketHandler_worker_demarshall (arg=0x222fc310)\n    at /home/condor/execute/dir_12420/userdir/src/condor_daemon_core.V6/daemon_core.cpp:3659\n#20 0x0000000000661c18 in CondorThreads::pool_add (routine=0x223eb780, arg=0x7fff291a4f10, tid=0x100,\n    descrip=0x223eb5e0 \"XU\") at /home/condor/execute/dir_12420/userdir/src/condor_utils/condor_threads.cpp:1109\n#21 0x000000000058a569 in DaemonCore::CallSocketHandler (this=0x1fae7f90, i=@0x7fff291a594c,\n    default_to_HandleCommand=true)\n    at /home/condor/execute/dir_12420/userdir/src/condor_daemon_core.V6/daemon_core.cpp:3647\n#22 0x0000000000591335 in DaemonCore::Driver (this=0x1fae7f90)\n    at /home/condor/execute/dir_12420/userdir/src/condor_daemon_core.V6/daemon_core.cpp:3531\n#23 0x000000000059f1f7 in main (argc=1, argv=0x7fff291a6048)\n---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit----\n    at /home/condor/execute/dir_12420/userdir/src/condor_daemon_core.V6/daemon_core_main.cpp:2377\n(gdb)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-May-24 09:11:22 by bbockelm:</em> <br/>\n\nWhich schedd's are crashing?  The remote one or the local one?  Is it only happening when Condor-C is used?\n\n<p>I'm using a PROPER build with the Globus5 in EPEL and haven't observed any crashes on our production schedd's.  (But maybe I'm just lucky?)\n\n</p><p></p><hr/>\n<em>2011-May-24 10:14:36 by zmiller:</em> <br/>\n\nthe \"client\" side is crashing, whether it's a schedd or condor_q.\n\n<p></p><hr/>\n<em>2011-May-24 10:40:16 by bbockelm:</em> <br/>\n\nThis should trigger it then, right:\n\n<p>[bbockelm@red ~]$ _CONDOR_SEC_CLIENT_AUTHENTICATION_METHODS=GSI _CONDOR_SEC_CLIENT_AUTHENTICATION=REQUIRED condor_q -debug\n\n</p><p>If so, I can't reproduce locally... sadly, it means the issue is going to be very subtle and perhaps version-specific.\n\n</p><p></p><hr/>\n<em>2011-May-24 10:53:39 by zmiller:</em> <br/>\n\ndate points:\n<div class=\"verbatim\">\n<pre>  7.6.1 client to 7.6.1 server: server segfaults\n  7.6.1 client to 7.6.0 server: client segfaults\n  7.6.0 client to 7.6.1 server: server segfaults\n  7.6.0 client to 7.6.0 server: no problem\n</pre></div>\n\nso it seems it doesn't matter if it's client or server, 7.6.1 as compiled and installed at the UW will segfault when using GSI.\n\n<p></p><hr/>\n<em>2011-May-24 16:48:20 by jfrey:</em> <br/>\n\nThis is caused by a change in how the externals are built. Now, every external is installed into a separate directory (the same as before the cmake changes happened). With this change, some additional CFLAGS and LDFLAGS need be set when building Globus. As it was, Globus was built referring to the system openssl, but linked with the externals openssl. Any differences in struct layouts or the like will cause memory corruption.\n\n<p>I just pushed a fix.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2332\" onclick=\"get_ticket_and_populate_wrapper('2332'); return false;\" title=\"Cream using multiple versions of openssl\">#2332</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCream using multiple versions of openssl</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-25 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bcd81703b96cbed309f684dcbf283587fa318672\">[22586]</a></span>: Fix cream build to use openssl from externals only. In building one of the glite modules used by cream (org.glite.security.gss), we were inadvertently compiling using the headers of the system's openssl but linking against our openssl external. This can lead to crashes like those seen in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2187\" onclick=\"get_ticket_and_populate_wrapper('2187'); return false;\" title=\"schedd crashes in GSI auth\">#2187</a></span>, due to\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-31 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1206e4133fbe9f120c259af7c0172e4eb6bab104\">[22048]</a></span>: Change Globus external version to avoid caching problems. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2187\" onclick=\"get_ticket_and_populate_wrapper('2187'); return false;\" title=\"schedd crashes in GSI auth\">#2187</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-24 16:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a98f4223bb9b29d525d2482c5292d0a70bb41732\">[21973]</a></span>: Fix build flags for Globus external. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2187\" onclick=\"get_ticket_and_populate_wrapper('2187'); return false;\" title=\"schedd crashes in GSI auth\">#2187</a></span> With each external being installed in a different directory, the CFLAGS and LDFLAGS for Globus need to be changed. Otherwise, it uses the system openssl half the time and the externals version the other half of the time. This was causing Condor to crash during\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-May-27 14:20", "status": "resolved", "created": "2011-May-23 16:33", "fixed_version": "2011-May-23 16:33", "broken_version": "v070600", "priority": "1", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba, bbockelm@cse.unl.edu", "due_date": ""}