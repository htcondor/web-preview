{"id": 7755, "title": "Ticket #7755: MACHINE_RESOURCE_NAMES can cause segfault", "description": "<blockquote>\nA reported a segfault on RHEL8 (but not RHEL7) with the following config:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">MACHINE_RESOURCE_NAMES = Network Ramdisk\nMACHINE_RESOURCE_Network = 100\nMACHINE_RESOURCE_INVENTORY_Ramdisk = \"gawk\n'BEGIN{p=\"\"df -l --output=size -B1 /dev/shm\"\";p|getline;p|getline;print \"\"DetectedRamdisk=\"\"int($0/1024/1024);}'\"\n</pre></div>\n\n\n<p>Commenting out either MACHINE_RESOURCE_NAMES or MACHINE_RESOURCE_INVENTORY_Ramdisk avoids the following problem:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/21/20 09:48:45 Local machine resource NAMES is not in MACHINE_RESOURCE_NAMES so it will have no effect\nCaught signal 11: si_code=1, si_pid=0, si_uid=1, si_addr=0x0\nStack dump for process 53337 at timestamp 1595317725 (11 frames)\n/usr/lib64/libcondor_utils_8_8_9.so(dprintf_dump_stack+0x24)[0x7f7f6365a484]\n/usr/lib64/libcondor_utils_8_8_9.so(_Z17unix_sig_coredumpiP9siginfo_tPv+0x69)[0x7f7f637a5579]\n/usr/lib64/libpthread.so.0(+0x12dd0)[0x7f7f61b41dd0]\n/usr/lib64/libc.so.6(+0x15a069)[0x7f7f618c7069]\n/usr/lib64/libcondor_utils_8_8_9.so(_ZN10StringList16contains_anycaseEPKc+0x36)[0x7f7f636c94c6]\ncondor_startd(_ZN14MachAttributes22init_machine_resourcesEv+0x25c)[0x42eb6c]\ncondor_startd(_ZN6ResMgr14init_resourcesEv+0x26)[0x4360d6]\ncondor_startd(_Z9main_initiPPc+0x1da)[0x46553a]\n/usr/lib64/libcondor_utils_8_8_9.so(_Z7dc_mainiPPc+0x15e0)[0x7f7f637a8e20]\n/usr/lib64/libc.so.6(__libc_start_main+0xf3)[0x7f7f617906a3]\ncondor_startd(_start+0x2e)[0x428a4e]\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Jul-27 10:46:28 by tlmiller:</em> <br/>\n\nThe problem is two-fold: first, that we erase resource names not in the map while iterating over the map, which is a no-no; and second, that MACHINE_RESOURCE_NAMES isn't specifically excluded from the list of config knobs that match MACHINE_RESOURCE_* when looking for the names of resources.\n\n<p></p><hr/>\n<em>2020-Jul-27 11:38:42 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : changes look good</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7756\" onclick=\"get_ticket_and_populate_wrapper('7756'); return false;\" title=\"startd runs scripts for excluded machine resources\">#7756</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nstartd runs scripts for excluded machine resources</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-27 12:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d3858460ade89553890968d14a22d3e6abd11d14\">[60237]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7755\" onclick=\"get_ticket_and_populate_wrapper('7755'); return false;\" title=\"MACHINE_RESOURCE_NAMES can cause segfault\">#7755</a></span>) Version history.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-27 11:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c2bb1965789bd4a8eb1653264e0a65d7391e997\">[60236]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7755\" onclick=\"get_ticket_and_populate_wrapper('7755'); return false;\" title=\"MACHINE_RESOURCE_NAMES can cause segfault\">#7755</a></span>) Ignore MACHINE_RESOURCE_NAMES when matching MACHINE_RESOURCE_* for machine resource names.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-27 11:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bdcb0b0cca6d0bfbf7718b67075f12527e8d4f75\">[60235]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7755\" onclick=\"get_ticket_and_populate_wrapper('7755'); return false;\" title=\"MACHINE_RESOURCE_NAMES can cause segfault\">#7755</a></span>) Don't erase elements of the map while iterating over it; this is disallowed by the std::map specification.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Jul-27 12:22", "status": "resolved", "created": "2020-Jul-27 10:41", "fixed_version": "2020-Jul-27 10:41", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}