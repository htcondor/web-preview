{"id": 2502, "title": "Ticket #2502: condor_startd doesn't start in old batlab", "description": "<blockquote>\nAfter 7.7.2 was installed in old batlab the master couldn't start the startd with error code 127.  strace didn't show any interesting output, and hung in the \"T\" state .  Here's what is going one.\n\n<p>1)  strace -ff doesn't work with our clone usage.  set the condor_config knob USE_CLONE_TO_CREATE_PROCESSES= false to allow strace to follow the master's children.\n\n</p><p>2) After that, we see that the start can't find the shared library libclassad.so.2.  Interesting, the token '$ORIGIN' is unexpanded in the open calls in the strace output\n\n</p><p>3) The ld.so docs say that $ORIGIN isn't expanded for setuid binaries.  But, I hear you cry, neither the startd nor the master is setuid.  In turns out that what  determines it was \"setuid\", is if the euid != ruid.  What the docs don't mention is that the program is also considered setuid if the egid != rgid.\n\n</p><p>Note that this problem does not manifest in the test suite, because that's not run as root.  Nor does it manifest in new batlab or CHTC, because they use native packages, and the shared libraries get plonked down in /usr/lib64, the default path.\n\n</p><p>4) Running a test program under the master shows that binaries spawned by the master have ruid == euid == 0, but rgid = 0 and egid = condor.\n\n</p><p>5) After further review, set_priv(PRIV_ROOT) inexplicably doen't set the gid.\n\n</p><p>In this ticket, I'm going to have set_priv(PRIV_ROOT) also setegid(root).  Note this is a pretty fundamental change, and I'm somewhat worried that some other code (NFS root squash?) may depend on this, but we just don't know.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-26 17:18:53 by bbockelm:</em> <br/>\n\nHi Greg,\n\n<p>There's already some specializations of set_priv for Create_Process.  Is there a harm in doing further abuse there?  This way, the changes only apply to post-fork and pre-exec.  Or, at least, only do this for PRIV_ROOT_FINAL?\n\n</p><p>Note about the CLONE issue: there's a patch floating around in gittrac to make Condor's clone usage compatible with gdb.  I'd be curious if it works for strace also.  Unfortunately, I never got it committed.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2011-Sep-26 23:41:09 by gthain:</em> <br/>\n\nIs there a PRIV_ROOT_FINAL?  What would that mean?  I think this is the right place, otherwise, switching to PRIV_ROOT leaves the egid in some random state.\n\n<p></p><hr/>\n<em>2011-Sep-30 14:39:56 by gthain:</em> <br/>\n\nTodd:  should we cherry-pick this back to 7.6?\n\n<p></p><hr/>\n<em>2011-Oct-12 10:29:31 by jfrey:</em> <br/>\n\nThis bug is caused by changes for tickets <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1135\" onclick=\"get_ticket_and_populate_wrapper('1135'); return false;\" title='\"Real\" dynamic binary releases'>#1135</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2389\" onclick=\"get_ticket_and_populate_wrapper('2389'); return false;\" title=\"Dynamically link Globus and VOMS libraries in UW builds\">#2389</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2390\" onclick=\"get_ticket_and_populate_wrapper('2390'); return false;\" title=\"Dynamically link ClassAds library\">#2390</a></span> and is only a problem for tarball releases of Condor.\n\n<p>Even with this fix, upgrading from pre-7.7.2 to 7.7.2+ by replacing the binaries will lead to the master exiting, as it fails to re-exec itself. There's no good solution to this problem. We need to put a note in the version history.\n\n</p><p>This argues strongly for back-porting this fix to 7.6. Then, people upgrading from 7.6 to 7.8 won't have the disappearing master problem.\n\n</p><p></p><hr/>\n<em>2011-Oct-17 14:48:16 by jfrey:</em> <br/>\n\nI've looked over the places we call set_root_priv() and believe there's very little risk of things failing if the egid changes to 0. dprintf() always changes to condor priv to access the daemon logs. For other files that are accessed, the code is switching to root so that it can access them securely (i.e. the files should be restricted to root-only write and possibly root-only read).\n\n<p></p><hr/>\n<em>2011-Oct-17 16:10:37 by jfrey:</em> <br/>\n\nI've cherry-picked this fix back to V7_6_4-branch. Thus, users upgrading from 7.6.4+ to 7.7.2+ or 7.8.x won't suffer the disappearing master problem.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-17 16:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ef3be83aab1b4db4aac461c862eb4f11c3c4c911\">[27867]</a></span>: set_priv(ROOT_PRIV) should also setegid(root) <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2502\" onclick=\"get_ticket_and_populate_wrapper('2502'); return false;\" title=\"condor_startd doesn't start in old batlab\">#2502</a></span> Committer: Jaime Frey  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-26 17:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a216db53392e8626caa864d0c688918be323609b\">[27418]</a></span>: set_priv(ROOT_PRIV) should also setegid(root) <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2502\" onclick=\"get_ticket_and_populate_wrapper('2502'); return false;\" title=\"condor_startd doesn't start in old batlab\">#2502</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Oct-17 16:10", "status": "resolved", "created": "2011-Sep-26 17:08", "fixed_version": "2011-Sep-26 17:08", "broken_version": "v070202", "priority": "1", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}