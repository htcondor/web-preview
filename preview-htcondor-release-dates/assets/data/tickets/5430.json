{"id": 5430, "title": "Ticket #5430: deadlock on windows when daemon talks to itself via shared port", "description": "<blockquote>\nWhen a daemon (say the collector) tries to send a TCP message to itself via shared port, it will deadlock on Windows because the outgoing message holds the big fat mutext, but the socket handoff (via pipe from shared port) cannot complete until the big fat mutex is released.\n\n<p>This happens routinely when the collector sends updates to COLLECTOR_HOST because it is usually a member (or the only entry!) in that list.\n\n</p><p>The fix for this should be 3 fold.\n\n</p><p></p><ol>\n<li>Since this communication will fail anyway, and lockup the shared port daemon in the process, the shared port daemon should just fail the connection attempt early instead.\n\n<p></p></li><li>The code in the collector to remove itself from the collector list before sending updates should be fixed - clearly it is not working on windows (or anywhere?).\n\n<p></p></li><li>The shared port on windows code should be modified so hand the socket off from the helper thread to the main thread without needing to take the big fat mutex.</li></ol>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5431\" onclick=\"get_ticket_and_populate_wrapper('5431'); return false;\" title=\"shared port should fail when source and destination are the same\">#5431</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nshared port should fail when source and destination are the same</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5432\" onclick=\"get_ticket_and_populate_wrapper('5432'); return false;\" title=\"collector doesn't always remove itself from collector list\">#5432</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncollector doesn't always remove itself from collector list</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5433\" onclick=\"get_ticket_and_populate_wrapper('5433'); return false;\" title=\"shared port on windows should hand sockets off without taking bigmutex\">#5433</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nshared port on windows should hand sockets off without taking bigmutex</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-14 21:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2c47b15e907eb9d6354847e72fd800b730fcccd5\">[46586]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5283\" onclick=\"get_ticket_and_populate_wrapper('5283'); return false;\" title=\"Shared port deadlock on Windows?\">#5283</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5430\" onclick=\"get_ticket_and_populate_wrapper('5430'); return false;\" title=\"deadlock on windows when daemon talks to itself via shared port\">#5430</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5431\" onclick=\"get_ticket_and_populate_wrapper('5431'); return false;\" title=\"shared port should fail when source and destination are the same\">#5431</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5432\" onclick=\"get_ticket_and_populate_wrapper('5432'); return false;\" title=\"collector doesn't always remove itself from collector list\">#5432</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5433\" onclick=\"get_ticket_and_populate_wrapper('5433'); return false;\" title=\"shared port on windows should hand sockets off without taking bigmutex\">#5433</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5434\" onclick=\"get_ticket_and_populate_wrapper('5434'); return false;\" title=\"Overflow error when setting cgroup vm limit when VM &gt; 2 gb\">#5434</a></span>  (By Tim Theisen )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Dec-14 16:58", "status": "resolved", "created": "2015-Dec-04 11:11", "fixed_version": "2015-Dec-04 11:11", "broken_version": "v080400", "priority": "3", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}