{"id": 446, "title": "Ticket #446: collector is freezing up after a forked child exits", "description": "<blockquote>\nSoon after merging in the thread code (<span class=\"ticket\"><a class=\"stalled\" href=\"/wiki-archive/tickets/?ticket=17\" onclick=\"get_ticket_and_populate_wrapper('17'); return false;\" title=\"Add support for kernel threads to facilitate non-blocking i/o\">#17</a></span>), some regression tests would occasionally fail.\n\n<p>DanB reported the following via email:\n</p><div class=\"verbatim\">\n<pre>Looking in all of the other failed test logs from last night, I see the\nsame pattern.  The collector is freezing up after a forked child exits\nand the collector has not yet processed the SIGCHLD.\n\nHere's one:\n04/30 02:15:48 (fd:6) (pid:15426) ForkWork: Child 15426 done, status 0\n04/30 02:15:48 (fd:5) (pid:15294) Entering thread safe start [select] in\nselector.cpp:311 unknown()\n\nAnd another:\n04/30 09:00:36 (fd:6) (pid:22825) ForkWork: Child 22825 done, status 0\n04/30 09:00:36 (fd:5) (pid:22806) Entering thread safe stop [select] in\nselector.cpp:317 unknown()\n04/30 09:00:36 (fd:5) (pid:22806) Leaving thread safe stop [select] in\nselector.cpp:317 unknown()\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2009-Apr-30 18:29:00 by tannenba:</em> <br/>\n\nLooks like the problem is with the mutex in dprintf, which was added to make dprintf() thread safe to aid in thread-related debugging.\n\n<p>The issue is in dprintf, we grab the mutex <em>before</em> blocking signals that could generate dprintfs (like SIGCHLD).  So if the SIGCHLD signal is delivered in the small window between grabbing the mutex and blocking dprintf-generating signals, we deadlock.\n\n</p><p>Will commit simple patch to master branch to grab mutex after signals are blocked, and of course release the mutex before signals are released.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Apr-30 18:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/329d66409c9ac382af35cbe666eb361c54ce3cdf\">[14616]</a></span>: In dprintf, must block signals before grabbing dprintf mutex to avoid deadlock. (gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=446\" onclick=\"get_ticket_and_populate_wrapper('446'); return false;\" title=\"collector is freezing up after a forked child exits\">#446</a></span>)  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-26 20:29", "status": "resolved", "created": "2009-Apr-30 18:25", "fixed_version": "2009-Apr-30 18:25", "broken_version": "v070301", "priority": "1", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "#17", "creator": "tannenba", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}