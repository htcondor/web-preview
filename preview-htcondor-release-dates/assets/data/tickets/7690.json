{"id": 7690, "title": "Ticket #7690: Deprecate old, bad Python interfaces", "description": "<blockquote>\nDeprecate the old event log reader and current job log reader classes (broken), as well as the old negotiator object (?).</blockquote>", "remarks": "<blockquote>\n<em>2020-Jun-16 15:51:37 by tlmiller:</em> <br/>\n\nAsking JoshK to review the implementation since this degree of Python sorcery is beyond my comfort level. :)\n\n<p></p><hr/>\n<em>2020-Jun-16 16:14:11 by tlmiller:</em> <br/>\n\nTJ, is <strong>htcondor.lock()</strong> also broken?  Should we avoid deprecating it?\n\n<p></p><hr/>\n<em>2020-Jun-17 11:28:55 by karpel:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>I get a build failure, probably related to the <code>make install</code> changes:\n</p><div class=\"code\">\n<pre class=\"code\">FAILED: bindings/python/build/timestamp\ncd /home/build/build/bindings/python &amp;&amp; /usr/bin/python2 /home/build/build/bindings/python/setup.py build &amp;&amp; /usr/bin/cmake3 -E touch /home/build/build/bindings/python/build/timestamp\n/usr/bin/python2: can't open file '/home/build/build/bindings/python/setup.py': [Errno 2] No such file or directory\n</pre></div>\n\n\n<p></p><ul>\n<li>I think the submodule should have a leading underscore in its name, since we don't intend end-users to import it.\n</li><li>The <code>deprecate</code> decorator needs to use <code>functools.wraps</code> as well, and that means it probably needs the <code>assigned</code> trick too. We should factor the <code>assigned</code> stuff out into a helper and re-use it here and in <code>_lock.py</code>. In fact, I think <code>deprecate_method</code> can probably just be a wrapper around <code>deprecate</code>, to further reduce code duplication.\n</li><li>The deprecation warning messages should be more specific. Language like \"Deprecated; will be removed in vX.Y.Z; replaced by <code>foo.bar</code>\".\n</li><li>I'm not convinced we can mark the un-constructable classes like this - I suspect the internal bindings code won't see these wrappers at all. We need to mark the methods that create those objects deprecated instead.\n</li><li>I recommend running <code>black</code> over this (I'd like us to be running <code>black</code> over all new Python code, where reasonable).\n</li></ul>\n\n<p></p><hr/>\n<em>2020-Jun-23 18:15:22 by tlmiller:</em> <br/>\n\nRegarding documentation:\n\n<p>AFAICT:\n\n</p><p></p><ul>\n<li><strong>hcondor.FileLock</strong> is not documented.\n</li><li><strong>htcondor.EventIterator</strong> is mentioned in the scalable job tracking page, but not documented.\n</li><li><strong>htcondor.LogReader</strong> is not documented.\n</li><li><strong>htcondor.lock</strong> is not documented.\n</li><li><strong>htcondor.read_events</strong> is mentioned in the scalable job tracking page, but not documented.\n</li></ul>\n\n<p>I have marked <strong>htcondor.Negotiator</strong> as deprecated, although we may want to reverse that before release; I think <strong>htcondor.Schedd.negotiate()</strong> is what everyone was worried about, but I don't recall at this point.\n\n</p><p>I will rewrite the scalable job tracking page as a different ticket, because yay for interactive tutorials.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7705\" onclick=\"get_ticket_and_populate_wrapper('7705'); return false;\" title=\"deprecated examples in scalable job tracking tutorial\">#7705</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ndeprecated examples in scalable job tracking tutorial</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7706\" onclick=\"get_ticket_and_populate_wrapper('7706'); return false;\" title=\"deprecated Python bindings used in test suite\">#7706</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ndeprecated Python bindings used in test suite</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-24 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c031d565ca0842edc5ea9031ca3a140ce828fa74\">[59972]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Don't deprecate htcondor.LogReader on platforms that don't have it (Windows).  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-24 08:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/70ff0c640514d32a38ae81d662152e1262370b5c\">[59969]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Ignore failures to set docstrings (Python 2 compatibility).  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-23 18:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/490a2d05cdf4ce4713c235db4b3163b240a5a420\">[59956]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Release notes, mark htcondor.Negotiator deprecated. (Nothing else was in the API docs.)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-18 15:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f84fb1356ab60a86186ad4131dcd926f0a3057c7\">[59914]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Also deprecate Schedd.negotiate(), as per gt#7524.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 15:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/df66b9acd037fa556fee1c207e044cc6ae507690\">[59906]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Final tweaks.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 14:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fdd351da0a307d6ee7f6bfac970bb534f57ed574\">[59903]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) refactor deprecation code; use import caching to avoid having to import in _deprecation.py; add deprecation warnings to docstrings automatically  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 13:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0052f2909f7f22d9996329eae5e2d64b541a88e9\">[59902]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) give deprecation submodule a _ prefix  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 13:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1ec2c5b924323e61ff314d1ec5a8126251ba12cb\">[59901]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) run black  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-16 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c1ef645376ec5019edb537c77dab3c6606119dc3\">[59892]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Final (for now) tweaks.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-16 15:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cb1024ebd186cbd2b3186c1517853ba7afe7e1db\">[59891]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Not sure how this got lost.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-16 15:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/758b2e7d8ad655369e1dfff8aa0f9ede2927a244\">[59890]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Only replace the __init__() method, not the whole class; this doesn't break anything.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-16 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c1bf7d9ebe1cd7780862809e9a8a38f790af13e\">[59889]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) A hack to make 'make install' refresh its cache of src/bindings/python every time.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-16 13:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4f7ac12a23453b146df933ea7996dadc7c2db034\">[59883]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7690\" onclick=\"get_ticket_and_populate_wrapper('7690'); return false;\" title=\"Deprecate old, bad Python interfaces\">#7690</a></span>) Deprecate all but the enums from the old and broken event and job queue log readers, as well as the negotiator object.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Jun-23 18:21", "status": "resolved", "created": "2020-Jun-16 13:36", "fixed_version": "2020-Jun-16 13:36", "broken_version": "", "priority": "2", "subsystem": "PythonBinding", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, karpel@wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}