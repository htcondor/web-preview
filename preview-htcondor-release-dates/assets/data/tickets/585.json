{"id": 585, "title": "Ticket #585: In the VM Gahp, systemCommand should open a bidirectional pipe", "description": "<blockquote>\nThis patch modifies the systemCommand function in the VM gahp so that it opens a local (Unix Domain) socket instead of a pipe.  This patch has no affect on Windows builds.  I am somewhat uncertain about whether or not the privsep code was preserved properly, but I believe that it was.</blockquote>", "remarks": "<blockquote>\n<em>2009-Jun-19 15:13:21 by tannenba:</em> <br/>\n\nHow does this \"enhance\" ?  In other words, what is the motivation for this patch, and how/who benefits?  Thanks.\n\n<p></p><hr/>\n<em>2009-Jun-19 16:52:28 by bkreuter:</em> <br/>\n\nI am currently working on another enhancement that will require executing a script and both writing to its stdin and reading its stdout/stderr.  The benefit of this particular patch is only for developers working on the VM gahp.\n\n<p></p><hr/>\n<em>2009-Jun-20 01:44:53 by matt:</em> <br/>\n\nThe benefit extends to any admin who wants to customize the libvirt xml based on the job ad.\n\n<p></p><hr/>\n<em>2009-Jun-23 14:20:04 by jfrey:</em> <br/>\n\nHere are my comments on the patch:\n\n<p></p><ul>\n<li>This code can dead-lock if the child process tries to write more data than the kernel buffers allow before consuming all of its input.\n\n<p></p></li><li>It appears the strings in cmd_in are expected to have newlines included, which is inconsistent with how cmd_out works (no newlines). systemCommand() should be adding the newlines for each string in cmd_in.\n\n<p></p></li><li>There should be a check at the top of systemCommand() for the caller attempting to use cmd_in on Windows, with either an EXCEPT() or a dprintf() and return -1.\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Jun-24 12:25:33 by bkreuter:</em> <br/>\n\nI have attached a new patch which addresses points 2 and 3.  With regard to point 1, the scripts that are executed are intended to be created by an administrator, and one of the requirements will be that the script drain its input before writing (this is not intended for interactive scripts).\n\n<p></p><hr/>\n<em>2009-Jun-30 13:33:55 by jfrey:</em> <br/>\n\nThe new patch looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/59/socketpair.patch\">socketpair.patch</a>\n5486 bytes added by bkreuter on 2009-Jun-19 16:49:05 UTC.\n<br/>\nThe patch.<br/>\n</li><li><a href=\"../files/62/socketpair.patch\">socketpair.patch</a>\n5612 bytes added by bkreuter on 2009-Jun-24 17:28:06 UTC.\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jul-07 13:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7fa671f5c79e29bf147fe78275b8b8b4aef7cc08\">[15029]</a></span>: Use execvp() when starting vmgahp scripts. Have the OS search the path for us, like previous my_popen() code does. gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=585\" onclick=\"get_ticket_and_populate_wrapper('585'); return false;\" title=\"In the VM Gahp, systemCommand should open a bidirectional pipe\">#585</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jul-02 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55bc07ab16c713384a324765e0b28fcd55957493\">[15010]</a></span>: Fix typo in previous commit. gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=585\" onclick=\"get_ticket_and_populate_wrapper('585'); return false;\" title=\"In the VM Gahp, systemCommand should open a bidirectional pipe\">#585</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jul-02 13:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/53c53e89f29dfa41904593ffd4550bf148763fe9\">[15009]</a></span>: Allow input to scripts called by the vm-gahp. gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=585\" onclick=\"get_ticket_and_populate_wrapper('585'); return false;\" title=\"In the VM Gahp, systemCommand should open a bidirectional pipe\">#585</a></span> Committer: Jaime Frey  (By Benjamin Kreuter )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2009-Dec-23 12:21", "status": "resolved", "created": "2009-Jun-19 11:48", "fixed_version": "2009-Jun-19 11:48", "broken_version": "v070300", "priority": "4", "subsystem": "VM", "assigned_to": "bkreuter", "derived_from": "", "creator": "bkreuter", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, bkreuter@redhat.com, jfrey@cs.wisc.edu", "due_date": ""}