{"id": 1963, "title": "Ticket #1963: Failure to write a UserLog event is not fatal", "description": "<blockquote>\nWith the v7.5.6 release candidate, on CHTC we have observed jobs running to completion and leaving the queue, and yet both the global and job event logs only have a running event - no execute or terminate event.\n\n<p>One big problem is the shadow does nothing beyond a dprintf when writing a user log event fails.  For example, when writing the job terminate event log fails, the shadow just does a dprintf and then merrily tells the schedd everything was fine, and the schedd then removes the job from the queue.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Mar-11 17:48:23 by tannenba:</em> <br/>\n\nCommit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6c91a795fa9154ce7f8a3f9565dd3fc74ad2ca7c\">[21031]</a></span> was code reviewed by gthain - pushed into v7.5.6-branch. We will be installing a shadow with these changes onto submit.chtc.wisc.edu to see if we can catch the problem in the act.\n\n<p></p><hr/>\n<em>2011-Mar-14 11:59:20 by tannenba:</em> <br/>\n\nAfter running the v7.5.6 prelease 2.5 days with the additional userlock log messages, we caught it in the act. Interesting shadow log snippet attached to this ticket. What we see is Shadow's attempting to grab the lock on the global event log, and chronically failing to do so for a period of a few seconds apparently because the underlying call to <code>fcntl()</code> is failing. When the underlying fcntl fails, apparently we ultimately fail to log the event anywhere. Our handling of fcntl failures is apparently not very robust.\n\n<p>Note this brief period of locking failures did not happen while the global event log was being rotated, so the rotation code is in the clear for the moment.\n\n</p><p>This may not be a regression. The lock failures appeared to happen grabbing the lock on the global event log (lots of shadows all locking the same file), and happened when there was a flood of events to log (many job evictions happened at the same time for some reason). The global event log has only been enabled on CHTC since end of Dec.\n\n</p><p></p><hr/>\n<em>2011-Apr-06 08:45:03 by tannenba:</em> <br/>\n\nGregT, please code review <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/98a8c510bba197879fed16989f98d4952d50178b\">[21277]</a></span> and <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b02790e24739e7133ed19eb4e3deca23d36776a6\">[21278]</a></span>\n\n<p></p><hr/>\n<em>2011-Apr-06 14:09:23 by cweiss:</em> <br/>\n\nA comment concerning changes in file_lock.unix.cpp:\n\n<p>For the non-blocking case we loop w/o an additional break condition in case of &amp;#8203;EINTR. I know that this has been that way since the dawn of time and unlikely to end up in an infinite loop, but I think I'd feel more comfortable if this loop also had a deterministic upper bound , maybe also </p><div class=\"verbatim\">\n<pre>num_retries &lt; _lock_file_num_retries</pre></div>\n ?</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2233\" onclick=\"get_ticket_and_populate_wrapper('2233'); return false;\" title=\"shadow crashes on user log init failure\">#2233</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nshadow crashes on user log init failure</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/291/ShadowLog.userlock.interesting.gz\">ShadowLog.userlock.interesting.gz</a>\n57246 bytes added by tannenba on 2011-Mar-14 16:47:02 UTC.\n<br/>\ngzipped one-minute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShadowLog\" title=\"Shadow Log\">ShadowLog</a></span> segment where file locking started to chronically fail on a UW CHTC submit node running v7.5.6 pre-release.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-06 08:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b02790e24739e7133ed19eb4e3deca23d36776a6\">[21278]</a></span>: If the shadow fails to initialize the user log, put the job on hold instead of EXCEPTing. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1963\" onclick=\"get_ticket_and_populate_wrapper('1963'); return false;\" title=\"Failure to write a UserLog event is not fatal\">#1963</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-05 21:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/98a8c510bba197879fed16989f98d4952d50178b\">[21277]</a></span>: Improve file locking by (1) saving and reporting errno in the event of a file lock error, and (2) retrying temporary file lock errors before giving up and returning failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1963\" onclick=\"get_ticket_and_populate_wrapper('1963'); return false;\" title=\"Failure to write a UserLog event is not fatal\">#1963</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-11 17:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6c91a795fa9154ce7f8a3f9565dd3fc74ad2ca7c\">[21031]</a></span>: The shadow will now EXCEPT if it fails to initialize the job event log or if it fails to write a job terminate event. Also, make certain that dprintf error messages in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> parts of the code are decorated with the string <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> or <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> (for easy grepping of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShadowLog\" title=\"Shadow Log\">ShadowLog</a></span> files) <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1963\" onclick=\"get_ticket_and_populate_wrapper('1963'); return false;\" title=\"Failure to write a UserLog event is not fatal\">#1963</a></span>.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Dec-27 12:32", "status": "resolved", "created": "2011-Mar-11 17:43", "fixed_version": "2011-Mar-11 17:43", "broken_version": "v070506", "priority": "1", "subsystem": "Libs", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "dan@hep.wisc.edu,gthain@cs.wisc.edu,jfrey@cs.wisc.edu", "due_date": "20110406"}