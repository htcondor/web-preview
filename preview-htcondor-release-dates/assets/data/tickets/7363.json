{"id": 7363, "title": "Ticket #7363: SSL memory leak", "description": "<blockquote>\nIt appears we have a memory leak in the SSL code.  Greg says:\n\n<p>It looks like guts inside an SSL CTX aren't getting free'd. I think the problem is near the end of condor_ssl_auth::authenticate, we do\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">    X509 *peer = (*SSL_get_peer_certificate_ptr)(ssl);\n    X509_NAME_oneline(X509_get_subject_name(peer), subjectname, 1024);\n    setAuthenticatedName( subjectname );\n    setRemoteUser( \"ssl\" );\n    setRemoteDomain( UNMAPPED_DOMAIN );\n\n    dprintf(D_SECURITY,\"SSL authentication succeeded to %s\\n\", subjectname);\n\n    (*SSL_CTX_free_ptr)(ctx);\n    (*SSL_free_ptr)(ssl);\n\n    free(buffer);\n    return success;\n</pre></div>\n\n\n<p>From my reading of the openssl docs, SSL_get_peer_certificate increments a reference count, and the cert inside the SSL CTX (named ssl in this case) won't free the cert inside it when CTX_free is called.  I think we need an X509_free(peer) call, like we do elsewhere.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Nov-08 13:38:52 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong> Looks good.  The only other place we call get_peer_certificate, we do call X509_free()</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-08 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d837ea16a6b054a0175153ea7008d984a065a99c\">[58422]</a></span>: Fix SSL memory leak. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7363\" onclick=\"get_ticket_and_populate_wrapper('7363'); return false;\" title=\"SSL memory leak\">#7363</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-08 12:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4008f8aba18685648e1ad6a036626bdd9e93d4e1\">[58414]</a></span>: Update version history for SSL memory leak. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7363\" onclick=\"get_ticket_and_populate_wrapper('7363'); return false;\" title=\"SSL memory leak\">#7363</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-08 11:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96c339fa3ca822d99d5db8ba05ca07475232c7ae\">[58413]</a></span>: Free the x509 resource, which was causing a memory leak. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7363\" onclick=\"get_ticket_and_populate_wrapper('7363'); return false;\" title=\"SSL memory leak\">#7363</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Nov-13 08:07", "status": "resolved", "created": "2019-Nov-08 11:00", "fixed_version": "2019-Nov-08 11:00", "broken_version": "v080800", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "zmiller@cs.wisc.edu, tannenba@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": ""}