{"id": 3051, "title": "Ticket #3051: SHADOW_LOCK fail death spiral", "description": "<blockquote>\nSubmit a bunch of jobs on a personal condor.\n\n<p>Eventually you will hit a shadow lock scenario where the schedd will refuse to run jobs:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">dprintf() had a fatal error in pid 27186\nCan't get exclusive lock on \"/home/tstclair/work/personal-condor/log/ShadowLock\", LockFd: -1\nerrno: 9 (Bad file descriptor)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Jun-11 22:08:46 by nwp:</em> <br/>\n\nOn my RHEL 6 CSL desktop machine, master will not start:\n\n<p>From <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MasterLog\" title=\"Master Log\">MasterLog</a></span>:\n</p><div class=\"code\">\n<pre class=\"code\">06/11/12 22:00:25 lock_file returning ERROR, errno=11 (Resource temporarily unavailable)\n06/11/12 22:00:25 FileLock::obtain(1) failed - errno 11 (Resource temporarily unavailable)\n06/11/12 22:00:25 ERROR \"Can't get lock on \"/scratch/nwp/personal-condor/log/InstanceLock\"\" at line 919 in file /u/n/w/nwp/CONDOR_SRC/src/condor_master.V6/master.cpp\n</pre></div>\n\n--In case this is related.\n\n<p></p><hr/>\n<em>2012-Jun-12 12:19:13 by nwp:</em> <br/>\n\nMy issues seem to have involved issues with the file system.  I blew away the $(LOG) directory and then mkdir'd it again; now everything works normally.  I had other FS issues also (my stashed ticket seems to have been corrupted) at the same time.\n\n<p></p><hr/>\n<em>2012-Jun-12 12:25:46 by nwp:</em> <br/>\n\nI do see Tim's reported behavior: I submitted 320 jobs, and condor ran about 150.  Now 170 jobs are sitting idle.  This is my personal condor, built from current master.\n\n<p></p><hr/>\n<em>2012-Jun-13 16:59:30 by johnkn:</em> <br/>\n\na change (that never shipped) to master branch had the *nix builds honoring the FILE_LOCK_VIA_MUTEX config knob.  The default value for this knob is true, but it appears that lock-via-mutex was only ever implemented in Windows, so file locking was just broken.\n\n<p>The commit changes dprintf_config so that it disables lock-via-mutex unconditionally on *nix.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-12 12:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7922b3d8aeff6a40a8343c5452fc5e7ca0631860\">[32279]</a></span>: ignore FILE_LOCK_VIA_MUTEX config value when not on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3051\" onclick=\"get_ticket_and_populate_wrapper('3051'); return false;\" title=\"SHADOW_LOCK fail death spiral\">#3051</a></span> mutex locking isn't implemented on *nix and the 7.8.x condor code ignores it a recent change to dprintf code started honoring this knob on *nix and broke things. ===VersionHistory:None=== bug never shipped.  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jun-25 13:57", "status": "resolved", "created": "2012-Jun-11 15:27", "fixed_version": "2012-Jun-11 15:27", "broken_version": "v070900", "priority": "1", "subsystem": "Daemons", "assigned_to": "johnkn", "derived_from": "", "creator": "tstclair", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tstclair@redhat.com, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}