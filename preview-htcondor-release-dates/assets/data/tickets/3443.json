{"id": 3443, "title": "Ticket #3443: daemon abort after changing STATISTICS_WINDOW_SECONDS, reconfig", "description": "<blockquote>\nAll daemon core daemons can be made to abort by letting the daemon run for <code>STATISTICS_WINDOW_SECONDS</code> seconds,  then reducing the value of <code>STATISTICS_WINDOW_SECONDS</code> param by at least 240 (the default quantum), and then running condor_reconfig on the daemon.\n\n<p>This will result in the following abort.\n\n</p><p></p><pre>    01/07/13 15:59:22 (pid:1068) ERROR \"Unexpected call to empty ring_buffer\n</pre>\n\n<p>REPRO for this bug (may be easier to reproduce in 7.9.3 ?) :\n\n</p><p>start with:\n</p><div class=\"code\">\n<pre class=\"code\"># I believe any size reduction will work, but here's my configuration\nSTATISTICS_WINDOW_QUANTUM = 1\nSTATISTICS_WINDOW_SECONDS = 30\n</pre></div>\n\n\n<p>start up a pool with a schedd.   Then change STATISTICS_WINDOW_SECONDS to 15 (reduce size of ring buffers) and:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_reconfig -schedd\n</pre></div>\n\n\n<p>You should see an exception in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span>:\n</p><div class=\"code\">\n<pre class=\"code\">01/07/13 15:59:22 (pid:1068) ERROR \"Unexpected call to empty ring_buffer\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-18 10:59:56 by tannenba:</em> <br/>\n\nTJ says patch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9df78d820762d5f1fff8d6a4177fdea9a6f758f\">[34639]</a></span> fixes the abort on reconfig with minimal changes to the code.  The work in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> is not needed to fix the abort, and thus nothing from <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> should be cherry-picked into the stable series.\n\n<p>While <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> does fix another bug in the ring buffer, it is a bug that has no known repro currently in HTCondor.  So in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span>, a unit test is added for this code, and some patches made to the code so all of the unit tests pass, but the unit test that was failing tests functionality that is not (yet) used in HTCondor.  Thus patch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9df78d820762d5f1fff8d6a4177fdea9a6f758f\">[34639]</a></span> is all that should be needed for the stable series.\n\n</p><p>As TJ wrote the patch, someone else should code review it (and leave code review comment in this ticket).  TJ feels very confident about the patch - it was tested on both RHEL and Windows, and this code has been running in production at CHTC for over a week with no problems (and with TJ poking at it).\n\n</p><p></p><hr/>\n<em>2013-Jan-18 13:56:15 by tstclair:</em> <br/>\n\n<strong>CODE REVIEW</strong>\nThe code should fix the crashing, but it clearly fails SetSize() tests, why that patch wasn't deemed ok for stable is unknown.  The other patch in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> does fix it, and imho should also be on 7.8 series as well.\n\n<p>In looking around at the rest of the code, I would like to raise a concern about the original code review.  It seems like we have recreated yet another data structure which was the root cause of the bug when many others would have sufficed (dequeue, vector).\n\n</p><p>If folks are going to hand-roll a container classes then there need to be justification for it (size/speed), data to support such a choice, and unit tests to back it.  E.g. Classads.\n\n</p><p></p><hr/>\n<em>2013-Jan-18 13:56:15 by eje:</em> <br/>\n\n\n<p>I would add that hand-rolled classes should adhere to STL interfacing standards everywhere possible:  <a class=\"external\" href=\"http://www.sgi.com/tech/stl/\">http://www.sgi.com/tech/stl/</a>  This makes it easier for the community to infer the api and behavior, and also allows inter-operability with other STL-compliant facilities (e.g. supplying iterators, begin() and end() means you can easily invoke the STL sort alg)\n\n</p><p></p><hr/>\n<em>2013-Jan-18 15:08:06 by tannenba:</em> <br/>\n\n@tstclair : The thinking here is there was a specific bug (crashing on reconfig) to fix in the stable series.  The code in this ticket is a minimal patch of the existing ring buffer code to fix the crash, no more, no less.   The other patch in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> essentially rewrites the ring buffer code.  Code rewrites/refactors belong in the dev series, not the stable series, even if the code has been written w/ unit tests.  Yes, the patch here still fails in v7.9 <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetSize\" title=\"Set Size\">SetSize</a></span> unit test, but I've been told that HTCondor v7.8 does not use the functionality tested by that unit test, so again fixing so <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetSize\" title=\"Set Size\">SetSize</a></span> passes belongs in the dev series.\n\n<p>Re comment about not reimplementing common containers: agree!  Between the STL and the containers already in the util lib, it should be rare that a new container needs to be built, and if a new one is built it should be built on top of existing tried/true contains as much as possible.\n\n</p><p></p><hr/>\n<em>2013-Jan-18 15:09:33 by tannenba:</em> <br/>\n\nCode review missed that there is no version history entry for this bug fix, set to docpending. TJ please add a version history blurb.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-26 10:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6929051f307081a0d0413072b0d1ada3dbe016a\">[35017]</a></span>: minor edit and HT-ify 7.8.8 version history item. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3443\" onclick=\"get_ticket_and_populate_wrapper('3443'); return false;\" title=\"daemon abort after changing STATISTICS_WINDOW_SECONDS, reconfig\">#3443</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-22 17:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/04f518a40d45eec50321be708893d0af14d1501f\">[34729]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3443\" onclick=\"get_ticket_and_populate_wrapper('3443'); return false;\" title=\"daemon abort after changing STATISTICS_WINDOW_SECONDS, reconfig\">#3443</a></span> ===VersionHistory:Complete===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-15 09:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9df78d820762d5f1fff8d6a4177fdea9a6f758f\">[34639]</a></span>: fix statistics ring buffer so that it no longer aborts after a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetSize\" title=\"Set Size\">SetSize</a></span> operation that reduces the size. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3443\" onclick=\"get_ticket_and_populate_wrapper('3443'); return false;\" title=\"daemon abort after changing STATISTICS_WINDOW_SECONDS, reconfig\">#3443</a></span>. This should fix the ring buffer problem in mentioned in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> also. parent ticket <span class=\"ticket\"><a class=\"stalled\" href=\"/wiki-archive/tickets/?ticket=2197\" onclick=\"get_ticket_and_populate_wrapper('2197'); return false;\" title=\"General statistics architecture for Condor\">#2197</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Mar-26 10:02", "status": "resolved", "created": "2013-Jan-15 09:30", "fixed_version": "2013-Jan-15 09:30", "broken_version": "v070807", "priority": "3", "subsystem": "Daemons", "assigned_to": "johnkn", "derived_from": "#2197", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, eje@cs.wisc.edu, johnkn@cs.wisc.edu, matt@redhat.com, tannenba@cs.wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}