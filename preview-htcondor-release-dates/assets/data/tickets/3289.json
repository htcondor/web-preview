{"id": 3289, "title": "Ticket #3289: Grid manager prematurely destroys keypairs.", "description": "<blockquote>\nThe GM_DELETE state in ec2job.cpp attempts to destroy the keypair created earlier in the job's lifecycle.  This state unconditionally follows GM_HOLD, which is entered when, for instance, a network burp prevents GM_PROBE_JOB from discovering the state of a (previously noted to be) running instance.\n\n<p>It may be OK to destroy the keypair -- if doing so doesn't destroy the instance's copy of the key, because if the job isn't still running by the time we get back to it, we can just make another one for resubmission -- but we shouldn't delete the user's copy of the private key until we know that the instance is gone, because otherwise they can't log in to it.\n\n</p><p>While we could destroy the keypair in GM_SAVE_INSTANCE_ID -- under the condition above, since the instance has started running and has its own undeletable copy of the public key -- it won't hurt anything to leave the keypair active longer, until, say, GM_DELETE.\n\n</p><p>Checking in GM_DELETE to see if the job is REMOVED or COMPLETED should suffice to only delete the user's key until we know the instance is terminated.  (If we have a problem terminating the instance when the user removes the job, we'll go into HOLD instead.)  This is probably the smallest code change that will resolve the problem.\n\n</p><p>We also need to make sure that we handle recovering a job whose instance has a destroyed keypair.</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2012-Oct-25 17:52:16 by johnkn:</em> <br/>\n\nBulk change of target version from v070806 to v070807 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2012-Nov-26 16:57:54 by tlmiller:</em> <br/>\n\nWe set ATTR_EC2_KEY_PAIR in the job ad in GM_SAVE_CLIENT_TOKEN, and check for it on startup, so we won't recreate it unnecessarily.  Otherwise, recovery ignores the keypair entirely.\n\n<p></p><hr/>\n<em>2012-Nov-27 11:54:21 by tlmiller:</em> <br/>\n\nThe current fix opens up a way to leave the key on disk after the job's been removed.  (condor_hold no longer deletes the key; on a condor_rm of a held job, the grid manager doesn't enter the state machine, so the key isn't never deleted.)  This could be fixed with cleverness about when not to remove the key (only remove on condor_hold or periodic_hold?) or maybe better by adjusting the grid manager's logic to check for a key on disk for a REMOVED or COMPLETED job.\n\n<p></p><hr/>\n<em>2012-Nov-29 11:48:41 by tlmiller:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">diff --git a/src/condor_gridmanager/ec2job.cpp b/src/condor_gridmanager/ec2job.cpp\nindex ec2ef15..5a534a8 100644\n--- a/src/condor_gridmanager/ec2job.cpp\n+++ b/src/condor_gridmanager/ec2job.cpp\n@@ -957,7 +957,6 @@ void EC2Job::doEvaluateState()\n\n\n \t\t\tcase GM_DELETE:\n-\n \t\t\t\tif (m_keypair_created)\n \t\t\t\t{\n \t\t\t\t  // Yes, now let's destroy the temporary keypair\n@@ -970,21 +969,36 @@ void EC2Job::doEvaluateState()\n \t\t\t\t\t  break;\n \t\t\t\t  }\n\n-\t\t\t\t  if (rc == 0) {\n-\n-\t\t\t\t\t  // remove temporary keypair local output file\n-\t\t\t\t\t  if ( !remove_keypair_file(m_key_pair_file.c_str()) ) {\n-\t\t\t\t\t\t  dprintf(D_ALWAYS,\"(%d.%d) job destroy keypair local file failed.\\n\", procID.cluster, procID.proc);\n-\t\t\t\t\t  }\n-\t\t\t\t\t  SetKeypairId( NULL );\n-\t\t\t\t\t  m_keypair_created = false;\n+\t\t\t\t  if( rc == 0 ) {\n+\t\t\t\t\t// Forget about the keypair.\n+\t\t\t\t\tSetKeypairId( NULL );\n+\t\t\t\t\tm_keypair_created = false;\n+\n+\t\t\t\t\t// Preserve the user's copy of the private key unless\n+\t\t\t\t\t// we're sure the instance is going away.  This will\n+\t\t\t\t\t// be overwritten on instance restart, if it occurs.\n+\t\t\t\t\t//\n+\t\t\t\t\t// Note that what we actually do here is check to see\n+\t\t\t\t\t// if the gridmanager will pay attention to the job the\n+\t\t\t\t\t// next time the gridmanager runs.  If it won't,\n+\t\t\t\t\t// we clean up.\n+\t\t\t\t\t//\n+\t\t\t\t\t// Except that, empirically, condor_rm doesn't clear\n+\t\t\t\t\t// the job ad.  *sigh*\n+\t\t\t\t\tstd::string gridJobID;\n+\t\t\t\t\tjobAd-&gt;LookupString( ATTR_GRID_JOB_ID, gridJobID );\n+\t\t\t\t\tif( gridJobID.empty() || condorState == REMOVED || condorState == COMPLETED ) {\n+\t\t\t\t\t\t// remove temporary keypair local output file\n+\t\t\t\t\t\tif ( !remove_keypair_file(m_key_pair_file.c_str()) ) {\n+\t\t\t\t\t\t\tdprintf(D_ALWAYS,\"(%d.%d) job destroy keypair local file failed.\\n\", procID.cluster, procID.proc);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n \t\t\t\t  } else {\n \t\t\t\t\t  errorString = gahp-&gt;getErrorString();\n \t\t\t\t\t  dprintf( D_ALWAYS,\"(%d.%d) job destroy keypair failed: %s: %s\\n\",\n \t\t\t\t\t\t\t  procID.cluster, procID.proc, gahp_error_code,\n \t\t\t\t\t\t\t  errorString.c_str() );\n \t\t\t\t  }\n-\n \t\t\t\t}\n\n \t\t\t\t// We are done with the job. Propagate any remaining updates\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Dec-04 13:59:39 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-17 13:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d291702a17c8b1cb21bc409384b50e9066fb2bbb\">[34416]</a></span>: clarified that these 7.8.7 bug fixes are for EC2 jobs in the grid universe ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3289\" onclick=\"get_ticket_and_populate_wrapper('3289'); return false;\" title=\"Grid manager prematurely destroys keypairs.\">#3289</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3061\" onclick=\"get_ticket_and_populate_wrapper('3061'); return false;\" title=\"Don't create ec2 ssh keypair if user doesn't request it\">#3061</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-05 11:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/576a60700ebbdfd6e2da1883a3ea8994cc88395a\">[34278]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3289\" onclick=\"get_ticket_and_populate_wrapper('3289'); return false;\" title=\"Grid manager prematurely destroys keypairs.\">#3289</a></span>) Do not prematurely destroy user's keypair file.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Dec-05 11:36", "status": "resolved", "created": "2012-Oct-24 11:41", "fixed_version": "2012-Oct-24 11:41", "broken_version": "v070800", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "s8199", "customer_group": "fermi", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}