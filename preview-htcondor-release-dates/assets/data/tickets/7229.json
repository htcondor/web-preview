{"id": 7229, "title": "Ticket #7229: Collector under shared port can forward ads to itself", "description": "<blockquote>\nWhen the collector is sitting behind a shared port server and CONDOR_VIEW_HOST is set to refer to itself, the collector can fail to notice the self-reference and end up forwarding ads to itself.\n\n<p>This can easily happen when using an array of child collectors that do authentication with daemons in the pool and forward ads to one parent collector (a collector tree), like CMS does. CONDOR_VIEW_HOST is set for all daemons, but the parent collector is supposed to refuse to forward ads to itself.\n\n</p><p>The problem occurs when the parent collector is using the shared port service and CONDOR_VIEW_HOST is set to a simple hostname or IP address and optional port. The collector uses Sinful::addressPointsToMe() to detect if the CONDOR_VIEW_HOST value refers to itself. In this case, the collector's internal sinful address includes a shared port id of <code>collector</code>, while the sinful address constructed from the CONDOR_VIEW_HOST setting has no shared port id. In this case, Sinful::addressPointsToMe() returns false, indicating the address refer to different daemons. But the shared port daemon will forward connection requests lacking a shared port id to the collector.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Oct-15 14:29:25 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The patch is well-formed, but I'm not sure it's a good idea.\n\n</p><p>There's a lengthy comment at line 1817 of <code>condor_collector.V6/collector.cpp</code> about the exact same problem, except for the COLLECTOR_HOST list, the gist of which is that context matters: when the collector asks, while trying to contact another collector, if the sinful it's about to contact is itself, we can be sure that in either sinful, the intended target is a collector.  The same is not true for all all other daemons.  While I can't think of a case that would arise naturally where this would misidentify a daemon, it doesn't seem impossible.  My preferred solution would thus be to turn the special-case code that follows the comment into a function and call it from both places (line 1817 and 1897) that need the fix.  On the other hand, I could be talked out of this, and we won't get a chance to test any changes I make in production.\n\n</p><p>Given that this hasn't caused any problems in testing so far, I will therefore mark this ticket as resolved, and open another one which tells Jaime and I to discuss this patch when he gets back.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7326\" onclick=\"get_ticket_and_populate_wrapper('7326'); return false;\" title=\"Discuss better fix for forwarding ads to self via CONDOR_VIEW_HOST\">#7326</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDiscuss better fix for forwarding ads to self via CONDOR_VIEW_HOST</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-21 22:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/faf637e3e4d8b27388648eb34313e32e96de5677\">[58223]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7229\" onclick=\"get_ticket_and_populate_wrapper('7229'); return false;\" title=\"Collector under shared port can forward ads to itself\">#7229</a></span>) Release note. Committer: Tim Theisen  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-21 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a363dfd0ace6f74f3dc16b7802ec76b60f042159\">[58221]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7229\" onclick=\"get_ticket_and_populate_wrapper('7229'); return false;\" title=\"Collector under shared port can forward ads to itself\">#7229</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-03 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d09a13526fa8c40304eef323ac9d4b74cf7cfcd8\">[57751]</a></span>: Fix collector self-reference check for ad forwarding with shared port <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7229\" onclick=\"get_ticket_and_populate_wrapper('7229'); return false;\" title=\"Collector under shared port can forward ads to itself\">#7229</a></span> Sinful::PointsToMe() didn't properly handle comparisons where one address includes a shared port id and the other doesn't (thus using the default id of 'collector'). This can easily cause the collector to incorrectly decide that\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Oct-21 16:25", "status": "resolved", "created": "2019-Sep-03 16:18", "fixed_version": "2019-Sep-03 16:18", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "tlmiller", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}