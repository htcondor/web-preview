{"id": 7697, "title": "Ticket #7697: SHARED_PORT_PORT is never honored", "description": "<blockquote>\nWhen the master chooses the port to assign to the shared_port daemon, if the master is not starting a collector, it will ignore SHARED_PORT_PORT and instead attempt to use the same port as the pool's collector.\n\n<p>This is clearly wrong in the case where of a node that is not running a collector (i.e. a submit node, or execute node), but the local machine is using shared port.  The user who ran into this problem wanted to start a Schedd and use shared port and specify a specific port for shared port because he was running in a container under k8s.  It turns out this configuration never works - SHARED_PORT_PORT is always ignored.\n\n</p><p>The reason is that the master first scans the COLLECTOR_LIST looking to see if there is a local collector with a port assignment. If this list is not empty, then there is a bug in the use of same_host() that results in the master thinking it has found a matching collector.  It then uses the port from that entry, and that entry does not have an explicit port, it uses the default port.\n\n</p><p>Only when the COLLECTOR_LIST is empty, does the master param for SHARED_PORT_PORT or COLLECTOR_PORT to get the port number.\n\n</p><p>The code in the master should be changed so that if it is not starting a local primary collector (i.e. the daemon list has COLLECTOR), it will never look at COLLECTOR_LIST to determine the port.  This is the immediate bug.\n\n</p><p>In a separate ticket, we will fix the bug where same_host() is being used incorrectly.\n\n</p><p><span class=\"subsubsection\"></span></p><h4>workaround </h4>\nIf the COLLECTOR_LIST is empty, or the first entry in the list uses the desired port, then the master will assign that port to the shared-port daemon.  This has the undesirable property of having the master try and send it's ad to at non-existent collector, but since COLLECTOR_LIST can be a list, it can be configured to <strong>also</strong> send it's ad to the real collector\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">config fragment</pre>\n<pre class=\"snip\"># The first entry in the list is what defines the local shared port port\nMASTER.COLLECTOR_LIST = $(IP_ADDRESS):$(SHARED_PORT_PORT) $(COLLECTOR_HOST)\n# If the collector list is empty, the master will use SHARED_PORT_PORT\nMASTER.COLLECTOR_LIST =\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Jul-31 16:12:22 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>I found (and fixed) a few issues in the ticket description itself, but the code and version history blurb look good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-28 11:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aa1fbf82601ed99827c906e99c8d6e6ce0941935\">[60255]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7697\" onclick=\"get_ticket_and_populate_wrapper('7697'); return false;\" title=\"SHARED_PORT_PORT is never honored\">#7697</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-25 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5be5ef9cee7084663c6390f70001c22309a1a4f6\">[59987]</a></span>: fix lib_auth_protocol-token test which was broken by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7697\" onclick=\"get_ticket_and_populate_wrapper('7697'); return false;\" title=\"SHARED_PORT_PORT is never honored\">#7697</a></span>, SHARED_PORT_PORT = 0 added to test config  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-24 15:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f1eaba90ca4716e5497a641ccb4a516c65ef5638\">[59975]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7697\" onclick=\"get_ticket_and_populate_wrapper('7697'); return false;\" title=\"SHARED_PORT_PORT is never honored\">#7697</a></span>, fix master so it uses SHARED_PORT_PORT to define the listen port of the shared-port daemon and ignores COLLECTOR_LIST and COLLECTOR_HOST when the master is not starting a primary COLLECTOR. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Jul-31 16:13", "status": "resolved", "created": "2020-Jun-19 14:36", "fixed_version": "2020-Jun-19 14:36", "broken_version": "v080403", "priority": "1", "subsystem": "DaemonMaster", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}