{"id": 883, "title": "Ticket #883: VM universe refactor", "description": "<blockquote>\nThe following are open items for refactoring in the next series:\n\n<p><strong>What:</strong>\n\n</p><p>Coding: (In general all the code is subject to review.)\n</p><div class=\"code\">\n<pre class=\"code\">1.) Nix VMPARAM_ and JobVM from classad attributes\n2.) Cleanup xentype.h &amp; .cpp it's rather difficult to follow\n3.) move vmware to libvirt, and any other new vm (virtbox)\n4.) support for libvirt on windows?\n</pre></div>\n\n\n<p>Submission changes:\n</p><div class=\"code\">\n<pre class=\"code\">1.) Consider having user provide libvirt xml description file for VMs that\nwork with libvirt. Then remove array of submit params specific to\nxen/kvm/vmware et al. Call it vm_description_file or vm_config_file.\n\n2.) Have Condor parse libvirt and vmware description files to get list of\nfiles to be transfered. Then kill xen_transfer_files params and simply say transefer_file = yes || no.\n\n3.) Maybe get rid of vm_should_transfer_files. Allow VM files to be visible\nat execute machine but not submit machine. Support file transfer hooks\nfor vm files.\n\n4.) Investigate usefulness of execute-machine provided kernel/initrd/etc.\nCan we just require them to be included with user-provided image?\n</pre></div>\n\n\n<p>Param changes:\n</p><div class=\"code\">\n<pre class=\"code\">1.) Consolidation can occur across the params.\n\n2.) VM_GAHP_SERVER should be set to default value in config file (not\ncommented out).\n\n3.) VMWARE_LOCAL_SETTINGS_FILE and XEN_LOCAL_SETTINGS_FILE can be replaced\nwith VM_LOCAL_SETTINGS_FILE or just removed. Are these params useful?\n</pre></div>\n\n\n<p>Open bugs/items which need to be addressed:\n</p><div class=\"code\">\n<pre class=\"code\">1.) libvirtd restarting causes vm-gahp to continue on even though the connection to the vm is gone.\n2.) All existing vm-universe bugs\n    #45,#272,#302,#303,#387,#405,#515,#517,#523,#618,#625,#626,#740,#854,#858\n3.) test and verify xen_type = vmx..?\n4.) remove VM_SCRIPT &amp;&amp; XEN_SCRIPT entirely?\n5.) Update notes on VM_BRDIGE_SCRIPT for KVM\n6.) remove mkisofs, let the xml specify the files, and handle\n</pre></div>\n\n\n<p><strong>Why:</strong>\n</p><div class=\"code\">\n<pre class=\"code\">As we have seen with the 7.4 release, there are a fair number of issues with\nthe vm-universe and it is my goal to ensure that the vm-universe is flexible,\nsimple, reliable, and *testable*.\n</pre></div>\n\n\n<p><strong>How:</strong>\n\n</p><p>I would like to team up with someone from UW (Jamie) and run through the following:\n</p><div class=\"code\">\n<pre class=\"code\">1.) Evaluation of current operation and use cases.\n2.) Define updated use case senario, and open to a broader audience (market feedback)\n3.) Evaluate current implementation and determine what we would like to do to meet the updated use case senario\n4.) Define attack plan, and test plan\n5.) Switch off between writing tests and attack plan.\n6.) goto 1 and verify.\n</pre></div>\n\n\n<p><strong>Expected Output:</strong>\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">1.) Documentation (detail is subject to debate)\n2.) Test Plan (To avoid the mistakes of the 7.4 release)\n3.) Updated vm-gahp\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2009-Nov-30 12:08:09 by matt:</em> <br/>\n\nIntegrate into above: VM_MEMORY cannot be reconfigured, but more generally the Memory and CPU limits make up a second, VMU sepcific, set of resource limits that should be factored out.\n\n<p>See <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=625\" onclick=\"get_ticket_and_populate_wrapper('625'); return false;\" title=\"Rework how startd handles VM resources\">#625</a></span>\n\n</p><p></p><hr/>\n<em>2009-Nov-30 12:10:14 by matt:</em> <br/>\n\nIntegrate into above: vm-gahp ignores failure of killVM, likely should not.\n\n<p></p><hr/>\n<em>2009-Dec-05 17:03:51 by matt:</em> <br/>\n\nIntegrate into above: Removal of hardcoded Xen/KVM XML, only use config script.\n\n<p></p><hr/>\n<em>2009-Dec-23 12:30:09 by tstclair:</em> <br/>\n\nSome use cases: per matt - ref in main doc and cleanup ticket (near term)\n\n<p><span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=515\" onclick=\"get_ticket_and_populate_wrapper('515'); return false;\" title=\"VM load not considered Condor Load\">#515</a></span> - Administrators want to be able to use <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LoadAvg\" title=\"Load Avg\">LoadAvg</a></span> in their policies on execute nodes that run VMs.\n\n</p><p><span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=486\" onclick=\"get_ticket_and_populate_wrapper('486'); return false;\" title=\"[RFE] Vacate and Hold command\">#486</a></span> - Users want to be able to checkpoint and hold a VM in a single operation. (Impl, may be similar to Jon Thomas' work on honoring kill_sig in condor_rm/hold for vanilla universe)\n\n</p><p><span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=1023\" onclick=\"get_ticket_and_populate_wrapper('1023'); return false;\" title=\"[RFE] Provide a means to get console dumps for VMs\">#1023</a></span> - Developers and VM Img builders want the ability to get access to the VM's console as an output file, if one exists.\n</p><hr/>\n<em>2010-Oct-20 15:59:08 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2010-Nov-29 12:55:41 by tstclair:</em> <br/>\n\nsee also\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1021\" onclick=\"get_ticket_and_populate_wrapper('1021'); return false;\" title=\"libvirt version mismatch from distro (x,y,z)\">#1021</a></span>\n\n<p></p><hr/>\n<em>2010-Dec-06 15:29:41 by bbockelm:</em> <br/>\n\nIntegrate into above:\n\n<p>- \"condor_reconfig\" causes the startd to recheck VM-GAHP capabilities.\n- Passing \"args\" in the submit file without setting a CDROM device will guarantee an execute-time error.  This can be caught and remedied at submit time.\n\n</p><p></p><hr/>\n<em>2010-Dec-06 19:41:47 by bbockelm:</em> <br/>\n\nSorry, forgot another two issues:\n\n<p></p><ul>\n<li>condor_submit messes up the determination of file transfers, and fails at sites without a shared file system unless you specify the (undocumented) magic string \"REQUIREMENTS = TARGET.FileSystemDomain <code>!</code> FALSE\"\n</li><li>The RHEL5 libvirt creates a log file per unique VM name created.  Condor gives each VM a unique name, meaning there's one log file per VM universe job in /var/log/libvirt/qemu.  These files don't get cleaned up ever (but they do appear to get logrotated).  We probably should consider naming the VM after the slot rather than the job.\n</li></ul>\n\n<p></p><hr/>\n<em>2010-Dec-20 10:28:06 by bbockelm:</em> <br/>\n\nIf we're going to dig into the VM-GAHP code, I do have one feature request:\n\n<p>VM Universe should be able to create and mount a scratch partition inside the VM.  This would allow us to keep the size of our VMs down to a minimum - right now, the VMs tend toward 10GB+ because CMS requires 10GB of scratch space.  This causes us to add the extra step of compressing the (mostly sparse) image when transferring it.\n\n</p><p>Thoughts?  My understanding of libvirt is this wouldn't be overly difficult.\n\n</p><p></p><hr/>\n<em>2010-Dec-20 10:58:22 by tstclair:</em> <br/>\n\nBrian -\n\n<p>Your last comment seems rather strange.  You want to have a separate scratch location which condor will manage?  and do what with (destroy it?)\n\n</p><p>As a general solution, if I enable the notion of passing in your own .xml file you could do whatever you want [This will be targeted for the next developer series.].  But you will need to be <strong>careful</strong> to set your job's disk requirements when landing.\n</p><hr/>\n<em>2011-Jan-27 14:46:04 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2011-Feb-08 12:00:00 by tiradani:</em> <br/>\n\nHere is one use case for Brian's request.  Presumably, a worker node would have plenty of disk space available for jobs.  In EC2, you have your disk image where your OS resides.  Also, automatically mounted is temporary disk space that is available during the VM run time only.  In essence, what I would like is to have the ability to tell Condor to mount a worker node directory in the VM as scratch space.  Once the VM is done running, wipe out the directory so that all cruft is cleaned up.  This will enable me to create VMs that are small in file size and easier to distribute.  From a site perspective, getting the smaller images to the worker nodes is easier than trying to stage out 10GB+ VMs (even if you pre-stage, that is a lot of wasted disk space once you factor in multiple users and multiple versions).</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1090\" onclick=\"get_ticket_and_populate_wrapper('1090'); return false;\" title=\"Initial header proto for vm-gahp 2.0\">#1090</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nInitial header proto for vm-gahp 2.0</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1119\" onclick=\"get_ticket_and_populate_wrapper('1119'); return false;\" title=\"libvirtd restarting causes vm-gahp to continue on even though the conn\">#1119</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nlibvirtd restarting causes vm-gahp to continue on even though the conn</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1143\" onclick=\"get_ticket_and_populate_wrapper('1143'); return false;\" title=\"VM_MEMORY not evaluated, param sites inconsistent\">#1143</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nVM_MEMORY not evaluated, param sites inconsistent</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-07 13:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/98c8fa94a735595784bf26739c6a60d069f05e34\">[19613]</a></span>: Ticket <span class=\"ticket\"><a class=\"stalled\" href=\"/wiki-archive/tickets/?ticket=883\" onclick=\"get_ticket_and_populate_wrapper('883'); return false;\" title=\"VM universe refactor\">#883</a></span>: Initial prepwork to enable multiple versions of vm_gahp  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-06 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c578131195ee7b4f0c74711a5eb4bf704f4d430\">[16260]</a></span>: Ticket <span class=\"ticket\"><a class=\"stalled\" href=\"/wiki-archive/tickets/?ticket=883\" onclick=\"get_ticket_and_populate_wrapper('883'); return false;\" title=\"VM universe refactor\">#883</a></span>: removal of root check on file privs. Jamie and I had both agreed this should not exist.  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-17 06:12", "status": "stalled", "created": "2009-Oct-23 11:15", "fixed_version": "2009-Oct-23 11:15", "broken_version": "v070400", "priority": "4", "subsystem": "Daemons", "assigned_to": "tstclair", "derived_from": "#45", "creator": "tstclair", "rust": "", "customer_group": "users", "visibility": "public", "notify": "jfrey@cs.wisc.edu, rrati@redhat.com, craig.struble@marquette.edu, david.herzfeld@marquette.edu", "due_date": "PARENT"}