{"id": 3131, "title": "Ticket #3131: investigate security issue", "description": "<blockquote>\n<strong>THIS IS A SECURITY ISSUE</strong> and is <strong>NOT FOR PUBLIC DISCUSSION</strong>\n\n<p>everything that follows is referencing a pool that uses only host-based authorization with no authentication.\n\n</p><p>when conodor receives a connection, it decides if the connection is authorized by looking at an ALLOW_X list (for example, ALLOW_ADMINISTRATOR).  this list can contain IP addresses, hostnames, and wildcards in either.\n\n</p><p>if the IP address has a reverse DNS entry that maps the IP to, for example, \"condor.cs.wisc.edu\", then an attacker may connect from that IP address and actually be authorized as if they were coming from a different IP address.\n\n</p><p>proposed fix:  after doing a reverse lookup, also do a forward lookup to verify that the IP that initiated the connection is a valid IP for that DNS hostname.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Jul-17 13:54:37 by zmiller:</em> <br/>\n\n<strong>CONFIRMED</strong>\n\n<p>i actually tested this by setting up a \"naughty\" reverse DNS for exec-1.batlab.org:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">% host exec-1.batlab.org\nexec-1.batlab.org has address 128.104.103.1\n% host 128.104.103.1\n1.103.104.128.in-addr.arpa domain name pointer exec-1.batlab.org.\n1.103.104.128.in-addr.arpa domain name pointer astro.cs.wisc.edu.\n</pre></div>\n\n\n<p>and here is the authorization list on bio.cs.wisc.edu:\n</p><div class=\"code\">\n<pre class=\"code\">% condor_config_val hostallow_administrator\ntonic.cs.wisc.edu, chopin.cs.wisc.edu, astro.cs.wisc.edu, stork.cs.wisc.edu, pinguino.cs.wisc.edu, cobalt.cs.wisc.edu nation.cs.wisc.edu\n</pre></div>\n\n\n<p>i then logged in to exec-1.batlab.org and was able to issue a condor_off command to bio.cs.wisc.edu.  here is the master log (notice the IP/hostname correlation):\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/17/12 13:49:07 Calling Handler &lt;DaemonCommandProtocol::WaitForSocketData&gt; (2)\n07/17/12 13:49:07 DC_AUTHENTICATE: received DC_AUTHENTICATE from &lt;128.104.103.1:49786&gt;\n07/17/12 13:49:07 DC_AUTHENTICATE: added incoming session id bio:4051:1342550947:7 to cache for 80 seconds (lease is 3620s, return address is unknown).\n07/17/12 13:49:07 DC_AUTHENTICATE: Success.\n07/17/12 13:49:07 IPVERIFY: matched user unauthenticated@unmapped from astro.cs.wisc.edu to allow list\n07/17/12 13:49:07 Adding to resolved authorization table: unauthenticated@unmapped/128.104.103.1: ADMINISTRATOR\n07/17/12 13:49:07 PERMISSION GRANTED to unauthenticated@unmapped from host 128.104.103.1 for command 60005 (DC_OFF_GRACEFUL), access level ADMINISTRATOR: reason: ADMINISTRATOR authorization policy allows hostname astro.cs.wisc.edu; identifiers used for this remote host: 128.104.103.1,astro.cs.wisc.edu\n07/17/12 13:49:07 Received TCP command 60005 (DC_OFF_GRACEFUL) from unauthenticated@unmapped &lt;128.104.103.1:49786&gt;, access level ADMINISTRATOR\n07/17/12 13:49:07 Calling HandleReq &lt;handle_off_graceful()&gt; (0) for command 60005 (DC_OFF_GRACEFUL) from unauthenticated@unmapped &lt;128.104.103.1:49786&gt;\n07/17/12 13:49:07 Return from HandleReq &lt;handle_off_graceful()&gt; (handler: 0.000s, sec: 0.004s, payload: 0.000s)\n07/17/12 13:49:07 Return from Handler &lt;DaemonCommandProtocol::WaitForSocketData&gt; 0.0041s\n07/17/12 13:49:07 Got SIGTERM. Performing graceful shutdown.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Jul-17 14:48:05 by tannenba:</em> <br/>\n\nThoughts on a patch:\n\n<p>When Condor does the reverse dns for host based authentication, it needs to implement <a class=\"external\" href=\"http://en.wikipedia.org/wiki/Forward-confirmed_reverse_DNS\">forward-confirmed reverse dns</a>.\n\n</p><p>At a high level, when the server receives a connection from the client, Condor should do an inverse lookup to get a list of hostnames associated with that address.  For each hostname, it should do a forward lookup, and discard any entry in the list where a forward lookup does not return the same address.\n\n</p><p>This should be a simple patch, but things are more complicated now with the IPv6 code. With the addition of IPv6, it is not clear the host alias functionality is intact, and also not clear that all code paths funnel through <code>condor_gethostbyaddr()</code> anymore like they did before IPv6.\n\n</p><p></p><hr/>\n<em>2012-Jul-18 11:56:33 by tannenba:</em> <br/>\n\nThoughts on a workaround:\n\n<p>Until folks upgrade their binaries, I folks would be safe if they changed their host allow/deny settings to only reference IP addresses (no hostnames). For instance, instead of\n\n</p><p></p><pre>   hostallow_write = *.cs.wisc.edu\n</pre>\n\n<p>instead do\n\n</p><p></p><pre>   hostallow_write = 128.105.*\n----\n_2012-Aug-23 13:52:45 by zmiller:_ <br/>\n\nBulk change of target version from v070802 to v070803 using ./ticket-target-mover.\n----\n_2012-Aug-23 14:11:43 by zmiller:_ <br/>\n\nBulk change of target version from v070802 to v070803 using ./ticket-target-mover.</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-15 13:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4fcc1c8371c1aa0b69926d28e97e224766d428fe\">[33067]</a></span>: move in fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3131\" onclick=\"get_ticket_and_populate_wrapper('3131'); return false;\" title=\"investigate security issue\">#3131</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-15 11:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37492c993fcdcf84fccd01118091df381e24b979\">[33061]</a></span>: move in fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3131\" onclick=\"get_ticket_and_populate_wrapper('3131'); return false;\" title=\"investigate security issue\">#3131</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-15 09:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/087be53444af869f05613ef94adce1d0f00d3839\">[33052]</a></span>: fix issue <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3131\" onclick=\"get_ticket_and_populate_wrapper('3131'); return false;\" title=\"investigate security issue\">#3131</a></span>  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jun-17 14:47", "status": "resolved", "created": "2012-Jul-17 11:12", "fixed_version": "2012-Jul-17 11:12", "broken_version": "v070000", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}