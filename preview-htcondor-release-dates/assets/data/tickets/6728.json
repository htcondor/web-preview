{"id": 6728, "title": "Ticket #6728: Undefined job policy expression can put job in tight run/idle cycle", "description": "<blockquote>\nWhen a job policy expression evaluates to Undefined, HTCondor is supposed to put the job on hold. If this happens when input transfer is starting and when_to_transfer_output is ON_EXIT_OR_EVICT, the starter ends up trying to start output transfer at the same time as input transfer and EXCEPTs. This sends the job back into idle status instead of held.\n\n<p>This error in the starter can be triggered by any graceful shutdown command that it receives during the input sandbox transfer. The fix is for the starter to skip output transfer if the job hasn't started yet. An undefined job policy expression only triggers this bug in 8.7 (due to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6549\" onclick=\"get_ticket_and_populate_wrapper('6549'); return false;\" title=\"ProvisionedGPUs wrong\">#6549</a></span>), but other causes of a graceful shutdown to the starter would affect 8.6.\n\n</p><p>The CMS team discovered this bug when their periodic remove expression included the following:\n</p><div class=\"code\">\n<pre class=\"code\">JobStatus=?=2 &amp;&amp; MemoryUsage &gt; RequestMemory\n</pre></div>\n\n\n<p>Two things that merit attention (probably deserving their own tickets):\n</p><ul>\n<li>Consensus in the hallway is that we should change Condor so that an Undefined result for a job policy expression should treated the same as having not set the expression.\n</li><li>The shadow doesn't evaluate the job policy expressions periodically before the job starts executing. It will do so in reaction to a job ad update from the starter or schedd.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-22 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f456a69fc9d2eacfe009bcdb1d1fe523f79f14e7\">[55598]</a></span>: Docs for starter EXCEPTing on shutdown during file transfer bug fix <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6728\" onclick=\"get_ticket_and_populate_wrapper('6728'); return false;\" title=\"Undefined job policy expression can put job in tight run/idle cycle\">#6728</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Aug-02 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ce6ca4386ee26ea56ea532d2fa1273f12c4bf781\">[55252]</a></span>: Don't do vacate-time output transfer if job hasn't started. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6728\" onclick=\"get_ticket_and_populate_wrapper('6728'); return false;\" title=\"Undefined job policy expression can put job in tight run/idle cycle\">#6728</a></span> If the job hasn't started yet, there's no point in doing a transfer of output files. It's actively harmful if an input transfer is occurring, as the starter will EXCEPT.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Oct-22 14:55", "status": "resolved", "created": "2018-Aug-01 15:34", "fixed_version": "2018-Aug-01 15:34", "broken_version": "", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}