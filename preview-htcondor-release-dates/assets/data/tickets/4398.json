{"id": 4398, "title": "Ticket #4398: STARTD_CRON should have a way to set slot specific values", "description": "<blockquote>\nIn configuration files,  one can use the configuration\n\n<p></p><pre>   STARTD_ATTRS = FOO\n   SLOT1_FOO = 1\n   SLOT2_FOO = 2\n</pre>\n\n<p>to publish FOO in slot1 &amp; slot2 will a different value in each slot, so the above configuration will result in the following STARD slot ads containing:\n\n</p><p></p><pre>   slot1 = [\n      FOO = 1\n   ]\n   slot2 = [\n      FOO = 2\n   ]\n</pre>\n\n<p>This is complicated by the fact that one can also use the configuration\n\n</p><p></p><pre>   STARTD_SLOT_ATTRS = FOO\n</pre>\n\n<p>To request that the value of for each slot be published in each slot, so if you had 2 slots as indicated above. This additional configuration would result in STARTD slot ads containing:\n\n</p><p></p><pre>   slot1 = [\n      FOO = 1\n      slot1_FOO = 1\n      slot2_FOO = 2\n   ]\n   slot2 = [\n      FOO = 2\n      slot1_FOO = 1\n      slot2_FOO = 2\n   ]\n</pre>\n\n<p>Note that <code>FOO = 1</code>, in slot1 and <code>FOO = 2</code> in slot2.\n\n</p><p>A hawkeye script can return <code>slot1_FOO = 1 and slot2_FOO = 2</code> and this will result in both of these attributes in both of the slots.  But there is no way for hawkeye (STARTD_CRON) scripts to set different values of FOO in each of the slot.\n\n</p><p>One possible solution would be for the output of hawkeye scripts to be parsed so that an attribute slot1_FOO would be treated as setting FOO only in slot1 rather than in all slots.  This could be combined with <code>STARTD_SLOT_ATTRS = FOO</code> to achieve the same output as can be achieved by config statements.\n\n</p><p>Another possible solution would be to extend the hawkeye script to accept multiple ads as return and either use classad nesting syntax or parse the <code>SlotId</code> or <code>SlotName</code> attributes of the returned ads to determine what slots to publish them into.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jun-11 10:01:46 by johnkn:</em> <br/>\n\nFrom investigation the current behavior of STARTD_CRON is:\n<ul>\n<li>attributes are read from stdout one at a time, and accumulated into a temporary classad until the script exits or until it writes a line beginning with '-'.\n</li><li>scripts of type <code>WaitForExit</code> can run forever, but they <em>must</em> write line starting with a '-' periodically or they have no effect on the startd ad(s).\n</li><li><code>STARD_CRON</code> can be combined with <code>STARTD_SLOT_ATTRS</code> but there appears to be a delay of one update cycle or so before the <code>STARTD_SLOT_ATTRS</code> propagates slot attrs to other slots.\n</li><li><code>STARTD_CRON_*_SLOTS</code> can be used to set the output slots for a script, so (at least on a machine with only static slots) advertising different values to different slots can be achieved with the current code.\n</li><li>Advertising different values to different dynamic slots is impossible to do because currently all dynamic slots share a slot id.\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Jun-16 11:06:00 by johnkn:</em> <br/>\n\nIt now seems clear to me that part of the solution to writing different values to different slots should be permitting the STARTD_CRON scripts write multiple ads.  This would allow for the possibility of having different merge rules for the different ads.\n\n<p>There would then need to be way to designate which ads are merged into which slots.  My thought was to look in the STARTD_CRON ad(s) for a <code>SlotId</code> or <code>SlotTypeId</code> or <code>SlotName</code> attribute and use that to direct the merge.  Since we <em>don't</em> want to allow a STARTD_CRON script to change these attributes of the slot, there is no ambiguity with using them (if they exist) to control the merge.\n\n</p><p>Todd suggested that we might also look for a new attribute containing a boolean expression that would control which slots the ad merged into.  This seems powerful, but I'm inclined to begin by looking for <code>SlotId</code>, <code>SlotTypeId</code> and <code>SlotName</code> since we want to prevent these from merging anyway.\n\n</p><p></p><hr/>\n<em>2014-Jun-16 17:17:32 by johnkn:</em> <br/>\n\npatch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/83206bd9c48141ea0342a4506094e60aa5145860\">[40449]</a></span> makes it possible to set different values into different slots, but in a different way than originally proposed.  Its comprised of two basic changes.\n\n<p></p><ul>\n<li>a line starting with '-' can now be followed by arguments.  the '-' line has always indicated end-of-classad.  It can now be followed by a uniqness tag to indicate the 'name' of the ad that should be replaced by the new ad. This name is joined to the name of the STARTD_CRON job to produced a full name for the ad. This allows a single STARTD_CRON script to return multiple ads - by giving each a unique name.  And to replace multiple ads - by using the same unique name as a previous invocation.  The optional uniqness tag can be followed by an optional keyword <code>update:&lt;bool&gt;</code>, which can be used to override the STARTD_CRON configuration and suppress or force immediate updates.\n\n<p></p></li><li>Each ad can return one of 4 possible attributes to control what slots the ad is merged into when the STARTD sends updates to the collector. These attributes are, in order of priority.\n<ul>\n<li><code>SlotMergeConstraint</code> <em>Expression</em> The current ad is merged into all slot ads for which this expression is true. The expression is evaluated with the slot ad as the TARGET ad.\n</li><li><code>SlotName</code> <em>String</em> The current ad is merged into all slots whose <code>Name</code> attributes match the value of <code>SlotName</code> up to the length of <code>SlotName</code>\n</li><li><code>Name</code> <em>String</em> - Alternative to <code>SlotName</code>\n</li><li><code>SlotTypeId</code> <em>Integer</em> The current ad is merged into all ads that have the same value for their <code>SlotTypeId</code> attribute.\n</li><li><code>SlotId</code> <em>Integer</em> The current ad is merged into all ads that have the same value for their <code>SlotId</code> attribute.\n</li></ul>\n</li></ul>\n\n<p>Attributes are checked in the above order.  If the attribute exists, the it controls the merge, otherwise the next higher priority attribute is checked. If <code>STARTD_CRON_&lt;tag&gt;_SLOTS</code> configuration is set, then the actual slots published to will be the intersection of configuration and script output.\n\n</p><p>For example - if the STARTD_CRON job returns:\n\n</p><p></p><pre>    Value=1\n    SlotId=1\n    -s1\n    Value=2\n    SlotId=2\n    -s2\n    Value=10\n    - update:true\n</pre>\n\n<p>This script will set Value=10 into all slots except slot1 &amp; slot2.  On those slots it will set Value=1 and Value=2 respectively. It will also send updates to the collector immediately\n\n</p><p></p><hr/>\n<em>2015-Nov-16 16:12:35 by tannenba:</em> <br/>\n\nThis ticket should never have been resolved, the documentation is useless. I opened a new child ticket (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5403\" onclick=\"get_ticket_and_populate_wrapper('5403'); return false;\" title=\"Documentation of startd_cron (hawkeye) is incomplete and confusing\">#5403</a></span>) to deal with the Manual.\n\n<p></p><hr/>\n<em>2016-Aug-24 11:30:39 by wenger:</em> <br/>\n\nTJ says there are now meta-knobs for this.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5403\" onclick=\"get_ticket_and_populate_wrapper('5403'); return false;\" title=\"Documentation of startd_cron (hawkeye) is incomplete and confusing\">#5403</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDocumentation of startd_cron (hawkeye) is incomplete and confusing</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6488\" onclick=\"get_ticket_and_populate_wrapper('6488'); return false;\" title=\"SlotMergeConstraint failures ignored\">#6488</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SlotMergeConstraint\" title=\"Slot Merge Constraint\">SlotMergeConstraint</a></span> failures ignored</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-04 12:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/23f6f3471eef701e08df6e7ad6421f0193ec1aac\">[40835]</a></span>: add 8.3.0 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4398\" onclick=\"get_ticket_and_populate_wrapper('4398'); return false;\" title=\"STARTD_CRON should have a way to set slot specific values\">#4398</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 14:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f23858a2c0c57c6953dcc57bc7bd0f8483234104\">[40634]</a></span>: new prose to explain how new syntax in generated start cron output affects <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4398\" onclick=\"get_ticket_and_populate_wrapper('4398'); return false;\" title=\"STARTD_CRON should have a way to set slot specific values\">#4398</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 12:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2485c7f574f2d88c684806a3dc8c240d1fbf8b7c\">[40631]</a></span>: In 8.2.2 manual, document that output of a dash from a startd cron executable causes the attributes to be incorporated into the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4398\" onclick=\"get_ticket_and_populate_wrapper('4398'); return false;\" title=\"STARTD_CRON should have a way to set slot specific values\">#4398</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-16 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/83206bd9c48141ea0342a4506094e60aa5145860\">[40449]</a></span>: Add support to publish different values in different slots from STARTD_CRON scripts <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4398\" onclick=\"get_ticket_and_populate_wrapper('4398'); return false;\" title=\"STARTD_CRON should have a way to set slot specific values\">#4398</a></span> This patch adds support for returning multiple ads from a single invocation of the script, and for using attributes inside each of those ads to define what slots the ad is published into. ===VersionHistory:Pending===\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Aug-24 11:30", "status": "resolved", "created": "2014-Jun-10 13:31", "fixed_version": "2014-Jun-10 13:31", "broken_version": "v080200", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}