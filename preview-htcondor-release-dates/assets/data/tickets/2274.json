{"id": 2274, "title": "Ticket #2274: Put job on hold for credential error (AuthFailure)", "description": "<blockquote>\nAs Seo-Young Noh (working with Steve Timm) says:\n\n<p></p><pre>  &gt; It was definitely my fault to not provide correct keyfile, but I am\n  &gt; thinking that I could find my mistake easily if a log message indicated\n  &gt; \"Authentication Failure\" rather than \"Detected Down Globus/Grid\n  &gt; Resource\".\n</pre>\n\n<p>I fixed the logging problem that was preventing Noh from finding any better error messages.  However, it isn't clear if the GAHP does (or, as presently structured, can) distinguish between a 'down resource' and an authentication failure or similar problem.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Nov-05 09:58:03 by matt:</em> <br/>\n\nAn authentication error is fatal and requires human interaction to fix. The job needs to be put on hold with an appropriate message. Currently, the job stays Idle forever. The only way to troubleshoot is to check the EC2_GAHP_LOG.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ tail -n2 $(condor_config_val EC2_GAHP_LOG)\n11/11/11 11:11:11 Failure response text was '&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;Response&gt;&lt;Errors&gt;&lt;Error&gt;<code>AuthFailure</code>&lt;Message&gt;AWS was not able to validate the provided access credentials&lt;/Message&gt;&lt;/Error&gt;&lt;/Errors&gt;&lt;RequestID&gt;ab50f005-6d77-4653-9cec-298b2d475f6e&lt;/RequestID&gt;&lt;/Response&gt;'.\n\n$ grep down $(condor_config_val GRIDMANAGER_LOG)\n11/11/11 11:11:11 [10697] resource https://ec2.amazonaws.com is now down\n11/11/11 11:14:22 [10697] resource https://ec2.amazonaws.com is still down\n</pre></div>\n\n\n<p>Note - this does not prevent other EC2 jobs with valid credentials from continuing to operate.\n\n</p><p></p><hr/>\n<em>2012-Nov-29 14:56:12 by tlmiller:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">diff --git a/src/condor_gridmanager/gahp-client.cpp b/src/condor_gridmanager/gahp-client.cpp\nindex 48c6b15..fcfdabb 100644\n--- a/src/condor_gridmanager/gahp-client.cpp\n+++ b/src/condor_gridmanager/gahp-client.cpp\n@@ -6023,6 +6023,20 @@ int GahpClient::ec2_ping(std::string service_url,\n\n \tif ( result ) {\n \t\tint rc = atoi(result-&gt;argv[1]);\n+\n+\t\t// If the service returns an authorization failure, that means\n+\t\t// the service is up, so return true.  Individual jobs with\n+\t\t// invalid authentication tokens will then go on hold, which is\n+\t\t// what we want (rather than saying idle).\n+\t\tif( result-&gt;argc == 4 ) {\n+\t\t    std::string errorCode = result-&gt;argv[2];\n+\t\t    std::string errorString = result-&gt;argv[3];\n+\n+\t\t    if( errorCode.find( \"(401)\" ) != std::string::npos ) {\n+\t\t        rc = 0;\n+\t\t    }\n+\t\t}\n+\n \t\tdelete result;\n \t\treturn rc;\n \t}\ndiff --git a/src/ec2_gahp/amazonCommands.cpp b/src/ec2_gahp/amazonCommands.cpp\nindex e603966..be4a6ee 100644\n--- a/src/ec2_gahp/amazonCommands.cpp\n+++ b/src/ec2_gahp/amazonCommands.cpp\n@@ -491,7 +491,8 @@ bool AmazonRequest::SendRequest() {\n     curl_easy_cleanup( curl );\n\n     if( responseCode != 200 ) {\n-        this-&gt;errorCode = \"E_HTTP_RESPONSE_NOT_200\";\n+        // this-&gt;errorCode = \"E_HTTP_RESPONSE_NOT_200\";\n+        sprintf( this-&gt;errorCode, \"E_HTTP_RESPONSE_NOT_200 (%lu)\", responseCode );\n         this-&gt;errorMessage = resultString;\n         dprintf( D_ALWAYS, \"Query did not return 200 (%lu), failing.\\n\",\n             responseCode );\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Dec-04 13:56:03 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>I'd prefer the checking for credential error to be done in EC2Resource::DoPing().\n\n</p><p></p><hr/>\n<em>2012-Dec-05 14:18:55 by tlmiller:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">diff --git a/src/condor_gridmanager/ec2resource.cpp b/src/condor_gridmanager/ec2resource.cpp\nindex abc7c16..b54ec4b 100644\n--- a/src/condor_gridmanager/ec2resource.cpp\n+++ b/src/condor_gridmanager/ec2resource.cpp\n@@ -132,15 +132,25 @@ void EC2Resource::DoPing( time_t&amp; ping_delay, bool&amp; ping_complete, bool&amp; ping_su\n \t}\n\n \tping_delay = 0;\n-\n-\tint rc = gahp-&gt;ec2_ping( resourceName, m_public_key_file, m_private_key_file );\n+\n+\tchar * error_code = NULL;\n+\tint rc = gahp-&gt;ec2_ping( resourceName, m_public_key_file, m_private_key_file, error_code );\n\n \tif ( rc == GAHPCLIENT_COMMAND_PENDING ) {\n \t\tping_complete = false;\n \t}\n \telse if ( rc != 0 ) {\n \t\tping_complete = true;\n-\t\tping_succeeded = false;\n+\n+\t\t// If the service returns an authorization failure, that means\n+\t\t// the service is up, so return true.  Individual jobs with\n+\t\t// invalid authentication tokens will then go on hold, which is\n+\t\t// what we want (rather than saying idle).\n+\t\tif( error_code != NULL &amp;&amp; strstr( error_code, \"(401)\" ) != NULL ) {\n+\t\t    ping_succeeded = true;\n+\t\t} else {\n+\t\t    ping_succeeded = false;\n+\t\t}\n \t}\n \telse {\n \t\tping_complete = true;\ndiff --git a/src/condor_gridmanager/gahp-client.cpp b/src/condor_gridmanager/gahp-client.cpp\nindex 48c6b15..871fb43 100644\n--- a/src/condor_gridmanager/gahp-client.cpp\n+++ b/src/condor_gridmanager/gahp-client.cpp\n@@ -5989,7 +5989,8 @@ int GahpClient::ec2_vm_status( std::string service_url,\n // Ping to check if the server is alive\n int GahpClient::ec2_ping(std::string service_url,\n \t\t\t\t\t\t std::string publickeyfile,\n-\t\t\t\t\t\t std::string privatekeyfile)\n+\t\t\t\t\t\t std::string privatekeyfile,\n+\t\t\t\t\t\t char *&amp; error_code )\n {\n \t// we can use \"Status All\" command to make sure EC2 Server is alive.\n \tstatic const char* command = \"EC2_VM_STATUS_ALL\";\n@@ -6023,6 +6024,12 @@ int GahpClient::ec2_ping(std::string service_url,\n\n \tif ( result ) {\n \t\tint rc = atoi(result-&gt;argv[1]);\n+\n+\t\tif( result-&gt;argc == 4 ) {\n+\t\t    error_code = strdup( result-&gt;argv[2] );\n+\t\t    error_string = result-&gt;argv[3];\n+\t\t}\n+\n \t\tdelete result;\n \t\treturn rc;\n \t}\ndiff --git a/src/condor_gridmanager/gahp-client.h b/src/condor_gridmanager/gahp-client.h\nindex 0b9790a..5dcf1bc 100644\n--- a/src/condor_gridmanager/gahp-client.h\n+++ b/src/condor_gridmanager/gahp-client.h\n@@ -572,7 +572,8 @@ class GahpClient : public Service {\n\n \t\tint ec2_ping( std::string service_url,\n \t\t\t\t\t  std::string publickeyfile,\n-\t\t\t\t\t  std::string privatekeyfile );\n+\t\t\t\t\t  std::string privatekeyfile,\n+\t\t\t\t\t  char* &amp; error_code );\n\n \t\tint ec2_vm_create_keypair( std::string service_url,\n \t\t\t\t\t\t\t\t   std::string publickeyfile,\ndiff --git a/src/ec2_gahp/amazonCommands.cpp b/src/ec2_gahp/amazonCommands.cpp\nindex e603966..be4a6ee 100644\n--- a/src/ec2_gahp/amazonCommands.cpp\n+++ b/src/ec2_gahp/amazonCommands.cpp\n@@ -491,7 +491,8 @@ bool AmazonRequest::SendRequest() {\n     curl_easy_cleanup( curl );\n\n     if( responseCode != 200 ) {\n-        this-&gt;errorCode = \"E_HTTP_RESPONSE_NOT_200\";\n+        // this-&gt;errorCode = \"E_HTTP_RESPONSE_NOT_200\";\n+        sprintf( this-&gt;errorCode, \"E_HTTP_RESPONSE_NOT_200 (%lu)\", responseCode );\n         this-&gt;errorMessage = resultString;\n         dprintf( D_ALWAYS, \"Query did not return 200 (%lu), failing.\\n\",\n             responseCode );\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Dec-05 15:21:08 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>It looks like you have a memory leak in EC2Resource::DoPing() now. You could change the new parameter to GahpClient::ec2_ping() to be a std::string reference.\n\n</p><p></p><hr/>\n<em>2012-Dec-05 16:46:20 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The committed version looks good.\n\n</p><p></p><hr/>\n<em>2012-Dec-05 16:52:23 by tlmiller:</em> <br/>\n\nYay!</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-17 11:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/041ee265413dfd78cb5937cabc7c3343658d4c4d\">[34411]</a></span>: removed parentheses on 7.8.7 version history item. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2274\" onclick=\"get_ticket_and_populate_wrapper('2274'); return false;\" title=\"Put job on hold for credential error (AuthFailure)\">#2274</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-06 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9236e510c2199d5addafb2f9a1ae27f6f42eced0\">[34319]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2274\" onclick=\"get_ticket_and_populate_wrapper('2274'); return false;\" title=\"Put job on hold for credential error (AuthFailure)\">#2274</a></span>) Friends don't let friends call sprintf() with a std::string. Committer: Jaime Frey  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-06 11:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ce12f50d10004bfaf43d2c952f061c27c877d68e\">[34312]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2274\" onclick=\"get_ticket_and_populate_wrapper('2274'); return false;\" title=\"Put job on hold for credential error (AuthFailure)\">#2274</a></span>) Friends don't let friends call sprintf() with a std::string.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-05 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a9615b017429b3378db8e13df08f634e14203ccf\">[34292]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2274\" onclick=\"get_ticket_and_populate_wrapper('2274'); return false;\" title=\"Put job on hold for credential error (AuthFailure)\">#2274</a></span>) Mention in the version history.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-05 16:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/062fb3f71bb5eb453c0575c89440ca10bf8991f7\">[34290]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2274\" onclick=\"get_ticket_and_populate_wrapper('2274'); return false;\" title=\"Put job on hold for credential error (AuthFailure)\">#2274</a></span>) Put EC2 jobs on hold for credential errors.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Dec-05 16:52", "status": "resolved", "created": "2011-Jun-28 09:12", "fixed_version": "2011-Jun-28 09:12", "broken_version": "v070700", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "#2150", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}