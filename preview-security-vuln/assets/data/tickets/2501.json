{"id": 2501, "title": "Ticket #2501: clean up glexec job proxy", "description": "<blockquote>\nWhen glexec is invoked, it creates a copy of the job proxy.  This proxy is not used by Condor, because we go out of our way to override X509_USER_PROXY so that the job uses the copy of the proxy managed by Condor.  It is important to use the copy managed by Condor in order to make sure the job gets updates to the proxy.\n\n<p>Condor should try to make sure the copy of the job proxy made by glexec is cleaned up.  Perhaps the condor glexec job wrapper could just delete it.  In versions of glexec that support disabling its creation, that could be done instead.\n\n</p><p>Here is some more information from an email by Mischa:\n\n</p><p>The create_target_proxy was indeed added after 0.6.8, in the 0.8 to be\nprecise. We realized that the proxy creation behaviour in version 0.6\nand below was arbitrary and indeterministic: sometimes the payload would\nbe trying to use the pilot proxy, often there just wasn't a proxy due to\ninternal errors. We then decided to fix this and decided how to do it.\nThat's described on\n<a class=\"external\" href=\"https://www.nikhef.nl/pub/projects/grid/gridwiki/index.php/Proxy_file_handling_in_gLExec\">https://www.nikhef.nl/pub/projects/grid/gridwiki/index.php/Proxy_file_handling_in_gLExec</a>\nThis was implemented in 0.7, but we realized that the target proxy\nshould be made optional. In the 0.8 it is still written by default but\nnow made optional. If you are sure the payload doesn't need a proxy (no\ndata access etc.) you can switch it off. The default proxy is a copy of\nthe payload proxy (GLEXEC_CLIENT_CERT) owned by the target user in /tmp\nwith a random name. The X509_USER_PROXY in the payload environment is\nexplicitly set to that location.\nYou have a point that if gLExec itself determined the target proxy name\nit probably could safely remove it (in linger mode). When the target\nfilename is explicitly set (via GLEXEC_TARGET_PROXY) it might not be\ngood, since the proxy might be reused by a next payload job. That was\noriginally the motivation not to remove it, we probably should\nreconsider that. Once the epilogue-functionality is there (should be in\nthe next release, before the end of this calendar year) I think that\nwould be the right place to clean it.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-05 16:07:59 by danb:</em> <br/>\n\nBrian found that setting GLEXEC_TARGET_PROXY to the path of the proxy managed by Condor was an effective way to avoid a leaked proxy.  Since glexec just copies the proxy rather than delegating it, this results in the proxy being overwritten with an identical copy, which should be harmless.  Since this issue applies to both the case where the job is launched and the case where various other helper scripts are run, the solution needed to apply to both <code>GLExecPrivSepHelper::run_script()</code> and <code>GLExecPrivSepHelper::create_process()</code>.  Since there was no convenient way to modify the environment in <code>run_script()</code> I chose to do all the environment manipulation in the glexec helper scripts, including the helper script used to launch the job.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-30 17:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5dca113134e4da663e67eef9b2bdf743e08a38e0\">[27563]</a></span>: Documented fix for glexec cleaning up the proxy. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2501\" onclick=\"get_ticket_and_populate_wrapper('2501'); return false;\" title=\"clean up glexec job proxy\">#2501</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-30 17:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8ea5a392595cf727a6ae7eddcaad8c53dc5c07d9\">[27562]</a></span>: Make sure glexec does not leave behind copies of the proxy in /tmp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2501\" onclick=\"get_ticket_and_populate_wrapper('2501'); return false;\" title=\"clean up glexec job proxy\">#2501</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Nov-22 09:33", "status": "resolved", "created": "2011-Sep-26 14:33", "fixed_version": "2011-Sep-26 14:33", "broken_version": "v070600", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,burt@fnal.gov,zmiller@cs.wisc.edu", "due_date": ""}