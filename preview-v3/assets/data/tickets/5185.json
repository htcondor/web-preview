{"id": 5185, "title": "Ticket #5185: Collector still tries to authenticate itself.", "description": "<blockquote>\nA follow-up bug to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5128\" onclick=\"get_ticket_and_populate_wrapper('5128'); return false;\" title=\"Collector tries to authenticate with self\">#5128</a></span>.\n\n<p><em>2015-Jul-20 21:25:23 by bbockelm:</em> <br/>\n\nHm - nope, this doesn't work in the out-of-the-box defaults with USE_SHARED_PORT=true.\n\n</p><p>With COLLECTOR_HOST set to hcc-briantest.unl.edu, it tries to update the following addr:\n</p><div class=\"verbatim\">\n<pre>&lt;129.93.244.208:9618&gt;\n</pre></div>\n\n\n<p>The collector identifies itself as the following:\n\n</p><p></p><div class=\"verbatim\">\n<pre>&lt;129.93.244.208:9618?addrs=129.93.244.208-9618&amp;noUDP&amp;sock=collector&gt;\n</pre></div>\n\n\n<p></p><hr/>\n<em>2015-Jul-21 09:54:04 by tlmiller:</em> <br/>\n\nThat <em>is</em> the wrong collector host, fwiw.  It happens to work because we hacked in support for it in the shared port daemon, but it's really not actually specifying the collector.\n\n<p>One of the special cases we have to handle in PointsToMe() -- or whatever we call it -- is obviously the one where the shared port daemon transparently passes connections along to the collector.\n\n</p><p>This may even have to be specific to collector-sends-updates logic -- in the general case, we can't tell if you're trying to talk to the shared port daemon (perhaps as part of some other source route) or to the collector it aliases.  However, for the updating logic, since we know the update ad command will be forwarded to the corresponding collector, that doesn't matter.  I guess we'd also have to verify that \"we\" have the socket name \"collector\", in case somebody tries to do something clever.  (Assuming that the socket named \"collector\" always gets the forwarded connectios...)\n\n</p><p></p><hr/>\n<em>2015-Jul-27 10:48:20 by tlmiller:</em> <br/>\n\nAfter a discussion with de Smet, the possibility of addressPointsToMe() being called while we're connecting to the shared port daemon (for the purpose of forwarding a connection), especially considering that the shared port code checks to see if it's on the same machine as the daemon, precludes including the special case code there; we don't want to risk leaving a landmine to step on during later development.\n\n<p></p><hr/>\n<em>2015-Jul-30 16:07:15 by tlmiller:</em> <br/>\n\nIncidentally, the reason we never saw this in our own testing is because we don't test with fixed port numbers.  If you specify hostname:0, it works.  I assume this is because we use the address file in that case, and the address file contains the full and complete sinful string.</blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-30 16:29:35 by tlmiller:</em> <br/>\n\nThis fix (wrongly) identifies all collectors behind the same shared port daemon as the same.  I'm not sure that this is a valid configuration.  If it is, then I don't know how identify which collector the SPd will default to; is it guaranteed to have the ID 'collector'?\n\n<p>At any rate, that configuration, if valid, is surely rarer than the one Brian stumbled on, so this fix is still moving forward.\n\n</p><p></p><hr/>\n<em>2015-Jul-30 21:00:36 by bbockelm:</em> <br/>\n\nThe logic in condor_master for shared port ID of the collector is:\n<ul>\n<li>COLLECTOR_USES_SHARED_PORT must be set to true.\n</li><li>Set shared port ID to parameter SHARED_PORT_DEFAULT_ID, if set.  Defaults to 'collector'.\n</li><li>The daemon must be referred to as \"COLLECTOR\".\n</li></ul>\n\n<p>I think you can probably benefit from the first two here?\n\n</p><p></p><hr/>\n<em>2015-Aug-12 14:03:40 by tlmiller:</em> <br/>\n\nSHARED_PORT_DEFAULT_ID is read by the shared port daemon and the master, so any collector can read it and find out where the default connection is going; since each knows its own shared port ID, it's trivial to determine if it's the default collector.  (If this collector isn't using shared port, it won't have a shared port ID, so the comparison will fail.)\n\n<p></p><hr/>\n<em>2015-Aug-24 15:26:24 by adesmet:</em> <br/>\n\n<strong>CODE REVIEW</strong> Passed without changes.\n\n<p>As noted above, there are deeper questions, but this particular patch is the right solution for now.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5218\" onclick=\"get_ticket_and_populate_wrapper('5218'); return false;\" title=\"Collector self-identification too communal.\">#5218</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCollector self-identification too communal.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-24 15:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55bdd033c7c4fd4a3085fc9db8f5847be6d3c258\">[45660]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5185\" onclick=\"get_ticket_and_populate_wrapper('5185'); return false;\" title=\"Collector still tries to authenticate itself.\">#5185</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5218\" onclick=\"get_ticket_and_populate_wrapper('5218'); return false;\" title=\"Collector self-identification too communal.\">#5218</a></span>) Version history item.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-30 16:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d5b799fa1403a582802b6da232cc056e33ed023b\">[45444]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5185\" onclick=\"get_ticket_and_populate_wrapper('5185'); return false;\" title=\"Collector still tries to authenticate itself.\">#5185</a></span>) Fix a problem with the collector recognizing its own address when it's behind a shared port daemon.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Aug-24 15:38", "status": "resolved", "created": "2015-Jul-30 16:17", "fixed_version": "2015-Jul-30 16:17", "broken_version": "v080307", "priority": "4", "subsystem": "DaemonsCM", "assigned_to": "tlmiller", "derived_from": "#5128", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, bbockelm@cse.unl.edu", "due_date": ""}