{"id": 3379, "title": "Ticket #3379: Race condition in file stageout", "description": "<blockquote>\nIf we have a remote job with grid universe, there is a race condition in retrieving the sandbox.\n\n<p>I believe this is because the gridmanager or schedd marks the job as complete prior to doing the chown of the spool.  If the remote user attempts to read out from the spool during that time, it may get a permission denied.\n\n</p><p>This is a HTCondor-CE job: another possibility is the issue is in the sandbox management of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span>.\n\n</p><p>I'll attach the \"condor_transfer_data\" session at D_FULLDEBUG|D_SECURITY.  I can reliably reproduce this by using \"condor_submit -remote\" to the HTCondor-CE, query for job completion every second, and call condor_transfer_data immediately after the job hits state 4.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-14 14:33:51 by jfrey:</em> <br/>\n\nThe gridmanager sets the job's status to COMPLETED when the job is done and all output has been retrieved. The gridmanager then cleans up any job-related state on the remote server, and then calls DestroyProc(). The DestroyProc() triggers the chowning of the sandbox (it would also remove the job from the queue if <span class=\"quote\">LeaveJobInQueue</span> wasn't True).\n\n<p>Here are a few possible solutions:\n\n</p><p></p><ul>\n<li>Check for <span class=\"quote\">CompletionDate</span> in the job ad. This is set when DestroyProc() is called. Still leaves a (much smaller) race condition, as sandbox chowning can be delayed.\n</li><li>Allow gridmanager to trigger sandbox chowning when setting <span class=\"quote\">JobStatus</span> to COMPLETED. Still leaves a (much smaller) race condition, as sandbox chowning can be delayed.\n</li><li>Allow schedd to transfer output before sandbox is chowned.\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Nov-17 15:40:47 by blin:</em> <br/>\n\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=4719\" onclick=\"get_ticket_and_populate_wrapper('4719'); return false;\" title=\"JobRouter fails to write userlog due to bad permissions\">#4719</a></span> was marked as a duplicate of this ticket\n\n<p></p><hr/>\n<em>2014-Dec-10 11:00:04 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good; approved.\n\n</p><p>(Review note: since we can't know when the schedd will get around to actually chown()ing the directory, we have no choice but to poll for it; but it the schedd has already chown()ed the directory by the time we notice the state change, we won't poll twice.)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/662/condor_transfer_data_race\">condor_transfer_data_race</a>\n21478 bytes added by bbockelm on 2012-Dec-13 23:22:04 UTC.\n<br/>\ncondor_transfer_data output at high level of debug.\n\n<p><strong>NOTICE</strong> the misleading error message - complains about a failure to auth using FS.  It tried FS, failed, then succeeded with GSI; likely there's an error stack that someone failed to clear.<br/>\n</p></li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-09 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0482cb888d065c9d4779ce69b5c74211661dcbf6\">[41861]</a></span>: 8.2.6 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3379\" onclick=\"get_ticket_and_populate_wrapper('3379'); return false;\" title=\"Race condition in file stageout\">#3379</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-01 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/07370fff8c6e4221a3b97b940bc5f5a9bc47ee26\">[41788]</a></span>: Delay Condor-C output file transfer until <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFinishedHookDone\" title=\"Job Finished Hook Done\">JobFinishedHookDone</a></span> is set. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3379\" onclick=\"get_ticket_and_populate_wrapper('3379'); return false;\" title=\"Race condition in file stageout\">#3379</a></span> When the schedd does file transfers, it accesses the job sandbox as the condor user. Thus, the transfer of output files can fail if the sandbox is still owned by the user. To guarantee that the job files are owned by the condor\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Dec-10 11:20", "status": "resolved", "created": "2012-Dec-13 17:20", "fixed_version": "2012-Dec-13 17:20", "broken_version": "v080000", "priority": "2", "subsystem": "", "assigned_to": "jfrey", "derived_from": "#4555", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu blin@cs.wisc.edu, marian.zvada@cern.ch", "due_date": ""}