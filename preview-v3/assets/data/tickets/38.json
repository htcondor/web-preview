{"id": 38, "title": "Ticket #38: Unhelpful hold reason when periodic expression is UNDEFINED", "description": "<blockquote>\n(Copied from Drupal <span class=\"drupalnode\"><a href=\"http://drupal-old.batlab.cs.wisc.edu/node/1364\">1364 (backup)</a> <a href=\"http://nmi.cs.wisc.edu/node/1364\">1364 (public)</a></span>.)\n\n<p>If a job has a periodic expression, but it evaluates to UNDEFINED, the resulting job is put on hold. The hold reason is not helpful. The hold reason is\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">HoldReason = \"The UNKNOWN (never set) PeriodicRemove expression '' evaluated to UNDEFINED\"</pre></div>\n\n\n<p>This is particularly confusing, since it suggests that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRemove\" title=\"Periodic Remove\">PeriodicRemove</a></span> expression was never set, when indeed it was. It also has a blank where it looks like the expression should be placed.\n\n</p><p>The expected output might look something like:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">HoldReason = \"The PeriodicRemove expression 'DoesNotExist &gt; 0' evaluated to UNDEFINED\"</pre></div>\n\n\n<p>To reproduce, try this submit file on a reasonably supported Linux:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">universe=vanilla\nexecutable=/bin/date\nlog=eraseme.log\nperiodic_remove = DoesNotExist &gt; 0\nqueue</pre></div>\n\n\n<p>Wait a few moments and the job should go on hold. The hold reason will be visible via `condor_q -format '%s\\n' HoldReason` or in the eraseme.log userlog.</p></blockquote>", "remarks": "<blockquote>\nPut this into the master.\n\n<p></p><hr/>\n<em>2010-Jul-16 17:04:36 by mccardel:</em> <br/>\n\nThe problem was that the function <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AnalyzeSinglePeriodicPolicy\" title=\"Analyze Single Periodic Policy\">AnalyzeSinglePeriodicPolicy</a></span> in condor_c++_util/user_job_policy.cpp couldn't tell the difference between when an attribute was undefined and when something inside the expression was undefined. This function was called from AnalyzePolicy() in the same file, which in turn was called from PeriodicExprEval() in condor_schedd.v6/schedd.cpp.\n\n<p>The call to ASPP would generate a return value of UNDEFINED_EVAL, and this would propagate up to PeriodicExprEval(). Following this, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserPolicy\" title=\"User Policy\">UserPolicy</a></span> is checked again; this time to see what the firing reason was. Originally, FiringReason() would see that the variable m_firing_source hadn't been set yet, and would set part of the error string to be \"UNKNOWN (never set)\", because the type of thing that tripped the firing code was never set. It should've been set in ASPP, but that quit before it could set the firing source.\n\n</p><p>However, the code in ASPP now differentiates between when an attribute is undefined and when its expression is undefined. This was done by adding an if-block that looked up the attrname in the classad, and made sure it wasn't null. If it isn't null, then we know that we can set m_firing_source to be a job attribute and that the expression is undefined.\n\n</p><p>Thus, the error message is now the following:\n\n</p><p></p><pre>  The job attribute PeriodicRemove expression 'DoesNotExist &gt; 0' evaluated to UNDEFINED</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-19 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c814ca2381a07b7fe2324440dc2fc6debb1e7c23\">[18591]</a></span>: Added helpful hold reason for when periodic expr is undefined (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=38\" onclick=\"get_ticket_and_populate_wrapper('38'); return false;\" title=\"Unhelpful hold reason when periodic expression is UNDEFINED\">#38</a></span>)  (By Will <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=McCardell\" title=\"Mc Cardell\">McCardell</a></span> )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Jul-19 15:35", "status": "resolved", "created": "2009-Jan-16 13:40", "fixed_version": "2009-Jan-16 13:40", "broken_version": "v070000", "priority": "2", "subsystem": "Daemons", "assigned_to": "mccardel", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "psilord@cs.wisc.edu mccardel@cs.wisc.edu", "due_date": ""}