{"id": 4708, "title": "Ticket #4708: Busy loop in blocking SHARED_PORT_PASS_SOCK command", "description": "<blockquote>\nWhen USE_SHARED_PORT is enabled and one local daemon is directly connecting to another using <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortClient\" title=\"Shared Port Client\">SharedPortClient</a></span> and the SHARED_PORT_PASS_SOCK command in blocking mode, it busy-loops waiting for a reply. The log is filled with lines like this:\n<div class=\"verbatim\">\n<pre>11/06/14 15:35:11 (pid:5500) SharedPortCliient read would block; waiting for result for SHARED_PORT_PASS_FD to 5579_36b4 as requested by &lt;128.105.14.74:56662&gt;.\n</pre></div>\n\n\n<p>Usually, when the shared port daemon is handing off a connection to a daemon, it does so in non-blocking mode, which doesn't hit this behavior. But sometimes, blocking mode is used. Two specific examples are the shared port daemon connecting to the master to send a child alive, and one daemon connecting directly to another local daemon when it can't find the shared port daemon's contact information.\n\n</p><p>In SharedPortState::HandleResp(), if m_non_blocking is false, it should put the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> in blocking mode when reading from it.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jan-21 13:52:12 by jfrey:</em> <br/>\n\nThis bug doesn't cause any failures. In limited cases, a daemon will busy loop briefly while writing extra lines to its log. Not worth mentioning in the version history.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-06 16:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/39e077f1648e121f24195502e8d24f3c7642dd76\">[41609]</a></span>: Don't busy loop reading reply to SHARED_PORT_PASS_SOCK. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4708\" onclick=\"get_ticket_and_populate_wrapper('4708'); return false;\" title=\"Busy loop in blocking SHARED_PORT_PASS_SOCK command\">#4708</a></span> In SharedPortState::HandleResp(), put the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> into the same non-blocking mode that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortState\" title=\"Shared Port State\">SharedPortState</a></span> is in when reading the reply from the remote daemon. Otherwise, if we're in blocking mode, we'll busy loop waiting for the reply to show\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jan-21 13:52", "status": "resolved", "created": "2014-Nov-06 16:11", "fixed_version": "2014-Nov-06 16:11", "broken_version": "v080301", "priority": "3", "subsystem": "DaemonSharedP", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}