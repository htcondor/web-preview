{"id": 4783, "title": "Ticket #4783: Add stats for job reconnects after schedd restart", "description": "<blockquote>\nWe'd like to have statistics on how the schedd recovers from a restart, specifically how many jobs it's able to reconnect with.\n\n<p>The following schedd statistics will be added:\n</p><ul>\n<li><code>JobsRestartReconnectsFailed</code> (job count)\n</li><li><code>JobsRestartReconnectsLeaseExpired</code> (job count)\n</li><li><code>JobsRestartReconnectsSucceeded</code> (job count)\n</li><li><code>JobsRestartReconnectsAttempting</code> (job count)\n</li><li><code>JobsRestartReconnectsInterrupted</code> (job count)\n</li><li><code>JobsRestartReconnectsBadput</code> (accumulated time)\n</li></ul>\n\n<p>At startup, the schedd initializes <code>JobsRestartReconnectsAttempting</code> to the number of shadows it will start in reconnect mode, initializes <code>JobsRestartReconnectsLeaseExpired</code> to the number of jobs it won't create reconnect shadows for because the job lease has already expired, initializes <code>JobsRestartReconnectsBadput</code> to the current run time of jobs counted in <code>JobsRestartReconnectsLeaseExpired</code>, and initializes the other stats to zero.\n\n</p><p>The shadow_rec struct has a new bool member named reconnect_succeeded, which is initialized to false.\n\n</p><p>If the shadow is born with the -reconnect argument and exits because it cannot reconnect to the job (either because the lease expired or the startd/starter refused it), it should use the new exit code JOB_RECONNECT_FAILED instead of JOB_SHOULD_REQUEUE. Note that if the shadow successfully reconnects and then subsequently fails to reconnect if disconnected in the future, it should still exit with JOB_SHOULD_REQUEUE. When a shadow exits with the new shadow exit code JOB_RECONNECT_FAILED, the schedd decrements <code>JobsRestartReconnectsAttempting</code>, increments <code>JobsRestartReconnectsFailed</code>, and increases <code>JobsRestartReconnectsBadput</code> by the current run time of the job. For all other purposes, JOB_RECONNECT_FAILED should be treated like JOB_SHOULD_REQUEUE.\n\n</p><p>When a shadow updates the job attribute <code>NumJobReconnects</code> (and increases the value), if the shadow_rec has is_reconnect==true and reconnect_succeeded==false, the schedd decrements <code>JobsRestartReconnectsAttempting</code> and increments <code>JobsRestartReconnectsSucceeded</code> and sets reconnect_succeeded=true.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-16 16:30:45 by jfrey:</em> <br/>\n\nWork for this ticket should be placed in git branch <code>master-gt4783-schedd-reconnect-stats</code>.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5700\" onclick=\"get_ticket_and_populate_wrapper('5700'); return false;\" title=\"Don't send schedd restart report for new schedds.\">#5700</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDon't send schedd restart report for new schedds.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-14 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dcf4a39275243bbde9af46ce3fa428d7a2465772\">[44608]</a></span>: Docs for new schedd stats for restart reconnects. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-14 14:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b1aef563e5b413fc17be3331b626741ae70ac9b4\">[44607]</a></span>: Change <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobsRestartReconnectsUnknown\" title=\"Jobs Restart Reconnects Unknown\">JobsRestartReconnectsUnknown</a></span> to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobsRestartReconnectsInterrupted\" title=\"Jobs Restart Reconnects Interrupted\">JobsRestartReconnectsInterrupted</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span> This matches the new wording in the restart report and sounds less ominous to the admin.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-14 14:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/73a8ea8cd1bef0813d5c390ce013e1c836ba3038\">[44606]</a></span>: minor edits to doc for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-14 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b79cb9e1f5168c13b9b719bc7f24befceec8caa4\">[44598]</a></span>: Change a description in the schedd restart report. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-14 10:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/115daa72f976db0e9e6f110843dc4e6600f32a9e\">[44597]</a></span>: Docs for schedd restart report. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-19 09:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eca563468b15b52f08e515d17d6163b6763e5260\">[43410]</a></span>: Fix crash when recycling the shadow. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-12 16:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41939a55fe9fb57b68ddf400dd22f2dca49762c9\">[43349]</a></span>: Have the schedd generate a restart reconnect report. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span> The schedd can now write a report to disk summarizing the reconnect on restart statistics. The report file is updated every minute until all reconnect attempts are finished. At that point, the final report is emailed to the pool admin.\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-06 11:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6de28738e064b4c0f0cf380115a1f35cc7632611\">[43276]</a></span>: Track shadows that exit without reporting reconnect success/failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span> For the restart reconnect schedd statistics, a shadow can exit without indicating whether it succeeded in reconnecting to the starter. For this, hopefully rare, occasion, add a new stat: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobsRestartReconnectsUnknown\" title=\"Jobs Restart Reconnects Unknown\">JobsRestartReconnectsUnknown</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-12 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d9e9c8fa67ff084ec1cbd0984f7cc428a106f4a8\">[42176]</a></span>: Fix type of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobsRestartReconnectsBadput\" title=\"Jobs Restart Reconnects Badput\">JobsRestartReconnectsBadput</a></span> to match other runtime stats. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-12 14:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2ccf65d8f4578054d29356adf5ea9caf934f903e\">[42170]</a></span>: Minor fixups for schedd restart reconnect stats. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-18 15:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3e5a712a13a27dfd03ec6c41d80a1255c934f62f\">[41965]</a></span>: Schedd updates stats when shadow exits with JOB_RECONNECT_FAILED. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-18 11:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fb5d3a351c43ba8a99f656e91294d425b65ba991\">[41961]</a></span>: Shadow exit with JOB_RECONNECT_FAILED if initial reconnect fails. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span> If the shadow is started in reconnect mode, and that reconnect fails, exit with JOB_RECONNECT_FAILED so the schedd can keep restart stats. If the shadow is subsequently disconnected and fails to reconnect, then exit with JOB_SHOULD_REQUEUE\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-17 13:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b1dbdd463302b4433b0b9f5ca7e5ffebe38ef1f5\">[41952]</a></span>: Start recording job restart reconnect schedd stats. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span> Initialize the stats at startup time. Recognize when a shadow has successfully reconnected (via it changing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobReconnects\" title=\"Num Job Reconnects\">NumJobReconnects</a></span>) and update stats accordingly. This includes a new flag in the shadow_rec to not double-count a shadow that reconnects\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-16 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b6e4a5240a513afc5369ef6e188dfda2b66702b7\">[41942]</a></span>: Add schedd stats for job reconnects after a restart. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4783\" onclick=\"get_ticket_and_populate_wrapper('4783'); return false;\" title=\"Add stats for job reconnects after schedd restart\">#4783</a></span> Added new counters to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddStatistics\" title=\"Schedd Statistics\">ScheddStatistics</a></span>. No plumbing to update them yet.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Apr-14 14:35", "status": "resolved", "created": "2014-Dec-16 16:16", "fixed_version": "2014-Dec-16 16:16", "broken_version": "v080300", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "jfrey@cs.wisc.edu,tannenba@cs.wisc.edu", "due_date": ""}