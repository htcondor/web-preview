{"id": 735, "title": "Ticket #735: starter, shadow, and startd deadlock on job ad update --> hold", "description": "<blockquote>\nA 3-way deadlock is observed in the windows nightly job_core_perhold_van test.  I have seen it in the 7.2 branch, but I am fixing it in 7.4.\n\n<p>The problem is that the starter sends a job update to the shadow and then waits for a response.  The shadow evaluates job policy and wants to put the job on hold.  The shadow connects to the startd and tells it to deactivate the claim.  The startd tries to connect to the starter to send it a DC signal, but the starter is unresponsive, because it is waiting for the shadow.\n\n</p><p>The fix I am making is to simply do the job policy evaluation in a 0-second timer so we can send a response to the starter right away.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Sep-14 14:10:24 by danb:</em> <br/>\n\nThe 0-second timer approach caused job_core_perremove-van to fail, because periodic_remove did not fire at job removal time.  Therefore I am reverting that patch.  Anyway, a different instance of a similar deadlock was observed that was not addressed by this patch, so I have implemented a different approach.  The new approach is to have the startd reply to deactivate_claim immediately, rather than replying after signaling the starter.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-14 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ef14d641f5f802044d545435fa4b73b96e1a5eac\">[15687]</a></span>: Revert \"Fixed 3-way deadlock observed in windows job_core_perhold_van. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=735\" onclick=\"get_ticket_and_populate_wrapper('735'); return false;\" title=\"starter, shadow, and startd deadlock on job ad update --&gt; hold\">#735</a></span>\" This reverts commit 0c30d66a8c997a0bd39999c008082b1d556ac61d.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-14 10:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dfe2ea417b28c24e055e733446f136156c5d87a4\">[15685]</a></span>: Fixed 3-way deadlock during deactivate_claim. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=735\" onclick=\"get_ticket_and_populate_wrapper('735'); return false;\" title=\"starter, shadow, and startd deadlock on job ad update --&gt; hold\">#735</a></span> The previous fix only addressed one instance of this problem. A new instance was observed. In this case, the shadow once again was blocked waiting for response from deactivate_claim, and this caused the starter to block while trying to send update, which\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-11 17:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b07c28c481f14a41063ee9ae02e7c62969184ed4\">[24984]</a></span>: Documented fix for shadow-startd-starter deadlock. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=735\" onclick=\"get_ticket_and_populate_wrapper('735'); return false;\" title=\"starter, shadow, and startd deadlock on job ad update --&gt; hold\">#735</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-11 17:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c30d66a8c997a0bd39999c008082b1d556ac61d\">[15683]</a></span>: Fixed 3-way deadlock observed in windows job_core_perhold_van. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=735\" onclick=\"get_ticket_and_populate_wrapper('735'); return false;\" title=\"starter, shadow, and startd deadlock on job ad update --&gt; hold\">#735</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jun-14 09:50", "status": "resolved", "created": "2009-Sep-11 17:16", "fixed_version": "2009-Sep-11 17:16", "broken_version": "v070200", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}