{"id": 7767, "title": "Ticket #7767: condor_shadow activate/deactivates claim with wrong privilege", "description": "<blockquote>\n<a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/124\">PR#124</a>\n\n<p>Report from OSG is that, if all the schedd has token (say, in <code>/etc/condor/tokens.d/</code>) and the CCB is necessary to talk to the starter, then the <code>condor_shadow</code> will invoke the <code>activateClaim</code> RPC with <code>PRIV_USER</code>.\n\n</p><p>Unfortunately, since the token is owned by <code>PRIV_CONDOR</code>, doing a RPC which involves going to the CCB results in a permission denied.\n\n</p><p>We should ensure the shadow always does RPCs to the starter as <code>PRIV_CONDOR</code>.  So far, I've found <code>activateClaim</code> and <code>deactivateClaim</code>.  There might be others..</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Aug-05 02:54:19 by tlmiller:</em> <br/>\n\nAssigning to Zach, who volunteered to do the merge.\n\n<p></p><hr/>\n<em>2020-Aug-07 12:19:49 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: What's there looks good, and I merged it.\n\n<p></p><hr/>\n<em>2020-Aug-07 12:23:04 by zmiller:</em> <br/>\n\nAdditional thought:  Does this check for <code>isDaemon()</code> do the right thing inside DAGMan?  Internally, DAGMan is daemonCore and has type <code>SUBSYSTEM_CLASS_DAEMON</code>, but it acts as a client (on behalf of the user) when talking to the SchedD to do \"direct submit\" or to update job attributes.  So it should be using the user's tokens.  <code>set_priv(PRIV_CONDOR)</code> is essentially a noop inside dagman because there's no UID switching, so probably it's fine.\n\n<p></p><hr/>\n<em>2020-Sep-30 13:18:27 by zmiller:</em> <br/>\n\nThis was already reviewed and merged.  I'm going to add a note in version history and then resolve this ticket.  I still think we should consider having the cred files be owned by root (like all other authentication methods), and this has now been made into ticket <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7870\" onclick=\"get_ticket_and_populate_wrapper('7870'); return false;\" title=\"Read IDTOKENS files for daemons as root, not condor\">#7870</a></span></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7870\" onclick=\"get_ticket_and_populate_wrapper('7870'); return false;\" title=\"Read IDTOKENS files for daemons as root, not condor\">#7870</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRead IDTOKENS files for daemons as root, not condor</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Oct-01 10:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/52e7b98f40ab72168805dd3dd16dffd16b5e6070\">[61385]</a></span>: Version history for PRIV_CONDOR reading of daemon tokens. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7767\" onclick=\"get_ticket_and_populate_wrapper('7767'); return false;\" title=\"condor_shadow activate/deactivates claim with wrong privilege\">#7767</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-02 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/34504e1b97ef3493e6f91c7f37cdc071b1f32062\">[60407]</a></span>: Slight improvement of IDTOKENS logging messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7767\" onclick=\"get_ticket_and_populate_wrapper('7767'); return false;\" title=\"condor_shadow activate/deactivates claim with wrong privilege\">#7767</a></span> It's often difficult to figure out why IDTOKENS rejects a token in the user's directory. This adds some hints at `D_FULLDEBUG`.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-02 15:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8fb077639beab28811874d0c8f60cb7f27fbef7e\">[60406]</a></span>: Read the token file as condor. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7767\" onclick=\"get_ticket_and_populate_wrapper('7767'); return false;\" title=\"condor_shadow activate/deactivates claim with wrong privilege\">#7767</a></span> This causes the code to read the token file as condor unless: - We are impersonating another user, OR - We are not running as a daemon. This fixes the case where the `condor_shadow` needs to talk to the starter through the CCB but is running as PRIV_USER.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Oct-01 11:02", "status": "resolved", "created": "2020-Jul-29 22:55", "fixed_version": "2020-Jul-29 22:55", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "zmiller", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelman@morgridge.org, zmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}