{"id": 6049, "title": "Ticket #6049: Race condition at job exit causes errors in StarterLog", "description": "<blockquote>\nWhen a job exits normally, the starter first transfers the output sandbox back to the shadow (if needed), then sends a remote system call to the shadow to inform it the job is done and the exit code.  The starter then waits for the startd to kill it.  The shadow deactivates the claim on the startd, and either exits, or virtually exits, and grabs another job from the schedd. In either case, it closes the syscall socket.  When the startd gets the deactivate claim message from the shadow, it kills the starter.\n\n<p>However, the starter also tries to detect a disconnected shadow or broken network by listening on the syscall socket and putting it into daemon core's select loop.  If it goes hot, we assume the socket is closed, and go into disconnected mode.\n\n</p><p>The race condition is if the shadow exits (and closes the syscall socket) before the starter is killed, the starter will log a confusing warning, go into disconnected mode, before getting killed.\n\n</p><p>To fix this, we will unregister the syscall socket from select before we send the final exit rsc to the shadow.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-17 15:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05a407b69277c42ff4ed22f6ada706979627140c\">[49998]</a></span>: Docment <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6049\" onclick=\"get_ticket_and_populate_wrapper('6049'); return false;\" title=\"Race condition at job exit causes errors in StarterLog\">#6049</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-14 15:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd161208c66df8ce8d6b7d1bfe9acf72b56bf7cb\">[49808]</a></span>: Fix race condition in job exit <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6049\" onclick=\"get_ticket_and_populate_wrapper('6049'); return false;\" title=\"Race condition at job exit causes errors in StarterLog\">#6049</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-17 15:12", "status": "defer", "created": "2016-Dec-14 15:27", "fixed_version": "2016-Dec-14 15:27", "broken_version": "v080400", "priority": "5", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}