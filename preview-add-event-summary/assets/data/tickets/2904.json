{"id": 2904, "title": "Ticket #2904: privsep fails when sandbox contains permission issues", "description": "<blockquote>\nThis problem may affect earlier versions.  I have observed it with 7.7.5 in CHTC.\n\n<p>Jobs go on hold with the following reason:\n\n</p><p></p><div class=\"verbatim\">\n<pre>HoldReason = \"Error from slot1@e076.chtc.wisc.edu: error changing sandbox ownership to condor\"\n</pre></div>\n\n\n<p>In the starter log, I see the following:\n\n</p><p></p><div class=\"verbatim\">\n<pre>...\n03/26/12 00:46:26 Can't open directory \"/var/lib/condor/execute/slot1/dir_3379/cms_OUSkLguW3587\" as PRIV_CONDOR, errno: 13 (Permission denied)\n03/26/12 00:46:26 Can't open directory \"/var/lib/condor/execute/slot1/dir_3379/cms_OUSkLguW3587\" as PRIV_CONDOR, errno: 13 (Permission denied)\n03/26/12 00:48:41 Process exited, pid=3401, status=147\n03/26/12 00:48:41 privsep_get_switchboard_response: error received: error in recursive chown of directory\n03/26/12 00:48:41 ERROR \"failed to chown sandbox to condor after job completed\" at line 2368 in file /home/condor/execute/dir_4305/userdir/src/condor_starter.V6.1/baseStarter.cpp\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Nov-07 11:52:58 by danb:</em> <br/>\n\nThis problem is alive and well in Condor 7.9.1.\n\n<p>I found that the following cases can cause the privsep chown operation to fail:\n\n</p><p>file2 is a hard or symbolic link to file1 and permissions on file1 do not allow reading by anyone but the owner.  The problem is that file1 gets chowned and then the switchboard fails to verify that file2 is a symlink or is already chowned, because it first tries to open the file as the source user, which is no longer allowed.\n\n</p><p>Another case that fails is if there is a directory in the sandbox that does not have execute permission for the owner of the directory.\n\n</p><p></p><hr/>\n<em>2012-Nov-08 17:10:10 by danb:</em> <br/>\n\nI pushed a patch for the problems with links.  That's the case that affected our users.  The other case (a directory without the execute bit set) is tricky.  For now, I think we should consider this expected behavior: jobs that produce such sandboxes will go on hold.\n\n<p></p><hr/>\n<em>2012-Dec-17 12:45:49 by zmiller:</em> <br/>\n\nagreed w/ dan.  if job creates directories that are not owner-traversible, the job will go on hold.  we could modify the switchboard if we think this is a problem in reality.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-08 16:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5edf43586b34aa88e6dc104e9b45a1e22f06fca8\">[34060]</a></span>: Fixed privsep sandbox chown errors when there are links to private files. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2904\" onclick=\"get_ticket_and_populate_wrapper('2904'); return false;\" title=\"privsep fails when sandbox contains permission issues\">#2904</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Dec-17 12:46", "status": "resolved", "created": "2012-Mar-26 11:21", "fixed_version": "2012-Mar-26 11:21", "broken_version": "v070705", "priority": "4", "subsystem": "", "assigned_to": "zmiller", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu", "due_date": ""}