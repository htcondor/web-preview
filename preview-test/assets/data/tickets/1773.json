{"id": 1773, "title": "Ticket #1773: condor_q is significantly slower due to new classads", "description": "<blockquote>\nWhen running condor_q against a queue of 100k jobs, I found that 7.5 after the introduction of new classads takes 4 times as long to complete as before new classads.\n\n<p>The main reasons for the slowdown that I have found are:\n\n</p><p></p><ol>\n<li>linear searches in <code>ClassAdList</code>\n\n<p></p></li><li>creating an intermediate copy of the classad in <code>compat_classad::ClassAd::initFromStream</code>\n\n<p></p></li><li>expensive <code>ClassAd</code> instantiation due to initialization of expr and name iterators that may not even be used\n\n<p></p></li><li>on the schedd side, putOldClassAd() is slow because iterating through a hash_map appears to be fairly expensive\n\n<p></p></li><li>on the schedd side, when applying a projection of which attributes to send, it constructs a temporary ad; deletion of this ad is fairly expensive, again due to iteration through the hash_map\n</li></ol>\n\n<p>The patches that I have committed to address the above problems make condor_q on 100k jobs perform at the same speed as the same test in 7.4.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Dec-12 16:07:21 by danb:</em> <br/>\n\nMy optimizations to <code>ClassAdList</code> made it incompatible with shallow copying as done by qsort of arrays in the negotiator containing <code>ClassAdList</code>.  This has been fixed.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-12 15:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b84606c73a0d5c812e49eed7decbb9e0f27406e9\">[19637]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdList\" title=\"Class Ad List\">ClassAdList</a></span> was incompatible with qsort(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span> My recent optimizations to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdList\" title=\"Class Ad List\">ClassAdList</a></span> made it incompatible with being shallow copied, as done by qsort() in the negotiator.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-09 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a2259bcafbf835cfb6f93d1f555c139136bfbb2e\">[19612]</a></span>: Fix a pointer bug in my previous commit to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdList\" title=\"Class Ad List\">ClassAdList</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-01 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55dd8ffa65f0e285ab954a2ffc5d39590fbd1815\">[19505]</a></span>: Revert \"Revert \"Avoid linear searches in compat_classad::ClassAdList. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span>\"\" This reverts commit df864428457342783c855db06e899789b3822741.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-01 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eba97564daae043812386b17a4f9d2365ed76ea6\">[19506]</a></span>: Fix my previous commit which broke sorting of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdList\" title=\"Class Ad List\">ClassAdList</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-29 17:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/df864428457342783c855db06e899789b3822741\">[19498]</a></span>: Revert \"Avoid linear searches in compat_classad::ClassAdList. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span>\" This reverts commit 0b8203df18f16d47d87494ea3049f4e8870554c6.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-17 21:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5316e9303706e3c74da27966208eb0968c398dff\">[19445]</a></span>: Make collector use more efficient method of sending a \"projected\" ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span> This is the same optimization that was applied to the schedd for condor_q. Instead of constructing an intermediate ad, just pass the list of attributes as a whitelist to putOldClassAd().  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-17 21:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/661ebedf289ad54a730cf36820f2ef40f0537d7b\">[19444]</a></span>: Optimized compat_classad::ClassAd::put(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-16 18:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/951e1a30655ecea5aaeaa58b9df63b65750e0aaf\">[25764]</a></span>: Documented performance fixes for condor_q. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-16 18:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0e849bc6c094da23c26bac2e156baa1217b25a29\">[19410]</a></span>: Optimized initialization of classad_compat::ClassAd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span> Instantiating iterators for iterating over attribute names and expressions turns out to be fairly expensive, so now this is only done when needed.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-16 18:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1f087210be7107469f60520a15d904caeb994066\">[19409]</a></span>: Optimized compat_classad::ClassAd::initFromStream(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span> Avoid creating a temporary copy of the classad and avoid creating two of the intermediate copies of the classad expression strings.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-16 18:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0b8203df18f16d47d87494ea3049f4e8870554c6\">[19408]</a></span>: Avoid linear searches in compat_classad::ClassAdList. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1773\" onclick=\"get_ticket_and_populate_wrapper('1773'); return false;\" title=\"condor_q is significantly slower due to new classads\">#1773</a></span> This speeds up condor_q and likely a few other things when dealing with large lists of ads.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Dec-12 16:07", "status": "resolved", "created": "2010-Nov-16 17:58", "fixed_version": "2010-Nov-16 17:58", "broken_version": "v070502", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "#990", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}