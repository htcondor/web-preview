{"id": 7247, "title": "Ticket #7247: Docker jobs can't be gracefully terminated", "description": "<blockquote>\nWhen HTCondor kills Docker jobs, unlike other vanilla universe jobs, it always uses a hardkill.  This is problematic for people (SWAMP) whose Docker jobs need time to shut down cleanly in order to be useful.</blockquote>", "remarks": "<blockquote>\n<em>2019-Sep-12 16:43:29 by tannenba:</em> <br/>\n\nSo with this patch, will the following job work as expected?\n\n<p>If my quoting foo is still good :), the below job will hang out until it gets a SIGTERM, at which point it will say\nso to stdout, and then exit 10 seconds later.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">universe = docker\ndocker_image = centos\nexecutable = /bin/bash\narguments = -c '(trap \"(printf \\\"Got TERM at \\\"; date; sleep 10)\" SIGTERM; trap \"(echo -n \\\"EXITING at \\\"; date)\" EXIT; sleep 50000)'\nwant_graceful_removal = true\n\n# Upon removing this job, test1.out should have both 'Got TERM at' and 'Exiting at'\noutput = test1.out\njob_max_vacate_time = 20\nqueue\n\n# Upon removing this job, test2.out should only have 'Got TERM at' because\n# it should be hard-killed before it can print it exits.\noutput = test2.out\njob_max_vacate_time = 5\nqueue\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Sep-12 23:04:59 by tlmiller:</em> <br/>\n\nWhat I (manually) tested was basically exactly the same as your question, and it does work (where <code>docker/out</code> shows the SIGTERM being received and the job either proceeding to finish or stopping after 10 seconds, depending on whether <code>job_max_vacate_time</code> was set.\n\n<p></p><div class=\"file\">\n<pre class=\"filelabel\">docker.submit</pre>\n<pre class=\"file\">output                  = docker/out\nerror                   = docker/error\nlog                     = docker/log\n\ndocker_image            = debian\nexecutable              = docker.sh\narguments               = 60\nuniverse                = docker\nshould_transfer_files   = YES\n\nstream_output           = TRUE\nstream_error            = TRUE\n\n# Tested with and without this line.\njob_max_vacate_time     = 10\n\nqueue 1\n</pre></div>\n\n\n<p></p><div class=\"file\">\n<pre class=\"filelabel\">docker.sh</pre>\n<pre class=\"file\">#!/bin/bash\n\ntrap handleTerm SIGTERM\n\nfunction handleTerm {\n    echo \"Caught SIGTERM, ignoring...\"\n}\n\ni=0\nwhile [ $i -lt $1 ]; do echo $i; i=$((i+1)); sleep 1; done\nexit 0\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Oct-04 10:38:16 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-11 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/713945487e73dd4c38206fe0451d2031e9c1a196\">[58138]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7247\" onclick=\"get_ticket_and_populate_wrapper('7247'); return false;\" title=\"Docker jobs can't be gracefully terminated\">#7247</a></span>) Release note. Committer: Tim Theisen  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-08 13:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8175474c50ba9df5b09a585bfdae5750e78258ad\">[58052]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7247\" onclick=\"get_ticket_and_populate_wrapper('7247'); return false;\" title=\"Docker jobs can't be gracefully terminated\">#7247</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-12 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0537c6662d4a1518b395b3163bb5d3b661371aa8\">[57825]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7247\" onclick=\"get_ticket_and_populate_wrapper('7247'); return false;\" title=\"Docker jobs can't be gracefully terminated\">#7247</a></span>) Extend DockerAPI::kill() to allow specification of the signal. Update <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DockerProc\" title=\"Docker Proc\">DockerProc</a></span> to send the appropriate signals.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Oct-08 13:15", "status": "resolved", "created": "2019-Sep-09 10:47", "fixed_version": "2019-Sep-09 10:47", "broken_version": "", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}