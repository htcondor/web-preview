{"id": 1392, "title": "Ticket #1392: condor_vacate_job is non-functional if the job catches/ignores sig 15", "description": "<blockquote>\ncondor_vacate_job issues a soft kill sig 15. If the job ignores this signal, it will not vacate. One will also be unable to issue a condor_rm on the job due to the state of the claim.</blockquote>", "remarks": "<blockquote>\n<em>2010-May-05 09:49:10 by jrt:</em> <br/>\n\nThe following patch fixes the problem:\n\n<p></p><div class=\"verbatim\">\n<pre>diff -rNup condor-7.4.1.orig/src/condor_starter.V6.1/vanilla_proc.cpp condor-7.4.1/src/condor_starter.V6.1/vanilla_proc.cpp\n--- condor-7.4.1.orig/src/condor_starter.V6.1/vanilla_proc.cpp\t2010-03-25 13:49:30.000000000 -0400\n+++ condor-7.4.1/src/condor_starter.V6.1/vanilla_proc.cpp\t2010-05-05 09:03:41.000000000 -0400\n@@ -337,7 +337,10 @@ VanillaProc::ShutdownGraceful()\n \t// now softkill the parent job process.  this is exactly what\n \t// OsProc::ShutdownGraceful does, so call it.\n \t//\n-\treturn OsProc::ShutdownGraceful();\n+\t//OsProc::ShutdownGraceful() always returns false\n+\tOsProc::ShutdownGraceful();\n+\tstartEscalationTimer();\n+\treturn false;\n }\n\n bool\n\n</pre></div>\n\nPatch seems to test good.\n\n<p>In a job that catches and ignores sig 15, timer fires and KILLs the job.\n\n</p><p>In a job that catches and exits on 15, the job exits and VanillaProc::JobReaper\ncancels the timer.\n\n</p><p>In a job that doesn't catch the signal, the job exits on the signal and\nVanillaProc::JobReaper cancels the timer.\n\n</p><p>In all three cases, the job is restarted as one expects with a vacate.\n</p><hr/>\n<em>2010-Aug-23 17:42:37 by adesmet:</em> <br/>\n\nBulk change of target version from v070403 to v070404 using ./ticket_target_mover.\n<hr/>\n<em>2010-Oct-27 16:39:01 by adesmet:</em> <br/>\n\nBulk change of target version from v070404 to v070405 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2010-Dec-17 08:47:23 by matt:</em> <br/>\n\n<div class=\"verbatim\">\n<pre>$ condor_version\n$CondorVersion: 7.4.5 Dec 16 2010 PRE-RELEASE $\n$CondorPlatform: X86_64-LINUX_F13 $\n\n$ cat ignore_sig_15.c\n#include &lt;signal.h&gt;\n#include &lt;unistd.h&gt;\nint\nmain(int argc, char **argv)\n{\n\tsigignore(15);\n\tsleep(900);\n\treturn 0;\n}\n\n$ echo 'cmd=ignore_sig_15\\nlog=/tmp/ignore.log\\nqueue' | condor_submit\n\n$ condor_q\n-- Submitter: matt@eeyore.local : &lt;192.168.1.100:34199&gt; : eeyore.local\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  92.0   matt           12/17 09:32   0+00:00:43 R  0   0.0  ignore_sig_15\n1 jobs; 0 idle, 1 running, 0 held\n\n$ pstree -p | grep condor_\n        |-condor_master(26724)-+-condor_collecto(26725)\n        |                      |-condor_negotiat(26727)\n        |                      |-condor_schedd(26728)-+-condor_procd(26731)\n        |                      |                      `-condor_shadow(27228)\n        |                      `-condor_startd(26729)-+-condor_procd(26786)\n        |                                             `-condor_starter(27230)---ignore_sig_15(27232)\n\n$ condor_vacate_job 92\nCluster 92 vacated.\n\n$ condor_status\nName               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime\nslot1@eeyore.local LINUX      X86_64 Unclaimed Idle     0.000   940  0+00:00:04\nslot2@eeyore.local LINUX      X86_64 Claimed   Busy     0.000   940  0+00:00:05\nslot3@eeyore.local LINUX      X86_64 Unclaimed Idle     0.000   940  0+00:10:06\nslot4@eeyore.local LINUX      X86_64 Unclaimed Idle     0.000   940  0+00:10:07\n                     Machines Owner Claimed Unclaimed Matched Preempting\n        X86_64/LINUX        4     0       1         3       0          0\n               Total        4     0       1         3       0          0\n\n(vacate+1min) $ condor_q\n-- Submitter: matt@eeyore.local : &lt;192.168.1.100:34199&gt; : eeyore.local\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  92.0   matt           12/17 09:32   0+00:01:56 R  0   0.0  ignore_sig_15\n1 jobs; 0 idle, 1 running, 0 held\n\n$ condor_rm 92\nCluster 92 has been marked for removal.\n\n$ tail log/StarterLog.slot2\n12/17/10 09:32:51 Create_Process succeeded, pid=27232\n12/17/10 09:33:46 Got SIGTERM. Performing graceful shutdown.\n12/17/10 09:33:46 ShutdownGraceful all jobs.\n\n(rm+3min) $ condor_q\n-- Submitter: matt@eeyore.local : &lt;192.168.1.100:34199&gt; : eeyore.local\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  92.0   matt           12/17 09:32   0+00:00:00 X  0   0.0  ignore_sig_15\n0 jobs; 0 idle, 0 running, 0 held\n\n$ pstree -p | grep condor_\n        |-condor_master(26724)-+-condor_collecto(26725)\n        |                      |-condor_negotiat(26727)\n        |                      |-condor_schedd(26728)-+-condor_procd(26731)\n        |                      |                      `-condor_shadow(27228)\n        |                      `-condor_startd(26729)-+-condor_procd(26786)\n        |                                             `-condor_starter(27230)---ignore_sig_15(27232)\n\n$ kill -1 27232\n\n$ pstree -p | grep condor_\n        |-condor_master(26724)-+-condor_collecto(26725)\n        |                      |-condor_negotiat(26727)\n        |                      |-condor_schedd(26728)---condor_procd(26731)\n        |                      `-condor_startd(26729)---condor_procd(26786)\n\n$ condor_q\n-- Submitter: matt@eeyore.local : &lt;192.168.1.100:34199&gt; : eeyore.local\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n0 jobs; 0 idle, 0 running, 0 held\n\n$ tail log/StarterLog.slot2\n12/17/10 09:33:46 Got SIGTERM. Performing graceful shutdown.\n12/17/10 09:33:46 ShutdownGraceful all jobs.\n12/17/10 09:40:42 Process exited, pid=27232, signal=1\n12/17/10 09:40:42 Last process exited, now Starter is exiting\n12/17/10 09:40:42 **** condor_starter (condor_STARTER) pid 27230 EXITING WITH STATUS 0\n\n$ tail log/StartLog\n12/17/10 09:32:51 slot2: Remote job ID is 92.0\n12/17/10 09:32:51 slot2: Got universe \"VANILLA\" (5) from request classad\n12/17/10 09:32:51 slot2: State change: claim-activation protocol successful\n12/17/10 09:32:51 slot2: Changing activity: Idle -&gt; Busy\n12/17/10 09:33:46 slot2: Called deactivate_claim()\n12/17/10 09:40:42 slot2: Called deactivate_claim_forcibly()\n12/17/10 09:40:42 Starter pid 27230 exited with status 0\n12/17/10 09:40:42 slot2: State change: starter exited\n12/17/10 09:40:42 slot2: Changing activity: Busy -&gt; Idle\n12/17/10 09:40:42 slot2: State change: received RELEASE_CLAIM command\n12/17/10 09:40:42 slot2: Changing state and activity: Claimed/Idle -&gt; Preempting/Vacating\n12/17/10 09:40:42 slot2: State change: No preempting claim, returning to owner\n12/17/10 09:40:42 slot2: Changing state and activity: Preempting/Vacating -&gt; Owner/Idle\n12/17/10 09:40:42 slot2: State change: IS_OWNER is false\n12/17/10 09:40:42 slot2: Changing state: Owner -&gt; Unclaimed\n\nvacate was at 9:33:41am, rm at 9:34:47am\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Dec-17 09:01:20 by matt:</em> <br/>\n\nWith patch...\n\n<p></p><div class=\"verbatim\">\n<pre>$ echo 'cmd=ignore_sig_15\\nlog=/tmp/ignore2.log\\nqueue' | condor_submit\nSubmitting job(s).\nLogging submit event(s).\n1 job(s) submitted to cluster 93.\n\n$ condor_q\n-- Submitter: matt@eeyore.local : &lt;192.168.1.100:54846&gt; : eeyore.local\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  93.0   matt           12/17 09:53   0+00:01:06 R  0   0.0  ignore_sig_15\n1 jobs; 0 idle, 1 running, 0 held\n\n$ pstree -p | grep condor_\n        |-condor_master(6770)-+-condor_collecto(6771)\n        |                     |-condor_negotiat(6773)\n        |                     |-condor_schedd(6774)-+-condor_procd(6776)\n        |                     |                     `-condor_shadow(6816)\n        |                     `-condor_startd(6775)-+-condor_procd(6817)\n        |                                           `-condor_starter(6818)---ignore_sig_15(6819)\n\n$ tail log/StarterLog.slot1\n12/17/10 09:53:44 Create_Process succeeded, pid=6819\n\n$ condor_vacate_job 93\nCluster 93 vacated.\n\n$ tail log/StarterLog.slot1\n12/17/10 09:53:44 Create_Process succeeded, pid=6819\n12/17/10 09:55:02 Got SIGTERM. Performing graceful shutdown.\n12/17/10 09:55:02 ShutdownGraceful all jobs.\n\n$ pstree -p | grep condor_\n        |-condor_master(6770)-+-condor_collecto(6771)\n        |                     |-condor_negotiat(6773)\n        |                     |-condor_schedd(6774)-+-condor_procd(6776)\n        |                     |                     `-condor_shadow(6816)\n        |                     `-condor_startd(6775)-+-condor_procd(6817)\n        |                                           `-condor_starter(6818)---ignore_sig_15(6819)\n\n(vacate+35sec) $ pstree -p | grep condor_\n        |-condor_master(6770)-+-condor_collecto(6771)\n        |                     |-condor_negotiat(6773)\n        |                     |-condor_schedd(6774)---condor_procd(6776)\n        |                     `-condor_startd(6775)---condor_procd(6817)\n\n$ condor_q\n-- Submitter: matt@eeyore.local : &lt;192.168.1.100:54846&gt; : eeyore.local\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  93.0   matt           12/17 09:53   0+00:01:48 I  0   3.9  ignore_sig_15\n1 jobs; 1 idle, 0 running, 0 held\n\n$ tail log/StarterLog.slot1\n12/17/10 09:53:44 Create_Process succeeded, pid=6819\n12/17/10 09:55:02 Got SIGTERM. Performing graceful shutdown.\n12/17/10 09:55:02 ShutdownGraceful all jobs.\n12/17/10 09:55:32 Process exited, pid=6819, signal=9\n12/17/10 09:55:32 Last process exited, now Starter is exiting\n12/17/10 09:55:32 **** condor_starter (condor_STARTER) pid 6818 EXITING WITH STATUS 0\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Dec-17 09:10:36 by matt:</em> <br/>\n\nCommitted. Thank you.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-11 16:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1dcd4d32be59295a092d4d041e5efa940b6a24f3\">[21841]</a></span>: Re-added fix from <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1392\" onclick=\"get_ticket_and_populate_wrapper('1392'); return false;\" title=\"condor_vacate_job is non-functional if the job catches/ignores sig 15\">#1392</a></span>, but made it smarter. The startd will signal the starter when it initiates a peaceful shutdown due to a state change. If the starter is told to exit because of a state change, it will not elevate signals and kill the job on a peaceful shutdown. In this case, it will be the responsibility\u00a0[...]\n (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-20 09:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/28807d34030e7eaedbd5fe57528f821a7c02f996\">[19714]</a></span>: startEscalationTimer is not available on WIN32, means <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1392\" onclick=\"get_ticket_and_populate_wrapper('1392'); return false;\" title=\"condor_vacate_job is non-functional if the job catches/ignores sig 15\">#1392</a></span> is still open for WIN32  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-18 10:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b66459f0ec7fccd0226ddeeada16ea6115e8101\">[19707]</a></span>: Revert \"startEscalationTimer is only in 7.5, 7.4 will have to live without this fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1392\" onclick=\"get_ticket_and_populate_wrapper('1392'); return false;\" title=\"condor_vacate_job is non-functional if the job catches/ignores sig 15\">#1392</a></span>\" This reverts commit 61c13d5a3842ad7fdb45b4c398a3d2bc989af6fb.  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-17 09:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e137159138e193095df6525ab6c5fb23ae833c95\">[19689]</a></span>: condor_vacate_job of a job that ignores SIGTERM (15) results in a job that is not vacated and cannot be removed until it completes, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1392\" onclick=\"get_ticket_and_populate_wrapper('1392'); return false;\" title=\"condor_vacate_job is non-functional if the job catches/ignores sig 15\">#1392</a></span> Committer: Matthew Farrellee  (By Jon Thomas )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Dec-18 10:01", "status": "resolved", "created": "2010-May-05 09:47", "fixed_version": "2010-May-05 09:47", "broken_version": "v070400", "priority": "3", "subsystem": "Tools", "assigned_to": "jrt", "derived_from": "", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, rrati@redhat.com", "due_date": ""}