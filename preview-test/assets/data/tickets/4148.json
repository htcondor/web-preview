{"id": 4148, "title": "Ticket #4148: Pass non-fungible slot resource IDs to the job via environment", "description": "<blockquote>\nUser-defined slot resources that have resource IDs, (i.e. are non-fungible) must be published to the Starter and/or job in order to be useful. See <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4141\" onclick=\"get_ticket_and_populate_wrapper('4141'); return false;\" title=\"Add support for non-fungible user-defined slot resources\">#4141</a></span>\n\n<p>There should be a way for the configurator to define what environment variable to publish a given resource id into.\n\n</p><p>To take the particular case of GPU resources, the config\n\n</p><p></p><pre>    # add this to your config file to define 4 non-fungible GPU resources\n    MACHINE_RESOURCE_GPUs = CUDA0,CUDA1,CUDA2,CUDA3\n</pre>\n\n<p>Will result in slots being assigned GPUs resources, the specific IDs of which are published in the slot ad in the <code>AssignedGPUs</code> attribute.  This will be a comma separated list, so a slot that is assigned 2 GPUs might have this attribute in it's machine ad.\n\n</p><p></p><pre>    AssignedGPUs = \"CUDA0,CUDA1\"\n</pre>\n\n<p>When a job lands on this slot, the assigned GPUs will be propagated into the job's environment as:\n\n</p><p></p><pre>    _CONDOR_AssignedGPUs=CUDA0,CUDA1\n</pre>\n\n<p>But in order to work the NVIDIA's CUDA api,  it also need to be published to the job's environment as <code>CUDA_VISIBLE_DEVICES</code> environment variable, with everything but the device numbers removed like this (see <span class=\"ticket\"><a class=\"stalled\" href=\"/wiki-archive/tickets/?ticket=2011\" onclick=\"get_ticket_and_populate_wrapper('2011'); return false;\" title=\"Investigate Condor / GPU integration for LIGO\">#2011</a></span>)\n\n</p><p></p><pre>    _CONDOR_AssignedGPUs=CUDA0,CUDA1\n    CUDA_VISIBLE_DEVICES=0,1\n</pre>\n\n<p>To get this behavior, you can add the optional configuration to specify an additional environment variable for assigned resources. HTCondor recognizes\nCUDA_VISIBLE_DEVICES and the OpenCL equivalent GPU_DEVICE_ORDINAL and will\nstrip all but [0-9,] from AssignedGPU before assigning it to one of these\n\n</p><p></p><pre>    # this config produces the above environment\n    MACHINE_RESOURCE_GPUs = CUDA0,CUDA1,CUDA2,CUDA3\n    ENVIRONMENT_FOR_AssignedGPUs = CUDA_VISIBLE_DEVICES\n</pre>\n\n<p></p><pre>    # this config is equivalent, but makes the transformation of IDs explicit\n    MACHINE_RESOURCE_GPUs = CUDA0,CUDA1,CUDA2,CUDA3\n    ENVIRONMENT_FOR_AssignedGPUs = CUDA_VISIBLE_DEVICES=/[ a-zA-Z]+//\n</pre>\n\n<p>This is generalized so that for this configuration\n\n</p><p></p><pre>    # config a tag resource\n    MACHINE_RESOURCE_Tag = VINI, VICI, VIDI\n    ENVIRONMENT_FOR_AssignedTag = WHAT_I_DID=/$/I_/\n    NUM_SLOTS_TYPE_1 = 1\n    SLOT_TYPE_1_PARTITIONABLE = true\n    SLOT_TYPE_1 = Cpus=100%, Disk=90%, Memory=90%, Tag=100%\n</pre>\n\n<p>A job that requests a Tag resource like this\n\n</p><p></p><pre>    # this is in the jobs submit file\n    request_tag = 1\n</pre>\n\n<p>Then the dynamic slot that is used to satisfy the job request will have these attributes\n\n</p><p></p><pre>    TotalTag = 3\n    DetectedTag = 3\n    TotalSlotTag = 1\n    Tag = 1\n    AssignedTag = \"VINI\"\n</pre>\n\n<p>And when the job starts on that slot, the job's environment will contain.\n\n</p><p></p><pre>    _CONDOR_AssignedTag=VINI\n    WHAT_I_DID=I_VINI</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Jan-24 10:08:49 by johnkn:</em> <br/>\n\n<code>ENVIRONMENT_FOR_AssignedTag</code> needs way to indicate string substitution operations on the right hand side, something like\n\n<p></p><pre>    ENVIRONMENT_FOR_AssignedGPUs = CUDA_VISIBLE_DEVICES=/CUDA//\n</pre>\n\n<p>which would indicate that CUDA should be removed from the device ID before assigning it to the <code>CUDA_VISIBLE_DEVICES</code> environment variable.\n\n</p><p>If the slot has\n\n</p><p></p><pre>    AssignedGPUs = \"CUDA2,CUDA3\"\n</pre>\n\n<p>Then the job environment will have\n\n</p><p></p><pre>    _CONDOR_AssignedGPUs=CUDA1,CUDA2\n    CUDA_VISIBLE_DEVICES=1,2\n</pre>\n\n<p></p><hr/>\n<em>2014-Jan-30 10:19:10 by johnkn:</em> <br/>\n\n<span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb6e2fd84dc59a9b2bad4435d4963cbd25077042\">[39261]</a></span> added a new config knob for each non-fungible user defined resource FOO\nthere is a config koob <code>ENVIRONMENT_FOR_AssignedFOO</code> which can contain a set of environment variables and associated perl style regex replacement rule for converting assigned FOO ids when setting that environment variable.\n\n<p>If there is a user defined resource\n\n</p><p></p><pre>   # configuration\n   MACHINE_RESOURCE_FOO = \"IDA,IDB,IDC\"\n   ENVIRONMENT_FOR_AssignedFOO = MYFOO=/ID([A-Z])/\"$1\"/  FOO2=/ID// FOO3\n</pre>\n\n<p>Then when a slot gets assigned a Foo, the machine ad will have\n\n</p><p></p><pre>   # machine/slot ad\n   FOO = 2\n   AssignedFOO = \"IDA,IDB\"\n</pre>\n\n<p>And the job environment will have\n\n</p><p></p><pre>   _CONDOR_AssignedFOO=IDA,IDB\n   MYFOO=\"A\",\"B\"\n   FOO2=A,B\n   FOO3=IDA,IDB</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-19 14:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1f542d18ed3bfd5403dcfdb9a0afe1b36fa33dc\">[39465]</a></span>: edit 8.1.4 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4148\" onclick=\"get_ticket_and_populate_wrapper('4148'); return false;\" title=\"Pass non-fungible slot resource IDs to the job via environment\">#4148</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-30 11:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6f16f7db6917466805e1ca159e893575f9226706\">[39264]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4141\" onclick=\"get_ticket_and_populate_wrapper('4141'); return false;\" title=\"Add support for non-fungible user-defined slot resources\">#4141</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4148\" onclick=\"get_ticket_and_populate_wrapper('4148'); return false;\" title=\"Pass non-fungible slot resource IDs to the job via environment\">#4148</a></span> (children of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3386\" onclick=\"get_ticket_and_populate_wrapper('3386'); return false;\" title=\"RFE: GPU discovery and ClassAd Update\">#3386</a></span>)  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-30 10:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb6e2fd84dc59a9b2bad4435d4963cbd25077042\">[39261]</a></span>: add regex style string replacement for device ids for user defined resources <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4148\" onclick=\"get_ticket_and_populate_wrapper('4148'); return false;\" title=\"Pass non-fungible slot resource IDs to the job via environment\">#4148</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-10 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/338039c037f573af7df432096d31e951cc571844\">[39135]</a></span>: Publish AssignedGPU slot attribute into jobs environment. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4148\" onclick=\"get_ticket_and_populate_wrapper('4148'); return false;\" title=\"Pass non-fungible slot resource IDs to the job via environment\">#4148</a></span> This is generalized for so that any resource in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MachineResources\" title=\"Machine Resources\">MachineResources</a></span> attribute that has an Assigned&lt;Res&gt; attribute will be published into the jobs environment as _CONDOR_Assigned&lt;Res&gt;. Part of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3386\" onclick=\"get_ticket_and_populate_wrapper('3386'); return false;\" title=\"RFE: GPU discovery and ClassAd Update\">#3386</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Feb-27 15:27", "status": "resolved", "created": "2014-Jan-07 12:39", "fixed_version": "2014-Jan-07 12:39", "broken_version": "v080100", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "#3386", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu", "due_date": ""}