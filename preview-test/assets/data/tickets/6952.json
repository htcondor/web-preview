{"id": 6952, "title": "Ticket #6952: shared port + procd on Windows causes the master to fail to restart", "description": "<blockquote>\nOn windows the service definition points to condor_master.exe\nHowever, if you stop the condor service, it goes to \"stopped\" once the master exits. Condor_procd is still running though and doesn't exit for about 30 secs.\n\n<p>This means that if you RESTART the service, it tries to launch condor while the previous procd is still running. This then leads to shared_port daemon exe starting but going in to a \"suspended\" state immediately and none of the other binaries being left running. <code>MasterLog</code> below.\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">MasterLog </pre>\n<pre class=\"snip\">03/08/19 13:00:02 Got SIGQUIT.  Performing fast shutdown.\n03/08/19 13:00:02 Sent signal 3 to SCHEDD (pid 6016)\n03/08/19 13:00:12 AllReaper unexpectedly called on pid 6016, status 0.\n03/08/19 13:00:12 The SCHEDD (pid 6016) exited with status 0\n03/08/19 13:00:12 Sent signal 15 to SHARED_PORT (pid 5304)\n03/08/19 13:00:12 AllReaper unexpectedly called on pid 5304, status 0.\n03/08/19 13:00:12 The SHARED_PORT (pid 5304) exited with status 0\n03/08/19 13:00:12 All daemons are gone.  Exiting.\n03/08/19 13:00:13 ******************************************************\n03/08/19 13:00:13 ** Condor (CONDOR_MASTER) STARTING UP\n03/08/19 13:00:13 ** D:\\Condor\\bin\\condor_master.exe\n03/08/19 13:00:13 ** SubsystemInfo: name=MASTER type=MASTER(2) class=DAEMON(1)\n03/08/19 13:00:13 ** Configuration: subsystem:MASTER local:&lt;NONE&gt; class:DAEMON\n03/08/19 13:00:13 ** $CondorVersion: 8.6.10 Mar 12 2018 BuildID: 435200 $\n03/08/19 13:00:13 ** $CondorPlatform: x86_64_Windows10 $\n03/08/19 13:00:13 ** PID = 13512\n03/08/19 13:00:13 ** Log last touched 3/8 13:00:12\n03/08/19 13:00:13 ******************************************************\n03/08/19 13:00:13 Using config source: D:\\Condor\\condor_config\n03/08/19 13:00:13 Using local config sources:\n03/08/19 13:00:13    D:\\Condor\\systems_config\\condor_config.8.a.base.gr\n03/08/19 13:00:13    D:\\Condor\\systems_config\\condor_config.8.a.base.gr.roles\n03/08/19 13:00:13    D:\\Condor\\systems_config\\condor_config.8.a.base.gr.vi\n03/08/19 13:00:13    D:\\Condor\\systems_config\\condor_config.8.b.submit.ws.qp\n03/08/19 13:00:13    D:\\Condor\\systems_config\\zzzc-metadata\n03/08/19 13:00:13    D:\\Condor\\user_config\\CondorHistoryFix.txt\n03/08/19 13:00:13    D:\\Condor\\user_config\\maxjobs.txt\n03/08/19 13:00:13 config Macros = 112, Sorted = 112, StringBytes = 8479, TablesBytes = 4128\n03/08/19 13:00:13 CLASSAD_CACHING is OFF\n03/08/19 13:00:13 Daemon Log is logging: D_ALWAYS D_ERROR\n03/08/19 13:00:13 SharedPortEndpoint: failed to open D:\\Condor\\etc/shared_port_ad: No such file or directory\n03/08/19 13:00:13 SharedPortEndpoint: did not successfully find SharedPortServer address. Will retry in 60s.\n03/08/19 13:00:13 DaemonCore: private command socket at &lt;172.18.9.15:0?sock=13512_5906&gt;\n03/08/19 13:00:13 Adding SHARED_PORT to DAEMON_LIST, because USE_SHARED_PORT=true (to disable this, set AUTO_INCLUDE_SHARED_PORT_IN_DAEMON_LIST=False)\n03/08/19 13:00:13 Collector port not defined, will use default: 9618\n03/08/19 13:00:13 ReadFile error: 109\n03/08/19 13:00:13 ProcFamilyClient: failed to read response from ProcD\n03/08/19 13:00:13 register_subfamily: ProcD communication error\n03/08/19 13:00:13 Create_Process: error registering family for pid 10516\n03/08/19 13:00:13 ERROR \"error registering process family with procd\" at line 7671 in file C:\\condor\\execute\\dir_5536\\sources\\src\\condor_daemon_core.V6\\daemon_core.cpp\n03/08/19 13:00:13 All daemons are gone.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Apr-01 15:03:36 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The code looks good.\n\n</p><p>Version history needs to be written.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-08 16:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3918a080b52ee07195e723defe099a0d9d47cb23\">[56521]</a></span>: Version history for several issues with Windows restart, reconfig and shutdown. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6952\" onclick=\"get_ticket_and_populate_wrapper('6952'); return false;\" title=\"shared port + procd on Windows causes the master to fail to restart\">#6952</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6957\" onclick=\"get_ticket_and_populate_wrapper('6957'); return false;\" title='Schedd on Windows restarts with \"fd_set is full\" message'>#6957</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6960\" onclick=\"get_ticket_and_populate_wrapper('6960'); return false;\" title=\"shared port on Windows can make damons slow to notice signals\">#6960</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-19 09:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/437c6defdc37641703f5b26b7b190266934fd352\">[56380]</a></span>: For <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6952\" onclick=\"get_ticket_and_populate_wrapper('6952'); return false;\" title=\"shared port + procd on Windows causes the master to fail to restart\">#6952</a></span>, change the condor_master so that it shuts down the procd explicitly and waits for it to exit before exiting or restarting itself. Also, fix a bug on Windows that could result in the master crashing just after it stopped the procd. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Apr-08 16:44", "status": "resolved", "created": "2019-Mar-11 09:56", "fixed_version": "2019-Mar-11 09:56", "broken_version": "v080600", "priority": "3", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "s96479", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}