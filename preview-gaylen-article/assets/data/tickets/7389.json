{"id": 7389, "title": "Ticket #7389: Expose Data Reuse to the ClassAd", "description": "<blockquote>\nThe current data reuse code slated for 8.9.5 includes some scaffolding to simply test the data reuse feature - but it's far from what we want.\n\n<p>The existing scaffolding allows us to specify a SHA256 checksum for the executable and allow the shadow to try to invoke data reuse when the checksum is available.  What we really want to allow is a <strong>data reuse manifest</strong>.  That is, a file which, when provided by the user, contains a mapping from filename to checksum for reusable files.  If specified, all files referenced inside the data reuse manifest should be transferred to the job sandbox using the reuse mechanism.\n\n</p><p>Example:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ cat reuse_manifest.txt\naba8412e2834958e70ca328ee2b9fbf75e6c22670a119903d0f78be56c1baf8e  CMakeCache.txt\n0f62f30ce1d39cfe61e5f89aa05d0ef3f62ff597e01d41ba56d150195949cfa0  hello_world2.txt\n40ab846d061bff2ad228325eab9918a16155ebf0d373861f48f143b1a085d28d  hello_world.txt\nb8bace8e943202fbd0c45f3156010414f6a2f9b0455d8ce094081c331dcb6567  install_manifest.txt\n</pre></div>\n\n\n<p>This file would be referenced in the submit description as such:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">+DataReuseManifestSHA256 = \"reuse_manifest.txt\"\n</pre></div>\n\n\n<p>and would cause the startd-side copy of <code>CMakeCache.txt</code>, <code>hello_world2.txt</code>, <code>hello_world.txt</code>, and <code>install_manifest.txt</code> to be reused if they are in the data reuse directory (and the checksum / sizes match).\n\n</p><p>Note that the reuse mechanism needs both the SHA256 hash and the file size.  If it's not provided (and the transfer file is not a URL), then we can use the <code>stat()</code> syscall to determine the size.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Feb-08 08:25:59 by bbockelm:</em> <br/>\n\nCode review occurred on <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GitHub\" title=\"Git Hub\">GitHub</a></span> by Jaime.  Per agreement with ToddT, I'd like to keep this undocumented until we are convinced we are happy with the approach.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-01 23:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5b040ae2d91eac311e7752453c65a14fc053f5bc\">[58910]</a></span>: Increment reserved space. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7389\" onclick=\"get_ticket_and_populate_wrapper('7389'); return false;\" title=\"Expose Data Reuse to the ClassAd\">#7389</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-01 23:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4090db6d9065d1b072bd7060f8399b85919092a9\">[58909]</a></span>: Ensure files in subdirectories are cached correctly. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7389\" onclick=\"get_ticket_and_populate_wrapper('7389'); return false;\" title=\"Expose Data Reuse to the ClassAd\">#7389</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-01 15:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e28c51a6568bcb9f5e6e4a546564a6ded1624e3a\">[58907]</a></span>: Ensure `DataReuseManifestSHA256` is rewritten after spooling. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7389\" onclick=\"get_ticket_and_populate_wrapper('7389'); return false;\" title=\"Expose Data Reuse to the ClassAd\">#7389</a></span> This ensures the name of the file attribute is correct after spooling.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-05 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/183067a9a80da7f7cca27f80285ce2bb7ee491d9\">[58906]</a></span>: Remove executable checksum. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7389\" onclick=\"get_ticket_and_populate_wrapper('7389'); return false;\" title=\"Expose Data Reuse to the ClassAd\">#7389</a></span> This removes the ability to set a hash for data reuse of the executable. That functionality was meant to simply be scaffolding for testing of the data reuse directory; now that there is the data reuse manifest, it is no longer needed.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-05 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/34b2bef662d806d905fc54d332da866213dfad53\">[58905]</a></span>: Make data reuse manifests compatible with spooling. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7389\" onclick=\"get_ticket_and_populate_wrapper('7389'); return false;\" title=\"Expose Data Reuse to the ClassAd\">#7389</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-05 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3328d3bfae08f40923cd1c92f263fbb027e61711\">[58904]</a></span>: Utilize a manifest file for data reuse. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7389\" onclick=\"get_ticket_and_populate_wrapper('7389'); return false;\" title=\"Expose Data Reuse to the ClassAd\">#7389</a></span> This allows a user to create a file (the format is the same as the output of the `sha256sum` binary) containing a list of files, one per line, and the corresponding checksum.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Apr-13 09:24", "status": "resolved", "created": "2019-Nov-19 23:07", "fixed_version": "2019-Nov-19 23:07", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelman@morgridge.org", "due_date": ""}