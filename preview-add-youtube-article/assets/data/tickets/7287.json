{"id": 7287, "title": "Ticket #7287: MAX_JOBS_SUBMITTED not working with jobs submitted through the python", "description": "<blockquote>\nWhere the problem was found:\nThis issue was found on HTCondor production schedds in CMS. We submit jobs using the condor python bindings (with the queue_with_itemdata() method) and had a limit of MAX_JOBS_SUBMITTED = 250000. We noticed jobs wouldn't submit at some point even if there were less than 60K jobs in the queue.\n\n<p>You can find a github issue describing the problem below\n<a class=\"external\" href=\"https://github.com/dmwm/WMCore/issues/9381\">https://github.com/dmwm/WMCore/issues/9381</a>\n\n</p><p>The solution for now has been resetting this setting to the default value.\n\n</p><p>General description (isolating the issue without CMS-related infrastructure):\n\n</p><p>MAX_JOBS_SUBMITTED doesn't work with jobs submitted through the python bindings (using the new htcondor.Submit() method) the way it does when jobs are submitted via condor_submit (the client).\n\n</p><p>Rather, it can refuse submitting more jobs even if the queue is empty, something in the accounting of jobs in the queue seems wrong.\n\n</p><p>For example, after restarting the schedd with MAX_JOBS_SUBMITTED = 10, submission of jobs (10 or less) can work, but if the jobs are removed and another submission is attempted, it starts failing. This does not seem to happen when jobs are submitted via the standard client condor_submit instead.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_version\n$CondorVersion: 8.9.2 Jun 04 2019 BuildID: 471265 PackageID: 8.9.2-1 $\n$CondorPlatform: x86_64_RedHat7 $\n$ condor_config_val MAX_JOBS_SUBMITTED\n10\n$ condor_q -allusers -totals\n\n\n-- Schedd: vocms0263.cern.ch : &lt;188.184.88.176:4080?... @ 09/26/19 16:04:33\nTotal for query: 0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended\nTotal for all users: 0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended\n\n[khurtado@vocms0263 /data/khurtado/late_materialization/bug]$ python submit_items3.py\nTraceback (most recent call last):\n  File \"submit_items3.py\", line 23, in &lt;module&gt;\n    submitRes = sub.queue_with_itemdata(txn, 1, iter(jobAds))\nRuntimeError: Failed to create new proc ID.\n\n$ tail /var/log/condor/SchedLog\n09/26/19 16:00:27 (pid:1496675) TransferQueueManager download 1m I/O load: 0 bytes/s  0.000 disk load  0.000 net load\n09/26/19 16:00:57 (pid:1496675) Number of Active Workers 0\n09/26/19 16:01:00 (pid:1496675) Number of Active Workers 0\n09/26/19 16:01:07 (pid:1496675) Number of Active Workers 0\n09/26/19 16:01:15 (pid:1496675) Can't find address for negotiator\n09/26/19 16:01:15 (pid:1496675) Failed to send RESCHEDULE to unknown daemon:\n09/26/19 16:03:13 (pid:1496675) Number of Active Workers 0\n09/26/19 16:04:33 (pid:1496675) Number of Active Workers 0\n09/26/19 16:04:36 (pid:1496675) NewProc(): MAX_JOBS_SUBMITTED exceeded, submit failed\n09/26/19 16:05:40 (pid:1496675) NewCluster(): MAX_JOBS_SUBMITTED exceeded, submit failed. Current total is 10. Limit is 10\n\n$ cat submit_items3.py\nimport classad\nimport htcondor\n\nsub = htcondor.Submit(\"\"\"\n\tuniverse = vanilla\n\texecutable = test.sh\n\targuments = 3\n        Output = out.$(Cluster)-$(Process)\n        Log = log.$(Cluster)\n\t\"\"\")\n\nschedd = htcondor.Schedd()\njobAds = []\nfor name in range(9):\n    name = str(name)\n    ad = {}\n    ad['My.JobName'] = classad.quote(name)\n    ad['My.JobLastName'] = classad.quote(name)\n    jobAds.append(ad)\n\nwith schedd.transaction() as txn:\n    submitRes = sub.queue_with_itemdata(txn, 1, iter(jobAds))\n    print(\"ClusterId: {0}, JobParams: {1}\".format(submitRes.cluster(), len(jobAds)))\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2019-Sep-26 10:34", "status": "new", "created": "2019-Sep-26 09:20", "fixed_version": "2019-Sep-26 09:20", "broken_version": "v080902", "priority": "4", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "khurtado", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}