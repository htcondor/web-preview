{"id": 6214, "title": "Ticket #6214: Have option to not run POST script if node job fails?", "description": "<blockquote>\nOn htcondor-users today, someone requested a way to <strong>not</strong> run a POST script if their node job fails, and have DAGMan consider the overall node failed.  This seems like a fairly reasonable request, and not too hard to do.\n\n<p>My initial thought is that it should be a DAG command rather than another config knob, especially since we now have the \"ALL_NODES\" option.\n\n</p><p>We could have something like this:\n\n</p><p></p><pre>  NO_POST_ON_FAIL &lt;node name&gt;\n</pre>\n\n<p>or\n\n</p><p></p><pre>  RUN_POST_ON_FAIL &lt;node name&gt; true|false\n</pre>\n\n<p>(I don't know if I like those command names, but you get the idea...)</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Apr-05 09:16:37 by wenger:</em> <br/>\n\nOn the other hand, doing this in configuration would make it easier to do it across splices or sub-DAGs with a single command...\n\n<p>I guess we should think about which way is better (I don't want to do both!).\n\n</p><p><em>2017-May-01 11:31:00 by coatsworth:</em> <br/>\n\nI've checked in an update. Code is in the following branch waiting for review:\n\n</p><p>remotes/origin/V8_7-gt6214-no-post-on-fail\n\n</p><p>I decided to take the NO_POST_ON_FAIL approach because I think it's intuitive. This commit includes a full implementation and a couple simple tests.\n\n</p><p></p><hr/>\n<em>2017-May-23 14:25:51 by wenger:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p></p><ul>\n<li>There's a problem with the NO_POST_ON_FAIL code in that it short-circuits\nnode retries, which it should not do.  I think that you can just change\n</li></ul>\n\n<p></p><pre>  if ( failed &amp;&amp; job-&gt;_scriptPost == NULL ) {\n</pre>\n\n<p>to\n\n</p><p></p><pre>  if ( failed &amp;&amp; ( job-&gt;_scriptPost == NULL || job-&gt;GetNoPostOnFail() ) ) {\n</pre>\n\n<p>and eliminate the whole new block of code below that.\n\n</p><p></p><ul>\n<li>The job_dagman_no_post_on_fail test needs to be added to Test_Requirements;\nafter that you should be able to do a build/test on all platforms.  You\nshould be sure to check whether the test works on Windows.\n\n<p></p></li><li>The version history item links to the wrong gittrac ticket.\nNO_POST_ON_FAIL should have the \\MacroNI{...} format in the version\nhistory.\n\n<p></p></li><li>Comments in job_dagman_no_post_on_fail.run refer to PRE_SKIP -- I\nassume you copied the .run file and forgot to change the comment.\n\n<p></p></li><li>I wonder if it might be worthwhile to have the syntax of the command\nbe something like:\n</li></ul>\n\n<p></p><pre>  NO_POST_ON_FAIL true|false &lt;node_name&gt;|ALL_NODES\n</pre>\n\n<p>then a user could do something like\n\n</p><p></p><pre>  NO_POST_ON_FAIL true ALL_NODES\n  NO_POST_ON FAIL false nodeX\n</pre>\n\n<p>if they wanted to skip the post script on failure for all but one node.\nThis would also be good if we ever decide to make not running the POST\nscript on failure the default in the future.\n\n</p><p></p><hr/>\n<em>2017-May-31 15:34:15 by coatsworth:</em> <br/>\n\nI've fixed the code problem, fixed the errors in the version history, and updated the comments in the test code.\n\n<p>The one thing I didn't do is implement the true|false value selection. I found this to be really confusing, on top of the fact that NO_POST_ON_FAIL is already confusing. If people ask for it I'll implement at a later date.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-30 10:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ad30da177715b0b79cf6f5525beec7f312ef3593\">[51660]</a></span>: Added to Test_Requirements (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-25 10:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8e4373927c1792684146e5bbedafd6692f64268a\">[50733]</a></span>: Fixed retry bug, fixed documentation, fixed test comments (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-28 14:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/653bab346dac517d0ec5cdcc28e76aff30378ebc\">[50591]</a></span>: Added basic tests for NO_POST_ON_FAIL (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-27 17:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cd403c47c2f9531e28330331be5d78610c4d927c\">[50589]</a></span>: Added documentation, removed debug messagse (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-27 13:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3e734d1f7463bf9c10d1f40c41bdf2b316a33f34\">[50588]</a></span>: Re-added code to fail parsing when job name not found (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-27 13:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dfad1d750688c39c58e6ef7c4f38fde065e45719\">[50587]</a></span>: Added code to skip POST nodes on job failures when NO_POST_ON_FAIL is set (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-27 10:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6796291dc9d6c3033360e060988d9f85bc7b10bc\">[50585]</a></span>: Added NO_POST_ON_FAIL into parse workflow and Job class (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6214\" onclick=\"get_ticket_and_populate_wrapper('6214'); return false;\" title=\"Have option to not run POST script if node job fails?\">#6214</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Jun-01 11:12", "status": "review", "created": "2017-Apr-03 15:49", "fixed_version": "2017-Apr-03 15:49", "broken_version": "v080700", "priority": "4", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "users", "visibility": "public", "notify": "wenger@cs.wisc.edu, coatsworth@cs.wisc.edu", "due_date": ""}