{"id": 5371, "title": "Ticket #5371: schedd crashes during fast shutdown intermittently", "description": "<blockquote>\nDuring a fast shutdown, the schedd will crash if there are running forkwork'ed children, perhaps from a condor_q in flight.  The stack trace looks like this:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">Stack dump for process 63178 at timestamp 1446687642 (17 frames)\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(dprintf_dump_stack+0x12d)[0x2ba86881eaad]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(+0x15af92)[0x2ba868831f92]\n/lib64/libpthread.so.0[0x33fb20f790]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_ZN10DaemonCore11Send_SignalE18classy_counted_ptrI11DCSignalMsgEb+0x57)[0x2ba868970517]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_ZN10DaemonCore11Send_SignalEii+0x76)[0x2ba868971416]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_ZN8ForkWork7KillAllEb+0x88)[0x2ba8688c46d8]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_ZN8ForkWork9DeleteAllEv+0x15)[0x2ba8688c4735]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_ZN8ForkWorkD1Ev+0x1b)[0x2ba8688c4a4b]\n/lib64/libc.so.6(exit+0xe2)[0x33faa35b22]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(__wrap_exit+0x73)[0x2ba86896a4f3]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_Z7DC_ExitiPKc+0x219)[0x2ba868959a59]\ncondor_schedd[0x449680]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_Z17handle_dc_sigquitP7Servicei+0x31)[0x2ba8689557a1]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_ZN10DaemonCore6DriverEv+0x946)[0x2ba868978576]\n/slots/07/dir_14290/userdir/condor/lib/libcondor_utils_8_5_2.so(_Z7dc_mainiPPc+0x1799)[0x2ba868958d89]\n/lib64/libc.so.6(__libc_start_main+0xfd)[0x33faa1ed5d]\ncondor_schedd[0x4213a9]\n</pre></div>\n\n\n<p>The problem is that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ForkWork\" title=\"Fork Work\">ForkWork</a></span> object is a global in qmgmt, and the destructor is called by the system after exit is called.  However, when the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ForkWork\" title=\"Fork Work\">ForkWork</a></span> destructor is called, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> singleton instance is guaranteed to already be deleted (we do it explicitly, before calling exit).  The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ForkWork\" title=\"Fork Work\">ForkWork</a></span> destructor  kills any running child proceses via DaemonCore::Send_Signal, but the daemonCore instance has already been deleted and set to null, so we crash.\n\n</p><p>Note this isn't a problem for a graceful shutdown of the schedd, for there we explicitly tell <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ForkWork\" title=\"Fork Work\">ForkWork</a></span> to kill all the children before calling DC_Exit for this very reason.\n\n</p><p>For 8.4, I'll just duplicate this code in the graceful shutdown code, but we should probably move <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ForkWork\" title=\"Fork Work\">ForkWork</a></span> into <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> for 8.5, as it depends on Dc.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-04 22:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fe06e98c8f5969294bcc8e19d3e9ef1d63c02c3\">[46195]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5371\" onclick=\"get_ticket_and_populate_wrapper('5371'); return false;\" title=\"schedd crashes during fast shutdown intermittently\">#5371</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-04 22:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6776ceb298099f8a060507668d8bf8e3c0d7325b\">[46194]</a></span>: Fix schedd crash on fast shutdown <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5371\" onclick=\"get_ticket_and_populate_wrapper('5371'); return false;\" title=\"schedd crashes during fast shutdown intermittently\">#5371</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Nov-11 08:18", "status": "resolved", "created": "2015-Nov-04 22:28", "fixed_version": "2015-Nov-04 22:28", "broken_version": "v080400", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20151108"}