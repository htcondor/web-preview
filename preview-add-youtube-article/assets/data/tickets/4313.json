{"id": 4313, "title": "Ticket #4313: Shadow reuse protocol issues", "description": "<blockquote>\nThere's a few CEDAR issues in Scheduler::RecycleShadow when sending a negative response back to the shadow.\n\n<p>First, this:\n\n</p><p></p><div class=\"verbatim\">\n<pre>        if( !mrec || !mrec-&gt;user ||\n                (srec-&gt;universe != CONDOR_UNIVERSE_VANILLA &amp;&amp;\n                 srec-&gt;universe != CONDOR_UNIVERSE_JAVA &amp;&amp;\n                 srec-&gt;universe != CONDOR_UNIVERSE_VM) )\n        {\n                stream-&gt;encode();\n                stream-&gt;put((int)0);\n                return FALSE;\n        }\n</pre></div>\n\n\n<p>Note there is no \"end_of_message\".  In the same function, there is also;\n\n</p><p></p><div class=\"verbatim\">\n<pre>        if( !FindRunnableJobForClaim(mrec,accept_std_univ) ) {\n                stream-&gt;put((int)0);\n                stream-&gt;end_of_message();\n                return TRUE;\n        }\n</pre></div>\n\n\n<p>This occurs when the stream is in decode mode.\n\n</p><p>We should really log some sort of \"no runnable job found, not reusing shadow\" message at either D_ALWAYS or D_FULLDEBUG.  More importantly, as the stream is still in 'decode' mode, it never sends a EOM to the shadow.\n\n</p><p>On the shadow side, I see:\n\n</p><p></p><div class=\"verbatim\">\n<pre>04/15/14 18:46:38 (304028.0) (1589274): recycleShadow() failed: Failed to receive end of message\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Apr-16 08:11:33 by bbockelm:</em> <br/>\n\nThis one bugged the heck outta me so I pushed a fix.  Jaime, can you do a quick review?\n\n<p></p><hr/>\n<em>2014-Apr-16 16:50:51 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Your patch looks good.\n\n</p><p></p><hr/>\n<em>2014-May-21 10:46:41 by jfrey:</em> <br/>\n\nI don't believe this fix merits a version history entry. The shadow's behavior is unchanged (it exits because the schedd doesn't want to recycle it). Resolving...</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-16 08:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/637c22814850d743052f51f17d9e94b396953eb5\">[39957]</a></span>: Fix incorrect CEDAR usage when recycling shadows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4313\" onclick=\"get_ticket_and_populate_wrapper('4313'); return false;\" title=\"Shadow reuse protocol issues\">#4313</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-May-21 10:46", "status": "resolved", "created": "2014-Apr-15 15:58", "fixed_version": "2014-Apr-15 15:58", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "jfrey", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}