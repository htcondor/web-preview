{"id": 4321, "title": "Ticket #4321: Enable use of larger UDP (safesock) fragment size", "description": "<blockquote>\nVery large pools using a multi-tier collector setup, such as US CMS, can observe problems where the top-level parent collector cannot keep-up with incoming updates from child collectors.  A significant contributor to this problem was the fragmentation of UDP datagrams, as <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SafeSock\" title=\"Safe Sock\">SafeSock</a></span> was hard-coded to always fragment into 1000 byte packets.  As a result, when the kernel incoming UDP buffer started to fill up, complete messages would rarely make it because one or more fragments would not make it into the buffer.  To demonstrate this phenomenon, see the graph below with results from an experiment where an increasing number of streams each sent 40 updates per second. UDP with 1k fragments peaks at 22 streams at 850 hertz, then the hertz nose dives rapidly once the incoming UDP receive buffer does not have enough free space to hold the incoming fragments.  The collector does a lot of work but rarely is able to reassemble a complete message. TCP and UDP w/ 16k MTU perform about the same - most importantly, they do not self-destruct when overloaded.  Instead, they continue to perform at their peak of ~1000 hertz.\n<img alt=\"performance.png\" src=\"attach_get/831/performance.png\"/>\nOne solution would be to use TCP updates, but that could cause the child collectors to block sending updates to the parent (which is a concern esp if the child collectors are acting as CCB brokers).\n\n<p>Thus for this ticket we will remove the hard-coded 1000-byte fragmentation size and introduce two new knobs:\n\n</p><p></p><ol>\n<li><code>UDP_LOOPBACK_FRAGMENT_SIZE</code> is used when connecting to the loopback interface (i.e. IPv4 address 127.0.0.1 or the IPv6 equal) and defaults to the largest allowable safesock message size, which is currently ~60k\n</li><li><code>UDP_NETWORK_FRAGMENT_SIZE</code> is used when connecting to an address other than the loopback, and defaults to 1000</li></ol>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/831/performance.png\">performance.png</a>\n28706 bytes added by tannenba on 2014-Apr-18 19:42:57 UTC.\n<br/>\nCollector performance graph for ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4321\" onclick=\"get_ticket_and_populate_wrapper('4321'); return false;\" title=\"Enable use of larger UDP (safesock) fragment size\">#4321</a></span><br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-21 11:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0928fd4f05263666dc74b283ede741693bfe03f2\">[40198]</a></span>: Document for UDP fragmentation knobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4321\" onclick=\"get_ticket_and_populate_wrapper('4321'); return false;\" title=\"Enable use of larger UDP (safesock) fragment size\">#4321</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-18 09:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c117b44c4c4e20d867da077010dbfc29d816190e\">[39976]</a></span>: Enable larger UDP (safesock) fragmentation sizes. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4321\" onclick=\"get_ticket_and_populate_wrapper('4321'); return false;\" title=\"Enable use of larger UDP (safesock) fragment size\">#4321</a></span> Add knobs UDP_LOOPBACK_FRAGMENT_SIZE used when going to the loopback interface (default to largest message size, currently 60k), and UDP_NETWORK_FRAGMENT_SIZE when going to any non-loopback address (default to 1000 bytes as before). Note these are\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-May-21 11:46", "status": "resolved", "created": "2014-Apr-18 09:25", "fixed_version": "2014-Apr-18 09:25", "broken_version": "", "priority": "1", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu", "due_date": ""}