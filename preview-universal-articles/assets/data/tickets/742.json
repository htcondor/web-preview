{"id": 742, "title": "Ticket #742: Slots left Claimed Idle when there are no jobs", "description": "<blockquote>\n<a class=\"external\" href=\"https://bugzilla.redhat.com/show_bug.cgi?id=523482\">https://bugzilla.redhat.com/show_bug.cgi?id=523482</a>\n\n<p>Description of problem:\n\n</p><p>It is possible to have slots left in the Claimed state with no running jobs,\nand no jobs to run!, until the claim lease expires.\n\n</p><p>Version-Release number of selected component (if applicable):\n\n</p><p>condor-7.4.0-0.4\n\n</p><p>How reproducible:\n\n</p><p>100%\n\n</p><p>Steps to Reproduce:\n1. start condor (make sure schedd start)\n2. mv /usr/sbin/condor_shadow /usr/sbin/condor_shadow-\n3. submit a job (echo -e\n'executable=/bin/sleep\\narguments=5\\ntransfer_executable=false\\nnotification=never\\nqueue\n1\\n' | condor_submit)\n4. watch condor_status -total until there is a Claimed slot, can also check\ncondor_status | grep Claimed, it should be Claimed Idle\n5. remove the job (condor_rm -a will do it)\n\n</p><p>Actual results:\n\n</p><p>The Claimed slot will remain that way until the claim lease expires. This can\nbe verified by watching the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartLog\" title=\"Start Log\">StartLog</a></span> on the slot's machine.\n\n</p><p>Expected results:\n\n</p><p>The slot should be returned to the Unclaimed state.\n\n</p><p>Additional info:\n\n</p><p>Running a job on a slot is a multi-step process. Three steps the Schedd goes\nthrough are to 1) REQUEST_CLAIM on the Startd 2) start a Shadow for the job 3)\nlet the Shadow ACTIVATE_CLAIM on the Startd. The Schedd will RELEASE_CLAIM on\nthe Startd for all jobs that have an active Shadow. Anything that prevents step\n(2) from succeeding, such as the Shadow cannot be executed (induced above) or a\ncondor_rm -a while the Schedd is loaded (original way of hitting this bug) and\nShadow execution is cancelled, will demonstrate this bug.\n\n</p><p>The Schedd keeps match_rec's for each job it is starting, the match_rec has a status field that can indicate M_STARTD_CONTACT_LIMBO (step 1 completed), M_CLAIMED (step 2 completed). The Schedd sends RELEASE_CLAIM on M_CLAIMED and should be changed to on M_STARTD_CONTACT_LIMBO as well.</p></blockquote>", "remarks": "<blockquote>\nI have tried to reproduce and understand this issue.  My attempts to reproduce it are based on the master branch, but I am pretty sure the results apply to V7_4 as well.\n\n<p>I think there was some confusion when testing the proposed solution (<span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6ef74d2c2da9becaa275d64d8cccf471871c000\">[15697]</a></span>).  It does not solve the problem, but the observed behavior is influenced by some race conditions, so it may be that while testing, the race made it appear that the behavior had improved.\n\n</p><p>The status of the match goes from LIMBO to CLAIMED when the startd responds to the schedd's CLAIM_REQUEST.  The schedd never tries to start a shadow while the match is still in the LIMBO state.  Furthermore, the schedd should never send RELEASE_CLAIM while the match is in the LIMBO state, at least until better claim management exists that prevents one schedd from obliterating another schedd's prior claim with the same id.\n\n</p><p>Here's what I observe when following the procedure specified in this ticket for reproducing the problem: after the job is removed, the next call to <code>StartJobs()</code> will cause the schedd to try to find a job to run on the claim.  If it finds no more jobs to run on it, then the claim is deleted and RELEASE_CLAIM is sent to the startd.  The delay before the call to <code>StartJobs()</code> can be quite short but it can be up to SCHEDD_INTERVAL seconds, possibly leaving one with the impression that the claim has been leaked.\n\n</p><p>So I think the problem is really that if a job is removed while in the queue of jobs pending to start, the schedd does not quickly notice that the associated claim is idle.  This could be easily solved in the master branch by making a call to <code>ExpediteStartJobs()</code> somewhere in the job removal code path.\n\n</p><p>I recommend that we revert <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6ef74d2c2da9becaa275d64d8cccf471871c000\">[15697]</a></span> and <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c7687ad1f4bc9c7945649fa1d74b7c3676569397\">[17675]</a></span> in V7_4-branch.  The latter patch basically tries to undo the effect of the former patch, but may not be catching all cases.\n\n</p><p></p><hr/>\n<em>2010-Mar-26 18:27:21 by danb:</em> <br/>\n\nAfter discussing with Matt, I went ahead and reverted <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6ef74d2c2da9becaa275d64d8cccf471871c000\">[15697]</a></span>  and <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c7687ad1f4bc9c7945649fa1d74b7c3676569397\">[17675]</a></span> in V7_4_2-branch.  In master branch (7.4.3), I added a call to ExpediteStartJobs() when jobs are removed to speed up discovery that a claim in CLAIMED state needs some attention (either picking a different job or removing the claim).</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1314\" onclick=\"get_ticket_and_populate_wrapper('1314'); return false;\" title=\"matches in M_STARTD_CONTACT_LIMBO are not removed as soon as desired\">#1314</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nmatches in M_STARTD_CONTACT_LIMBO are not removed as soon as desired</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-26 18:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a11ca9619690ef63a88c3fc066bfd1b34f06ed7a\">[25393]</a></span>: Documented revert of sending RELEASE_CLAIM while in LIMBO. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=742\" onclick=\"get_ticket_and_populate_wrapper('742'); return false;\" title=\"Slots left Claimed Idle when there are no jobs\">#742</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-26 18:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6da41a55d548b19e5aaf5c2db3b88091d07676d8\">[25379]</a></span>: Documented speed up in rescheduling after job removal. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=742\" onclick=\"get_ticket_and_populate_wrapper('742'); return false;\" title=\"Slots left Claimed Idle when there are no jobs\">#742</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-26 18:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6614692b206f9e8f30be8547b5cb6dc9f2b2dc43\">[17714]</a></span>: Speed up discovery that a match in CLAIMED state was associated with a job that has been removed. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=742\" onclick=\"get_ticket_and_populate_wrapper('742'); return false;\" title=\"Slots left Claimed Idle when there are no jobs\">#742</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-26 17:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/103718c421a3ae9ea13fa2ea3dacd2a76f76e3e4\">[17711]</a></span>: Revert \"Send RELEASE_CLAIM for match_recs that are in M_STARTD_CONTACT_LIMBO (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=742\" onclick=\"get_ticket_and_populate_wrapper('742'); return false;\" title=\"Slots left Claimed Idle when there are no jobs\">#742</a></span>)\" This reverts commit c6ef74d2c2da9becaa275d64d8cccf471871c000.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-15 12:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6ef74d2c2da9becaa275d64d8cccf471871c000\">[15697]</a></span>: Send RELEASE_CLAIM for match_recs that are in M_STARTD_CONTACT_LIMBO (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=742\" onclick=\"get_ticket_and_populate_wrapper('742'); return false;\" title=\"Slots left Claimed Idle when there are no jobs\">#742</a></span>)  (By Matthew Farrellee )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Mar-26 18:27", "status": "resolved", "created": "2009-Sep-15 11:50", "fixed_version": "2009-Sep-15 11:50", "broken_version": "v070302", "priority": "2", "subsystem": "Daemons", "assigned_to": "matt", "derived_from": "", "creator": "matt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu,dan@hep.wisc.edu", "due_date": ""}