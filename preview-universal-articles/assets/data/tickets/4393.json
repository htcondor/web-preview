{"id": 4393, "title": "Ticket #4393: Make listen() backlog configurable", "description": "<blockquote>\nWhen calling listen() for a daemon's command socket, we currently use a backlog of 500. We should make this configurable, as heavy users may want a larger value.\nWe'll have a new config param named SOCKET_LISTEN_BACKLOG, whose value will default to 500.\n\n<p>There are two locations where we want to do this. The first is in ReliSock::listen(). The second is for SharedPortEndpoint::CreateListener(), where a daemon creates a unix domain socket for being given connections from the shared port daemon.\n\n</p><p>Currently, if listen() fails, we retry several times with smaller backlog values. On all of our current platforms, if the given backlog is too large for the OS's liking, it just caps the value and listen() still succeeds.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jun-02 16:15:29 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good, please push w/ a version history entry.  Little worried about\ncalling param() from inside relisock  as relisock is used in the\nsyscall library, but I think we are likely ok in this instance.\n\n</p><p></p><hr/>\n<em>2014-Jun-05 16:09:13 by bbockelm:</em> <br/>\n\nFor historical record -\n\n<p>One case where one might increase the backlog is very busy schedd (many thousands of running jobs) using shared port.  The shared port will use the backlog as of 8.1.5; prior versions would fork child shared_port instances and use those as a queue.  So, effectively, from 8.1.4 to 8.1.5, the default queue size went from 1000 to 128 (Linux default max backlog) and the max configurable went from basically unlimited to 500.\n\n</p><p>So, this will allow large installs to restore the prior behavior.  The investigation for this bug uncovered many places where shared_port is used unnecessarily by the shadow and startd; these will be fixed in 8.2.x and 8.3.x, respectively.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/834/listen_backlog.patch\">listen_backlog.patch</a>\n2407 bytes added by jfrey on 2014-Jun-02 20:51:01 UTC.\n<br/>\nPatch to make listen() backlog configurable.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-09 09:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0878486de8b01e168bd9f86038feda78e0eb5036\">[40363]</a></span>: minor doc edits for new knob SOCKET_LISTEN_BACKLOG <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4393\" onclick=\"get_ticket_and_populate_wrapper('4393'); return false;\" title=\"Make listen() backlog configurable\">#4393</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-02 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f055cb90c9032f07e1b834449cc777040da0b9a2\">[40310]</a></span>: Make listen() backlog configurable with SOCKET_LISTEN_BACKLOG. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4393\" onclick=\"get_ticket_and_populate_wrapper('4393'); return false;\" title=\"Make listen() backlog configurable\">#4393</a></span> New configuration parameter SOCKET_LISTEN_BACKLOG can be used to set the listen() backlog used in daemons. The default of 500 maintains the old behavior.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-02 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7d3888473777b34568cdc6448b79055dc86cc758\">[40311]</a></span>: Docs for new config param SOCKET_LISTEN_BACKLOG. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4393\" onclick=\"get_ticket_and_populate_wrapper('4393'); return false;\" title=\"Make listen() backlog configurable\">#4393</a></span>  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Jun-13 10:38", "status": "resolved", "created": "2014-Jun-02 15:49", "fixed_version": "2014-Jun-02 15:49", "broken_version": "v080000", "priority": "2", "subsystem": "Libs", "assigned_to": "tannenba", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}