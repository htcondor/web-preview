{"id": 3333, "title": "Ticket #3333: improve file transfer management", "description": "<blockquote>\nWe propose to make some improvements to the management of file transfers.  See the attached design doc.</blockquote>", "remarks": "<blockquote>\n<em>2012-Dec-06 07:53:24 by bbockelm:</em> <br/>\n\nPer discussion with Dan in person on Wednesday:\n\n<p>The proposed round-robin transfer mechanism isn't very fair as it gives the next transfer to the queue with the least-recently-started transfer.  Consider the case where there are two users; User A has transfers which last 1s and User B has transfers which last 1hr.  If the transfer limit is 10 transfers, then after 10s, User B will have all the transfer slots and User A will be starved.\n\n</p><p>We proposed the following tweak: the next available transfer is given to the queue which has the least number of active transfers and the least-recently-started transfer.  This way, in the steady state, no user starves.  This does not solve startup issues (in the above example, if User A submits well after User B, they may have to wait an hour for the next transfer slot).\n\n</p><p></p><hr/>\n<em>2012-Dec-06 07:59:41 by bbockelm:</em> <br/>\n\nAnother deviation from the design document: TRANSFER_QUEUE_USER_EXPR was added to determine how to configure the queue.\n\n<p>For example (Dan, please correct if I am reading the HTCondor manual updates incorrectly; can you confirm you've tested these three cases?):\n</p><ul>\n<li>TRANSFER_QUEUE_USER_EXPR = FIFO; this will keep the older FIFO behavior.\n</li><li>TRANSFER_QUEUE_USER_EXPR = User; (default) this will round-robin transfers across users.\n</li><li>TRANSFER_QUEUE_USER_EXPR = User,GLIDEIN_Site; this will round-robin transfers per-site, per-user for glideinWMS systems.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Dec-06 09:42:18 by danb:</em> <br/>\n\nTRANSFER_QUEUE_USER_EXPR should evaluate to a string, so I'd just modify your examples like so:\n\n<p></p><ul>\n<li>TRANSFER_QUEUE_USER_EXPR = \"FIFO\"; this will keep the older FIFO behavior.\n</li><li>TRANSFER_QUEUE_USER_EXPR = User; (default) this will round-robin transfers across users.\n</li><li>TRANSFER_QUEUE_USER_EXPR = strcat(User,GLIDEIN_Site); this will round-robin transfers per-site, per-user for glideinWMS systems.\n</li></ul>\n\n<p>Also, the expression does not have access to the machine ad, so the example using GLIDEIN_Site would need to work around that by inserting the required machine attributes into the job ad (e.g. with job_machine_attrs or SYSTEM_JOB_MACHINE_ATTRS or $$).  Perhaps I should make the machine ad directly accessible to this expression.  The reason I didn't is that the file transfer object currently doesn't have access to the machine ad, but that's not a great excuse.\n\n</p><p></p><hr/>\n<em>2012-Dec-29 11:08:42 by bbockelm:</em> <br/>\n\nHi Dan,\n\n<p>Would it make sense to advertise a \"transfer queue ad\"?  Or perhaps have a list of transfer queue statuses as a sub-ad of the schedd ad?\n\n</p><p>Basically, if I'm an admin, I need a way to monitor queue lengths.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2013-Jan-02 22:02:21 by nwp:</em> <br/>\n\nWith this patch (300b1565), job_filexfer_output-withvacate_van test fails in <a class=\"external\" href=\"http://submit-2.batlab.org/results/run-details.php?runid=90775\">NMI</a>\n<hr/>\n<em>2013-Jan-22 10:54:51 by danb:</em> <br/>\n\nThe design plan for this ticket has been implemented.  Further improvements are being considered, but we will likely do them in a new ticket.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3487\" onclick=\"get_ticket_and_populate_wrapper('3487'); return false;\" title=\"implement fair sharing in transfer queue\">#3487</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nimplement fair sharing in transfer queue</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/658/TransferQueueUpgrade1.doc\">TransferQueueUpgrade1.doc</a>\n38400 bytes added by danb on 2012-Nov-20 20:17:24 UTC.\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-31 12:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d850f113cee60a61d86fb23ec38b78ee7ff1dd8b\">[34808]</a></span>: Edit documentation, correct spelling, and relocate if needed for alphabetization ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-10 11:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/14b0af5fecfc23e60f6a0f7247b94199e72b6ab1\">[34579]</a></span>: Fix for windows file transfer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span> My previous commit introduced a call to Register_Pipe() on a pipe that was not created with the registerable flag set.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-09 17:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db149af431458b2e875fa96e3f38679514d7a853\">[34571]</a></span>: Fix file transfer status reporting for parallel universe. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-08 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0eb02cb27b5cebf9af3eca3d9d3015776f716e1c\">[34565]</a></span>: Make download limit and non-blocking transfer work after a reconnect. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-08 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/124d28b8dfcdc6f62b89e4036d1ac239fd61d872\">[34566]</a></span>: Publish file transfer status and display it in condor_q. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-03 13:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dce3324f700b4f1b445ee45940f5ad5982cf4c93\">[34520]</a></span>: Wait for file transfer during graceful shutdown of the job. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span> This fixes a problem introduced in my previous commit.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-02 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/300b156527d0d1d0ecf9b1c2218eecf9334142e9\">[34515]</a></span>: Use non-blocking mode for file transfers in the shadow (unix only, for now). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-27 09:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/287e604dba6053defa542d415c0f1ef565a3f6a1\">[34480]</a></span>: Fixed default for new optional argument max_bytes in put_file(). It was intended to be unlimited by default, not 0. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-26 17:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6e177d119b648a4cb6a300b673357e62c61f55d9\">[34479]</a></span>: Fixed compiler warning. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-26 15:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f65a7533a4affe49783c4fb73949279842941e49\">[34478]</a></span>: Added MAX_TRANSFER_INPUT_MB and MAX_TRANSFER_OUTPUT_MB. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-05 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37952ad572addd73257f42d6d12a4364d6cc0110\">[34275]</a></span>: Fix windows build. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-04 17:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/70b7b8e1e5798af4e1466d49fc014001b8488532\">[34272]</a></span>: Added round-robin scheduling to the file transfer queue. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3333\" onclick=\"get_ticket_and_populate_wrapper('3333'); return false;\" title=\"improve file transfer management\">#3333</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Jan-22 11:41", "status": "resolved", "created": "2012-Nov-20 14:15", "fixed_version": "2012-Nov-20 14:15", "broken_version": "v070900", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu, bbockelm@cse.unl.edu, burt@fnal.gov", "due_date": ""}