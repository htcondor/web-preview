{"id": 7666, "title": "Ticket #7666: condor_ssh_to_job should fully work with singularity", "description": "<blockquote>\nWhen a job running inside singularity is connected to with condor_ssh_to_job, several things don't quite work today.  Because we never want to assume anything about what might be inside the container, we launch the sshd outside the container, and have it run nsenter to launch a shell inside the container, with stdin/out/error magically connected to the ssh session.\n\n<p>However, the stock nsenter doesn't allocate a pty for the session, and the pty that ssh allocates gets lost when we enter the container, because singularity remounts /dev/pts on the inside.\n\n</p><p>Also, the environment variables set by the job are not reset inside the interactive shell.  While we could set the ones that the starter knows about,\nsingularity itself sets several extra environment variables which we don't know about, and may be of particular important when gpus are in play.\n\n</p><p>Also, we need to give nsneter a different set of command line options if we are\nentering a singularity container that was started by a non-setuid singularity.\nThis is annoying, as we can't tell really if singularity is configured to be\nsetuid or not.\n\n</p><p>So, we will write a replacement nsenter that fixes all these problems.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Jul-27 22:59:18 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>Eliminate duplicate call to findChildProc() in os_proc.cpp.\n\n<p></p></li><li>Eliminate redundant calls to getenv().\n\n<p></p></li><li>Can't we end up with two DISPLAY environment variables in <code>envp</code>? Can we trust that the first one in the list will win?\n\n<p></p></li><li>Shouldn't we not call ioctl(TIOCSWINSZ) if ioctl(TIOCGWINSZ) fails?\n\n<p></p></li><li>Blindly trusting that the grandchild pid will have all of the correct environment variables and other properties seems error prone when it can be a child of the original job process.</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7779\" onclick=\"get_ticket_and_populate_wrapper('7779'); return false;\" title=\"Address code review comments for condor_nsenter\">#7779</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAddress code review comments for condor_nsenter</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-03 17:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7454896da556d8fa6787c5dd8ba5408d56bb5e9d\">[60328]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-11 18:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a75eece1bcbb140a7cdba124357b9b541a7c69f8\">[60121]</a></span>: Copy DISPLAY var from outside ssh-to-job to inside <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 12:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4695db01e968c4e45776df2d9ab3485df716ee0b\">[59842]</a></span>: condor_nsenter updates environment variables inside container to match target_dir <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-08 23:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a612b5eeb89e621f4e6ca63d7f09c1bfbcbc9fb9\">[59820]</a></span>: Port nsenter changes to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-08 22:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/946aedbf932b67940140cee980787b96f92596da\">[59819]</a></span>: Make nsenter work with dash <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span> Explicitly set the control terminal to the pty, which dash needs also copy the window size from the master pty to the work so vi works  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-29 08:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/90e0fb54ff3fe565d4aa1326bc1a067f9fd5d3a5\">[59733]</a></span>: Revert \"Port nsenter to el6 <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>\" EL6 support is no longer needed This reverts commit bee9b6d504f8a13e35998cbbb04cfc29fed4a3c6.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-28 18:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bee9b6d504f8a13e35998cbbb04cfc29fed4a3c6\">[59729]</a></span>: Port nsenter to el6 <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-28 17:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/112b7cff9cb70c5d717b80124d00f0f36b4121fc\">[59727]</a></span>: Add condor_nsenter to list of files in the package <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-28 14:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/073bdc0234047efe38cf4eefaa5d36ed8bc82705\">[59725]</a></span>: Make condor_ssh_to_job fully work with singularity <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7666\" onclick=\"get_ticket_and_populate_wrapper('7666'); return false;\" title=\"condor_ssh_to_job should fully work with singularity\">#7666</a></span> write a new version of nsenter that makes ptys, copies the environment and gets everything ssh needs.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Aug-04 06:30", "status": "resolved", "created": "2020-May-28 13:43", "fixed_version": "2020-May-28 13:43", "broken_version": "v080808", "priority": "2", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "peter.wienemann@uni-bonn.de, freyermuth@physik.uni-bonn.de", "due_date": ""}