{"id": 1679, "title": "Ticket #1679: UserLog reader will get stuck due to sticky feof", "description": "<blockquote>\nWe have encountered many problems related to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> reader, i.e. condor_wait getting stuck (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1457\" onclick=\"get_ticket_and_populate_wrapper('1457'); return false;\" title=\"condor_wait waits forever if an incomplete event is read\">#1457</a></span>), assorted DAGMan anomalies, etc. There are now many ways of monitoring the state of the reader's file pointer in order to make sure it will read events even after ending up in feof.\n\n<p>Turns out, this can be solved internally by adding a check for </p><div class=\"verbatim\">\n<pre>foef(file_ptr)</pre></div>\n and a following call to <div class=\"verbatim\">\n<pre>clearerr(file_ptr)</pre></div>\n for every initiated event read. We have assorted checks for that, but there exist code paths (i.e. w/o rotation) that will never even get there. If we make sure for every event read,that we get rid of the sticky feof, we will encounter far less problems with the reader API.\n\n<p>An additional aspect of that is that we - most likely - can get rid of the WRITE lock in the reader. So far the encountered failure looked a lot like a race condition -- and it is possible that the WRITE lock does something different to the file pointer (i.e. removing the sticky bit) than the READ lock. Since in 7.5 we mostly will have separate lock files anyway, this won't matter - but it revealed this bug yet another time.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-27 12:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7ee78d656c3a9bdb4b2269412ebe564b6e6dd469\">[19058]</a></span>: This commit fixes a problem with the user log reader when its file pointer gets stuck in feof state. By checking for feof in every readEvent call and clearing the sticky bit, we prevent this from happening (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1679\" onclick=\"get_ticket_and_populate_wrapper('1679'); return false;\" title=\"UserLog reader will get stuck due to sticky feof\">#1679</a></span>) . (cherry picked from commit 9c0cd2f12a888f61af8540df35f0a2c35cc6d48e)  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-27 12:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c0cd2f12a888f61af8540df35f0a2c35cc6d48e\">[19057]</a></span>: This commit fixes a problem with the user log reader when its file pointer gets stuck in feof state. By checking for feof in every readEvent call and clearing the sticky bit, we prevent this from happening (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1679\" onclick=\"get_ticket_and_populate_wrapper('1679'); return false;\" title=\"UserLog reader will get stuck due to sticky feof\">#1679</a></span>) .  (By Cathrin Weiss )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Sep-27 12:58", "status": "resolved", "created": "2010-Sep-27 12:15", "fixed_version": "2010-Sep-27 12:15", "broken_version": "v070000", "priority": "2", "subsystem": "", "assigned_to": "cweiss", "derived_from": "", "creator": "cweiss", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20100927"}