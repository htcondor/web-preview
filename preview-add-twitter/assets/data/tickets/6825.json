{"id": 6825, "title": "Ticket #6825: Enable condor_ssh_to_job into a singularity container", "description": "<blockquote>\nWhen a job is running inside singularity, condor_ssh_to_job works, but leaves the user's shell outside the container, which is less than optimal.  We can put the shell inside the container in the same way we do for docker universe -- by having the sshd outside the container, as we do for vanilla universe, and implementing a special command to enter the container.  Unfortunately, singularity doesn't have the equivalent of docker exec.  We can simulate this, though with a combination of nsenter and chroot.  This requires root, so when singularity is enabled, and the starter has root, we'll drop a unix domain socket in the sandbox dir.  When a connection is made to this sock, the client will pass stdin, stdout and stderr to the starter, which well then fork and exec nsenter, passing chroot as the command to nsenter.  This allows the resulting shell under the chroot to run inside the singularity container.</blockquote>", "remarks": "<blockquote>\n<em>2018-Dec-18 14:47:34 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>I don't see <code>singExecPid</code> being initialized anywhere, which suggests that bad luck could cause the reaper to <code>delete</code> the equally-uninitialized <code>sns</code>.\n\n<p></p></li><li>The dprintf() on line 1098 of <code>os_proc.cpp</code> seems rather deceptive.\n\n<p></p></li><li>Lines 1140-1142 of <code>os_proc.cpp</code> appear to be entirely redundant; is switching in and out of root priv state useful for some reason?\n</li></ul>\n\n<p>Looks good otherwise.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Dec-21 11:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0aaebf363c84510b638d871b6a86bb7c6673bca5\">[55924]</a></span>: More changes from code review <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6825\" onclick=\"get_ticket_and_populate_wrapper('6825'); return false;\" title=\"Enable condor_ssh_to_job into a singularity container\">#6825</a></span> Committer: Tim Theisen  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Dec-21 11:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/de4b1b4f2af43a8fdacd9390f2da8e991d2dad6a\">[55923]</a></span>: Updates from code review for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6825\" onclick=\"get_ticket_and_populate_wrapper('6825'); return false;\" title=\"Enable condor_ssh_to_job into a singularity container\">#6825</a></span> Committer: Tim Theisen  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Dec-19 15:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a9753d38a9bafe7d16bc4af36261549a7a699040\">[55899]</a></span>: More changes from code review <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6825\" onclick=\"get_ticket_and_populate_wrapper('6825'); return false;\" title=\"Enable condor_ssh_to_job into a singularity container\">#6825</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Dec-19 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1cc86a8ef0951a0406b7ef068d86120450b89613\">[55898]</a></span>: Updates from code review for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6825\" onclick=\"get_ticket_and_populate_wrapper('6825'); return false;\" title=\"Enable condor_ssh_to_job into a singularity container\">#6825</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-15 12:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/13198d4efef976689fdd2f102f6aa213fa2f4659\">[55735]</a></span>: Add condor_ssh_to_job support for Singularity <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6825\" onclick=\"get_ticket_and_populate_wrapper('6825'); return false;\" title=\"Enable condor_ssh_to_job into a singularity container\">#6825</a></span> Allow condor_docker_enter to work for singularity. It connects to a unix domain socket the starter has created in the scratch dir, and which the starter is listening on. At connection, condor_docker enter passes stdin, stdout and stderr to the starter,\u00a0[...]\n (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Dec-19 14:25", "status": "resolved", "created": "2018-Nov-15 10:18", "fixed_version": "2018-Nov-15 10:18", "broken_version": "v080800", "priority": "2", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}