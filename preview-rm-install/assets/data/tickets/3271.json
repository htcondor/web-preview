{"id": 3271, "title": "Ticket #3271: Fairly severe priority inversion at Nebraska", "description": "<blockquote>\nIn the current trunk, we're seeing some fairly severe priority inversion - a group is getting way too much CPU that has a fairly small fairshare.  Pool red-condor.unl.edu, if you want to pull the configs + user priorities yourself.\n\n<p>For example, here's a snippet from that negotiation log. Notice how all the requests are allocated, although there are not that many cores here (the number of cores is about equal to the total quota!)\n\n</p><p>Help!\n\n</p><p></p><div class=\"verbatim\">\n<pre>10/16/12 21:24:53 group quotas: group= &lt;none&gt;  cquota= 0  static= 0  accept= 1  quota= 3241  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: group= cms  cquota= 0.9  static= 0  accept= 1  quota= 2916.9  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: group= other  cquota= 0.1  static= 0  accept= 1  quota= 324.1  req= 1173  usage= 1139\n10/16/12 21:24:53 group quotas: group= cms.lcgadmin  cquota= 0.1  static= 0  accept= 1  quota= 291.69  req= 22  usage= 22\n10/16/12 21:24:53 group quotas: group= cms.other  cquota= 0.4  static= 0  accept= 1  quota= 1166.76  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: group= cms.prod  cquota= 0.5  static= 0  accept= 1  quota= 1458.45  req= 1423  usage= 1317\n10/16/12 21:24:53 group quotas: group= other.hcc  cquota= 1  static= 0  accept= 1  quota= 324.1  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: group= cms.other.prio  cquota= 0.5  static= 0  accept= 1  quota= 583.38  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: group= cms.other.user  cquota= 0.5  static= 0  accept= 1  quota= 583.38  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: group= cms.other.user.nonus  cquota= 0.6  static= 0  accept= 1  quota= 346.562  req= 5087  usage= 309\n10/16/12 21:24:53 group quotas: group= cms.other.user.t3  cquota= 0.4  static= 0  accept= 1  quota= 231.042  req= 18  usage= 18\n10/16/12 21:24:53 group quotas: group= cms.other.user.us  cquota= 0.01  static= 0  accept= 1  quota= 5.77604  req= 0  usage= 0\n10/16/12 21:24:53 group quotas: allocation round 1\n10/16/12 21:24:53 group quotas: fairshare (1): group= &lt;none&gt;  quota= 3241  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= &lt;none&gt;  quota= 3241  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms  quota= 2916.9  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms  quota= 2916.9  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.lcgadmin  quota= 291.69  requested= 22\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.lcgadmin  quota= 291.69  allocated= 22  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.other  quota= 1166.76  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.other  quota= 1166.76  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.other.prio  quota= 583.38  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.other.prio  quota= 583.38  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.other.user  quota= 583.38  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.other.user  quota= 583.38  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.other.user.nonus  quota= 346.562  requested= 5087\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.other.user.nonus  quota= 346.562  allocated= 346.562  requested= 4740.44\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.other.user.t3  quota= 231.042  requested= 18\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.other.user.t3  quota= 231.042  allocated= 18  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.other.user.us  quota= 5.77604  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.other.user.us  quota= 5.77604  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other.user  surplus= 802.198  subtree-requested= 4740.44\n10/16/12 21:24:53 group quotas: allocate-surplus (2b): quota-based allocation, group= cms.other.user  requested= 4740.44  surplus= 802.198\n10/16/12 21:24:53 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 4740.44  surplus= 802.198\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other.user.nonus  surplus= 802.198  subtree-requested= 4740.44\n10/16/12 21:24:53 group quotas: allocate-surplus (2b): quota-based allocation, group= cms.other.user.nonus  requested= 4740.44  surplus= 802.198\n10/16/12 21:24:53 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 4740.44  surplus= 802.198\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other.user.nonus allocated surplus= 802.198  allocated= 1148.76  requested= 3938.24\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other.user allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (3): group= cms.other.user  surplus= 0  subtree_requested= 3938.24\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other  surplus= 1750.14  subtree-requested= 3938.24\n10/16/12 21:24:53 group quotas: allocate-surplus (2b): quota-based allocation, group= cms.other  requested= 3938.24  surplus= 1750.14\n10/16/12 21:24:53 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 3938.24  surplus= 1750.14\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other.user  surplus= 1750.14  subtree-requested= 3938.24\n10/16/12 21:24:53 group quotas: allocate-surplus (2b): quota-based allocation, group= cms.other.user  requested= 3938.24  surplus= 1750.14\n10/16/12 21:24:53 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 3938.24  surplus= 1750.14\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other.user.nonus  surplus= 1750.14  subtree-requested= 3938.24\n10/16/12 21:24:53 group quotas: allocate-surplus (2b): quota-based allocation, group= cms.other.user.nonus  requested= 3938.24  surplus= 1750.14\n10/16/12 21:24:53 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 3938.24  surplus= 1750.14\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other.user.nonus allocated surplus= 1750.14  allocated= 2898.9  requested= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other.user allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (3): group= cms.other  surplus= 0  subtree_requested= 2188.1\n10/16/12 21:24:53 group quotas: fairshare (1): group= cms.prod  quota= 1458.45  requested= 1423\n10/16/12 21:24:53 group quotas: fairshare (2): group= cms.prod  quota= 1458.45  allocated= 1423  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms  surplus= 3222.04  subtree-requested= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (2a): direct allocation, group= cms  requested= 2188.1  surplus= 3222.04\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other  surplus= 2188.1  subtree-requested= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (2a): direct allocation, group= cms.other  requested= 2188.1  surplus= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other.user  surplus= 2188.1  subtree-requested= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (2a): direct allocation, group= cms.other.user  requested= 2188.1  surplus= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= cms.other.user.nonus  surplus= 2188.1  subtree-requested= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (2a): direct allocation, group= cms.other.user.nonus  requested= 2188.1  surplus= 2188.1\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other.user.nonus allocated surplus= 2188.1  allocated= 5087  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other.user allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms.other allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group cms allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (3): group= cms  surplus= 1033.94  subtree_requested= 0\n10/16/12 21:24:53 group quotas: fairshare (1): group= other  quota= 324.1  requested= 1173\n10/16/12 21:24:53 group quotas: fairshare (2): group= other  quota= 324.1  allocated= 324.1  requested= 848.9\n10/16/12 21:24:53 group quotas: fairshare (1): group= other.hcc  quota= 324.1  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (2): group= other.hcc  quota= 324.1  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= other  surplus= 324.1  subtree-requested= 848.9\n10/16/12 21:24:53 group quotas: allocate-surplus (2b): quota-based allocation, group= other  requested= 848.9  surplus= 324.1\n10/16/12 21:24:53 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 848.9  surplus= 324.1\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group other allocated surplus= 324.1  allocated= 648.2  requested= 524.8\n10/16/12 21:24:53 group quotas: fairshare (3): group= other  surplus= 0  subtree_requested= 524.8\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= &lt;none&gt;  surplus= 4274.94  subtree-requested= 524.8\n10/16/12 21:24:53 group quotas: allocate-surplus (2a): direct allocation, group= &lt;none&gt;  requested= 524.8  surplus= 4274.94\n10/16/12 21:24:53 group quotas: allocate-surplus (1): group= other  surplus= 524.8  subtree-requested= 524.8\n10/16/12 21:24:53 group quotas: allocate-surplus (2a): direct allocation, group= other  requested= 524.8  surplus= 524.8\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group other allocated surplus= 524.8  allocated= 1173  requested= 0\n10/16/12 21:24:53 group quotas: allocate-surplus (4): group &lt;none&gt; allocated surplus= 0  allocated= 0  requested= 0\n10/16/12 21:24:53 group quotas: fairshare (3): group= &lt;none&gt;  surplus= 3750.14  subtree_requested= 0\n10/16/12 21:24:53 group quotas: group= &lt;none&gt;  quota= 3241  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms  quota= 2916.9  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: group= other  quota= 324.1  requested= 1173  allocated= 1173  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.lcgadmin  quota= 291.69  requested= 22  allocated= 22  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.other  quota= 1166.76  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.prod  quota= 1458.45  requested= 1423  allocated= 1423  unallocated= 0\n10/16/12 21:24:53 group quotas: group= other.hcc  quota= 324.1  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.other.prio  quota= 583.38  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.other.user  quota= 583.38  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.other.user.nonus  quota= 346.562  requested= 5087  allocated= 5087  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.other.user.t3  quota= 231.042  requested= 18  allocated= 18  unallocated= 0\n10/16/12 21:24:53 group quotas: group= cms.other.user.us  quota= 5.77604  requested= 0  allocated= 0  unallocated= 0\n10/16/12 21:24:53 group quotas: groups= 12  requesting= 5  served= 5  unserved= 0  slots= 3241  requested= 7723  allocated= 7723  surplus= 3750.14\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Oct-16 22:41:24 by bbockelm:</em> <br/>\n\nI think I see the issue.  In Matchmaker::hgq_fairshare, stage (1), we print the quota and requested for that group.  We then calculate the allocated:\n\n<p>group-&gt;allocated = std::min(group-&gt;requested, group-&gt;quota);\n\n</p><p>and then:\n\n</p><p>surplus = group-&gt;quota - group-&gt;allocated;\n\n</p><p>This is wrong - the quota is the sum of the quota for this group and all its children, but the requested is only the requested from this group.  Hence, the surplus is much too large.\n\n</p><p>I propose something along the lines of the following patch.\n\n</p><p></p><div class=\"verbatim\">\n<pre>diff --git a/src/condor_negotiator.V6/matchmaker.cpp b/src/condor_negotiator.V6/matchmaker.cpp\nindex 053c082..2c3587c 100644\n--- a/src/condor_negotiator.V6/matchmaker.cpp\n+++ b/src/condor_negotiator.V6/matchmaker.cpp\n@@ -1848,13 +1848,22 @@ void Matchmaker::hgq_assign_quotas(GroupEntry* group, double quota) {\n     dprintf(D_FULLDEBUG, \"group quotas: group %s assigned quota= %g\\n\", group-&gt;name.c_str(), group-&gt;quota);\n }\n\n+double hgq_get_tree_requested(GroupEntry* group) {\n+    double requested = group-&gt;requested;\n+    for (unsigned long j = 0;  j &lt; group-&gt;children.size();  ++j) {\n+        GroupEntry* child = group-&gt;children[j];\n+        requested += hgq_get_tree_requested(child);\n+    }\n+    return requested;\n+}\n\n double Matchmaker::hgq_fairshare(GroupEntry* group) {\n-    dprintf(D_FULLDEBUG, \"group quotas: fairshare (1): group= %s  quota= %g  requested= %g\\n\",\n-            group-&gt;name.c_str(), group-&gt;quota, group-&gt;requested);\n+    double initial_subtree_requested = hgq_get_tree_requested(group)\n+    dprintf(D_FULLDEBUG, \"group quotas: fairshare (1): group= %s  quota= %g  requested= %g subtree_requested= %g\\n\",\n+            group-&gt;name.c_str(), group-&gt;quota, group-&gt;requested, initial_subtree_requested);\n\n     // Allocate whichever is smallest: the requested slots or group quota.\n-    group-&gt;allocated = std::min(group-&gt;requested, group-&gt;quota);\n+    group-&gt;allocated = std::min(initial_subtree_requested, group-&gt;quota);\n\n     // update requested values\n     group-&gt;requested -= group-&gt;allocated;\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Oct-17 11:56:25 by bbockelm:</em> <br/>\n\nAnother case:\n\n<p></p><div class=\"verbatim\">\n<pre>10/17/12 11:20:08 group quotas: group= &lt;none&gt;  cquota= 0  static= 0  accept= 1  quota= 3078  req= 0  usage= 0\n10/17/12 11:20:08 group quotas: group= cms  cquota= 0.9  static= 0  accept= 1  quota= 2770.2  req= 0  usage= 0\n10/17/12 11:20:08 group quotas: group= other  cquota= 0.1  static= 0  accept= 1  quota= 307.8  req= 1127  usage= 874\n10/17/12 11:20:08 group quotas: group= other.hcc  cquota= 1  static= 0  accept= 1  quota= 307.8  req= 0  usage= 0\n(removing the other CMS stuff)\n</pre></div>\n\n\n<p>The code will correctly determine other that group other has zero surplus.  Then it recurses to other.hcc and determine it has a surplus of 307.8.  It then adds that surplus to the parent group, so the group gets a total quota of 615.6.\n\n</p><p>I think the code doesn't clearly distinguish between \"quota\" and \"subtree quota\".  In the above example, other should have a quota of zero, but has a subtree quota of 307.8.\n\n</p><p></p><hr/>\n<em>2012-Oct-17 16:57:55 by eje:</em> <br/>\n\nI need more detailed context on the current configuration and the desired/expected behavior.\n\n<p>Can you attach the config, and/or define how to log into red-condor.unl.edu?\n\n</p><p></p><hr/>\n<em>2012-Oct-18 14:21:11 by eje:</em> <br/>\n\nThe problem appears to be changing default of  NEGOTIATOR_ALLOW_QUOTA_OVERSUBSCRIPTION from False to True on <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3040\" onclick=\"get_ticket_and_populate_wrapper('3040'); return false;\" title=\"change the defaults for HGQ sort order and oversubscription\">#3040</a></span>\n\n<p>When using dynamic quotas, should set:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_ALLOW_QUOTA_OVERSUBSCRIPTION = False </pre></div>\n\n\n<p>We may want to revisit that default value.  Fermi is the only customer I'm aware of who uses oversubscribed quotas.\n</p><hr/>\n<em>2012-Oct-25 17:52:16 by johnkn:</em> <br/>\n\nBulk change of target version from v070806 to v070807 using ./ticket-target-mover.\n<hr/>\n<em>2012-Dec-19 09:30:47 by johnkn:</em> <br/>\n\nBulk change of target version from v070807 to v070808 using ./ticket-target-mover.\n<hr/>\n<em>2013-Mar-28 17:16:00 by johnkn:</em> <br/>\n\nBulk change of target version from v070808 to v070809 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "todo", "last_change": "2014-Jul-28 12:59", "status": "abandoned", "created": "2012-Oct-16 22:09", "fixed_version": "2012-Oct-16 22:09", "broken_version": "v070805", "priority": "2", "subsystem": "", "assigned_to": "eje", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tstclair@redhat.com, eje@cs.wisc.edu", "due_date": ""}