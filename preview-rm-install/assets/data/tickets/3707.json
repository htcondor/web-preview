{"id": 3707, "title": "Ticket #3707: Fix DAGMan recovery for 7.8 --> 8.0", "description": "<blockquote>\nFix DAGMan so that it is not necessary to condor_rm all DAGs before upgrading from HTCondor version &lt;= 7.8.x to HTCondorversion &gt;= 8.0.0</blockquote>", "remarks": "<blockquote>\n<em>2013-Jun-19 11:15:02 by wenger:</em> <br/>\n\nI just was thinking about this.  If I'm right about what's happening in LIGO's case, I think we could fix it by having DAGMan automatically turn off use of the default node log if the submit file version is earlier than 7.9.1 (or whenever that feature was introduced).\n\n<p>I guess we should also post something on htcondor-users...\n\n</p><p></p><hr/>\n<em>2013-Jun-19 11:53:47 by nwp:</em> <br/>\n\nSome parts of the feature were introduced in 7.9.0, and some in 7.9.1  Hopefully, no one is still using 7.9.0 and upgrading to 8.0.0.  That might be bad.\n\n<p></p><hr/>\n<em>2013-Jun-19 12:19:11 by nwp:</em> <br/>\n\nPushed onto <code>V8_0-gittrac_3707-branch</code>.  Batlab seems to be messed up now, so builds are failing.  Hopefully that will clear up soon and we can verify that the fix does not break anything else.\n\n<p></p><hr/>\n<em>2013-Jun-24 11:30:32 by wenger:</em> <br/>\n\nI mean to review this later today.  Nathan, have you actually run a test \"live\" upgrade to make sure it works?\n\n<p></p><hr/>\n<em>2013-Jun-24 16:18:50 by nwp:</em> <br/>\n\nNo, I did not do such a test.  I can finally build it now and am creating such a set up.\n\n<p></p><hr/>\n<em>2013-Jun-24 17:13:07 by wenger:</em> <br/>\n\nNathan, can you remove the update notes commit?  That has to go into v8.0.0 so it can get immediately pushed out to the web.  I sent a modified version of your text to Karen, and she's going to take care of that end of things.  But I guess if the change is still on the V8_0-gittrac_3707-branch I think it will cause a conflict at some point...\n\n<p></p><hr/>\n<em>2013-Jun-24 17:41:18 by wenger:</em> <br/>\n\n<strong class=\"two\">CODE REVIEW</strong>\n\n<p>I'd prefer the structure to be like this:\n\n</p><p></p><pre>  if (!submitFileVersion.built_since_version(7,9,1)) {\n    ...\n  } else {\n    // Check for existence of default log\n  }\n</pre>\n\n<p>because I think checking the submit file version is a little cleaner; and we can have the else because if the submit file version check \"fails\" we don't need to check for the existence of the default log file.\n\n</p><p>Also, if the submit file version is 7.9.0, maybe we should print a warning because we're not totally sure what will happen in that case...  So maybe:\n\n</p><p></p><pre>  if (!submitFileVersion.built_since_version(7,9,1)) {\n    ...\n  } else {\n    if (&lt;default log doesn't exist&gt;) {\n      // turn off default log\n    } else if (submitFileVersion.compare_versions(7,9,0) == 0) {\n      // print warning\n    }\n  }\n</pre>\n\n<p></p><hr/>\n<em>2013-Jun-25 11:01:26 by nwp:</em> <br/>\n\nI verified that my patch works: I created a 7.8.8 HTCondor, and a post-8.0 HTcondor.  I started my DAGMan under 7.8.8, then ran <code>condor_off -master</code> to kill it.  I updated to the later version and ran <code>condor_master</code> to start up HTCondor.  The DAGMan job started up automatically. In the <code>dagman.out</code> file, we see that the code worked:\n<div class=\"code\">\n<pre class=\"code\">06/25/13 09:52:42 Default node log does not exist. Falling back to 7.8 behavior of not using the default node log\n06/25/13 09:52:42 Submit file version indicates submit is too old. Falling back to 7.8 behavior of not using the default node log\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Jun-25 11:02:27 by nwp:</em> <br/>\n\nMade changes from Kent's review and pushed them onto <code>V8_0-gittrac_3707-branch</code>.\n\n<p></p><hr/>\n<em>2013-Jun-25 12:39:53 by smoler:</em> <br/>\n\nSee SHA1\n45a9bac17808c3ae28ca3e86dffee03808876daa\nfor the commit that updates the 8.0.0 manual's upgrade version history item that describes how to handle the problem for 7.8 to 8.0.0 upgrades.\n\n<p></p><hr/>\n<em>2013-Jul-03 14:32:25 by wenger:</em> <br/>\n\n<strong class=\"two\">CODE REVIEW</strong>\n\n<p>I just added one comment to clarify a piece of the code that I thought was potentially confusing.\n\n</p><p>Go ahead and merge...</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-03 14:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/04f64359628891856374a3d4d58fa20d14488404\">[36759]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3707\" onclick=\"get_ticket_and_populate_wrapper('3707'); return false;\" title=\"Fix DAGMan recovery for 7.8 --&gt; 8.0\">#3707</a></span>: Just added a comment to clarify one aspect of the new code.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-25 10:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/413b23002bbd10378a4ee1a4c69775411ece3968\">[36671]</a></span>: Make changes from Kent's review <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3707\" onclick=\"get_ticket_and_populate_wrapper('3707'); return false;\" title=\"Fix DAGMan recovery for 7.8 --&gt; 8.0\">#3707</a></span> Make the following changes: Nathan, can you remove the update notes commit? That has to go into v8.0.0 so it can get immediately pushed out to the web. I send a modified version of your text to Karen, and she's going to take care of that end of things. But I guess\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-19 12:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/14adbdd6dbb4d5bc05d5d37905593b4fcb3cb70a\">[36624]</a></span>: Fix DAGMan problems on upgrade from 7.8 <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3707\" onclick=\"get_ticket_and_populate_wrapper('3707'); return false;\" title=\"Fix DAGMan recovery for 7.8 --&gt; 8.0\">#3707</a></span> Revise note about problems with DAGMan on upgrade. Add version history  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Aug-04 11:38", "status": "resolved", "created": "2013-Jun-19 11:03", "fixed_version": "2013-Jun-19 11:03", "broken_version": "v080000", "priority": "1", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "#3636", "creator": "nwp", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu johnkn@cs.wisc.edu tannenba@cs.wisc.edu anderson@ligo.caltech.edu", "due_date": ""}