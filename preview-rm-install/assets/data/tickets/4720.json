{"id": 4720, "title": "Ticket #4720: Files fail to spool using python bindings to an 8.0.x host", "description": "<blockquote>\n<span class=\"section\"><h2>Symptoms of the Error</h2></span>\nUsing the condor_ce_trace tool against an 8.0.x host, an error occurs when trying to spool files:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">RuntimeError: DCSchedd::spoolJobFiles:7002:File transfer failed for target job 790.0: Failed to receive GoAhead message from 128.230.171.6.\n</pre></div>\n\n\n<p>condor_ce_trace uses the python bindings to submit to the remote schedd. Using `condor_submit -spool` and `condor_transfer_data` appears to work ok.\n\n</p><p><span class=\"section\"></span></p><h2>Cause of the Error</h2>\nFor file transfer commands, if the DCSchedd object doesn't know the version of the schedd, it assumes it's the same version as itself. Thus, it assumes the schedd supports the disk-load-based throttling protocol change introduced in HTCondor 8.1.0.\n\n<p>The python bindings construct a DCSchedd object by providing it with only the sinful string of the schedd. Thus, the DCSchedd object doesn't know what version the schedd is.\n\n</p><p><span class=\"section\"></span></p><h2>Reproducing the Error</h2>\nGrab htcondor-ce-client from the 'osg' repo to get the condor_ce_trace tool and run: <div class=\"code\">\n<pre class=\"code\">condor_ce_trace --debug its-condor-ce.syr.edu</pre></div>\n\n\n<p>Alternatively, use condor_submit using the schedd's sinful string: </p><div class=\"code\">\n<pre class=\"code\">condor_submit -spool -address &lt;sinful string&gt;</pre></div>\n\n\n<p><span class=\"section\"></span></p><h2>Proposed Solution</h2>\nThe security negotiation that occurs at the start of most CEDAR commands (and forced for these file transfer commands) includes an exchange of the versions of the peers. The DCSchedd object could extract the version information from the CEDAR layer when it's not already known.</blockquote>", "remarks": "<blockquote>\n<em>2014-Nov-14 10:22:35 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>For the most part, we do know the version of the schedd in the python bindings (but the only real way to solve this is with querying CEDAR, of course).\n\n</p><p>However, I don't see any way to feed this to the DCSchedd object.  Is there something I'm missing?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Nov-14 12:06:39 by jfrey:</em> <br/>\n\nI see two ways you could feed the version info into the DCSchedd object in the python bindings. First, you can instantiate a full DCSchedd object in the constructor of the python Schedd struct and keep it around for later use. Second, you could create a tiny daemon ad in spoolJobFiles() with the name, address, and version of the schedd and feed that into the DCSchedd object you instantiate there.\n\n<p></p><hr/>\n<em>2014-Nov-17 08:48:32 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>I think I like your proposed solution better - the remote daemon just told us its version during authentication; might as well use it!\n\n</p><p>I put together a small implementation and pushed it to V8_3-gt4720.  Is this the approach you were thinking about?  It seems to test alright.\n\n</p><p>Note there's likely an even better solution here - the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> object could do the same thing, right?  Then, we wouldn't need to call FileTransfer::setPeerVersion at all.\n\n</p><p>However, that seems to be a bit bigger of a change than I want to do right now.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Nov-17 19:59:26 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>Can I request a backport to 8.2.x?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Nov-18 11:45:02 by jfrey:</em> <br/>\n\nThis fix is in 8.2.\n\n<p></p><hr/>\n<em>2014-Nov-18 14:48:36 by bbockelm:</em> <br/>\n\nApologies, I looked at the branch list wrong.  Thanks!\n\n<p>Reviewing the code, I see no issues.  I notice you simplified the patch by putting up with a bit more manual pointer management than I like.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-20 11:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/771764f5b8f8dacf682dc43628543aec31f9d6fe\">[41703]</a></span>: minor 8.2.5 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4720\" onclick=\"get_ticket_and_populate_wrapper('4720'); return false;\" title=\"Files fail to spool using python bindings to an 8.0.x host\">#4720</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-17 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbc644c7be15f0f22ff2e817fc2610be85d41eeb\">[41655]</a></span>: Docs for file transfer failure with python bindings bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4720\" onclick=\"get_ticket_and_populate_wrapper('4720'); return false;\" title=\"Files fail to spool using python bindings to an 8.0.x host\">#4720</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-17 14:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/67a1f0c3d183dbf443a850be81b87953f764d216\">[41654]</a></span>: File transfer failure with python bindings to 8.0 schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4720\" onclick=\"get_ticket_and_populate_wrapper('4720'); return false;\" title=\"Files fail to spool using python bindings to an 8.0.x host\">#4720</a></span> When the DCSchedd object is used to perform file transfers, if it doesn't know the version of the schedd, it assumes the schedd is the same version as itself. This can lead to failures if the schedd is old enough to not know about file transfer\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-17 08:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7251ed21012f31a7c89b392b6fd057c03bfdaa37\">[41650]</a></span>: For versioned spooling protocol, use version from CEDAR socket. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4720\" onclick=\"get_ticket_and_populate_wrapper('4720'); return false;\" title=\"Files fail to spool using python bindings to an 8.0.x host\">#4720</a></span> Previously, if DCSchedd was created from a sinful string, it would assume the remote side was the same version as the local one (the version was taken when it contacted the collector). This broke any protocol versioning.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Nov-20 09:36", "status": "resolved", "created": "2014-Nov-13 15:07", "fixed_version": "2014-Nov-13 15:07", "broken_version": "v080200", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "jfrey", "derived_from": "#4555", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu, cat@cs.wisc.edu", "due_date": ""}