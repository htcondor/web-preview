{"id": 5663, "title": "Ticket #5663: Log TCP statistics for file transfers", "description": "<blockquote>\nHTCondor is now transfers petabytes of files in the OSG over many WANs.  However, we have no visibility into the performance of these transfers.  There is a socket option on Linux, TCP_INFO, which returns many low-level statistics about the performance of a single network socket.\n\n<p>In this ticket, we will extract these statistics on a per-file-sandbox transfer, and log them to a distinct file for later processing.\n\n</p><p>We will add a new dprintf category, D_STATS, and allow the starter and shadow (via the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> class), to log these statistics to this category.  By default, both the starter and shadow will log to a file name <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=XferStatsLog\" title=\"Xfer Stats Log\">XferStatsLog</a></span>, one line per transfer.  This line will contain human readable statistics the the job id, number of bytes up/dowloaded, the peer IP address of the connection, and the low-level TCP statistics.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-14 15:11:28 by gthain:</em> <br/>\n\nWith this ticket, by default we create a new HTCondor log file, in the usual $(LOG) directory, called <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=XferStatsLog\" title=\"Xfer Stats Log\">XferStatsLog</a></span>.  This file is rotated every time it reaches a configurable size limit, by default 10Mb.  This file contains lines like the following (wrapped in this ticket for readability, but presented in one line in the log file for parseability.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">6/09/16 14:53:10 File Transfer Download: JobId: 626.19 files: 7 \\\\\n bytes: 391021382 seconds: 1.0 dest: 128.105.14.141 rto: 203000 ato: 40000 snd_mss: 33408 \\\\\n rcv_mss: 65468 unacked: 1 sacked: 0 lost: 0 retrans: 0 fackets: 0 pmtu: 65520 \\\\\n rcv_ssthresh: 1964430 rtt: 3000 snd_ssthresh: 2147483647 snd_cwnd: 10 \\\\\n advmss: 65483 reordering: 3 rcv_rtt: 1000 rcv_space: 4451824 total_retrans: 0\n</pre></div>\n\n\n<p>This line starts with a timestamp the transfer successfully finished, the direction of the transfer with respect to this machine (Download or Upload), and the condor job id.  Any further job attributes can be extracted from the condor_history command on the schedd's history file, or the startd's startd_history file on the execute side.  This is then followed by the number of files transferred, the total size of the files, and the IP address of the peer, either IPv4 or IPv6.  After these items, the contents of the Linux TCP_INFO getsockopt call are returned.  These are only fully documented in the Linux kernel source, but many would have meaning to a network engineer.  Probably the most important counters here are \"lost\", the number of packets lost, and \"retrans\", the number of re-transmitted packets, though the computed path mtu (pmtu) may also be interesting.\n\n</p><p>We would expect remote transfers to have roughly the same performance and statistics per site that we transfer to, it is up to a higher level tool to extract these data, and present them in a more user friendly format.\n\n</p><p>In vanilla universe, this file is written by the starter on the execute side, and by the shadow on the submit side.  The default file name is set by the STARTER_STATS_LOG and SHADOW_STATS_LOG config knobs, respectively, and the maximum size before rotation is set by MAX_STARTER_STATS_LOG and MAX_SHADOW_STATS_LOG.  Alternatively, and admin could add D_STATS to the SHADOW_DEBUG or STARTER_DEBUG and have these lines interweaved into the usual log files.\n\n</p><p>When the file transfer is initiated from a user-owned process, like the c-gahp or condor_submit -remote, who don't have permissions to write to a condor-owned log file, these lines will be written to their usual debug files.\n\n</p><p>Setting STARTER_STATS_LOG or SHADOW_STATS_LOG to /dev/null disables the writing of the log files.\n\n</p><p></p><hr/>\n<em>2016-Jun-17 09:09:01 by tannenba:</em> <br/>\n\nAbove you say this data is written by the shadow and the starter... what about file transfers between, say, the c-gahp and the schedd?  I am thinking about capturing all the file transfer network data between OSG and CMS glideinwms factories and HTCondor-CEs....\n\n<p></p><hr/>\n<em>2016-Jun-17 09:24:47 by tannenba:</em> <br/>\n\nAn article that provides some insights on the meaning of these various kernel TCP session stats is at\n<a class=\"external\" href=\"http://linuxgazette.net/136/pfeiffer.html\">http://linuxgazette.net/136/pfeiffer.html</a>\n\n<p></p><hr/>\n<em>2016-Jun-28 16:57:19 by wenger:</em> <br/>\n\nAre MAX_STARTER_STATS_LOG and MAX_SHADOW_STATS_LOG implemented?  They're not in the param table, and they don't show up anywhere in the code or binaries...\n\n<p></p><hr/>\n<em>2016-Jun-29 08:35:34 by gthain:</em> <br/>\n\nMAX_STARTER_STATS_LOG and MAX_SHADOW_STATS_LOG are implemented as synthetic knobs within the param system, so they don't show up in the param table.\n\n<p></p><hr/>\n<em>2016-Jun-29 09:26:30 by wenger:</em> <br/>\n\nWhat are the defaults for them?\n\n<p></p><hr/>\n<em>2016-Jun-29 09:28:46 by gthain:</em> <br/>\n\nMAX_DEFAULT_LOG, whose default is 10 MB.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=5763\" title=\"Add log file info to the admin section of the manual\">#5763</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd log file info to the admin section of the manual</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-29 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48699\">[48699]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>: Documented this feature.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-29 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48697\">[48697]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>: Documented this feature.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-17 09:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48580\">[48580]</a></span>: Have the C_CGAHP also log file xfer stats <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-07 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48509\">[48509]</a></span>: Add more file transfer stats to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=XferStatsLog\" title=\"Xfer Stats Log\">XferStatsLog</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-06 17:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48371\">[48371]</a></span>: Fix warnings <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-06 11:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48370\">[48370]</a></span>: Fix file transfer stats for 32 bit machines <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-06 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48369\">[48369]</a></span>: Remove file transfer stats from shadow and starter logs <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-05 17:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48366\">[48366]</a></span>: Add File Transfer statistics logging <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5663\" title=\"Log TCP statistics for file transfers\">#5663</a></span> New dprintf category D_STATS added that logs low-level tcp statistics per sandbox transfer. Only works on Linux  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-29 14:00", "status": "resolved", "created": "2016-May-05 15:39", "fixed_version": "2016-May-05 15:39", "broken_version": "v080500", "priority": "1", "subsystem": "FileTransfer", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu, gthain@cs.wisc.edu, wenger@cs.wisc.edu", "due_date": "20160505"}