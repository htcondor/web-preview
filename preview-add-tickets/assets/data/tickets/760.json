{"id": 760, "title": "Ticket #760: Gridmanager bottlenecks affecting BNL stress testing", "description": "<blockquote>\nThe BNL ATLAS group has been conducting Condor-G stress tests with 10,000's of jobs submitted to one Condor-G machine at BNL destined for to 1-4 CEs at UW-Madison. This testing has turned up several scaling problems in the gridmanager daemon. This ticket summarizes the main problems. Sub-tickets will detail individual changes.\n\n<p></p><ul>\n<li><span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=769\" title=\"Gridmanager jobs stuck in endless loop updating schedd\">#769</a></span> Jobs objects waiting for job ad changes to be pushed to schedd can wait extra long due to unrelated changes to job ad.\n</li><li><span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=771\" title=\"Schedd updates in gridmanager causes extra load\">#771</a></span> Job state evaluation sometimes called unnecessarily when job ad changes are pushed to the schedd.\n</li><li><span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=772\" title=\"proxy refresh notification ineffcient in gridmanager\">#772</a></span> A refreshed proxy file causes all related jobs to have their state evaluation called, often unnecessarily.\n</li><li><span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=773\" title=\"Check for GRID_ MONITOR_ NO_ STATUS_ TIMEOUT inefficient\">#773</a></span> Check for GRID_MONITOR_NO_STATUS_TIMEOUT highly inefficient.\n</li><li><span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=775\" title=\"Optimize daemon-core timer code for gridmanager usage\">#775</a></span> Simple optimizations to daemon-core timer code for 10,000s of timers that get reset frequently.\n</li></ul>\n\n<p>The main problems stem from the gridmanager's extensive use of daemon-core timers as a form of callback. Each Job object has a timer registered for its state evaluation function. When other parts of the code detect events that may be of interest to a job, they reset the job's state evaluation timer to fire immediately. Most of the time, the job's timer is set to TIMER_NEVER (i.e. don't fire), although sometimes it's set to go off in the near future (to do a periodic probe of the remote job's status, for instance).\n\n</p><p>Daemon-core keeps its timers in a linked list sorted by when they will fire next. This doesn't scale well when there are 10,000s of timers that get reset frequently. It's particularly bad when an event occurs that is of potential interest to all jobs, like a proxy file being refreshed. We have observed the gridmanager take 8 minutes to reset timers for 65,000 jobs to fire immediately.\n\n</p><p>Floods of timer resets like this present an additional problem of delaying other events in the gridmanager. When 65,000 timers are reset to fire immediately, previously-registered timers that will fire in 2 seconds can be delayed by 10s of minutes. Examples of delayed timers we saw in our testing:\n</p><ul>\n<li>Child Alive commands delayed more than 40 minutes, causing the schedd to kill the gridmanager, believing it to the hung.\n</li><li>Gahp RESULTS commands that should occur every minute occurring every 20 minutes.\n</li><li>Updates to the schedd that are scheduled for 5 seconds into the future delayed 15-20 minutes.\n</li><li>When a schedd update or gahp command completes, a job waiting for that event doesn't have its state evaluation called for 20-30 minutes.\n</li></ul>\n\n<p>Many times when a job's timer is reset to 0, its state evaluation function doesn't need to be called immediately, preceding events like Child Alives or schedd updates. Rather, the state evaluation needs to be called in the near future.\n\n</p><p>We need a way to handle calling of jobs' state evaluation that is efficient and won't cause prolonged delays for other tasks in the gridmanager. We could add low-priority timers to daemon-core. This would minimize the changes required in the gridmanager. Or we could use a modified <span class=\"quote\">SelfDrainingQueue</span> for job state evaluations. This would require potentially extensive changes in the gridmanager.\n\n</p><p>There are a couple changes we can make short of re-architecting how the gridmanager uses timers. First, there are a couple places where a large number of job timers are reset unnecessarily. These are when a proxy is refreshed (insert ticket number) and when a grid monitor report arrives (insert ticket number). Also, there are a couple minor changes that can be made to daemon-core's timer code to optimize the gridmanager's use of it (insert ticket number).</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Oct-10 10:04:47 by jfrey:</em> <br/>\n\nAfter implementing the changes in <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=769\" title=\"Gridmanager jobs stuck in endless loop updating schedd\">#769</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=771\" title=\"Schedd updates in gridmanager causes extra load\">#771</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=772\" title=\"proxy refresh notification ineffcient in gridmanager\">#772</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=773\" title=\"Check for GRID_ MONITOR_ NO_ STATUS_ TIMEOUT inefficient\">#773</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=775\" title=\"Optimize daemon-core timer code for gridmanager usage\">#775</a></span>, the gridmanager can easily manage 35,000 jobs going to a single CE.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=769\" title=\"Gridmanager jobs stuck in endless loop updating schedd\">#769</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nGridmanager jobs stuck in endless loop updating schedd</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=771\" title=\"Schedd updates in gridmanager causes extra load\">#771</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSchedd updates in gridmanager causes extra load</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=772\" title=\"proxy refresh notification ineffcient in gridmanager\">#772</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nproxy refresh notification ineffcient in gridmanager</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=773\" title=\"Check for GRID_ MONITOR_ NO_ STATUS_ TIMEOUT inefficient\">#773</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCheck for GRID_ MONITOR_ NO_ STATUS_ TIMEOUT inefficient</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=775\" title=\"Optimize daemon-core timer code for gridmanager usage\">#775</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nOptimize daemon-core timer code for gridmanager usage</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "", "type": "todo", "last_change": "2010-Jan-12 15:46", "status": "resolved", "created": "2009-Sep-22 16:53", "fixed_version": "2009-Sep-22 16:53", "broken_version": "v070302", "priority": "4", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "xzhao@bnl.gov", "due_date": ""}