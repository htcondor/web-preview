{"id": 3507, "title": "Ticket #3507: Handle OpenStack's stopped state.", "description": "<blockquote>\nHTCondor, when managing an instance on an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> resource, will report that instance as running even after it has shut itself down.  This is because <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> reports the instance as stopped, apparently disrespecting the\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InstanceInstantiatedShutdownBehavior\" title=\"Instance Instantiated Shutdown Behavior\">InstanceInstantiatedShutdownBehavior</a></span> flag.  (HTCondor sets this flag to 'terminate' for all instances, specifically to avoid having to worry about reporting something intelligent when an instance is no longer costing the user money, but its persistent data is.)\n\n<p>Tony, we believe that treating 'shutoff' instances (see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3367\" onclick=\"get_ticket_and_populate_wrapper('3367'); return false;\" title=\"Condor thinks VMs in OpenStack's &quot;SHUTOFF&quot; state are running\">#3367</a></span>) and 'stopped' instances identically will suffice to handle this problem.\n\n</p><p>If user demand subsequently materializes, we can revisit this decision, possibly using the HTCondor suspended state to more intuitively/accurately approximate the actual state of the instance.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Feb-21 14:38:58 by burt:</em> <br/>\n\nI found this comment in the nova source (nova/api/ec2/cloud.py):\n\n<p></p><div class=\"verbatim\">\n<pre># Note(maoy): We do not provide EC2 compatibility\n# in shutdown_terminate flag behavior. So we ignore\n# it here.\n</pre></div>\n\n\n<p>I'll try to look deeper into this from the <span class=\"quote\">OpenStack</span> side.\n\n</p><p></p><hr/>\n<em>2013-Mar-01 11:16:42 by tlmiller:</em> <br/>\n\nIndependent testing has revealed problems:\n\n<p></p><div class=\"restricted\">\n<pre>Hi Tony,\n\nI've put logs here:\n\n/afs/cern.ch/user/a/alahiff/public/logs3.tgz\n\nI ended up with 5 VMs in the stopped state (*), which Condor thinks are no\nlonger running:\n\n[root@lcggwms01 ~]# condor_q -global\nAll queues are empty\n\nRegards,\nAndrew.\n\n(*)\n-bash-3.2$ euca-describe-instances   | grep lcggwms | grep INST\nINSTANCE        i-000006a7      ami-0000000b\nserver-90616e17-9538-483f-8c04-c564dc492bcc\nserver-90616e17-9538-483f-8c04-c564dc492bcstopped       SSH_lcggwms01 gridpp\nrl ac uk 9618_schedd_glideins2 lcggwms01 gridpp rl ac uk 688 1 1362073945\n0               m1.large        2013-02-28T19:35:15.000Z        nova\nmonitoring-disabled     192.168.32.17   192.168.32.17\ninstance-store\nINSTANCE        i-000006a5      ami-0000000b\nserver-a6b1c446-d81b-40fc-ac34-3897bad7fa44\nserver-a6b1c446-d81b-40fc-ac34-3897bad7fa4stopped       SSH_lcggwms01 gridpp\nrl ac uk 9618_schedd_glideins2 lcggwms01 gridpp rl ac uk 685 1 1362073462\n0               m1.large        2013-02-28T19:30:15.000Z        nova\nmonitoring-disabled     192.168.32.14   192.168.32.14\ninstance-store\nINSTANCE        i-000006a3      ami-0000000b\nserver-bb86cb99-13a2-4688-8c72-47a6fe225950\nserver-bb86cb99-13a2-4688-8c72-47a6fe22595stopped       SSH_lcggwms01 gridpp\nrl ac uk 9618_schedd_glideins2 lcggwms01 gridpp rl ac uk 687 0 1362073885\n0               m1.large        2013-02-28T19:29:45.000Z        nova\nmonitoring-disabled     192.168.32.9    192.168.32.9\ninstance-store\nINSTANCE        i-000006a6      ami-0000000b\nserver-26ffdb48-980d-4bf5-85da-67817d9c4658\nserver-26ffdb48-980d-4bf5-85da-67817d9c465stopped       SSH_lcggwms01 gridpp\nrl ac uk 9618_schedd_glideins2 lcggwms01 gridpp rl ac uk 686 2 1362073824\n0               m1.large        2013-02-28T19:30:20.000Z        nova\nmonitoring-disabled     192.168.32.16   192.168.32.16\ninstance-store\nINSTANCE        i-000006a0      ami-0000000b\nserver-10019119-d891-40ee-af96-a8cc6fb46495\nserver-10019119-d891-40ee-af96-a8cc6fb4649stopped       SSH_lcggwms01 gridpp\nrl ac uk 9618_schedd_glideins2 lcggwms01 gridpp rl ac uk 685 2 1362073462\n0               m1.large        2013-02-28T19:14:45.000Z        nova\nmonitoring-disabled     192.168.32.7    192.168.32.7\ninstance-store\n</pre>\n</div><hr/>\n<em>2013-Mar-01 11:43:08 by tlmiller:</em> <br/>\n\nI found a serious bug because of these logs, and will be fixing it shortly.  However, I don't know if it actually caused the problem. :(\n\n<p></p><hr/>\n<em>2013-Mar-12 15:12:38 by tlmiller:</em> <br/>\n\nTony Tiradani replied on Mar 11:\n\n<p></p><div class=\"restricted\"><pre>&gt;&gt; (2) I fixed a bug as a result of the problem you(r associate) found with\n&gt;&gt;    how HTCondor handles OpenStack's stopped state, but I wasn't able to\n&gt;&gt;    determine if it actually fixed the problem.  Do you know anything?\n&gt;&gt;    about that?\n&gt; Initial testing showed that that fixed all known issues on GridPP (Imperial\n&gt; College, England).  We installed on HLT (the High Level Trigger farm at CERN\n&gt; where I have been doing all my work) and it looks like it solved those\n&gt; issues as well.\n</pre></div></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-13 15:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35139\">[35139]</a></span>: 7.9.5 version history item: minor single word change ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3507\" onclick=\"get_ticket_and_populate_wrapper('3507'); return false;\" title=\"Handle OpenStack's stopped state.\">#3507</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-13 13:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35135\">[35135]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3507\" onclick=\"get_ticket_and_populate_wrapper('3507'); return false;\" title=\"Handle OpenStack's stopped state.\">#3507</a></span>) Document 'stopped' state fix for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span>.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-01 11:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35036\">[35036]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3507\" onclick=\"get_ticket_and_populate_wrapper('3507'); return false;\" title=\"Handle OpenStack's stopped state.\">#3507</a></span>) Correct stupid bug.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-21 13:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34990\">[34990]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3507\" onclick=\"get_ticket_and_populate_wrapper('3507'); return false;\" title=\"Handle OpenStack's stopped state.\">#3507</a></span>) Treat 'stopped' like 'shutoff'.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Mar-13 13:46", "status": "resolved", "created": "2013-Feb-21 13:10", "fixed_version": "2013-Feb-21 13:10", "broken_version": "v070904", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "tiradani@fnal.gov, tstclair@redhat.com", "due_date": ""}