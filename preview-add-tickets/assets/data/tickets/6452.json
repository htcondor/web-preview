{"id": 6452, "title": "Ticket #6452: Fix hard link security problems with public HTTP transfers", "description": "<blockquote>\nOur current implementation of public HTTP transfers uses hard links to target files. We need to safe_fopen these target files before creating the hard links, to make sure they do not contain soft links in their paths which could be changed later for nefarious purposes.\n\n<p>Also update code to follow ToddT's 9/22/17 email suggestions, i.e.:\n</p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nI think you should a) impersonate the user and open the file using safe_open(), b) create the hard link as root, c) open the file using safe_open as user apache, d) fstat() the two open file handles and compare the inodes.  The idea here is we want to be certain the file is accessible by the end user, and no shenanigans occurred between the time when we tested accessibility and created the hard link.\n</td></tr></tbody></table></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-28 10:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52870\">[52870]</a></span>: Checked write return val to appease angry compiler (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-28 10:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52866\">[52866]</a></span>: Fixed more memory leak issues (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 10:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52845\">[52845]</a></span>: Removed erroneous delete[] call (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52844\">[52844]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=52842\">[52842]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52843\">[52843]</a></span>, Coverity fixes to mk_cache_links (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52843\">[52843]</a></span>: More Coverity fixes (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-20 17:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52840\">[52840]</a></span>: Added some checks to make Coverity happy (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-09 14:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52776\">[52776]</a></span>: Updated file locks to use blocking mode to obtain locks (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-09 11:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52772\">[52772]</a></span>: Fixed and tested file lock implementation for garbage collection (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-03 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52775\">[52775]</a></span>: Fixed Windows build problem (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-02 15:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52759\">[52759]</a></span>: Checked return vals to remove compiler warnings (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-02 09:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52750\">[52750]</a></span>: Added preening with file locks for public input files (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-01 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52748\">[52748]</a></span>: Reverted files that weren't supposed to go in last commit (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-01 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52747\">[52747]</a></span>: Implemented file locks for concurrency, but git acting string... (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-24 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52641\">[52641]</a></span>: Fixed security issues with hard link creation (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By root )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-23 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52631\">[52631]</a></span>: Secured hard link creation, not tested yet (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Dec-04 15:42", "status": "resolved", "created": "2017-Oct-17 13:01", "fixed_version": "2017-Oct-17 13:01", "broken_version": "v080703", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "coatsworth", "derived_from": "#6356", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, zmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}