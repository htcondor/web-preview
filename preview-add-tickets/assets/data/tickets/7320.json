{"id": 7320, "title": "Ticket #7320: preen can DOS the schedd", "description": "<blockquote>\nWhen spool is large, and there are many directories of spooled job data, preen can monopolize the schedd's queue management interface for a long time.  Beginning with 8.6.9, it does release the connection every 20 seconds.  But it will immediately attempt to make a new connection and keep doing that until it has finished walking the spool directory.\n\n<p>Preen should be changed so that it first walks the spool directory, building a list of 'potentially stale' files mapped by job id.  only then should it contact the schedd to get a list of valid job ids, and then proceed to cleanup the files known to be stale.   It should use the condor_q v2 query command for this purpose\nsince that does not block the schedd, and it should use only a single query command to get all of the job ids.  We should also remove the <code>PREEN_MAX_SCHEDD_CONNECTION_TIME</code> knob, since it will no longer be of use.\n\n</p><p>If it is unable to query the schedd, it should presume that all job spool directories (those that have valid name patterns) are still in use.\n\n</p><p>Additional background can be found <a class=\"external\" href=\"https://docs.google.com/document/d/1_EhYaizyAakBgScbLdbsRLx8XFj6zOLFMJjRTBo7tLE/edit?usp=sharing\">in this design document</a>.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Oct-22 17:47:08 by coatsworth:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p><span class=\"chng\"><a href=\"chngview?cn=58147\">[58147]</a></span> Mostly looks fine. Just a couple nit picks:\n\n</p><p>preen.cpp:\n</p><ul>\n<li>lines 467-521: <code>f2</code>, <code>f3</code> should be more descriptive variable names\n</li><li>line 553: Should be uncommented, we want to see this error\n</li><li>line 566: If <code>maybe_stable</code> is empty, both <code>firstid</code> and <code>lastid</code> will equal 0, I think we want to do something different with <code>tmpstr</code> and <code>ad</code> in this case?\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Oct-23 13:00:31 by johnkn:</em> <br/>\n\nRegarding the notes:\n\n<p></p><ul>\n<li>lines 467-521: f2 is the filename at level 2 of the directory, f3 is at level three.  I will change to fn to indicate filename better, but other than that I think these are good variable names.\n</li><li>line 553: uncommenting this dprintf results in the same error message twice in the log.\n</li><li>line 566: is unreachable if maybe_stale is empty\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Nov-25 15:04:30 by jfrey:</em> <br/>\n\nSome more notes:\n\n<p>Beginning in HTCondor 8.6.10, preen scans the entire spool directory before talking to the schedd (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>), but it then asks the schedd about the existence of individual jobs, with a round trip per query. If the connection to the schedd drops, preen assumes files for all remaining jobs in its list should be deleted.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7321\" title=\"add a command to the master to test preen\">#7321</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nadd a command to the master to test preen</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-09 11:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58615\">[58615]</a></span>: Improve version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7320\" title=\"preen can DOS the schedd\">#7320</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-23 13:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58245\">[58245]</a></span>: changes to <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7320\" title=\"preen can DOS the schedd\">#7320</a></span> in response to code review  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-22 15:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58236\">[58236]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7320\" title=\"preen can DOS the schedd\">#7320</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-11 16:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58147\">[58147]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7320\" title=\"preen can DOS the schedd\">#7320</a></span>, preen can DOS the Schedd. We fix this by having the schedd first gather a list of spool files by job id, then query the schedd for valid job ids, then preen the files that correspond to jobs no longer in the schedd. This commit also adds a -log argument to condor_preen to aid in testing\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Dec-09 15:36", "status": "resolved", "created": "2019-Oct-11 11:51", "fixed_version": "2019-Oct-11 11:51", "broken_version": "v080609", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}