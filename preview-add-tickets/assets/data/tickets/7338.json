{"id": 7338, "title": "Ticket #7338: Input file transfer should preserve relative paths", "description": "<blockquote>\nIf the <code>input</code> directory contains ten thousand files, but any particular job needs only (say) two of them, then the following submit file will (should) work, but is amazingly inefficient:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">arguments = input/$(PROC).h input/$(PROC).f\ntransfer_input_files = input\n</pre></div>\n\n\n<p>The obvious fix is to instead say\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">arguments = input/$(PROC).h input/$(PROC).f\ntransfer_input_files = input/$(PROC).h input/$(PROC).f\n</pre></div>\n\n\n<p>but this does not work, because <strong>transfer_input_files</strong> transfers all individually-named files to the root of the sandbox.  Although the work-around in this example is easy (strip the leading <code>input/</code> from each element of <strong>arguments</strong>), some jobs may really need a particular directory structure to function properly.\n\n</p><p>Rather than make users with such jobs write a wrapper script, we should allow them to specify that they'd like to keep the relative paths they specify in their inputs.\n\n</p><p>This work should be considered in combination with <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7269\" onclick=\"get_ticket_and_populate_wrapper('7269'); return false;\" title=\"support an explicit list of checkpoint files\">#7269</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7270\" onclick=\"get_ticket_and_populate_wrapper('7270'); return false;\" title=\"when_to_transfer_output = ON_SUCCESS\">#7270</a></span>.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Oct-24 13:31:01 by anderson:</em> <br/>\n\nIt is also important that the directory structure be preserved when it is transferred, and for bonus points allow a white list and/or black list regexp() for what should or shouldn't be transferred--think /bin/rsync --recursive with and without --include and --exclude rules.\n\n<p></p><hr/>\n<em>2019-Oct-24 14:17:48 by tlmiller:</em> <br/>\n\nMaybe I'm misunderstanding the ticket, but I think HTCondor already does this.  Does the following not do what you want when 'caches' is a directory?\n\n<p></p><div class=\"code\">\n<pre class=\"code\">transfer_input_files = injection.xml, caches\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Oct-29 15:39:08 by tlmiller:</em> <br/>\n\nBased on the call today, the issue is that\n\n<p></p><div class=\"code\">\n<pre class=\"code\">transfer_input_files = input\n</pre></div>\n\n\n<p>transfers too many files (to the point of causing problems), but\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">transfer_inptut_files = input/a/1 input/b/2 input/a/3\n</pre></div>\n\n\n<p>results in the sandbox (partial listing):\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">dir_1234:\n1    2    3\n</pre></div>\n\n\n<p>which is not OK.\n\n</p><p>I looked for <strong>transfer_input_remaps</strong>; we have an internal function with a similar name, but it's presently not available for end-users.  Sorry any confusion.\n\n</p><p>The general consensus of the call was that the HTCondor approach would probably be to integrate with <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7269\" onclick=\"get_ticket_and_populate_wrapper('7269'); return false;\" title=\"support an explicit list of checkpoint files\">#7269</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7270\" onclick=\"get_ticket_and_populate_wrapper('7270'); return false;\" title=\"when_to_transfer_output = ON_SUCCESS\">#7270</a></span>, so that the new file transfer attributes would preserve directory structure.\n\n</p><p>In the short term, you might be able to play games with symlinks (or hardlinks, if necessary) and create a directory structure for each job that has only the relevant files in it, and then transfer the whole thing.\n\n</p><p><em>original ticket body follows</em>\n\n</p><p></p><hr/>\nThis has become a major obstacle to porting LIGO pipelines to grid resources.\n\n<p>e.g. input files are injection.xml, caches/H1-frames.lcf, caches/L1-frames.lcf and the command line for the job is normally --inj injection.xml --H1-data caches/H1-frames.lcf --L1-data caches/L1-frames.lcf. It would be useful to have the local space contain injection.xml caches/H1-frames.lcf caches/L1-frames.lcf\n\n</p><p></p><hr/>\n<em>2019-Dec-03 17:25:31 by tlmiller:</em> <br/>\n\nThe branch which unconditionally preserves relative paths breaks URL transfers, because we need to take the basename of URLs to get a writable filepath.  Fix later.\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-28 08:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61342\">[61342]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Update documentation to reflect that preserve_relative_paths only works for jobs with a shadow.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 15:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59161\">[59161]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7270\" onclick=\"get_ticket_and_populate_wrapper('7270'); return false;\" title=\"when_to_transfer_output = ON_SUCCESS\">#7270</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7269\" onclick=\"get_ticket_and_populate_wrapper('7269'); return false;\" title=\"support an explicit list of checkpoint files\">#7269</a></span>) Release notes and documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-24 18:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59030\">[59030]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7269\" onclick=\"get_ticket_and_populate_wrapper('7269'); return false;\" title=\"support an explicit list of checkpoint files\">#7269</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-14 08:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58969\">[58969]</a></span>: Fix memory leak in file xfer <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 16:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58964\">[58964]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7269\" onclick=\"get_ticket_and_populate_wrapper('7269'); return false;\" title=\"support an explicit list of checkpoint files\">#7269</a></span>) Add ATTR_CONDOR_VERSION #define. Add preserve_relative_paths and transfer_checkpoint_files at submit commands; if either is specified, the submit utils will ad a requirement for version 8.9.6 or higher.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58963\">[58963]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) #define all the constants!  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58960\">[58960]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove dead code.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58959\">[58959]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove duplicate directory-creation entries from the expanded transfer list.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58958\">[58958]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove redundant directory-creation code. Fix bug where relative path preservation didn't create the parent directories of user-specified files in a subdirectory.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58957\">[58957]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Fix bug when preserving relative paths, and the preserved directory contained subdirectories.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58956\">[58956]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Fix a bug where we'd insert an extra slash in output_destination URLs (this was causing me grief with S3); and fix a bug with copying URLs into the sandbox.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58955\">[58955]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Implement (mostly for testing purposes) +PreserveRelativePaths.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58954\">[58954]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove a bunch of stray whitespace.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58953\">[58953]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Fix two log entries to include correct function name.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-13 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58952\">[58952]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Unconditionally preserve relative paths.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-08 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58945\">[58945]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove duplicate directory-creation entries from the expanded transfer list.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-06 15:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58944\">[58944]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove redundant directory-creation code. Fix bug where relative path preservation didn't create the parent directories of user-specified files in a subdirectory.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-03 19:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58943\">[58943]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Fix bug when preserving relative paths, and the preserved directory contained subdirectories.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-03 14:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58942\">[58942]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Fix a bug where we'd insert an extra slash in output_destination URLs (this was causing me grief with S3); and fix a bug with copying URLs into the sandbox.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-02 16:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58941\">[58941]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Implement (mostly for testing purposes) +PreserveRelativePaths.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-19 15:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58940\">[58940]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Remove a bunch of stray whitespace.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-19 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58939\">[58939]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Fix two log entries to include correct function name.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-03 15:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58938\">[58938]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Unconditionally preserve relative paths.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-03 15:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58937\">[58937]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7338\" onclick=\"get_ticket_and_populate_wrapper('7338'); return false;\" title=\"Input file transfer should preserve relative paths\">#7338</a></span>) Reorder the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> header and label the different sections of the (awful) API.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Apr-10 07:46", "status": "resolved", "created": "2019-Oct-24 13:21", "fixed_version": "2019-Oct-24 13:21", "broken_version": "", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "tlmiller", "derived_from": "", "creator": "pfc", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "peter.couvares@ligo.org, joshua.willis@ligo.org, stuart.anderson@ligo.org, james.clark@ligo.org, john.veitch@ligo.org, viven.raymond@ligo.org, carl.haster@ligo.org, tlmiller@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": ""}