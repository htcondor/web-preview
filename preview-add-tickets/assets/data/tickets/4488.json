{"id": 4488, "title": "Ticket #4488: Allow re-queue DAG POST jobs", "description": "<blockquote>\n(Kent and I discussed this in April, but I don't think I created a ticket.)\n\n<p>The POST scripts for CMS can sometimes take a very long time to finish - however, they are idle 99% because they wait for an external service to acknowledge job completion.  Because each POST script takes 20MB of RAM (they are python-based), we limit the number of concurrent running POSTs to 10.\n\n</p><p>This causes blocking behavior - other jobs can't be processed if we have 10 jobs that are taking a long time to complete in the external system.\n\n</p><p>I would like to see a new option for post scripts, \"REQUEUE X TIME Y\".  If the POST job exits with code X, then the POST script is added to the end of the event queue after Y seconds.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-28 14:16:54 by wenger:</em> <br/>\n\nOkay, I remember talking about this.  Have to get back to getting Zach up to speed on DAGMan -- hopefully then we can make more progress...\n\n<p></p><hr/>\n<em>2015-Mar-04 15:15:34 by wenger:</em> <br/>\n\nNote:  as per phone discussion today, the re-queue time is not a hard limit -- it's not a problem if the script gets re-tried somewhat sooner than the requested time.\n\n<p>Also, this will need a test; and think about how it should work in recovery mode.  (Brian's commit so far does not write a POST script terminated event if the script is being re-queued.)\n\n</p><p></p><hr/>\n<em>2015-Mar-04 21:41:25 by bbockelm:</em> <br/>\n\nOther items from the phone call:\n<ul>\n<li>CMS is willing to pitch in effort for the implementation if it can speed time-to-delivery (Kent mentioned a few other tight upcoming deadlines).\n</li><li>This feature seems to be very CMS-specific.  Hence, we can be narrow in its delivery - no need to solve a generic problem (assuming again this speeds time-to-delivery).\n</li></ul>\n\n<p></p><hr/>\n<em>2015-Mar-17 12:45:37 by wenger:</em> <br/>\n\nBrian, is your checkin on a branch anywhere?  If not, could you put it on one?  I'd like to be able to check out code that incorporates your changes, as opposed to just looking at the commit in gittrac.\n\n<p></p><hr/>\n<em>2015-Mar-17 13:11:13 by wenger:</em> <br/>\n\nOops, don't worry about that previous remark -- ToddT just showed me how to get the branch...\n\n<p></p><hr/>\n<em>2015-Mar-18 11:36:57 by wenger:</em> <br/>\n\nNote:  We need to have a limit on how many times a script will get retried.  Also, maybe pass the retry number as an environment variable or something.\n\n<p></p><hr/>\n<em>2015-Mar-18 11:57:35 by wenger:</em> <br/>\n\nThis needs to get added to the rescue DAG...\n\n<p></p><hr/>\n<em>2015-Mar-18 12:00:38 by bbockelm:</em> <br/>\n\nWhy add limits or keep retry counts in the rescue DAG?\n\n<p>To some extent, this replaces a post-script that is a work loop with a \"sleep 5m\" at the end.  The post-job itself has no time limit or retry count; we depend on the user not having infinite loops.  I don't see why we couldn't do the same for the first implementation here.\n\n</p><p></p><hr/>\n<em>2015-Mar-18 14:26:20 by wenger:</em> <br/>\n\nOne thing I don't like a whole lot about the current implementation: it will break any DAG that has a node named \"defer\" that has a pre or post script.\n\n<p></p><hr/>\n<em>2015-Mar-18 14:31:51 by bbockelm:</em> <br/>\n\nYeah - it seemed the option was to break nodes named \"defer\" or break executables named \"defer\".\n\n<p>On second glance, could we do:\n\n</p><p>SCRIPT &lt;DEFER X Y&gt; POST <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobName\" title=\"Job Name\">JobName</a></span> Executable\n\n</p><p>?\n\n</p><p>It's more awkward syntax but has better backward compatibility.\n\n</p><p></p><hr/>\n<em>2015-Mar-18 16:39:45 by wenger:</em> <br/>\n\nYes, I thought about that syntax.\n\n<p>Right now I am just getting things working right; maybe I'll change the syntax after that.\n\n</p><p></p><hr/>\n<em>2015-Mar-18 16:42:38 by wenger:</em> <br/>\n\nA few enhancements I thought of while doing this:\n<ul>\n<li>Move the _post from Script to ScriptQ -- that would save space and also simplify the code, I think.\n</li><li>Make a little struct that has all of the deferral-related stuff, and only allocate that for a Script if the deferral stuff is defined (to not use up so much space on scripts that don't have deferrals).\n</li></ul>\n\n<p>Also, I think we should define maximum number of retries, but maybe that can be done globally for the DAG as opposed to individually for each script.\n\n</p><p></p><hr/>\n<em>2015-Mar-18 21:02:09 by bbockelm:</em> <br/>\n\nRight now, the defer-related items are the same size as a pointer for 64 bit platforms.  Once you factor in malloc overhead, embedding the members in the data struct is actually more space efficient.\n\n<p>If you're worried about memory usage, you can fix the pre-existing data structure misalignments, change the status type to a single byte, and then have a smaller overall data structure than before the defer script was added!\n\n</p><p>(Note - there are also significant misalignments in the Job struct; you could probably get a non-trivial decrease in the size of that struct just by fixing those.)\n\n</p><p></p><hr/>\n<em>2015-Mar-19 11:56:16 by wenger:</em> <br/>\n\nThe above are good points; on the other hand, once we implement a retry limit, each script will have to have a counter for that, so the defer information will get bigger.\n\n<p>At any rate, though, fixing the alignment is a good idea -- we should probably do that for the Job object, too...\n\n</p><p></p><hr/>\n<em>2015-Mar-19 13:54:23 by wenger:</em> <br/>\n\nJust about to do hopefully the final code commit.  Still left to do for this ticket:\n<ul>\n<li>Finish up the automated test.\n</li></ul>\n\n<p></p><hr/>\n<em>2015-Mar-19 15:24:40 by wenger:</em> <br/>\n\nOkay, this is committed and merged to master.  But I'm leaving the ticket in the \"active\" state because I haven't finished up the automated test yet.\n\n<p></p><hr/>\n<em>2015-Mar-26 14:26:19 by wenger:</em> <br/>\n\nJust looked at Karen's manual edits.  In general I think they're good; my only question is whether the language about a \"single retry\" is confusing, because the script will be retried more than once if it continues to exit with the special defer exit code.\n\n<p></p><hr/>\n<em>2015-Mar-27 16:48:58 by wenger:</em> <br/>\n\nNote that checkin <span class=\"chng\"><a href=\"chngview?cn=43747\">[43747]</a></span> is really for this ticket -- I had the wrong ticket number in the commit message, but didn't notice that until after I had pushed.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=4946\" title=\"DAGMan script deferral enhancements\">#4946</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDAGMan script deferral enhancements</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-31 16:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44482\">[44482]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Duh! Added job_dagman_script_defer to the Test_Requirements and Windows_SkipList files.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-30 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44463\">[44463]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Changed (temporarily?) the job_dagman_script_defer to use \"real\" node jobs rather than NOOP nodes, because the test framework doesn't like seeing 0 for the cluster ID.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-30 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44460\">[44460]</a></span>: update 8.3.5 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-27 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43747\">[43747]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Finished the job_dagman_script_defer test.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-27 15:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43745\">[43745]</a></span>: correct description of new DAGMan DEFER feature <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-24 17:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43705\">[43705]</a></span>: edit of doc for new DAGMan feature of retry of a PRE or POST script <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-19 14:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43625\">[43625]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Fixed DEFER syntax for backwards compatibility, and changed the corresponding test DAG; DEFER information is now written to rescue DAGs; various other small cleanups; added version history and at least preliminary documentation.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-18 18:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43622\">[43622]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: A bunch more cleanup, but some still to go.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-18 18:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43621\">[43621]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Made scripts for the maxpre and maxpost tests take longer to run, to make the test more challenging.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-18 18:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43620\">[43620]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Partial test for this functionality -- DAG can be run manually.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-18 16:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43619\">[43619]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Re-did some of the implementation -- maxpre and maxpost tests pass, and valgrind doesn't find problems. Still need to do more checking, though...  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-18 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43618\">[43618]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Noted problems found so far...  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-18 09:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43617\">[43617]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span>: Cherry-picked the fix for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4940\" title=\"AddNode() is never called with non-null precmd, postcmd\">#4940</a></span> over to this branch because it simplifies the relevant code.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-02 19:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43493\">[43493]</a></span>: Allow post scripts to be deferred and re-run <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4488\" title=\"Allow re-queue DAG POST jobs\">#4488</a></span> This implements a new DAGMan feature, DEFER scripts. If the script exits with the given status, DAGMan will not log the exit status and run it again after about N seconds.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Apr-08 10:52", "status": "resolved", "created": "2014-Jul-28 13:53", "fixed_version": "2014-Jul-28 13:53", "broken_version": "", "priority": "2", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu, zmiller@cs.wisc.edu, wenger@cs.wisc.edu, smoler@cs.wisc.edu", "due_date": ""}