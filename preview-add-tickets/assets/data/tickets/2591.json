{"id": 2591, "title": "Ticket #2591: shadow fails to shut down, slot stays Claimed/Idle", "description": "<blockquote>\nWe observed a slot in batlab that was Claimed/Idle for 12 hours.  The schedd thinks the job is still running, because the shadow is still running.  No starter is running.\n\n<p>I suspect the problem may have been introduced in <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2329\" title='periodic_remove &amp;&amp; \"\"_hold would inadvertantly cause a release_claim'>#2329</a></span>, which modified removeJob() so that it does not always exit but instead waits for the starter to be deactivated.\n\n</p><p>The shadow logs the following, showing that it keeps trying to deactivate the claim.  The final attempt times out after 20s, so the shadow thinks it did not succeed, but looking on the startd side, it appears that it did succeed.  After this, the shadow stops trying to kill the starter.\n\n</p><p></p><div class=\"verbatim\">\n<pre>10/26/11 02:26:27 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:26:47 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:26:47 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:26:47 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:26:47 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:26:47 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 02:31:47 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:32:07 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:32:07 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:32:07 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:32:07 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:32:07 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 02:37:07 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:37:27 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:37:27 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:37:27 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:37:27 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:37:27 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 02:42:27 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:42:47 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:42:47 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:42:47 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:42:47 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:42:47 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 02:47:47 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:48:07 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:48:07 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:48:07 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:48:07 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:48:07 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 02:53:07 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:53:27 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:53:27 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:53:27 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:53:27 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:53:27 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 02:58:27 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 02:58:47 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 02:58:47 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 02:58:47 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 02:58:47 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 02:58:47 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 03:03:47 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 03:04:07 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 03:04:14 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 03:04:14 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 03:04:14 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 03:04:14 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 03:08:50 (940247.0) (9222): Calling Handler &lt;HandleSyscalls&gt; (1)\n10/26/11 03:08:50 (940247.0) (9222): Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n10/26/11 03:09:10 (940247.0) (9222): condor_read(): timeout reading 5 bytes from &lt;192.168.14.29:35667&gt;.\n10/26/11 03:09:10 (940247.0) (9222): IO: Failed to read packet header\n10/26/11 03:09:10 (940247.0) (9222): SECMAN: no classad from server, failing\n10/26/11 03:09:10 (940247.0) (9222): ERROR: SECMAN:2007:Failed to end classad message.\n10/26/11 03:09:10 (940247.0) (9222): RemoteResource::killStarter(): Could not send command to startd\n10/26/11 03:09:11 (940247.0) (9222): Return from Handler &lt;HandleSyscalls&gt; 20.5915s\n</pre></div>\n\n\n<p>Then the shadow periodically logs this:\n\n</p><p></p><pre>   Job 940247.0 is being removed: The job attribute PeriodicRemove expression '( ( CurrentTime - QDate ) &gt; 43200 )' evaluated to TRUE\n</pre>\n\n<p>On the startd side, we can see communication failure around the time when killStarter() failed:\n\n</p><p></p><div class=\"verbatim\">\n<pre>10/26/11 02:51:23 condor_write(): Socket closed when trying to write 293 bytes to &lt;192.168.0.162:39911&gt;, fd is 8\n10/26/11 02:51:23 Buf::write(): condor_write() failed\n10/26/11 02:51:23 SECMAN: Error sending response classad to &lt;192.168.0.162:39911&gt;!\nEnact = \"NO\"\nSubsystem = \"SHADOW\"\nCryptoMethods = \"3DES,BLOWFISH\"\nNewSession = \"YES\"\nServerPid = 9222\nAuthMethods = \"FS,KERBEROS,GSI\"\nEncryption = \"OPTIONAL\"\nServerCommandSock = \"&lt;198.51.254.20:40434?PrivAddr=%3c192.168.0.162:40434%3e&amp;PrivNet=nmi.cs.wisc.edu&amp;noUDP&gt;\"\nOutgoingNegotiation = \"PREFERRED\"\nIntegrity = \"OPTIONAL\"\nParentUniqueID = \"nmi-s005:30987:1317742664\"\nCommand = 404\nCommand = 404\nSessionDuration = \"86400\"\nCurrentTime = time()\nSessionLease = 3600\nRemoteVersion = \"$CondorVersion: 7.7.2 Sep 26 2011 BuildID: 372978 PRE-RELEASE-UWCS $\"\nAuthentication = \"OPTIONAL\"\n10/26/11 02:53:32 condor_write(): Socket closed when trying to write 293 bytes to &lt;192.168.0.162:46392&gt;, fd is 8\n10/26/11 02:53:32 Buf::write(): condor_write() failed\n</pre></div>\n\n\n<p>The startd does eventually receive the deactivation request and it shuts down the starter, but for whatever reason, the shadow keeps running.\n\n</p><p></p><div class=\"verbatim\">\n<pre>10/26/11 03:10:34 Received TCP command 404 (DEACTIVATE_CLAIM_FORCIBLY) from unauthenticated@unmapped &lt;192.168.0.162:56116&gt;, access level DAEM\nON\n10/26/11 03:10:34 Calling HandleReq &lt;command_handler&gt; (0) for command 404 (DEACTIVATE_CLAIM_FORCIBLY) from unauthenticated@unmapped &lt;192.168.\n0.162:56116&gt;\n10/26/11 03:10:34 slot1: Called deactivate_claim_forcibly()\n10/26/11 03:10:34 Return from HandleReq &lt;command_handler&gt; (handler: 0.073s, sec: 0.614s, payload: 0.000s)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-27 11:13:04 by tstclair:</em> <br/>\n\nIt's waiting for the final update from the starter.  Before the shadow would exit before receiving the final update.  It's entirely possible we've uncovered a workflow issue.\n\n<p>What doesn't make sense is why is it constantly trying to send the update?\n\n</p><p></p><hr/>\n<em>2011-Oct-27 13:56:43 by danb:</em> <br/>\n\nTim, I'm confused about your question, \"why is it constantly trying to send the update?\"  <em>What</em> is constantly trying to send an update?  Not the starter.  It is dead and gone.  The shadow?\n\n<p></p><hr/>\n<em>2011-Nov-03 11:00:29 by tstclair:</em> <br/>\n\nHas there been any repro conditions?  We have not seen *this.\n\n<p></p><hr/>\n<em>2011-Nov-10 10:29:17 by danb:</em> <br/>\n\nWe have observed what appears to be another instance of this bug in 7.7.2.\n\n<p>A shadow in CHTC has been sitting around for days.  It has no connection to the starter.  The claim lease expired 4 days ago and the schedd no longer has a match record.  The glidein that was running this job is long gone.  The shadow is just logging the following over and over:\n\n</p><p></p><pre>   11/10/11 08:11:50 (4929615.0) (5217): Job 4929615.0 going into Hold state (code 3,0): The job attribute PeriodicHold expression '( JobStatus == 2 ) &amp;&amp; ( ( CurrentTime - EnteredCurrentStatus ) &gt; ( 60 * 60 * 24 ) )' evaluated to TRUE\n</pre>\n\n<p>The shadow log does not go back far enough to see how it got into this state.\n\n</p><p>The symptom that caused us to notice this problem is that condor_ssh_to_job reported that, \"Job 4929615.0 does not support remote login\".  This is because of the missing match record.\n\n</p><p></p><hr/>\n<em>2011-Nov-10 10:44:27 by gthain:</em> <br/>\n\nThis is also happening in old batlab.  There are a bunch of shadows hanging around, with no corresponding starter.  Shadow log says:\n\n<p>11/10/11 10:37:34 (2612781.0) (23557): Job 2612781.0 is being removed: The job attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRemove\" title=\"Periodic Remove\">PeriodicRemove</a></span> expression '( ( ( <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span> - QDate ) &gt; 518400 ) || ( ( ( <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span> - <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobCurrentStartDate\" title=\"Job Current Start Date\">JobCurrentStartDate</a></span> ) &gt; 28800 ) <code>?</code> true ) )' evaluated to TRUE\n\n</p><p>But the shadows never actually go away or update the schedd.  condor_q shows these jobs in \"R\" state.\n\n</p><p></p><hr/>\n<em>2011-Nov-10 10:51:01 by tstclair:</em> <br/>\n\nCan the starter+startd logs be attached to this ticket for the time period of failure.  I'm guessing there is some botched update.\n\n<p></p><hr/>\n<em>2011-Nov-16 15:05:31 by danb:</em> <br/>\n\nThe following reproduces a similar condition to what may be happening in the other cases we have observed in the wild.  These configuration settings happen to require a recent version the master branch (7.7.5 pre-release).  Something similar could probably be achieved back in 7.7.2.\n\n<p>In the configuration of the execute machine:\n\n</p><p></p><pre>   MachineMaxVacateTime = 0\n   KILLING_TIMEOUT = 0\n</pre>\n\n<p>In the submit file:\n\n</p><p></p><pre>   periodic_remove = JobStatus == 2\n</pre>\n\n<p>When the shadow deactivates the claim, the startd hard-kills the starter, so there is no final update.  The shadow then waits around indefinitely for a final update that will never arrive.\n\n</p><p>A similar state is entered if I remove the job with condor_rm rather than via peirodic_remove.  periodic_hold also produces a similar state.\n\n</p><p>I have prepared a patch that solves this problem and avoids unsolving <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2105\" title=\"Shadow will treat closed socket as an error after claim is deactivated\">#2105</a></span></p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-16 15:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28281\">[28281]</a></span>: Fixed a case where shadow hung around waiting for starter update that would never come. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2591\" title=\"shadow fails to shut down, slot stays Claimed/Idle\">#2591</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-16 15:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28282\">[28282]</a></span>: Documented fix for lingering shadow problem. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2591\" title=\"shadow fails to shut down, slot stays Claimed/Idle\">#2591</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-22 09:25", "status": "resolved", "created": "2011-Oct-26 16:31", "fixed_version": "2011-Oct-26 16:31", "broken_version": "v070702", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "dan@hep.wisc.edu,tlmiller@cs.wisc.edu,tstclair@redhat.com", "due_date": ""}