{"id": 693, "title": "Ticket #693: rpmbuild mangling Globus jar files", "description": "<blockquote>\nOn rhel5, when rpmbuild builds the rpms for the Condor release, it repacks all of the jar files. It does so in such a way that the gt4 gahp fails on startup in some situations.\n\n<p>Earlier versions of Red Hat don't do this repacking. In later releases of Fedora Core, the jar repacking can be disabled by adding this macro to the rpm .spec file:\n</p><div class=\"code\">\n<pre class=\"code\">%define __jar_repack %{nil}\n</pre></div>\n\n\n<p>To disable the jar repacking on rhel5, the best solution I've found is to redefine the __os_install_post macro. The definition varies by platform, so we'd need to be explicit about where we redefine it. It's a hack, but it works.\n\n</p><p>We would add the following to the .spec file when building on rhel5:\n</p><div class=\"code\">\n<pre class=\"code\">%define __os_install_post \\\n    /usr/lib/rpm/redhat/brp-compress ; \\\n    %{!?__debug_package:/usr/lib/rpm/redhat/brp-strip %{__strip}} ; \\\n    /usr/lib/rpm/redhat/brp-strip-static-archive %{__strip} ; \\\n    /usr/lib/rpm/redhat/brp-strip-comment-note %{__strip} %{__objdump} ; \\\n    /usr/lib/rpm/brp-python-bytecompile ; \\\n%{nil}\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2009-Aug-27 11:27:54 by willb:</em> <br/>\n\nTry the following, which should work on RHEL.\n\n<p>%global __jar_repack %{nil}\n\n</p><p></p><hr/>\n<em>2009-Aug-27 14:49:46 by jfrey:</em> <br/>\n\nThe %global line didn't prevent the jar repacking.\n\n<p>Using <code>rpm --showrc</code> on my RHEL 5 machine to see the value of <code>__os_install_post</code>, I see that <code>brp-java-repack-jars</code> is run unconditionally. On a Fedora Core 9 machine, the execution of <code>brp-java-repack-jars</code> is conditional on <code>__jar_repack</code>.\n\n</p><p></p><hr/>\n<em>2009-Sep-01 15:27:24 by jfrey:</em> <br/>\n\nI met with Will Benton today about this problem. Here is a summary of what we discovered:\n\n<p>The version of rpm and redhat-rpm-config installed on the NMI x86-64 rhel 5 machine (nmi-0251) is almost 3 years old. Will thinks the jar repacking may be better in more recent versions, which are available for rhel 5.\n\n</p><p>I will build rpm packages on a CSL x86-64 rhel 5 machine with the updated rpm packages and see if the resulting jars suffer the same problem as those produced in NMI.\n\n</p><p>Interesting observation: <code>jar tvf</code> produces a different listing for the repacked jars.\n\n</p><p>Original jar contents:\n</p><div class=\"code\">\n<pre class=\"code\">     0 Thu Oct 14 17:57:34 CDT 2004 META-INF/\n   106 Thu Oct 14 17:57:32 CDT 2004 META-INF/MANIFEST.MF\n     0 Thu Oct 14 17:57:30 CDT 2004 org/\n     0 Thu Oct 14 17:57:34 CDT 2004 org/apache/\n     0 Thu Oct 14 17:57:34 CDT 2004 org/apache/naming/\n     0 Thu Oct 14 17:57:32 CDT 2004 org/apache/naming/java/\n  1253 Thu Oct 14 17:57:30 CDT 2004 org/apache/naming/java/javaURLContextFactory.class\n   105 Thu Oct 14 17:57:32 CDT 2004 org/apache/naming/java/package.html\n   104 Thu Oct 14 17:57:32 CDT 2004 META-INF/INDEX.LIST\n</pre></div>\n\n\n<p>Repacked jar contents:\n</p><div class=\"code\">\n<pre class=\"code\">   104 Tue Jan 01 00:00:00 CST 1980 META-INF/INDEX.LIST\n   106 Tue Jan 01 00:00:00 CST 1980 META-INF/MANIFEST.MF\n  1253 Tue Jan 01 00:00:00 CST 1980 org/apache/naming/java/javaURLContextFactory.class\n   105 Tue Jan 01 00:00:00 CST 1980 org/apache/naming/java/package.html\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Sep-01 17:01:27 by jfrey:</em> <br/>\n\nI built Condor 7.3.2 rpms on chevre.cs.wisc.edu, an x86-64 rhel 5 machine with newer rpm packages than the NMI build machine. When I use the resulting gt4 jar files on fgt4x4.fnal.gov (one of the Fermi machines where gt4_gahp is dying), gt4_gahp is able to run successfully.\n\n<p></p><hr/>\n<em>2009-Sep-02 10:42:20 by jfrey:</em> <br/>\n\nThe Globus jars from the x86 rhel 5 rpms work fine on Steve Timm's machine. NMI's x86 rhel 5 machine has a more recent version of rpm than their x86-64 rhel 5 machine. Updating the rpm package on the x86-64 machine should fix the problem.\n\n<p>On the x86 rhel 5 machine:\n</p><div class=\"code\">\n<pre class=\"code\">[jfrey@nmi-0099 ~]$ rpm -qi rpm\nName        : rpm                          Relocations: (not relocatable)\nVersion     : 4.4.2                             Vendor: Red Hat, Inc.\nRelease     : 47.el5                        Build Date: Fri 24 Aug 2007 02:18:59 PM CDT\nInstall Date: Mon 31 Mar 2008 12:40:14 PM CDT      Build Host: ls20-bc1-13.build.redhat.com\nGroup       : System Environment/Base       Source RPM: rpm-4.4.2-47.el5.src.rpm\nSize        : 1632869                          License: GPL\nSignature   : DSA/SHA1, Wed 05 Sep 2007 02:47:24 PM CDT, Key ID 5326810137017186\nPackager    : Red Hat, Inc. &lt;http://bugzilla.redhat.com/bugzilla&gt;\nSummary     : The RPM package management system.\nDescription :\nThe RPM Package Manager (RPM) is a powerful command line driven\npackage management system capable of installing, uninstalling,\nverifying, querying, and updating software packages. Each software\npackage consists of an archive of files along with information about\nthe package like its version, a description, etc.\n[jfrey@nmi-0099 ~]$\n</pre></div>\n\n\n<p>And the x86-64 rhel 5 machine:\n</p><div class=\"code\">\n<pre class=\"code\">[jfrey@nmi-0104 ~]$ rpm -qi rpm\nName        : rpm                          Relocations: (not relocatable)\nVersion     : 4.4.2                             Vendor: Red Hat, Inc.\nRelease     : 37.el5                        Build Date: Thu 04 Jan 2007 10:33:36 AM CST\nInstall Date: Wed 04 Apr 2007 12:56:08 AM CDT      Build Host: ls20-bc2-14.build.redhat.com\nGroup       : System Environment/Base       Source RPM: rpm-4.4.2-37.el5.src.rpm\nSize        : 1660868                          License: GPL\nSignature   : DSA/SHA1, Wed 17 Jan 2007 11:50:44 AM CST, Key ID 5326810137017186\nPackager    : Red Hat, Inc. &lt;http://bugzilla.redhat.com/bugzilla&gt;\nSummary     : The RPM package management system.\nDescription :\nThe RPM Package Manager (RPM) is a powerful command line driven\npackage management system capable of installing, uninstalling,\nverifying, querying, and updating software packages. Each software\npackage consists of an archive of files along with information about\nthe package like its version, a description, etc.\n[jfrey@nmi-0104 ~]$\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Sep-03 14:14:47 by jfrey:</em> <br/>\n\nNMI has updated rpm on the x86-64 rhel 5 machines to match that of the x86 rhel 5 machines. As a result, the Globus jar files in the rpms of a Condor build work properly on Steve Timm's machine (fgt4x4.fnal.gov).</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/86/rpm_no_repack.patch\">rpm_no_repack.patch</a>\n1286 bytes added by jfrey on 2009-Aug-26 16:53:20 UTC.\n<br/>\nPatch to disable jar repacking in rpmbuild<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-03 14:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=24975\">[24975]</a></span>: Version history for bad Globus jars (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=693\" title=\"rpmbuild mangling Globus jar files\">#693</a></span>)  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 13:15", "status": "resolved", "created": "2009-Aug-26 11:32", "fixed_version": "2009-Aug-26 11:32", "broken_version": "", "priority": "3", "subsystem": "Packaging", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "s7825", "customer_group": "fermi", "visibility": "public", "notify": "", "due_date": ""}