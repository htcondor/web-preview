{"id": 2054, "title": "Ticket #2054: hfs looping on \"group quota exceeded\"", "description": "<blockquote>\nIn old code, the cleanup of usage values and \"pruning\" of a group from further\nnegotiation was done immediately after negotiation of that group. Part of this\nwas setting a flag that would halt negotiation. And part of this was setting\ngroupArray[i].numsubmits == 0, which would then hit\n\n<p></p><div class=\"code\">\n<pre class=\"code\">if (  groupArray[i].numsubmits == 0  ) {\n...\n   continue;\n   }\n</pre></div>\n\n\n<p>This would skip negotiation for this group in the next iteration. The group\nwould be pruned from all subsequent negotiation. The flag was a defensive\nmeasure taken due to comparison of doubles. In new code, negotiation for all\ngroups is done followed by a new loop that does the clean up. There is no flag\nand the groups are not pruned immediately.\n\n</p><p>Repro:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NUM_CPUS = 100\nGROUP_NAMES = a, b\nGROUP_QUOTA_DYNAMIC_a = .4\nGROUP_QUOTA_DYNAMIC_b = .6\nGROUP_AUTOREGROUP_a = FALSE\n</pre></div>\n\n\n<p>The create a number of different users for group a.\n\n</p><p>Like 5 users ranging from a.a1 to a.a5.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">executable =./sleep.a1\narguments = 600\nuniverse = vanilla\nshould_transfer_files = YES\nwhen_to_transfer_output = ON_EXIT\n+AccountingGroup = \"a.a1\"\nqueue 200\n</pre></div>\n\n\n<p>Let the jobs fill the 40 slots and then\n\n</p><p></p><div class=\"verbatim\">\n<pre>grep exceeded NegotiatorLog\n\n04/05/11 11:56:55       Rejected 1444.8 a.a4@basin.redhat.com\n&lt;166.217.160.21:41826&gt;: group quota exceeded\n04/05/11 11:56:55       Rejected 1443.8 a.a3@basin.redhat.com\n&lt;166.217.160.21:41826&gt;: group quota exceeded\n04/05/11 11:56:55       Rejected 1442.8 a.a2@basin.redhat.com\n&lt;166.217.160.21:41826&gt;: group quota exceeded\n04/05/11 11:56:55       Rejected 1445.8 a.a5@basin.redhat.com\n&lt;166.217.160.21:41826&gt;: group quota exceeded\n04/05/11 11:56:56       Rejected 1441.7 a.a1@basin.redhat.com\n&lt;166.217.160.21:41826&gt;: group quota exceeded\n</pre></div>\n\n\n<p>In scenarios with lots of users like 100, you will get 100 rejections for\n\"group quota exceeded\". These could all be pruned either before or immediately\nafter the 1st rejection (the one for a.a4 in the example).</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Apr-18 16:25:53 by danb:</em> <br/>\n\nCode review:\n\n<p>For a stable series patch, it would be better to refrain from so much cosmetic surgery.  There are a number of changes in code flow, variable names, whitespace, comment style, variable declaration placement---all of which do not really seem fundamental to the patch.\n\n</p><p>That said, \"submitterAds\" is a much better name than \"scheddAds\" :).\n\n</p><p>I am concerned about the change in what happens when the submitter limit is reached.  Previously, this resulted in result=MM_RESUME, which (if I understand things correctly), resulted in the submitter remaining in line for consideration in future spins of the pie.  In the patch, this case is handled by removing the submitter from the list of submitters, so I think this means this user will not be considered in subsequent spins of the pie:\n\n</p><p></p><pre>            if (!ignore_submitter_limit &amp;&amp; ((submitterLimit &lt;= 0) || (pieLeft &lt; minSlotWeight))) {\n                // If limit is 0, and we are respecting submitter limits, don't waste time with negotiate\n                negotiation_cycle_stats[0]-&gt;submitters_share_limit.insert(submitterName.Value());\n                dprintf(D_FULLDEBUG, \"Submitter %s is at its submitter limit %g\\n\", submitterName.Value(), submitterLimit);\n                submitterAds.Remove(submitter);\n                continue;\n            }\n</pre>\n\n<p>In general, this seems like a pretty aggressive patch for a stable series.  This makes it hard to be confident that no surprises are introduced.  I'd recommend splitting this into two patches: one suitable for the stable series that fixes the problem with minimal code disturbance, and another with all the other improvements to the code.\n\n</p><p></p><hr/>\n<em>2011-Apr-18 17:44:07 by eje:</em> <br/>\n\nOuch, good catch -- shouldn't remove submitter on hitting submitter limit.\n\n<p></p><hr/>\n<em>2011-Apr-25 14:02:42 by danb:</em> <br/>\n\nLooks good!  I don't spot any problems in version 2 of the patch.\n\n<p></p><hr/>\n<em>2011-Apr-26 11:55:27 by danb:</em> <br/>\n\nErik, you committed the patch to the master branch.  It should go into V7_6-branch, right?\n\n<p>Incidentally, one of the problems fixed in this patch should also fix <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2092\" title=\"Negotiator miscounts resources it hands out\">#2092</a></span>.\n\n</p><p></p><hr/>\nThat was my typo -- I had intended v070700, since it was more of a convenience and efficiency improvement than fixing any incorrect behavior.\n\n<p>(however, I will be happy to backport it to 7.6 branch, if Greg is amenable)</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/320/gt2054_hgq_looping.patch\">gt2054_hgq_looping.patch</a>\n22900 bytes added by eje on 2011-Apr-12 18:06:24 UTC.\n<br/>\nAdds check for halting negotiator loop when group quota is met.  Also adds early pruning of submitter ads that have no idle or running jobs.  Includes some cleanup of negotiateWithGroup().\n<br/>\n</li><li><a href=\"attach_get/327/gt2054_hgq_looping.patch2\">gt2054_hgq_looping.patch2</a>\n5816 bytes added by eje on 2011-Apr-19 22:32:15 UTC.\n<br/>\nA more minimal version of first patch -- only new loop halting checks and early pruning of submitter ads.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-28 09:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22305\">[22305]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2230\" title=\"negotiating groups with no submitters\">#2230</a></span> === Patch created by jrt cleaned by eje Fix: negotiating groups with no submitters Artifact of <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2054\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2194\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span> when using round robin that leads to entering negotiateWithGroup with no submitters attached to the group.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-23 23:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21958\">[21958]</a></span>: Removed spurious reference to obsolete (and uninitialized) variable ignore_schedd_limit, corrected with ignore_submitter_limit. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2054\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-23 18:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21957\">[21957]</a></span>: Removed spurious reference to obsolete (and uninitialized) variable ignore_schedd_limit, corrected with ignore_submitter_limit. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2054\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-26 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21570\">[21570]</a></span>: Added check for earlier halting on reaching group quota in negotiation loop, along with early pruning of submitter ads with no running or idle jobs (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2054\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span>) Committer: Dan Bradley  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-25 15:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21563\">[21563]</a></span>: Added check for earlier halting on reaching group quota in negotiation loop, along with early pruning of submitter ads with no running or idle jobs (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2054\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span>)  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Apr-26 12:05", "status": "resolved", "created": "2011-Apr-12 09:21", "fixed_version": "2011-Apr-12 09:21", "broken_version": "v070506", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@redhat.com, matt@cs.wisc.edu, jthomas@redhat.com", "due_date": ""}