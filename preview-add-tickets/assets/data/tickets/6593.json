{"id": 6593, "title": "Ticket #6593: On dslot claim reuse, schedd checks resources of pslot", "description": "<blockquote>\nWhen the schedd searches for a job to run on an idle dynamic slot, it compares the job's resource request to the available resources of the partitionable slot that the dynamic slot was created from. This can result in the schedd attempting to run a job that's too big for the dynamic slot. When the shadow attempts to activate the claim, the startd rejects it, and the schedd then relinquishes the claim.\n\n<p>This happens because the schedd optimizes the slot ad's Requirements expression when the ad arrives in the schedd (in AddMrec()). This does constant propagation and expression inlining for attribute references internal to the slot ad. This includes the checks of whether the job fits in the slot in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WithinResourceLimits\" title=\"Within Resource Limits\">WithinResourceLimits</a></span> attribute. Later, when the schedd is about to contact the startd to request a claim, it modifies the partitionable slot ad to look like the dynamic slot ad that the startd will create for the claim. It overwrites the Cpus, Memory, and Disk attributes to match the amounts requested by the job it intends to run on that slot. But it doesn't update the copies of those attribute values that were propagated into the optimized Requirements expression. Thus, when the schedd looks for the next job to run on that slot, it will use an inaccurate Requirements expression that will match jobs that it shouldn't.\n\n</p><p>A simple fix for this bug is to redo the Requirements optimization after the partitionable slot ad is modified to look like a dynamic slot ad.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-09 08:25:54 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good.  Nice catch and a nice patch.\n\n</p><p></p><hr/>\n<em>2018-Mar-09 11:15:43 by tim:</em> <br/>\n\n<strong>DOC REVIEW:</strong> Looks good.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6611\" title=\"Update SlotType when schedd fakes up a dslot ad\">#6611</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nUpdate <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SlotType\" title=\"Slot Type\">SlotType</a></span> when schedd fakes up a dslot ad</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-02 10:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54417\">[54417]</a></span>: Docs for schedd matching big jobs to little dslots bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6593\" title=\"On dslot claim reuse, schedd checks resources of pslot\">#6593</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-02 10:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54416\">[54416]</a></span>: Re-optimize pslot ad after mutating it into a dslot ad. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6593\" title=\"On dslot claim reuse, schedd checks resources of pslot\">#6593</a></span> Optimization of a pslot ad will copy the Cpus, Memory, and Disk resource values into the Requirements expression. If we modified these values as part of making the pslot look like a dslot, we then need to redo the optimization. Otherwise,\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Jun-19 15:38", "status": "resolved", "created": "2018-Mar-02 10:39", "fixed_version": "2018-Mar-02 10:39", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}