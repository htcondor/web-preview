{"id": 3739, "title": "Ticket #3739: ssh to job fails when execute directory is more than 40 chars long", "description": "<blockquote>\nThe cmd_ssh_to_job_van test fails when the execute directory is 40 chars or more long.  We are seeing this in the batlab with a temporary Debian7 vm that has the execute directory as:  /usr/local/condor/local.exec-114/execute\n\n<p>This results in the construction of a socket name that is 109 characters long, which is 1 more than the maximum of 108 characters.\n\n</p><p>The actual error message from the test run is:\n</p><div class=\"verbatim\">\n<pre>07/05/13 23:35:45 Got connect info for starter &lt;128.104.103.114:60038&gt;\nfull socket name is too long: /usr/local/condor/local.exec-114/execute/dir_14208/userdir/temporary/nobody.condor_ssh_to_job_f48cb801/fdpass\n</pre></div>\n\n\n<p>To avoid this problem, the socket name should be constructed from the SCRATCH_DIR starting with dir_xxxx rather than using the whole path.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jul-08 17:51:45 by adesmet:</em> <br/>\n\nThe bit about SCRATCH_DIR is a red herring; it doesn't help.\n\n<p>Plan:\n\n</p><p></p><ol>\n<li>Squeeze the balloon! Make the socket's path as short as practical, but keep it in the SCRATCH_DIR.  This gives us the benefits of automatic cleanup on exit and allows things to work in more environments.\n\n<p></p></li><li>Hide the balloon somewhere else! If the shortened name is still too long after squeezing, and /tmp exists and has reasonable permissions, stuff it there.\n\n<p></p></li><li>Pop the balloon!  If /tmp isn't working out for us, give up.  Improve the error message to make it clear what the problem is and how a sysadmin might improve the situation.\n\n<p></p></li><li>Put the balloon in a TARDIS.  USE_FS_NAMESPACES=TRUE and ensure $TMP and friends is set to /tmp.  This should please every job in practice.  See <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3742\" onclick=\"get_ticket_and_populate_wrapper('3742'); return false;\" title=\"Jobs creating Unix domain sockets too long in scratch\">#3742</a></span> for details  This ticket can be resolved without doing this step; this is just noting that the other ticket will essentially eliminated popping the balloon.\n</li></ol>\n\n<p></p><hr/>\n<em>2013-Jul-08 18:00:43 by adesmet:</em> <br/>\n\nThe path is created in several parts:\n\n<p></p><ol>\n<li>getenv(\"TMP) (should be TMPDIR?) or \"/tmp\" SSHToJob::execute_ssh (<a class=\"file\" href=\"rlog?f=src/condor_tools/ssh_to_job.cpp\">/src/condor_tools/ssh_to_job.cpp</a> 494\n</li><li>Concatenate $TMP/$USERNAME.condor_ssh_to_job_$RANDINT  SSHToJob::execute_ssh (<a class=\"file\" href=\"rlog?f=src/condor_tools/ssh_to_job.cpp\">/src/condor_tools/ssh_to_job.cpp</a> 502\n</li><li>Append /fdpass SSHToJob::execute_ssh (<a class=\"file\" href=\"rlog?f=src/condor_tools/ssh_to_job.cpp\">/src/condor_tools/ssh_to_job.cpp</a> 548\n</li></ol>\n\n<p></p><hr/>\n<em>2014-Dec-29 13:13:21 by tlmiller:</em> <br/>\n\nAbandoned <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=3736\" onclick=\"get_ticket_and_populate_wrapper('3736'); return false;\" title=\"ssh-to-job test must conserve path length\">#3736</a></span> as a dup of this ticket.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "defect", "last_change": "2014-Dec-29 13:15", "status": "new", "created": "2013-Jul-08 09:58", "fixed_version": "2013-Jul-08 09:58", "broken_version": "v080000", "priority": "3", "subsystem": "Tools", "assigned_to": "adesmet", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "tannenba@cs.wisc.edu, danb@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}