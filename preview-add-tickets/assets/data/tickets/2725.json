{"id": 2725, "title": "Ticket #2725: ResidentSetSize appears to get reset when job is put on hold", "description": "<blockquote>\nIt appears <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResidentSetSize\" title=\"Resident Set Size\">ResidentSetSize</a></span> is reset to zero when a job is put on hold.\n\n<p>Locally, we have a SYSTEM_PERIODIC_HOLD expression based on RSS - anything hitting 1.6GB is put on hold.  Here's the memory-related classad attributes for a job in the schedd after it has been put on hold:\n</p><div class=\"verbatim\">\n<pre>ProportionalSetSizeKb = 1750000\nProportionalSetSizeKb_RAW = 1626303\nImageSize = 2000000\nImageSize_RAW = 1838488\nResidentSetSize = 0\n</pre></div>\n\n\n<p>Notice the values of PSS and VSIZE from the last run have been preserved, while RSS is reset to 0.  I also note that _RAW for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResidentSetSize\" title=\"Resident Set Size\">ResidentSetSize</a></span> is missing.\n\n</p><p>This is from Condor from trunk; I do not know when this behavior started.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Dec-22 09:14:00 by bbockelm:</em> <br/>\n\nThe attached patch causes RSS to work in a manner similar to PSS.\n\n<p>However, it's not obvious <strong>why</strong> the patch works (the \"correct\" PSS behavior is likely some unintended side-effect of rounding).  Discussing this with danb, there likely should be a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxResidentSetSize\" title=\"Max Resident Set Size\">MaxResidentSetSize</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxProportionalSetSizeKb\" title=\"Max Proportional Set Size Kb\">MaxProportionalSetSizeKb</a></span>; this would record the largest available value, not the most recent.  There are some small race conditions here - what if RSS/PSS is measured as the job is shutting down?\n\n</p><p></p><hr/>\n<em>2011-Dec-23 11:02:57 by danb:</em> <br/>\n\nIn my tests, rounding <code>ResidentSetSize</code> does not reliably prevent this attribute from getting reset to 0.  I can't come up with any theory that would explain why it should.\n\n<p>The reason RSS is getting reset to 0 is that in the starter's final update, it computes a total of 0 RSS for the job.  The reason PSS is not reset to 0 is an artifact of the way PSS is handled.  Instead of getting 0 for the total PSS, the starter gets the result \"no PSS available\", so it doesn't send an update to PSS in the final update.\n\n</p><p>I discussed with Todd and he agrees that we should change the definition of <code>ResidentSetSize</code> and <code>ProportionalSetSizeKb</code> to be maximums, like <code>ImageSize</code>.  This seems more useful for batch jobs.  If instantaneous values are ever desired, new attributes could be added to provide those.</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/511/rss_fix.patch\">rss_fix.patch</a>\n397 bytes added by bbockelm on 2011-Dec-21 22:36:41 UTC.\n<br/>\nQuick fix - anything that's rounded appears to be preserved after being put on hold.  No idea why.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-18 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=29141\">[29141]</a></span>: edit of version history items ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2710\" onclick=\"get_ticket_and_populate_wrapper('2710'); return false;\" title=\"Need a way to turn off pss grepping through /proc/pid/smaps\">#2710</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2725\" onclick=\"get_ticket_and_populate_wrapper('2725'); return false;\" title=\"ResidentSetSize appears to get reset when job is put on hold\">#2725</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-23 12:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28909\">[28909]</a></span>: Documented change to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResidentSetSize\" title=\"Resident Set Size\">ResidentSetSize</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProportionalSetSizeKb\" title=\"Proportional Set Size Kb\">ProportionalSetSizeKb</a></span>. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2725\" onclick=\"get_ticket_and_populate_wrapper('2725'); return false;\" title=\"ResidentSetSize appears to get reset when job is put on hold\">#2725</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-23 11:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28908\">[28908]</a></span>: Made <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResidentSetSize\" title=\"Resident Set Size\">ResidentSetSize</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProportionalSetSizeKb\" title=\"Proportional Set Size Kb\">ProportionalSetSizeKb</a></span> report the maximum value. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2725\" onclick=\"get_ticket_and_populate_wrapper('2725'); return false;\" title=\"ResidentSetSize appears to get reset when job is put on hold\">#2725</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Dec-23 12:03", "status": "resolved", "created": "2011-Dec-21 10:05", "fixed_version": "2011-Dec-21 10:05", "broken_version": "v070705", "priority": "3", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}