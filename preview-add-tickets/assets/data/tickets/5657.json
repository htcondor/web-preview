{"id": 5657, "title": "Ticket #5657: Master failed to restart after upgrade to 8.5.5-366162", "description": "<blockquote>\nErin Grasmick recently began the standard HTCondor pre-release upgrade on the CHTC pool to 8.5.5-366162.  When submit-4.chtc.wisc.edu was upgraded, the HTCondor master failed to restart.  The following is the relevant portion of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MasterLog\" title=\"Master Log\">MasterLog</a></span>:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">05/04/16 14:03:23 Doing exec( \"/usr/sbin/condor_master\" )\n05/04/16 14:03:24 ******************************************************\n05/04/16 14:03:24 ** condor_master (CONDOR_MASTER) STARTING UP\n05/04/16 14:03:24 ** /usr/sbin/condor_master\n05/04/16 14:03:24 ** SubsystemInfo: name=MASTER type=MASTER(2) class=DAEMON(1)\n05/04/16 14:03:24 ** Configuration: subsystem:MASTER local:&lt;NONE&gt; class:DAEMON\n05/04/16 14:03:24 ** $CondorVersion: 8.5.5 May 03 2016 BuildID: 366162 $\n05/04/16 14:03:24 ** $CondorPlatform: x86_64_RedHat6 $\n05/04/16 14:03:24 ** PID = 2490369\n05/04/16 14:03:24 ** Log last touched 5/4 14:03:23\n05/04/16 14:03:24 ******************************************************\n05/04/16 14:03:24 Using config source: /etc/condor/condor_config\n05/04/16 14:03:24 Using local config sources:\n05/04/16 14:03:24    /usr/bin/sudo /etc/condor/bin/dns_domain_name.sh /etc/condor/ephemeral/dns_domain_name.conf |\n05/04/16 14:03:24    /usr/bin/sudo /etc/condor/bin/htcondor_config_pull.sh -d /etc/condor |\n05/04/16 14:03:24    /etc/condor/ephemeral/dns_domain_name.conf\n05/04/16 14:03:24    /etc/condor/condor_config.hosts\n05/04/16 14:03:24    /etc/condor/condor_config.global\n05/04/16 14:03:24    /etc/condor/condor_config.policy\n05/04/16 14:03:24    /etc/condor/condor_config.x86_64_SL6\n05/04/16 14:03:24    /etc/condor/condor_config.security\n05/04/16 14:03:24    /etc/condor/dns_domains/chtc.wisc.edu.local\n05/04/16 14:03:24    /etc/condor/hosts/submit-4.chtc.wisc.edu.local\n05/04/16 14:03:24    /etc/condor/include/schedd.conf\n05/04/16 14:03:24    /etc/condor/include/facility_cs_3370a.conf\n05/04/16 14:03:24    /etc/condor/include/owned_by_chtc.conf\n05/04/16 14:03:24    /etc/condor/condor_config.flightworthy_testing\n05/04/16 14:03:24 config Macros = 226, Sorted = 226, StringBytes = 51372, TablesBytes = 8296\n05/04/16 14:03:24 CLASSAD_CACHING is OFF\n05/04/16 14:03:24 Daemon Log is logging: D_ALWAYS D_ERROR\n05/04/16 14:03:25 SharedPortEndpoint: waiting for connections to named socket 2490369_928d\n05/04/16 14:03:25 SharedPortEndpoint: failed to open /var/lock/condor/shared_port_ad: No such file or directory\n05/04/16 14:03:25 SharedPortEndpoint: did not successfully find SharedPortServer address. Will retry in 60s.\n05/04/16 14:03:25 DaemonCore: private command socket at &lt;128.105.244.190:0?sock=2490369_928d&gt;\n05/04/16 14:03:25 ERROR \"Failed DISCARD_SESSION_KEYRING_ON_STARTUP=True errno=122\" at line 526 in file /slots/03/dir_18932/userdir/.tmpTQNQpE/BUILD/condor-8.5.5/src/condor_master.V6/master.cpp\n</pre></div>\n\n\n<p>Execute node <code>e151.chtc.wisc.edu</code> was upgraded prior;  This issue did not occur for that upgrade.  I assigned this to Zach Miller and set it to the \"Security related\" subsystem because I suspect it is related to some recent changes he was working on with regards to HTCondor security features.\n\n</p><p>-Moate</p></blockquote>", "remarks": "<blockquote>\n<em>2016-May-05 11:30:47 by tim:</em> <br/>\n\nerrno 122 is \"Disk quota exceeded\"\n\n<p></p><hr/>\n<em>2016-May-05 11:38:15 by moate:</em> <br/>\n\nSubmit-4's spool is indeed in /home, which has quotas.  The condor quota was below the soft limit, but I don't really trust quotas, and the spool could have been larger when the issue occurred.  So, I think this was due to misconfiguration and not a HTCondor bug.  Recommend closing the ticket.\n\n<p>-Moate\n\n</p><p></p><hr/>\n<em>2016-May-05 12:13:34 by tannenba:</em> <br/>\n\nThe problem is the condor_master tried to create a new linux kernel session key, and this operation failed because there is a quota on the number of such keys each UID is allowed to create.\n\n<p>In this incident, the master failed to start because uid 0 (root) had exhausted its key quota.\nSee <a class=\"external\" href=\"http://linux.die.net/man/3/keyctl_join_session_keyring\">http://linux.die.net/man/3/keyctl_join_session_keyring</a>\n\n</p><p>The problem is submit-4, for some reason, user root on submit-4 has a very small quota (just 200 keys!), compared to say submit-5 (which has 1M keys) and the CSL-managed ingwe.cs (also 1M keys).\n\n</p><p>Why submit-4 and submit-5 have different kernel limits set is anyone's guess.\n\n</p><p>Behold :\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">\n[tannenba@submit-4 ~]$ cat /proc/sys/kernel/keys/root_maxkeys\n200\n[tannenba@submit-4 ~]$ cat /proc/sys/kernel/keys/root_maxbytes\n20000\n\n[tannenba@submit-5 ~]$ cat /proc/sys/kernel/keys/root_maxkeys\n1000000\n[tannenba@submit-5 ~]$ cat /proc/sys/kernel/keys/root_maxbytes\n25000000\n\ningwe.cs.wisc.edu{tannenba}54: cat /proc/sys/kernel/keys/root_maxkeys\n1000000\ningwe.cs.wisc.edu{tannenba}55: cat /proc/sys/kernel/keys/root_maxbytes\n25000000\n</pre></div>\n\n\n<p>Looks like submit-4 is currently running with 199 of its allowable 200 keys in use!! Also it is using almost a third of its key bytes quota... behold:\n</p><div class=\"code\">\n<pre class=\"code\">[tannenba@submit-4 ~]$ cat /proc/key-users | head -1\n    0:   204 203/203 199/200 5867/20000\n</pre></div>\n\n\n<p>BTW, the fields for /proc/key-users is (from <a class=\"external\" href=\"http://is.gd/mXp2M3\">http://is.gd/mXp2M3</a> )\n</p><div class=\"code\">\n<pre class=\"code\">&lt;UID&gt;                     User ID\n&lt;usage&gt;                 Usage count\n&lt;inst&gt;/&lt;keys&gt;      Total number of keys and number instantiated\n&lt;keys&gt;/&lt;max&gt;     Key count quota\n&lt;bytes&gt;&lt;max&gt;     Key size quota\n</pre></div>\n\n\n<p>I strongly suggest submit-4 have the same amount of root_maxkeys and root_maxbytes as apparently all other RHEL6 machine have...\n\n</p><p>Another idea would be for HTCondor kernel tuning script to set these.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5671\" title=\"Linux kernel tuning script should set root_maxkeys and root_maxbytes\">#5671</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nLinux kernel tuning script should set root_maxkeys and root_maxbytes</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "", "type": "incident", "last_change": "2016-May-11 16:56", "status": "resolved", "created": "2016-May-05 11:21", "fixed_version": "2016-May-05 11:21", "broken_version": "v080505", "priority": "2", "subsystem": "Security", "assigned_to": "tannenba", "derived_from": "", "creator": "moate", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "egrasmick@wisc.edu, wiscmoate@gmail.com, tim@cs.wisc.edu", "due_date": ""}