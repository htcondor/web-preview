{"id": 1374, "title": "Ticket #1374: Allow Shadow to run job without a schedd", "description": "<blockquote>\nCurrently, to run a job, the schedd needs to get a claim from the negotiator, and then spawn a shadow.  It gives the claim and the job to the shadow. We should allow the shadow to run a job, given a classad and a claim, without needing to talk with a schedd.  This will allow us to benchmark the shadow and startd/starter interactions for HFC.  It will also allow us to test many aspects of the shadow/starter interaction deterministically, without waiting for a negotiation cycle or schedd.</blockquote>", "remarks": "<blockquote>\n<em>2010-Apr-23 11:04:42 by gthain:</em> <br/>\n\nHere's a sample minimal job ad:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">JobUniverse = 5\nClusterId = 1\nProcID = 1\nJobStatus = 1\nCmd = \"/bin/sleep\"\nArgs = \"10\"\nOwner = \"gthain\"\nUser = \"gthain\"\nJobNotification = 0\nShouldTransferFiles = \"NO\"\nIwd = \"/tmp\"\nRemoteHost = \"slot1@chevre.cs.wisc.edu\"\nRequirements = TRUE\nStartdIpAddr = \"&lt;128.105.121.33:55436&gt;\"\nClaimStartd = true\nClaimId = \"&lt;128.105.121.33:55436&gt;#1272036774#14#fff97572386b042d004ce73fa1a20ac86dd9ef40\"\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Apr-25 23:26:17 by gthain:</em> <br/>\n\nBenchmarks show that starting a shadow is rather expensive.  Here's a run of 100 shadows, each running a 0 second sleep job to the startd on localhost without a schedd:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ time for n in 0 1 2 3 4 5 6 7 8 9; do for m in 0 1 2 3 4 5 6 7 8 9; do _condor_SHADOW_DEBUG=D_NEVER ./condor_shadow -f  1.1 --no-schedd-updates `pwd`/jobAd   2&gt; /dev/null; done; done\n\nreal    0m6.971s\nuser    0m0.969s\nsys     0m0.630s\n</pre></div>\n\n\n<p>So, that's about 16 shadows per second.\n\n</p><p>What is interesting is that if the shadow is passed invalid command line arguments, so that it exits after the startup costs, but before doing any real work, the real time goes down substantially ,but the user and sys time is substantial:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ time for n in 0 1 2 3 4 5 6 7 8 9; do for m in 0 1 2 3 4 5 6 7 8 9; do _condor_SHADOW_DEBUG=D_NEVER ./condor_shadow --this-is-invalid -f  1.1 --no-schedd-updates `pwd`/jobAd   2&gt; /dev/null; done; done\n\nreal    0m1.107s\nuser    0m0.530s\nsys     0m0.379s\n\n</pre></div>\n\n<hr/>\n<em>2010-Oct-20 16:03:30 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n<hr/>\n<em>2011-Jan-27 14:46:04 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n<hr/>\n<em>2011-Feb-01 16:08:44 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-26 12:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17911\">[17911]</a></span>: Allow a shadow to run multiple, sequential jobs sans sched <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1374\" onclick=\"get_ticket_and_populate_wrapper('1374'); return false;\" title=\"Allow Shadow to run job without a schedd\">#1374</a></span> Now this works with SHADOW_WORKLIFE  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-23 11:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17905\">[17905]</a></span>: Allow shadow to run jobs without a schedd feeding it. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1374\" onclick=\"get_ticket_and_populate_wrapper('1374'); return false;\" title=\"Allow Shadow to run job without a schedd\">#1374</a></span> This is a first cut, there is more work to be done, but this at least gets us started.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Nov-21 15:25", "status": "resolved", "created": "2010-Apr-23 10:11", "fixed_version": "2010-Apr-23 10:11", "broken_version": "", "priority": "4", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "#1095", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}