{"id": 7725, "title": "Ticket #7725: clean up API to wrap / unwrap for encryption", "description": "<blockquote>\nClean up the API to <code>wrap()</code> and <code>unwrap()</code> in <code>authentication.cpp</code>, <code>sock.cpp</code>, <code>reli_sock.cpp</code>.\n\n<p>Created a new type of object <code>Condor_Crypto_State</code> that holds all state for a given encrypted connection:\n</p><ul>\n<li>a <code>KeyInfo</code> object, which contains:\n<ul>\n<li>algorithm\n</li><li>key length\n</li><li>key data\n</li><li>duration\n</li></ul>\n</li><li>iv length\n</li><li>iv data\n</li><li>method_key_data_length and method_key_data - data for use by each specific algorithm.  e.g. 3des stores expanded \"key schedules\" for quicker operation.\n</li><li>num - message number\n</li></ul>\n\n<p>Calls to <code>wrap()=/=unwrap()</code> only use this object to keep state and nothing else.\n\n</p><p>The socket object now keeps a <code>Condor_Crypto_State</code> object which it passes to each call for encryption and decryption.\n\n</p><p>While working on this ticket, I discovered that <code>MUNGE</code>, <code>PASSWORD</code>, and <code>SSL</code> authentication methods also instantiate a <code>Condor_Crypto_3des</code> object (type hard-coded) to use for exchanging key data during authentication.  So they also now contain their own private <code>Condor_Crypto_State</code> object for their own internal use.  This state is separate from the state object used for passing encrypted payloads over the socket post-authentication.\n\n</p><p>The iv length and data are now dynamically sized (used to be hard-coded to be 8 bytes) so each method can use whatever it needs.\n\n</p><p>For serialization/deserialization the IV, method_key_data, and message num are NOT included.  If that is needed a new ticket should be created and linked here.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Jul-08 19:12:45 by tannenba:</em> <br/>\n\nNot sure if the above ticket description quite captures our discussion....\n\n<p>My understanding (without having looked at the code in a long time) is the wrap() and unwrap() functions need some read-only information from the session object (such as algorithm, key), and needs to write some state information into the socket object (as state like IV needs to be kept per socket / tcp connection).  So the thinking was the wrap/unwrap would take read-only ref to the session, and a read/write ref to what amounts to a \"void *\" state buffer to be kept in the socket object.  The socket object does not need to understand or interpret this state buffer, it just needs to pass it into calls to wrap/unwrap.\n\n</p><p></p><hr/>\n<em>2020-Jul-08 20:48:11 by bbockelm:</em> <br/>\n\nAdditional thoughts:\n\n<p></p><ol>\n<li>We will need to move the wrap/unwrap API to work at the message level as opposed to the byte level, at least for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span>.\n</li><li>Something will need to mutate the session state - for non-shared sessions, we'll want to keep a connection counter.  This doesn't have to be the wrap / unwrap API, but the session state may not necessarily be a black box to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span>.\n</li><li>You'll want to have an additional authenticated buffer passed to wrap / unwrap in order to add protection against modification of the pre-encryption handshake and header.  See the AES PR for an example.</li></ol>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60439\">[60439]</a></span>: Squashed commit of V8_9-crypto-wrap-branch. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span> commit 41e0302318d85110938f87e17d40cbaf667ff871 Author: zmiller &lt;zmiller@cs.wisc.edu&gt; Date: Wed Aug 12 13:25:57 2020 -0500 \u00a0[...]\n (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 13:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60438\">[60438]</a></span>: Comment, ifdef, formatting cleanup. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 13:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60437\">[60437]</a></span>: Clean up a couple comments. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60436\">[60436]</a></span>: Remove yet more debugging code. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 12:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60435\">[60435]</a></span>: Final(?) cleanup: rename member variables, remove some unused code, use memset instead of bzero. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-24 13:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60213\">[60213]</a></span>: Clean up debug messages, useless ifdefs, bad comments and formatting. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-24 13:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60212\">[60212]</a></span>: Remove member variables for storing messge num, fixed-size ivec, and specific key types and add dynamically-sized storage in the Condor_Crypto_State object. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-17 16:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60150\">[60150]</a></span>: Remove old code from layers where it doesn't belong. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-17 13:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60149\">[60149]</a></span>: Initial checkin of refactoring crypto state. LOTS OF WORK IN PROGRESS still to be done. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7725\" title=\"clean up API to wrap / unwrap for encryption\">#7725</a></span> Still to be done: Serializing/Deserializing inherited socket info Unifying key data storage in state object Debug message cleanup Remove code that's no longer called ...  (By zmiller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Sep-09 10:43", "status": "resolved", "created": "2020-Jul-06 13:43", "fixed_version": "2020-Jul-06 13:43", "broken_version": "", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#7850", "creator": "zmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "zmiller@cs.wisc.edu, tannenba@cs.wisc.edu BBockelman@morgridge.org", "due_date": "20200713"}