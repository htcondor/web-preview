{"id": 7648, "title": "Ticket #7648: Job submission without Unix account on schedd", "description": "<blockquote>\nI'm looking at supporting a use case where we are providing Jupyter notebooks to anyone within CMS (using their CERN account via OIDC).  We are generating an IDTOKEN on the fly for the container to allow them to submit Dask workers to a local schedd.  We do not want to create a Unix user in our LDAP for everyone using the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JupyterHub\" title=\"Jupyter Hub\">JupyterHub</a></span>, however.\n\n<p>Just as when a job from a different UID domain gets mapped to Unix user 'nobody' when running on a starter, I would like to explore the idea of a user from a different UID domain getting their Owner attribute mapped to Unix user 'nobody' when submitting to a schedd.\n\n</p><p>What does this imply?\n\n</p><p></p><ol>\n<li>User becomes an immutable attribute that reflects the authenticated identity at job submit time.  This is likely worth doing regardless!!\n</li><li><code>SetAttribute</code> code for generating the <code>Owner</code> attribute should set the owner to <code>nobody</code> if the user is from a different domain.\n</li><li>QMGMT owner checks become \"user\" checks.  Authenticated users from a different UID domain should not be able to change each other's jobs.\n</li><li>No longer \"fix\" the user attribute if the <code>Owner</code> is set to <code>nobody</code>.\n</li><li>Ban jobs from user <code>nobody</code> as that's now a reserved attribute.  For backward compatibility reasons, perhaps we can rename the string <code>nobody</code> for people submitting under that name.\n</li><li>Review tools that currently query on <code>Owner</code> to see if they should instead query on <code>User</code> (and then silently truncate the results if the UID_DOMAIN matches the one on the authenticated socket)</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Jun-10 12:33:56 by bbockelm:</em> <br/>\n\nThe first draft of this work is here:\n\n<p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/120\">https://github.com/htcondor/htcondor/pull/120</a>\n\n</p><p>While it currently contains some code relevant to the proposed feature, the more important aspect is it refactors the meaning of <code>User</code> and <code>Owner</code> as proposed (will also attach the longer document written with Miron &amp; Todd).  It has some minimal testing (personal condor functions) but not a full test run.  Modulo bugs (which I'm sure exist), it should have the same observable behavior as current HTCondor installs.\n\n</p><p>The code is not ready to merge but the basic approach is present and would benefit from comments / first-pass review.\n\n</p><p></p><hr/>\n<em>2020-Jun-30 17:28:43 by johnkn:</em> <br/>\n\n<strong>notes</strong>\n\n<p>In qmgmg.cpp at about line 1750 this line </p><div class=\"code\">\n<pre class=\"code\">bool update_uid_domain = uid_domain == g_prior_uid_domain;</pre></div>\n the test should be !=\n\n<p>The logic for handling condor_q only-my-jobs when the connection isn't authenticated is never going to trigger when you compare \"unauthenticated\" to a fully qualified username.\n\n</p><p>The User attribute is now the canonical user identity attribute, this is checked in many places for permissions, but it can still have the \"nice-user.\" prefix, which will break all of those tests.  You need to just kill all of the current \"nice-user\" code, and instead insert \"nice-user.\" into the name attribute that gets stuck into submitter ad.\n\n</p><p>I think that having the Owner attribute not be the same as the part of User before the @ is going to be confusing and surprising.  We should make a new attribute to hold the Schedd local OS user id that takes precedence over Owner when it exists.\n\n</p><p></p><hr/>\n<em>2020-Aug-04 16:05:13 by johnkn:</em> <br/>\n\ncommit <span class=\"chng\"><a href=\"chngview?cn=60357\">[60357]</a></span> refactors the other commits into a patch that makes the owner/user distinction something that can be enabled by a configuration variable <code>USER_IS_THE_NEW_OWNER</code>  This knob is not in the param table, and not intended to ever be public (if so we will rename it).  It exists so that we can get this code into master and begin experimenting with the consequences.\n\n<p></p><hr/>\n<em>2020-Oct-09 09:48:33 by tim:</em> <br/>\n\nExperimental feature. No documentation needed. Resolving.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7783\" title=\"remove existing nice-user mechanism because it pollutes User attribute\">#7783</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nremove existing nice-user mechanism because it pollutes User attribute</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7792\" title=\"Submit should treat nice_user as a shorthand for accounting_group\">#7792</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSubmit should treat nice_user as a shorthand for accounting_group</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/1051/Identities+in+the+SchedD.pdf\">Identities in the SchedD.pdf</a>\n62466 bytes added by bbockelm on 2020-Jun-10 17:34:14 UTC.\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-04 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60357\">[60357]</a></span>: make <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span> enable by param and off by default  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 21:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60351\">[60351]</a></span>: Make flakey test more reliable. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span> This test relied on jobs leaving the queue immediately when a `condor_rm` is executed. Periodically, I'd observe target jobs actually getting started by the shadow - meaning it took a few hundred milliseconds to preempt them and get them to leave the queue.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 21:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60350\">[60350]</a></span>: Fix ctest variant of job router tests. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 21:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60349\">[60349]</a></span>: Fix ability to set owner attributes in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetAttribute\" title=\"Set Attribute\">SetAttribute</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 21:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60348\">[60348]</a></span>: Fix usage of nice-user in User attribute. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span> This catches a couple of comparisons needed for \"nice-user\" and a handful of misspellings.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-17 21:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60347\">[60347]</a></span>: Fix usage of effective FQU. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span> The \"effective\" FQU was not used consistently throughout the QMGMT code. This helps fix cases where a superuser is impersonating and making changes on others' behalf.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 23:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60346\">[60346]</a></span>: Fix logic to start non-UID_DOMAIN jobs as nobody. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 13:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60345\">[60345]</a></span>: Avoid unnecessary param call. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-10 20:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60344\">[60344]</a></span>: Fix minor build issue. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-10 12:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60343\">[60343]</a></span>: Clarify / refactor semantics of `User` and `Owner`. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7648\" title=\"Job submission without Unix account on schedd\">#7648</a></span> This is the first step in refactoring the semantics of the `Owner` and `User` attributes in preparation for cases where `Owner` does not match the `User`.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Oct-09 09:48", "status": "resolved", "created": "2020-May-20 22:44", "fixed_version": "2020-May-20 22:44", "broken_version": "", "priority": "5", "subsystem": "", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelman@morgridge.org", "due_date": ""}