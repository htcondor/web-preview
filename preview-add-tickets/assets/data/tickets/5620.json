{"id": 5620, "title": "Ticket #5620: Fix race condition when removing spot instance requests.", "description": "<blockquote>\nAfter we've successfully cancelled a spot request, we need to wait for the next status update and make sure that the request hasn't spawned an instance.  If it has, be sure to remove that instance, as well.  (The spot request could have been fulfilled at any time after the last status update, right up until the GAHP finally manages to send the cancellation request.)</blockquote>", "remarks": "<blockquote>\n<em>2016-Apr-12 14:56:35 by tlmiller:</em> <br/>\n\nThis patch should be a duplicate of the GM_CANCEL/GM_CANCEL_CHECK logic for spot instances.  Although we've never had a problem with spot request cancellations being ignored or lost (like we did for GM_CANCEL), this patch checks that.  More importantly, it also checks, after sending the cancel, that the spot request didn't spawn an instance since the last time we checked.  (This check, of course, uses information from the batch status poll.)\n\n<p></p><hr/>\n<em>2016-Apr-12 14:59:48 by tlmiller:</em> <br/>\n\nAlso see line 971.\n\n<p></p><hr/>\n<em>2016-May-31 15:02:42 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This code looks good.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-05 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48363\">[48363]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5561\" onclick=\"get_ticket_and_populate_wrapper('5561'); return false;\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5580\" onclick=\"get_ticket_and_populate_wrapper('5580'); return false;\" title=\"Add EC2 GAHP metrics.\">#5580</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5588\" onclick=\"get_ticket_and_populate_wrapper('5588'); return false;\" title=\"[EC2]  Allow removal of spot jobs without instance IDs.\">#5588</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5620\" onclick=\"get_ticket_and_populate_wrapper('5620'); return false;\" title=\"Fix race condition when removing spot instance requests.\">#5620</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5628\" onclick=\"get_ticket_and_populate_wrapper('5628'); return false;\" title=\"Set HoldReasonCode and HoldReasonSubCode to EC2 job holds.\">#5628</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-20 16:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48266\">[48266]</a></span>: Squashed commit of the following: commit 2f666894c803c2bc53fe2a9ba55ae32bd51a3386 Merge: 0ba8935 462ae6d Author: Todd L Miller &lt;tlmiller@cs.wisc.edu&gt; Date: Tue Apr 19 10:47:09 2016 -0500\u00a0[...]\n (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-12 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48203\">[48203]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5620\" onclick=\"get_ticket_and_populate_wrapper('5620'); return false;\" title=\"Fix race condition when removing spot instance requests.\">#5620</a></span>) Wait until the next time we poll the status and verify that the cancelled spot request is (a) cancelled and (b) without a spawned instance.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-May-31 15:14", "status": "resolved", "created": "2016-Apr-12 11:38", "fixed_version": "2016-Apr-12 11:38", "broken_version": "", "priority": "4", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "#5588", "creator": "tlmiller", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}