{"id": 7508, "title": "Ticket #7508: Don't tune kernel if inside a container", "description": "<blockquote>\nThe kernel tuning script, which condor (master?) runs on startup, fails inside unprivileged containers where condor is only UID 0 inside the container, and not outside.  It should not run the script if it doesn't have the privileges to tune anything.  There are multiple ways to do this:\n\n<p>1. test if inside a container and don't run the tuning script if so\n\n</p><p>2. test for the right capability (CAP_SYS_ADMIN?) instead of testing the UID</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Feb-20 15:22:10 by bbockelm:</em> <br/>\n\nNote that, by definition, the initial process in the user namespace has <code>CAP_SYS_ADMIN</code> <strong>within the namespace</strong>.\n\n<p>By design, you can't query if the <code>condor_master</code> has <code>CAP_SYS_ADMIN</code> outside the namespace.\n\n</p><p></p><hr/>\n<em>2020-Feb-25 15:42:42 by gthain:</em> <br/>\n\nSure about that?\n\n<p></p><div class=\"verbatim\">\n<pre>$ docker fedora /usr/sbin/capsh --print\nCurrent: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap+eip\nBounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Feb-25 17:14:43 by bbockelm:</em> <br/>\n\n@gthain - Docker traditionally doesn't utilize user namespaces (requires more elaborate deployments such as OKD which FNAL uses).  Can you confirm it was for your example?\n\n<p></p><hr/>\n<em>2020-Feb-25 17:17:41 by bbockelm:</em> <br/>\n\nSorry, forgot to leave the other half of the thought:\n\n<p>- This is a good improvement in many cases (as Docker is, uh, not exactly uncommon).\n- There are some cases where this is a bad heuristic.  For the sake of Linux security, I hope these cases are more common in the future.\n- We should make the lack of these tunings something that HTCondor can manage cleanly (i.e., either fail with a clear message or ignore the failure).</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "enhance", "last_change": "2020-Nov-09 12:24", "status": "new", "created": "2020-Feb-17 16:58", "fixed_version": "2020-Feb-17 16:58", "broken_version": "v080000", "priority": "3", "subsystem": "Unknown", "assigned_to": "gthain", "derived_from": "", "creator": "matyas", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matyas@cs.wisc.edu", "due_date": ""}