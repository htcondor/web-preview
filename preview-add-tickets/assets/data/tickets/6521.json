{"id": 6521, "title": "Ticket #6521: Optimal preen connections to schedd", "description": "<blockquote>\nIn <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6490\" title=\"Reduce preen connections to schedd\">#6490</a></span> we fixed a defect in how preen cleans up the spool directory. Previously, preen established a blocking connection to the schedd for the entire time it spent cleaning the spool directory -- whether it was needed or not. We changed this to only connect to the schedd when needed, then to disconnect after a certain time interval expired.\n\n<p>However this was only a stopgap measure, not an optimal solution. We want to implement a better approach into preen, as follows:\n\n</p><p>1. When scanning through the spool directory, do not initially establish a connection to the schedd. Keep a list of any files we need more information about.\n\n</p><p>2. After finishing the scan, now connect to the schedd (if needed) and request information about the files. Do not delete files at this point, which could incur expensive disk accesses. Just keep track of which files are stale and need to get deleted.\n\n</p><p>3. Disconnect from the schedd. Now delete the files indicated as stale.\n\n</p><p>It's worth noting there is a possible race condition between steps 2 and 3; the schedd might indicate a file is stale, but then delete it before preen gets a chance. This is correct behavior, we just need to be prepared to handle it.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Jan-23 14:25:17 by coatsworth:</em> <br/>\n\nThis is broken in both stable and release branches. Fix it as first order priority for next release.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-09 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54474\">[54474]</a></span>: Version history: reorder, fix typos, addtl info for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6539\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-26 16:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54365\">[54365]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-29 13:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54185\">[54185]</a></span>: Fixed startd_history and set iterator preen bugs (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54174\">[54174]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=54172\">[54172]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=54173\">[54173]</a></span>, Fixed segfault + overzealous deletion bugs in preen devel (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>) (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6475\" title=\"preen erroneously removes submit digests for active clusters\">#6475</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 15:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54181\">[54181]</a></span>: Fixed preen segfault + overzealous deletions in 8.7.6 (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>) (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6475\" title=\"preen erroneously removes submit digests for active clusters\">#6475</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54172\">[54172]</a></span>: Fixed segfault + core dump bug in preen devel (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 12:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54164\">[54164]</a></span>: Fixed segfault + core dump bug in preen stable (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-09 13:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=53118\">[53118]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=53087\">[53087]</a></span>, Minimized schedd block while preen is cleaning spool files (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-04 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=53087\">[53087]</a></span>: Implemented optimal preen connection to schedd, still need to test (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6521\" title=\"Optimal preen connections to schedd\">#6521</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Mar-09 10:00", "status": "resolved", "created": "2018-Jan-03 13:47", "fixed_version": "2018-Jan-03 13:47", "broken_version": "", "priority": "1", "subsystem": "Tools", "assigned_to": "coatsworth", "derived_from": "#6490", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}