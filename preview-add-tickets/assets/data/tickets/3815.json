{"id": 3815, "title": "Ticket #3815: Projection introduced in #3366 breaks concurrency limits", "description": "<blockquote>\nThe resource ad projection introduced on <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3366\" title=\"scaling higher when NEGOTIATOR_CONSIDER_PREMPTION=False\">#3366</a></span> does not include the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ConcurrrencyLimits\" title=\"Concurrrency Limits\">ConcurrrencyLimits</a></span> attribute, which is required to recompute concurrency limit counts at the beginning of each negotiation cycle.\n\n<p>The effect is that concurrency limits used in previous cycles are not counted, and so concurrency limits won't be respected across multiple cycles.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jul-26 11:13:31 by eje:</em> <br/>\n\nTEST/REPRO\n\n<p>A good way to exercise the behavior across multiple cycles is to set up a p-slot with (say) 4 cpus, and configure a concurrency limit of 3.  \"consider-preemption\" must be false:\n</p><div class=\"code\">\n<pre class=\"code\">NUM_CPUS = 4\n\nSLOT_TYPE_1 = 100%\nSLOT_TYPE_1_PARTITIONABLE = True\nNUM_SLOTS_TYPE_1 = 1\n\n# Turn off preemption.   It's crucial to set \"NEGOTIATOR_CONSIDER_PREEMPTION = False\" for repro.\nCLAIM_WORKLIFE=0\nMAXJOBRETIREMENTTIME = 3600\nPREEMPT = False\nRANK = 0\nPREEMPTION_REQUIREMENTS = False\nNEGOTIATOR_CONSIDER_PREEMPTION = False\nNEGOTIATOR_MATCHLIST_CACHING = False\n\n# verbose logging\nALL_DEBUG = D_FULLDEBUG | D_ACCOUNTANT\n\n# reduce daemon update latencies\nNEGOTIATOR_INTERVAL = 30\nSCHEDD_INTERVAL = 15\n\n# A concurrency limit\nYYZ_LIMIT = 3\n</pre></div>\n\n\n<p>Submit &gt;= 4 jobs, subject to the cc-limit:\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 300\nshould_transfer_files = never\nconcurrency_limits = YYZ\nqueue 10\n</pre></div>\n\n\n<p>Before the fix, you should see one job match per cycle, and 4 jobs will run, instead of 3, which is the correct behavior.  In the negotiator log, you will see that the used concurrency limits are \"forgotten\" each cycle, because the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ConcurrencyLimits\" title=\"Concurrency Limits\">ConcurrencyLimits</a></span> attribute is not present on the claimed dynamic-slots.\n\n</p><p>after the fix, you should see that the number of running jobs is capped at 3, and concurrency limit accounting is correctly maintained across each cycle.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-12 11:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37165\">[37165]</a></span>: rewrite 8.0.2 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3815\" title=\"Projection introduced in #3366 breaks concurrency limits\">#3815</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-26 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37013\">[37013]</a></span>: ===GT:RevisionHistory=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3815\" title=\"Projection introduced in #3366 breaks concurrency limits\">#3815</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-26 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37012\">[37012]</a></span>: Added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ConcurrencyLimits\" title=\"Concurrency Limits\">ConcurrencyLimits</a></span> attribute to projection for claimed slots in negotiator ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3815\" title=\"Projection introduced in #3366 breaks concurrency limits\">#3815</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jul-26 16:15", "status": "resolved", "created": "2013-Jul-25 19:22", "fixed_version": "2013-Jul-25 19:22", "broken_version": "v070903", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "eje", "derived_from": "#3366", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, dan@hep.wisc.edu, tannenba@cs.wisc.edu, bbockelm@cse.unl.edu, matt@cs.wisc.edu, tstclair@redhat.com, johnkn@cs.wisc.edu", "due_date": ""}