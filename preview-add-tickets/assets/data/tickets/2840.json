{"id": 2840, "title": "Ticket #2840: glexec causes jobs to 'exit' without running", "description": "<blockquote>\nWhen condor is configured to use glexec, we have observed a situation where the job appears to exit with status 1, even though the job in fact was never started.  The stderr of the job contains the following message:\n\n<p></p><pre>    fdpass_recv error on new_sock_fd\n</pre>\n\n<p>This was observed at DESY with Condor 7.6.4.\n\n</p><p>Here is the story:\n\n</p><p></p><ol>\n<li>Condor starts condor_glexec_run with only one open file descriptor: fd 0, which is a socket for communication with the starter.\n\n<p></p></li><li>condor_glexec_run calls glexec to run condor_glexec_job_wrapper.\n\n<p></p></li><li>By the time condor_glexec_job_wrapper is run, file descriptors 1 and 3 but not 2 are also open.  They point to some socket (not sure where that came from).\n\n<p></p></li><li>condor_glexec_job_wrapper does not behave correctly if file descriptor 1 and/or 2 are not open.  The fact that 2 is not open therefore triggers the bug.  The bug was introduced in <span class=\"chng\"><a href=\"chngview?cn=11658\">[11658]</a></span> (7.2).  Prior to 7.6.2 (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1642\" onclick=\"get_ticket_and_populate_wrapper('1642'); return false;\" title=\"starter hangs when glexec linger=true\">#1642</a></span>), the effect of this bug in condor_glexec_job_wrapper was different.  It could have caused failure to detect exec() failure when starting the job.  Starting in 7.6.2, the effect of the bug is worse: it causes condor_glexec_job_wrapper to fail to start the job and for Condor to think that the job did start.  In 7.7, this bug does not get triggered, because Condor opens a pipe for stdout/stderr from glexec (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2259\" onclick=\"get_ticket_and_populate_wrapper('2259'); return false;\" title=\"glideins fail to use glexec at lcg grid sites\">#2259</a></span>) and hence is not dependent on how glexec behaves when stdout/stderr are not open when it is called.\n</li></ol>\n\n<p>At DESY, glite-GLEXEC_wn/node-version contains the version string 3.2.6-3, which I believe means glexec is version 0.8.1-1.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Feb-22 17:18:40 by danb:</em> <br/>\n\nThe following shell script can be used to mimic the way condor calls glexec.\n\n<p></p><div class=\"verbatim\">\n<pre>#!/bin/sh\nexec 3&gt;&amp;1 1&gt;&amp;- 2&gt;&amp;- /opt/glite/sbin/glexec /bin/sh -c '/usr/sbin/lsof -p $$ 1&gt;&amp;3'\n</pre></div>\n\n\n<p>At DESY, this shows the problematic 'hole' in the open file descriptors:\n\n</p><p></p><div class=\"verbatim\">\n<pre>bash    12522 cmsplt012    0u   CHR              136,0                2 /dev/pts/0\nbash    12522 cmsplt012    1u  unix 0xffff810424a14f00         60858654 socket\nbash    12522 cmsplt012    3u   CHR              136,0                2 /dev/pts/0\nbash    12522 cmsplt012    4u  unix 0xffff810424a14f00         60858654 socket\nbash    12522 cmsplt012    5r   REG                8,3     646   590363 /opt/glite/etc/lcmaps/lcmaps-glexec.db\n</pre></div>\n\n\n<p>The lcmaps-related file that is open makes me wonder if this problem has something to do with the lcmaps configuration.\n\n</p><p>When I run this test at T2_US_Wisconsin, I get the following (no holes)\n\n</p><p></p><div class=\"verbatim\">\n<pre>bash    16878 osg_cmsuser01    0u   CHR  136,0                2 /dev/pts/0\nbash    16878 osg_cmsuser01    1r   CHR    1,3             2215 /dev/null\nbash    16878 osg_cmsuser01    2r   CHR    1,3             2215 /dev/null\nbash    16878 osg_cmsuser01    3u   CHR  136,0                2 /dev/pts/0\n</pre></div>\n\n\n<p>The Wisconsin glexec is from rpm glexec-0.8.10-8.osg.\n\n</p><p></p><hr/>\n<em>2012-Feb-23 17:17:33 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Wow, what a find, nice detective work.  Patch looks good. Just need a quick version history blurb, so moving ticket to doc pending state.\n\n</p><p></p><hr/>\n<em>2012-Feb-28 11:45:33 by danb:</em> <br/>\n\n\n<p>It turns out that DESY had glexec configured in log-only mode.  This means glexec was not setuid-root.  Linux forces opening of /dev/null for the stdio descriptors for setuid-root programs running as non-root.  This explains why we do not normally see this problem: it only affect log-only mode.  Though Condor no longer cares, Mischa has now fixed gLExec 0.9.3 to open /dev/null for missing stdio descriptors, even when running in log-only mode.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-28 12:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30736\">[30736]</a></span>: Improved documentation of glexec bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2840\" onclick=\"get_ticket_and_populate_wrapper('2840'); return false;\" title=\"glexec causes jobs to 'exit' without running\">#2840</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-27 13:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30712\">[30712]</a></span>: Documented fix for glexec stdout/stderr bug. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2840\" onclick=\"get_ticket_and_populate_wrapper('2840'); return false;\" title=\"glexec causes jobs to 'exit' without running\">#2840</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-22 15:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30674\">[30674]</a></span>: Fixed a bug in condor_glexec_job_wrapper. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2840\" onclick=\"get_ticket_and_populate_wrapper('2840'); return false;\" title=\"glexec causes jobs to 'exit' without running\">#2840</a></span> When condor_glexec_job_wrapper was started (by glexec) without file descriptors 1 and 2 being in use, incorrect behavior resulted.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Feb-28 11:48", "status": "resolved", "created": "2012-Feb-22 15:42", "fixed_version": "2012-Feb-22 15:42", "broken_version": "v070602", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,burt@fnal.gov,zmiller@cs.wisc.edu", "due_date": ""}