{"id": 6272, "title": "Ticket #6272: condor_q reports wrong totals for materialized jobs", "description": "<blockquote>\nWrong totals are visible only when <code>CONDOR_Q_SHOW_OLD_SUMMARY</code> is false, which is not the default in 8.7.1.  Thus, this is (mostly) a bug that was invisible to users before.\n\n<p>But when <code>CONDOR_Q_SHOW_OLD_SUMMARY</code> is false, and a late-materialize job is submitted, the total for idle jobs will not show any of the materialized idle jobs, and when those jobs go to the running state, the count of idle jobs will be <strong>decremented</strong>.  This results in a low, or even negative count of idle jobs.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-May-19 13:30:56 by johnkn:</em> <br/>\n\nWhile chasing this bug. I realized that <code>CommitTransaction</code> in qmgmt.cpp will start a new transaction for jobs that have just been submitted in the hold-for-job-spooling state.  This nested transaction breaks the transaction triggers callback mechanism which is used to track jobs changing state and to update per-job-state counters.\n\n<p>The particular work done by this nested transaction doesn't change the job state, but this is still a potential problem for future transaction trigger'd callbacks, so work done in the nested transaction will instead by moved into the same function that currently does job transforms and submit requirements.  This will cause the changes to happen before the current transaction is committed. Only creation of the job spool directory will happen (as it does now) after the transaction is committed.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jun-20 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51746\">[51746]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6246\" title=\"job materialization in the schedd should not do file checks\">#6246</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6272\" title=\"condor_q reports wrong totals for materialized jobs\">#6272</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-19 13:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50692\">[50692]</a></span>: fix bug that caused late materized jobs to be mis-counted in the totals returned to condor_q by the schedd <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6272\" title=\"condor_q reports wrong totals for materialized jobs\">#6272</a></span>. This bug was introduced in 8.7.1 but not visible until the default for CONDOR_Q_SHOW_OLD_SUMMARY was changed to false as part of the 8.7.2 release work. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jun-20 10:18", "status": "resolved", "created": "2017-May-19 13:26", "fixed_version": "2017-May-19 13:26", "broken_version": "v080701", "priority": "4", "subsystem": "", "assigned_to": "johnkn", "derived_from": "#6166", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}