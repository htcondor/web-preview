{"id": 6177, "title": "Ticket #6177: Removing items while iterating HashTable can fail", "description": "<blockquote>\nTracking down the segfault in DAGMan (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6170\" onclick=\"get_ticket_and_populate_wrapper('6170'); return false;\" title=\"DAGMan crashes when parsing DAG with many splices.\">#6170</a></span>).  Turns out the problem is this:  if you're iterating through a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span>, and removing each object as you go, the interaction between remove() and iterate() is not correct.  If multiple keys in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> hash to an index of 0, you only see one of those items; when you remove it from the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span>, iterate() skips over all other items that hash to index 0.\n\n<p>The problematic code is this:\n\n</p><p></p><pre>  // if the item being deleted is being iterated, ensure that\n  // next iteration returns the object \"after\" this one\n  if (bucket == currentItem)\n  {\n      currentItem = 0;\n      if (--currentBucket &lt; 0) currentBucket = 0;\n  }\n</pre>\n\n<p>It turns out that we need to allow currentBucket to be set back to -1...\n\n</p><p>I'm currently testing a fix for this...</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Mar-07 15:01:05 by wenger:</em> <br/>\n\nCreated V8_6-gittrac_6177-branch for this.\n\n<p></p><hr/>\n<em>2017-Mar-08 10:22:10 by wenger:</em> <br/>\n\nDid a build/test of checkin 50281, and everything worked except for one test on one platform, so I'm figuring that's pretty likely a random test failure.\n\n<p>Anyhow, I still need to test the external iterators and check for other possible errors in the code...\n\n</p><p></p><hr/>\n<em>2017-Mar-10 09:59:05 by wenger:</em> <br/>\n\nThis has passed builds/tests, and also checking with valgrind, so I'm going to assign it to Greg for review...\n\n<p></p><hr/>\n<em>2017-Mar-16 16:33:29 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  The code is correct, with the caveat that 0 is a legal, in-use value for currentBucket, and -1 means there's no currentBucket.  Can we change the code from\n\n<p></p><div class=\"code\">\n<pre class=\"code\">if (--currentBucket &lt; -1) currentBucket = -1;\n</pre></div>\n\n\n<p>to\n</p><div class=\"code\">\n<pre class=\"code\">if (--currentBucket &lt; 0) currentBucket = -1\n\n</pre></div>\n\n\n<p>It does the same thing, but I think it is clearer.\n\n</p><p>otherwise, go ahead and merge.\n\n</p><p></p><hr/>\n<em>2017-Mar-16 16:36:05 by wenger:</em> <br/>\n\nAh, I like your suggestion, Greg.  I'll make that change and probably add a comment or two...\n\n<p></p><hr/>\n<em>2017-Apr-17 17:03:06 by tim:</em> <br/>\n\n<strong>DOC REVIEW:</strong> Looks good</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=6180\" onclick=\"get_ticket_and_populate_wrapper('6180'); return false;\" title=\"Problems with HashTable code -- fix or use STL\">#6180</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nProblems with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> code -- fix or use STL</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/983/gt6177_diff.txt\">gt6177_diff.txt</a>\n2516 bytes added by wenger on 2017-Mar-10 15:58:17 UTC.\n<br/>\nHere's a full diff of the branch.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-18 15:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50342\">[50342]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span>: Slight changes as per code review.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-08 13:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50290\">[50290]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span>: Added version history item.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-08 12:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50289\">[50289]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span>: Very slight cleanup.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-07 15:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50281\">[50281]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span>: Committing a fix to the basic problem (also see gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6170\" onclick=\"get_ticket_and_populate_wrapper('6170'); return false;\" title=\"DAGMan crashes when parsing DAG with many splices.\">#6170</a></span>); need to do further checking/testing of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> code to look for other problems...  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Apr-17 17:03", "status": "resolved", "created": "2017-Mar-07 14:12", "fixed_version": "2017-Mar-07 14:12", "broken_version": "v080601", "priority": "1", "subsystem": "Libs", "assigned_to": "wenger", "derived_from": "#6170", "creator": "wenger", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "wenger@cs.wisc.edu, tannenba@cs.wisc.edu, ghtain@cs.wisc.edu", "due_date": ""}