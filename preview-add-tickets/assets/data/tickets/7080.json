{"id": 7080, "title": "Ticket #7080: Auto-approve token rules", "description": "<blockquote>\nNow that we have the ability to request tokens in <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7006\" title=\"Add support for a token request workflow\">#7006</a></span>, we should allow the sysadmin to install auto-approval rules:\n\n<p></p><ol>\n<li>These rules should be time-limited (i.e., admin needs to specify that they are\u00a0only valid for 1 hour).\n<ul>\n<li>To allow for pools coming up quickly, requests predating the rule's installation (say, by 30 seconds) should be approved once the rule is installed.\n</li></ul>\n</li><li>The admin should be able to specify a netblock (e.g., 192.168.0.0/24) the rule is valid for.\n</li><li>The rule should only allow a very narrow set of fixed authorizations and identities.  That is, this should only be allowed for token requests with the identity <code>condor</code> and requesting the authorization for <code>ADVERTISE_SCHEDD</code> or <code>ADVERTISE_STARTD</code>.</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-May-30 14:37:19 by tlmiller:</em> <br/>\n\n\n<p>BrianB and I had a discussion and we agree that:\n\n</p><p></p><ul>\n<li>The CLI should have a default lifetime, but not a default netmask, unless (bonus feature) PRIVATE_NETWORK_NAME is set, in which case the default is the private network .  Otherwise, we just have to ask (and not do anything).\n\n<p></p></li><li>The CLI should tell the user what we're doing (e.g., confirm lifetime with time units and netmask).\n\n<p></p></li><li>Instead of trying to guess a good time-out for historical auto-approval, the CLI should list all of the requests from that time period (just like the list tokens command) and say \"to approve all these requests, run the following command.\"  It should also mention, if there are any requests older than that, how to get a list of them (e..g, condor_list_tokens &lt;num... num&gt;).\n\n<p></p></li><li>We should always log autoapprovals, but the first autoapproval for each rule should also log the rule in question (like security rejections).\n\n<p></p></li><li><code>condor_reconfig</code> should flush (delete) the autoapproval rules (and the collector should log that they're gone).  This may be a little surprising, but we can argue that since the rules aren't in the config files, they shouldn't be in the configuration after a reconfig.\n\n<p></p></li><li>Likewise, <code>condor_config</code> should flush (delete) pending requests.\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Jun-10 08:59:04 by bbockelm:</em> <br/>\n\nThe PR <a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/50\">https://github.com/htcondor/htcondor/pull/50</a> should have all the above addressed except for the <code>PRIVATE_NETWORK_NAME</code> pieces; that's a good idea, but isn't really how that particular knob works.\n\n<p></p><hr/>\n<em>2019-Jun-21 08:26:43 by bbockelm:</em> <br/>\n\nMerged master back into the branch and updated <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GitHub\" title=\"Git Hub\">GitHub</a></span>.  <code>ctest</code> run looks good on RHEL7.\n\n<p>Ready for review.\n\n</p><p></p><hr/>\n<em>2019-Jun-28 17:24:35 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ol>\n<li>I hoisted two of the checks out the per-rule loop in <code>TokenRequest::ShouldAutoApprove()</code>, because they didn't depend on the rule.  Let me know if you had meant to be inefficient there for the sake of the logging.\n</li><li>I moved the unimplemented features from the commentary to <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=7137\" title=\"Improve token request auto-approval UX\">#7137</a></span>.\n</li><li>This is bad and wrong: <div class=\"term\">\n<pre class=\"term\">$ condor_token_request_auto_approve -netblock 192.168.0.0/36 -lifetime 3700\nSuccessfully installed auto-approval rule for netblock 192.168.0.0/36 with lifetime of 1.03 hours\n</pre></div>\n  So is this: <div class=\"term\">\n<pre class=\"term\">condor_token_request_auto_approve -netblock 192::168.0.0/36 -lifetime -3700\nSuccessfully installed auto-approval rule for netblock 192::168.0.0/36 with lifetime of -1.03 hours\nRemote daemon reports no un-approved requests pending.\n</pre></div>\n  I don't know that we need to have the CLI do any particular filtering, but it seems like the server should.\n</li></ol>\n\n<p></p><hr/>\n<em>2019-Jun-28 17:26:59 by tlmiller:</em> <br/>\n\nChanges pushed to <code>v8_9-gt7080-branch</code> in the UW repository.\n\n<p></p><hr/>\n<em>2019-Jul-05 17:19:35 by tlmiller:</em> <br/>\n\nMerged.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=7137\" title=\"Improve token request auto-approval UX\">#7137</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove token request auto-approval UX</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-04 21:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57586\">[57586]</a></span>: Add documentation for auto-approval and other requests. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7006\" title=\"Add support for a token request workflow\">#7006</a></span> Also includes documents for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7094\" title=\"Auto-request tokens based on missing trust domains.\">#7094</a></span>.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-24 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57468\">[57468]</a></span>: Make a copy of reference variable. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span> When auto-approve rules are installed, this avoids a potential segfault by making a copy of the `TokenRequest` object prior to deleting the entry in the request map. Previously, when a reference was used, there was a potential use-after-free in the log line.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-06 07:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57337\">[57337]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>) Add token auto approve binary to RPM package  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-03 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57310\">[57310]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>) Reject rules with invalid netblocks.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-03 14:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57309\">[57309]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>) Reject rule lifetimes of &lt;= 0 in the client and at the server.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-28 17:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57260\">[57260]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>) Small changes from code review.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-20 20:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57258\">[57258]</a></span>: Fix silly printf-formatting warning. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57256\">[57256]</a></span>: Force use of encryption when we aren't using auto-approve. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57254\">[57254]</a></span>: Clear rules and requests on reconfig. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57255\">[57255]</a></span>: Always try TOKEN requests, even after DENIED. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span> When only the incorrect token is available, we should still give token requests a shot. For example, if the schedd auto-generated token is present, the startd should still try to get its own token (as the schedd token does not have authorization for\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57253\">[57253]</a></span>: Improve logging and user interface. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span> Be more pedantic about logging requests and update the user interface to match the discussions in the ticket. Require netblock to be set and have more reasonable values for lifetime.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57252\">[57252]</a></span>: Limit which token requests are eligible for auto-approve. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57251\">[57251]</a></span>: Add command line for token auto-approval. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-10 22:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57250\">[57250]</a></span>: Add token auto-approval RPC. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7080\" title=\"Auto-approve token rules\">#7080</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Aug-04 21:47", "status": "resolved", "created": "2019-May-30 08:35", "fixed_version": "2019-May-30 08:35", "broken_version": "", "priority": "3", "subsystem": "Security", "assigned_to": "bbockelm", "derived_from": "#7006", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelman@morgridge.org", "due_date": ""}