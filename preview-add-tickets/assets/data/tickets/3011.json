{"id": 3011, "title": "Ticket #3011: large accountant logs cause very long negotiator reconfigs", "description": "<blockquote>\nThere is a scaling problem with large accountant logs that can be seen when using reconfigs and also on startup. A 25MB log can require a 60 sec reconfig. This causes problems when trying to keep negotiation cycles short and the period between cycles stable.\n\n<p>I've tracked this down to n^2 in Accountant::Initialize. The accountant reads the accountant log into a table. Accountant::Initialize runs through this table looking at all the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CustomerRecords\" title=\"Customer Records\">CustomerRecords</a></span> and creates a user list. Then it iterates through the user list and for each user calls Accountant::ReportState. Accountant::ReportState iterates through the table looking at every <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResourceRecord\" title=\"Resource Record\">ResourceRecord</a></span> to match the user.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-21 13:32:47 by eje:</em> <br/>\n\nREPRO:\n\n<p>No special configuration is required except to enable D_ACCOUNTANT:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG | D_ACCOUNTANT</pre></div>\n\n\n<p>The important thing is to generate a large accountant <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log table, which can be done by starting up a pool, and using condor_setprio to generate entries in the accountant table:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_master\n\n# create 5000 user entries in the accountant:\n$ time for j in {0..5000}; do condor_userprio -setprio user\"$j\"@localdomain 1.0; done &gt; /dev/null\n\nreal\t7m18.727s\nuser\t1m20.221s\nsys\t0m49.676s\n</pre></div>\n\n\n<p>Next, stop the negotiator, then begin listening on the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NegotiatorLog\" title=\"Negotiator Log\">NegotiatorLog</a></span>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_off -neg\n$ tail -f NegotiatorLog | grep -e 'Sanity check' -e 'NEGOTIATOR_POST_JOB_RANK'\n</pre></div>\n\n\n<p>In another terminal, now re-start the negotiator using \"condor_on -neg\".  Verify that sanity checking happens, and that it takes some measurable time (in my case, it was about 15 seconds, with 5000 user entries):\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e 'Sanity check' -e 'NEGOTIATOR_POST_JOB_RANK'\n08/21/12 11:21:07 Sanity check on number of resources per user\n08/21/12 11:21:22 NEGOTIATOR_POST_JOB_RANK = 0\n</pre></div>\n\n\n<p>Next, in the other terminal, invoke \"condor_reconfig -neg\" to reconfigure the negotiator.  Back on the log output, verify that the sanity check happens again - this sanity check is redundant, since the negotiator has already started and checked its entries:\n</p><div class=\"code\">\n<pre class=\"code\">08/21/12 11:21:33 Sanity check on number of resources per user\n08/21/12 11:21:47 NEGOTIATOR_POST_JOB_RANK = 0\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Aug-21 13:46:37 by eje:</em> <br/>\n\nTEST:\n\n<p>to test the fix, use the same procedure as the REPRO above.  However, there should now be two differences.  After invoking \"condor_on -neg\", the initial sanity check should be faster.  In my case, I measured about 5 seconds instead of the original 15 seconds:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e 'Sanity check' -e 'NEGOTIATOR_POST_JOB_RANK'\n08/21/12 11:43:03 Sanity check on number of resources per user\n08/21/12 11:43:08 NEGOTIATOR_POST_JOB_RANK = 0\n</pre></div>\n\n\n<p>After invoking \"condor_reconfig -neg\" to reconfigure, there should be no sanity check from the reconfiguration:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">08/21/12 11:43:18 NEGOTIATOR_POST_JOB_RANK = 0\n</pre></div>\n\n<hr/>\n<em>2012-Oct-22 14:59:14 by zmiller:</em> <br/>\n\nBulk change of target version from v070901 to v070902 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/567/first_time.patch\">first_time.patch</a>\n584 bytes added by jrt on 2012-May-31 16:16:30 UTC.\n<br/>\nThis block of code was setup with static bool first_time = true and if ( first_time ) but first_time was never set to false at the end of the block.\n\n<p>the patch adds this<br/>\n</p></li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-07 11:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33301\">[33301]</a></span>: edit 7.9.1 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3011\" title=\"large accountant logs cause very long negotiator reconfigs\">#3011</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-21 11:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33124\">[33124]</a></span>: ===VersionHistory:Completed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3011\" title=\"large accountant logs cause very long negotiator reconfigs\">#3011</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-21 11:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33123\">[33123]</a></span>: Properly enforce once-only resource check on accountant startup, improve check efficiency ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3011\" title=\"large accountant logs cause very long negotiator reconfigs\">#3011</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-22 15:53", "status": "resolved", "created": "2012-May-25 15:00", "fixed_version": "2012-May-25 15:00", "broken_version": "v070604", "priority": "3", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, eje@cs.wisc.edu", "due_date": ""}