{"id": 1363, "title": "Ticket #1363: condor_status -collector broken: \"Error: communication error\"", "description": "<blockquote>\nOn the CS pool, \"condor_status -collector\" returns \"Error: communication error\".  This has also been observed on CHTC.\n\n<p>Tracing in GDB, it's failing in CondorQuery::fetchAds, condor_query.cpp:531:\n</p><div class=\"code\">\n<pre class=\"code\">528\t\tmore = 1;\n529\t\twhile (more)\n530\t\t{\n531\t\t\tif (!sock-&gt;code (more)) {\n532\t\t\t\tsock-&gt;end_of_message();\n533\t\t\t\tdelete sock;\n534\t\t\t\treturn Q_COMMUNICATION_ERROR;\n535\t\t\t}\n</pre></div>\n\n\n<p>The call to sock-&gt;code is failing.  condor_status tries to contact all three collectors without luck.\n\n</p><p>Related task: There doesn't appear to be a condor_status -collector test.  Ensure there is a test for all possible condor_status -subsystems, as well as -all.  If this doesn't get checked before this ticket is resolved, add a new ticket.\n\n</p><p>Probably related: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1319\" onclick=\"get_ticket_and_populate_wrapper('1319'); return false;\" title=\"Bad -constraint to condor_status returns unhelpful error\">#1319</a></span>: Bad -constraint to condor_status returns unhelpful error</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2010-Sep-27 14:54:50 by adesmet:</em> <br/>\n\nAdditional notes:\n\n<p>On NMI machines (say, nmi-s006), we have a collector ad, but condor_status -collector returns nothing:\n</p><div class=\"code\">\n<pre class=\"code\">% condor_status -any | grep Col\nCollector            None                 UW NMI Build and Test Pool\n% condor_status -collector\n\n%\n</pre></div>\n\n\n<p>Expected behavior:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">% condor_status -any | grep Col\nCollector            None                 UW NMI Build and Test Pool\n% condor_status -collector\n\nName                 Machine               Running  IdleJobs  HostsTotal\n\nUW NMI Build and Tes nmi-0011.cs.wisc.edu        0        0         2\n%\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Sep-27 15:00:56 by adesmet:</em> <br/>\n\nCHTC submit node:\n<div class=\"code\">\n<pre class=\"code\">% condor_status -any | grep Col\nCollector            None                 My Pool@cm.chtc.wisc.edu\n% condor_status -collector\nError: communication error\n\n%\n</pre></div>\n\n<hr/>\n<hr/>\n<em>2013-May-31 17:02:28 by tannenba:</em> <br/>\n\nThis is a security issue.\n\n<p>What we want is if the machine is the <code>CONDOR_DEVELOPER_COLLECTOR</code>, then it should only return collector ads if the client is authorized as ADMINISTRATOR, else it should return collector ads at READ authentication level.  And this behavior should be consistent, regardless of if the command is a QUERY_ANY or a QUERY_COLLECTOR_ADS.\n\n</p><p></p><hr/>\n<em>2013-Oct-21 16:59:18 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>One small concern: The expression rewriting and log messages are triggered for any query of something other than collector ads (if the knob is enabled). We could limit the check to queries of all ad types.\n\n</p><p>Since this will only happen on our CS collector and the logging level is D_FULLDEBUG, it's a minor issue.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-21 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37944\">[37944]</a></span>: Added knob to prevent Collector Ads from being returned in READ-level queries. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1363\" onclick=\"get_ticket_and_populate_wrapper('1363'); return false;\" title='condor_status -collector broken: \"Error: communication error\"'>#1363</a></span>)  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Oct-22 10:57", "status": "resolved", "created": "2010-Apr-16 15:51", "fixed_version": "2010-Apr-16 15:51", "broken_version": "v070402", "priority": "1", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}