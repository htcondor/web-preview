{"id": 1834, "title": "Ticket #1834: Add support for GSI authz mapping callout", "description": "<blockquote>\nBy adding support for the globus authz callout, Condor can make use of GUMS, which would provide greater flexibility in mapping, including mappings that are sensitive to VOMS attributes, mappings that automatically assign accounts from an account pool, and so on.</blockquote>", "remarks": "<blockquote>\n<em>2011-Jan-05 13:28:44 by danb:</em> <br/>\n\nI am assuming that Globus finds the authz configuration files via the environment variable GSI_AUTHZ_CONF and falls back to the default system location.  If that is true, should this environment variable be configured by Condor?  That would be consistent with how other Globus environment variables are handled.\n\n<p></p><hr/>\n<em>2011-Jan-05 14:01:37 by bbockelm:</em> <br/>\n\nYes - $GSI_AUTHZ_CONF overrides the default gsi-auth.conf location.  I don't know what Condor policy is here (whether it's left for the sysadmin to ensure the safety of environment variables), but I can see a reasonable argument for having Condor control this variable.  Especially if there's precedent elsewhere.\n\n<p>The search paths are:\n</p><ol>\n<li>$GSI_AUTHZ_CONF\n</li><li>/etc/grid-security/gsi-authz.conf\n</li><li>$GLOBUS_LOCATION/etc/gsi-authz.conf\n</li><li>~/.gsi-authz.conf\n</li></ol>\n\n<p></p><hr/>\n<em>2011-Jan-11 20:50:57 by bbockelm:</em> <br/>\n\nWARNING!\n\n<p>We are mysteriously seeing crashes on our glidein host which I <strong>think</strong> are related to this patch.  See the \"pstack\" from one of our shadows below.\n\n</p><p>Globus is starting a thread pool when initialize, meaning the shadow gets 4 total threads.  This is exhausting some resource on our system (number of threads?  32k is our pid_max, and we crash at somewhere around 8k running jobs on the schedd.  Other culprits are running out of FDs, as the schedd dies with exit code 44, which is DPRINTF_FAILURE)\n\n</p><p>Brian\n\n</p><p></p><div class=\"verbatim\">\n<pre>Thread 4 (Thread 0x42209940 (LWP 19663)):\n#0  0x00000034b3e0e838 in do_sigwait () from /lib64/libpthread.so.0\n#1  0x00000034b3e0e8dd in sigwait () from /lib64/libpthread.so.0\n#2  0x0000003525816709 in ?? () from /usr/lib64/libglobus_common.so.0\n#3  0x000000352582c400 in ?? () from /usr/lib64/libglobus_common.so.0\n#4  0x00000034b3e0673d in start_thread () from /lib64/libpthread.so.0\n#5  0x00000034b36d3f6d in clone () from /lib64/libc.so.6\nThread 3 (Thread 0x42c0a940 (LWP 19664)):\n#0  0x00000034b3e0aee9 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0\n#1  0x000000352582bdb6 in globus_cond_wait () from /usr/lib64/libglobus_common.so.0\n#2  0x00000035258179bc in ?? () from /usr/lib64/libglobus_common.so.0\n#3  0x000000352582c697 in globus_l_thread_pool_thread_start () from /usr/lib64/libglobus_common.so.0\n#4  0x000000352582c400 in ?? () from /usr/lib64/libglobus_common.so.0\n#5  0x00000034b3e0673d in start_thread () from /lib64/libpthread.so.0\n#6  0x00000034b36d3f6d in clone () from /lib64/libc.so.6\nThread 2 (Thread 0x4360b940 (LWP 19665)):\n#0  0x00000034b3e0aee9 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0\n#1  0x000000352582bdb6 in globus_cond_wait () from /usr/lib64/libglobus_common.so.0\n#2  0x00000035258179bc in ?? () from /usr/lib64/libglobus_common.so.0\n#3  0x000000352582c697 in globus_l_thread_pool_thread_start () from /usr/lib64/libglobus_common.so.0\n#4  0x000000352582c400 in ?? () from /usr/lib64/libglobus_common.so.0\n#5  0x00000034b3e0673d in start_thread () from /lib64/libpthread.so.0\n#6  0x00000034b36d3f6d in clone () from /lib64/libc.so.6\nThread 1 (Thread 0x2b35d98caf20 (LWP 19626)):\n#0  0x00000034b36cd212 in select () from /lib64/libc.so.6\n#1  0x000000000054c3c5 in Selector::execute() ()\n#2  0x00000000004a6f97 in DaemonCore::Driver() ()\n#3  0x000000000049b7b7 in main ()\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Jan-11 20:59:07 by bbockelm:</em> <br/>\n\nActually, it's almost certainly the number of open files:\n\n<p></p><div class=\"verbatim\">\n<pre>[root@glidein ~]# cat /proc/sys/fs/file-nr\n269790\t0\t300000\n</pre></div>\n\n\n<p>So, the number of threads must cause more files to be open... leading us to have an average of 30-ish files opened per shadow (maybe the surprising numbers are due to something silly globus is doing again?).\n\n</p><p>That said, we're going to crank up the file and pid max and see how much damage we can inflict.\n</p><hr/>\n<em>2011-Feb-01 16:20:02 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2103\" onclick=\"get_ticket_and_populate_wrapper('2103'); return false;\" title=\"Control GSI_AUTHZ_CONF environment variable via condor configuration\">#2103</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nControl GSI_AUTHZ_CONF environment variable via condor configuration</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2104\" onclick=\"get_ticket_and_populate_wrapper('2104'); return false;\" title=\"condor_master crashed during globus mapping callout\">#2104</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_master crashed during globus mapping callout</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-05 13:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=19859\">[19859]</a></span>: Add support for using the globus authz callout. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1834\" onclick=\"get_ticket_and_populate_wrapper('1834'); return false;\" title=\"Add support for GSI authz mapping callout\">#1834</a></span> Committer: Dan Bradley  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Apr-27 13:52", "status": "resolved", "created": "2011-Jan-05 13:21", "fixed_version": "2011-Jan-05 13:21", "broken_version": "v070506", "priority": "4", "subsystem": "", "assigned_to": "bbockelm", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu,dan@hep.wisc.edu,zmiller@cs.wisc.edu", "due_date": ""}