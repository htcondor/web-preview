{"id": 2096, "title": "Ticket #2096: Condor should rebuild environment post-gLexec", "description": "<blockquote>\ngLexec is invoked by one UID (the glexecer), maps a new UID based on the proxy, and changes to a different UID (the glexecee).\n\n<p>gLexec itself is known to strip out the environment.  For glideins with </p><div class=\"verbatim\">\n<pre>JOB_INHERITS_STARTER_ENVIRONMENT = True</pre></div>\n Condor should rebuild the environment, in effect passing the glexecer environment down to the glexecee.</blockquote>", "remarks": "<blockquote>\n<em>2011-Apr-26 16:29:25 by burt:</em> <br/>\n\nActually, Igor thinks it's only the PATH environment variable that is not getting properly rebuilt and the rest of the environment might be ok.\n\n<p></p><hr/>\n<em>2011-May-23 14:58:36 by danb:</em> <br/>\n\nDo we know if there is a good reason for glexec to mess with PATH?  If yes, perhaps we should think twice?  If no, can glexec be fixed?\n\n<p>I'm not trying to be lazy here (yet).  I'm just curious what the thinking is.\n\n</p><p></p><hr/>\n<em>2011-May-23 15:25:13 by danb (for Igor):</em> <br/>\n\nWe have actually implemented a workaround that passes the PATH in a different env variable, and restores it in the job wrapper.\nSo, from a practical point of view, we are happy in propagating the PATH.\n\n<p>But if any security expert can tell us why this is bad, I would be interested to hear it.\n\n</p><p></p><hr/>\n<em>2011-May-23 15:29:00 by danb:</em> <br/>\n\nShould we approach the glexec developers and ask them to make this change?  Implementing a hack in Condor to work around this seems appropriate if necessary.  I'm just still hoping it's not necessary.\n\n<p></p><hr/>\n<em>2011-May-23 16:00:00 by danb (for Igor):</em> <br/>\n\nI would be surprised if it was a glexec problem.\nglexec already destroys all the environment.\n\n<p>Condor then reconstructs it.\nThe question is:\nWhy it reconstructes everything but PATH?\n\n</p><p></p><hr/>\n<em>2011-Jul-19 17:07:50 by danb:</em> <br/>\n\nI discovered today that when condor reconstructs the job environment, it overrides all variables in the job environment with any variables set by glexec.  PATH is one of the variables set by glexec.  That explains the behavior you observed.\n\n<p>I am inclined to reverse the order of precedence.  If there is a conflict between intended job environment and environment set by glexec, we should use the job environment.\n\n</p><p>I am a little unsure about whether to make this change in the stable series or not.  It could be considered a behavioral change or a bug fix.  I have to make this change at least for X509_USER_PROXY in the stable series in order to be able to have proxy updates take effect when using glexec 0.7+.  I suppose we could be conservative and just treat PATH specially as well, rather than changing the precedence of all variables.\n\n</p><p>With glexec 0.6.8-3, I see the following environment from within a process launched by glexec:\n\n</p><p></p><div class=\"verbatim\">\n<pre>PATH=/usr/local/bin:/usr/bin:/bin\nGLEXEC_CLIENT_CERT=/tmp/x509up_u275\nHOME=/osghome/osg_cmsuser01\nLCMAPS_LOG_LEVEL=1\nLCMAPS_DEBUG_LEVEL=0\nLCMAPS_DB_FILE=/etc/glexec/lcmaps/lcmaps-suexec.db\nLCMAPS_LOG_FILE=/var/log/glexec/lcas_lcmaps.log\nLCAS_LOG_LEVEL=1\nLCAS_DEBUG_LEVEL=0\nLCAS_DB_FILE=/etc/glexec/lcas/lcas-suexec.db\nLCAS_LOG_FILE=/var/log/glexec/lcas_lcmaps.log\nJOB_REPOSITORY_ID=2011-07-19.16:35:00-22437\nLCMAPS_VERIFY_TYPE=uid_pgid\nLCMAPS_POLICY_NAME=glexec_get_account\nLCMAPS_LOG_STRING=2011-07-19.16:35:00-22437-glexec_get_accounts\nLCAS_LOG_STRING=2011-07-19.16:35:00-22437-glexec_get_accounts\n</pre></div>\n\n\n<p>I believe newer versions of glexec also set LOGNAME, USER, and X509_USER_PROXY.\n\n</p><p>The only problem that I can think of if any of these environment variables were overwritten by variables set by Condor or by the job <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span>, is that nested invocations of glexec would not overwrite the LCAS/LCMAPS/JOB_REPOSITORY_ID variables.  After the first invocation, these variables would all be frozen.\n\n</p><p></p><hr/>\n<em>2011-Aug-18 15:01:26 by danb:</em> <br/>\n\nI talked with both Jim Kupsch and Zach.  They agreed to the plan.  In the stable series (7.6.4), we make a special case to preserve the job's PATH.  In the development series (7.7.2), whenever there is any conflict, job environment trumps environment inherited from glexec.\n\n<p></p><hr/>\n<em>2011-Aug-22 12:01:26 by zmiller:</em> <br/>\n\nDidn't get to the review yet, will have it done by this wednesday.  Changing due date.\n\n<p></p><hr/>\n<em>2011-Aug-29 15:58:53 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW LOOKS GOOD, RESOLVING</strong></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26871\">[26871]</a></span>: Documented fix for PATH getting cleared by glexec. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2096\" onclick=\"get_ticket_and_populate_wrapper('2096'); return false;\" title=\"Condor should rebuild environment post-gLexec\">#2096</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26869\">[26869]</a></span>: Job environment now trumps glexec environment. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2096\" onclick=\"get_ticket_and_populate_wrapper('2096'); return false;\" title=\"Condor should rebuild environment post-gLexec\">#2096</a></span> ===VersionHistory=== All Complete  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26870\">[26870]</a></span>: Documented fix for job environment trumping glexec environment. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2096\" onclick=\"get_ticket_and_populate_wrapper('2096'); return false;\" title=\"Condor should rebuild environment post-gLexec\">#2096</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 12:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26855\">[26855]</a></span>: Prevent glexec from overriding the job's PATH environment variable. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2096\" onclick=\"get_ticket_and_populate_wrapper('2096'); return false;\" title=\"Condor should rebuild environment post-gLexec\">#2096</a></span> ===VersionHistory=== All Complete  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Aug-29 15:59", "status": "resolved", "created": "2011-Apr-26 16:04", "fixed_version": "2011-Apr-26 16:04", "broken_version": "v070600", "priority": "4", "subsystem": "Unknown", "assigned_to": "zmiller", "derived_from": "", "creator": "burt", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "sfiligoi@fnal.gov, burt@fnal.gov,dan@hep.wisc.edu", "due_date": "20110824"}