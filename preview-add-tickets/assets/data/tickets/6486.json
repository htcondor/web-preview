{"id": 6486, "title": "Ticket #6486: Merge python bindings pypi_staging target", "description": "<blockquote>\nWheels for uploading to PyPI can be built using the pypi_build target when using the last couple V8_7_x-pip branches. This build target should be merged into master, if nothing else for automation purposes, but the changes made in <span class=\"chng\"><a href=\"chngview?cn=52331\">[52331]</a></span> breaks builds of other targets (which build the python bindings). The broken parts should be mostly related to the shifting of code from one file to another, e.g. <code>classad_module.cpp -&gt; _classad_module.cpp</code>.</blockquote>", "remarks": "<blockquote>\n<em>2017-Nov-17 15:38:06 by jpatton:</em> <br/>\n\n1. Different linker on more recent Debian (and Debian-based) distros causing problems when building libpyclassad (need to mkdir first? investigating...)\n\n<p>2. <code>get_statistics()</code> in <a class=\"file\" href=\"rlog?f=src/condor_io/reli_sock.cpp\">/src/condor_io/reli_sock.cpp</a> references keys in the iperf <code>tcp_info</code> struct that are not provided by the version of iperf in the manylinux docker container:\n\n</p><p></p><ul>\n<li>tcpi_rcv_rtt\n</li><li>tcpi_rcv_space\n</li><li>tcpi_total_retrans\n</li></ul>\n\n<p>Should we just patch these out when building in a manylinux container? Upgrade iperf in our version of the container? Wait for \"manylinux2\" ( <a class=\"external\" href=\"https://mail.python.org/pipermail/wheel-builders/2017-August/000297.html\">https://mail.python.org/pipermail/wheel-builders/2017-August/000297.html</a> )?\n\n</p><p></p><hr/>\n<em>2017-Nov-20 13:22:03 by jpatton:</em> <br/>\n\nThe problem with the Debian 8 (and presumably Ubuntu 16) build is in the logic for figuring out the name for <code>libpyclassad</code> in <a class=\"file\" href=\"rlog?f=build/cmake/CondorConfigure.cmake\">/build/cmake/CondorConfigure.cmake</a> :\n\n<p></p><div class=\"code\">\n<pre class=\"code\">STRING(REGEX REPLACE \".*python([0-9]+[.]?[0-9]+).*\" \"\\\\1\" _PYTHON_VERSION ${PYTHON_EXECUTABLE})\nif ( ${PACKAGE_VERSION} MATCHES \"([0-9]+)[.]([0-9]+)[.]([0-9]+)\" )\n    set( PYCLASSAD_LIB_NAME \"pyclassad${_PYTHON_VERSION}_${CMAKE_MATCH_1}_${CMAKE_MATCH_2}_${CMAKE_MATCH_3}\" )\n    set( UTILS_LIB_NAME \"condor_utils_${CMAKE_MATCH_1}_${CMAKE_MATCH_2}_${CMAKE_MATCH_3}\" )\n</pre></div>\n\n\n<p>For some reason, on Debian 8, <code>${PYCLASSAD_LIB_NAME}</code> evaluates to:\n\n</p><p><code>pyclassad/usr/bin/python_8_7_4</code>\n\n</p><p>Whereas on CentOS builds, it evaluates to:\n\n</p><p><code>pyclassad2.7_8_7_4</code>\n\n</p><p></p><hr/>\n<em>2017-Nov-21 12:22:28 by jpatton:</em> <br/>\n\nSo after more thought and testing, we need to do two things with cmake:\n\n<p></p><ol>\n<li>Use a real method (<code>FindPythonInterp</code>, <code>python -V</code>, and/or <code>distutils.sysconfig.version_info</code>) to determine the Python version instead of getting it from the executable name. Even though it's a symlink in Debian 8 and Ubuntu 16, cmake doesn't \"see\" <code>/usr/bin/python</code> pointing to <code>/usr/bin/python2.7</code>.\n</li><li>Keep <code>pypi_staging</code> (and some of its prereqs) from being built automatically, especially because the bindings aren't built on all platforms (e.g. Fedora) in BaTLab.\n</li></ol>\n\n<p></p><hr/>\n<em>2017-Nov-21 13:29:52 by tim:</em> <br/>\n\nWe <strong>should</strong> build the python bindings for Fedora. They build them for the Fedora releases of HTCondor.\n\n<p></p><hr/>\n<em>2017-Nov-21 15:10:08 by jpatton:</em> <br/>\n\ncmake seems to need a some hand-holding to find python3 libs and interpreter correctly, e.g.:\n<a class=\"external\" href=\"https://stackoverflow.com/questions/29245558/how-to-link-with-python3-libs-with-cmake\">https://stackoverflow.com/questions/29245558/how-to-link-with-python3-libs-with-cmake</a>\n\n<p>Even hardcoding <code>set(Python_ADDITIONAL_VERSIONS 3.5)</code> does not seem to help. Continue to get the output...\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">-- Found PythonLibs: /usr/lib64/libpython3.5m.so (found version \"3.5.1\")\n-- Got PYTHONLIBS_VERSION_STRING = 3.5.1\n-- Could NOT find PythonInterp: Found unsuitable version \"2.7.12\", but required is at least \"3.5.1\" (found /bin/python)\n-- Got PYTHON_VERSION_STRING = 2.7.12\n</pre></div>\n\n\n<p>...when building on Fedora in BaTLab. Note that this is even with a newer version of cmake (3.6.2 on Fedora 25). It should be finding the interpreter under <code>/bin/python3</code> or similar.\n\n</p><p></p><hr/>\n<em>2017-Nov-29 11:19:21 by jpatton:</em> <br/>\n\nI've put the building of the duplicate libraries (<code>_classad</code> and <code>_htcondor</code>) behind an option, <code>WANT_PYTHON_WHEELS</code>, to avoid unnecessary compilation and to prevent strange build errors on Windows. Will hammer away at building on Windows at a later date, but we are not supporting building wheels on Windows right now anyway.\n\n<p>This effect of this change is that HTCondor builds the python bindings (and the rest of the code) as normal, pre-wheel building edits. No build errors on any platform.\n\n</p><p></p><hr/>\n<em>2017-Nov-29 15:31:46 by jpatton:</em> <br/>\n\nCode merged into master in <span class=\"chng\"><a href=\"chngview?cn=52889\">[52889]</a></span>. Note that we still need to develop a method of patching <code>reli_sock.cpp</code> to build with older gcc when building the manylinux1 wheels.\n\n<p></p><hr/>\n<em>2017-Dec-19 11:24:13 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good. However, please use <a class=\"external\" href=\"http://htcondor.org/\">http://htcondor.org/</a> as our official web site address.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Dec-28 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=53072\">[53072]</a></span>: Fix for manylinux1 openssl compatilibility (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span> related)  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Dec-20 10:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=53038\">[53038]</a></span>: Fix URL in python binding packaging <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Dec-02 09:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52912\">[52912]</a></span>: Fixup version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Dec-01 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52909\">[52909]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-29 15:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52889\">[52889]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=52848\">[52848]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52849\">[52849]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52850\">[52850]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52862\">[52862]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52863\">[52863]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52872\">[52872]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52885\">[52885]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52886\">[52886]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52888\">[52888]</a></span>, Merge branch 'V8_7-gt6486-pypi_merge' <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span> \u00a0[...]\n (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-29 15:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52888\">[52888]</a></span>: Update setup.py to reflect current status of bindings in PyPI <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-29 10:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52886\">[52886]</a></span>: Shove more cmake commands behind WANT_PYTHON_WHEELS <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-29 10:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52885\">[52885]</a></span>: Shove most of the cmake edits behind an option (WANT_PYTHON_WHEELS) <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-28 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52872\">[52872]</a></span>: Build python bindings with new filenames on Windows <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-27 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52863\">[52863]</a></span>: Don't set up pyclassad when not building python bindings <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-27 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52862\">[52862]</a></span>: pypi_staging target should not be made by default (all) <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52850\">[52850]</a></span>: libpyclassad should not get Python version from interpreter filename <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span> (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 13:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52849\">[52849]</a></span>: Update reli_sock.cpp (breaks build in manylinux1 container) <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6486\" title=\"Merge python bindings pypi_staging target\">#6486</a></span>  (By Jason Patton )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Dec-19 16:28", "status": "resolved", "created": "2017-Nov-13 13:45", "fixed_version": "2017-Nov-13 13:45", "broken_version": "", "priority": "2", "subsystem": "PythonBinding", "assigned_to": "jpatton", "derived_from": "#6327", "creator": "jpatton", "rust": "", "customer_group": "other", "visibility": "public", "notify": "edquist@cs.wisc.edu, tim@cs.wisc.edu, jpatton@cs.wisc.edu, bbockelm@cse.unl.edu", "due_date": ""}