{"id": 4679, "title": "Ticket #4679: Make SpoolOnEvict more useful", "description": "<blockquote>\nHm - it looks like <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4292\" onclick=\"get_ticket_and_populate_wrapper('4292'); return false;\" title=\"Allow output from evictions to be not-spooled\">#4292</a></span> was less useful than we had originally envisioned.\n\n<p>While the patch <strong>does</strong> work, it doesn't work in the case we had targeted - periodic_remove.  So \"condor_vacate_job\" will bring back the output we want; \"condor_rm\" or running afoul one of the \"periodic_remove\" expressions will not.\n\n</p><p>I propose we extend this attribute to bring back files in the case of removal - or, alternately, add a different knob that allows us to do this.\n\n</p><p>Knocking this up a few in the priority list as users are getting grumpy about missing output when their job goes over memory limits.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Nov-11 11:12:55 by bbockelm:</em> <br/>\n\nTo be clear (since TimT marked it as 8.3.2) - the checked-in patch is on branch V8_3-gt4679 for review.  Talking with ToddT previously, it's only a single \"suggested direction\"; we were considering whether it's the right approach.\n\n<p></p><hr/>\n<em>2014-Dec-03 08:24:09 by bbockelm:</em> <br/>\n\nSince this is not even committed to master (much less 8.3.2 branch), I'm going to remove the \"fixed versions\" tag.  Still needs input from ToddT on the approach within the code.\n\n<p></p><hr/>\n<em>2015-Jan-05 10:46:54 by tim:</em> <br/>\n\nThe NEOS group would also like to see this feature implemented. They want output from jobs that are removed via a periodic remove expression. Miron wants us to support NEOS.\n\n<p></p><hr/>\n<em>2015-Jan-20 16:53:48 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>BaseShadow::holdJob() should have the same graceful check as removeJobPre() and evictJob().\n\n<p></p></li><li>Initiating a graceful shutdown via the new argument to cleanUp() should be triggered by a call to jobWantsGracefulRemoval(), not the value of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SpoolOnEvict\" title=\"Spool On Evict\">SpoolOnEvict</a></span> in the job ad. This makes the behavior on hold or remove the same whether the shadow triggers the state change or is told by the schedd (e.g. user runs condor_rm).\n\n<p></p></li><li>We should revisit the change in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span> to perform file transfer by default on job removal (config param GRACEFULLY_REMOVE_JOBS defaults to True). If the user doesn't set SpoolOnEvict=False, then these output files are transferred to the spool directory, where they'll probably be immediately deleted.\n</li></ul>\n\n<p></p><hr/>\n<em>2015-Jan-20 17:09:46 by jfrey:</em> <br/>\n\nFrom my testing, the output files are transferred back to the job's IWD on a condor_rm. Thanks to the GRACEFULLY_REMOVE_JOBS parameter (which defaults to True), a schedd-initiated killing of the job (because of a condor_hold or condor_rm) results a graceful shutdown sent to the execute machine.\n\n<p></p><hr/>\n<em>2015-Jan-20 18:57:07 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>I'm having a hard time interpreting your last comment.  Are you saying the transfer happens in existing releases (i.e., you see something different from me?) or are you saying you see this with the branch?\n\n</p><p>Thanks,\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jan-20 20:21:49 by bbockelm:</em> <br/>\n\nOk, testing on my own - I'm guessing you meant the latter?\n\n<p>Are you saying that jobs should transfer output files by default for graceful kills?  I'm a bit reluctant to change the default; I'd rather introduce another knob (or just use <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SpoolOnEvict\" title=\"Spool On Evict\">SpoolOnEvict</a></span>).\n\n</p><p></p><hr/>\n<em>2015-Jan-21 09:56:33 by jfrey:</em> <br/>\n\nIn HTCondor 8.2 and 8.3 today, if someone runs condor_hold or condor_rm, the shadow does a graceful claim deactivation, including output file transfer. If <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SpoolOnEvict\" title=\"Spool On Evict\">SpoolOnEvict</a></span> is False, those files end up in the job's IWD. If the shadow decides to hold or remove the job, then a fast shutdown is perform (what you've observed).\n\n<p>For GRACEFULLY_REMOVE_JOBS, I think we should consider changing the default to False, but probably enabling it for jobs that set SpoolOnEvict=False.\n\n</p><p></p><hr/>\n<em>2015-Jan-22 20:35:58 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>I think your changes look correct, but I sure can't replicate what you say is existing behavior...\n\n</p><p>Anyhow, looks like the ticket got merged in with your suggestions - I'm 100% fine with them.  Won't investigate any further.\n\n</p><p>Brian</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-23 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42353\">[42353]</a></span>: minor edit to 8.3.3 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4679\" onclick=\"get_ticket_and_populate_wrapper('4679'); return false;\" title=\"Make SpoolOnEvict more useful\">#4679</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-22 16:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42327\">[42327]</a></span>: Docs for change when GRACEFULLY_REMOVE_JOBS is applied. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4679\" onclick=\"get_ticket_and_populate_wrapper('4679'); return false;\" title=\"Make SpoolOnEvict more useful\">#4679</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-21 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42297\">[42297]</a></span>: Make graceful job removal independent of how job was removed. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4679\" onclick=\"get_ticket_and_populate_wrapper('4679'); return false;\" title=\"Make SpoolOnEvict more useful\">#4679</a></span> Whether a job was killed gracefully on hold or removal varied depending on how it was held or removed. If the decision to hold/remove the job came through the schedd, then a graceful killing was done. If a job policy expression in the\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-25 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41448\">[41448]</a></span>: Extend <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SpoolOnEvict\" title=\"Spool On Evict\">SpoolOnEvict</a></span> to also return output on job abort. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4679\" onclick=\"get_ticket_and_populate_wrapper('4679'); return false;\" title=\"Make SpoolOnEvict more useful\">#4679</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Jan-22 20:35", "status": "resolved", "created": "2014-Oct-25 14:16", "fixed_version": "2014-Oct-25 14:16", "broken_version": "", "priority": "1", "subsystem": "", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu, tim@cs.wisc.edu", "due_date": ""}