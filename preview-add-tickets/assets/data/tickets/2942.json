{"id": 2942, "title": "Ticket #2942: Leaking job directories in SPOOL", "description": "<blockquote>\nSee thread  \"Leftovers of checkpointed jobs accumulate in SPOOL\" on condor-users\n<a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-March/msg00052.shtml\">https://lists.cs.wisc.edu/archive/condor-users/2012-March/msg00052.shtml</a>\n<a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-March/msg00071.shtml\">https://lists.cs.wisc.edu/archive/condor-users/2012-March/msg00071.shtml</a>\n<a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-April/msg00075.shtml\">https://lists.cs.wisc.edu/archive/condor-users/2012-April/msg00075.shtml</a>\n\n<p>Observed behavior:\n</p><ul>\n<li>Using DMTCP checkpointing on vanilla jobs\n</li><li>Job is evicted at least once\n</li><li>Job exits spool (via normal termination or condor_rm)\n</li><li>Job's directory in spool isn't removed</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-13 11:36:28 by adesmet:</em> <br/>\n\nBased on the reports, when the shadow exits/is evicted, it fails to remove the swap sandbox.  This is an error reported by the shadow. 13 is Permission denied.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">Failed to remove /var/spool/condor/3029/0/cluster3029.proc0.subproc0.swap: Permission denied (errno 13)\n</pre></div>\n\n\n<p>Then, when the shadow exits the second time, the schedd complains that the actual sandbox can't be removed. 39 is Directory not empty.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">Failed to remove /var/spool/condor/3029/0/cluster3029.proc0.subproc0: Directory not empty (errno 39)\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-May-25 14:30:22 by adesmet:</em> <br/>\n\nVerified, and pretty easily. Verified on the head of V7_8-branch as of May 20th, 2012. Also present in 7.6.7, as released.\n\n<p></p><ol>\n<li>Start Condor as root, configured to use the \"condor\" user.\n</li><li>Submit a job as a non-condor, non-root user.  An example submit file and executable are below.\n</li><li>Wait for the job to start running\n</li><li>condor_vacate\n</li><li>Observe the contents of the spool directory. A representative snapshot follows.\n</li><li>Allow the job to restart and finish\n</li><li>Observe that the job's spool subdirectory is still present.  A representative snapshot is below.\n</li></ol>\n\n<p>Submit:\n</p><div class=\"code\">\n<pre class=\"code\">executable=executable\narguments=60\noutput=eraseme.out\nerror=eraseme.err\nlog=eraseme.log\nwhen_to_transfer_output=on_exit_or_evict\nshould_transfer_files=true\nnotification=never\ninitialdir=output\nqueue\n</pre></div>\n\n\n<p>executable:\n</p><div class=\"code\">\n<pre class=\"code\">#! /bin/sh\n/bin/touch eraseme-touched-file\n/bin/date &gt;&gt; eraseme-dated-file\n#/bin/chmod 000 eraseme-touched-file\n/bin/hostname\n/usr/bin/whoami\n/bin/echo Sleeping for $1\n/bin/sleep $1\n/bin/echo DONE\n</pre></div>\n\n\n<p>Snapshot after condor_vacate\n</p><div class=\"code\">\n<pre class=\"code\">% find -type d  | xargs ls -ld\ndrwxr-xr-x 4 condor  root    4096 May 25 14:14 .\ndrwxr-xr-x 3 condor  condor  4096 May 25 14:14 ./1\ndrwxr-xr-x 5 condor  condor  4096 May 25 14:14 ./1/0\ndrwxr-xr-x 2 adesmet adesmet 4096 May 25 14:14 ./1/0/cluster1.proc0.subproc0\ndrwxr-xr-x 2 adesmet adesmet 4096 May 25 14:14 ./1/0/cluster1.proc0.subproc0.swap\ndrwxr-xr-x 2 adesmet adesmet 4096 May 25 14:14 ./1/0/cluster1.proc0.subproc0.tmp\ndrwxrwxrwt 2 condor  condor  4096 May 24 15:55 ./local_univ_execute\n</pre></div>\n\n\n<p>Snapshot after job completion\n</p><div class=\"code\">\n<pre class=\"code\">% find 1 | xargs ls -ld\ndrwxr-xr-x 3 condor  condor  4096 May 25 14:14 1\ndrwxr-xr-x 3 condor  condor  4096 May 25 14:15 1/0\ndrwxr-xr-x 2 adesmet adesmet 4096 May 25 14:14 1/0/cluster1.proc0.subproc0\n-rw-r--r-- 1 adesmet adesmet   29 May 25 14:14 1/0/cluster1.proc0.subproc0/eraseme-dated-file\n-rw-r--r-- 1 adesmet adesmet    0 May 25 14:14 1/0/cluster1.proc0.subproc0/eraseme.err\n-rw-r--r-- 1 adesmet adesmet   43 May 25 14:14 1/0/cluster1.proc0.subproc0/eraseme.out\n-rw-r--r-- 1 adesmet adesmet    0 May 25 14:14 1/0/cluster1.proc0.subproc0/eraseme-touched-file\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-May-25 14:34:36 by adesmet:</em> <br/>\n\nAnalysis:\n\n<p>The directory tree $(SPOOL)/1/0/cluster1.proc0.subproc0.swap was created.  The ownership is:\n\n</p><p></p><ul>\n<li><code>condor.</code> $(SPOOL)/\n</li><li><code>condor.</code> $(SPOOL)/1/\n</li><li><code>condor.</code> $(SPOOL)/1/0/\n</li><li><code>adesmet</code> $(SPOOL)/1/0/cluster1.proc0.subproc0.swap\n</li></ul>\n\n<p>When Condor tries to rmdir $(SPOOL)/1/0/cluster1.proc0.subproc0.swap, it does so as adesmet.  adesmet doesn't have write access to $(SPOOL)/1/0/, so the attempt fails.  I believe everything else that goes wrong chains from that failure.\n\n</p><p>Possible fixes:\n</p><ul>\n<li>Delete the directory as condor.\n</li><li>Have $(SPOOL)/1/0/ owned by adesmet\n</li></ul>\n\n<p>The \"1/0\" directories are relatively new; it used to be that you'd end up with $(SPOOL)/cluster1.proc0.subproc0.swap.  I believe the addition of the 1/0 directories are the immediate cause.  That doesn't necessarily explain why the code (presumably) worked in earlier releases.\n\n</p><p></p><hr/>\n<em>2012-May-30 15:28:12 by adesmet:</em> <br/>\n\nPresent at least as far back as 7.6.3\n\n<p></p><hr/>\n<em>2012-May-30 15:34:57 by adesmet:</em> <br/>\n\nIt's not feasible to have the intermediary directories (0/1) to be owned by adesmet; the directories are actually bucket, with clusters sorted into groups of 10000. Multiple people's jobs could be in those directories. We'll just need to clean up the topmost directory as condor.\n\n<p></p><hr/>\n<em>2012-Jun-04 14:08:46 by adesmet:</em> <br/>\n\nOr, not. That just ends up leaking different directories.  Could detect at run-time who the current owner is, but that seem fraught with non-portable (especially on Windows) code. Could try deleting both ways, but that raises questions like, \"if both attempts fail, which errno is meaningful.\"  I think the correct solution is to ensure directory ownership by condor in all cases.\n\n<p></p><hr/>\n<em>2012-Jun-21 13:22:50 by adesmet:</em> <br/>\n\nRe: Code review: This code went in and out and back in because of problems.  The \"real\" commit is bdb1033b <a class=\"external\" href=\"https://condor-wiki.cs.wisc.edu/index.cgi/chngview?cn=32261\">https://condor-wiki.cs.wisc.edu/index.cgi/chngview?cn=32261</a> .\n\n<p></p><hr/>\n<em>2012-Jun-21 13:58:36 by nwp:</em> <br/>\n\n<strong>CODE REVIEW</strong> I checked the code and it looks correct.\n\n<p></p><hr/>\n<em>2012-Jun-21 14:01:19 by nwp:</em> <br/>\n\nIs a regression test needed to catch this in the future?\n\n<p></p><hr/>\n<em>2012-Jun-21 14:17:23 by adesmet:</em> <br/>\n\nThere should be a regression test. Making it own ticket: <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=3077\" title=\"New tests: detect leaked spool directory files\">#3077</a></span></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-12 10:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32276\">[32276]</a></span>: minor editing change for version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-08 16:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32262\">[32262]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=32261\">[32261]</a></span>, Fix for spool directory leak <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span> moved back to 7.8.1 Merge branch 'V7_8_1-branch' into V7_8-branch  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-08 16:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32261\">[32261]</a></span>: Re-add spool leak fix to 7.8.1 <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span> 7.8.1 missed its previous release window, and was reopened for fixed. At TJ's request, I'm reintroducing it, along with a memory leak fix I made on 7.8.2. This reverts commit 47732edd4819bced7612e5afdbe13955bcc4b4ba.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-08 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32259\">[32259]</a></span>: Fix memory leak, side effect of spool leak fix. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-07 14:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32248\">[32248]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=32239\">[32239]</a></span>, Merge branch 'V7_8_1-branch' into V7_8-branch, but don't revert the spool leak fix, which now works. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-07 11:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32239\">[32239]</a></span>: Revert spool leak fix changes (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span>); Couldn't fix Windows in time for deadline. This reverts commit a795b23b0e0f9a0d34af448311e409f0150ca3a5. This reverts commit 9d7df74da95aaf08de5491adfaff69d603537a1a. This reverts commit dfa2b400ff4f61d2aafdd9a66d48789ab5769a94. This reverts commit 5d85347c41c3fb9a61fc36642d5747066cb91728.\u00a0[...]\n (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-07 10:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32236\">[32236]</a></span>: build fix for windows, move <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span> outside of !WIN32 block <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-06 21:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32228\">[32228]</a></span>: Document bugfix <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span> (leaky spool directories)  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-06 21:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32227\">[32227]</a></span>: Build fix for Windows; including missing header <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-06 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32221\">[32221]</a></span>: Fix leaking spool directories <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2942\" title=\"Leaking job directories in SPOOL\">#2942</a></span> Always delete the top level spool directory as condor, and ensure that the directory is owned by condor before doing so. As a side effect, refactor some code to merge copy-paste code into a single function.  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jun-21 14:17", "status": "resolved", "created": "2012-Apr-12 16:56", "fixed_version": "2012-Apr-12 16:56", "broken_version": "v070603", "priority": "2", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "debian", "visibility": "public", "notify": "", "due_date": ""}