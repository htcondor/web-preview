{"id": 3071, "title": "Ticket #3071: Does condor_power work?", "description": "<blockquote>\nDoes condor_power ever work?  I'm dubious.\n\n<p>The key code is in <a class=\"file\" href=\"rlog?f=src/condor_utils/udp_waker.cpp\">/src/condor_utils/udp_waker.cpp</a> .  The rough flow:\n\n</p><p></p><ol>\n<li>UdpWakeOnLanWaker::UdpWakeOnLanWaker (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> *ad ) (line 71) Gets a classad.  It hands the add to a Daemon object just so it can call Daemon::addr().  The returned address appears to be the local machine's address.  The code claims to \"retrieve the IP from the ad,\" but there isn't any reason that the ad would contain the target machine's IP address.  The local machine's address is put into m_public_ip.  For example, m_public_ip=1.2.3.4, where 1.2.3.4 is the machine I'm running condor_power on.\n</li><li>UdpWakeOnLanWaker::initializeBroadcastAddress ()\n<ul>\n<li>line 283 initializes m_broadcast.  Assuming a subnet was not passed in on the command line, or that the submit passed in was \"255.255.255.255\", m_broadcast.sin_addr.s_addr will be initialized to 0xffffffff.  This is as expected.\n</li><li>line 313 inverts m_broadcast.sin_addr.s_addr. It's not clear why it's doing this.  m_broadcast.sin_addr.s_addr is now 0x00000000\n</li><li>line 317 ors broadcast.sin_addr.s_addr against the address found in m_public_ip. (0x01020304 | 0x00000000) -&gt; 0x01020304 That decidedly seems wrong\n</li></ul>\n</li><li>UdpWakeOnLanWaker::doWake () (line 467) usess m_broadcast as the destination for sendto().  So we're sending a UDP packet to 0x01020304, which is 1.2.3.4, which is the local machine, not the target machine.\n</li></ol>\n\n<p>condor_rooster calls \"condor_power -d -i\", where -i means \"pass a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> in on stdin.\"  I need to check this code path; it's possible it works.  I think it probably sends a UDP packet directly to the off machine, which might actually work. The behavior remains weird.\n\n</p><p><strong>To do:</strong>\n\n</p><p></p><ul>\n<li>Figure out what the hell this code is doing.  A simple local broadcast should be as a simple sending to 255.255.255.255, and that code isn't doing it. It might be trying to do a subnet directed broadcast, but I don't think it's doing that either, at least not correctly.\n</li><li>Fix -m.  Presumably it should do a local broadcast.  Tim St. Clair is confident that it used to work.\n</li><li>Check if -m -s works.  What's it supposed to?  Probably subnet directed broadcasts.  Fix if broken.\n</li><li>Investigate -i.  Why does it work?  Does it fail in some cases?  In particular, is it using local broadcast or subnet directed broadcast, and should we bother supporting the other if it only doesone?</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Jun-25 15:34:09 by tstclair:</em> <br/>\n\nZ, DanB, &amp;&amp; Myself all verified that this did indeed work I'm guessing that the IPv6 work likely broke *this\n\n<p></p><hr/>\n<em>2012-Jun-28 17:14:29 by adesmet:</em> <br/>\n\nChatted with Z; he ported the code to Windows, but never actually tested it.\n\n<p>TJ tested using the \"-i\" (pass in a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span>) option, and it works, at least for a machine on the local subnet.  The -m option to the same machine fails.  Conclusion: -i (which is what condor_rooster uses) is okay, but -m (which people testing are likely to use) is broken.\n\n</p><p></p><hr/>\n<em>2012-Jul-06 14:04:18 by ziliang:</em> <br/>\n\nSlight correction: I ported condor_rooster to Windows and kicked it over to Ben Burnett for review.\n\n<p>Anyway, conclusions so far.  In the -m option, using 255.255.255.255 as the default subnet in conjunction with the current machine's IP address does not work.  The way the code shakes out, it ends up setting the broadcast destination address back to itself. A more reasonable default would be 255.255.255.0. Assuming the target machine's IP is 1.2.3.4, this results in the destination IP being 1.2.3.255, which is a reserved broadcast IP for said subnet. Passing a mask in through the -s option should also work. It might be a better idea to make the -s option mandatory if we are using the -m option. Need to set up an environment to test this.\n\n</p><p></p><hr/>\n<em>2012-Jul-07 13:30:57 by ziliang:</em> <br/>\n\nCurrent fix is to simply do a global broadcast and let the router deal with it.  This will work if we're on the same subnet, as routers generally will do a broadcast on their subnet but not forward on the broadcast.  Getting condor_power to hit a machine on a different subnet ultimately requires a properly configured router, which is out of our hands, though we need to document this better.\n\n<p></p><hr/>\n<em>2012-Jul-09 08:58:27 by tstclair:</em> <br/>\n\nWhy does the netmask not work?\n\n<p></p><hr/>\n<em>2012-Jul-09 11:27:26 by ziliang:</em> <br/>\n\nBecause to prevent DOS attacks, most routers by default do not pass on broadcasts to other subnets.\n<hr/>\n<em>2012-Aug-23 13:52:15 by zmiller:</em> <br/>\n\nBulk change of target version from v070802 to v070803 using ./ticket-target-mover.\n<hr/>\n<em>2012-Sep-11 11:06:53 by johnkn:</em> <br/>\n\nBulk change of target version from v070803 to v070804 using ./ticket-target-mover.\n<hr/>\n<em>2012-Sep-19 16:15:53 by zmiller:</em> <br/>\n\nBulk change of target version from v070804 to v070805 using ./ticket-target-mover.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3141\" onclick=\"get_ticket_and_populate_wrapper('3141'); return false;\" title=\"condor_power issues\">#3141</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_power issues</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-17 11:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32815\">[32815]</a></span>: improve condor_power man page ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3071\" onclick=\"get_ticket_and_populate_wrapper('3071'); return false;\" title=\"Does condor_power work?\">#3071</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-09 17:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32667\">[32667]</a></span>: Fix documentation for condor_power to include -i option. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3071\" onclick=\"get_ticket_and_populate_wrapper('3071'); return false;\" title=\"Does condor_power work?\">#3071</a></span>  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-07 13:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32616\">[32616]</a></span>: Change the default IP and subnet to do a global broadcast, fixing the -m option. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3071\" onclick=\"get_ticket_and_populate_wrapper('3071'); return false;\" title=\"Does condor_power work?\">#3071</a></span>  (By Ziliang Guo )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-02 15:12", "status": "resolved", "created": "2012-Jun-20 13:51", "fixed_version": "2012-Jun-20 13:51", "broken_version": "v070801", "priority": "2", "subsystem": "Libs", "assigned_to": "ziliang", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "support", "visibility": "public", "notify": "tstclair@redhat.com adesmet@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}