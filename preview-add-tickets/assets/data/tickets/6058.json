{"id": 6058, "title": "Ticket #6058: condor_starter abandons glexec job on shadow disconnect", "description": "<blockquote>\nCMS sites are starting to complain about glideins leaking a significant number of processes.\n\n<p>I was able to track down one of the log files and found the following:\n\n</p><p></p><div class=\"verbatim\">\n<pre>12/20/16 00:16:50 (pid:776322) Using wrapper /var/lib/condor/execute/dir_937213/glide_XuwA0N/condor_job_wrapper.sh to exec /var/lib/condor/execute/dir_937213/glide_XuwA0N/execute/dir_776322/condor_exec.exe pdmvserv_task_SMP-RunIISummer15wmLHEGS-00072__v1_T_161214_221009_1026-Sandbox.tar.bz2 4927461\n12/20/16 00:16:50 (pid:776322) Running job via glexec\n12/20/16 00:16:50 (pid:776322) Create_Process succeeded, pid=776349\n12/20/16 02:13:40 (pid:776322) Connection to shadow may be lost, will test by sending whoami request.\n12/20/16 02:13:40 (pid:776322) condor_write(): Socket closed when trying to write 37 bytes to &lt;128.142.209.43:4080&gt;, fd is 15\n12/20/16 02:13:40 (pid:776322) Buf::write(): condor_write() failed\n12/20/16 02:13:40 (pid:776322) i/o error result is 0, errno is 0\n12/20/16 02:13:40 (pid:776322) Lost connection to shadow, waiting 1200 secs for reconnect\n12/20/16 02:33:40 (pid:776322) No reconnect from shadow for 1200 seconds, aborting job execution!\n12/20/16 02:33:40 (pid:776322) chmod(/var/lib/condor/execute/dir_937213/glide_XuwA0N/execute/dir_776322) failed: Operation not permitted (errno 1)\n12/20/16 02:33:40 (pid:776322) Failed to chmod(0700) /var/lib/condor/execute/dir_937213/glide_XuwA0N/execute/dir_776322 and all subdirs\n12/20/16 02:33:40 (pid:776322) Can't remove \"/var/lib/condor/execute/dir_937213/glide_XuwA0N/execute/dir_776322\" as Condor daemon user 'unknown' (0.0), giving up!\n</pre></div>\n\n\n<p>These are jobs started via glexec.  Seems that this particular error path for disconnects doesn't kill via glexec (actually, looks like it can't kill if it's non-root).</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Dec-20 13:30:42 by jfrey:</em> <br/>\n\nWhat version of HTCondor is this, and how are the GLEXEC parameters set?\n\n<p></p><hr/>\n<em>2016-Dec-21 16:31:00 by jfrey:</em> <br/>\n\nWhen the job lease expires, the starter calls CStarter::StarterExit(), which does very minimal cleanup and doesn't attempt to kill the running job. It does try to delete the job's execute directory, but doesn't invoke the glexec code path. As a result, the starter orphans both the job (true for all job types when the lease expires) and the sandbox.\n\n<p>The startd acts as a back-stop for cleaning up resources orphaned by the starter. But it doesn't know how to invoke glexec to do proper cleanup. For the job process family, the procd does know how to use glexec to kill it. But the procd purges that knowledge when the starter exits, since the starter is the watcher of that process family.\n\n</p><p>As a fix for the immediate problem that's suitable for the stable series, I plan to fix the starter to start a fast shutdown when the job lease expires. This will hit the normal code paths for quickly killing the job and cleaning up after it.\n\n</p><p></p><hr/>\n<em>2017-Jan-20 16:35:03 by tannenba:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-20 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50025\">[50025]</a></span>: Docs for glexec job cleanup bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6058\" title=\"condor_starter abandons glexec job on shadow disconnect\">#6058</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-24 06:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49877\">[49877]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6058\" title=\"condor_starter abandons glexec job on shadow disconnect\">#6058</a></span>) Fixup build, glexec not supported on Windows  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-22 09:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49863\">[49863]</a></span>: Fix cleanup of glexec jobs on lease expiration in the starter. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6058\" title=\"condor_starter abandons glexec job on shadow disconnect\">#6058</a></span> When removing the job's execute directory, chown it back to the condor user if that hasn't been done already. When the job lease expires, trigger a fast shutdown with an alternate exit code, which will quickly kill the job.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-20 16:36", "status": "resolved", "created": "2016-Dec-19 22:01", "fixed_version": "2016-Dec-19 22:01", "broken_version": "", "priority": "1", "subsystem": "DaemonsExecNode", "assigned_to": "jfrey", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu tannenba@cs.wisc.edu jfrey@cs.wisc.edu", "due_date": ""}