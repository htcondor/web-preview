{"id": 4830, "title": "Ticket #4830: Bug: unnecessary socket creation", "description": "<blockquote>\nThis is a follow-up for <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=4461\" onclick=\"get_ticket_and_populate_wrapper('4461'); return false;\" title=\"IPv6 used by default if enabled\">#4461</a></span> post-8.3.2 as the original code approach is no longer necessary.\n\n<p>As stated in the RFCs (and part of the CMS pool support), if IPv6 is enabled, it should be used by default.  This is because, given both a routable IPv4 and IPv6 address, it's more likely the v6 one is globally routable.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jan-14 14:24:27 by bbockelm:</em> <br/>\n\nIt turns out that IPv6 <strong>is</strong> used by default.  The daemon advertises the address to the collector using the protocol it used to contact the collector.\n\n<p>So, if daemons use V6 to talk to the collector and have a V6 command socket, then address rewriting will cause the collector to get an ad with the IPv6 address.\n\n</p><p><strong>However</strong>, there's a bug in command socket creation that prevented IPv6 command sockets from being used when there's a fixed port (such as the case with the collector).\n\n</p><p>Fixing the underlying bug in command socket creation, IPv6 is used by default (according to original design).\n\n</p><p></p><hr/>\n<em>2015-Jan-22 20:39:57 by adesmet:</em> <br/>\n\nI believe the change to condor_bind is unnecessary. I believe all code paths where we create a socket to listen on will call Sock::assign(proto, INVALID_SOCKET). When INVALID_SOCKET is passed in, IPV6_V6ONLY is set at the bottom of the function (and for bonus points works on Windows).\n\n<p></p><hr/>\n<em>2015-Jan-22 20:42:29 by bbockelm:</em> <br/>\n\nHi Alan,\n\n<p>The change a bit superfluous - but is also belt-and-suspenders (the HTCondor Way TM).  I wanted to make sure there was no way to inadvertently bind a mixed-mode socket.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jan-23 16:42:10 by adesmet:</em> <br/>\n\nProposed: Retitle ticket to \"Bug: unnecessary socket creation\". Resolve this ticket; no documentation needed as the code was never released.\n\n<p>Sound good?\n\n</p><p></p><hr/>\n<em>2015-Jan-24 09:02:31 by bbockelm:</em> <br/>\n\nHi Alan,\n\n<p>Looking at git history, it seems the bug was indeed always internal.  Will rename ticket and mark as resolved.\n\n</p><p>Brian</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-23 16:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42365\">[42365]</a></span>: Remove redundant code. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4830\" onclick=\"get_ticket_and_populate_wrapper('4830'); return false;\" title=\"Bug: unnecessary socket creation\">#4830</a></span> Setting IPV6_V6ONLY is handled in Sock::assign, and also supports Windows. Partial revert of 999dfde2 <span class=\"chng\"><a href=\"chngview?cn=42209\">[42209]</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-14 14:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42209\">[42209]</a></span>: Fix issue with binding too many times. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4830\" onclick=\"get_ticket_and_populate_wrapper('4830'); return false;\" title=\"Bug: unnecessary socket creation\">#4830</a></span> We go through the loop one too many times in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitCommandSockets\" title=\"Init Command Sockets\">InitCommandSockets</a></span> in the case we are successful and are using a fixed port.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-14 12:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42199\">[42199]</a></span>: Prefer IPv6 if both v4 and v6 are enabled. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4830\" onclick=\"get_ticket_and_populate_wrapper('4830'); return false;\" title=\"Bug: unnecessary socket creation\">#4830</a></span> This does three things: 1) Creates the IPv6 socket first, then the IPv4 socket (DC will prefer to use the command socket created first). 2) Fixes a small bug that prevented HTCondor from running on well-known ports in dual-stack if the IPv6 socket is created\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Jan-24 09:03", "status": "resolved", "created": "2015-Jan-14 12:41", "fixed_version": "2015-Jan-14 12:41", "broken_version": "v080302", "priority": "4", "subsystem": "Tools", "assigned_to": "adesmet", "derived_from": "#4492", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}