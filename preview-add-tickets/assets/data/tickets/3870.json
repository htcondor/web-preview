{"id": 3870, "title": "Ticket #3870: Rescaling warnings in hgq_assign_quotas", "description": "<blockquote>\n<div class=\"verbatim\">\n<pre>Seems to be a precision problem in hgq_assign_quotas with\n\ndouble Zd = max(dqsum, double(1))\n\nand\n\nchild-&gt;config_quota / Zd\n\nwhere you see things like\n\nrescaled from 0 to 0\nrescaled from 0.00133333 to 0.00133333\n\n\n==========================================\n01/18/13 17:06:26 group quotas: WARNING: dynamic quota for group prod.boo.boo_char_td rescaled from 0.00133333 to 0.00133333\n01/18/13 17:06:26 group quotas: WARNING: dynamic quota for group prod.boo.boo_crowd rescaled from 0 to 0\n01/18/13 17:06:26 group quotas: WARNING: dynamic quota for group prod.boo.boo_cycles rescaled from 0 to 0\n01/18/13 17:06:26 group quotas: WARNING: dynamic quota for group prod.boo.boo_flo rescaled from 0.00133333 to 0.00133333\n01/18/13 17:06:26 group quotas: WARNING: dynamic quota for group prod.boo.boo_fx rescaled from 0.032 to 0.032\n01/18/13 17:06:26 group quotas: WARNING: dynamic quota for group prod.boo.boo_hi rescaled from 0.9 to 0.9\n==========================================\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Aug-24 11:17:12 by eje:</em> <br/>\n\nTESTING\n\n<p></p><div class=\"code\">\n<pre class=\"code\">NUM_CPUS = 10\n\nGROUP_NAMES = a, b, c\n\n# these add up to slightly &gt; 1, so will trigger rescale warning pre-fix\nGROUP_QUOTA_DYNAMIC_a = 0.33333334\nGROUP_QUOTA_DYNAMIC_b = 0.33333334\nGROUP_QUOTA_DYNAMIC_c = 0.33333334\n</pre></div>\n\n\n<p>If you spin up the negotiator with the above configuration, pre-fix you will see warning messages like this in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NegotiatorLog\" title=\"Negotiator Log\">NegotiatorLog</a></span>, due to \"numeric-jitter\" rescaling:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">08/24/13 08:55:03 group quotas: WARNING: dynamic quota for group a rescaled from 0.333333 to 0.333333\n08/24/13 08:55:03 group quotas: WARNING: dynamic quota for group b rescaled from 0.333333 to 0.333333\n08/24/13 08:55:03 group quotas: WARNING: dynamic quota for group c rescaled from 0.333333 to 0.333333\n</pre></div>\n\n\n<p>After the fix, these will go away.\n\n</p><p></p><hr/>\n<em>2013-Aug-26 11:35:59 by johnkn:</em> <br/>\n\nI don't understand why you didn't just change the code to read\n\n<p></p><pre>    if (Zd &gt; 1.0001)\n</pre>\n\n<p>But I don't think this really fixes the fundamental problem.\nwhen you do\n\n</p><p></p><pre>    child-&gt;config_quota / Zd\n</pre>\n\n<p>where Zd is 1.00001,  you can end up with a assigned quota value just slightly &lt; 1, and we know that when a quota of just slightly &lt; 1 is assigned, the job never gets ANY resources.\n\n</p><p>I think this warning is telling you about actual problems with the the quota assignment math, papering over the warning isn't really helpful.\n\n</p><p></p><hr/>\n<em>2013-Aug-26 21:20:18 by eje:</em> <br/>\n\nZd is the normalization factor for dynamic quotas, which are expected to sum to a value &lt;= 1.   When Zd is &gt; 1, that is because the child quotas summed to &gt; 1, and so it emits the warning prior to normalizing the values.\n\n<p>However, if Zd is only a very small amount larger, that's most likely due to numeric precision errors, and regardless the actual change to the quotas will be insignificant, so with this change the warning is skipped in that case.\n\n</p><p>This makes it easier to see more significant warnings.  It also reduces time and space from log output for customers who reconfigure the negotiator very frequently and have very large accounting group configurations.\n\n</p><p></p><hr/>\n<em>2013-Sep-13 11:42:28 by johnkn:</em> <br/>\n\nCODE_REVIEW: looks ok</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-24 11:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37332\">[37332]</a></span>: slight relaxation to the check for dynamic quota renormalization warning, so it does not spam log with warnings from numeric-precision jitter ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3870\" title=\"Rescaling warnings in hgq_assign_quotas\">#3870</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Sep-13 11:42", "status": "resolved", "created": "2013-Aug-24 10:37", "fixed_version": "2013-Aug-24 10:37", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "johnkn", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, dan@hep.wisc.edu, johnkn@cs.wisc.edu, tstclair@cs.wisc.edu", "due_date": ""}