{"id": 2264, "title": "Ticket #2264: Review Request: Support for stateful clouds in condor deltacloud", "description": "<blockquote>\nIn order for the deltacloud functionality in gridmanager to work with stateful clouds (such as RHEV-M), some changes to the deltacloud_gahp and dcloudjob.cpp must be made.  A patch series was sent to Jaime on June 21, 2011 with a number of bugfixes and this functionality included.\n\n<p>I'm opening this review request based on the advice of Matt Farrellee.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Jun-23 10:18:23 by tstclair:</em> <br/>\n\nIf patches could be attached to the ticket that would be useful for future archaeology.\n\n<p></p><hr/>\n<em>2011-Jun-27 14:42:42 by jfrey:</em> <br/>\n\nHere are my comments on the patches:\n\n<p></p><ul>\n<li>As an optimization, the results of the DELTACLOUD_GET_MAX_NAME_LENGTH and DELTACLOUD_START_AUTO gahp commands should be saved in the DCloudResource object.\n\n<p></p></li><li>In patch 9, there's a redundant comparison between <code>now</code> and <code>lastSubmitAttempt + submitInterval</code>.\n\n<p></p></li><li>The ATTR_DELTACLOUD_NEEDS_START attribute should be cleared from the job ad in GM_CLEAR_REQUEST.\n</li></ul>\n\n<p></p><hr/>\n<em>2011-Jul-01 10:29:31 by jfrey:</em> <br/>\n\nChanges for the items I mentioned above could be done as an additional set of patches.\n\n<p></p><hr/>\n<em>2011-Jul-05 09:41:34 by clalance:</em> <br/>\n\nYep, those sound like useful changes.  I've also found one bug while testing the patch set out.  I'll make the changes you suggest, and send out a new patchset with those changes plus my bugfix.\n\n<p></p><hr/>\n<em>2011-Jul-05 10:00:31 by clalance:</em> <br/>\n\nActually, I'm not sure what to do about the first point.  While we certainly could save the MAX_LENGTH and the START_AUTO in the jobAd, it wouldn't gain us all that much.  We only go through those code paths during initial submission, and we never reference those variables once we've used them the first time.  The only place where this would make a difference would be if we were going to do an automatic re-submit from CLEAR_REQUEST -&gt; UNSUBMITTED, which we don't use and I don't think we have tested at present.  Jaime, is this what you were thinking about, or was there another reason you wanted to cache those values?\n\n<p></p><hr/>\n<em>2011-Jul-05 13:10:35 by jfrey:</em> <br/>\n\nI'm suggesting that the MAX_LENGTH and AUTO_START answers be cached in the DCloudResource class in memory in the gridmanager, not in the job ad of each job. The advantage is that when you have a dozen jobs submitted to the same <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DeltaCloud\" title=\"Delta Cloud\">DeltaCloud</a></span> server, you only need to query MAX_LENGTH and AUTO_START once. I'm not suggesting that the answers be stored persistently; if the gridmanager exits and restarts, it would query the server again.\n\n<p></p><hr/>\n<em>2011-Jul-05 13:44:56 by tstclair:</em> <br/>\n\nlibdeltacloud 0.9 src ref : <a class=\"external\" href=\"http://koji.fedoraproject.org/koji/buildinfo?buildID=250065\">http://koji.fedoraproject.org/koji/buildinfo?buildID=250065</a>\n\n<p></p><hr/>\n<em>2011-Jul-11 09:37:51 by clalance:</em> <br/>\n\nJaime,\nOK, I see.  Can you apply the rest of the patches for now, and then we can do a follow-up for that optimization?  Thanks.\n\n<p></p><hr/>\n<em>2011-Jul-11 10:07:28 by clalance:</em> <br/>\n\nOops, of course I need to send out an updated patch set.  I'll do that right now.\n\n<p></p><hr/>\n<em>2011-Jul-13 16:26:49 by jfrey:</em> <br/>\n\nI've committed the patches to V7_6-branch for 7.6.3.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/393/0001-Remove-the-gahp_error_code-from-dcloudjob.cpp.patch\">0001-Remove-the-gahp_error_code-from-dcloudjob.cpp.patch</a>\n4449 bytes added by clalance on 2011-Jul-05 14:38:31 UTC.\n<br/>\nPatch 1<br/>\n</li><li><a href=\"attach_get/394/0002-Convert-dcloudjob-build_instance_name-to-use-a-UUID.patch\">0002-Convert-dcloudjob-build_instance_name-to-use-a-UUID.patch</a>\n5971 bytes added by clalance on 2011-Jul-05 14:38:43 UTC.\n<br/>\nPatch 2<br/>\n</li><li><a href=\"attach_get/395/0003-Require-libdeltacloud-0.9-for-maximum-length-support.patch\">0003-Require-libdeltacloud-0.9-for-maximum-length-support.patch</a>\n7395 bytes added by clalance on 2011-Jul-05 14:38:51 UTC.\n<br/>\nPatch 3<br/>\n</li><li><a href=\"attach_get/396/0004-Add-support-for-max-name-length-to-the-deltacloud-GA.patch\">0004-Add-support-for-max-name-length-to-the-deltacloud-GA.patch</a>\n6614 bytes added by clalance on 2011-Jul-05 14:39:00 UTC.\n<br/>\nPatch 4<br/>\n</li><li><a href=\"attach_get/397/0005-Get-the-maximum-length-supported-by-a-deltacloud-dri.patch\">0005-Get-the-maximum-length-supported-by-a-deltacloud-dri.patch</a>\n6691 bytes added by clalance on 2011-Jul-05 14:39:09 UTC.\n<br/>\nPatch 5<br/>\n</li><li><a href=\"attach_get/398/0006-Whitespace-cleanup-of-gridmanager-dcloud-files.patch\">0006-Whitespace-cleanup-of-gridmanager-dcloud-files.patch</a>\n28635 bytes added by clalance on 2011-Jul-05 14:39:18 UTC.\n<br/>\nPatch 6<br/>\n</li><li><a href=\"attach_get/399/0007-Move-create_failure-into-dcloudgahp_commands.cpp.patch\">0007-Move-create_failure-into-dcloudgahp_commands.cpp.patch</a>\n4195 bytes added by clalance on 2011-Jul-05 14:39:30 UTC.\n<br/>\nPatch 7<br/>\n</li><li><a href=\"attach_get/400/0008-Replace-the-call-to-deltacloud_get_instance_by_id.patch\">0008-Replace-the-call-to-deltacloud_get_instance_by_id.patch</a>\n2663 bytes added by clalance on 2011-Jul-05 14:39:40 UTC.\n<br/>\nPatch 8<br/>\n</li><li><a href=\"attach_get/401/0009-Re-arrange-GM_CREATE_VM.patch\">0009-Re-arrange-GM_CREATE_VM.patch</a>\n4822 bytes added by clalance on 2011-Jul-05 14:39:48 UTC.\n<br/>\nPatch 9<br/>\n</li><li><a href=\"attach_get/402/0010-Bail-out-of-GM_SAVE_INSTANCE_NAME-if-the-job-is-HELD.patch\">0010-Bail-out-of-GM_SAVE_INSTANCE_NAME-if-the-job-is-HELD.patch</a>\n980 bytes added by clalance on 2011-Jul-05 14:39:57 UTC.\n<br/>\nPatch 10<br/>\n</li><li><a href=\"attach_get/403/0011-Remove-an-unnecessary-break-statement-in-GM_SUBMITTE.patch\">0011-Remove-an-unnecessary-break-statement-in-GM_SUBMITTE.patch</a>\n757 bytes added by clalance on 2011-Jul-05 14:40:07 UTC.\n<br/>\nPatch 11<br/>\n</li><li><a href=\"attach_get/404/0012-Add-DELTACLOUD_START_AUTO-support-to-the-deltacloud-.patch\">0012-Add-DELTACLOUD_START_AUTO-support-to-the-deltacloud-.patch</a>\n5457 bytes added by clalance on 2011-Jul-05 14:40:17 UTC.\n<br/>\nPatch 12<br/>\n</li><li><a href=\"attach_get/405/0013-Add-autostart-checking-to-deltacloud-gridmanager-cod.patch\">0013-Add-autostart-checking-to-deltacloud-gridmanager-cod.patch</a>\n12838 bytes added by clalance on 2011-Jul-05 14:40:29 UTC.\n<br/>\nPatch 13<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22426\">[22426]</a></span>: Clear out the deltacloud NEEDS_START attribute during CLEAR_REQUEST (with slight modificaitons by jfrey) ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22425\">[22425]</a></span>: Remove redundant delay check in GM_CREATE_VM. In GM_CREATE_VM, there was a useless additional lastSubmitAttempt check. By the time we reach there, we already know we need to wait around a bit to see if the previous submit worked, so just calculate the delay. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22424\">[22424]</a></span>: Move the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRunning\" title=\"Job Running\">JobRunning</a></span> transition into <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProcessInstanceAttrs\" title=\"Process Instance Attrs\">ProcessInstanceAttrs</a></span>. Consider the following: a deltacloud EC2 job goes through the following transitions:\u00a0[...]\n (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22423\">[22423]</a></span>: Add autostart checking to deltacloud gridmanager code. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22422\">[22422]</a></span>: Add DELTACLOUD_START_AUTO support to the deltacloud GAHP. This is used to determine whether the deltacloud driver we are using automatically starts instances when they are submitted, or whether they need a separate \"start\" action to get them going. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22421\">[22421]</a></span>: Remove an unnecessary break statement in GM_SUBMITTED. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22420\">[22420]</a></span>: Bail out of GM_SAVE_INSTANCE_NAME if the job is HELD. A missing break statement meant that we would still try to do GM_SAVE_INSTANCE_NAME, even if the job was in HELD or REMOVED. Fix that here. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22419\">[22419]</a></span>: Re-arrange GM_CREATE_VM. There were too many nested if statements which made it hard to read. If we run into an error, bail out early. This makes it much easier to see what is going on. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22418\">[22418]</a></span>: Replace the call to deltacloud_get_instance_by_id. With the switch to libdeltacloud 0.8, an additional deltacloud_get_instance_by_id() call was added to the dcloud_start_worker() method. Unfortunately, that was the wrong thing to do; it is not guaranteed that the instance ID can be looked up directly\u00a0[...]\n (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22417\">[22417]</a></span>: Move create_failure into dcloudgahp_commands.cpp. It never quite sat well with me that create_success was in dcloudgahp_commands.cpp while create_failure was in dcloudgahp_common.cpp. It turns out that only one place outside of dcloudgahp_commands.cpp was using it, and using it very simply at that. \u00a0[...]\n (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22416\">[22416]</a></span>: Whitespace cleanup of gridmanager dcloud files. No functional change. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22415\">[22415]</a></span>: Get the maximum length supported by a deltacloud driver In order to make the best decision about how to name an instance, we need to know the maximum length supported by a deltacloud driver. This patch sets up gridmanager to ask the deltacloud GAHP what that maximum is. Once it finds out the maximum,\u00a0[...]\n (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22414\">[22414]</a></span>: Add support for max name length to the deltacloud GAHP. That is, some backend clouds have a maximum length that the name of an instance can be. Add a GAHP command to call into deltacloud to figure out what this length is, if any. This will be used by the next commit. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span>\u00a0[...]\n (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22413\">[22413]</a></span>: Require libdeltacloud 0.9 for maximum length support. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22412\">[22412]</a></span>: Convert dcloudjob build_instance_name to use a UUID. This is so that we can shorten up the name (some clouds require fairly short names), and also maintain the uniqueness of the names. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22411\">[22411]</a></span>: Remove the gahp_error_code from dcloudjob.cpp. It wasn't being used at all. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2264\" title=\"Review Request: Support for stateful clouds in condor deltacloud\">#2264</a></span> Committer: Jaime Frey  (By Chris Lalancette )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Oct-19 08:29", "status": "resolved", "created": "2011-Jun-22 14:49", "fixed_version": "2011-Jun-22 14:49", "broken_version": "v070600", "priority": "3", "subsystem": "Grid", "assigned_to": "clalance", "derived_from": "", "creator": "clalance", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com, clalance@redhat.com, jfrey@cs.wisc.edu", "due_date": ""}