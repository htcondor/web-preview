{"id": 885, "title": "Ticket #885: condor_off is irreversible when daemon is already off", "description": "<blockquote>\nWe ran the following commands in CHTC.  Not only did HDFS not get started but we couldn't find any way to ever start it again without restarting the master.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">condor_off -subsys HDFS &lt;hostname&gt;\ncondor_on -subsys HDFS &lt;hostname&gt;\n</pre></div>\n\n\n<p>Resulted in the following <code>MasterLog</code>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">10/23 16:49:29 The HDFS (pid 19944) exited with status 4\n10/23 16:49:29 restarting /usr/sbin/condor_hdfs in 3600 seconds\n10/23 17:07:04 Got SIGHUP.  Re-reading config files.\n10/23 17:07:04 Reconfiguring all running daemons.\n10/23 17:07:04 Sent SIGHUP to STARTD (pid 18703)\n10/23 17:12:55 Handling daemon-specific command for \"HDFS\"\n10/23 17:12:55 Canceling timer to re-start HDFS\n10/23 17:13:05 Handling daemon-specific command for \"HDFS\"\n</pre></div>\n\n\n<p>So HDFS was already off and was waiting to restart when we sent our condor_off.  Then when we sent condor_on, it did not start.  With increased debugging, we see this in <code>MasterLog</code>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">10/23 17:18:27 Handling daemon-specific command for \"HDFS\"\n10/23 17:18:27 ::RealStart; HDFS on_hold=0\n10/23 17:18:27 ::RealStart; HDFS stop_state=1, ignoring\n</pre></div>\n\n\n<p>It appears to me that the following code is responsible.  It seems that the stop state should be set after the check to see if we are running, not before.  This same pattern repeats for other shutdown modes.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">    stop_state = GRACEFUL;\n        // Test for pid after setting state so HA daemons that aren't\n        // running get notified that they are shutting down\n    if( !pid ) {\n            // We're not running, just return.\n        return;\n    }\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2009-Dec-21 12:46:57 by danb:</em> <br/>\n\nThe patch I submitted for this (<span class=\"chng\"><a href=\"chngview?cn=16742\">[16742]</a></span>) undoes some of the changes from commit 3924ee46, which was trying to fix a race condition in stop/start of HA daemons.  Now we need to figure out how to solve that race condition without causing irreversible condor_off.  One idea is to make use of the existing <code>GotDaemonsOff</code> global state in the master.  It is currently not set when initiating shutdown of the master, but it would be appropriate to do so.  When this flag is set, we could disallow startup of any daemons or at least HA daemons.\n\n<p></p><hr/>\n<em>2009-Dec-23 13:50:54 by danb:</em> <br/>\n\nI reverted my previous fix for this, which just undid parts of 3924ee46, which introduced the irreversible condor_off problem.  I also reverted 3924ee46 and the accompanying patch 89697cc1.\n\n<p>In place of all those reverted patches, I have created <span class=\"chng\"><a href=\"chngview?cn=16777\">[16777]</a></span> which fixes the race condition on master shutdown with HA daemons and also avoids the irreversible condor_off problem.  The patch makes use of a flag that gets set when the master is shutting down.  In shutdown mode, no new daemons are allowed to start (including both HA and non-HA daemons).</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-06 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16834\">[16834]</a></span>: Revert \"Fixed shutdown race condition in master with HA daemons\" This reverts commit 24013295ddfb7263528d813cc3bee95497b0db20. This reverts commit 89697cc17f1f9c21ca1f944b5e75a9ce0ad45915. This reverts commit 3924ee46d836c7742ef3a7b07396959fc71cdc6c.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-06 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16835\">[16835]</a></span>: Fix for irreversible condor_off and shutdown race condition in master with HA daemons. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=885\" onclick=\"get_ticket_and_populate_wrapper('885'); return false;\" title=\"condor_off is irreversible when daemon is already off\">#885</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-06 13:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16830\">[16830]</a></span>: Fix for irreversible condor_off problem. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=885\" onclick=\"get_ticket_and_populate_wrapper('885'); return false;\" title=\"condor_off is irreversible when daemon is already off\">#885</a></span> If a daemon was already off, sending condor_off would make it impossible to ever turn the daemon on again without restarting the master.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-23 17:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16784\">[16784]</a></span>: Revert \"Fixed shutdown race condition in master with HA daemons\" This reverts commit 24013295ddfb7263528d813cc3bee95497b0db20. This reverts commit 89697cc17f1f9c21ca1f944b5e75a9ce0ad45915. This reverts commit 3924ee46d836c7742ef3a7b07396959fc71cdc6c.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-23 17:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16785\">[16785]</a></span>: Fix for irreversible condor_off and shutdown race condition in master with HA daemons. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=885\" onclick=\"get_ticket_and_populate_wrapper('885'); return false;\" title=\"condor_off is irreversible when daemon is already off\">#885</a></span> Committer: Alan De Smet  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-23 17:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16780\">[16780]</a></span>: Fix for irreversible condor_off problem. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=885\" onclick=\"get_ticket_and_populate_wrapper('885'); return false;\" title=\"condor_off is irreversible when daemon is already off\">#885</a></span> If a daemon was already off, sending condor_off would make it impossible to ever turn the daemon on again without restarting the master. Committer: Alan De Smet  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-23 13:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16777\">[16777]</a></span>: Fix for irreversible condor_off and shutdown race condition in master with HA daemons. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=885\" onclick=\"get_ticket_and_populate_wrapper('885'); return false;\" title=\"condor_off is irreversible when daemon is already off\">#885</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-23 13:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16776\">[16776]</a></span>: Revert \"Fixed shutdown race condition in master with HA daemons\" This reverts commit 24013295ddfb7263528d813cc3bee95497b0db20. This reverts commit 89697cc17f1f9c21ca1f944b5e75a9ce0ad45915. This reverts commit 3924ee46d836c7742ef3a7b07396959fc71cdc6c.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-21 11:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16742\">[16742]</a></span>: Fix for irreversible condor_off problem. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=885\" onclick=\"get_ticket_and_populate_wrapper('885'); return false;\" title=\"condor_off is irreversible when daemon is already off\">#885</a></span> If a daemon was already off, sending condor_off would make it impossible to ever turn the daemon on again without restarting the master.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-23 13:51", "status": "resolved", "created": "2009-Oct-23 17:53", "fixed_version": "2009-Oct-23 17:53", "broken_version": "v070400", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.wisc.edu matt@cs.wisc.edu", "due_date": ""}