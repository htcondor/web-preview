{"id": 3812, "title": "Ticket #3812: collector reporting duplicate ads", "description": "<blockquote>\nSee slot13 below:\n\n<p></p><div class=\"verbatim\">\n<pre>[root@condor ~]# condor_status spice115.sugar.phy.syr.edu\nName               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime\n\nslot10@spice115.su LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:05\nslot11@spice115.su LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:01\nslot12@spice115.su LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:02\nslot13@spice115.su LINUX      X86_64 Claimed   Busy      1.000 2010  0+03:13:32\nslot13@spice115.su LINUX      X86_64 Claimed   Busy      1.000 ?   [Unknown]\nslot14@spice115.su LINUX      X86_64 Claimed   Busy      1.000 2010  0+03:35:53\nslot15@spice115.su LINUX      X86_64 Preemptin Vacating  0.000 2010  0+00:01:26\nslot16@spice115.su LINUX      X86_64 Claimed   Busy      1.000 2010  0+03:44:11\nslot17@spice115.su LINUX      X86_64 Claimed   Busy      1.230 4021  0+00:33:01\nslot18@spice115.su LINUX      X86_64 Claimed   Busy      1.000 4021  0+00:04:30\nslot19@spice115.su LINUX      X86_64 Claimed   Busy      1.000 4021  0+03:32:38\nslot1@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot20@spice115.su LINUX      X86_64 Claimed   Busy      1.000 4021  0+00:30:19\nslot21@spice115.su LINUX      X86_64 Claimed   Busy      1.010 4021 13+05:36:52\nslot22@spice115.su LINUX      X86_64 Claimed   Busy      1.010 4021 13+05:24:37\nslot23@spice115.su LINUX      X86_64 Claimed   Busy      1.010 4021 13+05:34:37\nslot24@spice115.su LINUX      X86_64 Claimed   Busy      2.000 4021  0+00:05:02\nslot2@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:05\nslot3@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:01\nslot4@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:02\nslot5@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:03\nslot6@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot7@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:05\nslot8@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:03\nslot9@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\n                     Total Owner Claimed Unclaimed Matched Preempting Backfill\n\n        X86_64/LINUX    25     0      12         0       0          1       12\n\n               Total    25     0      12         0       0          1       12\n</pre></div>\n\n\n<p>However, a direct query doesn't show the problem:\n\n</p><p></p><div class=\"verbatim\">\n<pre>[root@condor ~]# condor_status -dir spice115.sugar.phy.syr.edu\nName               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime\n\nslot10@spice115.su LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot11@spice115.su LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot12@spice115.su LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot13@spice115.su LINUX      X86_64 Claimed   Busy      1.000 2010  0+03:30:14\nslot14@spice115.su LINUX      X86_64 Claimed   Busy      1.000 2010  0+03:47:35\nslot15@spice115.su LINUX      X86_64 Claimed   Busy      0.000 2010  0+00:03:07\nslot16@spice115.su LINUX      X86_64 Preemptin Vacating  0.000 2010  0+00:00:16\nslot17@spice115.su LINUX      X86_64 Claimed   Busy      1.990 4021  0+00:44:48\nslot18@spice115.su LINUX      X86_64 Claimed   Busy      1.000 4021  0+00:16:16\nslot19@spice115.su LINUX      X86_64 Claimed   Busy      2.000 4021  0+03:49:23\nslot1@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot20@spice115.su LINUX      X86_64 Claimed   Busy      1.270 4021  0+00:42:03\nslot21@spice115.su LINUX      X86_64 Claimed   Busy      1.010 4021 13+05:48:35\nslot22@spice115.su LINUX      X86_64 Claimed   Busy      1.010 4021 13+05:36:19\nslot23@spice115.su LINUX      X86_64 Claimed   Busy      1.010 4021 13+05:46:18\nslot24@spice115.su LINUX      X86_64 Claimed   Busy      2.000 4021  0+00:21:50\nslot2@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot3@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot4@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot5@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot6@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot7@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot8@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\nslot9@spice115.sug LINUX      X86_64 Backfill  Idle      0.000 1005  0+00:00:04\n                     Total Owner Claimed Unclaimed Matched Preempting Backfill\n\n        X86_64/LINUX    24     0      11         0       0          1       12\n\n               Total    24     0      11         0       0          1       12\n</pre></div>\n\n\n<p>The full machine classad dump (from the collector) is available <a class=\"external\" href=\"https://www.dropbox.com/s/28lpj71l2l60pvg/full-classads.txt\">here</a>.\n\n</p><p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartLog\" title=\"Start Log\">StartLog</a></span> is available <a class=\"external\" href=\"https://www.dropbox.com/s/z4259py77y53d85/StartLog.gz\">here</a>.\n\n</p><p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CollectorLog\" title=\"Collector Log\">CollectorLog</a></span> is available <a class=\"external\" href=\"https://www.dropbox.com/s/0kav66vr1i7fde7/CollectorLog.gz\">here</a>.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jul-30 13:57:11 by pfc:</em> <br/>\n\nI should add that at any given time this is happening for a few nodes.  E.g., right now it's happening on six:\n<div class=\"verbatim\">\n<pre>[root@condor kickstart]# condor_status | fgrep Unknown\nslot14@spice033.su LINUX      X86_64 Claimed   Busy      1.000 ?   [Unknown]\nslot14@spice046.su LINUX      X86_64 Claimed   Busy      1.000 ?   [Unknown]\nslot2@spice099.sug LINUX      X86_64 Claimed   Busy      0.000 ?   [Unknown]\nslot13@spice100.su LINUX      X86_64 Claimed   Busy      1.000 ?   [Unknown]\nslot13@spice119.su LINUX      X86_64 Claimed   Busy      1.000 ?   [Unknown]\nslot20@spice119.su LINUX      X86_64 Claimed   Busy      1.000 ?   [Unknown]\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Jul-30 14:02:49 by tannenba:</em> <br/>\n\nThe collector hashes startd ads on a tuple of the classad's <em>Name</em> attribute and <em>MyAddress</em> attribute.\n\n<p>I think you were seeing duplicate entries momentarily because the IP address of that machine (spice115) changed.  Thus the ad with the old IP address for that machine will stick around until aged out.\n\n</p><p>Attached relevant lines grepped from the Collector log below showing the IP address changing from 10.20.3.115 to 10.20.3.84 right about the time you noticed the duplicate.  As such I am resolving this ticket - we can reopen if I misunderstood something.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/20/13 08:14:06 StartdAd     : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.123 &gt;\"\n07/20/13 08:14:06 stats: Inserting new hashent for 'Start':'slot13@spice115.sugar.phy.syr.edu':'10.20.3.123'\n07/20/13 08:14:06 StartdPvtAd  : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.123 &gt;\"\n07/20/13 08:14:06 stats: Inserting new hashent for 'StartdPvt':'slot13@spice115.sugar.phy.syr.edu':'10.20.3.123'\n07/20/13 08:31:57               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.123 &gt;\"\n07/20/13 08:31:57               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.123 &gt;\"\n07/20/13 08:31:57               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.123 &gt;\"\n07/20/13 08:31:57               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.123 &gt;\"\n07/24/13 03:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 03:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 03:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 03:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 03:19:55 StartdAd     : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 03:19:55 StartdPvtAd  : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 11:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 11:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 11:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 11:19:14               **** Removing stale ad: \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 11:20:01 StartdAd     : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 11:20:01 StartdPvtAd  : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.115 &gt;\"\n07/24/13 16:30:03 StartdAd     : Inserting ** \"&lt; slot13@spice115.sugar.phy.syr.edu , 10.20.3.84 &gt;\"\n07/24/13 16:30:03 stats: Inserting new hashent for 'Start':'slot13@spice115.sugar.phy.syr.edu':'10.20.3.84'\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Jul-30 14:05:26 by pfc:</em> <br/>\n\nThat's a bug -- there is /no way/ these hosts' IP addresses are changing.  From where does Condor get its idea to the contrary?\n\n<p></p><hr/>\n<em>2013-Jul-30 14:08:08 by pfc:</em> <br/>\n\n...and I've just confirmed by looking at the hosts that their IPs have not changed (I can see the DHCP leases renewing and they're 100% consistent).\n\n<p>Could Condor be thinking one slot's update is from another?\n\n</p><p></p><hr/>\n<em>2013-Jul-30 14:25:00 by tannenba:</em> <br/>\n\nIt could be that two machines, one with IP addr 10.20.3.115 and one with IP addr 10.20.3.84 both have inverse names in DNS of spice115.\n\n<p>On machine 10.20.3.115, what does /bin/hostname say?  What does an inverse nslookup and/or /etc/hosts say?  Ditto for 10.20.3.84 ?\n\n</p><p></p><hr/>\n<em>2013-Jul-30 14:44:53 by pfc:</em> <br/>\n\nWe have no DNS on our private network.\n\n<p></p><hr/>\n<em>2013-Jul-30 14:48:46 by pfc:</em> <br/>\n\nTo use a host on which the problem is occurring right now:\n<div class=\"code\">\n<pre class=\"code\">[root@spice033 ~]# /bin/hostname\nspice033.sugar.phy.syr.edu\n[root@spice033 ~]# fgrep spice033 /etc/hosts\n10.20.3.33\tspice033.sugar.phy.syr.edu\tspice033\n[root@spice033 ~]# ifconfig br0\nbr0       Link encap:Ethernet  HWaddr 00:25:90:29:D0:AA\n          inet addr:10.20.3.33  Bcast:10.255.255.255  Mask:255.0.0.0\n          inet6 addr: fe80::225:90ff:fe29:d0aa/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:4564387751 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:2398078357 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:6107607130095 (5.5 TiB)  TX bytes:1419408916270 (1.2 TiB)\n</pre></div>\n\n\n<p>...and on the central manager:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">[root@condor ~]# fgrep spice033 /etc/hosts\n10.20.3.33\tspice033.sugar.phy.syr.edu\tspice033\n</pre></div>\n\n\n<p>...so they all agree.\n\n</p><p></p><hr/>\n<em>2013-Jul-30 14:56:09 by tannenba:</em> <br/>\n\nAnd what about the other IP address that was reported to the collector as spice033 ?  Look at the 'stale' duplicate ad for the stale IP address, or grep 'spice033' at the tail of the collector log to find the other IP address.  What other machine is using this stale IP address? How long has it been using it?\n\n<p></p><hr/>\n<em>2013-Jul-30 15:18:51 by pfc:</em> <br/>\n\nSame thing.  Consistent IP for months via DHCP, accurate hosts file entries, etc.\n\n<p></p><hr/>\n<em>2013-Jul-30 15:20:09 by pfc:</em> <br/>\n\nI.e., the other host (spice144, aka 10.20.3.144) has <strong>not</strong> been using spice033's name or IP (10.20.3.33) at all, ever, period.  And visa-versa.  Evidence of this problem is 100% nonexistent outside of Condor's logs.\n\n<p></p><hr/>\n<em>2013-Jul-31 14:20:08 by tannenba:</em> <br/>\n\nAnother thought... does spice033 and/or other nodes that sometimes have dup ads have more than one physical interface? I could imagine a problem with duplicate ads if a machine has more than one interface with a route to the collector, and these routes have the same metric (weight) in the routing table.\n\n<p></p><hr/>\n<em>2013-Jul-31 15:41:50 by pfc:</em> <br/>\n\nNope, all our cluster nodes have a single physical interface, on our private network.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "incident", "last_change": "2015-Sep-22 14:58", "status": "defer", "created": "2013-Jul-24 15:41", "fixed_version": "2013-Jul-24 15:41", "broken_version": "v080000", "priority": "5", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "", "creator": "pfc", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pfcouvar@syr.edu,pcouvare@caltech.edu", "due_date": ""}