{"id": 5642, "title": "Ticket #5642: Provide a stop constraint for history queries", "description": "<blockquote>\nIn CMS, we use the python binding's remote history query functionality to centralize all our job ads.\n\n<p>Unfortunately, it's fairly expensive to ask for a subset of the ads.  For example, if we want to query for all jobs completed since noon, HTCondor will still parse the last 10,000 jobs by default - even though we know we can stop parsing once we found a single job with completion date prior to noon.\n\n</p><p>Hence, we should add the concept of a \"stop expression\" to the API.  If a parsed ad matches the given expression, do not return it and immediately stop processing.\n\n</p><p>The python API would look something like this:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">import htcondor\nsd = htcondor.Schedd()\niter = sd.history(requirements='VO=?=\"CMS\"', stop_requirements='CompletionDate &lt; 1460815361')\nfor job in iter:\n  # Do stuff with our wonderful job ads.\n  print job['ClusterId']\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-May-04 16:00:23 by jfrey:</em> <br/>\n\nThe only useful stop requirements I can think of are <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CompletionDate\" title=\"Completion Date\">CompletionDate</a></span> less than a given value, and job id (cluster and proc) matching a given value. Can you think of any others? If not, wouldn't it be better to support these two cases specifically rather than a general expression?\n\n<p></p><hr/>\n<em>2016-May-04 16:04:07 by bbockelm:</em> <br/>\n\nAh - my original plan was to just hardcode the date (as that's my narrow use case).  TJ suggested to turn it into an expression.  Can you chat with him on what other items he had in mind?\n\n<p>Honestly, given this is a programmatic-only interface, I would lean toward the more generic.\n\n</p><p></p><hr/>\n<em>2016-Jun-01 17:09:37 by johnkn:</em> <br/>\n\nWe should do this by enhancing condor_history to that it has a stop condition, and <strong>also</strong> so that it knows how to write into a socket.   Then change the schedd to just use condor_history as the history helper application.\n\n<p>I propose adding the following arguments to condor_history\n\n</p><p></p><ul>\n<li>-since-job &lt;job.id&gt;  stops when this job is seen and does <strong>not</strong> return it.\n</li><li>-sock &lt;inherited-socket-info&gt;  act as a history helper, writing into the given sock.\n</li></ul>\n\n<p>-since-job is the only way to do perfect periodic updates without ever risking missing a job or reading the same job twice.\n\n</p><p>We might also want to have a bit of cleverness in the argument parsing and support this.\n\n</p><p></p><ul>\n<li>-since &lt;time&gt;|&lt;job.id&gt;|&lt;expr&gt;\n</li></ul>\n\n<p>where the argument is parsed as a classad expression, and if the result is an int literal, treat that as a time,  if it's a float literal, treat that as a job id, and if it's anything else, treat it as an expression. We might also have a special case here for delta times, eg. 2hr, 1day, 1week, etc.\n\n</p><p>On the reading side,  we could look at the attribute references for the -since expression, and if it looks only at cluster, proc, completiondate and/or owner, we could skip parsing the job ad entirely and just evaluate the stop expression against those 4 bits of information.\n\n</p><p></p><hr/>\n<em>2016-Jun-06 14:41:03 by johnkn:</em> <br/>\n\ncommit <span class=\"chng\"><a href=\"chngview?cn=48496\">[48496]</a></span> adds -since and -completed since to condor_history. also -scanlimit, -inherit and -attributes arguments. These changes allow condor_history to be used as the history helper for remote condor_history queries.\n\n<p>The schedd python bindings have not yet been updated to handle the new arguments, and the condor_history_helper binary has not yet been removed.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6247\" title=\"Remove History Helper\">#6247</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRemove History Helper</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=6248\" title=\"Python bindings missing for recent condor_history features\">#6248</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nPython bindings missing for recent condor_history features</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-20 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48814\">[48814]</a></span>: Version history and doc for new condor_history -since option <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5642\" title=\"Provide a stop constraint for history queries\">#5642</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-06 14:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48496\">[48496]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5642\" title=\"Provide a stop constraint for history queries\">#5642</a></span> provide a stop constraint for history queries. This commit obsoletes (but does not remove) the history_helper. condor_history is now invoked by the schedd when a history_helper process is needed. This commit also for a stop constraint with the -since and -completedsince command line arguments\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-19 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48245\">[48245]</a></span>: Provide stop constraint for history queries. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5642\" title=\"Provide a stop constraint for history queries\">#5642</a></span> The stop constraint indicates the history parser has hit an ad the client is no longer interested in. The remote side can stop parsing and return immediately.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jul-20 15:00", "status": "resolved", "created": "2016-Apr-19 15:17", "fixed_version": "2016-Apr-19 15:17", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}