{"id": 7532, "title": "Ticket #7532: box_plugin should retry with refreshed tokens", "description": "<blockquote>\nBox only allows a single access token per user per API client (i.e. per schedd) to be valid at a time. If tokens are refreshed on the schedd, there is a period between the token refresh and when a job's starter fetches new sandbox tokens where the token in the sandbox is invalid. This situation leads to 401 errors when the Box file transfer plugin tries to download or upload files.\n\n<p>The simple solution is for the Box plugin, once getting the 401, to monitor the sandbox access token for a refresh and retry as soon as it is refreshed. There's an upper bound on how long the plugin should wait, <code>SEC_CREDENTIAL_REFRESH</code> (which should be assumed to be 300 if not defined).</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Mar-04 11:21:16 by jpatton:</em> <br/>\n\nWaiting for new tokens from inside the plugin does not work because the starter blocks waiting for the plugin to exit. Instead, we need a way for a file transfer plugin to exit and signal that it should be retried when new credentials are obtained from the shadow.\n\n<p></p><hr/>\n<em>2020-Mar-04 14:34:58 by coatsworth:</em> <br/>\n\nI've rejigged the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> object so that plugins use enumerated result codes instead of binary success/failure. It's a bigger change than I expected so I'm pushing my code to a branch:\n\n<p>V8_9-gt7532-plugin-auth-retry\n\n</p><p>Right now I'm using the following values:\n\n</p><p></p><ul>\n<li>Plugin failed: -1\n</li><li>Plugin success: 0\n</li><li>Plugin has invalid credentials: 1\n</li></ul>\n\n<p>We'll want to update all our file transfer plugins to use these codes. Ideally, we can force them to use the enumerated values so that if the values/codes change in the future, the plugins won't have to change also.\n\n</p><p></p><hr/>\n<em>2020-Mar-05 12:19:45 by jpatton:</em> <br/>\n\nBox plugin updated to exit 1 when encountering a HTTP 401 error. Will update the Google Drive and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OneDrive\" title=\"One Drive\">OneDrive</a></span> plugins to do the same once we settle on the enum values and test Box.\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-24 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59473\">[59473]</a></span>: Fixed mangled merge (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-22 13:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59472\">[59472]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=59080\">[59080]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=59106\">[59106]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=59107\">[59107]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=59145\">[59145]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=59233\">[59233]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=59471\">[59471]</a></span>, Merging file transfer plugin enumerated return types into master (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)\" Conflicts: src/condor_utils/file_transfer.cpp  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-22 13:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59471\">[59471]</a></span>: Reversed syscall approach to shadow communication (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-02 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59233\">[59233]</a></span>: Added syscall socket + example usage in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> for credential refresh (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-12 16:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59145\">[59145]</a></span>: Fixed uploads byte reporting, code cleanup (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-09 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59106\">[59106]</a></span>: Plugin downloads working with new error codes (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-05 12:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59084\">[59084]</a></span>: box_plugin exits 1 when encountering a 401 <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-04 14:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59080\">[59080]</a></span>: Rejigged file plugins to use enumerated result codes, not tested (<span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=7532\" onclick=\"get_ticket_and_populate_wrapper('7532'); return false;\" title=\"box_plugin should retry with refreshed tokens\">#7532</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Nov-09 12:23", "status": "active", "created": "2020-Mar-02 13:48", "fixed_version": "2020-Mar-02 13:48", "broken_version": "", "priority": "1", "subsystem": "FileTransfer", "assigned_to": "jpatton", "derived_from": "", "creator": "jpatton", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "jpatton@cs.wisc.edu,coatsworth@cs.wisc.edu,johnkn@cs.wisc.edu", "due_date": ""}