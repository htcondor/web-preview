{"id": 2450, "title": "Ticket #2450: schedd fails to parse its transaction log", "description": "<blockquote>\nA schedd in the glidein factory at UCSD failed to restart after a power outage.  It failed with the following exception:\n\n<p></p><pre>   ERROR \"Error: bad record with op=103 in corrupt logfile\" at line 1060 in file /home/condor/execute/dir_22626/userdir/src/condor_utils/classad_log.cpp\n</pre>\n\n<p>Note the complete lack of helpful information about where in the transaction log this error was encountered.\n\n</p><p>It turned out that there were numerous entries in the transaction log of the following form, where XXXX is replaced by random garbage characters:\n\n</p><p></p><pre>   103 541891.0 HoldReason \"CREAM error: CREAM_Job_Register Error: XXXXodName=[jobRegister] ErrorCode=[0] Description=[The CREAM service cannot accept jobs at the moment] FaultCause=[Submissions are disabled!] Timestamp=[Wed 07 Sep 2011 17:54:52]\"\n</pre>\n\n<p>Removing the garbage characters made the schedd happy.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-12 13:37:10 by danb:</em> <br/>\n\nThe problem is caused by ascii 0xFF characters.  These are treated as an error by the log reading code in LogRecord::readline(), because they happen to match the value of (char)EOF:\n\n<p></p><pre>        buf[i] = fgetc( fp );\n        if( buf[i] == EOF &amp;&amp; !feof( fp ) ) {\n            free( buf );\n            return( -1 );\n        }\n</pre>\n\n<p>But these characters are not forbidden by the log writing code, so it is possible to write a record that is not accepted on read-back.  This code that treats EOF as an error dates back to at least 6.4.0 if not earlier.\n\n</p><p>This failure to distinguish between (char)0xFF and EOF is a bug.  I therefore propose fixing the log reader rather than forbidding the writing of 0xFF characters.\n\n</p><p>It is a shame that the quill log reader is implemented completely separately, duplicating much code.  It happens that while fixing a different sort of problem, that code was fixed to distinguish between (char)0xFF and EOF in <span class=\"chng\"><a href=\"chngview?cn=17674\">[17674]</a></span>.\n\n</p><p></p><hr/>\n<em>2011-Sep-12 20:56:21 by danb:</em> <br/>\n\nNote: some of the commits associated with this ticket are for 7.7.2.  The commits that went into 7.6.4 are <span class=\"chng\"><a href=\"chngview?cn=27176\">[27176]</a></span> and <span class=\"chng\"><a href=\"chngview?cn=27182\">[27182]</a></span>.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=2459\" onclick=\"get_ticket_and_populate_wrapper('2459'); return false;\" title=\"CREAM hold message contains garbage characters\">#2459</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCREAM hold message contains garbage characters</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 20:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27183\">[27183]</a></span>: Make quill's log reader use the same token-reading functions as the rest of condor. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2450\" onclick=\"get_ticket_and_populate_wrapper('2450'); return false;\" title=\"schedd fails to parse its transaction log\">#2450</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 18:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27182\">[27182]</a></span>: Corrected handling of null character in my previous patch. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2450\" onclick=\"get_ticket_and_populate_wrapper('2450'); return false;\" title=\"schedd fails to parse its transaction log\">#2450</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 17:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27181\">[27181]</a></span>: Documented improved logging when encountering corruption in the classad log. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2450\" onclick=\"get_ticket_and_populate_wrapper('2450'); return false;\" title=\"schedd fails to parse its transaction log\">#2450</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 17:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27179\">[27179]</a></span>: Documented fix for (char)255 in the classad log. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2450\" onclick=\"get_ticket_and_populate_wrapper('2450'); return false;\" title=\"schedd fails to parse its transaction log\">#2450</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27177\">[27177]</a></span>: Improved log message when corruption in the classad log is encountered. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2450\" onclick=\"get_ticket_and_populate_wrapper('2450'); return false;\" title=\"schedd fails to parse its transaction log\">#2450</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 17:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27176\">[27176]</a></span>: Allow reading of (char)255 characters in the classad log. Previously, if a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> value contained such a character, it was written to the transaction log, but the log reader would fail when trying to load it back in. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2450\" onclick=\"get_ticket_and_populate_wrapper('2450'); return false;\" title=\"schedd fails to parse its transaction log\">#2450</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-04 12:09", "status": "resolved", "created": "2011-Sep-09 18:50", "fixed_version": "2011-Sep-09 18:50", "broken_version": "v070602", "priority": "2", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,tstclair@redhat.com", "due_date": ""}