{"id": 2306, "title": "Ticket #2306: Multiple file logging output architecturally brittle", "description": "<blockquote>\nThere are currently two problems with directing different debug levels to different log files.  Both occur when someone tries to direct two debug levels to the same file for whatever reason.\n\n<p>1. The debug message is written twice in the log if the two debug levels are ORed in the dprintf call.\n\n</p><p>2. The current keep file open architecture would hold two file pointers to the same file.  This means at rotation time we could conceivably attempt to rotate the file twice.  The rotation code does close the file before reopening it for rotation purposes, but better just get rid of the duplicate handles in the first place.\n\n</p><p>Proposed solution:\n\n</p><p>Use a vector to store a struct that contains the path to the file, the file pointer, and the debug flags associated with that file.  During configuration time the vector gets structs added to it as Condor discovers files for each debug level.  During runtime a call to dprintf will sweep through the vectors and only ever write to a file in the vectors once in the run.  This eliminates both problems.  Long term this could probably be extended to include other \"types\" of output for dprintf.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-22 17:20:22 by johnkn:</em> <br/>\n\ni think that the expression\n\n<p></p><pre>   if((debugFlags != 0) &amp;&amp; ((debugFlags &amp; flags) != flags))\n</pre>\n\n<p>is wrong, it would work only when there is a single bit set, to work with multiple bits use\n\n</p><p></p><pre>   if((debugFlags != 0) &amp;&amp; ((debugFlags &amp; flags) == 0))\n</pre>\n\n<p>instead.\n\n</p><p></p><hr/>\n<em>2011-Oct-20 16:18:55 by johnkn:</em> <br/>\n\nThis looks fine.\n\n<p>There is currently no way to express many &lt;-&gt; many mapping between debug levels and files, and the code as currently written will fail if you try.  But its a useful step on the way, and it currently supports all of the configurations that we actually use.\n\n</p><p>It's important that we don't <em>stop</em> making improvements at this point though.\n\n</p><p>-tj\n\n</p><p></p><hr/>\n<em>2011-Nov-16 19:26:12 by jfrey:</em> <br/>\n\nThe changes in this ticket completely break being able to have logs larger than 2GB on 32-bit systems. <code>DebugFileInfo::maxLog</code> is 32 bits on those systems. To make <code>off_t</code> be 64 bits, you have to #define <code>_FILE_OFFSET_BITS</code> to 64 before including the system header files, not just before you declare your <code>off_t</code> variable.\n\n<p></p><hr/>\n<em>2011-Nov-21 11:15:12 by jfrey:</em> <br/>\n\nLarge-file support on 32-bit systems has been restored by defining _FILE_OFFSET_BITS in the affected files. This is error-prone and will be better addressed in 7.7.5 or later.\n\n<p></p><hr/>\n<em>2011-Nov-22 15:18:23 by jfrey:</em> <br/>\n\nCheckin <span class=\"chng\"><a href=\"chngview?cn=28401\">[28401]</a></span> breaks on freebsd and macosx. Solaris may be affected as well. On macosx, there is no lseek64(); lseek() always uses 64-bit values in the versions we support. I don't about freebsd, but I suspect you can just use lseek() on the 64-bit version.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-30 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28507\">[28507]</a></span>: Take two on fixing 32/64bit mess with log file sizes, this time for all platforms. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-23 09:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28413\">[28413]</a></span>: Revert \"Forgot to include header file change for 64bit log size. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.\" This reverts commit 111475ff9996710edadb874194fb38aca7a38825. This also reverts 53405404e7eb96c95d1c223f00ac438919a36647 These commits broke most dagman tests.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-22 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28402\">[28402]</a></span>: Forgot to include header file change for 64bit log size. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-22 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28401\">[28401]</a></span>: Convert max log variable to always use 64bit values to avoid off_t mismatches. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-17 11:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28290\">[28290]</a></span>: Fix support for log sizes larger than 2GB on 32-bit linux. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span> The changes made to improve logging to multiple files for 7.7.3 broke support for large log files on 32-bit linux, due to a misplaced _FILE_OFFSET_BITS macro.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-04 13:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28128\">[28128]</a></span>: change dprintf internal functions to take a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugFileInfo\" title=\"Debug File Info\">DebugFileInfo</a></span> rather than trying to treat debug_level as a 'index' into the vector of DebugFileInfo's. This is an attempt to re-enable the behavior of paying attention to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugFlags\" title=\"Debug Flags\">DebugFlags</a></span> for the first log file which was broken in a previous commit of the dprintf\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-03 19:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28119\">[28119]</a></span>: Revert \"Fix major oversight where we could drop all debug levels besides D_ALWAYS. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.\" This reverts commit 9f4aa84ee5a03913479660466bb8002588ba33ef. This commit breaks most of the test suite  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-03 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28116\">[28116]</a></span>: Fix major oversight where we could drop all debug levels besides D_ALWAYS. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-16 09:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27244\">[27244]</a></span>: Fix semantic problem when output is intended for the terminal and no output locations are specified. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-14 12:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27206\">[27206]</a></span>: Fix potential causes of the illegal instruction signal on Linux by passing in the C string version of the log path instead of the std::string version to certain printf-like functions. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-01 12:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27056\">[27056]</a></span>: Add an internal header file for dprintf to separate the off_t definition. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-01 11:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27051\">[27051]</a></span>: Add an explicit copy constructor to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugFileInfo\" title=\"Debug File Info\">DebugFileInfo</a></span> to avoid stale pointers. Compilation fixes for standard universe. Fix major bug related to size of off_t between dprintf.cpp and dprintf_config.cpp. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-29 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27020\">[27020]</a></span>: Fix vector usage on Linux and fix fileno conversion for getting list of open debug logs. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-26 14:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27002\">[27002]</a></span>: Semantic fixes to how debug flags were compared to see if we write to a specific log file. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-12 13:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26748\">[26748]</a></span>: Fixes to get vector list of debug files functional. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-09 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26696\">[26696]</a></span>: Continue purge of arrays used to hold debug information, moving them into a vector. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-03 13:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26597\">[26597]</a></span>: Convert list of log files and their FDs into a vector instead of an array. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2306\" title=\"Multiple file logging output architecturally brittle\">#2306</a></span>.  (By Ziliang Guo )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-22 15:18", "status": "resolved", "created": "2011-Jul-14 15:19", "fixed_version": "2011-Jul-14 15:19", "broken_version": "v070700", "priority": "2", "subsystem": "Libs", "assigned_to": "ziliang", "derived_from": "#2476", "creator": "ziliang", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}