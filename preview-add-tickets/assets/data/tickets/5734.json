{"id": 5734, "title": "Ticket #5734: Nonexistent owners cause problems in schedd", "description": "<blockquote>\nIn most of HTCondor, authenticated usernames in CEDAR don't have to correspond to OS user accounts, although they frequently do. However, in the schedd, we usually map an authenticated username to a job's Owner attribute, and the Owner attribute must be a valid local OS user account. Job files will be owned by this account, and the schedd and its children with act as this account for file access and other possible activities.\n\n<p>Currently, a job's Owner attribute is set to match the authenticated username of the submitting client without any check on its validity. This leads to various failures during and after job submission. Some actions are performed as the condor user or root instead of the job owner. The schedd repeatedly tries and fails to run the job. The schedd can EXCEPT when it can't become the non-existent user. Attempts to remove the job can fail.\n\n</p><p>There a few fixes we should make:\n\n</p><p></p><ul>\n<li>The job event writing code shouldn't attempt to switch to user privilege if it fails to initialize the user info. This leads to an EXCEPT of the schedd in 8.5.\n</li><li>The schedd should refuse a job submission if the Owner attribute doesn't correspond to a valid OS user account.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-16 11:21:22 by jfrey:</em> <br/>\n\nAttached a patch that returns an error message to the client when the schedd rejects an invalid Owner value. Not sure if it's appropriate for stable.\n\n<p></p><hr/>\n<em>2016-Jun-16 15:06:45 by gthain:</em> <br/>\n\nWhen condor is running as non-root, what should we do with nonexistant owners, because we will always run as the non-root id anyway?\n\n<p></p><hr/>\n<em>2016-Jun-20 10:23:24 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  This is good for stable, and let's hold off the owner.patch until devel.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=5741\" title=\"Improve error reporting in queue-management interface\">#5741</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove error reporting in queue-management interface</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/946/owner.patch\">owner.patch</a>\n3042 bytes added by jfrey on 2016-Jun-16 16:20:35 UTC.\n<br/>\nOn invalid Owner error, delay failure until <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommitTransaction\" title=\"Commit Transaction\">CommitTransaction</a></span> and return an error message to the client.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-24 12:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48629\">[48629]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5734\" title=\"Nonexistent owners cause problems in schedd\">#5734</a></span>: Fixed typo in version history that kept manual from building.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-21 09:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48599\">[48599]</a></span>: Docs for schedd rejecting non-existent job owners. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5734\" title=\"Nonexistent owners cause problems in schedd\">#5734</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-16 15:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48577\">[48577]</a></span>: Disable Owner account existence check when non-root <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5734\" title=\"Nonexistent owners cause problems in schedd\">#5734</a></span> If the schedd can't switch to different user accounts, then it doesn't matter if a given Owner value doesn't have a valid account.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-16 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48567\">[48567]</a></span>: Schedd rejects jobs with invalid Owner attribute. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5734\" title=\"Nonexistent owners cause problems in schedd\">#5734</a></span> In the schedd, the Owner attribute must be a valid local OS user account. Many things will fail if it is not.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-15 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48562\">[48562]</a></span>: Event log writer shouldn't switch to uninitialized user. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5734\" title=\"Nonexistent owners cause problems in schedd\">#5734</a></span> If <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> hasn't successfully initialized the user privilege state, then it should switch to condor priv instead of user priv. Trying to use user priv will lead to a bad priv state or an EXCEPT.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Jun-21 09:44", "status": "resolved", "created": "2016-Jun-15 16:24", "fixed_version": "2016-Jun-15 16:24", "broken_version": "v080400", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu", "due_date": ""}