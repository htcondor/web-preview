{"id": 5506, "title": "Ticket #5506: More efficient updates of parent collector in a collector tree", "description": "<blockquote>\nThe CMS global pool central manager consists of a collector tree.\n\n<p>In Feb 2016, we observed the parent in the collector tree was unable to ingest <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> forwarded from the child collectors at a fast enough rate; the receive UDP buffer on the parent collector was full and the thus the parent collector is dropping ads.\n\n</p><p>Traditionally, whenever an ad was updated in a child collector, it would be immediately forwarded to the parent collector.  As a quick interim measure, this patch introduces two knobs to limit when a child collector will forward Startd ads to a parent collector to just two conditions:\n</p><ul>\n<li><code>FORWARD_INTERVAL</code>  an integer representing seconds; if an update for an ad arrives at a child collector and this ad has not been forwarded to the parent collector for more than FORWARD_INTERVAL seconds, the ad is forwarded.  If you set this knob to 0, you should get the same behavior as before this patch (i.e. every update gets immediately forwaded).\n</li><li><code>FORWARD_WATCH_LIST</code> a string list of classad attributes.  If an update arriving at a child collector changes the value of any of the attributes listed in this knob, then the ad is forwarded to the parent collector.  Defaults to <em>State,Cpus,Memory</em>.\n</li></ul>\n\n<p>Note that all other ads besides startd ads (e.g. startdprivate ads, submitter ads, etc) are still always immediately forwarded.  By only forwarding startd ads periodically or that only change their State, Cpus, or Memory value, we should reduce the number of ads sent to the parent collector.  For instance, the startd sends an update for all slot ads whenever the Activity changes, which means without this patch the parent collector could be flooded with startd ads if a user were to submit a large batch of short running jobs.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Feb-09 17:12:42 by tannenba:</em> <br/>\n\nPatches committed to topic branch V8_3_8-gt5506-branch\n\n<p>NMI Build for RHEL6 submitted to\n<a class=\"external\" href=\"http://submit-3.batlab.org/nmi/results/details?runID=356439\">http://submit-3.batlab.org/nmi/results/details?runID=356439</a>\n\n</p><p></p><hr/>\n<em>2016-Feb-09 17:14:12 by tannenba:</em> <br/>\n\nWe need to be wary with the use of this patch if CMS uses <code>STARTD_SLOT_ATTRS</code>, <code>STARTD_SLOT_EXPRS</code>, or <code>SYSTEM_STARTD_SLOT_ATTRS</code>.\n\n<p></p><hr/>\n<em>2016-Mar-11 11:06:16 by jfrey:</em> <br/>\n\nFiltering is now done on submitter ads in addition to startd ads.\n\n<p>The configuration parameters are now as follows:\n</p><ul>\n<li><code>COLLECTOR_FORWARD_FILTERING</code>: Boolean that controls whether filtering is enabled. Defaults to <code>False</code>.\n</li><li><code>COLLECTOR_FORWARD_WATCH_LIST</code>: List of attributes to filter on. Defaults to <code>State,Cpus,Memory,IdleJobs</code>.\n</li><li><code>COLLECTOR_FORWARD_INTERVAL</code>: Interval after which an update is always forwarded. Defaults to one third of <code>CLASSAD_LIFETIME</code>.\n</li></ul>\n\n<p></p><hr/>\n<em>2016-Apr-29 13:54:21 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good assuming changes to Version String in commit <span class=\"chng\"><a href=\"chngview?cn=47581\">[47581]</a></span> have been subsequently modified.\n\n</p><p>Switching over to docpending so new knobs can be documented.\n\n</p><p></p><hr/>\n<em>2016-May-02 14:08:40 by tim:</em> <br/>\n\nMoving this ticket to 8.5.5 to complete the documentation.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5913\" onclick=\"get_ticket_and_populate_wrapper('5913'); return false;\" title=\"Consider ClaimId in collector forward filter\">#5913</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nConsider <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClaimId\" title=\"Claim Id\">ClaimId</a></span> in collector forward filter</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-04 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48359\">[48359]</a></span>: Docs for collector forward filtering config params <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5506\" onclick=\"get_ticket_and_populate_wrapper('5506'); return false;\" title=\"More efficient updates of parent collector in a collector tree\">#5506</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-11 10:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47709\">[47709]</a></span>: Remove debugging code for collector forward filtering. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5506\" onclick=\"get_ticket_and_populate_wrapper('5506'); return false;\" title=\"More efficient updates of parent collector in a collector tree\">#5506</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-11 10:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47708\">[47708]</a></span>: Fix up names for collector forward filtering. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5506\" onclick=\"get_ticket_and_populate_wrapper('5506'); return false;\" title=\"More efficient updates of parent collector in a collector tree\">#5506</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-11 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47598\">[47598]</a></span>: Collector forwarding filter now applied to submitter ads. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5506\" onclick=\"get_ticket_and_populate_wrapper('5506'); return false;\" title=\"More efficient updates of parent collector in a collector tree\">#5506</a></span> Using a single watch list for both ad types. This should be fine, since a missing attribute is treated as unchanging.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-09 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47581\">[47581]</a></span>: Edit version string for special CMS release. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5506\" onclick=\"get_ticket_and_populate_wrapper('5506'); return false;\" title=\"More efficient updates of parent collector in a collector tree\">#5506</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-09 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47580\">[47580]</a></span>: Initial pass at FORWARD_WATCH_LIST and FORWARD_INTERVAL. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5506\" onclick=\"get_ticket_and_populate_wrapper('5506'); return false;\" title=\"More efficient updates of parent collector in a collector tree\">#5506</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-May-04 14:54", "status": "resolved", "created": "2016-Feb-09 16:21", "fixed_version": "2016-Feb-09 16:21", "broken_version": "v080308", "priority": "1", "subsystem": "DaemonsCM", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "jfrey@cs.wisc.edu, tannenba@cs.wisc.edu, bbockelm@cse.unl.edu", "due_date": ""}