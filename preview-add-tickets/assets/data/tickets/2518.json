{"id": 2518, "title": "Ticket #2518: Child processes are inheriting log files on Windows", "description": "<blockquote>\nWhen a file is opened through C runtime functions like open, its inheritance flag is set to true by default.  As such, on Windows when a daemon calls Create_Process, if the inherit flag for the Windows <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreateProcess\" title=\"Create Process\">CreateProcess</a></span> function is also set to true, the child process will inherit any open files.  On Linux Condor will go and close all open files as part of the fork/exec process.  On Windows this code was commented out with the intention of developing a proper fix that never materialized.  As such, with the new ability to keep logs open between writes, the child processes suddenly have handles to their parent's. log file.  When Condor attempts to rotate the log, it fails because it cannot rename a file that is held open by another process.  There are effectively two problems right now on Windows.\n<ul>\n<li>Files are being inherited by child processes by default.\n</li><li>Log files are being inherited because they are kept open by default.\n</li></ul>\n\n<p>This ticket is to address the second issue.\n\n</p><p>Solution:\n\n</p><p></p><ol>\n<li>Have the safefile library support the _O_NOINHERIT flag for open and the N option for fopen.  These will allow opening a file and set the inherit option to false. - Done, needs testing.\n</li><li>Change the calls to safe_fopen in dprintf to include the N option.  This option will be ignored on Linux but will pass down the correct flags within the safefile library. - Done, needs testing.\n</li></ol>\n\n<p>Future Work: Figure out how to keep Condor processes from inheriting files in general on Windows.  One solution may be to always pass in the N option for safe_fopen and use _O_NOINHERIT for safe_open.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-07 12:50:37 by ziliang:</em> <br/>\n\nFix for this resulted in problems when 'c' was passed into safe_fopen.  Jim has spun another version of safefile to address the issue.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/473/inherit.patch\">inherit.patch</a>\n60974 bytes added by ziliang on 2011-Oct-04 17:24:11 UTC.\n<br/>\nPatch that updates safefile and changes dprintf callsites to use the N option for fopen.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-07 12:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27679\">[27679]</a></span>: Fix calls to safe_fopen using c option on Windows due to changes in safefile library. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2518\" onclick=\"get_ticket_and_populate_wrapper('2518'); return false;\" title=\"Child processes are inheriting log files on Windows\">#2518</a></span>  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-04 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27603\">[27603]</a></span>: Fix log inheritance issue on Windows. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2518\" onclick=\"get_ticket_and_populate_wrapper('2518'); return false;\" title=\"Child processes are inheriting log files on Windows\">#2518</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-04 15:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27601\">[27601]</a></span>: Fix log inheritance issue on Windows. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2518\" onclick=\"get_ticket_and_populate_wrapper('2518'); return false;\" title=\"Child processes are inheriting log files on Windows\">#2518</a></span>.  (By Ziliang Guo )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Oct-13 12:45", "status": "resolved", "created": "2011-Oct-01 18:54", "fixed_version": "2011-Oct-01 18:54", "broken_version": "v070700", "priority": "1", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "#2064", "creator": "ziliang", "rust": "", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu, tannenba@cs.wisc.edu, tstclair@redhat.com", "due_date": "20111003"}