{"id": 2567, "title": "Ticket #2567: Priority and preemption not working correctly", "description": "<blockquote>\nI'm reproing this on 7_6-branch head: 4eaaaaf2413d4ae0133e8b34a0c34aff646414ff\n\n<p>Repro with this config:\n</p><div class=\"code\">\n<pre class=\"code\">MAXJOBRETIREMENTTIME = 3600\nPREEMPT = True\nPREEMPTION_REQUIREMENTS = True\nRANK = 0\nNEGOTIATOR_CONSIDER_PREEMPTION = True\n\nCLAIM_WORKLIFE = 0\n\nNEGOTIATOR_INTERVAL = 30\nNEGOTIATOR_DEBUG = D_FULLDEBUG\n\nNUM_CPUS = 5\n</pre></div>\n\n\n<p>First set prio-factor for \"u1\"\n</p><div class=\"code\">\n<pre class=\"code\">[eje@rorschach grid]$ condor_userprio -setfactor u1@localdomain 10\nThe priority factor of u1@localdomain was set to 10.000000\n</pre></div>\n\n\n<p>Next submit five jobs (all slots) against \"u1\" (10 minute duration)\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 600\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"u1\"\nqueue 5\n</pre></div>\n\n\n<p>Wait for those five jobs to start running.  Now submit another job for user \"u2\" - this user should have better priority since its prio-factor is just 1.0\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 60\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"u2\"\nqueue 1\n</pre></div>\n\n\n<p>Let a few negotiator cycles pass.  We expect job for \"u2\" to preempt somebody from \"u1\" but it does not happen:\n</p><div class=\"code\">\n<pre class=\"code\">[eje@rorschach grid]$ condor_q\n\n\n-- Submitter: rorschach.localdomain : &lt;192.168.1.2:35245&gt; : rorschach.localdomain\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n   3.0   eje            10/20 16:31   0+00:03:09 R  0   0.0  sleep 600\n   3.1   eje            10/20 16:31   0+00:03:09 R  0   0.0  sleep 600\n   3.2   eje            10/20 16:31   0+00:03:09 R  0   0.0  sleep 600\n   3.3   eje            10/20 16:31   0+00:03:09 R  0   0.0  sleep 600\n   3.4   eje            10/20 16:31   0+00:03:09 R  0   0.0  sleep 600\n   4.0   eje            10/20 16:32   0+00:00:00 I  0   0.0  sleep 60\n\n6 jobs; 1 idle, 5 running, 0 held\n</pre></div>\n\n\n<p>Note priorities appear as we'd expect:\n</p><div class=\"code\">\n<pre class=\"code\">[eje@rorschach grid]$ condor_userprio -all -allusers\nLast Priority Update: 10/20 16:35\n                                    Effective   Real     Priority   Res   Total Usage       Usage            Last\nUser Name                           Priority  Priority    Factor    Used (wghted-hrs)    Start Time       Usage Time\n------------------------------      --------- -------- ------------ ----  ----------- ---------------- ----------------\nu2@localdomain                           0.50     0.50         1.00    0         0.03 10/20/2011 16:29 10/20/2011 16:32\neje@localdomain                          0.50     0.50         1.00    0         0.00 12/31/1969 17:00        ???\n&lt;none&gt;                                   0.51     0.51         1.00    5         0.46 10/20/2011 16:29 10/20/2011 16:35\nu1@localdomain                           5.11     0.51        10.00    5         0.43 10/20/2011 16:29 10/20/2011 16:35\n------------------------------      --------- -------- ------------ ----  ----------- ---------------- ----------------\nNumber of users: 3                                                     5         0.46 10/20/2011 16:29        ???\n</pre></div>\n\n\n<p>analyze says \"u2\" is not running because other jobs have better priority, which makes no sense:\n</p><div class=\"code\">\n<pre class=\"code\">[eje@rorschach grid]$ condor_q -bet 4.0\n\n\n-- Submitter: rorschach.localdomain : &lt;192.168.1.2:35245&gt; : rorschach.localdomain\n---\n004.000:  Run analysis summary.  Of 5 machines,\n      0 are rejected by your job's requirements\n      0 reject your job because of their own requirements\n      5 match but are serving users with a better priority in the pool\n      0 match but reject the job for unknown reasons\n      0 match but will not currently preempt their existing job\n      0 match but are currently offline\n      0 are available to run your job\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-21 10:44:59 by eje:</em> <br/>\n\nUgh, it's not broken, it wasn't preempting because I set \"PREEMPT = TRUE\" and the first five jobs were going into Claimed/Retiring, with max retirement time of 1 hour.\n\n<p>Works fine with\n</p><div class=\"verbatim\">\n<pre>MAXJOBRETIREMENTTIME = 0\nPREEMPT = False\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "defect", "last_change": "2011-Oct-21 10:45", "status": "abandoned", "created": "2011-Oct-20 18:38", "fixed_version": "2011-Oct-20 18:38", "broken_version": "", "priority": "1", "subsystem": "Daemons", "assigned_to": "", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, tannenba@cs.wisc.edu, tstclair@cs.wisc.edu, dan@hep.wisc.edu, matt@cs.wisc.edu", "due_date": ""}