{"id": 2608, "title": "Ticket #2608: Keep track of startd ads that disappear, aka absent ads", "description": "<blockquote>\nSimilar to how the collector can persistently store ads where offline=true, the idea is to allow the collector to remember ads for resources that simply disappear.  (aka ads that go absent)\n\n<p>Initial steps:\n\n</p><p></p><ol>\n<li>Admin can specify a classad constraint  in the config of the collector, eg <code>COLLECTOR_RECORD_AS_ABSENT</code>. if this knob is not present, then all behavior is as before.\n</li><li>If the collector is about to remove an ad from its hashtables because the lease on this ad has expired, then the above constraint is evaluated against this ad evaluates to True, then <code>Absent=True</code> is implicitly inserted into the ad and the collector records this ad to disk in the offline log.  This handles the case of marking a startd absent if it disappeared unexcused, aka if it disappeared without first invalidating its ad (e.g. the execute machine crashed).\n</li><li>Just like offline ads, when an update is received at the collector, the ad is no longer considered absent and the persistent absent ad is removed.\n</li><li>By default, the collector will append \"<code>&amp;&amp; (Absent = ! = True)</code>\" to the query constraint unless the constraint already references the <code>Absent</code> attribute (similar to how condor_submit inserts <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpSys\" title=\"Op Sys\">OpSys</a></span> unless specified).\n</li></ol>\n\n<p>After the above is done, the following future work could happen:\n</p><ol>\n<li>In addition to marking an ad as absent when the lease expires, the collector could persistently write a resource ad to disk the first time it sees it, aka on insertion (not on update). Then the persistent ad is only removed from disk upon an receipt of an invalidation. This could handle the scenario where the collector is dead at the time the resource ad lease expires.\n</li><li>Initially, only startd ads will be supported as absent ads. The reason is for this initial limitation is for the implementation we will leverage the collector code already present for offline ads, and that code only stores startd ads persistently. If the absent ad feature proves to be popular we can expand it to support other types of ads (master, schedd, etc) in the future.\n</li></ol>\n\n<p>For years, the BaTLab had a number of jobs that could never run clogging up our queues.  Some of these jobs couldn't run because of bad requirements; other because they were targeted at platforms that didn't exist (because we didn't have them or because of typos).  These jobs became a problem when, for unrelated reasons, it became a real problem for other users to have these pointless jobs in the queue.  We addressed the majority of the problem by implementing a Metronome-level whitelist of permissible platforms.  This had the benefit of allowing us to give the user a good error message at submission time, rather than an obsure one a week later, when their job timed out.\n\n</p><p>However, this solution has a few obvious problems, centering around the fact that we have to manually maintain the whitelist, which thus gets out of date easily.  Historically, checking to see if the target platform is in the pool at submission time hasn't been especially useful, because platforms drift in and out of our pool constantly -- we would reject submissions only to accept the same one a few minutes later.\n\n</p><p>We looked into a few solutions, but at heart they all involved polling the collector and acting as its memory, which none of us were really interested in doing.  When we heard about offline ads, we thought they were just the thing for us: a way for Condor to keep track of what \"should be\" in the pool for us.  They turned out not to work in that capacity; hence absent ads.  We will be using them as (a) a platform whitelist that's always up-to-date (to within however long we decide to keep ads) and (b) a data source for reporting platform availability to our users.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Nov-22 11:41:05 by jfrey:</em> <br/>\n\nThis code causes the build to break if HAVE_HIBERNATION isn't defined. The new code in CollectorEngine::cleanHashTable() that references CollectorDaemon::offline_plugin_ should include a check of HAVE_HIBERNATION.\n\n<p></p><hr/>\n<em>2011-Nov-22 14:22:49 by tannenba:</em> <br/>\n\nAddressed above comment re HAVE_HIBERNATION unhappiness via commit <span class=\"chng\"><a href=\"chngview?cn=28403\">[28403]</a></span>\n\n<p></p><hr/>\n<em>2012-Jan-11 06:56:43 by matt:</em> <br/>\n\nI can imagine some uses for this, but will you include the motivating use cases in the description?</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2690\" onclick=\"get_ticket_and_populate_wrapper('2690'); return false;\" title=\"Improve absent ads UI in condor_status,\">#2690</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove absent ads UI in condor_status,</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=2799\" onclick=\"get_ticket_and_populate_wrapper('2799'); return false;\" title=\"Regression tests for absent ads.\">#2799</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRegression tests for absent ads.</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-14 14:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32041\">[32041]</a></span>: Edit of documentation for absent <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>. Edits went into V7_8-branch to go with 7.8.1 release. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2690\" onclick=\"get_ticket_and_populate_wrapper('2690'); return false;\" title=\"Improve absent ads UI in condor_status,\">#2690</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2608\" onclick=\"get_ticket_and_populate_wrapper('2608'); return false;\" title=\"Keep track of startd ads that disappear, aka absent ads\">#2608</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-08 15:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=31952\">[31952]</a></span>: Document absent ads (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2608\" onclick=\"get_ticket_and_populate_wrapper('2608'); return false;\" title=\"Keep track of startd ads that disappear, aka absent ads\">#2608</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2690\" onclick=\"get_ticket_and_populate_wrapper('2690'); return false;\" title=\"Improve absent ads UI in condor_status,\">#2690</a></span>).  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-22 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28403\">[28403]</a></span>: Always build collector offline plugin regardless of HAVE_HIBERNATION. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2608\" onclick=\"get_ticket_and_populate_wrapper('2608'); return false;\" title=\"Keep track of startd ads that disappear, aka absent ads\">#2608</a></span> Previously the collector invoked offline plugin methods conditional on the HAVE_HIBERNATION compilation option. But now that this plugin is also used for ABSENT_REQUIREMENTS, invoke these methods unconditionally. Note that all\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-18 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28346\">[28346]</a></span>: Initial support for absent ads in the collector. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2608\" onclick=\"get_ticket_and_populate_wrapper('2608'); return false;\" title=\"Keep track of startd ads that disappear, aka absent ads\">#2608</a></span> Added knob ABSENT_REQUIREMENTS which, if defined, is evaluated whenever a startd ad in the collector would expire. If it evals to True, the ad is stored in the offline log just like offline ads. Queries sent to the collector are modified to not include\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-18 14:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28344\">[28344]</a></span>: Added method to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span> to remove white space. Refactored where used. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2608\" onclick=\"get_ticket_and_populate_wrapper('2608'); return false;\" title=\"Keep track of startd ads that disappear, aka absent ads\">#2608</a></span> ===VersionHistory:None===  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-18 14:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28345\">[28345]</a></span>: Refactored to remove cut-n-pasted code to store/remove ads in collector persistant store. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2608\" onclick=\"get_ticket_and_populate_wrapper('2608'); return false;\" title=\"Keep track of startd ads that disappear, aka absent ads\">#2608</a></span> ===VersionHistory:None===  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-May-08 15:46", "status": "resolved", "created": "2011-Nov-01 17:27", "fixed_version": "2011-Nov-01 17:27", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "matt@cs.wisc.edu", "due_date": "20111103"}