{"id": 683, "title": "Ticket #683: Job can be in neither job_queue.log nor history", "description": "<blockquote>\nWhen a job finishes, the schedd first removed it from the job_queue.log, then writes it into the history.  This creates a window during which condor_q and condor_history can report that the job doesn't exist at all.  (This has been erratically seen in the test suite.)  It also means that if the schedd crashes at exactly the wrong moment, the job disappears.\n\n<p>We can't just swap the order of operations, or we risk duplicate copies appearing in the history, or both condor_q and condor_history reporting the job.\n\n</p><p>The correct solution is to make the edit to both files atomic.  This might be an argument for moving both files over to SQLite, which I believe can guarantee an atomic commit for multi-file situations.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Feb-19 10:56:07 by matt:</em> <br/>\n\nA quick spin through <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DestroyProc\" title=\"Destroy Proc\">DestroyProc</a></span> suggests that we currently write to the history file (and other places) before the job_queue.log, which closes the hole for losing a job while allowing for duplicate writes to the history file.\n\n<p>When was the last time we saw a job disappear from the queue and not make it to the history file?\n\n</p><p></p><hr/>\n<em>2010-Apr-27 16:20:23 by psilord:</em> <br/>\n\nAlan, is this still a problem?\n<hr/>\n<em>2010-Oct-20 15:59:08 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n<hr/>\n<em>2011-Jan-27 14:21:33 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n<hr/>\n<em>2011-Feb-01 14:49:30 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 21:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=15453\">[15453]</a></span>: Final phase one of test cruft where we run a new systems interface to catch more issues and sooner. Runcmd changes and adjustments for it. Includes work around for missing history file <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=683\" title=\"Job can be in neither job_queue.log nor history\">#683</a></span> and test cruft work <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=297\" title=\"Test Cruft Code Review\">#297</a></span>  (By Bill Taylor )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 16:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=15448\">[15448]</a></span>: Final phase one of test cruft where we run a new systems interface to catch more issues and sooner. Runcmd changes and adjustments for it. Includes work around for missing history file <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=683\" title=\"Job can be in neither job_queue.log nor history\">#683</a></span> and test cruft work <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=297\" title=\"Test Cruft Code Review\">#297</a></span>  (By Bill Taylor )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-17 06:03", "status": "new", "created": "2009-Aug-20 12:03", "fixed_version": "2009-Aug-20 12:03", "broken_version": "", "priority": "1", "subsystem": "Daemons", "assigned_to": "", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.wisc.edu", "due_date": ""}