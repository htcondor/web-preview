{"id": 4815, "title": "Ticket #4815: ace leak in Starter when USE_VISIBLE_DESKTOP is true", "description": "<blockquote>\nVia RUST, a customer reports:\n\n<p></p><ul>\nWe've been experiencing a problem where after \"some time\" we start seeing the message:\n</ul>\n\n<p></p><pre>         Create_Process: Unable to use visible desktop\n</pre>\n\n<p></p><ul>\nIn our StarterLog.slotN files. The process is created, but not on the \"visible desktop\". This causes the application that we are running to fail since it needs to be associated with the desktop. It turns out that it takes about 2300 condor_starter.exe invocations after a reboot for this to occur.\n\n<p>I've downloaded condor source, built it and added additional debugging output in order to track down the problem. I found the problem in condor_utils\\access_desktop.WINDOWS.cpp. The last function in the file is <code>RemoveTheAceDesktop(HDESK hdesk, PSID psid)</code> which includes a call to <code>AddAccessAllowedAce</code>. Well, this is the very Ace it is meaning to remove! The loop above the call copies all the other ACEs skipping the one added by <code>AddTheAceDesktop</code>; this call then adds it back in! It looks like a simple copy/paste error from <code>AddTheAceDesktop</code> since most of the code is nearly identical.\n\n</p><p>The simple fix is to remove the call to <code>AddAccessAllowedAce</code> from <code>RemoveTheAceDesktop</code>.\n\n</p><p>This seems to affect only condor_starter since that is the only call to <code>RevokeDesktopAccess</code> which is the only call to <code>RemoveTheAceDesktop</code>. This causes me a little concern since <code>GrantDesktopAccess</code> is called from the daemon_core code which is I think used by all daemons, but only if <code>USE_VISIBLE_DESKTOP</code> is set.</p></ul>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-27 10:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42412\">[42412]</a></span>: minor edit of 8.2.7 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4815\" title=\"ace leak in Starter when USE_VISIBLE_DESKTOP is true\">#4815</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-26 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42393\">[42393]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4815\" title=\"ace leak in Starter when USE_VISIBLE_DESKTOP is true\">#4815</a></span>, ACE leak when USE_VISIBLE_DESKTOP=true  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-14 17:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42220\">[42220]</a></span>: Fix ACE leak on Windows in Starter when USE_VISIBLE_DESKTOP is true <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4815\" title=\"ace leak in Starter when USE_VISIBLE_DESKTOP is true\">#4815</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoveTheAceDesktop\" title=\"Remove The Ace Desktop\">RemoveTheAceDesktop</a></span> had what appears to be a copy/paste error where it removed the access-allowed ace, but then fell through to code that added it back. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Feb-04 10:11", "status": "resolved", "created": "2015-Jan-08 14:07", "fixed_version": "2015-Jan-08 14:07", "broken_version": "", "priority": "2", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "a27773", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}