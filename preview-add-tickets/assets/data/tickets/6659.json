{"id": 6659, "title": "Ticket #6659: High Priority Jobs", "description": "<blockquote>\nIt would be very useful to be able to run, for instance, an interactive job <em>immediately</em>.  Obviously, we'd need some sort of throttling mechanism (we <em>are</em> a batch system, after all), but for use cases like backing Jupyter notebooks or for instructional purposes, one \"high priority\" job per user would be plenty and not overly disruptive.\n\n<p>This ticket requires a design doc.  Notes for it follow.\n\n</p><p></p><hr/>\n<ul>\n<li>At least initially, just pick a resource from those already assigned to the schedd; it's important for speed reasons to ignore the negotiator.\n</li><li>We'll probably  want a configuration knob (a rank expression) for determining which job to preempt.\n</li><li>The schedd should probably check to see if there's a match record it hasn't activated yet and use that if it can't (perhaps even before bothering with the rank expression).\n</li><li>We'll want a configuration knob to determine which jobs are eligible to be high-priority (e.g., interactive = true) and maybe an attribute in the job ad indicating that such a priority was requested.\n</li><li>What do we do in the pathological case where we have more users than slots?  Reject a high-priority submit because it can't be satisfied immediately?  That sounds weird but may be right and is almost certainly easier than sorting those jobs to the top of the list for the negotiator.  (I guess we'd want to note in the job ad which job was taking up the owner's quota, though.)\n</li><li>As mentioned, we'll want a throttle.  One per user is a good start, but we may also have to do a frequency throttle (if for some reason the schedd doesn't use the resource your previous high-priority job just abandoned for your next high-priority job).\n</li></ul>\n\n<p></p><hr/>\nTJ, ToddT, and ToddM discussed this and have agreed on the following approach.\n\n<p>Our first step is a mechanism (and tool to activate it) which vacates a given job and runs some other given job on the vacated slot.  The invoker must be either a queue super-user or the owner of both jobs; in either case, we feel that an explicit request of this nature makes it OK to break promises about retirement and vacation time.\n\n</p><p>This should alleviate some of the pain for the RCF's specific use-case, because they are or can become queue super-users.  (The user would submit an interactive job as themselves, and then the RCF forces it to run immediately.)\n\n</p><p>At some point, possibly in a different ticket, we would like:\n\n</p><p></p><ul>\n<li>to be able to specify multiple victims (on the same startd) whose slots coalesce.  There is a startd command to vacate a set of claims and return a new claim ID which corresponds to the coalescensce we can use as the basis.  (Would we (need to) construct a new match record?  Where in the schedd would we hang the knowledge about which job should run on the new match while the command was in nonblocking flight?)  We may need to modify the startd to accept claims rather than preempting claims.\n</li><li>to be able to specify a resource constraint instead of a job ID.\n</li><li>for the schedd to have a policy engine for choosing which job(s) to vacate for the run-immediately job.\n</li><li>add a 'run-immediately' mode to condor_submit, where it would proceed as normal up to the point where it would normally issue the reschedule command, and instead issue the reassign command.  (This could initially be submit-job-and-reassign-this-slot, and upgrade to submit-job-and-pick-a-slot when that's ready.)\n</li></ul>\n\n<p></p><hr/>\nWe're considering testing just the mechanism documented below (under a different name), so further progress on this subject will be in child tickets.</blockquote>", "remarks": "<blockquote>\n<em>2018-May-03 11:57:35 by tlmiller:</em> <br/>\n\nWork for the initial test is well under way; after fixing some existing bugs (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6663\" onclick=\"get_ticket_and_populate_wrapper('6663'); return false;\" title=\"condor_vacate_job -fast leaves starters stuck in Preempting/Vacating\">#6663</a></span>), initial results for a user reassigning a slot between two of that user's jobs are promising.  The next step is test what happens when a queue super user reassigns a slot between jobs of different ownership.\n\n<p>Actually, before that, I need to clean up the experimental code on the client side.\n\n</p><p></p><hr/>\n<em>2018-May-30 14:38:11 by tlmiller:</em> <br/>\n\n<strong>condor_reassign_slot</strong> as currently implemented works as follows:\n\n<p></p><ol>\n<li>It sends a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> command, REASSIGN_SLOT, to the schedd, specifying victim and beneficiary jobs as a pair of attributes (cluster ID and process ID).\n</li><li>The schedd verifies that the authenticated user owns both jobs (the queue super-user owns all jobs).\n</li><li>(Probably optional.)  The schedd verifies that both jobs are vanilla-universe jobs.\n</li><li>The schedd verifies that the beneficiary is idle and the victim is running.\n</li><li>The schedd marks the victim's match record with the beneficiary's job ID.\n</li><li>The schedd calls <code>&amp;#8203;enqueueActOnJobMyself(..., JA_VACATE_FAST_JOBS, ...)</code>, which (asynchronously, after rate-limiting) sends a SIGQUIT to the shadow.  The shadow exits without attempting reuse.\n</li><li>When the shadow exits, <code>Scheduler::child_exit()</code> calls <code>Scheduler::StartJob()</code>, passing it the match record corresponding to the shadow which just exited.\n</li><li>In <code>Scheduler::startJob()</code>, if the match record has been marked with a job ID, the schedd will try to start that job ID on the match record.  If that job is not runnable (or no longer matches the slot), the schedd will call <code>FindRunnableJobForClaim()</code> as normal.  (We skip the match record's existing job ID if the match record has been marked, which may be the wrong thing to do.)\n</li></ol>\n\n<p></p><hr/>\n<em>2018-Jun-13 13:36:59 by tlmiller:</em> <br/>\n\nNeed to add a release note and write the man page before release.\n\n<p></p><hr/>\n<em>2018-Jun-14 16:04:08 by tlmiller:</em> <br/>\n\nCould use a doc review.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6694\" onclick=\"get_ticket_and_populate_wrapper('6694'); return false;\" title=\"Extend condor_reassign_slot to accept multiple victims\">#6694</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nExtend condor_reassign_slot to accept multiple victims</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55065\">[55065]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Add condor_now man page. Fix up its release note and usage. Unbreak dependencies for ref.pdf in the Makefile.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 14:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55064\">[55064]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6664\" onclick=\"get_ticket_and_populate_wrapper('6664'); return false;\" title=\"condor_drain -start ... broken?\">#6664</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6697\" onclick=\"get_ticket_and_populate_wrapper('6697'); return false;\" title=\"coordinated retirement while draining breaks HOLD_IF_MEMORY_EXCEEDED\">#6697</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6701\" onclick=\"get_ticket_and_populate_wrapper('6701'); return false;\" title=\"condor_off -peaceful disrespects max job length\">#6701</a></span>) Release notes.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 14:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55063\">[55063]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Release note. (Needs man page.)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 10:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55053\">[55053]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Build fix for Visual Studio.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-13 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55051\">[55051]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Forgot to tell RPM about the new tool's binary.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-13 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55049\">[55049]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Add -debug option.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-13 13:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55048\">[55048]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Fix bug which would make match records changed by REASSIGN_SLOT unfindable. Update condor_now usage to better-reflect reality.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-13 11:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55047\">[55047]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Rename to condor_now for release. Reorder arguments because of the obviously proper extension for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6694\" onclick=\"get_ticket_and_populate_wrapper('6694'); return false;\" title=\"Extend condor_reassign_slot to accept multiple victims\">#6694</a></span>.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-12 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55046\">[55046]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Fix stupid build issue.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-03 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54833\">[54833]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Implement DCSchedd::ReassignSlot(); undo hack in condor_daemon_client/daemon.h. Remove error-checking-free code from reassign_slot tool.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-03 11:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54829\">[54829]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6659\" onclick=\"get_ticket_and_populate_wrapper('6659'); return false;\" title=\"High Priority Jobs\">#6659</a></span>) Experimental work. Add a daemon command to the schedd (and a tool to invoke it) which given two job IDs, vacates the first and starts the second in its place.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Jun-15 15:34", "status": "resolved", "created": "2018-Apr-24 11:49", "fixed_version": "2018-Apr-24 11:49", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}