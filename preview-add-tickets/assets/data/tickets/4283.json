{"id": 4283, "title": "Ticket #4283: Improve synchronization of the job log.", "description": "<blockquote>\nFor updates, there's no reason to use fsync (which sync's data and metadata) on the job_queue.log; only fdatasync (which only sync's data) is really needed.\n\n<p>The metadata probably only needs to be synchronized on rotation...\n\n</p><p>...speaking of which, our current code for job_queue.log rotation is not safe.  We use rename() to rotate the file; there's no guarantee which copy of the data is in which file after a crash.  To make sure the rename persists, we need to call fsync on the directory to make sure the directory metadata is on disk.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Apr-01 08:40:57 by bbockelm:</em> <br/>\n\nI have an implementation of this prepared in branch V8_1-gt4283 - just trying to get the conditional compilation magic happy across all platforms, including those without fdatasync.\n\n<p>Investigation with 'strace' indicates that, with the patch, we are doing the rename according to POSIX and have replaced fsync with fdatasync for classad log updates.\n\n</p><p>Additionally, I updated the <span class=\"wiki\"><a href=\"wiki?p=LinuxTuning\" title=\"Linux Tuning\">LinuxTuning</a></span> page to reflect the knowledge about fsync and ext{3,4} mount options.\n\n</p><p></p><hr/>\n<em>2014-Jul-08 13:37:53 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Nice patch!!  Some things to change:\n\n</p><p></p><ol>\n<li>When fsync of the parent directory meta-data on rename() fails, the code should EXCEPT, just like it excepts if it fails to sync the contents of the file.\n</li><li>Should not need to explicitly include unistd.h in files that already include condor_common.h - condor_common.h already includes system header files\n</li><li>Should use CMAKE to test for and flag the existence of fdatasync() instead of relying on unistd posix flags, just for consistency\n</li><li>Should add a version history blurb (no need for additional documentation beyond that)\n</li></ol>\n\n<p>Once the above are fixed, please merge into master, as the parts using fdatasync are really just a scalability improvement.  While it is true the parts to sync the directory meta-data on rename is a bug fix, it is a rare enough race condition that I am good with it going just into master.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 17:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40654\">[40654]</a></span>: Win32 does not support notion of opening a parent dir for fsync. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-10 09:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40593\">[40593]</a></span>: edit 8.3.0 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-10 09:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40590\">[40590]</a></span>: Look in headers, not libc, for fdatasync. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span> Mac OS X is a curious platform. Its libc provides fdatasync as a symbol we can link against, but the headers we use don't actually define fdatasync. Hence, the build is failing because the CMake test succeeds though condor_fsync.cpp doesn't compile.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-10 06:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40587\">[40587]</a></span>: Add in fake condor_fdatasync for libcondorapi. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-09 20:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40586\">[40586]</a></span>: Fixes and improvements from code review. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-09 20:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40585\">[40585]</a></span>: Improve handling of durability of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> logs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span> This switches fsync to fdatasync where possible. Also, ensure we fsync the parent directory after performing rename().  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-30 11:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39768\">[39768]</a></span>: Do not look for unistd on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-29 21:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39767\">[39767]</a></span>: Look for fdatasync's POSIX define. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-29 21:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39765\">[39765]</a></span>: Improve handling of durability of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> logs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span> This switches fsync to fdatasync where possible. Also, ensure we fsync the parent directory after performing rename().  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Jul-15 10:23", "status": "resolved", "created": "2014-Mar-28 09:10", "fixed_version": "2014-Mar-28 09:10", "broken_version": "", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}