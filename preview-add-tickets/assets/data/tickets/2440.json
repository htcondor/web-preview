{"id": 2440, "title": "Ticket #2440: HGQ improperly handling partitionable slots", "description": "<blockquote>\nThe HGQ quota assignment does not properly account for partitionable slots with multiple cpus.  When accept-surplus is disabled, it will result in slot starvation, as the quota will count a partitionable slot once instead of how many cpus it has available.\n\n<p>From Jon Thomas:\n</p><div class=\"verbatim\">\n<pre>GROUP_NAMES = a, b\nGROUP_QUOTA_DYNAMIC_a = 0.5\nGROUP_QUOTA_DYNAMIC_b = 0.5\n\nSimple case:\n\nNUM_CPUS = 4\nSLOT_TYPE_1 = cpus=2\nSLOT_TYPE_1_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_1 = 2\n\nSubmit jobs to a. Users in will not use more than one slot.\n\nSeems to hit in other configs too:\n\nNUM_CPUS = 20\nSLOT_TYPE_1 = cpus=2\nSLOT_TYPE_1_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_1 = 10\n\nWill only use 9 slots\n\nNUM_CPUS = 20\nSLOT_TYPE_1 = cpus=4\nSLOT_TYPE_1_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_1 = 5\n\nWill only use 4 slots.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-03 13:44:34 by eje:</em> <br/>\n\nrepro/test:\n\n<p>Using the following configuration, with both regular and partitionable slots:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nSCHEDD_INTERVAL\t= 15\nNEGOTIATOR_USE_SLOT_WEIGHTS = FALSE\nGROUP_QUOTA_MAX_ALLOCATION_ROUNDS = 1\n\nGROUP_NAMES = a, b\nGROUP_QUOTA_DYNAMIC_a = 0.5\nGROUP_QUOTA_DYNAMIC_b = 0.5\nGROUP_ACCEPT_SURPLUS = FALSE\n\nNUM_CPUS = 22\nSLOT_TYPE_1 = cpus=4\nSLOT_TYPE_1_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_1 = 5\n\nSLOT_TYPE_2 = cpus=1\nSLOT_TYPE_2_PARTITIONABLE = FALSE\nNUM_SLOTS_TYPE_2 = 2\n</pre></div>\n\n\n<p>The unused slot profile should look like this:\n</p><div class=\"code\">\n<pre class=\"code\">$ svhist Machine _SlotType_ State Activity Cpus\n      5 rorschach.localdomain | P | Unclaimed | Idle | 4\n      2 rorschach.localdomain | X | Unclaimed | Idle | 1\n      7 total\n</pre></div>\n\n\n<p>submit 12 jobs to group \"a\".  The group should be allowed to run 11 jobs:\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 1800\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.user\"\nqueue 12\n</pre></div>\n\n\n<p>Submit the above jsub file, and let several negotiator cycles pass. Before fix: the slots provided by partitionable slots are not properly accounted for, and slots are starved.  \"a\" is only allowed to run 6 jobs, instead of its quota of 11:\n</p><div class=\"code\">\n<pre class=\"code\">$ qvhist AccountingGroup JobStatus\n      6 a.user | 1\n      6 a.user | 2\n     12 total\n</pre></div>\n\n\n<p>After the fix, group \"a\" quota is filled, and 11 jobs are allowed to run:\n</p><div class=\"code\">\n<pre class=\"code\">$ qvhist AccountingGroup JobStatus\n      1 a.user | 1\n     11 a.user | 2\n     12 total\n</pre></div>\n\n\n<p></p><hr/>\nHere is an additional test variation for the fixed version that exercises the code path for GROUP_DYNAMIC_MACH_CONSTRAINT / NEGOTIATOR_SLOT_POOLSIZE_CONSTRAINT\n\n<p>This configuration adds 42 slots, which will be ignored by the HGQ algorithms and by the job submission:\n</p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nSCHEDD_INTERVAL\t= 15\nNEGOTIATOR_USE_SLOT_WEIGHTS = FALSE\nGROUP_QUOTA_MAX_ALLOCATION_ROUNDS = 1\n\nGROUP_NAMES = a, b\nGROUP_QUOTA_DYNAMIC_a = 0.5\nGROUP_QUOTA_DYNAMIC_b = 0.5\nGROUP_ACCEPT_SURPLUS = FALSE\n\nNUM_CPUS = 22+42\n\nSLOT_TYPE_1 = cpus=4\nSLOT_TYPE_1_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_1 = 5\n\nSLOT_TYPE_2 = cpus=1\nSLOT_TYPE_2_PARTITIONABLE = FALSE\nNUM_SLOTS_TYPE_2 = 2\n\n# I intend this slot's quota to be ignored by\n# GROUP_DYNAMIC_MACH_CONSTRAINT / NEGOTIATOR_SLOT_POOLSIZE_CONSTRAINT\nSLOT_TYPE_3 = cpus=42\nSLOT_TYPE_3_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_3 = 1\n\n# ignore slots of type 3 for quota counting\nGROUP_DYNAMIC_MACH_CONSTRAINT = (Cpus &lt; 42)\n</pre></div>\n\n\n<p>This version of the job also ignores the 42-cpu slot, so it does not get partitioned:\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 1800\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\nrequirements = (Cpus &lt; 42)\n+AccountingGroup=\"a.user\"\nqueue 12\n</pre></div>\n\n\n<p>Because the 42-cpu slot is ignored both by the HGQ algorithms and the job, we should see that group \"a\" is still allowed to run 11 jobs, as before:\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_submit t.jsub\nSubmitting job(s)............\n12 job(s) submitted to cluster 1.\n\n$ qvhist AccountingGroup JobStatus\n      1 a.user | 1\n     11 a.user | 2\n     12 total\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Sep-23 17:38:26 by danb:</em> <br/>\n\nCode review:\n\n<p>This patch conflicts quite a bit with a patch TJ recently committed on the master branch: <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2277\" title=\"generalize GROUP_DYNAMIC_MACH_CONSTRAINT\">#2277</a></span>.  You might have beaten him to the punch if I hadn't taken so long to review.  Sorry!\n\n</p><p>The basic idea looks okay to me, though one wonders if it would be better to just simplify the negotiator by always using slot weights.\n\n</p><p>--Dan\n\n</p><p></p><hr/>\n<em>2011-Sep-23 18:10:04 by eje:</em> <br/>\n\nFor this particular situation, I don't think slot weights would work quite the right way, since in the case of partitionable slots you want a job to be able to peel off a single slot, and not worry about paying for a weight tagged to # of cpus.\n\n<p>I think we want partitionable slots to be \"weighted\" on the resource side (summing up available resources for allocation) but <strong>not</strong> on the consumption side (paying for weight when negotiating).\n\n</p><p>(I expected this might be a race condition with <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2277\" title=\"generalize GROUP_DYNAMIC_MACH_CONSTRAINT\">#2277</a></span>, regardless)</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/451/gt2440-part-slot-usage.patch\">gt2440-part-slot-usage.patch</a>\n5098 bytes added by eje on 2011-Sep-03 15:55:55 UTC.\n<br/>\nPatch to allow HGQ quota assignment to correctly account for the effective number of slots provided by partitionable slots.  This patch is against V7_6-branch, will probably require manual merge against master.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-04 10:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27607\">[27607]</a></span>: Improve version history item, which required adding index entries. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2440\" title=\"HGQ improperly handling partitionable slots\">#2440</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 17:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27459\">[27459]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=27447\">[27447]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=27448\">[27448]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=27458\">[27458]</a></span>, Merge V7_7_2-branch to master ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2440\" title=\"HGQ improperly handling partitionable slots\">#2440</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 16:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27458\">[27458]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=27456\">[27456]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=27457\">[27457]</a></span>, Merge branch V7_6-branch into V7_7_2-branch ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2440\" title=\"HGQ improperly handling partitionable slots\">#2440</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 16:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27457\">[27457]</a></span>: ===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2440\" title=\"HGQ improperly handling partitionable slots\">#2440</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27456\">[27456]</a></span>: Fix group quota assignment to correctly account for the effective number of slots provided by partitionable slots ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2440\" title=\"HGQ improperly handling partitionable slots\">#2440</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Dec-07 15:56", "status": "resolved", "created": "2011-Sep-02 18:07", "fixed_version": "2011-Sep-02 18:07", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, jthomas@redhat.com, dan@hep.wisc.edu, eje@cs.wisc.edu", "due_date": ""}