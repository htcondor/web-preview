{"id": 3422, "title": "Ticket #3422: Fix locking code", "description": "<blockquote>\nLocking code appears to not work under heavy load.  Either rip it out and replace with something from condor_utils or fix the error handling.</blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-09 19:03:20 by bbockelm:</em> <br/>\n\nThere are actually some deeper issues here -\n\n<p>Properly done, we should use retries with exponential backoff.  There's no guarantee the sysadmin isn't also invoking iptables.  Alternately, the process with the lock may have gone to sleep indefinitely due to some unknown bug.\n\n</p><p><strong>Probably</strong> what we should do is some sort of opportunistic locking approach - try doing a lock.  After 1s, switch to the exponential backoff algorithm.\n\n</p><p>It's going to be fairly miserable to have a well-designed interface for the admin setup/cleanup scripts.  Probably no sysadmin is ready for this sort of behavior - no one does concurrent iptables I suspect, so no one is ready for things to fail due to this reason.\n\n</p><p></p><hr/>\n<em>2013-Jan-09 19:46:23 by bbockelm:</em> <br/>\n\nThe locking code seems to have been mostly a matter of a wrong locking flag (FD_SETLK versus FD_SETLKW).\n\n<p>Once that's fixed, the next problem is the firewall cleanup code.  Since the iptables rules for bridge mode are pretty trivial, that may not be such a big issue for the demo.  Definitely an issue for the NAT code.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-09 19:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46447\">[46447]</a></span>: Use correct flag for locks; handle EINTR case. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3422\" title=\"Fix locking code\">#3422</a></span>.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "todo", "last_change": "2014-Aug-07 12:04", "status": "resolved", "created": "2013-Jan-09 10:49", "fixed_version": "2013-Jan-09 10:49", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "bbockelm", "derived_from": "#3421", "creator": "bbockelm", "rust": "", "customer_group": "lark", "visibility": "public", "notify": "", "due_date": ""}