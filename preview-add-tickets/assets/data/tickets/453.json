{"id": 453, "title": "Ticket #453: Short-term fix for Condor-C ignoring job lease renewal of running jobs", "description": "<blockquote>\nWe need an immediate short term fix for the problem described in <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=452\" onclick=\"get_ticket_and_populate_wrapper('452'); return false;\" title=\"remote job in grid universe can be killed even after lease renewed\">#452</a></span>.\n\n<p>The plan is when the shadow connects to the schedd to push updates received from the starter into the persistent queue, it should also read a fresh copy of the job classad in order to renew its cached copy.  It is important the the shadow does this <em>after</em> it pushes its updates (so the starter updates are not lost), and that is happens on the same schedd connection (for performance reasons).\n\n</p><p>A patch to the vanilla shadow to implement the above will be attached to this ticket, and a version of the schedd that the <span class=\"quote\">BatLab</span> can test with will be made available asap.  However, this patch should not be shipped as part of a release, and therefore should not be pushed into the source code repository.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-May-05 14:08:32 by zmiller:</em> <br/>\n\npatch attached, but has minor differences:\n\n<p>1) there is a config knob, ALWAYS_UPDATE_JOB_AD_ON_PERIODIC_EVALUATION, which must be set to true to enable this feature.\n\n</p><p>2) on EVERY periodic timer it updates to the schedd and then pulls the new ad.  this is less efficient but more correct.\n\n</p><p></p><hr/>\n<em>2009-May-26 13:18:14 by tannenba:</em> <br/>\n\nThe patches, as they now stand, are broken because onexit expressions now results in a shadow exception.  The problem is job termination attributes, like <span class=\"quote\">JobExit</span> (exit code), are being wiped out when the patch fetches the job ad from the schedd.\n\n<p>The proposed fix would be for the shadow to do a 3-way classad merge (previously seen shadow ad, current shadow ad, schedd ad) in the patch instead of just replacing the internal shadow ad w/ what we get from the schedd.\n\n</p><p></p><hr/>\n<em>2009-Oct-28 16:55:23 by jfrey:</em> <br/>\n\nI removed the old hack with ALWAYS_UPDATE_JOB_AD_ON_PERIODIC_EVALUATION and added code to <span class=\"quote\">QmgrJobUpdater</span> to pull attributes from the schedd when it connects, as originally described in this ticket.\n\n<p>Some further improvements could be made to this code:\n</p><ul>\n<li>Adjust periodic update interval based on when the job lease from the submitter is set to expire.\n</li><li>Scan the job policy expressions for other attributes that should be updated from the schedd.\n</li></ul>\n\n<p>Note: these patches will appear in v7.4.1\n\n</p><p></p><hr/>\n<em>2009-Nov-25 16:08:44 by bgietzel:</em> <br/>\n\ncheckin <span class=\"chng\"><a href=\"chngview?cn=16199\">[16199]</a></span> did not make it into Condor 7.4.0.  Using a large job lease duration and disabling the previous patch is a workaround.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">ALWAYS_UPDATE_JOB_AD_ON_PERIODIC_EVALUATION = FALSE\nJOB_LEASE_DURATION = 5000000\nSUBMIT_EXPRS = JOB_LEASE_DURATION\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/54/nmi-condor-c.patch\">nmi-condor-c.patch</a>\n1738 bytes added by zmiller on 2009-May-05 19:16:34 UTC.\n<br/>\ncommit 41446ef\npush 9942a08..41446ef  master -&gt; master\n<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-28 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16199\">[16199]</a></span>: Remove ALWAYS_UPDATE_JOB_AD_ON_PERIODIC_EVALUATION hack. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=453\" onclick=\"get_ticket_and_populate_wrapper('453'); return false;\" title=\"Short-term fix for Condor-C ignoring job lease renewal of running jobs\">#453</a></span> This hack never worked right, and now we have a better solution.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-28 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16198\">[16198]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=QmgrJobUpdater\" title=\"Qmgr Job Updater\">QmgrJobUpdater</a></span> can now pull updated attributes from the schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=453\" onclick=\"get_ticket_and_populate_wrapper('453'); return false;\" title=\"Short-term fix for Condor-C ignoring job lease renewal of running jobs\">#453</a></span> Whenever <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=QmgrJobUpdater\" title=\"Qmgr Job Updater\">QmgrJobUpdater</a></span> connects to the schedd, it will check for updates of certain attributes in the schedd's ad and propogate them into the local job ad. For now, the only attribute that's checked is <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-19 14:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=14712\">[14712]</a></span>: cherry-picked <span class=\"chng\"><a href=\"chngview?cn=14637\">[14637]</a></span> and <span class=\"chng\"><a href=\"chngview?cn=14638\">[14638]</a></span> from master into V7_3_1-branch. <span class=\"chng\"><a href=\"chngview?cn=14637\">[14637]</a></span>: added a quick hack for NMI's use of condor-c which always fetches a fresh copy of the job ad from the schedd before evaluating periodic expressions. <span class=\"chng\"><a href=\"chngview?cn=14638\">[14638]</a></span>: Fix the quick hack for NMI's use of Condor-C gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=453\" onclick=\"get_ticket_and_populate_wrapper('453'); return false;\" title=\"Short-term fix for Condor-C ignoring job lease renewal of running jobs\">#453</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-05 15:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=14638\">[14638]</a></span>: Fix the quick hack for NMI's use of Condor-C gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=453\" onclick=\"get_ticket_and_populate_wrapper('453'); return false;\" title=\"Short-term fix for Condor-C ignoring job lease renewal of running jobs\">#453</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-05 14:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=14637\">[14637]</a></span>: added a quick hack for NMI's use of condor-c which always fetches a fresh copy of the job ad from the schedd before evaluating periodic expressions.  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-17 13:39", "status": "resolved", "created": "2009-May-05 13:48", "fixed_version": "2009-May-05 13:48", "broken_version": "v070300", "priority": "2", "subsystem": "Grid", "assigned_to": "zmiller", "derived_from": "#452", "creator": "tannenba", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "bgietzel@cs.wisc.edu", "due_date": ""}