{"id": 6698, "title": "Ticket #6698: Provide the ability to identify black hole slots", "description": "<blockquote>\nThe GlideinWMS folks would like to have a way to identify when a slot is a black hole, i.e. some X number of jobs fail over a short Y minute time-span. Currently, the only way to do this is to to write a STARTD_CRON that polls the <code>RecentNumJobStarts</code> and if it's too high, set the START expression to False.\n\n<p>The slot should be marked as a black hole if jobs are starting/finishing too quickly\n\n</p><p>We will identify jobs that 'finish too quickly' by publishing statistics about the average/min/max lifetime of the starter that can be used to influence the START expression.\n\n</p><p>So the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=IsBlackHole\" title=\"Is Black Hole\">IsBlackHole</a></span> sub-expression of the START expression could be\n\n</p><p></p><pre>    IsBlackHole = IfThenElse(JobBusyTimeAvg is undefined, false, JobBusyTimeAvg &lt; $(EXPECTED_JOB_MINIMUM_RUNTIME))</pre>\n</blockquote>", "remarks": "<blockquote>\nI propose adding a new stat that will keep track of the average time that a job is on the slot. That is (execution time + transfer time) which corresponds to the time that the slot claimed/busy\n\n<p>This new stat will publish total,min,max,average and std-deviation of claimed/busy time for all slots.  These stats will be undefined until the first time a slot leaves the busy state.\n\n</p><p>So your black hole expression could be\n\n</p><p></p><pre>    IsBlackHole = IfThenElse(AvgJobBusyTime is undefined, false, AvgJobBusyTime &lt; $(EXPECTED_JOB_MINIMUM_RUNTIME))\n</pre>\n\n<p></p><hr/>\n<em>2018-Jul-16 17:46:39 by marco:</em> <br/>\n\nLorena was mentioning about an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AvgJobBusyTime\" title=\"Avg Job Busy Time\">AvgJobBusyTime</a></span> over 20 min updated every 5min. If things go bad, jobs may fail in a few seconds, so 20 min would eat out &gt; 100 jobs.\nOn the other side, some jobs may last hours, so frequent updates of the value may use CPU for nothing. Updating on an event base (job completion) or letting the update frequency be a variable (we could have it in the config at condor startup - depending on the expected length of jobs) would be better.\n\n<p>Other possibilities could be: an &amp;#65533;average execution time on a moving window&amp;#65533;. The avg execution time of the last N jobs, where N is configurable (better) or a fixed number, e.g. 10.\nThe moving window is good because if the 1st job runs OK and then something breaks, a general avg would not help in finding the black hole (skewed heavily by the first long job).\nIt could also be populated from the beginning (no preference about waiting the first N jobs or not), <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStarts\" title=\"Job Starts\">JobStarts</a></span> would tell us if we reached the min number of jobs.\n\n</p><p>Alternatively, an attribute like <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobRunTime\" title=\"Last Job Run Time\">LastJobRunTime</a></span>, the value of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalJobRunTime\" title=\"Total Job Run Time\">TotalJobRunTime</a></span> when a job ends, would be good. There is a mechanism that I don&amp;#65533;t remember now, that allows keeping the last N values of an attribute and we could use that to calculate the avg on the moving window.\n\n</p><p></p><hr/>\n<em>2018-Jul-17 08:44:16 by johnkn:</em> <br/>\n\nI'm thinking that the value is an average of job duration, and that it updates on job exit - and that there are 2 values.  a value for the life of the startd, and another one that is the average only of the jobs that have exited in the last 20 minutes.\n\n<p></p><hr/>\n<em>2018-Jul-17 11:27:28 by marco:</em> <br/>\n\nI like the fact that the value is updated after the end of each job (better than periodically because jobs may have big variability in duration).\nWhat happens if 20 minutes have not gone yet?\nWould be possible to consider the last 10 jobs instead of the last 20 minutes for the average?\n\n<p>The problem I see w/ 20mins is that if a job runs fine and then they start failing, we will not realize anything is wrong until the 20mins are gone (which may be many failed jobs).\n\n</p><p>I'm trying to understand the values to see if I can evaluate that.\nI see <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStarts\" title=\"Job Starts\">JobStarts</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentJobStarts\" title=\"Recent Job Starts\">RecentJobStarts</a></span> (last 20 min) as counters for the number of jobs that started.\nProbably those are what you use but I don&amp;#65533;t see a total running time in the machine attributes.\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalJobRunTime\" title=\"Total Job Run Time\">TotalJobRunTime</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalClaimRunTime\" title=\"Total Claim Run Time\">TotalClaimRunTime</a></span> for the total running times for a job and all jobs within a claim. Is it there a sum for all jobs that run under a startd (if 2 jobs ran at the same time in 2 partitionable slots, that time should count double)?\nIs <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalTimeClaimedBusy\" title=\"Total Time Claimed Busy\">TotalTimeClaimedBusy</a></span> something that similar to that?\n\n</p><p></p><hr/>\n<em>2018-Jul-24 11:22:00 by johnkn:</em> <br/>\n\nThe stats I am looking at don't appear in any permanent <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> right now.  There would be a stat for the min, max &amp; average lifetime of a Starter.  This is a decent approximation of the lifetime of a job + the transfer time.  I am also looking into having a stat for the average execution time of a job, but that's a bit more work right now.\n\n<p>If The average lifetime of a Starter drops below some threshold and the Glide-in stops accepting jobs, then that average will never change again, and the Glide-in will stop accepting jobs forever until it dies (which will be 20 minutes later I understand)\n\n</p><p>If the glide-in is working, and then stops working, then yes it will take a few jobs to go by for the average to drop down to the point where you detect the problem, but this is what you want - otherwise a single short job will have the potential to take down your whole pool - a single short job will only quickly kill off a startd that doesn't have a record of success.\n\n</p><p>This is why the 20 minute windowed average is not as useful as the overall lifetime average.\n\n</p><p></p><hr/>\n<em>2018-Jul-25 15:39:45 by johnkn:</em> <br/>\n\nThese two new probes will generate 16 attributes in each slot ad when enabled.  Because that's a lot, they will not be published by default.\n\n<p>You can enable them for publication by adding this\n\n</p><p></p><pre>     STARTD.STATISTICS_TO_PUBLISH_LIST = $(STATISTICS_TO_PUBLISH_LIST) JobDuration, JobBusyTime\n</pre>\n\n<p>To the configuration of your execute node.\n\n</p><p></p><hr/>\n<em>2018-Jul-25 15:51:49 by johnkn:</em> <br/>\n\nDue to the way the statistics probes work, the qualifier Avg will appear at the end of the attribute name, not at the beginning.  So for 2, 2 minute jobs, you would see something like this.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">JobBusyTimeAvg = 122.2497668266296\nJobBusyTimeCount = 2\nJobBusyTimeMax = 122.2925918102264\nJobBusyTimeMin = 122.2069418430328\nJobDurationAvg = 120.0414055\nJobDurationCount = 2\nJobDurationMax = 120.061154\nJobDurationMin = 120.021657\nRecentJobBusyTimeAvg = 122.2497668266296\nRecentJobBusyTimeCount = 2\nRecentJobBusyTimeMax = 122.2925918102264\nRecentJobBusyTimeMin = 122.2069418430328\nRecentJobDurationAvg = 120.0414055\nRecentJobDurationCount = 2\nRecentJobDurationMax = 120.061154\nRecentJobDurationMin = 120.021657\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-23 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55609\">[55609]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6581\" onclick=\"get_ticket_and_populate_wrapper('6581'); return false;\" title=\"condor_submit should not always read from stdin if no submit file\">#6581</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6752\" onclick=\"get_ticket_and_populate_wrapper('6752'); return false;\" title=\"ReadUserLog::readEvent() broken on Windows?\">#6752</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6784\" onclick=\"get_ticket_and_populate_wrapper('6784'); return false;\" title=\"there should be a knob to set the default for should_transfer_files\">#6784</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6698\" onclick=\"get_ticket_and_populate_wrapper('6698'); return false;\" title=\"Provide the ability to identify black hole slots\">#6698</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6737\" onclick=\"get_ticket_and_populate_wrapper('6737'); return false;\" title=\"Accounting and Defrag adtypes missing from python bindings\">#6737</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6723\" onclick=\"get_ticket_and_populate_wrapper('6723'); return false;\" title=\"Late Materialization jobs handle getenv=true incorrectly\">#6723</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6732\" onclick=\"get_ticket_and_populate_wrapper('6732'); return false;\" title=\"speed up the schedd check for a change in an autoclustered attribute\">#6732</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-23 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55610\">[55610]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6581\" onclick=\"get_ticket_and_populate_wrapper('6581'); return false;\" title=\"condor_submit should not always read from stdin if no submit file\">#6581</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6752\" onclick=\"get_ticket_and_populate_wrapper('6752'); return false;\" title=\"ReadUserLog::readEvent() broken on Windows?\">#6752</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6784\" onclick=\"get_ticket_and_populate_wrapper('6784'); return false;\" title=\"there should be a knob to set the default for should_transfer_files\">#6784</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6698\" onclick=\"get_ticket_and_populate_wrapper('6698'); return false;\" title=\"Provide the ability to identify black hole slots\">#6698</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6737\" onclick=\"get_ticket_and_populate_wrapper('6737'); return false;\" title=\"Accounting and Defrag adtypes missing from python bindings\">#6737</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6723\" onclick=\"get_ticket_and_populate_wrapper('6723'); return false;\" title=\"Late Materialization jobs handle getenv=true incorrectly\">#6723</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6732\" onclick=\"get_ticket_and_populate_wrapper('6732'); return false;\" title=\"speed up the schedd check for a change in an autoclustered attribute\">#6732</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-25 15:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55217\">[55217]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6698\" onclick=\"get_ticket_and_populate_wrapper('6698'); return false;\" title=\"Provide the ability to identify black hole slots\">#6698</a></span>. add statistcs that make detection of black-hole glide-ins possible ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Oct-23 11:47", "status": "resolved", "created": "2018-Jun-06 15:14", "fixed_version": "2018-Jun-06 15:14", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "#4882", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu llobato@fnal.gov tannenba@cs.wisc.edu johnkn@cs.wisc.edu", "due_date": ""}