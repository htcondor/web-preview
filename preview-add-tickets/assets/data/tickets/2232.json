{"id": 2232, "title": "Ticket #2232: enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior", "description": "<blockquote>\nCurrently, the GROUP_DYNAMIC_MACH_CONSTRAINT expression counts the startdAds that match the expression and group quotas are based upon this count. The issue is that the negotiation loop iterates ( multiple times ) through these startdAds. The ability to remove these startdAds would increase performance.</blockquote>", "remarks": "<blockquote>\n<em>2011-Jun-14 08:11:06 by bbockelm:</em> <br/>\n\nJust a note: we actively use the old behavior.  We want to remove certain nonsensical ads for the calculation of the pie slice, but the startd's are still usable.\n\n<p>The example here is \"management\" slots that 99.99% of jobs can't use, but are actually used by the sysadmins - and hence need negotiation.\n\n</p><p></p><hr/>\n<em>2011-Jun-17 17:07:58 by eje:</em> <br/>\n\nrepro/test\n\n<p>This fix introduces a new param NEGOTIATOR_STARTD_CONSTRAINT_REMOVE, which defaults to FALSE for backward compatability.  If set to TRUE, then any ads not satisfying GROUP_DYNAMIC_MACH_CONSTRAINT are <strong>removed</strong> from the startd ad list, as well as not being counted for purposes of quota assignment.\n\n</p><p>Use the following config.  Note that configuring no groups actually makes testing easier, since it allows the changes in startd length to show up in the negotiator ad.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nNEGOTIATOR_USE_SLOT_WEIGHTS = FALSE\n\nNEGOTIATOR_INTERVAL = 30\nSCHEDD_INTERVAL = 15\n\nNUM_CPUS = 20\n\nGROUP_NAMES =\n\nNEGOTIATOR_STARTD_CONSTRAINT_REMOVE = TRUE\nGROUP_DYNAMIC_MACH_CONSTRAINT = (SlotID &lt;= 10)\n</pre></div>\n\n\n<p>Amusingly, no jobs are necessary to repro or test new behavior.  Just allow the negotiator to run for a few cycles.\n\n</p><p>Before the fix, observe the candidate slots remain unchanged from total:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_status -neg -l | grep -e TotalSlots -e CandidateSlots\nLastNegotiationCycleTotalSlots0 = 20\nLastNegotiationCycleTotalSlots1 = 20\nLastNegotiationCycleTotalSlots2 = 20\nLastNegotiationCycleCandidateSlots0 = 20\nLastNegotiationCycleCandidateSlots1 = 20\nLastNegotiationCycleCandidateSlots2 = 20\n</pre></div>\n\n\n<p>After the fix, we see that the length of the startd ad list actually changed, as the non-satisfying slots were removed:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_status -neg -l | grep -e TotalSlots -e CandidateSlots\nLastNegotiationCycleTotalSlots0 = 20\nLastNegotiationCycleTotalSlots1 = 20\nLastNegotiationCycleTotalSlots2 = 20\nLastNegotiationCycleCandidateSlots0 = 10\nLastNegotiationCycleCandidateSlots1 = 10\nLastNegotiationCycleCandidateSlots2 = 10\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Jun-27 14:21:21 by jrt:</em> <br/>\n\nThe previous patch had some code to dprintf the fact that the startdAds were trimmed. The new one doesn't which makes it difficult to debug. Any chance that can be added back in?\n\n<p></p><hr/>\n<em>2011-Jun-28 10:21:47 by danb:</em> <br/>\n\nThe configuration seems convoluted.  In the 7.6.2 patch, we have two knobs that interact with each other, but the names do not seem to relate to each other.  The scope of impact is not clear from the names.  One also wonders why the ability to strip out some slot ads should be only offered when there are dynamic groups.  Wouldn't it be better to have a new knob that takes an expression specifically for the purpose of stripping out undesired slot ads?\n\n<p>In the other patch, the prefix \"NEG_\" should instead be \"NEGOTIATOR_\" in keeping with the naming of other existing knobs.\n\n</p><p>This patch feels more like new functionality than bug fixing.  How important is the performance boost?  Unless it is pretty important in a real case, I'd push for landing this all in the development branch.\n\n</p><p></p><hr/>\n<em>2011-Jun-28 10:27:03 by tstclair:</em> <br/>\n\nThis came from the field because apparently they were running into it.\n\n<p></p><hr/>\n<em>2011-Jun-28 14:24:44 by tstclair:</em> <br/>\n\nThe 2nd patch appears to contain the mods which you requested.\n\n<p></p><hr/>\n<em>2011-Jun-28 14:36:56 by danb:</em> <br/>\n\nThe 2nd patch has a boolean toggle that flips the behavior of GROUP_DYNAMIC_MACH_CONSTRAINT.  I think it would be better to have a new knob that does not interact with GROUP_DYNAMIC_MACH_CONSTRAINT.  The new knob should take an expression and use that expression to trim undesired startd ads.\n\n<p>In addition, we should generalize GROUP_DYNAMIC_MACH_CONSTRAINT, as described in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2277\" onclick=\"get_ticket_and_populate_wrapper('2277'); return false;\" title=\"generalize GROUP_DYNAMIC_MACH_CONSTRAINT\">#2277</a></span>.\n\n</p><p></p><hr/>\n<em>2011-Jul-05 15:54:04 by tstclair:</em> <br/>\n\nThis seems trivial and from tracing (patch2) is appears to that (even though the name is poor) it does exactly what was requested in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2277\" onclick=\"get_ticket_and_populate_wrapper('2277'); return false;\" title=\"generalize GROUP_DYNAMIC_MACH_CONSTRAINT\">#2277</a></span>.\n\n<p>From inspection the purpose of the boolean is simply to trim from the full startdAds list.\n\n</p><p>Given previous issues I will target to 7.7 series.\n\n</p><p></p><hr/>\n<em>2011-Jul-05 16:11:49 by tstclair:</em> <br/>\n\nAny further modifications should be done on <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2277\" onclick=\"get_ticket_and_populate_wrapper('2277'); return false;\" title=\"generalize GROUP_DYNAMIC_MACH_CONSTRAINT\">#2277</a></span> if needed.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2277\" onclick=\"get_ticket_and_populate_wrapper('2277'); return false;\" title=\"generalize GROUP_DYNAMIC_MACH_CONSTRAINT\">#2277</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ngeneralize GROUP_DYNAMIC_MACH_CONSTRAINT</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2383\" onclick=\"get_ticket_and_populate_wrapper('2383'); return false;\" title=\"Document new parameter NEGOTIATOR_STARTD_CONSTRAINT_REMOVE\">#2383</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDocument new parameter NEGOTIATOR_STARTD_CONSTRAINT_REMOVE</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/373/startdconstraint.patch\">startdconstraint.patch</a>\n9269 bytes added by jrt on 2011-Jun-13 19:20:56 UTC.\n<br/>\nPatch to remove startdAds not matching GROUP_DYNAMIC_MACH_CONSTRAINT. Changes GROUP_DYNAMIC_MACH_CONSTRAINT to NEG_STARTD_CONSTRAINT  (keeps backward compat) and adds NEG_STARTD_CONSTRAINT_REMOVE to toggle new behavior.<br/>\n</li><li><a href=\"attach_get/381/gt2232_startdconstraint.patch2\">gt2232_startdconstraint.patch2</a>\n2353 bytes added by eje on 2011-Jun-17 21:58:25 UTC.\n<br/>\nMinimalist version of patch to grease skids for inclusion in 7.6.2 stable release.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-22 11:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27344\">[27344]</a></span>: Add param NEGOTIATOR_SLOT_CONSTRAINT to constrain the query for Ads from the negotiator to the collector. Add param NEGOTIATOR_SLOT_POOLSIZE_CONSTRIANT to exclude some of the Ads returned from the calculation of the poolsize for determining quotas. For backward compatibility GROUP_DYNAMIC_MACH_CONSTRAINT\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 12:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27160\">[27160]</a></span>: Edit of NEGOTIATOR_STARTD_CONSTRAINT_REMOVE. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2232\" onclick=\"get_ticket_and_populate_wrapper('2232'); return false;\" title=\"enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior\">#2232</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-09 07:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27134\">[27134]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2232\" onclick=\"get_ticket_and_populate_wrapper('2232'); return false;\" title=\"enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior\">#2232</a></span>, NEGOTIATOR_STARTD_CONSTRAINT_REMOVE  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-05 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22367\">[22367]</a></span>: Trim startdAds for non matching GROUP_DYNAMIC_MACH_CONSTRAINT (poorly named) as its more like DYNAMIC_MACH_CONSTRAINT. Patch originally created by jrt modified by eje. === GT <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2232\" onclick=\"get_ticket_and_populate_wrapper('2232'); return false;\" title=\"enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior\">#2232</a></span> ===  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-29 08:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22334\">[22334]</a></span>: Revert \"=== GT <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2232\" onclick=\"get_ticket_and_populate_wrapper('2232'); return false;\" title=\"enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior\">#2232</a></span> ===\" This reverts commit 536629e388e588845d87d7a5b8b38907386001d0.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-28 09:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22307\">[22307]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2232\" onclick=\"get_ticket_and_populate_wrapper('2232'); return false;\" title=\"enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior\">#2232</a></span> === patch initially created by jrt, refactored by eje Fix: enable additional GROUP_DYNAMIC_MACH_CONSTRAINT behavior  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Aug-15 10:21", "status": "resolved", "created": "2011-Jun-13 14:18", "fixed_version": "2011-Jun-13 14:18", "broken_version": "v070600", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com, eje@cs.wisc.edu, dan@hep.wisc.edu", "due_date": ""}