{"id": 5561, "title": "Ticket #5561: [EC2 GAHP] Retry on AWS' RequestLimitExceeded", "description": "<blockquote>\nJohn Hover writes:\n\n<p></p><div class=\"verbatim\">\n<pre>&gt; Last Friday we attempted a very large scale AWS test, using 3 submit hosts,\n&gt; all three Amazon regions, and many instance types. Each submit host was\n&gt; configured the same, and submitted to all three regions/endpoints.\n&gt;\n&gt; Everything went OK until hitting the ~5000 machine level, at which point,\n&gt; over a couple hours, each submit host began seeing AWS RequestLimitExceeded\n&gt; messages. Getting that error sent the VM job into HELD state.\n</pre></div>\n\n\n<p>We should instead respond to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestLimitExceeded\" title=\"Request Limit Exceeded\">RequestLimitExceeded</a></span> by retrying the limit-exceeding request after a(n exponential) back-off (based on the number of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestLimitExceeded\" title=\"Request Limit Exceeded\">RequestLimitExceeded</a></span> errors received since the last success or failure).\n\n</p><p><span class=\"section\"></span></p><h2>Milestones </h2>\n\n<p><span class=\"subsection\"></span></p><h3>Milestone 1 - Respond to RateLimitExceeded messages</h3>\n<strong>Planned completion date: 2016-03-28</strong>\n\n<p>For this milestone, we plan to complete implementation of responding to an Amazon <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RateLimitExceeded\" title=\"Rate Limit Exceeded\">RateLimitExceeded</a></span> error via an exponential back-off algorithm recommended by Amazon engineers.\n\n</p><p>More specifically, the EC2 GAHP will now examine each Amazon result code for the\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RateLimitExceeded\" title=\"Rate Limit Exceeded\">RateLimitExceeded</a></span> error. If the GAHP finds it, it will wait until the exponential back-off period\nhas expired before re-sending the failed request and sending any subsequent requests. If that back-off period would result in waiting long\nenough for the signature on the RPC we need to retry to expire (~5 minutes), the GAHP will fail the request immediately.\n\n</p><p>We will add a configurable throttle to limit the rate at which the GAHP will send requests to the EC2 server.\n\n</p><p><span class=\"subsection\"></span></p><h3>Milestone 2 - Reduce number of requests sent to Amazon</h3>\n<strong>Planned completion date: 2016-03-28</strong>\n\n<p>We plan to significantly reduce the number of job-specific requests made by HTCondor to Amazon. This\nshould reduce the frequency with which we encounter the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RateLimitExceeded\" title=\"Rate Limit Exceeded\">RateLimitExceeded</a></span>\nerror.\n\n</p><p>Currently each EC2 job submitted to HTCondor results in four requests made to Amazon:\n</p><ul>\n<ol>\n<li>submit spot instance request\n</li><li>cancel spot instance request\n</li><li>tag instance\n</li><li>remove instance upon a condor_rm\n</li></ol>\n</ul>\n\n<p>We believe we can reduce this to just one request.  Item 2 can be eliminated by making the spot request a \"fire-once\" request upon submission.  Item 3 can be eliminated by not requesting a tag in the job submit file (currently Johns does not typically use the tags). Item 4 can be eliminated by having the glidein jobs themselves shutdown the instance when the startd has not had any claimed slots for more than X minutes, instead of relying on the factory to perform a condor_rm of the EC2 job.  To facilitate this, we will produce an HTCondor config recipe for John to use.\n\n</p><p>At completion of Milestone 1 and 2, we will ask John Hover to test incremental release for regressions by using his small EC2 pool in its quiescent low-cost state (40-50 instances).\n\n</p><p><span class=\"subsection\"></span></p><h3>Milestone 3 - Complete extensive synthetic testing</h3>\n<strong>Planned completion date: 2016-04-04</strong>\n\n<p>We will use extensive synthetic testing to develop confidence that the binaries produced upon completion of Milestone 1 and 2 will function as expected both during \"normal\" operation and in rarer cases. The approach will be for the HTCondor code to pretend to receive a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RateLimitExceeded\" title=\"Rate Limit Exceeded\">RateLimitExceeded</a></span> error at specific corner cases and/or according to a defined random distribution. Any problems we discover will be fixed and a new pre-release sent to John Hover to help verify continued forward progress.\n\n</p><p>Our goal at the completion of this milestone is to allow John Hover to be able to perform the first functional full-scale (10k instances) tests as early in the first week of April, and have reasonable confidence in success since we understand performing a full-scale test has a non-negligible monetary cost.\n\n</p><p><span class=\"subsection\"></span></p><h3>Milestone 4 - Addition of metrics</h3>\n<strong>Planned completion date: 2016-04-13</strong>\n\n<p>HTCondor will report, via the grid manager resource ads which are sent to the condor_collector, statistics\nabout i) how many requests were sent, ii) how many received <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestLimitExceeded\" title=\"Request Limit Exceeded\">RequestLimitExceeded</a></span>\nerrors, and iii) how many times the GAHP returned failure for a request because the signature expired.\n\n</p><p>In addition, the EC2 job classad will include an attribute <code>LastRemoteStatusUpdate</code> which will contain the time HTCondor last heard from Amazon about the state of this job; this will allow the user to discern if the information in the job classad is stale (perhaps due to exponential back-off).\n\n</p><p><span class=\"subsection\"></span></p><h3>Milestone 5 - Prioritize commands sent to Amazon</h3>\n<strong>Planned completion date: 2016-04-18</strong>\n\n<p>When the grid manager has multiple commands to issue to the GAHP, it\nwill issue them in priority order: status commands highest and commands\nto generate more work lowest.\n\n</p><p><span class=\"section\"></span></p><h2>Design Document</h2>\n\n<p>Work on a design doc is in progress.  A draft is available at the following address:\n\n</p><p><a class=\"external\" href=\"https://docs.google.com/document/d/1g9F5Vx1YSDfC-ieBeGUxTSZ-sBKDI4IL7nWSzo-8K_I\">https://docs.google.com/document/d/1g9F5Vx1YSDfC-ieBeGUxTSZ-sBKDI4IL7nWSzo-8K_I</a></p></blockquote>", "remarks": "<blockquote>\n<em>2016-Mar-24 20:15:27 by tlmiller:</em> <br/>\n\nWork for milestone 1 will be credited to this ticket.  Work for milestone 2 will be credited to the child ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5567\" title=\"[EC2]  Skip spot cancel if SIR already has an instance ID.\">#5567</a></span>.  The results of milestone 3 should probably be new tickets, but small changes will be assigned to this ticket or <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5567\" title=\"[EC2]  Skip spot cancel if SIR already has an instance ID.\">#5567</a></span>, depending on where the problem was found.  Work for milestone 4 will be credited to the child ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5580\" title=\"Add EC2 GAHP metrics.\">#5580</a></span>.  Work for milestone 5 will be credited to <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5582\" title=\"Prioritize commands sent to EC2\">#5582</a></span>.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5567\" title=\"[EC2]  Skip spot cancel if SIR already has an instance ID.\">#5567</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n[EC2]  Skip spot cancel if SIR already has an instance ID.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5580\" title=\"Add EC2 GAHP metrics.\">#5580</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd EC2 GAHP metrics.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5582\" title=\"Prioritize commands sent to EC2\">#5582</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nPrioritize commands sent to EC2</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=5583\" title=\"[EC2] Add test of EC2 GAHP retry logic to test suite.\">#5583</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n[EC2] Add test of EC2 GAHP retry logic to test suite.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5588\" title=\"[EC2]  Allow removal of spot jobs without instance IDs.\">#5588</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n[EC2]  Allow removal of spot jobs without instance IDs.</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-05 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48363\">[48363]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5580\" title=\"Add EC2 GAHP metrics.\">#5580</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5588\" title=\"[EC2]  Allow removal of spot jobs without instance IDs.\">#5588</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5620\" title=\"Fix race condition when removing spot instance requests.\">#5620</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5628\" title=\"Set HoldReasonCode and HoldReasonSubCode to EC2 job holds.\">#5628</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-22 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48278\">[48278]</a></span>: Fix EC2 call throttling on OS X. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-21 18:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48272\">[48272]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>) Remove code, add functionality. (Fix build failure on Fedora.)  (By Todd Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-20 16:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48266\">[48266]</a></span>: Squashed commit of the following: commit 2f666894c803c2bc53fe2a9ba55ae32bd51a3386 Merge: 0ba8935 462ae6d Author: Todd L Miller &lt;tlmiller@cs.wisc.edu&gt; Date: Tue Apr 19 10:47:09 2016 -0500\u00a0[...]\n (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-19 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48235\">[48235]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>) Start an EC2 GAHP for each resource-identity pair by default, since that's what the request limits actually track.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-13 13:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48206\">[48206]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5580\" title=\"Add EC2 GAHP metrics.\">#5580</a></span>) Fixed bug where state reason code updates (e.g., \"bid-too-low\") weren't being forwarded to the collector. Implemented four EC2 GAHP statistics: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumRequests\" title=\"Num Requests\">NumRequests</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumDistinctRequests\" title=\"Num Distinct Requests\">NumDistinctRequests</a></span> (excluding retries), <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumRequestsExceedingLimit\" title=\"Num Requests Exceeding Limit\">NumRequestsExceedingLimit</a></span>, and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumExpiredSignatures\" title=\"Num Expired Signatures\">NumExpiredSignatures</a></span>. TJ's statistics code means I got Recent*\u00a0[...]\n (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-04 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48172\">[48172]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>) Improved test harness. We now check before sending a request if its signature has already expired. (Because our signature may have expired while waiting for another request to finish.)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-24 16:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48113\">[48113]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5567\" title=\"[EC2]  Skip spot cancel if SIR already has an instance ID.\">#5567</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5588\" title=\"[EC2]  Allow removal of spot jobs without instance IDs.\">#5588</a></span>) Eliminate the other superflous call to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CancelSpotInstanceRequests\" title=\"Cancel Spot Instance Requests\">CancelSpotInstanceRequests</a></span>. Fix for being unable to remove Spot jobs before they spawned an instance. Fixed a bug allowing Spot jobs to be removed during recovery without verifying that they hadn't spawned an instance in the interim. Fixed\u00a0[...]\n (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-24 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48112\">[48112]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5567\" title=\"[EC2]  Skip spot cancel if SIR already has an instance ID.\">#5567</a></span>) Don't waste our request quota on superflous <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CancelSpotInstanceRequests\" title=\"Cancel Spot Instance Requests\">CancelSpotInstanceRequests</a></span> calls. Add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestLimitExceeded\" title=\"Request Limit Exceeded\">RequestLimitExceeded</a></span> code for smoke-testing. (Makes EC2 GAHPs account-specific.)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-21 17:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48070\">[48070]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>) Correct a typo in a comment. Add newlines to some dprintf()s that needed them.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-21 17:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48069\">[48069]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5561\" title=\"[EC2 GAHP] Retry on AWS' RequestLimitExceeded\">#5561</a></span>) Add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WantNameTag\" title=\"Want Name Tag\">WantNameTag</a></span> option, defaults true, false for scaling.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "incident", "last_change": "2016-May-17 10:32", "status": "resolved", "created": "2016-Mar-15 13:52", "fixed_version": "2016-Mar-15 13:52", "broken_version": "v080404", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "jhover@bnl.gov, tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu,jfrey@cs.wisc.edu", "due_date": ""}