{"id": 6396, "title": "Ticket #6396: noop_job in submit isn't honored by schedd when a claim is reused", "description": "<blockquote>\nFor reference: submit value <code>noop_job</code> is translated to <code>IsNoopJob</code> in the job ad.\n\n<p>When the schedd sees a job with <code>IsNoopJob==True</code>, it marks it as completed and goes on its merry way.\n\n</p><p>However, it does this in <code>count_a_job()</code>, which works for most jobs, but is not sufficient for all jobs.  Particularly, when reusing a claim, it is possible to have a noop job that <code>count_a_job()</code> has not yet processed (because it was recently submitted), so the schedd goes ahead and executes the job as if this attribute were not present.\n\n</p><p>We need to check for the <code>IsNoopJob</code> attribute when searching for a runnable job. For efficient processing of <code>IsNoopJob</code>, we should also be checking just after the job is submitted.\n\n</p><p>Now the way the schedd finds jobs to run when it gets match records is to walk the <code>PrioRec</code> array checking each job in order. this guarantees that the highest priority matching job gets the match.  In 8.6.6 and earlier versions of the schedd. noop jobs are put into the <code>PrioRec</code> array, so <code>FindRunnableJob</code> finds them.  If they were skipped when building the <code>PrioRec</code> array, then they would not be run, although because the <code>IsNoopJob</code> is an expression, it should still be checked in <code>Runnable</code> to insure that even if a job ends up in the <code>PrioRec</code> array, it will not be run.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Sep-06 17:03:17 by zmiller:</em> <br/>\n\nTo reproduce, open attachment and submit a.dag, let it run to completion.  When the bug is present, jobs N3 and N4 will execute even though they are marked noop, and you'll see result files output.N2, output.N3, and output.N4.\n\n<p>If the bug is fixed, you should see only output.N2.\n\n</p><p>(run clean in between trials to remove output, logs, dagman cruft.)\n\n</p><p></p><hr/>\n<em>2017-Sep-07 11:21:09 by johnkn:</em> <br/>\n\nOne way to avoid hitting this bug is to make sure that the noop jobs don't match any resources.  This can be accomplished by setting requirements=false as well as noop_job=true to the submit file.\n\n<p></p><hr/>\n<em>2017-Sep-07 12:47:11 by johnkn:</em> <br/>\n\nThe fix (for stable) will be to skip the noop jobs when building the <code>PrioRec</code> array, and ALSO to check for noop jobs in <code>Runnable</code>.  This will prevent jobs that were submitted as noop jobs from being found when searching for runnable jobs, and also prevent them from being run if the <code>IsNoopJob</code> expression changes to true after the <code>PrioRec</code> array is built, but before the job is actually started.\n\n<p></p><hr/>\n<em>2017-Oct-26 14:54:21 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.\n\n<p></p><hr/>\n<em>2017-Oct-27 14:58:31 by tim:</em> <br/>\n\n<strong>Doc Review:</strong> Complete</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/1002/noop.tgz\">noop.tgz</a>\n457 bytes added by zmiller on 2017-Sep-06 22:03:40 UTC.\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-28 20:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52700\">[52700]</a></span>: Transplant version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6396\" onclick=\"get_ticket_and_populate_wrapper('6396'); return false;\" title=\"noop_job in submit isn't honored by schedd when a claim is reused\">#6396</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6425\" onclick=\"get_ticket_and_populate_wrapper('6425'); return false;\" title=\"Windows limited to 80% of open socket limit for no good reason.\">#6425</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-26 15:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52674\">[52674]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6396\" onclick=\"get_ticket_and_populate_wrapper('6396'); return false;\" title=\"noop_job in submit isn't honored by schedd when a claim is reused\">#6396</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6425\" onclick=\"get_ticket_and_populate_wrapper('6425'); return false;\" title=\"Windows limited to 80% of open socket limit for no good reason.\">#6425</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-07 15:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52290\">[52290]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6396\" onclick=\"get_ticket_and_populate_wrapper('6396'); return false;\" title=\"noop_job in submit isn't honored by schedd when a claim is reused\">#6396</a></span>. noop_job may be ignored if the job runs shortly after it is sumitted, which is common with dagman and keep-claim-idle  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Oct-27 14:58", "status": "resolved", "created": "2017-Sep-06 16:54", "fixed_version": "2017-Sep-06 16:54", "broken_version": "v080600", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu zmiller@cs.wisc.edu", "due_date": "20170909"}