{"id": 2340, "title": "Ticket #2340: Globus gss_assist API used without activation", "description": "<blockquote>\nIn condor_auth_x509, it is possible to use the gss_assist calls without activating the module.  In many cases, using Globus without activating is OK, but it is possible to trigger badness.\n\n<p>In particular, I triggered this (see gdb backtrace below; I was breaking on globus_module_activate); if you use LCMAPS via gsi-authz.conf, it will properly activate/deactivate gss_assist.  When it deactivates gss_assist, it zeros out a mutex (which is initialized statically, I think), causing any subsequent call to Globus to segfault.\n\n</p><p>It's likely I'm the only Condor user in the universe to hit this, but my dev box is approximately what we want the OSG production servers to look like in December.\n\n</p><p></p><div class=\"verbatim\">\n<pre>(gdb) bt\n#0  globus_module_activate (module_descriptor=0x7ebb80) at globus_module.c:262\n#1  0x0000003f84c0845c in gss_acquire_cred (minor_status=0x7fffffffd40c, desired_name_P=0x0, time_req=&lt;value optimized out&gt;, desired_mechs=&lt;value optimized out&gt;, cred_usage=0, output_cred_handle_P=0xa774f0, actual_mechs=0x0,\n    time_rec=0x0) at acquire_cred.c:116\n#2  0x0000003f85803ffd in globus_gss_assist_acquire_cred_ext (minor_status=0x7fffffffd40c, desired_name_char=0x0, time_req=4294967295, desired_mechs=0x0, cred_usage=0, output_cred_handle=0xa774f0, actual_mechs=0x0, time_rec=0x0)\n    at acquire.c:166\n#3  0x0000003f85804059 in globus_gss_assist_acquire_cred (minor_status=0x7ebb80, cred_usage=-2065591584, output_cred_handle=0x6f08) at acquire.c:80\n#4  0x00000000004d3750 in Condor_Auth_X509::authenticate_self_gss (this=0xa774a0, errstack=0x7fffffffde20) at /usr/src/debug/condor-7.6.0/src/condor_io/condor_auth_x509.cpp:605\n#5  0x00000000004d4406 in Condor_Auth_X509::authenticate (this=0x7ebb80, errstack=0x0) at /usr/src/debug/condor-7.6.0/src/condor_io/condor_auth_x509.cpp:91\n#6  0x00000000004c054d in Authentication::authenticate_inner (this=0x7fffffffda10, hostAddr=0x0, auth_methods=&lt;value optimized out&gt;, errstack=0x7fffffffde20, timeout=-1)\n    at /usr/src/debug/condor-7.6.0/src/condor_io/authentication.cpp:252\n#7  0x00000000004c0c92 in Authentication::authenticate (this=0x7ebb80, hostAddr=0x0, key=@0x7fffffffdea8, auth_methods=0x0, errstack=0x7fffffffde20, timeout=28424) at /usr/src/debug/condor-7.6.0/src/condor_io/authentication.cpp:91\n#8  0x00000000004a6f5c in ReliSock::perform_authenticate (this=0xa89df0, with_key=true, key=@0x7fffffffdea8, methods=0xa766d0 \"GSI\", errstack=0x7fffffffde20, auth_timeout=-1, method_used=0x7fffffffde80)\n    at /usr/src/debug/condor-7.6.0/src/condor_io/reli_sock.cpp:975\n#9  0x00000000004a707e in ReliSock::authenticate (this=0x7ebb80, key=@0x0, methods=0x3f7f80c0a4 \"H\\203\\304\\b1\\300\\303\\017\\037D\", errstack=0x3f84e192e0, auth_timeout=28424, method_used=&lt;value optimized out&gt;)\n    at /usr/src/debug/condor-7.6.0/src/condor_io/reli_sock.cpp:1003\n#10 0x000000000047c71b in DaemonCore::HandleReq (this=0xa469a0, insock=0xa51a30, asock=&lt;value optimized out&gt;) at /usr/src/debug/condor-7.6.0/src/condor_daemon_core.V6/daemon_core.cpp:4801\n#11 0x000000000047de05 in DaemonCore::CallSocketHandler_worker (this=0xa469a0, i=0, default_to_HandleCommand=true, asock=0xa89df0) at /usr/src/debug/condor-7.6.0/src/condor_daemon_core.V6/daemon_core.cpp:3713\n#12 0x000000000047de3a in DaemonCore::CallSocketHandler_worker_demarshall (arg=0xa75ce0) at /usr/src/debug/condor-7.6.0/src/condor_daemon_core.V6/daemon_core.cpp:3661\n#13 0x000000000050d288 in CondorThreads::pool_add (routine=0, arg=0x0, tid=0x0, descrip=0x3f7f80c0a4 \"H\\203\\304\\b1\\300\\303\\017\\037D\") at /usr/src/debug/condor-7.6.0/src/condor_utils/condor_threads.cpp:1109\n#14 0x0000000000478e79 in DaemonCore::CallSocketHandler (this=0xa469a0, i=@0x7fffffffe32c, default_to_HandleCommand=true) at /usr/src/debug/condor-7.6.0/src/condor_daemon_core.V6/daemon_core.cpp:3649\n#15 0x000000000047fa05 in DaemonCore::Driver (this=0xa469a0) at /usr/src/debug/condor-7.6.0/src/condor_daemon_core.V6/daemon_core.cpp:3533\n#16 0x000000000048fa07 in main (argc=1, argv=0x7fffffffea28) at /usr/src/debug/condor-7.6.0/src/condor_daemon_core.V6/daemon_core_main.cpp:2379\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Aug-03 11:26:02 by jfrey:</em> <br/>\n\nI've attached a patch that should fix this problem.\n\n<p></p><hr/>\n<em>2011-Aug-05 09:51:53 by zmiller:</em> <br/>\n\nreviewed, looks good.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/426/gittrac-2340.patch\">gittrac-2340.patch</a>\n1319 bytes added by jfrey on 2011-Aug-03 16:25:46 UTC.\n<br/>\nPatch to activate globus modules in Condor_Auth_X509.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-05 10:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26646\">[26646]</a></span>: Document GSI bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2340\" title=\"Globus gss_assist API used without activation\">#2340</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-04 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26637\">[26637]</a></span>: Properly initialize GSI when using it in CEDAR. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2340\" title=\"Globus gss_assist API used without activation\">#2340</a></span>  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Aug-05 10:22", "status": "resolved", "created": "2011-Aug-01 14:12", "fixed_version": "2011-Aug-01 14:12", "broken_version": "v070600", "priority": "4", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}