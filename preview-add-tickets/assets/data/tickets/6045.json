{"id": 6045, "title": "Ticket #6045: The Startd should put docker \"universe\" offline if Docker hangs", "description": "<blockquote>\nIn CHTC we are seeing cases where a Docker job is causing the Docker daemon to stop responding.  When this happens, all subsequent docker jobs will fail on this machine, making the machine a black hole for Docker jobs.\n\n<p>To Fix this:\n\n</p><p></p><ul>\n<li>The DockerAPI should be enhanced so that it will time out all communication with the Docker daemon.\n</li><li>When the Startd is unable to communicate with the Docker daemon, it should put the docker \"universe\" offline using the same mechanism we added for VM universe.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Dec-08 14:08:45 by johnkn:</em> <br/>\n\nSince the DockerAPI currently uses my_popen for most communication with the Docker daemon, we will need to add the capability to do reads from the resulting pipe with a timeout.\n\n<p>More particularly, since we only really care about whether or not the my_popen process FINISHES within a certain amount of time, a new class will be created on top of my_popen that will run a program and capture its output into a memory buffer with a timeout on the entire operation.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-19 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49840\">[49840]</a></span>: more changes to the my_popen with timeout based on code review <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6045\" onclick=\"get_ticket_and_populate_wrapper('6045'); return false;\" title='The Startd should put docker \"universe\" offline if Docker hangs'>#6045</a></span> this commit also reduces the chattyness of the dockerapi in part by making a new flag that can be passed to my_popen telling it to fail certain operations quietly. ===VersionHistory:none===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-15 14:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49819\">[49819]</a></span>: changes resulting from code review for <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6045\" onclick=\"get_ticket_and_populate_wrapper('6045'); return false;\" title='The Startd should put docker \"universe\" offline if Docker hangs'>#6045</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-09 11:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49778\">[49778]</a></span>: have the STARTD put docker \"Universe\" offline when docker hangs. <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6045\" onclick=\"get_ticket_and_populate_wrapper('6045'); return false;\" title='The Startd should put docker \"universe\" offline if Docker hangs'>#6045</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Jan-25 10:10", "status": "review", "created": "2016-Dec-08 14:03", "fixed_version": "2016-Dec-08 14:03", "broken_version": "", "priority": "4", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}