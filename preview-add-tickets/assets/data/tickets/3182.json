{"id": 3182, "title": "Ticket #3182: Getting loadavg does not work on non-English versions of Windows", "description": "<blockquote>\nThe PDH library we use for getting CPU usage takes locale specific names for performance counters. Since we hardcode the name we use, this means on non-English versions of Windows, the API fails to find the requested counters. Guilty code is in condor_sysapi/load_avg.cpp at around line 323 in the sample_load function. Specifically, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PdhAddCounter\" title=\"Pdh Add Counter\">PdhAddCounter</a></span> function wants the localized counter name. Vista offers an \"alternative\" function called <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PdhAddEnglishCounter\" title=\"Pdh Add English Counter\">PdhAddEnglishCounter</a></span>, which unfortunately we cannot use since we still support XP. The alternative is to follow the suggestions here: <a class=\"external\" href=\"http://support.microsoft.com/kb/287159\">http://support.microsoft.com/kb/287159</a> to acquire the localized name by searching for it using the counter index. The counter we are using is a system counter so I do not believe it is ever liable to change, so we could hardcode that. A third alternative would be to avoid using the pdh helper functions.</blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-07 15:16:29 by johnkn:</em> <br/>\n\nI propose that we dynalink to the Vista/Win7 function and use it if it is available, otherwise fall back to the current code.  That gives us non-english support on Vista and Win7, but not on XP, which would be acceptable to most of our users.\n\n<p>-tj</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/617/load.patch\">load.patch</a>\n2226 bytes added by ziliang on 2012-Aug-07 21:30:04 UTC.\n<br/>\nPatch doing what TJ suggested.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-04 10:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33247\">[33247]</a></span>: minor version history item wording change ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3182\" title=\"Getting loadavg does not work on non-English versions of Windows\">#3182</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-31 15:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33241\">[33241]</a></span>: add version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3182\" title=\"Getting loadavg does not work on non-English versions of Windows\">#3182</a></span> ===VersionHistory:Complete===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-08 13:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33014\">[33014]</a></span>: Add support for getting load average on non-English versions of Windows on Vista and higher. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3182\" title=\"Getting loadavg does not work on non-English versions of Windows\">#3182</a></span>.  (By Ziliang Guo )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Aug-08 14:42", "status": "resolved", "created": "2012-Aug-07 14:51", "fixed_version": "2012-Aug-07 14:51", "broken_version": "v070800", "priority": "4", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "", "creator": "ziliang", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}