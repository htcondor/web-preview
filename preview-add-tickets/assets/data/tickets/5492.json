{"id": 5492, "title": "Ticket #5492: collector crashes while sending updates", "description": "<blockquote>\ncollector is crashing on RHEL6 while trying to detect whether it is sending updates to itself.\n\n<p>the faulting line of code is in dc_collector.cpp DCCollector::sendUpdate\n\n</p><p></p><pre>\tif( cmd == UPDATE_COLLECTOR_AD || cmd == INVALIDATE_COLLECTOR_ADS ) {\n            ...\n    \t    !!crash-here!!  if( strcmp( myOwnSinful, _addr ) == 0 ) {\n</pre>\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">rust 8618</pre>\n<pre class=\"snip\">01/21/16 18:18:10       Cleaning GridAds ...\n01/21/16 18:18:10       Cleaning XferServiceAds ...\n01/21/16 18:18:10       Cleaning LeaseManagerAds ...\n01/21/16 18:18:10       Cleaning Generic Ads ...\n01/21/16 18:18:10 Housekeeper:  Done cleaning Stack dump for process 242147 at timestamp 1453418291 (11 frames) /usr/lib64/libcondor_utils_8_4_3.so(dprintf_dump_stack+0x12d)[0x38be7b69dd]\n/usr/lib64/libcondor_utils_8_4_3.so(_Z18linux_sig_coredumpi+0x40)[0x38be8b1930]\n/lib64/libpthread.so.0[0x334e40f790]\n/lib64/libc.so.6[0x334e128b24]\n/usr/lib64/libcondor_utils_8_4_3.so(_ZN11DCCollector10sendUpdateEiPN14compat_classad7ClassAdER22DCCollectorAdSequencesS2_b+0x292)[0x38be867452]\ncondor_collector(_ZN15CollectorDaemon15sendCollectorAdEv+0x4a4)[0x455f54]\n/usr/lib64/libcondor_utils_8_4_3.so(_ZN12TimerManager7TimeoutEPiPd+0x3d3)[0x38be88a8b3]\n/usr/lib64/libcondor_utils_8_4_3.so(_ZN10DaemonCore6DriverEv+0xc03)[0x38be89bbe3]\n/usr/lib64/libcondor_utils_8_4_3.so(_Z7dc_mainiPPc+0x1799)[0x38be8b3ac9]\n/lib64/libc.so.6(__libc_start_main+0xfd)[0x334e01ed5d]\ncondor_collector[0x40eab9]\n01/21/16 18:18:21 Setting maximum file descriptors to 10240.\n01/21/16 18:18:21 ******************************************************\n\nGDB dump:\n\nCore was generated by `condor_collector -f'.\n#0  0x00000038be8cc648 in WriteCoreDump () from /usr/lib64/libcondor_utils_8_4_3.so\n(gdb) where\n#0  0x00000038be8cc648 in WriteCoreDump () from /usr/lib64/libcondor_utils_8_4_3.so\n#1  0x00000038be8b1993 in linux_sig_coredump (signum=11) at\n/usr/src/debug/condor-8.4.3/src/condor_daemon_core.V6/daemon_core_main.cpp:735\n#2  &lt;signal handler called&gt;\n#3  __strcmp_sse42 () at ../sysdeps/x86_64/multiarch/strcmp.S:1078\n#4  0x00000038be867452 in DCCollector::sendUpdate (this=0x145bae0, cmd=19, ad1=0x145c9a0, adSeq=&lt;value optimized out&gt;, ad2=0x0,\n    nonblocking=false) at\n/usr/src/debug/condor-8.4.3/src/condor_daemon_client/dc_collector.cpp:253\n#5  0x0000000000455f54 in ?? ()\n#6  0x000000000147ea48 in ?? ()\n#7  0x00007ffda60a0240 in ?? ()\n#8  0x000000000150a538 in ?? ()\n#9  0x00000000a60a0230 in ?? ()\n#10 0x00000000014b9ff8 in ?? ()\n#11 0x000000334fcbd1d9 in operator new[] (sz=&lt;value optimized out&gt;) at\n./../../../libstdc++-v3/libsupc++/new_opv.cc:32\n#12 0x00007ffda60bea11 in vdso_fallback_gettime (clock=0, ts=0x14156f0) at\narch/x86/vdso/vclock_gettime.c:32\n#13 __vdso_clock_gettime (clock=0, ts=0x14156f0) at\narch/x86/vdso/vclock_gettime.c:131\n#14 0x00000000a60a0580 in ?? ()\n#15 0x00007ffda60a0220 in ?? ()\n#16 0xffffffffff600421 in ?? ()\n#17 0x0000000056a16ac2 in ?? ()\n#18 0x0000000001417dd0 in ?? ()\n#19 0x00000038bebac940 in ?? () from /usr/lib64/libcondor_utils_8_4_3.so\n#20 0x00000038bebaad6c in AnyDebugBasicListener () from /usr/lib64/libcondor_utils_8_4_3.so\n---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---\n#21 0x00007ffda60a0580 in ?? ()\n#22 0x0000000000000001 in ?? ()\n#23 0x00007ffda60a0588 in ?? ()\n#24 0x00000038be88a8b3 in TimerManager::Timeout (this=0x67cd58, pNumFired=0x67c700, pruntime=0x67cd68)\n    at\n/usr/src/debug/condor-8.4.3/src/condor_daemon_core.V6/timer_manager.cpp:440\n#25 0x00000038be89bbe3 in DaemonCore::Driver (this=0x14100c0) at\n/usr/src/debug/condor-8.4.3/src/condor_daemon_core.V6/daemon_core.cpp:3438\n#26 0x00000038be8b3ac9 in dc_main (argc=1, argv=0x7ffda60a0cc0)\n    at\n/usr/src/debug/condor-8.4.3/src/condor_daemon_core.V6/daemon_core_main.cpp:2777\n#27 0x000000334e01ed5d in __libc_start_main (main=0x40eba0, argc=2, ubp_av=0x7ffda60a0cb8, init=&lt;value optimized out&gt;,\n    fini=&lt;value optimized out&gt;, rtld_fini=&lt;value optimized out&gt;,\nstack_end=0x7ffda60a0ca8) at libc-start.c:226\n#28 0x000000000040eab9 in ?? ()\n#29 0x00007ffda60a0ca8 in ?? ()\n#30 0x000000000000001c in ?? ()\n#31 0x0000000000000002 in ?? ()\n#32 0x00007ffda60a1cbb in ?? ()\n#33 0x00007ffda60a1cbb in ?? ()\n#34 0x0000000000000000 in ?? ()\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Jan-27 14:08:14 by tlmiller:</em> <br/>\n\nUser sent us a stack dump which makes it clear that this is a problem with the world collector:\n\n<p></p><div class=\"verbatim\">\n<pre>01/27/16 10:23:43 (D_HOSTNAME) Checking if condor.cs.wisc.edu is a sinful address\n01/27/16 10:23:43 (D_HOSTNAME) condor.cs.wisc.edu is not a sinful address: does not begin with \"&lt;\"\n01/27/16 10:23:43 (D_HOSTNAME) New Daemon obj (collector) name: \"condor.cs.wisc.edu\", pool: \"NULL\", addr: \"NULL\"\n01/27/16 10:23:43 (D_HOSTNAME) Using name \"condor.cs.wisc.edu\" to find daemon\n01/27/16 10:23:43 (D_HOSTNAME) Port not specified, using default (9618)\n01/27/16 10:23:43 (D_HOSTNAME) Host info \"condor.cs.wisc.edu\" is a hostname, finding IP address\n01/27/16 10:23:43 (D_HOSTNAME) ipv6_getaddrinfo() could not look up condor.cs.wisc.edu: Name or service not known (-2)\n01/27/16 10:23:44 (D_HOSTNAME) Using name \"condor.cs.wisc.edu\" to find daemon\n01/27/16 10:23:44 (D_HOSTNAME) Port not specified, using default (9618)\n01/27/16 10:23:44 (D_HOSTNAME) Host info \"condor.cs.wisc.edu\" is a hostname, finding IP address\n01/27/16 10:23:44 (D_HOSTNAME) ipv6_getaddrinfo() could not look up condor.cs.wisc.edu: Name or service not known (-2)\n\nStack dump for process 341105 at timestamp 1453908224 (11 frames)\n/usr/lib64/libcondor_utils_8_4_3.so(dprintf_dump_stack+0x12d)[0x38be7b69dd]\n/usr/lib64/libcondor_utils_8_4_3.so(_Z18linux_sig_coredumpi+0x40)[0x38be8b1930]\n/lib64/libpthread.so.0[0x334e40f790]\n/lib64/libc.so.6[0x334e1283fa]\n/usr/lib64/libcondor_utils_8_4_3.so(_ZN11DCCollector10sendUpdateEiPN14compat_classad7ClassAdER22DCCollectorAdSequencesS2_b+0x292)[0x38be867452]\n</pre></div>\n\n\n<p>The user sees this on reconfig rather than start-up because we don't bother to update the world collector if we have no machines.  We don't see this problem for any other kind of advertisement because we check to see if we're advertising a collector before we check to see if we're advertising to ourselves.\n\n</p><p></p><hr/>\n<em>2016-Jan-28 10:18:35 by johnkn:</em> <br/>\n\nCODE_REVIEW: code looks ok except for use of D_FAILURE flag, which is intended for use in situations where the daemon is about to exit or fail to operate correctly.  Since this is likely to be a benign failure for the common case of not being able to update the world collector. it probably should not be marked D_FAILURE.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-29 11:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47526\">[47526]</a></span>: Minor version history edits for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5492\" title=\"collector crashes while sending updates\">#5492</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5488\" title=\"master blows assert if old shared port ad in address file\">#5488</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5466\" title=\"Job policy reason strings contain extra junk\">#5466</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-28 13:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47508\">[47508]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5492\" title=\"collector crashes while sending updates\">#5492</a></span>) Version history entry.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-28 12:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47504\">[47504]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5492\" title=\"collector crashes while sending updates\">#5492</a></span>) Remove unwarranted D_FAILURE flags.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-27 14:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47497\">[47497]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5492\" title=\"collector crashes while sending updates\">#5492</a></span>) Collector now properly refuses to check a NULL address when determining if it's sending an ad to itself.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Jan-28 13:13", "status": "resolved", "created": "2016-Jan-22 12:00", "fixed_version": "2016-Jan-22 12:00", "broken_version": "v080403", "priority": "1", "subsystem": "DaemonsCM", "assigned_to": "tlmiller", "derived_from": "", "creator": "johnkn", "rust": "s8616", "customer_group": "support", "visibility": "public", "notify": "", "due_date": ""}