{"id": 6936, "title": "Ticket #6936: job event log timestamps have no year, can appear to go backwards", "description": "<blockquote>\nA bug was reported to RT that the timestamps in the job event log don't work for users that care about the event times and have logs with events in them that were not written in the current year.\n\n<p>In particular, there is no year or timezone information in the log, and the event reader c++ classes reconstruct the full timestamp assuming localtime and all that all event are from the current year.\n\n</p><p>For example\n</p><div class=\"code\">\n<pre class=\"code\">Worker and Scheduler both have the correct RTC time: 2019-01-01 04:00:00Z\n\nWorker's timezone is PST, Scheduler's timezone is UTC\n\nWorker localtime = 2018-12-31 20:00:00 -&gt; writes 12/31 20:00:00\nReader localtime = 2019-01-01 04:00:00 -&gt; tm_year = 119 + 12/31 20:00:00 :. EventTime = 2019-12-31 20:00:00\n</pre></div>\n\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">python code to reproduce the problem</pre>\n<pre class=\"snip\">import htcondor\n\ndata = \"\"\"\n028 (1234.000.000) 12/31 23:59:59 Job ad information event triggered.\nEventTime = \"2016-12-31T23:59:59\"\nCluster = 1234\nProc = 0\nSubmitHost = \"&lt;xxx&gt;\"\nMyType = \"SubmitEvent\"\nTriggerEventTypeNumber = 0\nEventTypeNumber = 28\nSubproc = 0\nTriggerEventTypeName = \"ULOG_SUBMIT\"\n...\n028 (1234.000.000) 01/01 00:00:00 Job ad information event triggered.\nEventTime = \"2017-01-01T00:00:00\"\nCluster = 1235\nProc = 0\nSubmitHost = \"&lt;xxx&gt;\"\nMyType = \"SubmitEvent\"\nTriggerEventTypeNumber = 0\nEventTypeNumber = 28\nSubproc = 0\nTriggerEventTypeName = \"ULOG_SUBMIT\"\n...\n\"\"\"\n\nTEST_FILE = \"/tmp/condor.sampledata.txt\"\nwith open(TEST_FILE, \"w\") as outf:\n    outf.write(data)\n\nwith open(TEST_FILE, \"r\") as inf:\n    for event in htcondor.read_events(inf):\n        print(event['EventTime'])\n</pre></div>\n\n\n<p>Run the script: note that both dates have the current year, but note that the first date is incorrect by an additional year.\n\n</p><p>The bug reporter goes on to suggest that we could fix this bug by adding the year and possibly timezone information to the header of each event, or adding an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventTime\" title=\"Event Time\">EventTime</a></span> field to the body of every event.\n\n</p><p>Both of these suggestions would break backward compatibility.  The first is much less work for us.  The second suggestion seems like it might not break backward compatibility, but not all events would tolerate the inclusion of new fields, so it actually would break backward compatibility.\n\n</p><p>We should fix this by changing the log reader so that either the current date/time format or an ISO 8601 time of the form yyyy-mm-dd hh:mm+hh or hh:mmZ is allowed.\n\n</p><p>We should then add a configuration knob for the Schedd and Shadow that allows administrators to opt in to the ISO 8601 date/time format. This new configuration knob should default to off for the 8.8 series, and to on for the 8.9 series.  We might also want to allow the Administrator to opt in to UTC timestamps.\n\n</p><p>We could also optionally provide a tool - perhaps a python script, that would intelligently convert a completed user event log to one with ISO 8601 timestamps.\n\n</p><p><span class=\"subsubsection\"></span></p><h4>Fixes </h4>\nIn 8.8.2, the c++ event log reader will be changed to that it will read either the current date format or an ISO 8601 date including the year from the event header.  It will also correctly parse a time with a fractional seconds value, and/or an optional trailing Z to indicate UTC.  It will also parse but ignore a trailing timezone field in ISO 8601 form.\n\n<p>So HTCondor 8.8.2 will be able to consume log files with either 8.8.1 or earlier event headers, or ISO 8601 compatible headers. It may not report the time correctly if a timezone other than Z is used, but it will not choke on the format.\n\n</p><p>Two knobs will be added, but not documented that allows a system administrator to opt in to ISO 8601 dates and/or UTC for all user job logs and for the global event log. These knobs will be\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">config fragment</pre>\n<pre class=\"snip\"># this controls format of the EventLog\nEVENT_LOG_FORMAT_OPTIONS=UTC,ISO_DATE\n# this sets default format options for job's Log and DagmanLog\nDEFAULT_USERLOG_FORMAT_OPTIONS=UTC,ISO_DATE\n</pre></div>\n\npermitted values for these two knobs will be zero or more of the case-insensitive options\n\n<p></p><ul>\n<li>UTC - print the date and time as UTC with a trailing Z as the timezone\n</li><li>ISO_DATE - print the date as YYYY-MM-DD\n</li><li>SUB_SECOND - (future) print a fractional seconds value\n</li></ul>\n\n<p>These options may be prefixed by a ! to turn the option off, although at present there is no need to do this because all options are set to off by default in the code.  In the the 8.9 series, we plan to change the compile time default to <code>UTC,ISO_DATE</code> and at that time, an admin can go back to the older date/time format by configuring <code>!UTC,!ISO_DATE</code></p></blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-28 10:50:23 by johnkn:</em> <br/>\n\nThe relevant broken code is in src/condor_utils/condor_event.cpp lines 247 thru 249, and lines 303 thru 312\n\n<p></p><hr/>\n<em>2019-Mar-04 16:26:35 by johnkn:</em> <br/>\n\nIn 8.8.1 and earlier, when we read the ISO6801 timestamp from the <code>\"EventTime\"</code> field in an XML log file, a trailing Z (meaning UTC) is parsed but ignored.\n\n<p></p><hr/>\n<em>2019-Mar-22 13:56:43 by jfrey:</em> <br/>\n\nThis code changes ULogEvent::toClassAd() to take an argument (with no default). This will break any code that uses this method. Since we consider this part of a public API, we should avoid such changes in the stable series.\n\n<p></p><hr/>\n<em>2019-Apr-09 11:39:12 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks OK.\n\n<p>In <code>condor_event.cpp</code>, in <code>ULogEvent::readHeader</code>, we check for a bogus date stamp. The check is a little looser than it could be it would allow dates with the date of the month value of 0 and 32. Also, it allows 24 for the hour, which is not allowed in a <code>struct tm</code>, but is allow to denote midnight at the end of a day in ISO 8601.\n\n</p><p>Gratuitous change of workspace from 6 to 8 bytes in <code>iso_dates.cpp</code>.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=5468\" onclick=\"get_ticket_and_populate_wrapper('5468'); return false;\" title=\"Have only one timestamp in the ULogEvent class\">#5468</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nHave only one timestamp in the ULogEvent class</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6940\" onclick=\"get_ticket_and_populate_wrapper('6940'); return false;\" title=\"event log and userlog times should have a year by default\">#6940</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nevent log and userlog times should have a year by default</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-05 17:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56282\">[56282]</a></span>: add arg to formatEvent() used by Py_Str() in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobEventLog\" title=\"Job Event Log\">JobEventLog</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6936\" onclick=\"get_ticket_and_populate_wrapper('6936'); return false;\" title=\"job event log timestamps have no year, can appear to go backwards\">#6936</a></span> made this a required argument  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-05 16:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56281\">[56281]</a></span>: fix problem caused by merge of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6936\" onclick=\"get_ticket_and_populate_wrapper('6936'); return false;\" title=\"job event log timestamps have no year, can appear to go backwards\">#6936</a></span> to master branch  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-05 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56279\">[56279]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6936\" onclick=\"get_ticket_and_populate_wrapper('6936'); return false;\" title=\"job event log timestamps have no year, can appear to go backwards\">#6936</a></span>, add option to write ISO 8601 date and/or UTC time to event log and userlog headers. two new knobs control these options : EVENT_LOG_FORMAT_OPTIONS for the event log, and DEFAULT_USERLOG_FORMAT_OPTIONS for the userlog. The knobs default to nothing will leaves the format of the event log and\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-01 16:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56266\">[56266]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6936\" onclick=\"get_ticket_and_populate_wrapper('6936'); return false;\" title=\"job event log timestamps have no year, can appear to go backwards\">#6936</a></span>, change c++ event log reader to read date and time out of the event header in a way that permits future addition of a year and/or timezone without completely breaking eventlog readers like dagman ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Apr-09 13:56", "status": "resolved", "created": "2019-Feb-28 10:48", "fixed_version": "2019-Feb-28 10:48", "broken_version": "", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "s96318", "customer_group": "support", "visibility": "public", "notify": "", "due_date": ""}