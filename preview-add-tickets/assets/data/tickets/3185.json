{"id": 3185, "title": "Ticket #3185: allow job router to edit jobs in place", "description": "<blockquote>\nIt would be useful to have the option in the job router to edit jobs in place rather than creating a copy of the job.  In this mode, the job router would not continue to manage the job; it just transforms it.  There is no limit on how many times the job may be transformed.  That is left up to the routing logic, which could effect a one-time transformation or periodic transformations as appropriate.\n\n<p>The immediate use-case Brian has in mind is a service that provides scheduling hints to Condor.  It periodically analyzes each job in the queue and provides a hint (as an attribute in the job ad) that could be referenced in the job rank expression to preferentially run the job on machines that are closer to the data files accessed by the job.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-16 07:58:14 by bbockelm:</em> <br/>\n\nHi Dan,\n\n<p>I'm seeing a lot of these errors:\n\n</p><p></p><div class=\"verbatim\">\n<pre>08/16/12 07:54:43 warning: setting UserUid to 30412, was 30728 previously\n08/16/12 07:54:43 JobRouter (src=5748.0,route=Local_Transform): Done editing job.\n08/16/12 07:54:43 warning: setting UserUid to 1999, was 30412 previously\n08/16/12 07:54:43 JobRouter (src=7467.0,route=Local_Transform): Done editing job.\n</pre></div>\n\n\n<p>Looks like the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> is getting confused about UIDs within a loop?\n\n</p><p></p><hr/>\n<em>2012-Aug-16 13:04:11 by danb:</em> <br/>\n\nThe priv switching for edit-in-place happens in push_classad_diff.  I'm struggling to see any case where it would leak the priv state.\n\n<p></p><pre>    priv_state priv = set_user_priv_from_ad(src);\n    success = push_classad_diff_with_current_priv(src,dest,schedd_name,pool_name);\n    set_priv(priv);\n</pre>\n\n<p>I'll give it a test with multiple users and see what I can find.\n\n</p><p></p><hr/>\n<em>2012-Aug-16 14:15:49 by bbockelm:</em> <br/>\n\nHi Dan,\n\n<p>I see this too:\n\n</p><p></p><div class=\"verbatim\">\n<pre>08/16/12 13:03:08 JobRouter (route=Local_Transform): 0 submitted (max 100), 0 idle (max 50), throttle: none, recent stats: 35 started, 35 succeeded, 0 failed.\n08/16/12 13:03:08 warning: setting UserUid to 30279, was 32031 previously\n08/16/12 13:03:08 JobRouter (src=8426.0,route=Local_Transform): Done editing job.\n08/16/12 13:03:18 JobRouter (route=Local_Transform): 0 submitted (max 100), 0 idle (max 50), throttle: none, recent stats: 36 started, 36 succeeded, 0 failed.\n</pre></div>\n\n\n<p>Looking at the strace output, the effective user IDs are handled correctly (i.e., it goes back to user condor between switches).\n\n</p><p>I think set_user_priv_from_ad probably wants to use init_user_ids_quiet, not init_user_ids.  It's complaining about PRIV_USER mapping to different usernames.\n\n</p><p>Brian</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-05 14:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33284\">[33284]</a></span>: formating edit for new edit-in-place job router feature ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3185\" onclick=\"get_ticket_and_populate_wrapper('3185'); return false;\" title=\"allow job router to edit jobs in place\">#3185</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-24 16:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33163\">[33163]</a></span>: Fixed spurious warnings about switching <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserUids\" title=\"User Uids\">UserUids</a></span> in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3185\" onclick=\"get_ticket_and_populate_wrapper('3185'); return false;\" title=\"allow job router to edit jobs in place\">#3185</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-15 11:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33059\">[33059]</a></span>: Fixed a bug in job router edit-in-place mode. Insertion of new attributes did not work. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3185\" onclick=\"get_ticket_and_populate_wrapper('3185'); return false;\" title=\"allow job router to edit jobs in place\">#3185</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-08 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33009\">[33009]</a></span>: New feature in job router: option to edit jobs in place. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3185\" onclick=\"get_ticket_and_populate_wrapper('3185'); return false;\" title=\"allow job router to edit jobs in place\">#3185</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-08 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33010\">[33010]</a></span>: Documented new job router feature: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EditJobInPlace\" title=\"Edit Job In Place\">EditJobInPlace</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3185\" onclick=\"get_ticket_and_populate_wrapper('3185'); return false;\" title=\"allow job router to edit jobs in place\">#3185</a></span> Also removed some now unnecessary verbiage about new classads in the job router configuration syntax description.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Aug-16 14:15", "status": "resolved", "created": "2012-Aug-08 09:44", "fixed_version": "2012-Aug-08 09:44", "broken_version": "v070901", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu,dan@hep.wisc.edu", "due_date": ""}