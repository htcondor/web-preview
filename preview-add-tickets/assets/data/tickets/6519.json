{"id": 6519, "title": "Ticket #6519: Add Managed Instance Group Support to GCE GAHP", "description": "<blockquote>\nAdding managed group instances to GCE GAHP server.  This patch will add two new GAHP commands:\n\n<p></p><ul>\n<li>GCE_GROUP_INSERT : create an instance template and a managed instance group\n</li><li>GCE_GROUP_DELETE : delete aforementioned template and group\n</li></ul>\n\n<p>Specifications are based on previously submitted design doc (ping me for access):\n<a class=\"external\" href=\"https://docs.google.com/document/d/1B2V03lXR9YCgodRsUKdU1hHmbGbiQZAjSqt4rjV-bHY/edit\">https://docs.google.com/document/d/1B2V03lXR9YCgodRsUKdU1hHmbGbiQZAjSqt4rjV-bHY/edit</a>\n\n</p><p>Note that groups created this way last \"forever\".  Functionality to automatically delete the group after a set number of hours is not yet supported.\n\n</p><p>Can be tested by running gce_gahp and then sending the followng text:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">GCE_GROUP_INSERT 1234 https://www.googleapis.com/compute/v1 /&lt;CRED_FILE&gt; &lt;PROJECT&gt; us-central1-a gahp-test n1-highcpu-8 &lt;IMAGE_NAME&gt; NULL NULL true NULL 4 1\nGCE_GROUP_DELETE 1234 https://www.googleapis.com/compute/v1 &lt;CRED_FILE&gt; &lt;PROJECT&gt; us-central1-a gahp-test\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2018-Jan-24 09:33:15 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>I have not read the design document yet. Some of my concerns below may be addressed there.\n\n</p><p>Each of the new gahp commands performs two operations with the server, the creation/deletion of an instanceTemplate and an instanceGroupManager. Some thought needs to go into properly handling this 1-to-2 mapping of operations, particularly with regards to failure.\n\n</p><p>The most immediate problem is that it appears that each gahp command will generate two RESULTS lines, which violates the standard gahp protocol outline. There should only be one RESULTS line that encompasses all of the actions performed for a given gahp command.\n\n</p><p>There's also the issue of what happens when one of the operations fails. The client needs a well-defined recovery path, which can be as simple as make sure everything is deleted and tell the user there was a problem. For example, in GCE_GROUP_INSERT, if the second creation operation fails (instanceGroupManager), can the client retry the gahp command? If so, then the first creation operation (instanceTemplate) on the second attempt shouldn't fail when the resource already exists. If the client instead uses GCE_GROUP_DELETE to clean up the instanceTemplate, the command shouldn't fail because the instanceGroupManager doesn't exist.\n\n</p><p>If these issues are too difficult to work out, one solution is to break these commands apart so that each GCE operation is a separate gahp command.\n\n</p><p>Some of the comments in GceGroupDelete::workerFunction() refer to creation of resources instead of deletion.\n\n</p><p></p><hr/>\n<em>2018-Feb-04 16:20:22 by dstrain:</em> <br/>\n\nHere is a new version.  I have changed the result string to concatenate the two results if there were two operations.\n\n<p>For failure modes, if the first insert succeeds and the second succeeds, the client will need to send a delete to clean up the template.  I believe I have modified the delete to continue if the first delete fails.  i.e. It will attempt to delete both.\n\n</p><p>Is this what you are looking for?  If not, can you clarify the procedure you'd like to implement?  (I don't know if splitting the operations is the best idea.  It will become more complicated in the future, since you will need to create 2 templates [one for instances, and one for timekeeper]).\n\n</p><p></p><hr/>\n<em>2018-Feb-04 16:20:47 by dstrain:</em> <br/>\n\nHere is a new version.  I have changed the result string to concatenate the two results if there were two operations.\n\n<p>For failure modes, if the first insert succeeds and the second succeeds, the client will need to send a delete to clean up the template.  I believe I have modified the delete to continue if the first delete fails.  i.e. It will attempt to delete both.\n\n</p><p>Is this what you are looking for?  If not, can you clarify the procedure you'd like to implement?  (I don't know if splitting the operations is the best idea.  It will become more complicated in the future, since you will need to create 2 templates [one for instances, and one for timekeeper]).\n\n</p><p></p><hr/>\n<em>2018-Mar-28 16:09:53 by jfrey:</em> <br/>\n\nRather than stapling two result messages together with a semicolon, I like something along these lines:\n\n<p>When a GAHP command consists of multiple requests to the service, try each request in sequence. If a request fails, stop and return a failure result with the error message for that request. If all requests succeed, return a success result. In the case of a deletion request, treat an \"object doesn't exist\" error as a success.\n\n</p><p>This gives the client of the gahp a simple recourse for failures: call GCE_GROUP_DELETE until it reports success, optionally ask for intervention from the user.\n\n</p><p></p><hr/>\n<em>2018-Apr-05 18:33:28 by dstrain:</em> <br/>\n\nI have submitted a new patch.  I think this is the error message semantics you want?  If not, please let me know what should be modified.\n\n<p></p><hr/>\n<em>2018-Apr-19 16:49:58 by jfrey:</em> <br/>\n\nThe latest patch is close to the error semantics I have in mind. I'll commit it and then make the changes I think are needed.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/1010/0001-Adding-managed-group-support-to-GCE-GAHP.patch\">0001-Adding-managed-group-support-to-GCE-GAHP.patch</a>\n24931 bytes added by dstrain on 2017-Dec-30 19:07:29 UTC.\n<br/>\nGit patch to add managed group support to GCE GAHP.<br/>\n</li><li><a href=\"attach_get/1013/0001-Adding-managed-group-support-to-GCE-GAHP.patch\">0001-Adding-managed-group-support-to-GCE-GAHP.patch</a>\n20266 bytes added by dstrain on 2018-Feb-04 22:21:15 UTC.\n<br/>\n2nd edition of Managed instance support.<br/>\n</li><li><a href=\"attach_get/1016/0001-Adding-managed-group-support-to-GCE-GAHP.patch\">0001-Adding-managed-group-support-to-GCE-GAHP.patch</a>\n20158 bytes added by dstrain on 2018-Apr-05 23:32:51 UTC.\n<br/>\nNew patch with error message changes.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-20 11:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54778\">[54778]</a></span>: Adjust failure semantics of new gce_gahp group commands. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6519\" onclick=\"get_ticket_and_populate_wrapper('6519'); return false;\" title=\"Add Managed Instance Group Support to GCE GAHP\">#6519</a></span> If the first request to the server fails for these commands, then the failure is returned to the client (without attempting the second request).  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-20 10:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54777\">[54777]</a></span>: Adding managed group support to GCE GAHP. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6519\" onclick=\"get_ticket_and_populate_wrapper('6519'); return false;\" title=\"Add Managed Instance Group Support to GCE GAHP\">#6519</a></span> Add new gahp commands for launching/deleting managed instance groups in GCE. This is intended for use by the Annex. Committer: Jaime Frey  (By Doug Strain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Jul-16 13:51", "status": "resolved", "created": "2017-Dec-30 13:06", "fixed_version": "2017-Dec-30 13:06", "broken_version": "", "priority": "4", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "dstrain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dstrain@google.com", "due_date": ""}