{"id": 2331, "title": "Ticket #2331: Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist", "description": "<blockquote>\nConfiguration in LIGO has DAGMAN_PROHBIT_MULTI_JOBS = True, but this causes subdags to fail.  Is this behavior intentional?  The LIGO user below says the behavior changed between 7.4 and 7.6, but the code would seem to dispute that assertion, as git archaeology says that the code has not changed since 2006.</blockquote>", "remarks": "<blockquote>\n<em>2011-Jul-25 08:57:05 by nwp:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">Date: Fri, 22 Jul 2011 18:35:22 -0400\nFrom: Duncan Brown &lt;dabrown@physics.syr.edu&gt;\nTo: Thomas Dent &lt;Thomas.Dent@astro.cf.ac.uk&gt;\nCc: \"ML:\" &lt;condorligo@aei.mpg.de&gt;\nSubject: [CondorLIGO] LIGO: Major bug in dagman in condor 7.6 series\n\nHi Tom,\n\nI think you have discovered a dagman bug. Lazy planning of subdags no longer works. I created a one-line dag with a sub-dag to test this:\n\n[dbrown@sugar ~]$ cat tom/tom.dag\nSUBDAG EXTERNAL 1 /home/dbrown/tom/dent/dent.dag DIR /home/dbrown/tom/dent\nRETRY 1 3\n\nThe sub-dag is a proper dag containing one job:\n\n[dbrown@sugar ~]$ cat /home/dbrown/tom/dent/dent.dag\nJOB 1 denty.sub\n\n[dbrown@sugar ~]$ cat /home/dbrown/tom/dent/denty.sub\nuniverse = vanilla\nexecutable = /bin/hostname\nlog = /tmp/denty.log\nout = denty.out\nerr = denty.err\nqueue 1\n\nSo this all should work. However, when I submit it, the top-level dag fails with:\n\n07/22/11 18:27:03 Parsing tom.dag ...\n07/22/11 18:27:03 MultiLogFiles::readFileToString: safe_fopen_wrapper(/home/dbrown/tom/dent/dent.dag.condor.sub) failed with errno 2 (No such file or directory)\n07/22/11 18:27:03 MultiLogFiles: Unable to read file: /home/dbrown/tom/dent/dent.dag.condor.sub\n07/22/11 18:27:03 ERROR in MultiLogFiles::getQueueCountFromSubmitFile(): Unable to read file: /home/dbrown/tom/dent/dent.dag.condor.sub\n07/22/11 18:27:03 Aborting DAG...\n07/22/11 18:27:03 Writing Rescue DAG to tom.dag.rescue001...\n\nNow I can't resubmit this dag, as the rescue dag for the *top level dag* is written in the subdir!\n\n[dbrown@sugar tom]$ ls -l\ntotal 18\ndrwxr-xr-x 2 dbrown sufaculty    5 Jul 22 18:27 dent\n-rw-r--r-- 1 dbrown sufaculty   85 Jul 22 18:26 tom.dag\n-rw-r--r-- 1 dbrown sufaculty  972 Jul 22 18:27 tom.dag.condor.sub\n-rw-r--r-- 1 dbrown sufaculty  615 Jul 22 18:27 tom.dag.dagman.log\n-rw-r--r-- 1 dbrown sufaculty 4550 Jul 22 18:27 tom.dag.dagman.out\n-rw-r--r-- 1 dbrown sufaculty    0 Jul 22 18:27 tom.dag.lib.err\n-rw-r--r-- 1 dbrown sufaculty   29 Jul 22 18:27 tom.dag.lib.out\n[dbrown@sugar tom]$ ls -l dent/\ntotal 5\n-rw-r--r-- 1 dbrown sufaculty  16 Jul 22 18:22 dent.dag\n-rw-r--r-- 1 dbrown sufaculty 107 Jul 22 18:22 denty.sub\n-rw-r--r-- 1 dbrown sufaculty 193 Jul 22 18:27 tom.dag.rescue001\n\n[dbrown@sugar tom]$ condor_submit tom.dag\nSubmitting job(s)\nERROR: Failed to parse command file (line 1).\n[dbrown@sugar tom]$ condor_submit_dag tom.dag\n\nERROR: \"tom.dag.condor.sub\" already exists.\nERROR: \"tom.dag.lib.out\" already exists.\nERROR: \"tom.dag.lib.err\" already exists.\nERROR: \"tom.dag.dagman.log\" already exists.\n\nSome file(s) needed by condor_dagman already exist.  Either rename them,\nuse the \"-f\" option to force them to be overwritten, or use\nthe \"-update_submit\" option to update the submit file and continue.\n\nThis all matches exactly what you've seen with your dags. This problem exists with 7.6.1 and 7.6.2\n\n07/22/11 18:27:02 ** $CondorVersion: 7.6.2 Jul 14 2011 BuildID: 351672 $\n\nSo we're stuck until Kent fixes it and Stuart upgrades condor.\n\nCheers,\nDuncan.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Jul-25 08:59:04 by nwp:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">Date: Sun, 24 Jul 2011 19:55:00 -0700\nFrom: Duncan Brown &lt;dabrown@physics.syr.edu&gt;\nTo: Nathan Panike &lt;nwp@cs.wisc.edu&gt;\nCc: Thomas Dent &lt;Thomas.Dent@astro.cf.ac.uk&gt;, \"ML:\" &lt;condorligo@aei.mpg.de&gt;\nSubject: Re: [CondorLIGO] LIGO: Major bug in dagman in condor 7.6 series\n\nHi Nathan,\n\nOn Jul 24, 2011, at 7:43 PM, Nathan Panike wrote:\n\n&gt; I looked at this this evening.\n\nThanks for taking a look at this.\n\n&gt; This is 7.6.x---for the example below, would you please look at\n&gt; dent.dag.dagman.out and at tom.dag.dagman.out and look for the value of\n&gt; DAGMAN_PROHIBIT_MULTI_JOBS in each file.\n\nFor both of these, it is true:\n\n07/22/11 18:27:03 DAGMAN_PROHIBIT_MULTI_JOBS setting: True\n\n\n&gt;  For subdags to work, this value must\n&gt; be false, and all 7.6 versions of condor_dagman will print the value of this\n&gt; configuration variable.\n\nIs that a desired behavior change from 7.4 -&gt; 7.6? We have had this variable set to True in the past to prevent dagman from submitting jobs that have queue values greater than 1 in their submit files. I believe\n+this is the desired behavior of the variable. I don't think this variable should control sub-dag submission behavior.\n\n&gt;  If it is true, then condor_dagman is getting it from a\n&gt; config file somewhere.\n\nIt's coming from the condor_config.local I inherited from Stuart at Caltech:\n\n# Prohibit condor_dagman from running a DAG that references node job submit\n# files that queue multiple jobs (other than parallel universe).\nDAGMAN_PROHIBIT_MULTI_JOBS = True\n\n&gt;  The solution is to have a CONFIG directive in your\n&gt; toplevel dag(s) that points to a config file that explicitly specifies\n&gt;\n&gt; \"DAGMAN_PROHIBIT_MULTI_JOBS = False\"\n&gt;\n&gt; The only way I have successfully reproduced the behavior below here on 7.6 is\n&gt; by setting the config directive above to True.\n\nI can try it with the value set to false, but still claim that this needs to be fixed in dagman. We can't go back and edit all our DAGs (which are in various states of progress) to change this, and having\n+DAGMAN_PROHIBIT_MULTI_JOBS prevent lazy planning of sub-dags must be a bug, or no? It's certainly not the documented behavior.\n\nCheers,\nDuncan.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Aug-09 10:56:00 by wenger:</em> <br/>\n\nAh, it's entirely accidental that DAGMAN_PROHIBIT_MULTI_JOBS doesn't work with sub-DAGs.  I looked at the code, and I think when we added the DAGMAN_PROHIBIT_MULTI_JOBS check we just forgot about sub-DAGs.  I suspect that this check will also fail with lazily-created submit files for \"regular\" jobs.  So the real solution is to move the check out of the Job() constructor and put it in just before the job is actually submitted.  (Of course, that means that if you <strong>don't</strong> lazily create your submit files, you won't get the error when you first submit the DAG...).\n\n<p></p><hr/>\n<em>2011-Aug-09 13:38:34 by wenger:</em> <br/>\n\nHmm -- it just occurred to me that we should turn on DAGMAN_PROHIBIT_MULTIPLE_JOBS in some of the DAGMan tests.  Very few of them actually use multi-job nodes, so we should be able to turn this on without affecting the tests, once the bug if fixed...\n\n<p></p><hr/>\n<em>2011-Aug-15 16:14:29 by nwp:</em> <br/>\n\nI pushed code for this on <code>V7_6-subdags_not_count_as_multi_job-branch</code>.  I am running the test suite in NMI now.  Setting this to review for Kent\n\n<p></p><hr/>\n<em>2011-Aug-16 11:45:39 by nwp:</em> <br/>\n\nThis has been merged to <code>7_6-branch</code>.  The fix will be in 7.6.3.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/421/prohibit-patch\">prohibit-patch</a>\n2015 bytes added by nwp on 2011-Jul-26 10:57:33 UTC.\n<br/>\nPatch to fix this issue: patch applies to V7_6-branch at bcd8170.  We add a new flag to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AddNode\" title=\"Add Node\">AddNode</a></span>, so that the Job can tell we are adding a subdag and ignores\nthe DAGMAN_PROHIBIT_MULTI_JOBS config setting.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26858\">[26858]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2331\" onclick=\"get_ticket_and_populate_wrapper('2331'); return false;\" title=\"Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist\">#2331</a></span> code review/cleanup: renamed some test files to better match usual conventions; moved the multi-job check to just before submission so that DAGMAN_PROHIBIT_MULTI_JOBS works with lazy submit file creation. Also created lazy submit file test (gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2031\" onclick=\"get_ticket_and_populate_wrapper('2031'); return false;\" title=\"Create lazy submit file creation test\">#2031</a></span>).  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-16 11:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26802\">[26802]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=26779\">[26779]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26780\">[26780]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26801\">[26801]</a></span>, Merge branch 'V7_6-subdags_not_count_as_multi_job-branch' into V7_6-branch This series is to fix <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2331\" onclick=\"get_ticket_and_populate_wrapper('2331'); return false;\" title=\"Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist\">#2331</a></span> Conflicts: doc/version-history/7-6.history.tex  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-16 09:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26801\">[26801]</a></span>: Add tests to src/condor_tests/CMakeLists.txt ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2331\" onclick=\"get_ticket_and_populate_wrapper('2331'); return false;\" title=\"Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist\">#2331</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-15 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26780\">[26780]</a></span>: Update the version history ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2331\" onclick=\"get_ticket_and_populate_wrapper('2331'); return false;\" title=\"Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist\">#2331</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-15 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26779\">[26779]</a></span>: Add tests to make sure we do not lose the ability to run subDAGs ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2331\" onclick=\"get_ticket_and_populate_wrapper('2331'); return false;\" title=\"Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist\">#2331</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-15 16:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26778\">[26778]</a></span>: Add an argument to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AddNode\" title=\"Add Node\">AddNode</a></span> to indicate whether it is a subDAG ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2331\" onclick=\"get_ticket_and_populate_wrapper('2331'); return false;\" title=\"Subdags and DAGMAN_PROHIBIT_MULTI_JOBS do not coexist\">#2331</a></span> This seems to fix a problem noted by LIGO.  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jan-29 13:58", "status": "defer", "created": "2011-Jul-25 08:50", "fixed_version": "2011-Jul-25 08:50", "broken_version": "v070601", "priority": "5", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "nwp", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "wenger@cs.wisc.edu,dabrown@physics.syr.edu,thomas.dent@astro.cf.ac.uk,pcouvare@caltech.edu", "due_date": ""}