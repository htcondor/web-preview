{"id": 4483, "title": "Ticket #4483: Remove GSI libraries from the shadow", "description": "<blockquote>\nThe GSI libraries add about 100kB of memory to every process that links to them. If any GSI functions are called, even more memory is used. This presents a scalability problem for the condor_shadow, which almost never needs to use GSI.\n\n<p>To remove GSI memory overhead from the shadow on linux, we plan to do the following:\n</p><ul>\n<li>Don't link the condor_utils library against the GSI and VOMS libraries. Instead, dlopen() those libraries whenever they're needed.\n</li><li>When the shadow needs to do something with the job's proxy certificate, have it fork a child process, which does the work and reports the results.\n</li></ul>\n\n<p>With these changes and setting SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION=True, the shadow will never have the GSI libraries loaded and can avoid the associated memory overhead.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-23 20:31:53 by bbockelm:</em> <br/>\n\nPLEASE don't work on this ticket until someone reviews <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>.  Having non-blocking GSI is very important to CMS and I suspect this might cause massive merge conflicts.\n\n<p></p><hr/>\n<em>2014-Jul-24 10:36:09 by jfrey:</em> <br/>\n\nI already have a bunch of code for this ticket, but I'll hold off on committing it. Merging it into the non-blocking GSI authentication changes will be easier than the reverse.\n\n<p></p><hr/>\n<em>2014-Aug-12 16:41:03 by jfrey:</em> <br/>\n\nThe code for this ticket is on master-gt4483-dlopen_gsi-branch.\n\n<p></p><hr/>\n<em>2014-Aug-20 15:09:21 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>:  Jaime's code looks good, with one caveat.  Per discussion with Jaime, we decided to hard-code the library version to avoid pulling in the wrong version which could have a different and lead to memory corruption.  However, hard-coding these will not (always) work in proper builds, so we don't use dlopen for proper builds.  Now Jaime should review my changes.\n\n<p></p><hr/>\n<em>2014-Sep-10 10:12:05 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Zach's changes look good. For a future release, we should attempt to determine the SO versions of the GSI libraries automatically at build time.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4585\" onclick=\"get_ticket_and_populate_wrapper('4585'); return false;\" title=\"Detect SO version of libraries we dlopen() at compile time\">#4585</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDetect SO version of libraries we dlopen() at compile time</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-10 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41140\">[41140]</a></span>: exceptionally minor 8.3.1 version history item edit. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-10 13:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41136\">[41136]</a></span>: Docs for dlopen'ing GSI libraries on demand. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-20 15:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41008\">[41008]</a></span>: Be less specific about the GSI .so version numbers. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-20 15:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41006\">[41006]</a></span>: Only use dlopen for GSI on non-proper builds, since we hard-coded the .so versions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-20 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41005\">[41005]</a></span>: For now, put the explicit .so version numbers into the GSI dlopen code so we don't accidentally pull in the wrong one. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-12 15:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40952\">[40952]</a></span>: Do job proxy operations in a child process of the shadow on linux. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span> We want to avoid loading the GSI libraries in the shadow process. Thus, when we need to read the job proxy, fork a quick child process to do the actual operations. The results of the operation are sent to the main shadow process\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-12 15:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40951\">[40951]</a></span>: dlopen() the GSI libraries on linux. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span> Instead of linking against the GSI libraries for Condor executables, we now dlopen() them on demand. All calls to GSI libraries are now done via function pointers, which are set by activate_globus_gsi(). If activate_globus_gsi() returns failure, we must be careful\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-29 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40799\">[40799]</a></span>: Consolidate Globus module activation. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4483\" onclick=\"get_ticket_and_populate_wrapper('4483'); return false;\" title=\"Remove GSI libraries from the shadow\">#4483</a></span>  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Sep-10 13:59", "status": "resolved", "created": "2014-Jul-23 16:31", "fixed_version": "2014-Jul-23 16:31", "broken_version": "v080200", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4405", "creator": "zmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}