{"id": 6454, "title": "Ticket #6454: copy_to_spool does useless extra copies of executable over the network", "description": "<blockquote>\nWhen <code>copy_to_spool</code> is set to <code>True</code> in the submit file, condor_submit tries to send the executable file over the network to the schedd once for each job in the cluster, when it only needs to do so once for the whole cluster. The schedd can say \"no need\", but it stupidly tells submit to send it each time. The schedd also logs the following errors in its log for every transfer after the first:\n\n<p></p><div class=\"verbatim\">\n<pre>10/17/17 14:35:48 ickpt_share: unexpected error linking /Users/jfrey/condor/test/spool/973/cluster973.ickpt.subproc0 to /Users/jfrey/condor/test/spool/exe-jfrey-CmdMD5-1bfa1384e9f3c65c96fd8d20e589b1ed: File exists\n10/17/17 14:35:48 ickpt_share: unexpected error linking /Users/jfrey/condor/test/spool/exe-jfrey-CmdMD5-1bfa1384e9f3c65c96fd8d20e589b1ed to /Users/jfrey/condor/test/spool/973/cluster973.ickpt.subproc0: File exists\n</pre></div>\n\n\n<p>Both sides can do this more intelligently. Submit can offer to send the executable only once per cluster. The schedd can tell submit to not bother if a copy of the executable for that job cluster already exists.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-19 15:18:08 by jfrey:</em> <br/>\n\nWe'll delay improvements on the submit side to the development series (8.7).\n\n<p></p><hr/>\n<em>2017-Oct-19 15:56:52 by jfrey:</em> <br/>\n\nCommit <span class=\"chng\"><a href=\"chngview?cn=52615\">[52615]</a></span> belongs under ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6459\" onclick=\"get_ticket_and_populate_wrapper('6459'); return false;\" title=\"Submit shouldn't spool executable multiple times for same cluster\">#6459</a></span>, and was committed to the master branch (8.7.x).\n\n<p></p><hr/>\n<em>2017-Oct-26 14:54:45 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : stable branch changes look good.\n\n<p></p><hr/>\n<em>2017-Oct-28 18:50:04 by tim:</em> <br/>\n\n<strong>Doc Review:</strong> I add version history for Jaime.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6459\" onclick=\"get_ticket_and_populate_wrapper('6459'); return false;\" title=\"Submit shouldn't spool executable multiple times for same cluster\">#6459</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSubmit shouldn't spool executable multiple times for same cluster</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-27 21:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52695\">[52695]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6431\" onclick=\"get_ticket_and_populate_wrapper('6431'); return false;\" title=\"slurm_status.py script misparses memory usage field\">#6431</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6454\" onclick=\"get_ticket_and_populate_wrapper('6454'); return false;\" title=\"copy_to_spool does useless extra copies of executable over the network\">#6454</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-19 15:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52615\">[52615]</a></span>: Submit should spool executable only once per cluster. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6454\" onclick=\"get_ticket_and_populate_wrapper('6454'); return false;\" title=\"copy_to_spool does useless extra copies of executable over the network\">#6454</a></span> When copy_to_spool is set to True, condor_submit now sends the executable once per cluster, instead of once per job. Since a spooled executable is shared across a job cluster, sending it once per job is unnecessary and wasteful.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-19 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52613\">[52613]</a></span>: Improve cleanup when ReliSock::get_file() reports failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6454\" onclick=\"get_ticket_and_populate_wrapper('6454'); return false;\" title=\"copy_to_spool does useless extra copies of executable over the network\">#6454</a></span> When ReliSock::get_file() reports an error due to close() failing, it now tries to remove the relevant file. This makes its behavior on error more consistent (always tries to remove the file).  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-19 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52614\">[52614]</a></span>: Schedd should decline executable spooling if file already exists. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6454\" onclick=\"get_ticket_and_populate_wrapper('6454'); return false;\" title=\"copy_to_spool does useless extra copies of executable over the network\">#6454</a></span> When copy_to_spool is set to true in the submit file, condor_submit attempts to send the executable to the schedd once for every job. Since the spooled executable is shared across all jobs within a cluster, this can result in many\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Oct-28 18:50", "status": "resolved", "created": "2017-Oct-17 15:16", "fixed_version": "2017-Oct-17 15:16", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}