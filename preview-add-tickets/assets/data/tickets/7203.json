{"id": 7203, "title": "Ticket #7203: Starter crashes if preempted during file xfer in", "description": "<blockquote>\nIf the starter is transferring the sandbox into the scratch dir during startup, and the job is preempted, say with a condor_vacate -fast slot_name, the starter crashes during exit with the following stack trace:  The problem is that the daemon_core singleton object is getting nulled out, but the file_transfer destructor is dereferencing it.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">08/12/19 15:01:47 ERROR \"Assertion ERROR on (daemonCore)\" at line 4358 in file /nobackup/gthain/CONDOR_SRC/src/condor_utils/file_transfer.cpp\n/slots/20/dir_3988059/userdir/.tmpW03mEZ/BUILD/condor-8.9.2/src/condor_utils/file_transfer.cpp\nCaught signal 6: si_code=4294967290, si_pid=9778, si_uid=0, si_addr=0x2632\nStack dump for process 9778 at timestamp 1565114067 (28 frames)\n/usr/lib64/libcondor_utils_8_9_2.so(dprintf_dump_stack+0x24)[0x7fc454038694]\n/usr/lib64/libcondor_utils_8_9_2.so(_Z17unix_sig_coredumpiP9siginfo_tPv+0x69)[0x7fc4541f3499]\n/usr/lib64/libpthread.so.0(+0xf5d0)[0x7fc4526f05d0]\n/usr/lib64/libc.so.6(gsignal+0x37)[0x7fc45234a207]\n/usr/lib64/libc.so.6(abort+0x148)[0x7fc45234b8f8]\n/usr/lib64/libcondor_utils_8_9_2.so(_EXCEPT_+0x135)[0x7fc4540153c5]\n/usr/lib64/libcondor_utils_8_9_2.so(+0x1bc08b)[0x7fc45406c08b]\n/usr/lib64/libcondor_utils_8_9_2.so(_ZN12FileTransfer10stopServerEv+0x16)[0x7fc45406c0a6]\n/usr/lib64/libcondor_utils_8_9_2.so(_ZN12FileTransferD1Ev+0x202)[0x7fc45406dcf2]\n/usr/lib64/libcondor_utils_8_9_2.so(_ZN12FileTransferD0Ev+0x9)[0x7fc45406df39]\ncondor_starter(_ZN9JICShadowD2Ev+0x90)[0x429c90]\ncondor_starter(_ZN9JICShadowD0Ev+0x9)[0x429e39]\ncondor_starter(_ZN8CStarterD2Ev+0x3d)[0x46151d]\n/usr/lib64/libc.so.6(+0x39b69)[0x7fc45234db69]\n/usr/lib64/libc.so.6(+0x39bb7)[0x7fc45234dbb7]\n/usr/lib64/libcondor_utils_8_9_2.so(__wrap_exit+0x65)[0x7fc4541c31b5]\n/usr/lib64/libcondor_utils_8_9_2.so(_Z7DC_ExitiPKc+0x1d9)[0x7fc4541f3f69]\ncondor_starter[0x462843]\ncondor_starter(_ZN8CStarter11cleanupJobsEv+0x93)[0x4619d3]\ncondor_starter(_ZN8CStarter14transferOutputEv+0x113)[0x464d63]\ncondor_starter(_ZN8CStarter11allJobsDoneEv+0xa4)[0x461ab4]\ncondor_starter(_ZN8CStarter22RemoteShutdownGracefulEi+0x3c)[0x46144c]\ncondor_starter(_Z22main_shutdown_gracefulv+0x16)[0x446216]\n/usr/lib64/libcondor_utils_8_9_2.so(_Z17handle_dc_sigtermP7Servicei+0x97)[0x7fc4541f3817]\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Dec-06 12:39:44 by tannenba:</em> <br/>\n\nLooks like this is still happening with HTCondor v8.9.4, and also happens during transfer output.  One of our CHTC execute nodes had 35 condor_starter core files from the past week!\n\n<p>Another stack backtrace is below.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">Program terminated with signal 6, Aborted.\n#0  0x00007f1d67fc2607 in kill () from /usr/lib64/libc.so.6\nMissing separate debuginfos, use: debuginfo-install glibc-2.17-292.el7.x86_64 libgcc-4.8.5-39.el7.x86_64 libgomp-4.8.5-39.el7.x86_64 libstdc++-4.8.5-39.el7.x86_64 openssl-libs-1.0\n2k-19.el7.x86_64 pcre-8.32-17.el7.x86_64 zlib-1.2.7-18.el7.x86_64\n(gdb) bt\n#0  0x00007f1d67fc2607 in kill () from /usr/lib64/libc.so.6\n#1  0x00007f1d69e71aa4 in unix_sig_coredump (signum=6, s_info=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core_main.cpp:1295\n#2  &lt;signal handler called&gt;\n#3  0x00007f1d67fc2337 in raise () from /usr/lib64/libc.so.6\n#4  0x00007f1d67fc3a28 in abort () from /usr/lib64/libc.so.6\n#5  0x00007f1d69d87275 in _EXCEPT_ (fmt=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_utils/except.cpp:97\n#6  0x00007f1d69d196cb in FileTransfer::abortActiveTransfer (this=0xa59b20) at /usr/src/debug/condor-8.9.4/src/condor_utils/file_transfer.cpp:4596\n#7  0x00007f1d69d196e6 in FileTransfer::stopServer (this=this@entry=0xa59b20) at /usr/src/debug/condor-8.9.4/src/condor_utils/file_transfer.cpp:4574\n#8  0x00007f1d69d1b432 in FileTransfer::~FileTransfer (this=0xa59b20, __in_chrg=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_utils/file_transfer.cpp:284\n#9  0x00007f1d69d1b679 in FileTransfer::~FileTransfer (this=0xa59b20, __in_chrg=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_utils/file_transfer.cpp:296\n#10 0x0000000000448ae0 in JICShadow::~JICShadow (this=0xa2f1e0, __in_chrg=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/jic_shadow.cpp:147\n#11 0x0000000000448c89 in JICShadow::~JICShadow (this=0xa2f1e0, __in_chrg=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/jic_shadow.cpp:160\n#12 0x00000000004294bd in CStarter::~CStarter (this=0x6b2820 &lt;StarterObj&gt;, __in_chrg=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/baseStarter.cpp:105\n#13 0x00007f1d67fc5c99 in __run_exit_handlers () from /usr/lib64/libc.so.6\n#14 0x00007f1d67fc5ce7 in exit () from /usr/lib64/libc.so.6\n#15 0x00007f1d69e8ecd5 in __wrap_exit (status=0) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core.cpp:5527\n#16 0x00007f1d69e730c9 in DC_Exit (status=status@entry=0, shutdown_program=shutdown_program@entry=0x0)\n    at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core_main.cpp:868\n#17 0x000000000042aee3 in CStarter::StarterExit (this=0x6b2820 &lt;StarterObj&gt;, code=0) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/baseStarter.cpp:274\n#18 0x0000000000429973 in CStarter::cleanupJobs (this=0x6b2820 &lt;StarterObj&gt;) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/baseStarter.cpp:3042\n#19 0x000000000042dbcb in CStarter::transferOutput (this=0x6b2820 &lt;StarterObj&gt;) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/baseStarter.cpp:3014\n#20 0x0000000000429a54 in CStarter::allJobsDone (this=0x6b2820 &lt;StarterObj&gt;) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/baseStarter.cpp:2949\n#21 0x0000000000428f4e in CStarter::remoteHoldCommand (this=0x6b2820 &lt;StarterObj&gt;, s=0xa5d9a0) at /usr/src/debug/condor-8.9.4/src/condor_starter.V6.1/baseStarter.cpp:1725\n#22 0x00007f1d69e99c8a in DaemonCore::CallCommandHandler (this=0x9e4180, req=1500, stream=0xa5d9a0, delete_stream=delete_stream@entry=false,\n    check_payload=check_payload@entry=true, time_spent_on_sec=0.000551000005, time_spent_waiting_for_payload=time_spent_waiting_for_payload@entry=0)\n    at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core.cpp:4442\n#23 0x00007f1d69e88ee1 in DaemonCommandProtocol::ExecCommand (this=0xa598f0) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_command.cpp:1719\n#24 0x00007f1d69e8aae5 in DaemonCommandProtocol::doProtocol (this=this@entry=0xa598f0) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_command.cpp:169\n#25 0x00007f1d69e8abe5 in DaemonCommandProtocol::SocketCallback (this=this@entry=0xa598f0, stream=0xa5d9a0)\n    at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_command.cpp:232\n#26 0x00007f1d69e9b344 in DaemonCore::CallSocketHandler_worker (this=0x9e4180, i=3, default_to_HandleCommand=&lt;optimized out&gt;, asock=&lt;optimized out&gt;)\n    at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core.cpp:4209\n#27 0x00007f1d69e9b3fd in DaemonCore::CallSocketHandler_worker_demarshall (arg=0xa50d60) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core.cpp:4168\n#28 0x00007f1d69d372f5 in CondorThreads::pool_add (routine=routine@entry=0x7f1d69e9b3e0 &lt;DaemonCore::CallSocketHandler_worker_demarshall(void*)&gt;, arg=arg@entry=0xa50d60,\n    tid=&lt;optimized out&gt;, descrip=&lt;optimized out&gt;) at /usr/src/debug/condor-8.9.4/src/condor_utils/condor_threads.cpp:1108\n#29 0x00007f1d69e972d7 in DaemonCore::CallSocketHandler (this=this@entry=0x9e4180, i=@0x7fff52109708: 3, default_to_HandleCommand=default_to_HandleCommand@entry=true)\n    at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core.cpp:4156\n#30 0x00007f1d69ea0a4e in DaemonCore::Driver (this=0x9e4180) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core.cpp:3993\n#31 0x00007f1d69e762e2 in dc_main (argc=2, argv=0x7fff52109fe0) at /usr/src/debug/condor-8.9.4/src/condor_daemon_core.V6/daemon_core_main.cpp:4236\n#32 0x00007f1d67fae505 in __libc_start_main () from /usr/lib64/libc.so.6\n#33 0x0000000000424b37 in _start ()\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Dec-09 09:39:07 by gthain:</em> <br/>\n\nNote this doesn't happen in 8.9.5.  I haven't tracked down which change fixed this, might have been one of the coverity-found fixes.\n\n<p>Also, with the exception of the core files, this bug has no user-visible impacts -- the core is generated as the starter is exit'ing, and the job has already completed normally.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "defect", "last_change": "2019-Dec-23 13:22", "status": "abandoned", "created": "2019-Aug-12 15:05", "fixed_version": "2019-Aug-12 15:05", "broken_version": "v080902", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}