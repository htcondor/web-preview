{"id": 6608, "title": "Ticket #6608: Malformed XferStatsLog records - multiple job ids in same record", "description": "<blockquote>\nUsers have <a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2018-March/msg00061.shtml\">reported malformed XferStatsLog records</a>.  Specifically, there are multiple job ids in same record ?!?  Behold this line from a CHTC submit server:\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \n   03/15/18 14:24:00 (D_STATS) (55363701.8437) (2405608): (peer stats from starter): 03/15/18 14:24:01 (D_STATS) (55372299.226) (2382515): (peer stats from starter): File Transfer Upload: JobId: 55372299.226 files: 2 bytes: 86403 seconds: 2658.14 dest: 128.xxx.xxx.xxx rto: 201000 ato: 40000 snd_mss: 1448 rcv_mss: 536 unacked: 0 sacked: 0 lost: 0 retrans: 0 fackets: 0 pmtu: 1500 rcv_ssthresh: 29200 rtt: 226 snd_ssthresh: 20 snd_cwnd: 21 advmss: 1448 reordering: 3 rcv_rtt: 0 rcv_space: 29200 total_retrans: 0\n</td></tr></tbody></table></div>\n\n\n<p>It almost looks as if records are being overlapped, but this should not be happening assuming the condor_shadow is writing this status line in one call to dprintf ever since ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=1707\" title=\"improve scalability of shadow logging\">#1707</a></span>.  Recall <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=1707\" title=\"improve scalability of shadow logging\">#1707</a></span> changed things so log messages are written with one call to write(), which POSIX claims will be atomic on files opened with O_APPEND.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-15 15:52:23 by johnkn:</em> <br/>\n\nthis code:\n<div class=\"snip\">\n<pre class=\"sniplabel\">jic_shadow.cpp </pre>\n<pre class=\"snip\">const char *stats = m_ft_info.tcp_stats.c_str();\nstd::string full_stats = \"(peer stats from starter): \";\nfull_stats += stats;\n\nASSERT( !shadowDisconnected() );\n\nif (shadow_version &amp;&amp; shadow_version-&gt;built_since_version(8, 5, 8)) {\n\tREMOTE_CONDOR_dprintf_stats(full_stats.c_str());\n}\n</pre></div>\n\n\n<p>Will end up printing a line with no \\n if tcp_stats is empty, which it will be if there was were no files to transfer.\n\n</p><p></p><hr/>\n<em>2018-Mar-15 17:31:11 by tannenba:</em> <br/>\n\nConflicts merging this v8.6 patch over to the master.  I resolved them in <span class=\"chng\"><a href=\"chngview?cn=54529\">[54529]</a></span>, but Greg please make sure I did it correctly.\n\n<p></p><hr/>\n<em>2018-May-02 11:33:41 by jpatton:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-04 13:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54848\">[54848]</a></span>: Revert \"Documnet <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6608\" title=\"Malformed XferStatsLog records - multiple job ids in same record\">#6608</a></span>\" This reverts commit 59a354b794ee51cb22c4f8c786667fee51bea88b.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-17 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54744\">[54744]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6608\" title=\"Malformed XferStatsLog records - multiple job ids in same record\">#6608</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-15 17:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54529\">[54529]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=52958\">[52958]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52961\">[52961]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52964\">[52964]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52967\">[52967]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52968\">[52968]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52969\">[52969]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52984\">[52984]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52985\">[52985]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52986\">[52986]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52987\">[52987]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52988\">[52988]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52989\">[52989]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52990\">[52990]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52992\">[52992]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52995\">[52995]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52996\">[52996]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52997\">[52997]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52999\">[52999]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53000\">[53000]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53018\">[53018]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53019\">[53019]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53021\">[53021]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53023\">[53023]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53025\">[53025]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53027\">[53027]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53046\">[53046]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53047\">[53047]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53079\">[53079]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53083\">[53083]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53099\">[53099]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53100\">[53100]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53109\">[53109]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=53111\">[53111]</a></span>,\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-15 16:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54525\">[54525]</a></span>: Fix bug in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=XferStatsLog\" title=\"Xfer Stats Log\">XferStatsLog</a></span> that would interleave output messages <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6608\" title=\"Malformed XferStatsLog records - multiple job ids in same record\">#6608</a></span> Only happens when there are no files to transfer in either direction.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-May-02 11:34", "status": "resolved", "created": "2018-Mar-15 14:36", "fixed_version": "2018-Mar-15 14:36", "broken_version": "v080600", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "gthain", "derived_from": "#5917", "creator": "tannenba", "rust": "", "customer_group": "users", "visibility": "public", "notify": "georgpap@isi.edu, tannenba@cs.wisc.edu, jpatton@cs.wisc.edu", "due_date": ""}