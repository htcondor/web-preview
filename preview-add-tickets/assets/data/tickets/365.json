{"id": 365, "title": "Ticket #365: gcb_relay_server leaves connections to down machine ESTABLISHED", "description": "<blockquote>\natlas-gcb03 was acting as a GCB broker for macaroni02.  macaroni02 went down, probably suddenly, probably 5 or 6 days ago.  Today, a bunch of jobs in a user install of Condor on newbio were found \"running\" for 6 days (in excess of how long the job can plausibly run).  They were all \"running\" on macaroni02, multiple jobs claiming to have each slow.  The shadows had ESTABLISHED connections to the relay server.  The server claimed to have ESTABLISHED connections to macaroni02.  The relay server appeared to be hanging out in select() when debugged.  It looks like as many as 20 jobs, including some from non-newbio machines, were involved.\n\n<p></p><ul>\n<li>Hypothesis 1: connections opened by GCB lack SO_KEEPALIVE.  The shadow and the relay server were waiting for data to arrive from macaroni02.  Since macaroni02 wasn't around, the absence of data was interpreted as a quiet connection.  (Will this ever time out?)\n\n<p></p><ul>\n<li>Possible fix: Add SO_KEEPALIVE to the connection?  Should kill a dead connection within a few hours.\n</li></ul>\n\n<p></p></li><li>Hypothesis 2, from Pete: Pete has seen exactly this sort of behavior without GCB involved about a year ago.  The problem was a wonky router that was erroneously reporting that the connection was still valid.\n</li></ul>\n\n<p>Unresolved problems:\n\n</p><p></p><ul>\n<li>How did multiple jobs end up believing they were claiming the same slot?  Perhaps the machine cycled down and up repeatedly for a while.\n</li></ul>\n\n<p>\"ps -efwww\" on atlas-gcb03:\n</p><div class=\"code\">\n<pre class=\"code\">gcb       2515     1  0 Feb19 ?        00:00:00 /home/gcb/bin/gcb_master -i 198.51.254.85 -f /home/gcb/log/master_logfile -l /home/gcb/log/broker_logfile -d fulldebug -b /home/gcb/bin/gcb_broker -r /home/gcb/bin/gcb_relay_server\ngcb       2521  2515  0 Feb19 ?        00:00:22 /home/gcb/bin/gcb_broker -i 198.51.254.85 -l /home/gcb/log/broker_logfile -d fulldebug -r /home/gcb/bin/gcb_relay_server\ngcb       2535  2521  0 Feb19 ?        04:24:03 /home/gcb/bin/gcb_relay_server -i 198.51.254.85 -p 32769\n</pre></div>\n\n\n<p>\"lsof -p 2535 | grep macaroni02\" on atlas-gcb03:\n</p><div class=\"code\">\n<pre class=\"code\">gcb_relay 2535  gcb   65u  IPv4 661018             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:33875 (ESTABLISHED)\ngcb_relay 2535  gcb   67u  IPv4 661021             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:33877 (ESTABLISHED)\ngcb_relay 2535  gcb   69u  IPv4 661024             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:33879 (ESTABLISHED)\ngcb_relay 2535  gcb   71u  IPv4 661027             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:33881 (ESTABLISHED)\ngcb_relay 2535  gcb   98u  IPv4 672716             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:37761 (ESTABLISHED)\ngcb_relay 2535  gcb   99u  IPv4 672714             TCP agt-c019.cs.wisc.edu:50058-&gt;macaroni02.cs.wisc.edu:50531 (ESTABLISHED)\ngcb_relay 2535  gcb  155u  IPv4 672719             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:37763 (ESTABLISHED)\ngcb_relay 2535  gcb  162u  IPv4 670417             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:50739 (ESTABLISHED)\ngcb_relay 2535  gcb  166u  IPv4 672732             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:37767 (ESTABLISHED)\ngcb_relay 2535  gcb  167u  IPv4 672730             TCP agt-c019.cs.wisc.edu:50061-&gt;macaroni02.cs.wisc.edu:54678 (ESTABLISHED)\ngcb_relay 2535  gcb  169u  IPv4 669306             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:41650 (ESTABLISHED)\ngcb_relay 2535  gcb  171u  IPv4 669309             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:41652 (ESTABLISHED)\ngcb_relay 2535  gcb  175u  IPv4 672735             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:37769 (ESTABLISHED)\ngcb_relay 2535  gcb  177u  IPv4 670420             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:50741 (ESTABLISHED)\ngcb_relay 2535  gcb  181u  IPv4 669674             TCP agt-c019.cs.wisc.edu:49608-&gt;macaroni02.cs.wisc.edu:43397 (ESTABLISHED)\ngcb_relay 2535  gcb  182u  IPv4 669679             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:45476 (ESTABLISHED)\ngcb_relay 2535  gcb  183u  IPv4 669677             TCP agt-c019.cs.wisc.edu:49609-&gt;macaroni02.cs.wisc.edu:36486 (ESTABLISHED)\ngcb_relay 2535  gcb  185u  IPv4 669682             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:45478 (ESTABLISHED)\ngcb_relay 2535  gcb  187u  IPv4 669685             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:45480 (ESTABLISHED)\ngcb_relay 2535  gcb  189u  IPv4 669688             TCP agt-c019.cs.wisc.edu:32769-&gt;macaroni02.cs.wisc.edu:45482 (ESTABLISHED)\n</pre></div>\n\n\n<p>Additional logs and output are available at /p/condor/workspaces/adesmet/trac-files/365</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Nov-09 16:48:37 by adesmet:</em> <br/>\n\nGCB is dead.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "defect", "last_change": "2011-Nov-21 15:58", "status": "abandoned", "created": "2009-Apr-06 16:32", "fixed_version": "2009-Apr-06 16:32", "broken_version": "", "priority": "4", "subsystem": "GCB", "assigned_to": "", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}