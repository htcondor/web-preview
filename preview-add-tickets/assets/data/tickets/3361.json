{"id": 3361, "title": "Ticket #3361: MPI Parallel Universe jobs fail when USE_NFS=True", "description": "<blockquote>\nWhen running an OpenMPI job with <code>USE_NFS=True</code>, the job never runs and we have a shadow exception.\n\n<p></p><pre>  007 (030.000.000) 12/04 17:48:10 Shadow exception!\n        Error from slot11@beaver.cs.wisc.edu: File /scratch/samf/personal-condor/spool/30/0/cluster30.proc0.subproc0/contact maps to url local:/scratch/samf/personal-condor/spool/30/0/cluster30.proc0.subproc0/contact, which I don't know how to open.\n</pre>\n\n<p>ToddT described a workaround and Alan helped Sam get the workaround working:\n\n</p><p><code>no_nfs.sh</code>\n</p><div class=\"verbatim\">\n<pre>#!/bin/sh\nexport _CONDOR_USE_NFS=False\nshadow_location=`condor_config_val real_shadow`\nexec $shadow_location $*\n</pre></div>\n\n\n<p>where we have in <code>condor_config.local</code>\n\n</p><p></p><div class=\"verbatim\">\n<pre>REAL_SHADOW\t= $(SBIN)/condor_shadow\nSHADOW\t\t= $(SBIN)/no_nfs.sh\n</pre></div>\n\n\n<p>and have placed <code>no_nfs.sh</code> in <code>$(SBIN)</code>.\n\n</p><p>The file <code>pseudo_ops.cpp</code> appears to be the culprit. The one in <code>condor_shadow.V6.1</code> needs to be changed as a lot of is too similar to the one in <code>condor_shadow.std</code>.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Dec-07 11:21:42 by tannenba:</em> <br/>\n\nThe problem is a protocol mismatch: the remote I/O client in the vanilla starter does not understand all the potential file mappings that the remote I/O server in the shadow may return.  Behold from <a class=\"file\" href=\"rlog?f=src/condor_starter.V6.1/io_proxy_handler.cpp\">/src/condor_starter.V6.1/io_proxy_handler.cpp</a> :\n\n<p></p><div class=\"code\">\n<pre class=\"code\">result = REMOTE_CONDOR_get_file_info_new(path,url);\nif(result==0) {\n  dprintf(D_SYSCALLS,\"Directed to use url %s\\n\",url);\n  ASSERT( strlen(url) &lt; CHIRP_LINE_MAX );\n  if(!strncmp(url,\"remote:\",7)) {\n  strncpy(path,url+7,CHIRP_LINE_MAX);\n} else if(!strncmp(url,\"buffer:remote:\",14)) {\n  strncpy(path,url+14,CHIRP_LINE_MAX);\n} else {\n  EXCEPT(\"File %s maps to url %s, which I don't know how to open.\\n\",path,url);\n}\n</pre></div>\n\n\n<p>So if USE_NFS=True, the remote I/O server in the shadow will return a mapping URL that starts with local:, and the remote I/O client in the starter only understands remote: and buffer:remote.\n\n</p><p>Plan for stable series fix: in the vanilla shadow, insert USE_NFS=False and USE_AFS=False into the param table on shadow startup and after a reconfig. Given that the only remote I/O client in the world known to exist is the one in the starter, this seems like a safe/acceptable solution for the stable series.\n\n</p><p>Plan for developer series fix: For the development branch moving forward, we should either teach the remote I/O client how to handle all the possible server responses such as local:, or rip out the possibility for local: responses from the server.\n\n</p><p></p><hr/>\n<em>2012-Dec-14 09:42:38 by tstclair:</em> <br/>\n\nThis commit breaks compat in the stable series, &amp;&amp; we depend.\n\n<p></p><hr/>\n<em>2012-Dec-14 11:07:45 by tannenba:</em> <br/>\n\nTim, re the above, how do you \"depend\" ?  Is my statement above about how the new starter is the only known remote I/O client incorrect, i.e. did you guys write your own remote i/o client?\n<hr/>\n<em>2012-Dec-19 09:30:47 by johnkn:</em> <br/>\n\nBulk change of target version from v070807 to v070808 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2012-Dec-26 16:57:25 by samf:</em> <br/>\n\nWe tried using <code>set_runtime_config</code> in <code>baseshadow.cpp:config()</code>. We want to use <code>param_insert</code> instead as <code>set_runtime_config</code> sets values and waits for them to be read into the parameter hash table when the user runs <code>condor_reconfig</code>. <code>param_insert</code> does indeed work when setting <code>param_insert(\"USE_NFS\",\"False\");</code></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"tktview?tn=3390\" title=\"MPI Parallel Universe jobs fail when USE_NFS=True - Developer Series\">#3390</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMPI Parallel Universe jobs fail when USE_NFS=True - Developer Series</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-19 10:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34435\">[34435]</a></span>: update 7.8.7 version history item (starter crash with chirp) ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"tktview?tn=3361\" title=\"MPI Parallel Universe jobs fail when USE_NFS=True\">#3361</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-17 12:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34404\">[34404]</a></span>: Added Version History for <span class=\"ticket\"><a class=\"defer\" href=\"tktview?tn=3361\" title=\"MPI Parallel Universe jobs fail when USE_NFS=True\">#3361</a></span> (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-12 10:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34360\">[34360]</a></span>: change name of config knob for USE_AFS &amp; USE_NFS in the non-standard shadow, for <span class=\"ticket\"><a class=\"defer\" href=\"tktview?tn=3361\" title=\"MPI Parallel Universe jobs fail when USE_NFS=True\">#3361</a></span> new knob is NONSTD_USE_NFS and NONSTD_USE_AFS for condor_shadow.v1. condor_shadow.std still uses old knob names. Ultimately, these knobs will be removed in the developer series but to avoid making large changes in\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Dec-26 16:57", "status": "defer", "created": "2012-Dec-05 16:10", "fixed_version": "2012-Dec-05 16:10", "broken_version": "v070800", "priority": "5", "subsystem": "Parallel", "assigned_to": "samf", "derived_from": "", "creator": "samf", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "samf@cs.wisc.edu, tannenba@cs.wisc.edu, tstclair@redhat.com, matt@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}