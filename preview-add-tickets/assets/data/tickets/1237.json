{"id": 1237, "title": "Ticket #1237: condor_schedd fsync()s UserLog multiple times on job removal", "description": "<blockquote>\nRelated to...\n<div class=\"verbatim\">\n<pre>commit 579dffc9e99b6b50cce342f5468b3b3b8c3a95fb\nAuthor: Dan Bradley &lt;dan@hep.wisc.edu&gt;\nDate:   Thu Feb 11 16:35:55 2010 -0600\n\n    Only fsync user log once when writing multiple submit events.\n    Previously, 'queue 100' caused 100 calls to fsync.\n</pre></div>\n\n\n<p>The Schedd will fsync the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> once for each job that is removed.\n\n</p><p>Watching the Schedd with...\n</p><div class=\"verbatim\">\n<pre>$ strace -c -efsync -p $(pidof condor_schedd)\n</pre></div>\n\n\n<p>Submission with no log file...\n</p><div class=\"verbatim\">\n<pre>$ time echo \"cmd=/bin/true\\nrequirements=false\\nnotification=never\\nqueue 100\" | strace -c -efsync condor_submit\nSubmitting job(s)....................................................................................................\n100 job(s) submitted to cluster 5.\necho \"cmd=/bin/true\\nrequirements=false\\nnotification=never\\nqueue 100\"  0.00s user 0.00s system 113% cpu 0.002 total\nstrace -c -efsync condor_submit  0.08s user 0.14s system 48% cpu 0.458 total\n</pre></div>\n\n\n<p>Schedd fsync counts with no log file (after queue drained)...\n</p><div class=\"verbatim\">\n<pre>$ strace -c -efsync -p $(pidof condor_schedd)\nProcess 24411 attached - interrupt to quit\n^CProcess 24411 detached\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n  -nan    0.000000           0         2           fsync\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000000                     2           total\n</pre></div>\n\n\n<p>Submission with single log file...\n</p><div class=\"verbatim\">\n<pre>$ time echo \"cmd=/bin/true\\nlog=/tmp/log\\nrequirements=false\\nnotification=never\\nqueue 10\" | strace -c -efsync condor_submit\nSubmitting job(s)..........\nLogging submit event(s)..........\n10 job(s) submitted to cluster 7.\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n  -nan    0.000000           0         1           fsync\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000000                     1           total\necho   0.00s user 0.00s system 0% cpu 0.002 total\nstrace -c -efsync condor_submit  0.02s user 0.07s system 36% cpu 0.230 total\n</pre></div>\n\n\n<p>Schedd fsync counts with single log file (after queue drained)...\n</p><div class=\"verbatim\">\n<pre> strace -c -efsync -p $(pidof condor_schedd)\nProcess 24411 attached - interrupt to quit\n^CProcess 24411 detached\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000682          57        12           fsync\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000682                    12           total\n</pre></div>\n\n\n<p>Submission with multiple log files...\n</p><div class=\"verbatim\">\n<pre>$ time echo \"cmd=/bin/true\\nlog=/tmp/log.\\$(cluster).\\$(process)\\nrequirements=false\\nnotification=never\\nqueue 10\" | strace -c -efsync condor_submit\nSubmitting job(s)..........\nLogging submit event(s)..........\n10 job(s) submitted to cluster 8.\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000882          88        10           fsync\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000882                    10           total\necho   0.00s user 0.00s system 28% cpu 0.003 total\nstrace -c -efsync condor_submit  0.02s user 0.06s system 41% cpu 0.204 total\n</pre></div>\n\n\n<p>Schedd fsync counts with multiple log files (after queue drained)...\n</p><div class=\"verbatim\">\n<pre>$ strace -c -efsync -p $(pidof condor_schedd)\nProcess 24411 attached - interrupt to quit\n^CProcess 24411 detached\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n  -nan    0.000000           0        12           fsync\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.000000                    12           total\n</pre></div>\n\n\n<p>Actual fsync counts for n jobs...\n<table border=\"1\" cellspacing=\"0\">\n<tbody><tr>\n<td>\n </td>\n<td>\nno log</td>\n<td>\nsingle log</td>\n<td>\nmultiple logs</td>\n</tr>\n\n<tr>\n<td>\nsubmit</td>\n<td>\n0</td>\n<td>\n1</td>\n<td>\nn</td>\n</tr>\n\n<tr>\n<td>\nschedd</td>\n<td>\n2</td>\n<td>\nn+2</td>\n<td>\nn+2</td>\n</tr>\n\n</tbody></table>\n</p><p>Expected fsync counts for n jobs...\n<table border=\"1\" cellspacing=\"0\">\n<tbody><tr>\n<td>\n </td>\n<td>\nno log</td>\n<td>\nsingle log</td>\n<td>\nmultiple logs</td>\n</tr>\n\n<tr>\n<td>\nsubmit</td>\n<td>\n0</td>\n<td>\n1</td>\n<td>\nn</td>\n</tr>\n\n<tr>\n<td>\nschedd</td>\n<td>\n2</td>\n<td>\n1+2</td>\n<td>\nn+2</td>\n</tr>\n</tbody></table></p></blockquote>", "remarks": "<blockquote>\n<em>2010-Mar-17 10:37:38 by tstclair:</em> <br/>\n\nThis may be related to the check_zombie issue we had seen when shadows exit prior to the schedd communicating.  During reaping the schedd will execute check_zombie which then performs multiple fsyncs.  It could easily be bundled under a single transaction.\n<hr/>\n<em>2010-Oct-20 16:03:30 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n<hr/>\n<em>2011-Jan-27 14:46:04 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n<hr/>\n<em>2011-Feb-01 16:01:00 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "enhance", "last_change": "2012-Oct-17 12:25", "status": "new", "created": "2010-Feb-19 12:11", "fixed_version": "2010-Feb-19 12:11", "broken_version": "", "priority": "3", "subsystem": "Daemons", "assigned_to": "", "derived_from": "#1284", "creator": "matt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.cs.wisc.edu, tstclair@redhat.com", "due_date": ""}