{"id": 3982, "title": "Ticket #3982: Teach DaemonCore to listen to multiple command sockets simultaneously", "description": "<blockquote>\nAs part of the IPv4/IPv6 mixed mode work (<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3538\" title=\"Support mixed IPv4/IPv6 mode\">#3538</a></span>), <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> needs to be able to listen to multiple command sockets simultaneously.  As it happens, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> already does, but:\n\n<p></p><ul>\n<li>it privileges the first command socket it creates as the one it advertises, and in a few other places.\n</li><li>it doesn't create multiple sockets initially.   The other sockets are special cases (a specially requested socket for SOAP, a dedicated socket for shadows to talk to).\n</li></ul>\n\n<p>Work plan:\n</p><ul>\n<li><code>DONE....</code> Eliminate special tracking of the first command socket. For backward compatibility, allow easy identification of what would have been returned in the past. <span class=\"chng\"><a href=\"chngview?cn=37826\">[37826]</a></span>\n</li><li><code>DONE....</code> Track a list of socket pairs (UDP+TCP) instead of just one pair.  <span class=\"chng\"><a href=\"chngview?cn=37911\">[37911]</a></span> <span class=\"chng\"><a href=\"chngview?cn=37927\">[37927]</a></span>\n</li><li><code>DONE....</code> Teach DaemonCore::InitCommandSockets to return a list of pairs (but only actually return one pair) <span class=\"chng\"><a href=\"chngview?cn=37826\">[37826]</a></span>\n</li><li><code>DONE....</code> Ensure all callers to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitCommandSockets\" title=\"Init Command Sockets\">InitCommandSockets</a></span> handle it correctly (excepting DaemonCore::Create_Process)\n</li><li><code>DONE....</code> Ensure DaemonCore::Create_Process allows all created command sockets to be inherited, not just two. <span class=\"chng\"><a href=\"chngview?cn=37826\">[37826]</a></span>\n</li><li><code>DONE....</code> Ensure DaemonCore::Inherit is prepared to take a list of sockets, not just two. <span class=\"chng\"><a href=\"chngview?cn=37826\">[37826]</a></span>\n</li><li><code>DONE....</code> Teach ReliSock/SafeSock to use protocol passed in, not to automatically decide. <span class=\"chng\"><a href=\"chngview?cn=38758\">[38758]</a></span>\n</li><li><code>DONE....</code> Teach <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitCommandSockets\" title=\"Init Command Sockets\">InitCommandSockets</a></span> to listen on both protocols by default if enabled and listening to *. <span class=\"chng\"><a href=\"chngview?cn=38795\">[38795]</a></span> <span class=\"chng\"><a href=\"chngview?cn=38793\">[38793]</a></span>\n</li><li><code>WORKING.</code> Test mixed mode collector receiving updates and queries from both protocols.\n</li><li><code>........</code> Teach <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> to listen on both protocols by default if enabled and listening to *.\n</li><li><code>........</code> Check if there are sockets we should not be advertising.  Ensure we don't flag them for general use.  The sockets created by the schedd for shadows leap to mind.\n</li><li><code>........</code> Ensure \"Get my own Sinful\" code gets the entire list of sockets, even if right now it only uses the first one.\n</li><li><code>........</code> Eliminate any use of the \"get first command socket\" backward compatibility.\n</li><li><code>........</code> Better integrate superport? At least stuff it into a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SockPair\" title=\"Sock Pair\">SockPair</a></span>?\n</li></ul>\n\n<p>The requirement for an approved design document in advance has been waived as it was deemed too time critical to wait for.  <span class=\"wiki\"><a href=\"wiki?p=DesignDoc\" title=\"Design Doc\">DesignDoc</a></span> is more what you'd call \"guidelines\" than actual rules.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Oct-30 08:33:47 by bbockelm:</em> <br/>\n\nUgh - counted_ptr?  Any chance you can use classad_shared_ptr?\n\n<p></p><hr/>\n<em>2013-Nov-14 14:22:11 by adesmet:</em> <br/>\n\ncounted_ptr works fine, and doesn't unnecessarily drag in classad specific stuff (even if the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> specific stuff is just a thin wrapper around STL/Boost functionality).\n\n<p>Really we need classad_shared_ptr to be copied into utils, perhaps as condor_shared_ptr.  Then replace counted_ptr's use.  But that's a different ticket.\n\n</p><p></p><hr/>\n<em>2014-Jan-06 16:32:56 by adesmet:</em> <br/>\n\nCollector successfully listening on both IPv6 and IPv4.\n\n<p>I haven't managed to convince any tools to actually work yet...</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-06 13:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39115\">[39115]</a></span>: IPv6 socket shouldn't also grab IPv4 <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-21 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38810\">[38810]</a></span>: Better error messages when failing to bind to IPv6 <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-21 13:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38795\">[38795]</a></span>: Now actually tries to listen on IPv6 .#3982 Missed a few cases where we need to pass the protocol down.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-19 16:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38793\">[38793]</a></span>: Daemoncore can now listen multi-protocol <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span> It's only going to advertise one. And no promises that it actually works. But it's listening now.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-19 14:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38764\">[38764]</a></span>: ReliSock::listen(int port) now takes protocol as well. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-19 14:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38763\">[38763]</a></span>: Flag some functions as deprecated. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-19 13:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38758\">[38758]</a></span>: Reli/SafeSocks now accept proto as argument <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span> This is preperatory work for getting <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitCommandSockets\" title=\"Init Command Sockets\">InitCommandSockets</a></span> to bind to multiple protocols.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-14 18:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38734\">[38734]</a></span>: Allow inherited command sockets to be a list. .#3982  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-14 14:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38724\">[38724]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitCommandSockets\" title=\"Init Command Sockets\">InitCommandSockets</a></span> can now return a list of sockets ...at least the API supports it. It still only returns one thing, and other code will likely break when it returns more than one thing. But this is a step toward returning sockets on both IPv4 and IPv6 simultaneously. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-18 11:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37927\">[37927]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SockPair\" title=\"Sock Pair\">SockPair</a></span> now manages de/alloc of Safe/ReliSocks. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span> Now that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SafeSock\" title=\"Safe Sock\">SafeSock</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> for a command port are collected inside a vector of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SockPairs\" title=\"Sock Pairs\">SockPairs</a></span>, it was getting a bit muzzy who owned the memory. Now it's <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SockPair\" title=\"Sock Pair\">SockPair</a></span>, always. This will simplify teaching DaemonCore::InitCommandSockets to return a vector\u00a0[...]\n (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-16 14:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37911\">[37911]</a></span>: Track lists of socket pairs, not just one <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-11 17:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37826\">[37826]</a></span>: Allow multiple \"important\" command sockets. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3982\" title=\"Teach DaemonCore to listen to multiple command sockets simultaneously\">#3982</a></span> Not yet useful...  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-May-27 15:35", "status": "resolved", "created": "2013-Oct-11 17:36", "fixed_version": "2013-Oct-11 17:36", "broken_version": "", "priority": "4", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "#9", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "adesmet@cs.wisc.edu", "due_date": ""}