{"id": 3929, "title": "Ticket #3929: Log rotation broken when MAX_NUM_SUBSYS_LOG > 1 w/o date rotation", "description": "<blockquote>\nwhen <code>MAX_NUM_&lt;SUBSYS&gt;_LOG</code> is set to 2 or more, the log rotation code generates a log file with the extension 1969* and never actually rotates beyond it.  It appears that there is some crosstalk between time based rotation and size based rotation.\n\n<p>Also, on Windows.  if there is a log file with an extension that sorts after .old. <code>cleanupOldLogFiles</code> will go into an infinite loop.\n\n</p><p>Note this bug does not occur if one is using date-based rotation instead of size-based rotation.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Oct-02 17:50:23 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Ticket shows no evidence of how the patch was tested. While the problems with rotation when <code>MAX_NUM_SUBSYS_LOG &gt; 1</code> appear resolved, unfortunately <code>cleanUpOldLogFiles()</code> still goes into an infinite loop.\n\n</p><p>The infinite loop problem seems related to this code:\n</p><div class=\"code\">\n<pre class=\"code\">// catch the exception that the file name pattern is disturbed by external influence\nif (strcmp(oldFile, empty) == 0)\n   break;\n</pre></div>\n\n\n<p>The <code>break</code> statement never happens, because in my test case <code>empty</code> is <code>c:\\condor/log/NegotiatorLog</code>, and <code>oldFile</code> is <code>NegotiatorLog.20131002T173421</code>. The problem is one path is fully qualified, and the other is not, thus the break will never happen.  Even if both paths were fully qualified, another issue is the directory delimiters are not canonicalized before the pathnames are compared.\n\n</p><p>Please modify patch and include in the ticket screen output of it failing to work before your fix and working correctly after your fix.\n\n</p><p><em>2013-Oct-15 13:50:23 by johnkn:</em> <br/>\n\nFurther analysis of the code shows that the above is indeed a problem, but that the code is <strong>even more broken</strong> than previously believed.   Fixing the above mentioned problem actually makes things worse because findOldest on Windows always returns the .old file if one exists, but that test causes us to never delete that file.   On *nix, findOldest actually returns the youngest file with a file extension, so it's broken in a different way.\n\n</p><p>The fix for these bugs requires more changes than can be safely made before 8.0.4 is released - I'm retargeting for 8.0.5\n\n</p><p></p><hr/>\n<em>2013-Nov-07 15:35:46 by bt:</em> <br/>\n\nWe now have some tools which test the logging code. A test exercises those tools and can be run by hand in a preconfigured condor to test. The test is called \"job_test_logrotation.run\" and it uses a custom tool condor_testwritelog. When called with any args, it does not start any person condors but does change\nconfig settings between  tests. Status as of 11/8/13.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-19 15:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37679\">[37679]</a></span>: fix <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=3929\" title=\"Log rotation broken when MAX_NUM_SUBSYS_LOG &gt; 1 w/o date rotation\">#3929</a></span>, log rotation is broken when MAX_NUM_&lt;SUBSYS&gt;_LOG &gt; 1. This commit also fixes the windows-only bug where having a log file with an extension &gt; .old that isn't part of the standard log extension pattern will put the log rotate code into an infinite loop. <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=3929\" title=\"Log rotation broken when MAX_NUM_SUBSYS_LOG &gt; 1 w/o date rotation\">#3929</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-May-29 16:06", "status": "new", "created": "2013-Sep-17 16:50", "fixed_version": "2013-Sep-17 16:50", "broken_version": "v080000", "priority": "2", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}