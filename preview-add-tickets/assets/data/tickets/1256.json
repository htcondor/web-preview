{"id": 1256, "title": "Ticket #1256: condor_schedd crashes sometimes when gridmanager exits", "description": "<blockquote>\nI think there is a bug in grid_universe.cpp.  See in the following code where it checks for add_timer_id instead of remove_timer_id?  Instead, it should be checking for remove_timer_id.\n\n<p></p><div class=\"verbatim\">\n<pre>   if ( node-&gt;add_timer_id == -1 ) {  // == -1 means no timer set\n       node-&gt;remove_timer_id = daemonCore-&gt;Register_Timer(job_removed_delay,\n           GridUniverseLogic::SendRemoveSignal,\n           \"GridUniverseLogic::SendRemoveSignal\");\n</pre></div>\n\n\n<p>Because of this error, it is possible to register multiple remove timers.  If the gridmanager exits before these timers fire, only one of the timers will be unregistered.  When the others fire, they will dereference the deleted <code>GridUniverseLogic</code> object.\n\n</p><p>This code appears to be from 2002 or earlier.  I marked the broken version as v070000, but the original broken version is likely much older than that.\n\n</p><p>The reason I looked at this code is that the schedd crashed on CHTC in <code>GridUniverseLogic::SendRemoveSignal</code>.  Here's what we see:\n\n</p><p>The schedd process still exists, so the master hasn't noticed any problem yet.  Here's what the schedd process is doing:\n\n</p><p></p><div class=\"verbatim\">\n<pre>(gdb) where\n#0  0x00000039a86d2c2b in __lll_mutex_lock_wait () from /lib64/tls/libc.so.6\n#1  0x0000000000c898b0 in ?? ()\n#2  0x0000000000000001 in ?? ()\n#3  0x00000039a866de53 in posix_memalign () from /lib64/tls/libc.so.6\n#4  0x00000039a8831640 in __malloc_initialize_hook () from /lib64/tls/libc.so.6\n#5  0x00000039a88316b8 in main_arena () from /lib64/tls/libc.so.6\n#6  0x0000000000000007 in ?? ()\n#7  0x00000039a8658836 in sscanf () from /lib64/tls/libc.so.6\n#8  0x00000000006524cc in CondorVersionInfo::string_to_VersionData ()\nPrevious frame inner to this frame (corrupt stack?)\n</pre></div>\n\n\n<p>Here's the tail end of the schedd log:\n\n</p><p></p><div class=\"verbatim\">\n<pre>03/03/10 10:20:30 (pid:13473) condor_gridmanager (PID 13504, owner yoo2) exited\nwith return code 4.\nStack dump for process 13473 at timestamp 1267633231 (13 frames)\ncondor_schedd(dprintf_dump_stack+0xb3)[0x5ceacf]\ncondor_schedd(_Z18linux_sig_coredumpi+0x28)[0x5c098a]\n/lib64/tls/libpthread.so.0[0x39a930c5b0]\n/lib64/tls/libc.so.6[0x39a8669791]\n/lib64/tls/libc.so.6(malloc+0x92)[0x39a866b632]\n/usr/lib64/libstdc++.so.5(_Znwm+0x25)[0x315ce9d425]\ncondor_schedd(_ZN10DaemonCore11Send_SignalEii+0x1d)[0x5b35a7]\ncondor_schedd(_ZN17GridUniverseLogic16SendRemoveSignalEv+0x80)[0x56a1b8]\ncondor_schedd(_ZN12TimerManager7TimeoutEv+0x27f)[0x5ca057]\ncondor_schedd(_ZN10DaemonCore6DriverEv+0x71f)[0x5adaf9]\ncondor_schedd(main+0x1921)[0x5c38f9]\n/lib64/tls/libc.so.6(__libc_start_main+0xdb)[0x39a861c3fb]\ncondor_schedd(_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_c+0x52)[0x516cea]\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-03 17:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25353\">[25353]</a></span>: Documented fix for schedd crash on gridmanager exit. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=1256\" title=\"condor_schedd crashes sometimes when gridmanager exits\">#1256</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-03 17:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17380\">[17380]</a></span>: Fixed a rare schedd crash on gridmanager exit. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=1256\" title=\"condor_schedd crashes sometimes when gridmanager exits\">#1256</a></span> The problem was that multiple <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GridUniverseLogic\" title=\"Grid Universe Logic\">GridUniverseLogic</a></span> remove timers could be registered rather than the intended maximum of 1. When the object is destructed, only the most recently registered timer is unregistered. When the others fire, they dereference\u00a0[...]\n (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Mar-04 09:45", "status": "resolved", "created": "2010-Mar-03 17:17", "fixed_version": "2010-Mar-03 17:17", "broken_version": "v070000", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}