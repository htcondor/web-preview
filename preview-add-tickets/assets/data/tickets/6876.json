{"id": 6876, "title": "Ticket #6876: Support output file remaps for URLs", "description": "<blockquote>\nOn output, we can only specify an \"output destination\": if set, on the final transfer from the condor_starter, we copy each file in the output sandbox to:\n\n<p></p><div class=\"verbatim\">\n<pre>OutputDestination + \"/\" + filename\n</pre></div>\n\n\n<p>This really means <em>everything</em> -- including stdout and stderr from the job.  We believe this has been highly unpopular and that users actually want only specific transfers to go URLs.\n\n</p><p>For now, I'd like to keep the <code>OutputDestination</code> semantic to preserve backward compatibility - but this might be removable in the future.\n\n</p><p>Instead, we should use the existing <code>transfer_output_remaps</code> on the upload side.  If the output file is to be remapped to a URL, then it should be transferred from the starter using a hook instead of CEDAR.  By removing a limit on the existing remap mechanism, we have minimal user interface changes.\n\n</p><p>In terms of <em>when</em> the hook is invoked, we should keep the existing logic for <code>OutputDestination</code>.  This is only invoked when it is a \"final transfer\" (which is only true for Upload from the starter to the shadow).  The hooks should not be invoked when the file transfer output is\u00a0used by client tools (<code>condor_transfer_data</code> or the Python bindings).</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-11 17:16:13 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Patches look good, thanks!\n\n</p><p>Couple minor issues I noticed are below... most (all?) of these issues existed in this part of the code before these patches\n\n</p><p></p><ol>\n<li><code>OutputDestination</code> has a <code>DIR_DELIM_CHAR</code> appended; it really should just be a forward character always, since this is URL not a local filesystem path name. ( Now fixed in  <span class=\"chng\"><a href=\"chngview?cn=56167\">[56167]</a></span> )\n</li><li>Memory allocation/deallocation mismatch : Many of the data members in file transfer, include the output destination, are allocated with <code>strdup()</code> (sigh) but then deallocated in the dtor with <code>delete</code> (instead of free).  Seems like valgrind should have flagged this error years ago?  Maybe in practice the compiler does not care since the data type is <code>char *</code> ?\n</li><li>More comments in the code would always be appreciated\n</li></ol>\n\n<p></p><hr/>\n<em>2019-Feb-12 11:27:51 by tannenba:</em> <br/>\n\nPushed code to master branch, moving to docpending and reassigning back to BrianB for documentation\n\n<p></p><hr/>\n<em>2019-Apr-15 15:20:48 by tim:</em> <br/>\n\n<strong>Doc Review:</strong> Looks good.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6964\" onclick=\"get_ticket_and_populate_wrapper('6964'); return false;\" title=\"Fix mismatch between alloc()/delete found in #6876 code review\">#6964</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFix mismatch between alloc()/delete found in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span> code review</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-09 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56547\">[56547]</a></span>: Added full documentation under Submitting a Job page, also moved misplaced content (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-27 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56453\">[56453]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56167\">[56167]</a></span>: URL pathnames should always use forward slashes, not backslash. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-23 08:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56064\">[56064]</a></span>: Handle spooling files when output is URL. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-23 00:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56062\">[56062]</a></span>: Allow transfer_output_remaps to remap to a URL. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span> If a transfer_output_remaps statement maps a transfer to a URL, then have the condor_starter invoke the file transfer plugin logic on the URL. \u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Apr-15 15:20", "status": "resolved", "created": "2019-Jan-22 23:23", "fixed_version": "2019-Jan-22 23:23", "broken_version": "", "priority": "3", "subsystem": "FileTransfer", "assigned_to": "tim", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelman@morgridge.org tannenba@cs.wisc.edu", "due_date": ""}