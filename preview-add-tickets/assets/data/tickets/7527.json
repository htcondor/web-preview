{"id": 7527, "title": "Ticket #7527: MemoryUsage in Docker Universe does not show maximum observed", "description": "<blockquote>\nThe <code>MemoryUsage</code> attribute in the job classAd for Docker Universe jobs can be incorrect. Specifically, it represents the immediate memory usage, and not the maximum memory used. The result it can end up being set to zero in the job event log and in the history file if HTCondor polls Docker for memory usage after the job completes and the container is shutting down or output files are being transferred.\n\n<p>There are two problems here:\n\n</p><p></p><ol>\n<li>The condor_starter does not poll the Docker daemon for memory usage often enough, meaning it could \"miss\" observing the job's maximum.  The polling interval should be controlled by the config knob <code>POLLING_INTERVAL</code> (which defaults to 5 seconds), but instead the polling interval was hard-coded to 20 seconds.\n\n<p></p></li><li>Neither the condor_starter nor the condor_shadow actually calculates the maximum of the observed memory values. (sigh)\n</li></ol>\n\n<p>This patch changes the starter to actually honor the polling interval for Docker Universe jobs, and also take the maximum of the observed values.\n\n</p><p>Note we attempted to fix the problem of not storing the maximum observed value months ago in the shadow via <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7049\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span>, but that patch failed to do the job because of conflicts with commit <span class=\"chng\"><a href=\"chngview?cn=54199\">[54199]</a></span> in <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6549\" title=\"ProvisionedGPUs wrong\">#6549</a></span> which ended up incorrectly rewriting the value for <code>MemoryUsage</code>. The patch in <span class=\"chng\"><a href=\"chngview?cn=54199\">[54199]</a></span> needs to be revised, but that is another ticket.  In the meantime, this ticket makes a simpler patch to the shadow which will take the maximum memory value for Docker universe jobs as well (so that the max is taken even if the starter has not been updated yet).</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Apr-21 11:25:56 by johnkn:</em> <br/>\n\n<strong>code_review</strong> changes look good.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 19:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59168\">[59168]</a></span>: version history for bugfix <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7527\" title=\"MemoryUsage in Docker Universe does not show maximum observed\">#7527</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 18:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59166\">[59166]</a></span>: have starter honor POLLING_INTERVAL to monitor docker universe jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7527\" title=\"MemoryUsage in Docker Universe does not show maximum observed\">#7527</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 18:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59167\">[59167]</a></span>: fix patch in <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7049\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span> to shadow keep max memusage for docker universe. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7527\" title=\"MemoryUsage in Docker Universe does not show maximum observed\">#7527</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 18:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59165\">[59165]</a></span>: have starter track and report max memory used by a docker universe job. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7527\" title=\"MemoryUsage in Docker Universe does not show maximum observed\">#7527</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Apr-21 11:26", "status": "resolved", "created": "2020-Feb-27 15:57", "fixed_version": "2020-Feb-27 15:57", "broken_version": "v080502", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "tannenba", "derived_from": "#7049", "creator": "tannenba", "rust": "a99659", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}