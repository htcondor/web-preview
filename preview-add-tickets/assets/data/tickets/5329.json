{"id": 5329, "title": "Ticket #5329: Unify user log event writing code", "description": "<blockquote>\nRight now there is a whole bunch of duplicate code for writing user log events.  For example, the following source code files all have InitializeUserLog() or similarly-named functions that look like they pretty much all do the same thing:\n<ul>\n<li>condor_gridmanager/basejob.cpp\n</li><li>condor_job_router/submit_job.cpp\n</li><li>condor_schedd.V6/schedd.cpp\n</li><li>condor_shadow.std/log_events.cpp\n</li><li>condor_shadow.V6.1/baseshadow.cpp\n</li><li>condor_starter.V6.1/local_user_log.cpp\n</li></ul>\n\n<p>I guess one question is whether we want to do anything with this that's short of moving the event writing into its own daemon (<span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=963\" title=\"Have a Condor event logging daemon that does all log file writing\">#963</a></span>).  But maybe we could consolidate things into a single class that would be used by all of the above code as step 1, and then move that into a separate daemon as step 2?\n\n</p><p>Anyhow, I just wanted to record that there is an awful lot of duplicate (or near-duplicate) code related event writing...</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Dec-02 16:10:00 by jfrey:</em> <br/>\n\nNo user-visible changes, so no version history.\n\n<p></p><hr/>\n<em>2019-Dec-02 16:32:13 by jfrey:</em> <br/>\n\nThe code for initializing a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> object has been consolidated into two initialize() methods in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span>:\n<ul>\n<li>Specify a single log file, job id, and format parameters. No privilege switching.\n</li><li>Specify a job ad, which is used to determine all destination files and formatting. Privilege switching done as appropriate. Option to init/uninit user account to switch to.\n</li></ul>\n\n<p>More simplification to consider for the future:\n</p><ul>\n<li>Turn vector of log files into two explicit files (user-specified log and dagman log).\n</li><li>Optimize common case for DAGManNodesMask or remove checking of it entirely (i.e. hard-code list of DAGMan-relevant event types).</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=7009\" title=\"DAGMan event log messed up when job has no event log\">#7009</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDAGMan event log messed up when job has no event log</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-19 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57867\">[57867]</a></span>: Remove some noisy dprintf() statements. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5329\" title=\"Unify user log event writing code\">#5329</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-19 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57866\">[57866]</a></span>: Minor fixups for WriteUserLog::initialize() consolidation. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5329\" title=\"Unify user log event writing code\">#5329</a></span> Fix broken tests. Generate new date format by default in python bindings.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-15 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57865\">[57865]</a></span>: Remove unused versions of WriteUserLog::initialize(). <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5329\" title=\"Unify user log event writing code\">#5329</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-15 09:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57864\">[57864]</a></span>: Consolidate calls to WriteUserLog::initialize(). <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5329\" title=\"Unify user log event writing code\">#5329</a></span> The new form of initialize() that takes a job ad allows us to eliminate many different pieces of code that all try to figure out which log files should be written to.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-15 09:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57863\">[57863]</a></span>: Add WriteUserLog::initialize() based on a job ad. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5329\" title=\"Unify user log event writing code\">#5329</a></span> The code in this function is currently replicated sloppily in a half dozen locations. That code can be consolidated here. We configure the user, dagman, and global event logs as appropriate. This includes checking the xml and dagman event mask attributes.\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-14 15:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57862\">[57862]</a></span>: Remove alternate <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> constructors. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5329\" title=\"Unify user log event writing code\">#5329</a></span> These constructors hide failures to initialize the object. Now, all users must call some form of initialize(), which can return false to indicate a failure.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Dec-02 16:32", "status": "resolved", "created": "2015-Oct-21 12:13", "fixed_version": "2015-Oct-21 12:13", "broken_version": "v080500", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#963", "creator": "wenger", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}