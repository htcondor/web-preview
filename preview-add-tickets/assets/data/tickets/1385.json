{"id": 1385, "title": "Ticket #1385: improve information reported for multi-core jobs", "description": "<blockquote>\n<span class=\"section\"><h2>Overview </h2></span>\n\n<p>CPU usage by multi-core vanilla jobs on OSG (i.e. HTPC jobs) is under-reported at condor sites.  Gratia records that the job ran on 1 core in all cases.  The reason is that the user log and job history entry do not say how many cores the job ran on.  The condor accountant, on the other hand, can take into account the number of cores via <code>SlotWeight</code>, which defaults to the number of cores associated with the slot.\n\n</p><p>Miron does not want condor's job accounting to get overly tied to the specific concept of cores, but he does want us to report what the charge was for using the resource.  For most purposes, we could consider the charge to be the <code>SlotWeight</code> times the wall clock time, summed over all the run attempts for the job.  The sum of this charge across all jobs run by a user will not be exactly equal to the charge computed by the accountant, because the accountant deals in claims, not jobs, so any Unclaimed/Idle time will be charged by the accountant but will not show up in the charge associated with individual jobs.  Furthermore, the time boundaries of claims observed by the accountant depend on the sampling interval in the negotiator, the staleness of information in the collector, and so on.  It still seems useful to have a concept of a charge per job, as long as people realize that this is not identical to the accountant's view of things.\n\n</p><p>Job suspension raises an additional question.  Should the suspended time be counted towards the charge for using the resource?  The accountant can be configured either way via NEGOTIATOR_DISCOUNT_SUSPENDED_RESOURCES (default false).  So to really be correct when reporting the per-job charge, we would need to find out how the negotiator is configured.  An easier but sloppier approach would be to assume that this configuration setting is the same on the submit machine as on the central manager.  An even simpler approach, which is what I propose below, is to always discount suspended resources in what we report in the job and change the default in the negotiator to do likewise.  I think that is a more useful default and it is not worth much effort supporting the other case until we have a need for it.\n\n</p><p><span class=\"section\"></span></p><h2>Proposal </h2>\n\n<p>Add the following attributes to the job ad:\n\n</p><p></p><ul>\n<li>[DONE] <code>CumulativeSlotTime</code>: Sum of <code>SlotWeight*(WallClockTime-SuspensionTime)</code> over all run attempts for a job.\n\n<p></p></li><li>[DONE] <code>CommittedSlotTime</code>: Sum of <code>SlotWeight*(WallClockTime-SuspensionTime)</code> over run attempts that contributed to goodput for this job.  Analogous to <code>CommittedTime</code>.\n\n<p></p></li><li>[DONE] <code>CommittedSuspensionTime</code>: Time the job spent suspended during run attempts that contributed to <code>CommittedTime</code>.  This is just plain missing in the current system and needs to be added, irrespective of everything else here.\n\n<p></p></li><li>[DONE] <code>MachineAttrXXX</code>: where XXX is a machine attribute listed in the configuration variable JOB_MACHINE_ATTRS.  The value stored in this attribute is the evaluation of the corresponding machine attribute when the job started running (i.e. at the same time when $$ macros are evaluated).\n</li></ul>\n\n<p>Why have JOB_MACHINE_ATTRS when we already have $$?\n\n</p><p></p><ol>\n<li>The values of $$ expansions are only persisted in the job history ad as a sort of accident and this has never been formalized.\n\n<p></p></li><li>$$ only works inside of a string, so if you are storing numeric data, any expressions that refer to it must convert string values to numeric values.\n\n<p></p></li><li>By enforcing a naming scheme that ties the name of the attribute in the job ad to the name in the machine ad, it is easier to know how to interpret the values.  For example, gratia could check for <code>MachineAttrCpus</code> and use it if it is there, without worrying about how the site is configured.\n</li></ol>\n\n<p>If <code>MachineAttrCpus</code> is not available, how can gratia calculate the number of cores used by the job?  For sites that use the default <code>SlotWeight</code>, the number of cores can be obtained from <code>CumulativeSlotTime/(RemoteWallClockTime-CumulativeSuspensionTime)</code>.  This works even for jobs that run on X cores in one run attempt and Y cores in another run attempt.  The answer will be the time-weighted average of the number of cores, which seems like the most reasonable thing to report in this case.\n\n</p><p>For sites that configure a different <code>SlotWeight</code>, it would be incumbent on the admin to make sure <code>MachineAttrCpus</code> is defined.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-05 16:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25609\">[25609]</a></span>: Documented <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedSlotTime\" title=\"Committed Slot Time\">CommittedSlotTime</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CumulativeSlotTime\" title=\"Cumulative Slot Time\">CumulativeSlotTime</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-05 16:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18737\">[18737]</a></span>: Added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CumulativeSlotTime\" title=\"Cumulative Slot Time\">CumulativeSlotTime</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedSlotTime\" title=\"Committed Slot Time\">CommittedSlotTime</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span> These attributes are just like <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedTime\" title=\"Committed Time\">CommittedTime</a></span> but they are weighted by the slot weight(s) of the machine(s) that ran the job.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-03 14:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18709\">[18709]</a></span>: Fix for MAXINT compilation problem under windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-03 14:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25598\">[25598]</a></span>: edit and add to documentation related to SYSTEM_JOB_MACHINE_ATTRS, including listing/defining job attribute MachineAttr&lt;X&gt;&lt;N&gt;; gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-02 12:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18687\">[18687]</a></span>: Added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobMachineAttrs\" title=\"Job Machine Attrs\">JobMachineAttrs</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span> A configurable list of machine attributes may be inserted into the job ad with the prefix \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MachineAttr\" title=\"Machine Attr\">MachineAttr</a></span>\" and a numerical suffix that is an index into past run attempts.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-02 12:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25594\">[25594]</a></span>: Documented <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobMachineAttrs\" title=\"Job Machine Attrs\">JobMachineAttrs</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-30 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25589\">[25589]</a></span>: Documented addition of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedSuspensionTime\" title=\"Committed Suspension Time\">CommittedSuspensionTime</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-30 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18677\">[18677]</a></span>: Added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedSuspensionTime\" title=\"Committed Suspension Time\">CommittedSuspensionTime</a></span> to the job ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1385\" onclick=\"get_ticket_and_populate_wrapper('1385'); return false;\" title=\"improve information reported for multi-core jobs\">#1385</a></span> This relates to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedTime\" title=\"Committed Time\">CommittedTime</a></span> in the same way that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CumulativeSuspensionTime\" title=\"Cumulative Suspension Time\">CumulativeSuspensionTime</a></span> relates to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span>.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Aug-05 16:57", "status": "resolved", "created": "2010-Apr-29 15:00", "fixed_version": "2010-Apr-29 15:00", "broken_version": "v070503", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu tannenba@cs.wisc.edu gthain@cs.wisc.edu miron@cs.wisc.edu matt@cs.wisc.edu", "due_date": ""}