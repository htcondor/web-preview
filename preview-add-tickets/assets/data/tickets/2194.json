{"id": 2194, "title": "Ticket #2194: Filter \"no idle jobs\" submitters prior to phase 4.1", "description": "<blockquote>\nThe calculation of submitter limits will take submitters into account who have no idle jobs, and will not use slots given to them.  This results in extra \"spins\" in the negotiation loop that could be avoided.  Pre-filtering submitters with no idle jobs can reduce unnecessary iterations.</blockquote>", "remarks": "<blockquote>\n<em>2011-May-26 16:18:22 by eje:</em> <br/>\n\nrepro/test:\n\n<p>Configuration:\n</p><div class=\"code\">\n<pre class=\"code\">$ more 95.bz706512.config\nNEGOTIATOR_CONSIDER_PREEMPTION = FALSE\nNUM_CPUS = 10\nGROUP_NAMES = a, b\nGROUP_QUOTA_a = 5\nGROUP_QUOTA_b = 5\n</pre></div>\n\n\n<p>Test uses two submissions.  The first submits a single job under submitter\n\"a.u1\":\n</p><div class=\"code\">\n<pre class=\"code\">$ more a.u1.jsub\nuniverse = vanilla\ncmd = /bin/sleep\nargs = 300\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.u1\"\nqueue 1\n</pre></div>\n\n\n<p>The second will submit 4 jobs for submitter \"a.u2\":\n</p><div class=\"code\">\n<pre class=\"code\">$ more a.u2.jsub\nuniverse = vanilla\ncmd = /bin/sleep\nargs = 300\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.u2\"\nqueue 4\n</pre></div>\n\n\n<p>The test is to first submit \"a.u1.jsub\", and let it negotiate.  After it has\nnegotiated, submit \"a.u2.jsub.\"\n\n</p><p>Before the fix, you will see this:  The first Phase-4.1 spin is \"a.u1\"\nnegotiating.   The next three spins (4.1,4.2,4.3) are \"a.u2\" negotiating.  You\ncan see that on the first spin, \"a.u2\" is given a submitter limit of 2.5, even\nthough 4 slots are available, since it is also including submitter \"a.u1\" in\nits computation.  (Note, the third spin 4.3 is an artifact of <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2195\" title=\"Submitters requiring extra pie spin that isn't necessary\">#2195</a></span>)\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e 'Phase 4..:' -e 'Negotiating with.* at' -e\n'submitterLimit *='\n05/26/11 11:22:01 Phase 4.1:  Negotiating with schedds ...\n05/26/11 11:22:01   Negotiating with a.u1@localdomain at &lt;192.168.1.2:34321&gt;\n05/26/11 11:22:01     submitterLimit    = 1.000000\n05/26/11 11:22:21 Phase 4.1:  Negotiating with schedds ...\n05/26/11 11:22:21   Negotiating with a.u2@localdomain at &lt;192.168.1.2:34321&gt;\n05/26/11 11:22:21     submitterLimit    = 2.482556\n05/26/11 11:22:22 Phase 4.2:  Negotiating with schedds ...\n05/26/11 11:22:22   Negotiating with a.u2@localdomain at &lt;192.168.1.2:34321&gt;\n05/26/11 11:22:22     submitterLimit    = 2.000000\n05/26/11 11:22:22 Phase 4.3:  Negotiating with schedds ...\n05/26/11 11:22:22   Negotiating with a.u2@localdomain at &lt;192.168.1.2:34321&gt;\n05/26/11 11:22:22     submitterLimit    = 1.000000\n</pre></div>\n\n\n<p>After the fix, we see that \"a.u2\" gets 4 slots, and \"a.u1\" is filtered due to\nits having no idle jobs to negotiate (Note, here the second spin 4.2 is manifestation of ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2195\" title=\"Submitters requiring extra pie spin that isn't necessary\">#2195</a></span> -- once that is fixed I would expect \"a.u2\" to negotiate in one spin)\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e 'Phase 4..:' -e\n'Negotiating with.* at' -e 'submitterLimit *=' -e 'Filtering submitter'\n05/26/11 12:03:31 Phase 4.1:  Negotiating with schedds ...\n05/26/11 12:03:31   Negotiating with a.u1@localdomain at &lt;192.168.1.2:47753&gt;\n05/26/11 12:03:31     submitterLimit    = 1.000000\n05/26/11 12:03:51 Filtering submitter a.u1@localdomain with no idle jobs\n05/26/11 12:03:51 Phase 4.1:  Negotiating with schedds ...\n05/26/11 12:03:51   Negotiating with a.u2@localdomain at &lt;192.168.1.2:47753&gt;\n05/26/11 12:03:51     submitterLimit    = 4.000000\n05/26/11 12:03:51 Phase 4.2:  Negotiating with schedds ...\n05/26/11 12:03:51   Negotiating with a.u2@localdomain at &lt;192.168.1.2:47753&gt;\n05/26/11 12:03:51     submitterLimit    = 1.000000\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Jun-15 18:19:46 by eje:</em> <br/>\n\nSee also <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2230\" title=\"negotiating groups with no submitters\">#2230</a></span>\n\n<p></p><hr/>\n<em>2011-Jun-27 10:28:14 by danb:</em> <br/>\n\nThanks for the patch!\n\n<p>Perhaps the log message, \"Filtering submitter %s with no idle jobs\" would be clearer if it were \"Ignoring submitter %s with no idle jobs\".\n\n</p><p>You are only applying this filter when consideration of preemption is disabled.  I think that is prudent for now, but perhaps something we should revisit later.  The reason I think it is prudent for now is described in <span class=\"ticket\"><a class=\"new\" href=\"tktview?tn=2270\" title=\"spinning pie algorithm + preemption = unfair allocation\">#2270</a></span>: the spinning pie algorithm does not converge to fair share allocations when preemption is allowed.  I am worried that this problem could be exacerbated by dropping submitters earlier in the cycle than we do already.\n\n</p><p></p><hr/>\n<em>2011-Jun-27 14:14:13 by tstclair:</em> <br/>\n\npushed patch with modified comment block per review</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2230\" title=\"negotiating groups with no submitters\">#2230</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nnegotiating groups with no submitters</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/358/gt2194_filter_noidle.patch\">gt2194_filter_noidle.patch</a>\n1406 bytes added by eje on 2011-May-26 21:24:06 UTC.\n<br/>\nfilter submitters with no idle jobs<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-28 09:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22305\">[22305]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2230\" title=\"negotiating groups with no submitters\">#2230</a></span> === Patch created by jrt cleaned by eje Fix: negotiating groups with no submitters Artifact of <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2054\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2194\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span> when using round robin that leads to entering negotiateWithGroup with no submitters attached to the group.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-27 14:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22298\">[22298]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2194\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span> === + Patch created by eje Fix for: The calculation of submitter limits will take submitters into account who have no idle jobs, and will not use slots given to them. This results in extra \"spins\" in the negotiation loop that could be avoided. Pre-filtering submitters with no idle jobs can\u00a0[...]\n (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-27 14:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22296\">[22296]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2194\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span> === + Patch created by eje Fix for: The calculation of submitter limits will take submitters into account who have no idle jobs, and will not use slots given to them. This results in extra \"spins\" in the negotiation loop that could be avoided. Pre-filtering submitters with no idle jobs can\u00a0[...]\n (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Jun-27 14:27", "status": "resolved", "created": "2011-May-26 16:11", "fixed_version": "2011-May-26 16:11", "broken_version": "", "priority": "3", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.wisc.edu, eje@cs.wisc.edu, tstclair@redhat.com", "due_date": "20110601"}