{"id": 6075, "title": "Ticket #6075: Watchdog problems in Fedora 25", "description": "<blockquote>\nUnder Fedora 25, but <em>not</em> under 24, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MasterLog\" title=\"Master Log\">MasterLog</a></span> reports:\n\n<p></p><pre>     systemd watchdog notification support not available.\n</pre>\n\n<p>However, it <em>is</em> available. No idea how this detection happens.\nResult is however, that every 20 minutes Condor gets restarted\nby systemd.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Jan-05 10:05:23 by bbockelm:</em> <br/>\n\nSeems that the systemd-provided library we use to interact with the watchdog was renamed in systemd 230:\n\n<p></p><div class=\"verbatim\">\n<pre>        * The compatibility libraries libsystemd-daemon.so,\n          libsystemd-journal.so, libsystemd-id128.so, and libsystemd-login.so\n          which have been deprecated since systemd-209 have been removed along\n          with the corresponding pkg-config files. All symbols provided by\n          those libraries are provided by libsystemd.so.\n</pre></div>\n\n\n<p>Given that the RPM configuration requires this library to work with the shipped unit file, we ought to add an explicit <code>Requires:</code>.\n\n</p><p></p><hr/>\n<em>2017-Jan-05 13:53:04 by tannenba:</em> <br/>\n\nSeems like the way to fix this is to tell our code to dlopen libsystemd.so instead of libsystemd-daemon.so.  Patch incoming.  And this same patch should be fine on RHEL7 as well since it uses systemd-219, so it seems like we can unconditionally do it everywhere since I don't feel like we need to support older-then-rhel7 distros that use systemd-208 or earlier.\n\n<p>Brian, by the above do you mean we should have a Build-Requires: systemd-devel (which we already do) and a Requires: systemd (which we do not have).  We could add this, but it seems like every system using systemd prolly already has libsystemd.so installed, right?\n\n</p><p></p><hr/>\n<em>2017-Jan-05 13:59:37 by bbockelm:</em> <br/>\n\nThat gets down to why we <code>dlopen</code> the library in the first place.  Technically, Debian defaults to systemd but it should be possible to put together a system that utilizes other inits.  We didn't want HTCondor to fail in such a setup.\n\n<p>For RHEL7, it's clear: no one should object to a hard dependency on systemd from HTCondor.\n\n</p><p>Doesn't Debian have a softer version of <code>Requires:</code> that we could use?  Something like \"install systemd-libs if systemd itself is installed?\"\n\n</p><p></p><hr/>\n<em>2017-Jan-05 14:34:15 by tannenba:</em> <br/>\n\nOk, I pushed some patches (I was in this part of cmake anyway).  Assigning to TimT for code review / testing (I don't have easy access to Fedora 25).  Also TimT, please confirm that with the patch we do NOT see the watchdog notification unavailable error in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MasterLog\" title=\"Master Log\">MasterLog</a></span> on RHEL7, just to be sure I didn't regress anything.\n\n<p></p><hr/>\n<em>2017-Jan-26 21:05:31 by tim:</em> <br/>\n\nNo regression on CentOS7. <strong>CODE REVIEW:</strong> Looks good</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-05 14:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49924\">[49924]</a></span>: Require systemd dependecy in RPM on RHEL7+ or Fedora16+. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6075\" title=\"Watchdog problems in Fedora 25\">#6075</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-05 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49923\">[49923]</a></span>: Don't use deprecated libsystemd-daemon.so, use libsystemd.so instead. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6075\" title=\"Watchdog problems in Fedora 25\">#6075</a></span> Since systemd-209, systemd-daemon has been deprecated, and now in Fedora 25 they actually no longer ship that library. Since RHEL7 ships with systemd-219, and we don't support anything older than that running systemd (ie who\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-26 21:05", "status": "resolved", "created": "2017-Jan-05 07:27", "fixed_version": "2017-Jan-05 07:27", "broken_version": "v080508", "priority": "3", "subsystem": "Packaging", "assigned_to": "tannenba", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "users", "visibility": "public", "notify": "bbockelm@cse.unl.edu tim@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}