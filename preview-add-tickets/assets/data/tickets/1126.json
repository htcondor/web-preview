{"id": 1126, "title": "Ticket #1126: Deploy TARGET scope correcting functions", "description": "<blockquote>\nNow that we have functions to add TARGET scopes to expressions in the new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> compatibility layer, we need to use them in the codebase. They need to be employed anywhere an expression is received from a user or a potentially old Condor process.\n\n<p>At some point in the future, many of these calls can be removed.\n\n</p><p>Locations for AddExplicitTargetRefs():\n</p><ul>\n<li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorQuery\" title=\"Condor Query\">CondorQuery</a></span> class [DONE]\n</li><li>Collector receiving a query ad [DONE]\n</li><li>Collector receiving an invalidation ad [DONE]\n</li><li>Startd receiving a query ad [DONE]\n</li></ul>\n\n<p>Locations for RemoveExplicitTargetRefs():\n</p><ul>\n<li>Schedd receiving constraints to identify jobs to act on [DONE]\n</li></ul>\n\n<p>Locations for AddTargetRefs():\n</p><ul>\n<li>Submit reading submit file [DONE]\n</li><li>Schedd receiving job attributes to set (submit and qedit) [DONE]\n</li><li>Schedd reading scheduler/local universe policy expressions from config file [DONE]\n</li><li>Schedd receiving machine ad from negotiator [DONE]\n</li><li>Schedd reading old ads from job queue log on startup [DONE]\n</li><li>Negotiator receiving job ad from schedd [DONE]\n</li><li>Negotiator reading matching policy expressions from config file [DONE]\n</li><li>Negotiator receiving machine ads from collector [DONE]\n</li><li>Startd receiving job ad for claim request [DONE]\n</li><li>Startd receiving job ad for claim activation [DONE]\n</li><li>Startd reading policy expressions from config file\n</li><li>Startd in a VM receiving ad of startd on physical machine [DONE]\n</li><li>Collector receiving machine ad [DONE]\n</li><li>Analyze receiving job ads [DONE]\n</li><li>Analyze receiving machine ads [DONE]</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2010-Jan-20 15:19:46 by jfrey:</em> <br/>\n\nCalls to these functions will have to be surrounded by a check for the macro WANT_OLD_CLASSADS. That is, only call the function if the macro isn't defined.\n\n<p></p><hr/>\n<em>2010-Jan-21 17:03:06 by jfrey:</em> <br/>\n\nWe should check if calls from soap clients to the collector and schedd follow separate codepaths that need separate checks.\n\n<p></p><hr/>\n<em>2010-Jan-26 08:02:58 by jfrey:</em> <br/>\n\nSoap calls to the collector and schedd are covered.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1116\" onclick=\"get_ticket_and_populate_wrapper('1116'); return false;\" title=\"Queue-management constraints shouldn't use TARGET scoping\">#1116</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nQueue-management constraints shouldn't use TARGET scoping</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1117\" onclick=\"get_ticket_and_populate_wrapper('1117'); return false;\" title=\"Query ads to the collector should have proper TARGET scoping\">#1117</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nQuery ads to the collector should have proper TARGET scoping</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1118\" onclick=\"get_ticket_and_populate_wrapper('1118'); return false;\" title=\"Proper Target scoping in job ad expressions\">#1118</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nProper Target scoping in job ad expressions</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-04 11:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17094\">[17094]</a></span>: Add Target scoping to dedicated scheduler's rewrite of job ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span> The dedicated scheduler modifies the job's requirements for matchmaking. The attribute references it adds need a TARGET scope.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-26 08:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16966\">[16966]</a></span>: Add proper TARGET scoping on invalidation ads. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-25 00:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16957\">[16957]</a></span>: Add more calls to AddTargetRefs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span> Add calls for condor_q -better-analyze and for preemption expressions in the dedicated scheduler.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-22 13:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16953\">[16953]</a></span>: Startd adds TARGET scoping to policy expressions from the config file <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-21 23:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16951\">[16951]</a></span>: Startd adds TARGET scoping in ads it receives from others. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-21 23:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16950\">[16950]</a></span>: Schedd adds TARGET scoping to job expressions when reading job queue log. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1118\" onclick=\"get_ticket_and_populate_wrapper('1118'); return false;\" title=\"Proper Target scoping in job ad expressions\">#1118</a></span> This allows upgrading Condor with jobs in the queue.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-21 23:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16949\">[16949]</a></span>: Collector now adds TARGET scoping on machine ad expressions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-21 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16948\">[16948]</a></span>: Schedd now adds TARGET scope on incoming expressions for new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1118\" onclick=\"get_ticket_and_populate_wrapper('1118'); return false;\" title=\"Proper Target scoping in job ad expressions\">#1118</a></span> The schedd now checks expressions for proper TARGET scoping of attributes in the following: * machine ads from the negotiator * SetAttribute() * local and scheduler universe start expressions  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-20 21:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16942\">[16942]</a></span>: Negotiator adds Target. scoping on all expressions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1118\" onclick=\"get_ticket_and_populate_wrapper('1118'); return false;\" title=\"Proper Target scoping in job ad expressions\">#1118</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1126\" onclick=\"get_ticket_and_populate_wrapper('1126'); return false;\" title=\"Deploy TARGET scope correcting functions\">#1126</a></span> This includes job ads, machine ads, and matchmaking policy expressions from the config file.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Feb-05 15:45", "status": "resolved", "created": "2010-Jan-20 11:15", "fixed_version": "2010-Jan-20 11:15", "broken_version": "v070500", "priority": "4", "subsystem": "", "assigned_to": "jfrey", "derived_from": "#1112", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20100125"}