{"id": 4586, "title": "Ticket #4586: Google cloud type doesn't work as documented", "description": "<blockquote>\nBy following the documentation (HTCondor Version 8.3.0 Manual), I\ndiscovered that it is no more possible to use the GCE (Google Compute\nEngine) Grid.\nThe reason is that Google modified his APIs. In particular, the\n'gcutil' tool described in HTCondor manual is now deprecated and, with\nthe current tools, I have not been able to find a way to generate an\nauthentication file that can replace the .gcutil_auth.\nThis problem affects all the released HTCondor versions, of course.</blockquote>", "remarks": "<blockquote>\n<em>2014-Sep-22 13:10:47 by timm:</em> <br/>\n\nHere are some notes of how our student was able to use a combination of a python script as found on the google site plus the ReST apI to do authentication.\n\n<p>I discovered an issue with the GCE's OAuth2 authentication method through the REST API. The issue has been accepted, but not yet solved, so, the only way of using the REST API with GCE is by authenticating with other approaches.\nIn the next steps I will use the Python API to authenticate, obtaining the access token needed by the REST API.\n\n</p><p>########################\n# PREREQUISITES        #\n########################\n\n</p><p>Python 2.5, 2.6, or 2.7 is required.\n\n</p><p>Install the pip tool:\nDownload <a class=\"external\" href=\"https://bootstrap.pypa.io/get-pip.py\">https://bootstrap.pypa.io/get-pip.py</a>\nAnd execute it, as superuser.\n\n</p><p>Install Google API Python client\n# pip install --upgrade google-api-python-client\n(<a class=\"external\" href=\"http://github.com/google/google-api-python-client\">http://github.com/google/google-api-python-client</a>)\n\n</p><p>Install OAuth2 Python client\npip install --upgrade oauth2client\n(<a class=\"external\" href=\"https://github.com/google/oauth2client\">https://github.com/google/oauth2client</a>)\n\n</p><p>########################\n# AUTHENTICATION       #\n########################\n\n</p><p>As described in \"<a class=\"external\" href=\"https://developers.google.com/compute/docs/api/python-guide\">https://developers.google.com/compute/docs/api/python-guide</a>\", it is possible to get authenticated with the Python API.\n\n</p><p>First of all, from the Google Cloud Console (<a class=\"external\" href=\"https://console.developers.google.com\">https://console.developers.google.com</a>), note your project id (next, will be called \"MY_PROJECT_ID\") access the project and, on the left column, reach\n\"APIs &amp; auth -&gt; Credentials\"\ncreate credentials and download the \"Compute Engine and App Engine\"'s JSON file.\nSave the JSON file as \"client_secrets.json\" in the folder you'll place the next script.\n\n</p><p>The following Python script returns the access token needed by the GCE REST API.\n\n</p><p></p><hr/>\n#!/usr/bin/env python\n\n<p>import json\nfrom pprint import pprint\nimport logging\nimport sys\nimport argparse\nimport httplib2\nfrom oauth2client.client import flow_from_clientsecrets\nfrom oauth2client.file import Storage\nfrom oauth2client import tools\nfrom oauth2client.tools import run_flow\n\n</p><p>from apiclient.discovery import build\n\n</p><p>DEFAULT_ZONE = 'us-central1-a'\nAPI_VERSION = 'v1'\nGCE_URL = 'https://www.googleapis.com/compute/%s/projects/' % (API_VERSION)\nPROJECT_ID = 'MY_PROJECT_ID'\nCLIENT_SECRETS = 'client_secrets.json'\nOAUTH2_STORAGE = 'oauth2auth.dat'\nGCE_SCOPE = 'https://www.googleapis.com/auth/compute'\n\n</p><p>def main(argv):\n  logging.basicConfig(level=logging.INFO)\n\n</p><p></p><pre>  parser = argparse.ArgumentParser(\n    description=__doc__,\n    formatter_class=argparse.RawDescriptionHelpFormatter,\n    parents=[tools.argparser])\n</pre>\n\n<p></p><pre>  # Parse the command-line flags.\n  flags = parser.parse_args(argv[1:])\n</pre>\n\n<p></p><pre>  # Perform OAuth 2.0 authorization.\n  flow = flow_from_clientsecrets(CLIENT_SECRETS, scope=GCE_SCOPE)\n  storage = Storage(OAUTH2_STORAGE)\n  credentials = storage.get()\n</pre>\n\n<p></p><pre>  if credentials is None or credentials.invalid:\n    credentials = run_flow(flow, storage, flags)\n  http = httplib2.Http()\n  auth_http = credentials.authorize(http)\n</pre>\n\n<p></p><pre>  storage_data = open(OAUTH2_STORAGE)\n  storageData = json.load(storage_data)\n  storage_data.close()\n</pre>\n\n<p></p><pre>  print storageData[\"access_token\"]\n</pre>\n\n<p>if __name__ == '__main__':\n  main(sys.argv)\n</p><hr/>\n########################\n# REST API             #\n########################\n\n<p>A simple REST call that returns the project's instances info contains is a GET request to:\n<a class=\"external\" href=\"https://www.googleapis.com/compute/v1/projects/MY_PROJECT_ID/zones/us-central1-a/instances\">https://www.googleapis.com/compute/v1/projects/MY_PROJECT_ID/zones/us-central1-a/instances</a>\n\n</p><p>That contains in the header the following access token:\nAuthorization: Bearer ACCESS_TOKEN_RETURNED_BY_PYTHON_SCRIPT\n\n</p><p>In Curl, it's the foollowing:\n$ curl -H \"Authorization: Bearer ACCESS_TOKEN_RETURNED_BY_PYTHON_SCRIPT\" -X GET \"<a class=\"external\" href=\"https://www.googleapis.com/compute/v1/projects/MY_PROJECT_ID/zones/us-central1-a/instances\">https://www.googleapis.com/compute/v1/projects/MY_PROJECT_ID/zones/us-central1-a/instances</a>\"\n\n</p><p></p><hr/>\nI believe it should be possible following this approach to get something that can work with HTCondor again.\n\n<p></p><hr/>\n<em>2015-Jan-14 13:29:15 by jfrey:</em> <br/>\n\nWith the new Google Cloud SDK, I can get a credential file that HTCondor can use by running <code>gcloud auth login</code>. The credentials are written to <code>~/.config/gcloud/credentials</code>. That's the only change in authentication that I see.\n\n<p>The syntax for creating a new instance has changed in the <code>v1</code> API, and the <code>v1beta16</code> API we developed against is no longer available. I now have a patched HTCondor that can submit instances to the current GCE servers. I'll do a quick check to see if anything else in the API has changed that would affect HTCondor.\n\n</p><p></p><hr/>\n<em>2015-Jan-23 10:24:18 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Changes look good to me.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-26 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42383\">[42383]</a></span>: minor 8.2.7 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4586\" onclick=\"get_ticket_and_populate_wrapper('4586'); return false;\" title=\"Google cloud type doesn't work as documented\">#4586</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-15 10:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42226\">[42226]</a></span>: Docs for GCE update and bug fixes. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4586\" onclick=\"get_ticket_and_populate_wrapper('4586'); return false;\" title=\"Google cloud type doesn't work as documented\">#4586</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4832\" onclick=\"get_ticket_and_populate_wrapper('4832'); return false;\" title=\"GCE instances not cleaned up properly\">#4832</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-15 09:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42224\">[42224]</a></span>: Update instance creation for GCE to match v1 API. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4586\" onclick=\"get_ticket_and_populate_wrapper('4586'); return false;\" title=\"Google cloud type doesn't work as documented\">#4586</a></span> Google Compute Engine changed the syntax for creating a new instance between v1beta16 and v1.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jan-23 10:25", "status": "resolved", "created": "2014-Sep-12 10:47", "fixed_version": "2014-Sep-12 10:47", "broken_version": "v080202", "priority": "3", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "timm", "rust": "a27341", "customer_group": "fermi", "visibility": "public", "notify": "timm@fnal.gov", "due_date": ""}