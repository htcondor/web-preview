{"id": 3209, "title": "Ticket #3209: Add support for spot instances to EC2 GAHP", "description": "<blockquote>\nTony Tiradani writes:\n\n<p></p><pre>  &gt; I have recently received requests from both CMS and HCC to provide EC2\n  &gt; Spot Instance support in glideinWMS since spot instances are\n  &gt; significantly cheaper than ordinary instances.  In order to do this, we\n  &gt; need Condor to support EC2 Spot Instances.\n</pre>\n\n<p></p><pre>  &gt; Could we have the following API calls added to the support list?\n</pre>\n\n<p></p><pre>  &gt; These calls are required to get spot instance to work:\n</pre>\n\n<p></p><pre>  &gt; RequestSpotInstances\n  &gt; CancelSpotInstanceRequests\n  &gt; DescribeSpotInstanceRequests\n</pre>\n\n<p></p><pre>  &gt; This one would be a second order request.  I envision using it to provide\n  &gt; matching capabilities per availability zone.\n</pre>\n\n<p></p><pre>  &gt; DescribeSpotPriceHistory</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-24 16:25:18 by tstclair:</em> <br/>\n\nReally...? wow, you would want DMTCP or something to ensure job recovery.\n\n<p></p><hr/>\n<em>2012-Aug-24 16:29:09 by tlmiller:</em> <br/>\n\nI've added the following commands to the EC2 GAHP:\n\n<p></p><pre>  EC2_VM_START_SPOT\n  EC2_VM_STATUS_SPOT\n  EC2_VM_STOP_SPOT\n  EC2_VM_STATUS_ALL_SPOT\n</pre>\n\n<p>all equivalent to the commands without the _SPOT suffix, and corresponding to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestSpotInstances\" title=\"Request Spot Instances\">RequestSpotInstances</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DescribeSpotInstanceRequests\" title=\"Describe Spot Instance Requests\">DescribeSpotInstanceRequests</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CancelSpotInstanceRequests\" title=\"Cancel Spot Instance Requests\">CancelSpotInstanceRequests</a></span> API commands, respectively.  (EC2_VM_STATUS_ALL_SPOT issues an unfiltered <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DescribeSpotInstanceRequests\" title=\"Describe Spot Instance Requests\">DescribeSpotInstanceRequests</a></span> command.)\n\n</p><p>After discussion with Jaime, I've decided to extend to EC2Job class's state machine with five new states: GM_START_SPOT, GM_SPOT_SUBMITTED, GM_PROBE_SPOT, GM_CANCEL_SPOT, and GM_CHECK_FOR_SPOT (used during recovery).  To summarize, we're going to change the rest of the state machine as little as possible, and instead jump into a subgraph that deals with spot instances.  We can do this by forbidding persistent spot requests and spot requests which can spawn more than one instance; if requested by our users, we can emulate/implement those features in Condor proper.  (Effectively, once we've cancelled the spot request and removed its information (and added the instance ID), the job is a normal instance job, and can be treated as such.)\n\n</p><p></p><hr/>\n<em>2012-Aug-24 16:30:48 by jfrey:</em> <br/>\n\nOr calibrate your spot instance price so that average instance lifetime is  longer than a job's lifetime. We'll let them worry about figuring that out.\n\n<p></p><hr/>\n<em>2012-Aug-24 16:32:03 by tstclair:</em> <br/>\n\nWe should have some type of clause to say use at your own peril.\n\n<p></p><hr/>\n<em>2012-Sep-28 11:55:09 by tlmiller:</em> <br/>\n\nIn branch 'V7_9-spot_instances-branch'.\n\n<p></p><hr/>\n<em>2012-Sep-28 11:56:25 by tlmiller:</em> <br/>\n\nJaime, please review; I'll start working on the tests.  Thanks.\n\n<p></p><hr/>\n<em>2012-Nov-07 14:12:02 by tlmiller:</em> <br/>\n\nMerged to master.  Still to do:\n\n<p></p><ul>\n<li>Finish handling the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StateReasonCode\" title=\"State Reason Code\">StateReasonCode</a></span> (extensive comments in code).\n</li><li>Add regression test(s).\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-08 13:49:14 by tlmiller:</em> <br/>\n\nTook care of the state reason code.  Remaining:\n\n<p></p><ul>\n<li>Regression tests.\n</li><li>Documentation.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-14 13:48:37 by jfrey:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p></p><ul>\n<li>General note: try to match the tab/space style of surrounding code.\n\n<p></p></li><li>In GM_PROBE_JOB, EC2Job::errorString shouldn't have newlines.\n\n<p></p></li><li>In GM_CLEAR_REQUEST, you should be setting ATTR_EC2_SPOT_REQUEST_ID to\n  Undefined. You need to do this before the check for dirty attributes\n  and in such a way that subsequent calls into doEvaluateState() don't\n  re-dirty the attribute. One way to do this is to check whether\n  m_spot_request_id is empty. If it isn't, set to the empty string\n  and set the attribute to Undefined in the job ad.\n\n<p></p></li><li>In GM_SPOT_CANCEL, when you clear m_spot_request_id, you could also\n  set ATTR_EC2_SPOT_REQUEST_ID to Undefined in the job ad and call\n  requestScheddUpdate(this, false).\n  That would avoid an unnecessary EC2 command on any subsequent failure\n  recovery.\n\n<p></p></li><li>In GM_SPOT_START, you switch to GM_SPOT_CANCEL if the job is held or\n  removed. Nothing will happen in GM_SPOT_CANCEL, as we don't have a\n  spot instance request id. Also, if we have an ec2_spot_start command\n  in progress, we have to wait for the result before leaving this state.\n  Otherwise, we can leak a spot instance request.\n\n<p></p></li><li>In GM_SPOT_QUERY, the comments say that ec2_spot_status() should\n  return 0 or 1 spot instance request, and in the case of 1, it'll be\n  the one we're interested in. The code handles getting multiple\n  requests, but assumes our request is one of them. The code could be\n  improved to handle receiving results that don't include our own\n  request.\n\n<p></p></li><li>In GM_SPOT_QUERY, you switch to GM_DONE_SAVE if the spot instance\n  request's status isn't \"active\" or \"open\". Shouldn't it be putting\n  the job on hold, and possibly canceling the request first?\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-15 09:59:18 by tlmiller:</em> <br/>\n\n<strong>DOCUMENTATION</strong>\n\n<p>The sooner the better, but these changes require documentation.  In particular:\n\n</p><p></p><ul>\n<li>condor_submit has gained the 'ec2_spot_price' submit file attribute\n</li><li>The EC2 section in the grid manual needs to talk about spot instances, how Condor handles them (lifecycle and other concerns from the design doc), and how they can be requested.\n</li><li>The attributes EC2SpotPrice, EC2SpotRequestID, and EC2StatusReasonCode need to be added to, and explained in, the job ad documentation.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-15 10:00:15 by tlmiller:</em> <br/>\n\n<strong>REGRESSION TESTING</strong>\n\n<p>...\n\n</p><p></p><hr/>\n<em>2012-Nov-19 11:21:17 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Complete and changes pushed.</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/641/Overview.docx\">Overview.docx</a>\n151549 bytes added by tlmiller on 2012-Oct-03 18:46:38 UTC.\n<br/>\nFirst draft, belated design document.<br/>\n</li><li><a href=\"attach_get/661/AmazonSpotInstanceSupportV3.1.doc\">AmazonSpotInstanceSupportV3.1.doc</a>\n112128 bytes added by tlmiller on 2012-Nov-30 16:33:54 UTC.\n<br/>\nRevised design document.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-02 13:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34511\">[34511]</a></span>: edit of initial documetation on EC2 spot instances. Add version history item about the existence of the documentation. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-03 10:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34243\">[34243]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span>) Documentation for EC2 spot instances.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-16 13:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34141\">[34141]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span>) Minor changes resulting from the code review.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-16 13:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34143\">[34143]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span>) Minor changes resulting from the code review.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-14 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34118\">[34118]</a></span>: Clear EC2SpotRequestID from job ad along with job id, etc. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span> When scrubbing the job ad of data related to a previous submission attempt, include EC2SpotRequestID and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GridJobStatus\" title=\"Grid Job Status\">GridJobStatus</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-13 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34109\">[34109]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span>) Add (deliberately) content-free version history entry.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-08 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34056\">[34056]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3209\" onclick=\"get_ticket_and_populate_wrapper('3209'); return false;\" title=\"Add support for spot instances to EC2 GAHP\">#3209</a></span>) Copy <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StateReasonCode\" title=\"State Reason Code\">StateReasonCode</a></span> to the job ad, put the job on hold if bad.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Aug-04 13:16", "status": "resolved", "created": "2012-Aug-24 16:14", "fixed_version": "2012-Aug-24 16:14", "broken_version": "", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "s8199", "customer_group": "other", "visibility": "public", "notify": "jfrey@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}