{"id": 5295, "title": "Ticket #5295: Add RPC in shadow for starter to fetch opaque credential from shadow.", "description": "<blockquote>\nAssuming that any job in the queue implies that an opaque credential has already been stored by the credd, the shadow can then grab that credential directly without talking to the schedd or credd.  (It must exist on the local disk in SEC_CREDENTIAL_DIR/&lt;user&gt;.cred)\n\n<p>Before running the job, the starter will get the credential from the shadow via daemoncore command CREDD_GET_PASSWD.  See ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5296\" title=\"Starter needs to receive opaque credential, store, and activate it\">#5296</a></span> for the starter side of things.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Oct-13 16:13:37 by tannenba:</em> <br/>\n\nWhy are we sending the uberticket from the shadow to the starter via a file transfer sub-command? That code is already so complicated.... plus the starter may end up simply discarding it if a .cc file already exists on the execute node.\n\n<p>How about the alternate idea:\n\n</p><p>The starter is born with a socket back to the shadow for remote system calls and a copy of the job classad. For remote system calls, the starter acts as the client and the shadow is the server. So instead of file transfer munging, how about if the job classad has an attribute saying the job needs an uberticket, and the .cc file does not already exist, the starter simply does a remote system call back to the shadow to securely (ie with cedar encryption enabled) pull the uberticket (and then store it, sighup, etc). This could be done very early in the lifetime of the starter, before any file transfer crap.\n\n</p><p>Advantages:\n</p><ol>\n<li>This works cleanly even if the user does not want any file transfer (which will be the common case at CERN)\n</li><li>It is much simpler conceptually, and probably implementation wise as well vs expanding the file transfer stuff\n</li><li>Because the starter simply pulls the uberticket (instead of the shadow pushing it), if the .cc file already exists at the execute node (also common), then nothing is unnecessarily transferred.\n</li></ol>\n\n<p>Thoughts?\n\n</p><p></p><hr/>\n<em>2015-Oct-14 12:01:42 by zmiller:</em> <br/>\n\nI agree sending using file transfer is not a good idea, having initially gone down this road.  I've abandoned that approach.  A couple other ideas I had:\n\n<p></p><ol>\n<li>Send uberticket as part of claim activation.  This minimizes round trips perhaps but requires changing that protocol in a backwards compatible way which may also be complex.\n\n<p></p></li><li>Have shadow send a new command to starter to store the credential before running the job.\n\n<p></p></li><li>Have the starter pull the credential from the credd via RPC since the credd is managing those tokens.\n\n<p></p></li><li>Have the starter pull the credential from the shadow via RPC (todd's suggestion).\n</li></ol>\n\n<p>Given that the socket from starter to shadow already exists, ##4 seems like it is the most straightforward to implement, and I am going with that.\n\n</p><p></p><hr/>\n<em>2015-Oct-14 18:45:19 by zmiller:</em> <br/>\n\nThe shadow currently supports this using a separate daemoncore command, CREDD_GET_PASSWD, using the same wire protocol as the CredD.  The advantage of that is you could just as easily point it at a CredD instead of a shadow.  However, it does mean an extra TCP connect, so I may switch this to a SYSCALL.  For now, though, I am resolving this ticket.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-14 17:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45981\">[45981]</a></span>: Have the shadow handler for CREDD_GET_PASSWD actually pull it off disk <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5295\" title=\"Add RPC in shadow for starter to fetch opaque credential from shadow.\">#5295</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-14 15:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45975\">[45975]</a></span>: Add handler in shadow to handle CREDD_GET_PASSWD so the starter can invoke it directly. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5295\" title=\"Add RPC in shadow for starter to fetch opaque credential from shadow.\">#5295</a></span>  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Apr-26 20:57", "status": "resolved", "created": "2015-Oct-07 12:59", "fixed_version": "2015-Oct-07 12:59", "broken_version": "", "priority": "1", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#5272", "creator": "zmiller", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": "20151016"}