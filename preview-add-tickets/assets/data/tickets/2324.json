{"id": 2324, "title": "Ticket #2324: improve handling of glexec failure", "description": "<blockquote>\nHi all.\n\n<p>While trying to use glexec at various sites, I have noticed that a glexec failure results in different behavior, depending on which step fails:\n\n</p><p>1) If condor_glexec_setup fails, the job receives a shadow exception and stays in idle state, to be rapidly re-matched to the same glidein.\n\n</p><p></p><div class=\"verbatim\">\n<pre>07/16/11 17:31:25 (pid:30030) GLExecPrivSepHelper::run_script: /home/cmsplt023\n/pbstmp.14755696.grid-batch5.desy.de/glide_K25961/main/condor/libexec\n/condor_glexec_setup exited with status 256 and following output:\n[gLExec]:   LCMAPS failed.\n\n07/16/11 17:31:25 (pid:30030) ERROR \"error changing sandbox ownership to the\nuser\" at line 162 in file /home/condor/execute/dir_17004/userdir\n/src/condor_starter.V6.1/glexec_privsep_helper.linux.cpp\n</pre></div>\n\n\n<p>2) If condor_glexec_run fails, the job is instead put on hold.\n\n</p><p></p><div class=\"verbatim\">\n<pre>07/16/11 03:16:57 (pid:18230) IWD: /tmp/2086739.1.cms/glide_X12886/execute/dir_18230\n07/16/11 03:16:57 (pid:18230) Renice expr \"0\" evaluated to 0\n07/16/11 03:16:57 (pid:18230) Using wrapper /tmp/2086739.1.cms/glide_X12886\n/condor_job_wrapper.sh to exec /tmp/2086739.1.cms/glide_X12886/execute/dir_18230/condor_exec.exe\n07/16/11 03:16:57 (pid:18230) GLEXEC: error reading hello from glexec_job_wrapper\n07/16/11 03:16:57 (pid:18230) GLEXEC: glexec call exited with status 203\n07/16/11 03:16:57 (pid:18230) GLEXEC: error output: [gLExec]:   LCMAPS failed.\n07/16/11 03:16:57 (pid:18230) ERROR \"Create_Process(/tmp/2086739.1.cms\n/glide_X12886/condor_job_wrapper.sh,/tmp/2086739.1.cms/glide_X12886/execute\n/dir_18230/condor_exec.exe, ...) failed:  glexec call exited with status 203\nand with error output (IS: Executing \"/opt/glite/sbin/glexec\"\n\"/tmp/2086739.1.cms/glide_X12886/glrun.sh\"; #!/bin/bash; cd \"/tmp/2086739.1.cms\n/glide_X12886/execute/dir_18230\"; exec '/tmp/2086739.1.cms/glide_X12886\n/main/condor/libexec/condor_glexec_job_wrapper' '/dev/null' '/tmp/2086739.1.cms\n/glide_X12886/execute/dir_18230/a.out.170.0' '/tmp/2086739.1.cms/glide_X12886\n/execute/dir_18230/a.err.170.0' '/tmp/2086739.1.cms/glide_X12886\n/condor_job_wrapper.sh'\n'/tmp/2086739.1.cms/glide_X12886/execute/dir_18230/condor_exec.exe';\n[gLExec]:   LCMAPS failed.)\" at line 559 in file /home/condor/execute/dir_17004/userdir/src/condor_starter.V6.1/os_proc.cpp\n</pre></div>\n\n\n<p>Can you please make the behavior more similar in all scenarios?\nBTW: I think that the putting of the job on hold is actually a good thing.\n\n</p><p>Thanks,\n   Igor</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Jul-19 17:19:17 by danb:</em> <br/>\n\nIgor and I discussed possible solutions.  The one we agreed was best for now is to try the glexec operation X times and then in case of failure put the job on hold.\n\n<p>Among other things, this should help avoid rapid failure in the case where a user is rejected by the mapping service.  It would be nice to steer the user away from the problematic site rather than just putting all of their jobs on hold.  If needed, we envision latter adding some sort of black hold avoidance mechanism in the schedd that addresses that problem.\n\n</p><p></p><hr/>\n<em>2011-Aug-24 11:44:37 by danb:</em> <br/>\n\nI am splitting the remaining item to be done (retries) into a new ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2415\" onclick=\"get_ticket_and_populate_wrapper('2415'); return false;\" title=\"add automatic retries to glexec\">#2415</a></span>, since the hold-on-failure behavior is already being released in 7.7.1.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-22 09:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22583\">[22583]</a></span>: Fixed windows build broken by my previous commit. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2324\" onclick=\"get_ticket_and_populate_wrapper('2324'); return false;\" title=\"improve handling of glexec failure\">#2324</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-21 16:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22578\">[22578]</a></span>: Improved error handling when using glexec. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2324\" onclick=\"get_ticket_and_populate_wrapper('2324'); return false;\" title=\"improve handling of glexec failure\">#2324</a></span> ===VersionHistory=== When using privsep or glexec, failure to change the ownership of the job's execute directory now causes the job to be put on hold with a specific hold code and a hold reason that describes the failure. Previously, these\u00a0[...]\n (By danb )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Aug-24 12:09", "status": "resolved", "created": "2011-Jul-19 17:14", "fixed_version": "2011-Jul-19 17:14", "broken_version": "v070000", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "s8064", "customer_group": "cms", "visibility": "public", "notify": "sfiligoi@fnal.gov, burt@fnal.gov,dan@hep.wisc.edu", "due_date": ""}