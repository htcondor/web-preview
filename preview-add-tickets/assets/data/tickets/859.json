{"id": 859, "title": "Ticket #859: startd does not correctly do claim cleanup", "description": "<blockquote>\nI observed a number of machines in the CS pool that have been rejecting claim requests for over 2 weeks without ever successfully running a job during that time.  The startd reports:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">10/15 12:39:41 (fd:7) (pid:2164) slot1: Request to claim resource refused.\n</pre></div>\n\n\n<p>The claim requests are rejected because there are left over attributes in the slot ad from some previous job that ran and was booted off due to using too much memory.  These left over attributes are not visible via condor_status, even when using -direct.  This is because the startd generates ads from scratch when publishing or responding to queries.  The extra attributes are visible when using D_MACHINE at the time the claim request is made.\n\n</p><p>There is no longer evidence for exactly how the startd got into this state.  However, I have reproduced essentially the same behavior by finding several problematic code paths in the startd where proper claim cleanup is not done.  These do not appear to be new problems.  The bad code paths that I found all happened to be related to what we do after failing to send signals to the starter.  These code paths either bypassed the preempting state altogether or failed to call leave_preempting_state().  The consequences of this could include other bad things in addition to not cleaning out job attributes from the slot ad.\n\n</p><p>Assuming the problem was caused by the code paths I found, this does not appear to be a new problem in 7.3.2.  However, it is puzzling why so many machines in the CS pool are in this bad state (about 7% of the p cluster).  Perhaps there is another bad code path that I have not found yet.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Oct-15 12:53:22 by danb:</em> <br/>\n\nI pushed a patch for 7.4.1 for the cases I found.  Since it does not appear to be a regression, I am not elevating this to 7.4.0, which is almost out the door.  Until we find further evidence of this problem, I am closing this ticket.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-04 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25093\">[25093]</a></span>: Documented fix for machine classad cleanup problem. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=859\" onclick=\"get_ticket_and_populate_wrapper('859'); return false;\" title=\"startd does not correctly do claim cleanup\">#859</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-16 13:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16102\">[16102]</a></span>: Fixed cases in startd where claim cleanup was not correctly done. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=859\" onclick=\"get_ticket_and_populate_wrapper('859'); return false;\" title=\"startd does not correctly do claim cleanup\">#859</a></span> When failing to send signals to the starter, the startd either bypassed the preempting state or failed to call leave_preempting_state(). This resulted in attributes from the old claim remaining in the slot ad. These attributes were\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-15 12:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16076\">[16076]</a></span>: Fixed cases in startd where claim cleanup was not correctly done. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=859\" onclick=\"get_ticket_and_populate_wrapper('859'); return false;\" title=\"startd does not correctly do claim cleanup\">#859</a></span> When failing to send signals to the starter, the startd either bypassed the preempting state or failed to call leave_preempting_state(). This resulted in attributes from the old claim remaining in the slot ad. These attributes were\u00a0[...]\n (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 13:41", "status": "resolved", "created": "2009-Oct-15 12:48", "fixed_version": "2009-Oct-15 12:48", "broken_version": "v070302", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}