{"id": 6764, "title": "Ticket #6764: TCP_FORWARDING_HOST vs PRIVATE_NETWORK_*", "description": "<blockquote>\nThe following five-line configuration does not result in an advertised private network (name or interface/address):\n\n<p></p><div class=\"code\">\n<pre class=\"code\">USE_SHARED_PORT = FALSE\n# This line may be superfluous / redundant\nNETWORK_INTERFACE = $(IP_ADDRESS)\nPRIVATE_NETWORK_NAME = tannenba\nPRIVATE_NETWORK_INTERFACE = $(IP_ADDRESS)\nTCP_FORWARDING_HOST = 1.2.3.4\n</pre></div>\n\n\n<p>It appears that <code>DaemonCore::InfoCommandSinfulStringMyself()</code> has a bug where TCP_FORWARDING_HOST changes the public IP of the sinful /after/ the determination of whether to advertise the private network attributes (we don't if the public and private sinfuls aren't different).\n\n</p><p>This problem doesn't happen when USE_SHARED_PORT is TRUE (the default), which probably means that the above test is probably broken.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Sep-14 18:37:58 by tlmiller:</em> <br/>\n\nAfter further investigation, this may have been a testing problem.  We <em>deliberately</em> don't set TCP_FORWARDING_HOST in the .address files, because those are intended only for local communication.  So, using the test configuration:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ condor_status -master -af MyAddress\n&lt;1.2.3.4:32845?PrivAddr=%3c69.130.241.97:32845%3e&amp;PrivNet=tannenba&amp;addrs=1.2.3.4-32845&amp;noUDP&gt;\n$ cat ../install/local/log/.master_address\n&lt;69.130.241.97:32845?addrs=69.130.241.97-32845&gt;\n$CondorVersion: 8.7.10 Sep 14 2018 BuildID: UW_development PRE-RELEASE-UWCS $\n$CondorPlatform: X86_64-Debian_7 $\n</pre></div>\n\n\n<p>You see that without shared port, the address file uses the specified NETWORK_INTERFACE.  The address file does not include the private network name, which make no sense for local communication, but the actual advertised Sinful does.  (Arguably, you could have a private network address that you'd rather use for local communication, but since we don't support that, using the specified NETWORK_INTERFACE is the most likely to result in locally-routed packets, since the kernel must know about that interface for anything else to work.)\n\n</p><p>With shared port:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_status -master -af MyAddress\n&lt;1.2.3.4:40095?PrivAddr=%3c69.130.241.97:40095%3fsock%3d29510_4c4b%3e&amp;PrivNet=tannenba&amp;addrs=1.2.3.4-40095&amp;noUDP&amp;sock=29510_4c4b&gt;\n$ cat ../install/local/log/.master_address\n&lt;1.2.3.4:40095?PrivAddr=%3c69.130.241.97:40095%3fsock%3d29510_4c4b%3e&amp;PrivNet=tannenba&amp;addrs=1.2.3.4-40095&amp;noUDP&amp;sock=29510_4c4b&gt;\n$CondorVersion: 8.7.10 Sep 14 2018 BuildID: UW_development PRE-RELEASE-UWCS $\n$CondorPlatform: X86_64-Debian_7 $\n</pre></div>\n\n\n<p>You can see that the address file uses the same address as the advertised address, because it's using (must use) the shared port's address.  Arguably, the on-disk shared port ad should include what would otherwise be in its .address file, but that's not what we do for whatever reason.\n\n</p><p></p><hr/>\n<em>2018-Sep-17 13:34:42 by tlmiller:</em> <br/>\n\nResolving since we can't reproduce.  Best guess is that ToddT forgot to restart the shared port daemon after making the changes.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "incident", "last_change": "2018-Sep-17 13:34", "status": "resolved", "created": "2018-Sep-12 16:22", "fixed_version": "2018-Sep-12 16:22", "broken_version": "v080612", "priority": "2", "subsystem": "Libs", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}