{"id": 6453, "title": "Ticket #6453: Garbage collection for public HTTP transfer", "description": "<blockquote>\nPublic HTTP transfers currently have no garbage collection; the hard links they create stay in the webroot folder indefinitely. When creating hard links, let's create an additional empty file with the same hash name and .access extension. We can look at these .access files later to determine when the hard link was created, and if it's older than a certain time period (we'll set this in a knob) then delete it.</blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-26 15:52:57 by coatsworth:</em> <br/>\n\nOne thing we need to deal with here is a race condition between condor_preen trying to delete an old link, at the same time the shadow is trying to update it.\n\n<p>I think the simplest solution is to treat .access files like locks.\n\n</p><p>The very first thing the shadow will do when creating/updating a link is delete the .access file. This is the equivalent of grabbing the lock, since preen cannot delete a hard link without the .access file. Don't even check if exists, since that would break atomicity. Just unlink it and move on.\n\n</p><p>The last thing the shadow will do when creating/updating a link is create a new .access file (with new timestamp).\n\n</p><p>Thoughts?\n\n</p><p><em>2017-Dec-4 15:37:57 by coatsworth:</em> <br/>\n\nIt turns out my suggestion above did not eliminate all race conditions. We ended up implementing this using file locks on the access file.\n\n</p><p></p><hr/>\n<em>2017-Dec-06 11:06:33 by coatsworth:</em> <br/>\n\nDuplicate of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6452\" onclick=\"get_ticket_and_populate_wrapper('6452'); return false;\" title=\"Fix hard link security problems with public HTTP transfers\">#6452</a></span></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "todo", "last_change": "2017-Dec-06 11:23", "status": "abandoned", "created": "2017-Oct-17 13:05", "fixed_version": "2017-Oct-17 13:05", "broken_version": "v080703", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "coatsworth", "derived_from": "#6356", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, zmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}