{"id": 6420, "title": "Ticket #6420: Python submit object does not behave the same as condor_submit", "description": "<blockquote>\nThe Python binding object htcondor.Submit() is supposed to allow users to use the familiar submit-file keywords to submit jobs.  Unfortunately, submitting the same job with <code>condor_submit</code> results in a different job classad than submitting via the Python the htcondor.Submit() object.  Primary reason appears that the python Submit.queue() always does the most backward compatible thing, while condor_submit command-line tool checks the version of the schedd you are trying to submit to and will use the most up-to-date features that the schedd will support. This impacts file transfer, as well as the way the job\u2019s environment is specified, and possibly a few other things.\n\n<p>First reported by Xin Wang in <a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2017-September/msg00123.shtml\">this htcondor-users thread</a>.\n\n</p><p>Here is code that demonstrates the problem by submitting the same job via Python and via condor_submit, and then comparing the respective job classads that end up in the schedd:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#!/usr/bin/env python\n\nimport os\nimport htcondor\n\n#\n# Create a submit object with a simple job\n#\nsub = htcondor.Submit()\nsub['universe'] = 'vanilla'\nsub['environment'] = '\"PYTHONHOME=/my/path/to/anaconda3\"'\nsub['executable'] = '/usr/bin/python'\nsub['arguments'] = '/my/path/to/scripts/myrun.py'\nsub['log'] = '/tmp/job.log'\nsub['output'] = '/tmp/test.log'\nsub['error'] = '/tmp/test.err'\nsub['should_transfer_files'] = 'YES'\nsub['hold'] = 'true'\n\n#\n# Use HTCondor python bindings to submit the job, and\n# save this job id in jobId1\n#\nschedd = htcondor.Schedd()\nwith schedd.transaction() as txn:\n  jobId1 = sub.queue(txn)\n\n#\n# Now convert the job described in the submit object into a\n# string containing name=value pairs, and use this string as stdin\n# to condor_submit.  Save this job id in jobId2\n#\njob = \"\"\nfor x in sub.items():\n  job += x[0] + \" = \" + x[1] + \"\\n\"\njob += \"queue \\n\"\njobId2=os.popen(\"echo '\" + job + \"' | condor_submit -terse - | awk '{print $1}'\" ).read().rstrip()\n\n#\n# Finally compare the two jobs.  Hopefully they are the same.\n#\nos.system(\"condor_q -l \" + str(jobId1) + \" \" + jobId2 + \" | sort | uniq -u\")\n</pre></div>\n\n\n<p>The only job attributes that should be different between the two jobs should <code>ClusterId</code> and <code>GlobalJobId</code>, but unfortunately that is not the case.  Behold when testing on HTCondor v8.6.6:\n\n</p><p></p><div class=\"verbatim\">\n<pre>[tannenba@localhost test]$ ./pytestrun.py\nClusterId = 34\nClusterId = 35\nCumulativeRemoteSysCpu = 0.0\nCumulativeRemoteUserCpu = 0.0\nEnvDelim = \";\"\nEnvironment = \"PYTHONHOME=/my/path/to/anaconda3\"\nEnv = \"PYTHONHOME=/my/path/to/anaconda3\"\nErr = \"_condor_stderr\"\nErr = \"/tmp/test.err\"\nGlobalJobId = \"localhost#34.0#1506453150\"\nGlobalJobId = \"localhost#35.0#1506453150\"\nOut = \"_condor_stdout\"\nOut = \"/tmp/test.log\"\nTransferOutputRemaps = \"_condor_stdout=/tmp/test.log;_condor_stderr=/tmp/test.err\"\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2017-Sep-26 15:23:22 by tannenba:</em> <br/>\n\nThings look much better when re-running the test program above applying the patches in this ticket:\n\n<p></p><div class=\"verbatim\">\n<pre>[tannenba@localhost test]$ ./pytestrun.py\nClusterId = 38\nClusterId = 39\nGlobalJobId = \"localhost#38.0#1506454292\"\nGlobalJobId = \"localhost#39.0#1506454292\"\n</pre></div>\n\n\n<p></p><hr/>\n<em>2017-Sep-27 09:41:39 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> changes look good.\n\n<p></p><hr/>\n<em>2017-Oct-25 10:24:34 by tim:</em> <br/>\n\n<strong>Doc Review:</strong> OK</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-26 15:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52429\">[52429]</a></span>: Version history blurb for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6420\" title=\"Python submit object does not behave the same as condor_submit\">#6420</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-26 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52426\">[52426]</a></span>: Submit utils object fails to intialize a few attributes. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6420\" title=\"Python submit object does not behave the same as condor_submit\">#6420</a></span> A couple of attributes initialized in condor_submit are not initialized in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SubmitHash\" title=\"Submit Hash\">SubmitHash</a></span> object.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-26 14:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52425\">[52425]</a></span>: Python bindings must init <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SubmitHash\" title=\"Submit Hash\">SubmitHash</a></span> with remote schedd version. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=6420\" title=\"Python submit object does not behave the same as condor_submit\">#6420</a></span> This is required to produce the same job classad as condor_submit. Also should initialize file checks via knob SUBMIT_SKIP_FILECHECKS.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Oct-25 10:24", "status": "resolved", "created": "2017-Sep-26 13:59", "fixed_version": "2017-Sep-26 13:59", "broken_version": "v080600", "priority": "3", "subsystem": "PythonBinding", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}