{"id": 4905, "title": "Ticket #4905: Avoid matchmaking schedds near limits", "description": "<blockquote>\nWhen a schedd is near its resource limits (i.e., near the MAX_JOBS_RUNNING), it will still send large resource requests to the negotiator.\n\n<p>For example, CMS has a schedd with an autocluster of size 70,000.  The schedd is running 19,999 jobs (MAX_JOBS_RUNNING is set to 20,000).  It will still happily send out the resource request to the negotiator - in our case, the negotiator sends back 4,000 matches; the schedd drops them on the floor.  Because the glideins aren't used, they eventually exit - causing significant churn.  There <strong>are</strong> other schedds in the pool that have plenty of capacity - it's just that this problematic one eats up all the potential matches.\n\n</p><p>I propose a two-pronged fix:\n</p><ul>\n<li>New config variable, <code>CURB_MATCHMAKING</code>.  This is an expression which is inserted into the schedd ad.  When this evaluates to true, we do not offer any new resource requests to the matchmaker.\n</li><li>Adjust the resource request count to be no more than max_offers = (MAX_JOBS_RUNNING - # shadows running).  Prevent more than max_offers job requests from being outstanding with the negotiator at any time in the asynchronous protocol.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Mar-19 16:57:52 by tannenba:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Nice patch, thanks!  Looks good.  Merged to master.\n\n</p><p></p><hr/>\n<em>2015-Mar-19 17:07:23 by tannenba:</em> <br/>\n\nRegression testing thoughts... (for bill)\n\n<p>In condor_config set\n\n</p><p></p><pre>  MAX_JOBS_RUNNING = 2\n</pre>\n\n<p>Then submit 100 jobs with <code>queue 100</code> so that all jobs end up in the same autocluster.  Should then see a line in the <code>ScheddLog</code> that says\n\n</p><p></p><pre>  03/19/15 15:34:31 Offering 2 jobs instead of 100 to the negotiator for this cluster; nearing internal limits (MAX_JOBS_RUNNING, etc).</pre>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-17 13:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44665\">[44665]</a></span>: minor edit of 8.3.5 version history item and new knob's definition <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4905\" onclick=\"get_ticket_and_populate_wrapper('4905'); return false;\" title=\"Avoid matchmaking schedds near limits\">#4905</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-16 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44654\">[44654]</a></span>: Documentation for CURB_MATCHMAKING and version history blurbs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4905\" onclick=\"get_ticket_and_populate_wrapper('4905'); return false;\" title=\"Avoid matchmaking schedds near limits\">#4905</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-19 16:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43632\">[43632]</a></span>: Avoid matchmaking with schedds near limits. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4905\" onclick=\"get_ticket_and_populate_wrapper('4905'); return false;\" title=\"Avoid matchmaking schedds near limits\">#4905</a></span> Previously, the scheduler would send out very large resource requests (in the wild, we observed 70,000 jobs in an autocluster) despite being at-or-near the MAX_JOBS_RUNNING limit. This tracks how close we are to the limit and trims resource requests accordingly.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-20 09:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=43426\">[43426]</a></span>: Avoid matchmaking with schedds near limits. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4905\" onclick=\"get_ticket_and_populate_wrapper('4905'); return false;\" title=\"Avoid matchmaking schedds near limits\">#4905</a></span> Previously, the scheduler would send out very large resource requests (in the wild, we observed 70,000 jobs in an autocluster) despite being at-or-near the MAX_JOBS_RUNNING limit. This tracks how close we are to the limit and trims resource requests accordingly.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Apr-16 13:58", "status": "resolved", "created": "2015-Feb-20 09:14", "fixed_version": "2015-Feb-20 09:14", "broken_version": "", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}