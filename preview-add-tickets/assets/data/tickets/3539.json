{"id": 3539, "title": "Ticket #3539: change recommended configuration for disabling preemption", "description": "<blockquote>\nThere are several known problems with use of <code>MaxJobRetirementTime</code>:\n\n<p></p><ul>\n<li>Jobs wait to run on a busy slot and only periodically try getting a new match.  This can make it difficult to understand why things happen --- the order in which jobs start running, and which machines they run on.\n\n<p></p></li><li>While jobs are waiting to run, a TCP connection exists between the schedd and the startd.  This consumes a file descriptor in the schedd.  If the schedd runs low on file descriptors, this can cause communication failures that result in unexpected behavior.  For example, I have seen a case where the schedd was unable to authenticate to the collector, so it could not advertise submitters.\n\n<p></p></li><li>A job that is matched and waiting to run on a busy slot becomes unavailable for being matched to flocked pools.\n\n<p></p></li><li>While a claim is in the Claimed/Retiring or Preempting state, the resource is not counted as belonging to the preempting user.  Preempting claims therefore do not subtract from the calculated share of the pool that should be given to the preempting user.  This can result in the preempting user being given claims to more and more machines across multiple negotiation cycles. <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=2270\" onclick=\"get_ticket_and_populate_wrapper('2270'); return false;\" title=\"spinning pie algorithm + preemption = unfair allocation\">#2270</a></span>\n</li></ul>\n\n<p><span class=\"section\"></span></p><h2>Proposed Change</h2>\n\n<p>We considered two possible solutions.  One is simply to stop recommending use of <code>MaxJobRetirementTime</code> in the section in the manual on disabling preemption.  The default CLAIM_WORKLIFE is non-zero these days, so setting PREEMPTION_REQUIREMENTS=False and Rank=0 is not such a bad thing as it used to be.  The other option is to change things so that when <code>MaxJobRetirementTime</code> would cause delayed preemption, the default negotiation policy will avoid matching jobs to the slot.\n\n</p><p>Assuming we go with the second option, here is a plan for what would need to be done:\n\n</p><p></p><ul>\n<li>Make the startd advertise the time when retirement of the current job would end: <code>RetirementTimeRemaining</code>.  Currently, only the <code>MaxJobRetirementTime</code> expression is advertised.  This is not enough information for the negotiator to compute when retirement of the current running job would end.\n\n<p></p></li><li>Add a new option in the negotiator: NEGOTIATOR_CONSIDER_EARLY_PREEMPTION.  The default will be FALSE, which causes slots that still have retirement time to be excluded from consideration during matchmaking.\n</li></ul>\n\n<p><span class=\"subsection\"></span></p><h3>Remaining Issues</h3>\n\n<p></p><ul>\n<li>Suspension does not count towards a job's retirement time, so <code>RetirementEndTime</code> could get extended when suspension happens.  A race condition could result in a job getting sent to a machine where the negotiator thought retirement should have ended but which extended retirement due to suspension.  Currently, the semantics of <code>MaxJobRetirementTime</code> are such that changes in the result of evaluating the expression take effect during retirement.  This can produce similar effects to suspension: the advertised <code>RetirementEndTime</code> may change, and this could result in a race condition affecting our policy of avoiding preemption during retirement.  One way to solve the race condition would be to modify the job/machine requirements to require that <code>RetirementEndTime</code> be in the past.\n\n<p></p></li><li>The proposed policy addresses lengthy retirement times but not lengthy preemption times, which could result from a large <code>MachineMaxVacateTime</code> and jobs that take a long time to go away.  Many of the problems associated with long retirement also apply to long preemption.  I don't propose changing the default policy, but I do think it would be prudent to advertise <code>VacateEndTime</code>.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Apr-23 15:18:58 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Love it.  Thanks for the patch!  My only comment is the version history should probably mention the change to the default value for <code>CLAIM_WORKLIFE</code>.\n\n</p><p></p><hr/>\n<em>2013-Apr-23 15:28:16 by danb:</em> <br/>\n\nHi Todd.  There was no change to the default value of CLAIM_WORKLIFE.  It's been 3600 for a while now.  However, I did notice a place in the manual that was out of sync with the current default, so I updated that in my patch.  Maybe that's what you noticed.\n\n<p></p><hr/>\n<em>2013-Apr-23 15:50:56 by tannenba:</em> <br/>\n\nYes, my bad, all good. Thanks.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-09 11:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35678\">[35678]</a></span>: clean up some manual index entries and formatting ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3539\" onclick=\"get_ticket_and_populate_wrapper('3539'); return false;\" title=\"change recommended configuration for disabling preemption\">#3539</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-07 17:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35641\">[35641]</a></span>: Edit many 7.9.6 version history items, including those for tickets (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3539\" onclick=\"get_ticket_and_populate_wrapper('3539'); return false;\" title=\"change recommended configuration for disabling preemption\">#3539</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3586\" onclick=\"get_ticket_and_populate_wrapper('3586'); return false;\" title=\"move python bindings out of contrib\">#3586</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3398\" onclick=\"get_ticket_and_populate_wrapper('3398'); return false;\" title=\"Batch GAHP cannot set remote memory or walltime requests\">#3398</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span>, <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2949\" onclick=\"get_ticket_and_populate_wrapper('2949'); return false;\" title=\"peaceful shutdown cannot be escalated to graceful\">#2949</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3493\" onclick=\"get_ticket_and_populate_wrapper('3493'); return false;\" title=\"Audit Log for Condor schedds\">#3493</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3496\" onclick=\"get_ticket_and_populate_wrapper('3496'); return false;\" title=\"monitor file transfer i/o activity\">#3496</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3597\" onclick=\"get_ticket_and_populate_wrapper('3597'); return false;\" title=\"CPU affinity enforcement broken with partitionable slots\">#3597</a></span>, <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=3601\" onclick=\"get_ticket_and_populate_wrapper('3601'); return false;\" title=\"autofs doesn't work with 7.9\">#3601</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3579\" onclick=\"get_ticket_and_populate_wrapper('3579'); return false;\" title=\"condor_updates_stats doesn't work anymore\">#3579</a></span>,) and (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3570\" onclick=\"get_ticket_and_populate_wrapper('3570'); return false;\" title=\"Starter leaks FDs to file transfer plugin\">#3570</a></span>, <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3588\" onclick=\"get_ticket_and_populate_wrapper('3588'); return false;\" title=\"DHCPREQUEST doesn't have the ending 0xff byte to mark end of options f\">#3588</a></span>)  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-25 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35546\">[35546]</a></span>: Improve documentation related to preemption. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3539\" onclick=\"get_ticket_and_populate_wrapper('3539'); return false;\" title=\"change recommended configuration for disabling preemption\">#3539</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-22 17:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35499\">[35499]</a></span>: Added NEGOTIATOR_CONSIDER_EARLY_PREEMPTION. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3539\" onclick=\"get_ticket_and_populate_wrapper('3539'); return false;\" title=\"change recommended configuration for disabling preemption\">#3539</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Apr-23 15:50", "status": "resolved", "created": "2013-Mar-12 16:43", "fixed_version": "2013-Mar-12 16:43", "broken_version": "v070906", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.wisc.edu,tannenba@cs.wisc.edu", "due_date": ""}