{"id": 4266, "title": "Ticket #4266: Matchmaker should avoid matching startds about to leave a glidein", "description": "<blockquote>\nEspecially in a glidein pool setting, it is a waste of time for the negotiator to make matches to startds that are likely to shutdown before the schedd is able to claim it.\n\n<p>As the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonShutdown\" title=\"Daemon Shutdown\">DaemonShutdown</a></span> attribute is advertised in the machine classad, a simple patch could allow the negotiator to ignore ads that are going to go away soon.\n\n</p><p>The thinking is to accomplish this via a new negotiator knob, NEGOTIATOR_TRIM_SHUTDOWN_THRESHOLD, an expression evaluated to an integer value within the context of the negotiator classad, with a default value of 0.  When this expression evaluates to an integer X, and X is greater than 0, the negotiator will not make matches to machine ads that contain a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonShutdown\" title=\"Daemon Shutdown\">DaemonShutdown</a></span>\nattribute that evalutes to true when attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span> is set to be X seconds into the future.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Mar-18 13:32:07 by tannenba:</em> <br/>\n\nThe assumption here is that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonShutdown\" title=\"Daemon Shutdown\">DaemonShutdown</a></span> contains logic like\n\n<p></p><pre>   Activity==\"Unclaimed\" &amp;&amp; (CurrentTime - EnteredCurrentActivity &gt;\nGLIDEIN_Max_Idle)\n</pre>\n\n<p>Unfortunately this is not currently true of glideInWMS, which actually contains logic like\n\n</p><p></p><pre>   TotalTimeUnclaimedIdle &gt; GLIDEIN_Max_Idle\n</pre>\n\n<p>which is incorrect as it will result in the startd shutting down once it has hit a total\nof 20 minutes of idle time across its entire lifetime, ie. perhaps the\nslot is continuously being used, but there is 5 minutes of idle time\nbetween jobs.  After four jobs, the startd will shutdown, which is not the desired behavior.\n\n</p><p>Parag and I talked about this - I suggest that glideInWMS make the change above to reference <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span>, and then set NEGOTIATOR_TRIM_SHUTDOWN_THRESHOLD to whatever value Igor suggests.  Note it could be set to be a function of the length of the previous negotiation cycle, which may have a nice self-limiting property.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-27 15:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39735\">[39735]</a></span>: edit documentation for new knob NEGOTIATOR_TRIM_SHUTDOWN_THRESHOLD <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4266\" title=\"Matchmaker should avoid matching startds about to leave a glidein\">#4266</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-18 13:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39656\">[39656]</a></span>: Added knob NEGOTIATOR_TRIM_SHUTDOWN_THRESHOLD. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4266\" title=\"Matchmaker should avoid matching startds about to leave a glidein\">#4266</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Oct-09 17:47", "status": "resolved", "created": "2014-Mar-18 13:29", "fixed_version": "2014-Mar-18 13:29", "broken_version": "", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "burt@fnal.gov, parag@fnal.gov, bbockelm@cse.unl.edu, sfiligoi@fnal.gov", "due_date": ""}