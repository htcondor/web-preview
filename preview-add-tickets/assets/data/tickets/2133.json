{"id": 2133, "title": "Ticket #2133: [Debian] Modify init script to handle /var/run as tmpfs", "description": "<blockquote>\nWith the current init scripts, Condor assumes that /var/run persists. Debian's assumption is that it is cleaned on startup, hence whatever should be in there needs to be recreated on startup.</blockquote>", "remarks": "<blockquote>\n<em>2011-May-06 11:11:35 by cweiss:</em> <br/>\n\nTim suggested (for this ticket and also <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2137\" onclick=\"get_ticket_and_populate_wrapper('2137'); return false;\" title=\"[Debian] Add dependency on remote fs to init script\">#2137</a></span>) to a) have separate init script for deb and rpm, and b) start off with the Debian 6 default init script for the deb version. That way we can deal with different policies more easily. I really like that idea and think it will save us some trouble in the future.\n\n<p></p><hr/>\n<em>2011-May-06 14:41:35 by cat:</em> <br/>\n\nYeah, like Cathrin wrote... Just some extra notes here:\n\n<p>On Debian 5, at least, there is a \"skeleton\" init script template that ships with the OS. It is located at\n\n</p><p>/etc/init.d/skeleton\n\n</p><p>It is very helpful to see how Debian thinks an init script should be written. Not that we have to follow it slavishly, but that we should use it and stick to its conventions where sensible. It does some things very nicely, like loading default environment variables, using LSB, and handling the start and stop of services in a very Debian way.\n\n</p><p>Note that the skeleton init script uses LSB functions. Therefore, there MUST be a run-time dependency on the LSB package -- Debian's dependency-checking scripts will not find it automatically, and so it must be added manually. At least, this is what we found on the LIGO packages. The comment in the init script (again, my sample is Debian 5) says it all: Depend on lsb-base (&gt;= 3.0-6) to ensure that this file is present.\n\n</p><p>I have worked with this template a few times for various init services for LIGO, and so I would be happy to help merge together the existing Condor init script with the Debian stuff. Let me know how I can be useful!\n\n</p><p></p><hr/>\n<em>2011-Dec-20 12:50:40 by jfrey:</em> <br/>\n\nSome more details about the current init script:\nIt requires that the directory <code>/var/run/condor</code> persist across reboots. On Ubuntu 11.10, /var/run is tmpfs and nothing in it survives a reboot. Condor fails to start after a reboot.\n\n<p>The script has some code to create /var/run/condor when starting the daemons, but it comes after a check for the directory's existence that terminates the script on failure.\n\n</p><p></p><hr/>\n<em>2011-Dec-20 13:42:25 by mih:</em> <br/>\n\nThis is exactly what the modifications in the Debian package address. /var/run not being persistent is not just an Ubuntu problem. /var/run being tmpfs is perfectly fine with the FHS any other distro could do the same and Debian is AFAIK going to as well.\n\n<p></p><hr/>\n<em>2011-Dec-20 14:05:01 by jfrey:</em> <br/>\n\nSo whether or not we make a Debian-specific init file, we need to fix the init file we currently have.\n\n<p></p><hr/>\n<em>2011-Dec-20 14:58:25 by bbockelm:</em> <br/>\n\n/var/run is on tmpfs for Fedora, starting about F15 or so.  So, one can guess this is going to be an issue for some future RHEL (RHEL6 bases of F13; likely is fine there).\n\n<p></p><hr/>\n<em>2012-Jan-03 13:51:18 by tstclair:</em> <br/>\n\nIs the afore mentioned issue a restriction in the script itself or in some other workings of condor.  on F15 &amp;&amp; &gt;&gt; there is a separate condor.service for systemd\n\n<p></p><hr/>\n<em>2012-Jan-05 12:19:40 by jfrey:</em> <br/>\n\nIt's an assumption in the init file itself.\n\n<p></p><hr/>\n<em>2012-Jan-05 14:29:45 by jfrey:</em> <br/>\n\nI've attached a patch that fixes this problem. It also fixes a related problem of $USER not being set on some systems.\n\n<p></p><hr/>\n<em>2012-Jan-06 10:42:07 by jfrey:</em> <br/>\n\nMatt Farrellee mentioned this as a better solution to the tmpfs problem: <a class=\"external\" href=\"http://fedoraproject.org/wiki/Packaging:Tmpfiles.d\">http://fedoraproject.org/wiki/Packaging:Tmpfiles.d</a>. It's available in Fedora 15 and later.\n\n<p></p><hr/>\n<em>2012-Jan-25 11:38:14 by jfrey:</em> <br/>\n\nI'm resolving this ticket, as the immediate problem has been resolved. If we want to write a Debian-specific init script, we can open another ticket.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/515/init.patch\">init.patch</a>\n1965 bytes added by jfrey on 2012-Jan-05 20:28:30 UTC.\n<br/>\nPatch to fix init script. Don't assume /var/run/condor persists. Ensure $USER is set.\n<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-17 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=29125\">[29125]</a></span>: Minor 7.6.6 version history item edits for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2738\" onclick=\"get_ticket_and_populate_wrapper('2738'); return false;\" title=\"condor_ckpt_server is crashing\">#2738</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2736\" onclick=\"get_ticket_and_populate_wrapper('2736'); return false;\" title=\"schedd tries to kill pid 0 and then excepts\">#2736</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2133\" onclick=\"get_ticket_and_populate_wrapper('2133'); return false;\" title=\"[Debian] Modify init script to handle /var/run as tmpfs\">#2133</a></span>.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-05 15:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=29002\">[29002]</a></span>: Fix init script to handle /var/run as tmpfs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2133\" onclick=\"get_ticket_and_populate_wrapper('2133'); return false;\" title=\"[Debian] Modify init script to handle /var/run as tmpfs\">#2133</a></span> Don't assume /var/run/condor/ will persist across a reboot. Don't assume $USER will be set. ===VersionHistory:Complete===  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Jan-25 11:38", "status": "resolved", "created": "2011-May-06 09:44", "fixed_version": "2011-May-06 09:44", "broken_version": "v070000", "priority": "4", "subsystem": "", "assigned_to": "jfrey", "derived_from": "#2058", "creator": "cweiss", "rust": "", "customer_group": "other", "visibility": "public", "notify": "jfrey@cs.wisc.edu,cat@cs.wisc.edu , michael.hanke@gmail.com , cweiss@cs.wisc.edu", "due_date": ""}