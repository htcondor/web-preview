{"id": 5150, "title": "Ticket #5150: Tools should apply reasonable projection for daemon location", "description": "<blockquote>\nWhen querying the collector for daemon location, tools such as 'condor_q' get the kitchen sink - no projection is applied.\n\n<p>CMS has very large schedd ads (~100KB) because of the monitoring we have enabled.  I've noticed that, on high-latency and/or low-bandwidth links, this transfer back to the client can contribute significant portion of the overall query time.\n\n</p><p>We should apply a projection on <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span>.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-17 11:07:27 by jfrey:</em> <br/>\n\nThere will need to be a few more attributes in the projection, like <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersion\" title=\"Condor Version\">CondorVersion</a></span>.\n\n<p></p><hr/>\n<em>2015-Jul-28 14:21:20 by jfrey:</em> <br/>\n\nThe following attributes are consulted in the Daemon object. They would have to be part of the projection.\n\n<p></p><ul>\n<li>&lt;subsys&gt;IpAddr\n</li><li>Name\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span>\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersion\" title=\"Condor Version\">CondorVersion</a></span>\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorPlatform\" title=\"Condor Platform\">CondorPlatform</a></span>\n</li><li>Machine\n</li><li>AddressV1 and AddressV2 (for IPv6)\n</li></ul>\n\n<p>Additionally, the daemon's ad can be retrieved via a public method. In several places, callers query additional attributes, requiring potentially the full daemon ad. This could be handled by having an option to fetch the full ad. Here are the current places where more of the daemon ad is required:\n\n</p><p></p><ul>\n<li>condor_pigeon: a fragile attempt to lookup an attribute whose name ends with \"PORT\" from a pigeon ad.\n</li><li>condor_q: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SwapSpaceExhausted\" title=\"Swap Space Exhausted\">SwapSpaceExhausted</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobsRunning\" title=\"Max Jobs Running\">MaxJobsRunning</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalRunningJobs\" title=\"Total Running Jobs\">TotalRunningJobs</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartSchedulerUniverse\" title=\"Start Scheduler Universe\">StartSchedulerUniverse</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartLocalUniverse\" title=\"Start Local Universe\">StartLocalUniverse</a></span>\n</li><li>condor_config_val: -evaluate takes a config parameter's value and evaluates it in the context of the daemon ad\n</li><li>condor_history, condor_load_history: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueBirthdate\" title=\"Job Queue Birthdate\">JobQueueBirthdate</a></span>\n</li><li>python bindings: the daemon ad appears to be visible to python callers\n</li></ul>\n\n<p></p><hr/>\n<em>2015-Aug-06 17:26:00 by tannenba:</em> <br/>\n\nI would like daemon location queries sent to the collector to be tagged specifically as \"location lookups\", not just as generic queries with a small projections.  Ie the query ad to the collector should state that this is an address lookup.  One reason for this is instead of just shortening the projection, I'd like these lookups to always use an index on the collector.\n\n<p></p><hr/>\n<em>2015-Aug-09 05:37:37 by bbockelm:</em> <br/>\n\nThe solution I ended up with was to differentiate between \"LOCATE_FAST\" and \"LOCATE_FULL\" in the Daemon::locate method (defaulting to LOCATE_FULL).\n\n<p>When LOCATE_FAST is used, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorQuery\" title=\"Condor Query\">CondorQuery</a></span> indicates to the collector that this is a \"location query\" (in addition to providing a reasonable projection).\n\n</p><p>I went through and tagged as many tools as I had time to test (and, crucially, the negotiator lookup for the schedd's RESCHEDULE -- CMS has previously noted that this is an expensive lookup as it is done for every condor_submit; there's a ticket somewhere...).\n\n</p><p>If we go further down this road, we could consider flipping the default to LOCATE_FAST and marking just the tools Jaime noted which pull out the daemonAd.  ( <strong>NOTE:</strong> we essentially did this in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6223\" onclick=\"get_ticket_and_populate_wrapper('6223'); return false;\" title=\"Use a location lookup collector query by default\">#6223</a></span> for v8.7.2 )\n\n</p><p>Finally, I changed the default for locate in the python tools to LOCATE_FAST.  This was always the intent behind exposing a different \"locate\" versus \"query\" in the first place.  We'll just note to users that they will need to switch to 'query' if they want the full ad.\n\n</p><p></p><hr/>\n<em>2015-Aug-10 10:51:34 by tannenba:</em> <br/>\n\nThanks Brian.... I'd be happy to code review when the time comes if nobody else does so...\n\n<p></p><hr/>\n<em>2015-Aug-10 10:57:11 by tannenba:</em> <br/>\n\nBrian re your comment above about the expensive collector lookup that the schedd does upon a reschedule.... Hopefully that has been significantly improved after <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4821\" onclick=\"get_ticket_and_populate_wrapper('4821'); return false;\" title=\"Only fork collector for a few ad types\">#4821</a></span> got pushed into v8.3.3.\n\n<p></p><hr/>\n<em>2015-Aug-10 11:19:34 by bbockelm:</em> <br/>\n\nYup - that should make a good improvement.  However, there's still RTT between California and CERN to deal with -  still seems silly to do it multiple times a second if every 'condor_submit' invokes a reschedule.\n\n<p>Anyhow, there ss a separate ticket for this: <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4274\" onclick=\"get_ticket_and_populate_wrapper('4274'); return false;\" title=\"Excessive Negotiator lookups\">#4274</a></span>\n\n</p><p></p><hr/>\n<em>2015-Oct-21 10:55:22 by tannenba:</em> <br/>\n\nToddM must sign off on this from an IPv6 perspective.  Greg will consult with ToddM on some details here.\n\n<p></p><hr/>\n<em>2015-Nov-06 11:06:19 by tlmiller:</em> <br/>\n\nThis doesn't look like it will cause any problems for the IPv6 / multi-address work in the short-to-medium term.  In the long term, we may introduce yet another address attribute, but this can be readily extended to cover that.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6222\" onclick=\"get_ticket_and_populate_wrapper('6222'); return false;\" title=\"condor_q should use a projection when fetching schedd location\">#6222</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_q should use a projection when fetching schedd location</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6223\" onclick=\"get_ticket_and_populate_wrapper('6223'); return false;\" title=\"Use a location lookup collector query by default\">#6223</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nUse a location lookup collector query by default</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-15 14:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47606\">[47606]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span>) Python bindings: use <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span> for address  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-04 11:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=47557\">[47557]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-05 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46202\">[46202]</a></span>: Final cleanups for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-02 19:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46188\">[46188]</a></span>: Differentiate location lookups from queries. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span> The collector fundamentally has two roles: responding to queries for pool information (i.e., condor_status) and providing a DNS-like service for daemons (as is used in condor_q -pool pool.example.com -name foo).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-02 19:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46189\">[46189]</a></span>: Fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span> Rename LOCATE_FAST to LOCATE_FOR_LOOKUP Keep virtual functions virtual  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-29 15:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46178\">[46178]</a></span>: Fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span> Rename LOCATE_FAST to LOCATE_FOR_LOOKUP Keep virtual functions virtual  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-09 05:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45546\">[45546]</a></span>: Differentiate location lookups from queries. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5150\" onclick=\"get_ticket_and_populate_wrapper('5150'); return false;\" title=\"Tools should apply reasonable projection for daemon location\">#5150</a></span> The collector fundamentally has two roles: responding to queries for pool information (i.e., condor_status) and providing a DNS-like service for daemons (as is used in condor_q -pool pool.example.com -name foo).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Apr-12 13:53", "status": "resolved", "created": "2015-Jul-14 21:31", "fixed_version": "2015-Jul-14 21:31", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "gthain", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tannenba@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}