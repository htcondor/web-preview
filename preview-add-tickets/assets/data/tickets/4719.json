{"id": 4719, "title": "Ticket #4719: JobRouter fails to write userlog due to bad permissions", "description": "<blockquote>\n<span class=\"section\"><h2>Symptoms of the error:</h2></span>\n\n<p>When submitting a remote job to a Condor instance with a job router, we will see error messages in the job log that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> has aborted the job after the job has terminated and output has been retrieved (see attached job log). There is a corresponding error in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouterLog\" title=\"Job Router Log\">JobRouterLog</a></span> about being unable to write to the job log:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">11/13/14 11:29:08 (395.0) Writing terminate record to user logfile\n11/13/14 11:29:08 WriteUserLog::initialize: safe_open_wrapper(\"log\") failed - errno 13 (Permission denied)\n11/13/14 11:29:08 WriteUserLog::initialize: failed to open file log\n11/13/14 11:29:08 (-1.-1) Unable to open user log (event 5)\n</pre></div>\n\n\n<p>This does not appear to be an issue with grid universe jobs that are submitted to a client's local schedd.\n\n</p><p><span class=\"section\"></span></p><h2>Cause of the error:</h2>\n\n<p>After some discussion with Brian B. and Jaime, the issue appears to be that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> is setting the job status to COMPLETED and Managed to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddDone\" title=\"Schedd Done\">ScheddDone</a></span> then letting the Schedd handle cleanup on some periodic check that chowns the user's files to the condor user. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> then tries to terminate the job as the user but can't write to the user log because of the previous chown. Since the cleanup/chown appears to be happening periodically, this results in a race condition.\n\n</p><p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GridManager\" title=\"Grid Manager\">GridManager</a></span> has similar behavior except it actually calls DestroyProc(), which chowns the user's files. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> should probably just mirror the behavior of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GridManager\" title=\"Grid Manager\">GridManager</a></span>.\n\n</p><p><span class=\"section\"></span></p><h2>Reproducing the error:</h2>\n\n<p></p><ol>\n<li>Submit a vanilla universe job to the remote CE's schedd: <div class=\"code\">\n<pre class=\"code\">condor_submit -remote fermicloud133.fnal.gov -pool fermicloud133.fnal.gov:9619 test.sub</pre></div>\n\n</li><li>When the job completes, retrieve your files: <div class=\"code\">\n<pre class=\"code\">condor_transfer_data -name fermicloud133.fnal.gov -pool fermicloud133.fnal.gov:9619 &lt;job id&gt;</pre></div>\n\n</li><li>Repeat as necessary since the error depends on the race condition.\n</li></ol>\n\n<p><span class=\"section\"></span></p><h2>Jaime's comments</h2>\n\n<p>The sequence of events for the gridmanager is as follows:\n\n</p><p></p><ol>\n<li>Transfer output files to the spool directory\n</li><li>Set job status to COMPLETED\n</li><li>Write the terminate event as the user\n</li><li>Set Managed to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddDone\" title=\"Schedd Done\">ScheddDone</a></span> and call DestroyProc()\n</li></ol>\n\n<p>Steps 2 and 4 are done in separate connections to the schedd. The DestroyProc() is what triggers the chowning of the spool directory to the condor user. COMPLETED should be a terminal state (no pun intended), so it should only be set after output files have been transferred back to the job\u2019s spool directory and attributes about the job\u2019s execution (like exit code) have been written to the job ad.\n\n</p><p>Calling condor_transfer_data shouldn\u2019t trigger chowning of the job spool directory. But trying the transfer before the DestroyProc() would explain a failure that Brian Lin has been seeing, where the transfer fails because it can\u2019t read an output file with restricted permissions.\n\n</p><p>As the gridmanager operates now, condor_ce_run should wait until <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatus\" title=\"Job Status\">JobStatus</a></span> is COMPLETED and Managed is <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddDone\" title=\"Schedd Done\">ScheddDone</a></span> (or undefined, if for some reason the job runs directly under the CE schedd and isn\u2019t routed).\n\n</p><p>It would be easier on the client if step 2 were merged into step 4, with step 3 coming before it. Then, the client only has to consult the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatus\" title=\"Job Status\">JobStatus</a></span> attribute to see if it can retrieve the output files, and writing the terminate event won\u2019t run into permissions problems.\n\n</p><p>I don\u2019t see a call to DestroyProc() in the job router for completed jobs. I assume it\u2019s relying on the schedd to call it on some periodic check after Managed has been set to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddDone\" title=\"Schedd Done\">ScheddDone</a></span>. That may be setting up a race condition between the spool directory being chowned and the client retrieving the output files.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Nov-17 15:41:54 by blin:</em> <br/>\n\nAbandoning this ticket as it's a dupe of <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3379\" title=\"Race condition in file stageout\">#3379</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/854/JobLog\">JobLog</a>\n1098 bytes added by blin on 2014-Nov-17 18:02:05 UTC.\n<br/>\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobLog\" title=\"Job Log\">JobLog</a></span> with 'aborted job' message<br/>\n</li></ul>\n</blockquote>", "check_ins": "", "type": "defect", "last_change": "2014-Nov-20 10:27", "status": "abandoned", "created": "2014-Nov-13 12:12", "fixed_version": "2014-Nov-13 12:12", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "", "derived_from": "", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu, blin@cs.wisc.edu, cat@cs.wisc.edu", "due_date": ""}