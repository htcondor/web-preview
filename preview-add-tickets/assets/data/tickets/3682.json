{"id": 3682, "title": "Ticket #3682: Reintroduce SSH keypair -style two-phase commit for OpenStack", "description": "<blockquote>\nAlthough it doesn't complain when you supply a client token, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> doesn't support the idempotent RunInstances().  We must therefore reintroduce the SSH keypair ID -style of two-phase commit.  Because we can't really tell if we're contacting a (broken version of) <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span>, we must have the user tell us.  (A job attribute might be appropriate, given that the logic changes will fall mostly in the grid manager, but since we already use 'euca3' as a \"protocol\", it may be less ugly to add 'openstack' as a protocol as well.)\n\n<p>This also implies using something like GM_SEEK_INSTANCE_ID (or, rather, its batched-request replacement) during recovery, since we need to make sure we only call RunInstances() once per job.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jun-28 13:43:32 by tlmiller:</em> <br/>\n\n<strong class=\"two\">CODE REVIEW</strong>\n\n<p>Looks good, with the minor exception of ec2job.cpp's line 1179.  Given the prior definition(s) of m_keypair_created, we can't be in GM_DELETE with m_keypair_created set and __not__ know the name of the key pair we created (m_key_pair).  That test is therefore superfluous, although it might be worthwhile to __assert__ that we have a key pair name, since we believe that we should.\n\n</p><p>Of course, the linear scan for the job object in ec2resource.cpp is no performance winner, but we've already discussed that; extracting the Condor job ID (and then looking up the job object) from the SSH key pair name should be straightforward.\n\n</p><p></p><hr/>\n<em>2013-Jul-09 16:37:19 by jfrey:</em> <br/>\n\nSome additional data points: Nimbus correctly implements idempotent submission via the clientToken attribute. Eucalyptus does not.\n\n<p></p><hr/>\n<em>2013-Jul-22 11:47:49 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>I am still sad-faced about the linear scan for the job object when searching by key pair ID.  There ought to be a comment about\nextracting the Condor job ID (and then looking up the job object) from the SSH key pair, in case we do need the performance improvement.\n\n</p><p>Otherwise, the code looks good.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3755\" onclick=\"get_ticket_and_populate_wrapper('3755'); return false;\" title=\"Add GAHP command to detect EC2 server type\">#3755</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd GAHP command to detect EC2 server type</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3832\" onclick=\"get_ticket_and_populate_wrapper('3832'); return false;\" title=\"Improve searching of EC2 jobs by ssh keypair name\">#3832</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove searching of EC2 jobs by ssh keypair name</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/756/GT-3682-DesignDoc-V1.docx\">GT-3682-DesignDoc-V1.docx</a>\n5113 bytes added by tlmiller on 2013-Jun-14 15:21:59 UTC.\n<br/>\nNot even a first draft, but maybe it'll save Jaime some time.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-09 09:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37141\">[37141]</a></span>: minor 8.1.1 version history item edit ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3682\" onclick=\"get_ticket_and_populate_wrapper('3682'); return false;\" title=\"Reintroduce SSH keypair -style two-phase commit for OpenStack\">#3682</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-06 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37100\">[37100]</a></span>: Version history for EC2 ssh keypair-based two-phase commit. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3682\" onclick=\"get_ticket_and_populate_wrapper('3682'); return false;\" title=\"Reintroduce SSH keypair -style two-phase commit for OpenStack\">#3682</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-06 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37099\">[37099]</a></span>: Add comment about how to improve EC2 ssh keypair name search. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3682\" onclick=\"get_ticket_and_populate_wrapper('3682'); return false;\" title=\"Reintroduce SSH keypair -style two-phase commit for OpenStack\">#3682</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-16 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36918\">[36918]</a></span>: Finish using ssh keypair for OpenSTack EC2 submission. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3682\" onclick=\"get_ticket_and_populate_wrapper('3682'); return false;\" title=\"Reintroduce SSH keypair -style two-phase commit for OpenStack\">#3682</a></span> Ensure ssh keypair creation and deletion are done properly in recovery cases. Disallow use of pre-existing ssh keypair when client token doesn't work.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-09 17:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36831\">[36831]</a></span>: Further work using ssh keypair for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> EC2 submission. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3682\" onclick=\"get_ticket_and_populate_wrapper('3682'); return false;\" title=\"Reintroduce SSH keypair -style two-phase commit for OpenStack\">#3682</a></span> Use auto-detection of ec2 server type to decide if we need to use the ssh keypair for two-phase submission. Improve cleanup of ssh keypairs.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-26 22:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36694\">[36694]</a></span>: Initial code for ssh keypair two-phase commit for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3682\" onclick=\"get_ticket_and_populate_wrapper('3682'); return false;\" title=\"Reintroduce SSH keypair -style two-phase commit for OpenStack\">#3682</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> doesn't properly support the client token instance property to do idempotent calls to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunInstances\" title=\"Run Instances\">RunInstances</a></span>. We currently rely on that to avoid double-submiting jobs when a failure occurs. Thus, we need to re-introduce the use of the\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Aug-06 10:39", "status": "resolved", "created": "2013-Jun-06 17:24", "fixed_version": "2013-Jun-06 17:24", "broken_version": "v070905", "priority": "2", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "#3681", "creator": "tlmiller", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "tiradani@fnal.gov", "due_date": "20130614"}