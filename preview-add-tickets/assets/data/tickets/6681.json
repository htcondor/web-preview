{"id": 6681, "title": "Ticket #6681: bake-in relevant functions of singularity wrappers to Condor", "description": "<blockquote>\nFrom a few sources, I've heard that the OSG uses a job wrapper to handle a lot of the corner cases of Singularity jobs. Finally saw it today and I'm told <a class=\"external\" href=\"https://github.com/opensciencegrid/osg-flock/blob/master/job-wrappers/user-job-wrapper.sh\">this one is in use at Madison</a>.\n\n<p>For starters, that is one heck of a script and its actual functionality is not self-evident. Here's what I see it doing:\n\n</p><p></p><ol>\n<li>Follow symlink of an image and replace with its target. I think Singularity (2.5.1) might be doing this now, because running <code>singularity shell</code> gives me a prompt with the name of the target in it rather than the link.\n</li><li>Hard-coded binding a few mountpoints in (e.g. <code>/hadoop</code>). This can be realized with SINGULARITY_BIND_EXPR.\n</li><li>Bring in some extra bind points based on Job <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> (e.g. GPU, CVMFS). Are these generic enough to bake in?\n</li><li>Set <code>--contain</code> (if not GPU jobs) and <code>--ipc</code> and <code>--pid</code>. It looks to me like Condor now uses <code>-C</code> (which is equivalent) by default but do not know if that is uniformly used for all jobs.\n</li><li>Fix working directory in OSG-appropriate manner. I have filed <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6676\" onclick=\"get_ticket_and_populate_wrapper('6676'); return false;\" title=\"singularity should use --pwd argument when on shared filesystems\">#6676</a></span> to discuss precisely this point. Although the ticket has \"shared filesystems\" in its name, I believe the issue to be more generic.\n</li><li>Fix X509 environment variables. This may have been resolved by <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6625\" onclick=\"get_ticket_and_populate_wrapper('6625'); return false;\" title=\"X509_USER_PROXY not set properly for singularity jobs\">#6625</a></span> and the recent release?\n</li></ol>\n\n<p>So, for starters, this probably isn't a full enumeration of the functionality. But, since it's in use at Madison, there must be a reason for it and some local expertise with it. In the grand spirit of HTCondor, there should be a knob / standard-ish job transform snippets for the bits that are generic.\n\n</p><p>I'm particularly concerned about <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6676\" onclick=\"get_ticket_and_populate_wrapper('6676'); return false;\" title=\"singularity should use --pwd argument when on shared filesystems\">#6676</a></span> and IWD handling.\n\n</p><p>I'm pushing Singularity very hard with some interested users and I'll admit to some frustration that a lot of effort must of gone into this wrapper but not so much into helping the HTCondor team identify the problems it's solving. To give an example, I believe the X509 problem was resolved in a week or two in response to a report by Matthias Schnepf from Germany. When... quite literally you have someone fixing it in a job wrapper down the hall from you.\n\n</p><p>Can we view this as a starting point for understanding where Singularity support stands and what might be snuck in before 8.8?</p></blockquote>", "remarks": "<blockquote>\n<em>2018-May-14 19:43:15 by gthain:</em> <br/>\n\nTom:\n\n<p>We would like to remove the need to have this wrapper script as well.\n\n</p><p></p><ol>\n<li>Looks like the singularity running in OSG fixes the need to explicitly follow symlinks, so, as you say, we don't need the part of the script\n</li></ol>\n\n<p>2 &amp; 3:  Note that the SINGULARITY_BIND_EXPR is evaluated in the context of the job and machine ad, so we can write expressions that the job can opt into certain mounts.\n\n</p><p></p><ol>\n<li>Condor now uses -C (contain all namespaces)\n\n<p></p></li><li>We'll work on this one\n\n<p></p></li><li>As of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6625\" onclick=\"get_ticket_and_populate_wrapper('6625'); return false;\" title=\"X509_USER_PROXY not set properly for singularity jobs\">#6625</a></span> and recent work on environment variables, this should all work.\n</li></ol>\n\n<p>So, it looks like we're just down to one issue this script is really taking care of.\n\n</p><p></p><hr/>\n<em>2019-Apr-10 15:12:48 by pfc:</em> <br/>\n\nCan Greg please update this ticket with what if anything is still left to do, and can Tom update with how important it is to LIGO given the impact?\n\n<p></p><hr/>\n<em>2019-Apr-17 14:10:14 by gthain:</em> <br/>\n\nI boldly proclaim there is nothing left to do.  Independently, we've been working with the glidein folks to obviate the need to have a singularity wrapper, adding the SINGULARITY_EXTRA_ARGUMENTS (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6731\" onclick=\"get_ticket_and_populate_wrapper('6731'); return false;\" title=\"Allow admin to add additional singularity command line args\">#6731</a></span>), allowing condor_ssh_to_job to singularity jobs, and allowing X509 proxies to work with singularity <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6625\" onclick=\"get_ticket_and_populate_wrapper('6625'); return false;\" title=\"X509_USER_PROXY not set properly for singularity jobs\">#6625</a></span>\n\n<p></p><hr/>\n<em>2019-Apr-24 14:13:06 by pfc:</em> <br/>\n\nWe're accepting Greg's bold unsubstantiated claim that this is resolved unless/until Tom or other have info or opinions to the contrary.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "todo", "last_change": "2019-Apr-24 14:13", "status": "resolved", "created": "2018-May-11 16:55", "fixed_version": "2018-May-11 16:55", "broken_version": "", "priority": "3", "subsystem": "", "assigned_to": "", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "downes@uwm.edu,pcouvare@caltech.edu", "due_date": ""}