{"id": 5416, "title": "Ticket #5416: master should have a command to query (and wait for) child readiness", "description": "<blockquote>\nIn support of <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=5340\" onclick=\"get_ticket_and_populate_wrapper('5340'); return false;\" title=\"Controlling daemon startup dependencies and delay for ready\">#5340</a></span>, and for testing. it would be nice to have a command that can be sent to the master and it would reply with the readiness states of each of it's children.   It would also be nice if the master could delay responding to query until the children had reached a known readiness state or a timeout had expired.\n\n<p>A new command would be added to the master\n\n</p><p></p><pre>    DC_QUERY_READY\n</pre>\n\n<p>The Master would reply to this query with a classad containing a single global readiness attribute and 2 attributes for each child in the daemon list.\n\n</p><p></p><pre>    IsReady    = bool: all non-held daemons are in \"Alive\" state\n    NumDaemons = int:  number of daemons in DAEMON_LIST\n    NumAlive   = int:  number of daemons in \"Alive\" state\n    NumStartup = int:  number of daemons in \"Startup\" state\n    NumHold    = int:  number of daemons in \"Hold\" state\n    NumHung    = int:  number of daemons in \"Hung\" state\n    NumDead    = int:  number of daemons in \"Dead\" state\n    # 2 attributes for each daemon in DAEMON_LIST\n    &lt;Daemon&gt;_PID = int: PID or 0 if no child process\n    &lt;Daemon&gt;     = string: one of the &lt;readiness-state&gt; values\n    # 1 optional additional attribute for some daemons in DAEMON_LIST\n    &lt;Daemon&gt;_State = string: state reported by the daemon using =DC_SET_READY=\n</pre>\n\n<p>The <code>&lt;Daemon&gt;</code> values will be the names from <code>DAEMON_LIST</code>,\n\n</p><p>The possible string values for <code>&lt;readiness-state&gt;</code> will be\n\n</p><p></p><pre>    \"Alive\"  - got a pid and at least 1 alive message from that pid\n    \"Hung\"    - got a pid and at least 1 alive message, but none recently\n    \"Startup\" - started the child, but have not yet got an alive message or decided it hung\n    \"Dead\"    - no pid and not on hold\n    \"Hold\"    - no pid and daemon has been condor_off'd\n    \"WaitForStartup\" - no pid and waiting before starting the daemon\n    \"WaitForStartupFile\" - no pid and waiting before starting the daemon\n</pre>\n\n<p>For daemons that send the master a <code>DC_SET_READY</code> message, the string value sent in this message will be written to a <code>&lt;Daemon&gt;_State</code> attribute, it will be reported as part of the <code>DC_QUERY_READY</code> reply until a change of the <code>&lt;readiness-state&gt;</code> of the daemon clears it.  In general, do not expect a daemon that is not in \"Alive\" state to have a <code>&lt;Daemon&gt;_State</code> attribute.\n\n</p><p>In addition to the basic query, the <code>DC_QUERY_READY</code> command will have\na <code>ClassAd</code> payload, that can be used to specify that the reply should not occur until a desired readiness state has been achieved or a timeout has expired. The attributes to control this will be\n\n</p><p></p><pre>    ReadyRequirements = &lt;readiness-expr&gt;\n    WaitTimeout = &lt;max-time-before-reply-in-sec&gt;\n</pre>\n\n<p>When a non-zero timeout is supplied the <code>ReadyRequirements</code> expression will be evaluated against the readiness ad once per second, and the reply will be sent once the <code>WaitTimeout</code> has expired, or <code>ReadyRequirements</code> evaluates to true. So for instance\n\n</p><p></p><pre>    ReadyRequirements = (NumDead &gt; 0) || (IsReady &amp;&amp; (STARTD_State =?= \"Ready\"))\n    WaitTimeout       = 60\n</pre>\n\n<p>Will tell the master to reply only once all daemons have sent at least 1 heartbeat, and the Startd has sent \"ready\", or after 60 seconds have expired.\n\n</p><p>condor_who -quick will be enhanced to use the new <code>DC_QUERY_READY</code> command, and (possibly?) a new flavor of condor_tool will be created to make it easy to use the query ready command in a script.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Nov-25 14:07:18 by johnkn:</em> <br/>\n\nOnce this feature is in and tested, it should be backported to stable so that can be used in the test suite.\n\n<p></p><hr/>\n<em>2016-Oct-12 14:47:35 by johnkn:</em> <br/>\n\n<code>condor_who</code> has a new argument to support the use of the <code>DC_QUERY_READY</code> message.\n\n<p></p><div class=\"verbatim\">\n<pre>condor_who -wait-for-ready[:&lt;time&gt;] &lt;expr&gt;</pre></div>\n\n\n<p>When this argument is used, condor_who will scrape the log directory(s) to find the MASTER, and once it knows the master address it will attempt to send a <code>DC_QUERY_READY</code> to the master with &lt;time&gt; as the timeout and &lt;expr&gt; as the Readyness expression.  If a readyness ad is returned it will print this in -long form (unless -af or -autoformat is used).\n\n</p><p></p><div class=\"verbatim\">\n<pre>condor_who -quick</pre></div>\n does the same thing, but with a &lt;time&gt; of 0 and an &lt;expr&gt; of TRUE.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-23 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49644\">[49644]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5290\" onclick=\"get_ticket_and_populate_wrapper('5290'); return false;\" title=\"output of condor_q -analyze is often misleading or wrong\">#5290</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5805\" onclick=\"get_ticket_and_populate_wrapper('5805'); return false;\" title=\"Create a tool to do generic classad transforms and pretty printing\">#5805</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6018\" onclick=\"get_ticket_and_populate_wrapper('6018'); return false;\" title=\"add join function to classads to complement split\">#6018</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5889\" onclick=\"get_ticket_and_populate_wrapper('5889'); return false;\" title=\"condor_qedit and other tools should hondor CONDOR_Q_ONLY_MY_JOBS\">#5889</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5416\" onclick=\"get_ticket_and_populate_wrapper('5416'); return false;\" title=\"master should have a command to query (and wait for) child readiness\">#5416</a></span>, and doc for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6018\" onclick=\"get_ticket_and_populate_wrapper('6018'); return false;\" title=\"add join function to classads to complement split\">#6018</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-12 15:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49415\">[49415]</a></span>: finalize design of DC_QUERY_READY command and condor_who's use of it. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5416\" onclick=\"get_ticket_and_populate_wrapper('5416'); return false;\" title=\"master should have a command to query (and wait for) child readiness\">#5416</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-03 10:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46343\">[46343]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5416\" onclick=\"get_ticket_and_populate_wrapper('5416'); return false;\" title=\"master should have a command to query (and wait for) child readiness\">#5416</a></span>, have <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> keep track of number of alive messages for each daemon, and add DC_QUERY_READY command to master to query this. this should be helpful in test suite to know when a personal HTCondor is ready to go. This commit also adds a preliminary DC_SET_READY command that the STARTD uses\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Nov-23 16:14", "status": "resolved", "created": "2015-Nov-25 14:06", "fixed_version": "2015-Nov-25 14:06", "broken_version": "", "priority": "3", "subsystem": "DaemonMaster", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}