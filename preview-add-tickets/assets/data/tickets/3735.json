{"id": 3735, "title": "Ticket #3735: chirp wire protocol incompatible between 7.8.x and 8.0.x", "description": "<blockquote>\nToo aggressive removal of unneeded code in the shadow and starter (<span class=\"ticket\"><a class=\"defer\" href=\"tktview?tn=3390\" title=\"MPI Parallel Universe jobs fail when USE_NFS=True - Developer Series\">#3390</a></span>) resulted in a change to the wire protocol for chirp between 7.9.4 and 7.9.5.  This wasn't noticed until we tried to run a mixed 8.0.0 and 7.9.4 pool in the batlab.  Because 7.8.x uses the same protocol as 7.9.4, and 8.0.0 uses the same protocol as 7.9.5, this represents an incompatibility between successive stable versions.\n\n<p>Because this protocol change shipped in 8.0.0, it is now necessary to fix the problem by detecting the version of the other side of the chirp conversation and either using the old or new protocol based on that information.\n\n</p><p>The command that was actually failing in the batlab was </p><div class=\"code\">\n<pre class=\"code\">condor_chirp put -mode wac - $file</pre></div>\n\n\n<p>it was failing because the chirp open() call was failing in the starter because it was not expecting a filename prefixed with \"remote:\" (new protocol) but the shadow was sending the file with that prefix (old protocol).\n\n</p><p>Testing reveals that when the Shadow is 8.0 and the Starter is 7.8, we see the bug.  But when the Shadow is 7.8 and the Starter is 8.0 we don't see it.  This is because the 8.0 starter calls <code>REMOTE_CONDOR_get_file_info_new</code> to translate a pathname, and gets back \"remote:original_path\", then it <em>ignores</em> the translated path and uses the original path instead.  Because the 8.0 Starter is immune to all changes in the translation algorithm, the bug can be fixed by merely reinstating the code in the Shadow that adds the url prefixes \"remote:\".  This will work for 7.8 starter because it expects the \"remote:\" prefix, and for the 8.0 starter because it ignores the translation entirely.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jul-08 10:39:49 by johnkn:</em> <br/>\n\nnote: <span class=\"chng\"><a href=\"chngview?cn=35292\">[35292]</a></span> introduced the bug\n\n<p></p><hr/>\n<em>2013-Jul-09 16:22:22 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  gthain 6/9/2013.  Changes are good.  Let's add a version history.  Any reason the dprintf was changed from D_SYSCALL to D_SYSCALL|D_VERBOSE</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-25 09:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36991\">[36991]</a></span>: minor version history item edit ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3735\" title=\"chirp wire protocol incompatible between 7.8.x and 8.0.x\">#3735</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-24 14:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36987\">[36987]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3735\" title=\"chirp wire protocol incompatible between 7.8.x and 8.0.x\">#3735</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-09 14:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36816\">[36816]</a></span>: fix memory leak in dprintf D_SYSCALLS for <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3735\" title=\"chirp wire protocol incompatible between 7.8.x and 8.0.x\">#3735</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-08 17:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36784\">[36784]</a></span>: change chirp wire protocol for 8.0.x so that it always sends \"remote:\" <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3735\" title=\"chirp wire protocol incompatible between 7.8.x and 8.0.x\">#3735</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-08 10:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36781\">[36781]</a></span>: fix chirp wire protocol so 8.0.x can interoperate with 7.8.x. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=3735\" title=\"chirp wire protocol incompatible between 7.8.x and 8.0.x\">#3735</a></span> This affects the non-std universe shadow only. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jul-29 15:12", "status": "resolved", "created": "2013-Jul-02 14:14", "fixed_version": "2013-Jul-02 14:14", "broken_version": "v080000", "priority": "1", "subsystem": "FileTransfer", "assigned_to": "gthain", "derived_from": "#3390", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}