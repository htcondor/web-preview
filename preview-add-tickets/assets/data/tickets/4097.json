{"id": 4097, "title": "Ticket #4097: On Windows files are not always truncated when they should be", "description": "<blockquote>\nIf a user submits a job like\n<div class=\"code\">\n<pre class=\"code\">executable = foo\noutput = foo.out\nqueue\n</pre></div>\n\nand runs it, and then after it completes runs it a second time, one would expect HTCondor to erase (truncate) the results from the first run of foo.out before writing out the results from the second run.  Unfortunately on Windows this is currently not happening, and the user may be left with a mish-mash of the two runs in foo.out.\n\n<p>The problem is in our safe_open utility library, the flag O_TRUNC is removed from the <code>open()</code> system call and <code>ftruncate()</code> is called afterwards. But the <code>ftruncate()</code> call is in a block of code that's only compiled on unix. Thus, on Windows, safe_open effectively ignores O_TRUNC and thus the opened file is never truncated.\n\n</p><p>The functions where this occurs are <code>safe_open_no_create()</code> and <code>safe_open_no_create_follow()</code>, though many other calls in the safe_open API end up calling these functions.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Nov-25 14:36:15 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>These changes look good.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-27 10:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38871\">[38871]</a></span>: Minor edit of 8.0.5 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4097\" onclick=\"get_ticket_and_populate_wrapper('4097'); return false;\" title=\"On Windows files are not always truncated when they should be\">#4097</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-26 17:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38865\">[38865]</a></span>: Windows fix: do not pass bad params to fstat(), preventing a except. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4097\" onclick=\"get_ticket_and_populate_wrapper('4097'); return false;\" title=\"On Windows files are not always truncated when they should be\">#4097</a></span> fstat() is considered a security related libc call on Windows, and when security related calls get passed unexpected data (like a bad file descriptor), Windows invokes a process-wide Invalid Parameter Handler Routine. The default\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-22 18:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38828\">[38828]</a></span>: add version history blurb to bug fix <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4097\" onclick=\"get_ticket_and_populate_wrapper('4097'); return false;\" title=\"On Windows files are not always truncated when they should be\">#4097</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-22 18:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38827\">[38827]</a></span>: Fix bug where safe open calls ignore O_TRUNC flag on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4097\" onclick=\"get_ticket_and_populate_wrapper('4097'); return false;\" title=\"On Windows files are not always truncated when they should be\">#4097</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Nov-26 17:44", "status": "resolved", "created": "2013-Nov-22 17:27", "fixed_version": "2013-Nov-22 17:27", "broken_version": "v080000", "priority": "2", "subsystem": "Win32", "assigned_to": "tannenba", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}