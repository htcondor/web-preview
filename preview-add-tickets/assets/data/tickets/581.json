{"id": 581, "title": "Ticket #581: Dynamic startd slots lose SLOTx_STARTD_ATTRS", "description": "<blockquote>\nIf a slot is partitionable (SLOT_TYPE_1_PARTITIONABLE=TRUE), the dynamic slots created will lack any attributes added using SLOTx_STARTD_ATTRS.  Attributes added using STARTD_ATTRS will appear as expected.  They will appear in the base partitionable ad, but they disappear when the dynamic slot is created.  They don't show up in the classad emitted when STARTD_DEBUG=D_MACHINE.  If a job requires one or more of these attributes, the startd will reject the job, citing, \"6/18 17:45:10 slot1.1: Job requirements not satisfied.\" and \"6/18 17:55:10 slot1.1: Request to claim resource refused.\"\n\n<p>Expected behavior: the attributes in question appear in all dynamic slots derived from a base slow showing these attributes.\n\n</p><p>To reproduce: Set up a simple condor install.  \"tar xvzf condor-*.tar.gz; cd condor-*; ./condor_install --install\".  Append the following to the generated condor_config.  (This example assumes that the machine has two CPUs.)\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">STARTD_DEBUG=D_MACHINE\n\nSLOT_TYPE_1 = cpus=2\nNUM_SLOTS_TYPE_1 = 1\nSLOT_TYPE_1_PARTITIONABLE=TRUE\n\nPATH_TO_DATE=\"/bin/date\"\nSTARTD_EXPRS=PATH_TO_DATE\nTEST1=\"number-one\"\nTEST_SHOES=2\nSLOT1_STARTD_ATTRS=TEST1, TEST_SHOES\n</pre></div>\n\n\n<p>Start the install up.  Using \"condor_status -l\", observe that PATH_TO_DATE, TEST1, and TEST_SHOES are present.\n\n</p><p>Submit a simple job requiring TEST_SHOES.  For example:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">executable=/bin/sleep\narguments=300\noutput=eraseme.out\nerror=eraseme.err\nlog=eraseme.log\nrequirements=TEST_SHOES &gt; 0\nrequest_cpus=1\nrequest_disk=1\nrequest_memory=1\nqueue\n</pre></div>\n\n\n<p>Allow a matchmaking cycle to run.  Observe that the job doesn't run.  Check the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartLog\" title=\"Start Log\">StartLog</a></span> and find something like:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">6/18 17:45:10 slot1.1: Job requirements not satisfied.\n...\n6/18 17:55:10 slot1.1: Request to claim resource refused.\n</pre></div>\n\n\n<p>Between those points is a dump of the dynamic class ad.  Observe that PATH_TO_DATE is present, but TEST1 and TEST_SHOES are not.\n\n</p><p>Matthew Farrellee hypothesizes that \"the dynamic slot is missing a call to Resource::published when it is created in command.cpp.\"</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Jun-18 18:07:21 by adesmet:</em> <br/>\n\nThis bug has been observed in the wild <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2009-June/msg00070.shtml\">https://lists.cs.wisc.edu/archive/condor-users/2009-June/msg00070.shtml</a>\n\n<p><em>tstclair:</em> <br/>\n\nI've traced it down into the Resource::publish() when it calls config_fill_ad.  The prefix=\"slot1.1\", and due to the extra \".1\" it will never match the values that have been configured.  The fix is simply to ignore the \".\" for partitionable slots, so prefix=\"slot1\".  A push will be forthcoming.\n\n</p><p></p><hr/>\n<em>2009-Aug-18 13:38:47 by danb:</em> <br/>\n\nIf you look in Resource::Resource(), you will see that \"slot\" is the default slot prefix, but the prefix can be configured to be something else.  It's probably best to be consistent and make sure that your patch uses the same prefix.\n\n<p></p><hr/>\n<em>2009-Aug-18 15:41 by tstclair:</em> <br/>\n\nUpdated patch to use existing r_id_str - .r_sub_id, versus creating a new string named \"slot\"\n\n<p></p><hr/>\n<em>2009-Aug-19 11:01:07 by danb:</em> <br/>\n\nMyString::find() returns -1 if not found, so the following code should be slightly adjusted:\n<div class=\"code\">\n<pre class=\"code\">int iPeriodPos = szTmp.find(\".\");\nif ( iPeriodPos )\n {\n   szTmp.setChar ( iPeriodPos,  '\\0' );\n }\n</pre></div>\n\n\n<p>Also, this patch contains a number of lines with whitespace modifications on lines completely unrelated to the problem at hand.  Probably your editor did that without you knowing.  It's best to avoid that.\n\n</p><p></p><hr/>\n<em>2009-Aug-19 13:18:07 by tstclair:</em> <br/>\n\n\n<p>I made the mod to check  iPeriodPos&gt;=0, patch attached  I will have to cleanup the whitespace issue prior to moving upstream.  Thank you for spotting that.</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/84/patch1\">patch1</a>\n2436 bytes added by tstclair on 2009-Aug-19 18:17:37 UTC.\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-24 08:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=15459\">[15459]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=581\" title=\"Dynamic startd slots lose SLOTx_STARTD_ATTRS\">#581</a></span>: Dynamic startd slots lose SLOTx_STARTD_ATTRS Update was made to how we fill the slot attributes using config_fill_ad the string passed in as a prefix contained a \".\" which would always fail a fill, fix was to terminate a temporary prefix at said location e.g. slot1.1 -&gt; slot1\u00a0[...]\n (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-24 08:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=15458\">[15458]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=581\" title=\"Dynamic startd slots lose SLOTx_STARTD_ATTRS\">#581</a></span>: Dynamic startd slots lose SLOTx_STARTD_ATTRS Update was made to how we fill the slot attributes using config_fill_ad the string passed in as a prefix contained a \".\" which would always fail a fill, fix was to terminate a temporary prefix at said location e.g. slot1.1 -&gt; slot1\u00a0[...]\n (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-24 08:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=15465\">[15465]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=15460\">[15460]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=15461\">[15461]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=15462\">[15462]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=15463\">[15463]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=15464\">[15464]</a></span>, Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=581\" title=\"Dynamic startd slots lose SLOTx_STARTD_ATTRS\">#581</a></span>: Dynamic startd slots lose SLOTx_STARTD_ATTRS Update was made to how we fill the slot attributes using config_fill_ad the string passed in as a prefix contained a \".\" which would always fail a fill, fix was to terminate a temporary prefix\u00a0[...]\n (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-17 15:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=15460\">[15460]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=581\" title=\"Dynamic startd slots lose SLOTx_STARTD_ATTRS\">#581</a></span> update to all paritionable slots to correctly inherit attributes  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-17 13:47", "status": "resolved", "created": "2009-Jun-18 18:05", "fixed_version": "2009-Jun-18 18:05", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "tstclair", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.wisc.edu,tstclair@redhat.com", "due_date": ""}