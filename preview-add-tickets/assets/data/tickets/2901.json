{"id": 2901, "title": "Ticket #2901: advertised checkpoint platform string is inconsistent", "description": "<blockquote>\nDan Forrest noticed in numerous instances that a std univ job that had previously saved a checkpoint matched to a machine and wrote a new checkpoint with a different checkpoint signature than the one advertised by the startd on that machine.  The job therefore no longer matched to the same machine that it just ran on.  The part of the platform string that had changed was the vdso address.\n\n<p>How is this possible?  He observed that condor_ckpt_probe is dynamically linked, and that ld-linux.so gets (sometimes?) loaded before the vdso object.  We found that ld-linux.so had been recently updated on the machine.  This could explain why the vdso address changed: the size of ld-linux.so may have changed.\n\n</p><p>Restarting condor caused the advertised checkpoint platform string to change, presumably making it consistent with the string associated with new checkpoints, until the next time something causes condor_ckpt_probe to generate a different value.\n\n</p><p>Suggested workaround: statically link condor_ckpt_probe.  The std univ jobs are statically linked, so it seems that condor_ckpt_probe should also be statically linked, so that it sees the same memory layout.\n\n</p><p>I assume that this problem affects all previous 7.6 releases of Condor, but I don't know that for sure.  The problem has been observed under 7.6.6 in GLOW.  It has also been observed in CHTC (7.7.5) and CS (7.6.6).</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-13 14:41:58 by tannenba:</em> <br/>\n\n<em>additional wisdom from Dan Forest on this issue</em>\n\n<p>The basic problem is that recent OS upgrades have updated the file\n/lib/ld-linux.so.2 (now a symlink to /lib/ld-2.5.so on many machines)\nand this has changed the memory layout (regardless of setarch -R -L)\nand hence the VDSO location has changed.\n\n</p><p>I have experimented with this a bit and it appears that statically\nlinked binaries do not have this problem (because /lib/ld-linux.so.2\nis not mapped to the process address space).  It is also the case that\nall Condor checkpointable binaries are statically linked.\n\n</p><p>So I am proposing that /usr/libexec/condor/condor_ckpt_probe should be\nstatically linked for two reasons:\n\n</p><p>1.) The VDSO in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CheckpointPlatform\" title=\"Checkpoint Platform\">CheckpointPlatform</a></span> attribute will match the actual\n    VDSO address of the running program.\n\n</p><p>2.) The VDSO in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CheckpointPlatform\" title=\"Checkpoint Platform\">CheckpointPlatform</a></span> attribute will hopefully not\n    possibly change again after another OS upgrade.\n\n</p><p>It should be fairly easy to statically link this program.  Once this\nis done it should be pushed out to the various pools (GLOW, CHTC, and\nhopefully the CS Condor pool too) and the condor_startd's should be\nrestarted to advertise the correct <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CheckpointPlatform\" title=\"Checkpoint Platform\">CheckpointPlatform</a></span>.\n\n</p><p>People with checkpointed jobs would probably then want to edit the\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastCheckpointPlatform\" title=\"Last Checkpoint Platform\">LastCheckpointPlatform</a></span> attribute:\n\n</p><p>\"LINUX X86_64 2.6.x normal 0x2aaaaaac7000\" -&gt;\n\"LINUX X86_64 2.6.x normal 0x2aaaaaaab000\"\n\n</p><p>\"LINUX INTEL 2.6.x normal 0x4001d000\" -&gt;\n\"LINUX INTEL 2.6.x normal 0x40000000\"\n\n</p><p>Etc.\n\n</p><p>Alternatively, the condor_startd's could all be restarted just to make\nsure the advertised <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CheckpointPlatform\" title=\"Checkpoint Platform\">CheckpointPlatform</a></span> matches the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CheckpointPlatform\" title=\"Checkpoint Platform\">CheckpointPlatform</a></span>\nattribute returned by /usr/libexec/condor/condor_ckpt_probe (it looks\nlike a reconfigure alone will not do this).  Right now there are a lot\nof machines where this mismatch keeps checkpointed jobs from running\nagain on the machine where the checkpoint originated!\n\n</p><p></p><hr/>\n<em>2012-May-22 15:27:36 by tlmiller:</em> <br/>\n\nThe changes to CMake were made straightforward by playing games with the source to reduce the number of random things to which it needed to link.\n\n<p></p><hr/>\n<em>2012-May-22 16:15:05 by tlmiller:</em> <br/>\n\nApproved by GregT.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4025\" onclick=\"get_ticket_and_populate_wrapper('4025'); return false;\" title=\"condor_ckpt_probe missing\">#4025</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_ckpt_probe missing</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-06 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32215\">[32215]</a></span>: minor editing of version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2901\" onclick=\"get_ticket_and_populate_wrapper('2901'); return false;\" title=\"advertised checkpoint platform string is inconsistent\">#2901</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-24 15:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32112\">[32112]</a></span>: Document condor_ckpt_probe fix (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2901\" onclick=\"get_ticket_and_populate_wrapper('2901'); return false;\" title=\"advertised checkpoint platform string is inconsistent\">#2901</a></span>).  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-21 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32079\">[32079]</a></span>: Link condor_ckpt_probe statically. (GT <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2901\" onclick=\"get_ticket_and_populate_wrapper('2901'); return false;\" title=\"advertised checkpoint platform string is inconsistent\">#2901</a></span>)  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-May-24 15:06", "status": "resolved", "created": "2012-Mar-22 15:01", "fixed_version": "2012-Mar-22 15:01", "broken_version": "v070606", "priority": "2", "subsystem": "Std", "assigned_to": "tlmiller", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "dan@hep.wisc.edu,dan.forrest@ssec.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}