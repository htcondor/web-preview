{"id": 7440, "title": "Ticket #7440: Optimize collector performance", "description": "<blockquote>\nProfile the collector and look for opportunities for performance improvement. Focus on the top-level collector of a collector tree. This is primarily for CMS, which is pushing the limits of how large we can scale. Large changes should get their own tickets.</blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-04 11:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59578\">[59578]</a></span>: Docs for collector performance improvements. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7423\" onclick=\"get_ticket_and_populate_wrapper('7423'); return false;\" title=\"Filter private ads for startds the negotiator won't match\">#7423</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-21 21:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59004\">[59004]</a></span>: Remove some string compares when sending a classad over the wire. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> In the few places where PUT_CLASSAD_NO_TYPES is used, we don't need to filter out <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyType\" title=\"My Type\">MyType</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TargetType\" title=\"Target Type\">TargetType</a></span> in the main iteration over attributes. We only need to omit the two dedicated strings usually sent after all of the attribute/value\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 16:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58735\">[58735]</a></span>: Disable find-grained collector timing stats for receive_update(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> These timings aren't useful to users and had a noticeable performance impact. They can be enabled at compile time via a macro.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 15:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58734\">[58734]</a></span>: Use cheaper fine-grained timer for performance measurements. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> On linux, the CLOCK_MONOTONIC_RAW clock calls into the kernel (500ns), while CLOCK_MONOTONIC does not (25ns). Both are fast on macOS.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 15:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58732\">[58732]</a></span>: Replace string cons'ing with ClassAd::Assign <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58722\">[58722]</a></span>: Optimize the code to get a string out of a whole UDP cedar packet. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58720\">[58720]</a></span>: Remove some duplicate <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> evaluation code. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> This also lets us remove some object files from libcondorapi.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58721\">[58721]</a></span>: Add comment about reduced need to peek in cedar messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58718\">[58718]</a></span>: Remove unnecessary peek at start of cedar commands. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> This peek is only needed by the shared port daemon to decide if it needs to transparently hand a connection off to the collector.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58719\">[58719]</a></span>: Remove some dead signal handler code. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> Ultimately, we'd like to not have to block signals inside dprintf(). For now, reduce the complexity of our signal handlers, espcially any that may call dprintf().  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58717\">[58717]</a></span>: Remove some umask() calls. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7440\" onclick=\"get_ticket_and_populate_wrapper('7440'); return false;\" title=\"Optimize collector performance\">#7440</a></span> Most of the code base assumes a daemon's umask remains reasonable after we set it at startup. dprintf() and the email code can do the same.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-May-04 11:34", "status": "resolved", "created": "2019-Dec-19 09:53", "fixed_version": "2019-Dec-19 09:53", "broken_version": "", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}