{"id": 7214, "title": "Ticket #7214: Signal handler can create daemon log owned by root", "description": "<blockquote>\nThe code to write to the daemon's log file safely from a signal handler can end up creating the file with root ownership. This will prevent any new instances of the daemon from writing to the file. Due to a short-circuiting OR operator, a call to <code>seteuid()</code> is likely to be skipped in <code>safe_async_log_open()</code>.\n\n<p>We saw this occur in CHTC under the following circumstances:\n</p><ul>\n<li>The starter's log was moved to another directory (by third-party log rotation software) while the daemon was running.\n</li><li>The starter called EXCEPT() while in root privilege (in the docker_proc job reaper).\n</li><li><code>ABORT_ON_EXCEPTION</code> was set to <code>True</code> in the Condor config files.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Aug-19 14:37:40 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> looks good</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-19 14:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57694\">[57694]</a></span>: Docs for daemon log wrong owner bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7214\" onclick=\"get_ticket_and_populate_wrapper('7214'); return false;\" title=\"Signal handler can create daemon log owned by root\">#7214</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-19 13:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57689\">[57689]</a></span>: Avoid short-circut OR when switching privs in signal handler logging. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7214\" onclick=\"get_ticket_and_populate_wrapper('7214'); return false;\" title=\"Signal handler can create daemon log owned by root\">#7214</a></span> Otherwise, we don't change our effective UID, leading to creation of the daemon log with the wrong ownership. The check of return values was added to silence a compiler warning. Now, we silence the warning the same way that we\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Aug-19 14:41", "status": "resolved", "created": "2019-Aug-19 13:55", "fixed_version": "2019-Aug-19 13:55", "broken_version": "", "priority": "3", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}