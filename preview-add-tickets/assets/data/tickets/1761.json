{"id": 1761, "title": "Ticket #1761: Local job slow to exit can kill schedd", "description": "<blockquote>\nThe change made for ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=699\" onclick=\"get_ticket_and_populate_wrapper('699'); return false;\" title=\"Except if LocalUniverseJobsRunning is &lt;= 0\">#699</a></span> uncovered a consistency problem in the value of Scheduler::LocalUniverseJobsRunning. It is recomputed periodically in Scheduler::count_jobs(). It is also updated when a local job is started (incremented) and when the job's starter exits (decremented). The counting of jobs marked for holding or removal which have yet to be killed is ambiguous. count_jobs() doesn't include these jobs, but between calls to count_jobs(), they are counted (due to when the decrement happens).\n\n<p>If count_jobs() executes between when a job is marked for holding/removal and when its starter exits, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LocalUniverseJobsRunning\" title=\"Local Universe Jobs Running\">LocalUniverseJobsRunning</a></span> ends up under-counting and possibly going negative. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=699\" onclick=\"get_ticket_and_populate_wrapper('699'); return false;\" title=\"Except if LocalUniverseJobsRunning is &lt;= 0\">#699</a></span> causes the schedd to EXCEPT when this happens. We're seeing this occasionally in the test suite with the job_core_perhold_local test.\n\n</p><p>To remove ambiguity in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LocalUniverseJobsRunning\" title=\"Local Universe Jobs Running\">LocalUniverseJobsRunning</a></span>, count_jobs() (and count(), which it calls) can be changed to not ignore held and removed jobs. <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentHosts\" title=\"Current Hosts\">CurrentHosts</a></span> in the job ad accurately reflects whether the job is running, so we could just remove the job status check. A similar change should be done for scheduler universe jobs.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Nov-08 13:40:35 by jfrey:</em> <br/>\n\nPushed a fix to master for 7.5.5.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-21 16:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25869\">[25869]</a></span>: Add some version history entries. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1695\" onclick=\"get_ticket_and_populate_wrapper('1695'); return false;\" title=\"Improve reaction to misbehaving gahps on startup\">#1695</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1761\" onclick=\"get_ticket_and_populate_wrapper('1761'); return false;\" title=\"Local job slow to exit can kill schedd\">#1761</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1747\" onclick=\"get_ticket_and_populate_wrapper('1747'); return false;\" title=\"Improve hold reasons for cream jobs\">#1747</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1641\" onclick=\"get_ticket_and_populate_wrapper('1641'); return false;\" title=\"Add new job status TRANSFERRING_OUTPUT\">#1641</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1650\" onclick=\"get_ticket_and_populate_wrapper('1650'); return false;\" title=\"Submitting multiple VMWare jobs with single submit doesn't work\">#1650</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-08 12:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=19342\">[19342]</a></span>: Fix counts of running scheduler and local universe jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1761\" onclick=\"get_ticket_and_populate_wrapper('1761'); return false;\" title=\"Local job slow to exit can kill schedd\">#1761</a></span> In the schedd, jobs marked for holding or removal which have yet to be killed are treated inconsistently for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LocalUniverseJobsRunning\" title=\"Local Universe Jobs Running\">LocalUniverseJobsRunning</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedUniverseJobsRunning\" title=\"Sched Universe Jobs Running\">SchedUniverseJobsRunning</a></span>. Between calls to count_jobs(), they're included in the count. In count_jobs(),\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Nov-08 13:40", "status": "resolved", "created": "2010-Nov-08 11:40", "fixed_version": "2010-Nov-08 11:40", "broken_version": "v070504", "priority": "4", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "#699", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}