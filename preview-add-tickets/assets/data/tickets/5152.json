{"id": 5152, "title": "Ticket #5152: Perform spool removal out-of-process", "description": "<blockquote>\nOn the CMS pool, we're seeing stack traces like the following -- it takes &gt;1 minute to return to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span>.\n\n<p>Can we move the recursive chown and/or removal out-of-process?\n\n</p><p></p><div class=\"verbatim\">\n<pre>-bash-4.1$ sudo pstack 1363748\n#0  0x00007f7103cb726e in waitpid () from /lib64/libpthread.so.0\n#1  0x00007f7105779e4c in my_spawnv () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#2  0x00007f7105779fb0 in my_spawnl () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#3  0x00007f71056cbf5b in Directory::rmdirAttempt(char const*, priv_state) () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#4  0x00007f71056cc618 in Directory::do_remove_dir(char const*) () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#5  0x00007f71056cc911 in Directory::do_remove(char const*, bool) () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#6  0x00007f71056cc9b0 in Directory::Remove_Entire_Directory() () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#7  0x00007f7105787325 in ?? () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#8  0x00007f7105789190 in SpooledJobFiles::removeJobSpoolDirectory(classad::ClassAd*) () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#9  0x000000000042f835 in ?? ()\n#10 0x000000000048c349 in DestroyProc(int, int) ()\n#11 0x0000000000443e9c in ?? ()\n#12 0x0000000000484f2f in ?? ()\n#13 0x0000000000430d6d in ?? ()\n#14 0x00007f7105845091 in TimerManager::Timeout(int*, double*) () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#15 0x00007f7105828e57 in DaemonCore::Driver() () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#16 0x00007f7105849d29 in dc_main(int, char**) () from /data/srv/glidecondor/condor-8.3.5-x86_64_RedHat6-stripped/sbin/../lib/libcondor_utils_8_3_5.so\n#17 0x00007f710392ed5d in __libc_start_main () from /lib64/libc.so.6\n#18 0x000000000041c4c9 in ?? ()\n#19 0x00007fffc5fa4938 in ?? ()\n#20 0x000000000000001c in ?? ()\n#21 0x0000000000000002 in ?? ()\n#22 0x00007fffc5fa6a99 in ?? ()\n#23 0x00007fffc5fa6a99 in ?? ()\n#24 0x0000000000000000 in ?? ()\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-16 20:44:25 by bbockelm:</em> <br/>\n\nJust poked through the spool cleanup code a bit more.\n<ul>\n<li>We recursively chown the spool directory to user condor, then spawn /bin/rm to do the dirty work.  CMS spool directories can have tens-of-thousands of files, making the unnecessary clonej() a very expensive operation.\n</li><li>Spawning a separate process costs about 250ms (which honestly we don't have...)\n</li></ul>\n\n<p>If we have to leave this work in-process, doing it more efficiently would really help.\n\n</p><p></p><hr/>\n<em>2015-Jul-27 14:01:19 by jfrey:</em> <br/>\n\nOne option is to remove the chown entirely. That is, the job's spool directory would be owned by the user for its entire lifetime.\n\n<p></p><hr/>\n<em>2015-Jul-28 14:09:40 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>I'm not sure of the impact of removing the chown in <em>all</em> cases - I think there's some good reasons why it's chown'd during hold, for example (I don't know what these are).\n\n</p><p>But certainly, in this particular case (chown is followed up by rm immediately) it seems we can remove the chown.\n\n</p><p>Brian</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "enhance", "last_change": "2016-Jan-20 15:09", "status": "new", "created": "2015-Jul-15 08:52", "fixed_version": "2015-Jul-15 08:52", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}