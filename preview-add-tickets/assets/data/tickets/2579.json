{"id": 2579, "title": "Ticket #2579: Issues in load_avg.cpp and Linux 3.x kernel", "description": "<blockquote>\nTwo issues:\n\n<p></p><ol>\n<li>load_avg.cpp has a switch statement on the major version of the kernel.  On the 3.1.0 kernel, this causes an issue because case \"3\" isn't handled.\n</li><li>The generated error message doesn't end with a newline, causing a pileup of output:\n</li></ol>\n\n<p>10/25/11 02:22:16 /proc format unknown for kernel version 3.1.010/25/11 02:22:21 /proc format unknown for kernel version 3.1.010/25/11 02:22:26 /proc format unknown for kernel version 3.1.010/25/11 02:22:31 /proc format unknown for kernel version 3.1.010/25/11 02:22:36 /proc format unknown for kernel version 3.1.010/25/11 02:22:41 slot1: State change: received RELEASE_CLAIM command</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-25 07:51:43 by matt:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\"># uname -a\nLinux v3node 3.0.7-rt20.36.el6rt.x86_64 #1 SMP PREEMPT RT Wed Oct 19 12:38:05 EDT 2011 x86_64 x86_64 x86_64 GNU/Linux\n\n# condor_config_val NUM_CPUS\n1\n\n# condor_status -l | grep LoadAvg\nTotalLoadAvg = -1.000000\nCpuBusy = ( ( LoadAvg - CondorLoadAvg ) &gt;= 0.500000 )\nLoadAvg = -1.000000\nTotalCondorLoadAvg = -1.000000\nCondorLoadAvg = -1.000000\n\n# condor_status -format \"%d, \" LoadAvg -format \"%d, \" CondorLoadAvg -format \"%d, \" TotalLoadAvg -format \"%d\\n\" TotalCondorLoadAvg\n-1, -1, -1, -1\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Oct-25 07:58:43 by matt:</em> <br/>\n\nAfter simple patch to add \"case 3\" -\n\n<p></p><div class=\"code\">\n<pre class=\"code\"># condor_status -l | grep LoadAvg\nTotalLoadAvg = 0.290000\nCpuBusy = ( ( LoadAvg - CondorLoadAvg ) &gt;= 0.500000 )\nLoadAvg = 0.290000\nTotalCondorLoadAvg = 0.0\nCondorLoadAvg = 0.0\n\n# condor_status -format \"%d, \" LoadAvg -format \"%d, \" CondorLoadAvg -format \"%d, \" TotalLoadAvg -format \"%d\\n\" TotalCondorLoadAvg\n0, 0, 0, 0\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Oct-25 08:08:34 by matt:</em> <br/>\n\nGoing with simple patch to explicitly support major number 3. Skipping the suggestion to blindly parse /proc/loadavg, though it is very <strong>very</strong> likely to be perfectly fine and nothing about the kernel says /proc/loadavg cannot change format in a major version. Not going to smash out the -1 error as its presence allows for detecting a problem without looking into log files.\n\n<p></p><hr/>\n<em>2011-Nov-09 11:39:34 by gthain:</em> <br/>\n\nwhat about blindly parsing the 3 %f's, but checking the return value from scanf, and assuming that if we got 3 %f's we're ok, otherwise returning -1?\n\n<p></p><hr/>\n<em>2011-Nov-09 14:04:22 by matt:</em> <br/>\n\nThat's quite reasonable, for devel series. This ticket went into stable and aimed to be minimal.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/486/condor_load.patch\">condor_load.patch</a>\n1888 bytes added by bbockelm on 2011-Oct-25 12:30:34 UTC.\n<br/>\nSimple patch to remove Linux-version-dependent call to sysapi_load_avg_raw.\n\n<p>Check the return code in the startd to make sure error codes aren't passed to the collector.<br/>\n</p></li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-17 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28298\">[28298]</a></span>: edits of 7.6.5 version history items. Matt: run a spell checker! ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2579\" onclick=\"get_ticket_and_populate_wrapper('2579'); return false;\" title=\"Issues in load_avg.cpp and Linux 3.x kernel\">#2579</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2636\" onclick=\"get_ticket_and_populate_wrapper('2636'); return false;\" title=\"removing startd cron job causes startd to crash\">#2636</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2603\" onclick=\"get_ticket_and_populate_wrapper('2603'); return false;\" title=\"Condor_q -analyze chokes on string attributes that end in backslash\">#2603</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 08:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27969\">[27969]</a></span>: Version history for loadavg detection on v3 linux kernel, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2579\" onclick=\"get_ticket_and_populate_wrapper('2579'); return false;\" title=\"Issues in load_avg.cpp and Linux 3.x kernel\">#2579</a></span>  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 07:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27967\">[27967]</a></span>: Added load_avg support for linux kernels with major number 3, /proc/loadavg format is the same as major version 2, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2579\" onclick=\"get_ticket_and_populate_wrapper('2579'); return false;\" title=\"Issues in load_avg.cpp and Linux 3.x kernel\">#2579</a></span>  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 07:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27966\">[27966]</a></span>: Added newline to unknown /proc/loadavg dprintf, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2579\" onclick=\"get_ticket_and_populate_wrapper('2579'); return false;\" title=\"Issues in load_avg.cpp and Linux 3.x kernel\">#2579</a></span>  (By Matthew Farrellee )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-09 14:04", "status": "resolved", "created": "2011-Oct-24 21:31", "fixed_version": "2011-Oct-24 21:31", "broken_version": "v070600", "priority": "4", "subsystem": "Daemons", "assigned_to": "matt", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}