{"id": 7887, "title": "Ticket #7887: Questions about condor 8.9.8 and Token Authentication", "description": "<blockquote>\nOn a test cluster at LIGO Hanford Observatory with a condor host, submit\nhost, and a node (xcondor, xpcdev1, and xnode1 respectively) we are\nrunning condor 8.9.8 and I am testing Token Authentication.\n\n<p>While I can get it to work, I'm having trouble setting up\nAuthentication/Authorization to allow a user to submit from the submit\nhost without a token.\n\n</p><p>My hope is to allow a user logged onto xpcdev1 to use FS Authentication\nto run condor_submit.\n\n</p><p>I also run into a few other questions while trying to set this up.\n\n</p><p>1. Here's what I've done:\n\n</p><p>i. Based on the SEC settings for Token Authentication given here,\n\n</p><p><a class=\"external\" href=\"https://htcondor.readthedocs.io/en/latest/admin-manual/security.html#token-authentication\">https://htcondor.readthedocs.io/en/latest/admin-manual/security.html#token-authentication</a>\n\n</p><p>and the example ALLOW settings for user-based Authorization given here,\n\n</p><p><a class=\"external\" href=\"https://htcondor.readthedocs.io/en/latest/admin-manual/security.html#example-of-authorization-security-configuration\">https://htcondor.readthedocs.io/en/latest/admin-manual/security.html#example-of-authorization-security-configuration</a>\n\n</p><p>and the condor_token_request_auto_approve command given here,\n\n</p><p><a class=\"external\" href=\"https://htcondor.readthedocs.io/en/latest/admin-manual/security.html#quick-configuration-of-security\">https://htcondor.readthedocs.io/en/latest/admin-manual/security.html#quick-configuration-of-security</a>\n\n</p><p>on the test cluster, xcondor, xpcdev1, and xnode1 at LIGO Hanford, I\ninstalled this config file:\n\n</p><p></p><div class=\"term\">\n<pre class=\"term\">[root@xcondor ~]# cat /etc/condor/config.d/50-test-security\nSEC_NEGOTIATOR_AUTHENTICATION_METHODS = IDTOKENS\nSEC_COLLECTOR_AUTHENTICATION_METHODS = IDTOKENS\nSEC_DAEMON_AUTHENTICATION_METHODS = IDTOKENS\nSEC_DEFAULT_AUTHENTICATION_METHODS= IDTOKENS\nSEC_CLIENT_AUTHENTICATION_METHODS = IDTOKENS\nALLOW_READ            = *@dcs.ligo-wa.caltech.edu/*\nALLOW_WRITE           = *@dcs.ligo-wa.caltech.edu/*.dcs.ligo-wa.caltech.edu\nALLOW_ADMINISTRATOR   = condor@dcs.ligo-wa.caltech.edu/xcondor.dcs.ligo-wa.caltech.edu\nALLOW_CONFIG          = condor@dcs.ligo-wa.caltech.edu/xcondor.dcs.ligo-wa.caltech.edu\nALLOW_NEGOTIATOR      = condor@dcs.ligo-wa.caltech.edu/xcondor.dcs.ligo-wa.caltech.edu\nALLOW_DAEMON          = condor@dcs.ligo-wa.caltech.edu/*.dcs.ligo-wa.caltech.edu\n#ALL_DEBUG = D_CAT D_ALL:2 D_SECURITY\nALL_DEBUG = D_SECURITY\n</pre></div>\n\n\n<p>ii. However, probably not surprisingly, this failed on xcondor:\n\n</p><p>[root@xcondor ~]# condor_token_request_auto_approve -netblock\n10.21.199.0/24 -lifetime 3600\n\n</p><p>iii. If I create a token:\n\n</p><p>[root@xcondor ~]# condor_token_create -identity root@dcs.ligo-wa.caltech.edu\n\n</p><p>and install it in,\n\n</p><p>~/.condor/tokens.d/token\n\n</p><p>then it still fails,\n\n</p><p>[root@xcondor ~]# condor_token_request_auto_approve -netblock\n10.21.199.0/24 -lifetime 3600\n\n</p><p>Failed to create new auto-approval rule: SECMAN:2010:Received \"DENIED\"\nfrom server for user condor_pool@ using method IDTOKENS.\n\n</p><p>iv. However, in /etc/condor/config.d/50-test-security, if I change,\n\n</p><p>SEC_CLIENT_AUTHENTICATION_METHODS = IDTOKENS\n\n</p><p>to\n\n</p><p>SEC_CLIENT_AUTHENTICATION_METHODS = FS, IDTOKENS\n\n</p><p>then it works,\n\n</p><p>[root@xcondor ~]# condor_token_request_auto_approve -netblock\n10.21.199.0/24 -lifetime 3600\n\n</p><p>Successfully installed auto-approval rule for netblock 10.21.199.0/24\nwith lifetime of 1.00 hours\nRemote daemon reports no un-approved requests pending.\n\n</p><p>Cool!\n\n</p><p>I wanted to use FS to Authenticate in any case, when running condor\nadmin commands as root on a host.\n\n</p><p>v. But on xpcdev1 as root, if I change,\n\n</p><p>SEC_CLIENT_AUTHENTICATION_METHODS = IDTOKENS\n\n</p><p>to\n\n</p><p>SEC_CLIENT_AUTHENTICATION_METHODS = FS, IDTOKENS\n\n</p><p>and become user gregory.mendell, then these fail:\n\n</p><p>-bash-4.2$ condor_q -debug\n\n</p><p>10/13/20 16:33:26 Can't open directory \"/etc/condor/passwords.d\" as\nPRIV_UNKNOWN, errno: 13 (Permission denied)\n10/13/20 16:33:26 SECMAN: required authentication with schedd at\n&lt;10.21.199.11:9618&gt; failed, so aborting command QUERY_JOB_ADS_WITH_AUTH.\n\n</p><p>-- Failed to fetch ads from:\n&lt;10.21.199.11:9618?addrs=10.21.199.11-9618&amp;alias=xpcdev1.dcs.ligo-wa.caltech.edu&amp;noUDP&amp;sock=schedd_576483_f778&gt;\n: xpcdev1.dcs.ligo-wa.caltech.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\n-bash-4.2$ cd public_html/testosg/localtest/\n-bash-4.2$ condor_submit localhelloworld.sub\nSubmitting job(s)\nERROR: Failed to connect to local queue manager\nAUTHENTICATE:1003:Failed to authenticate with any method\n\n</p><p>However, if I create a token for myself,\n\n</p><p>[root@xcondor ~]# condor_token_create -identity gregory.mendell@xcondor\n\n</p><p>and install it in  ~/.condor/tokens.d/token under my home directory on\nxpcdev1 then condor_q and condor_submit work!\n\n</p><p>That's nice.\n\n</p><p>But here's my question:\n\n</p><p>How can I get condor_q and condor_submit to work for myself (or any\nuser) who in on the submit host (xpcdev1 for this test) without having\nto issue a token for user?\n\n</p><p>2. After trying the above I also changed,\n\n</p><p>SEC_DEFAULT_AUTHENTICATION_METHODS= IDTOKENS\n\n</p><p>to\n\n</p><p>SEC_DEFAULT_AUTHENTICATION_METHODS= FS, IDTOKENS\n\n</p><p>This seemed to allow condor submit as user gregory.mendell on xpcdev1 to work without a token.\n\n</p><p>But two things still didn't work:\n\n</p><p>i. Without a token, condor_status fails:\n\n</p><p>-bash-4.2$ condor_status\n\n</p><p>Error: communication error\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using FS\n\n</p><p>This probably makes sense, since authentication with the Collector on xcondor will fail without a token.\n\n</p><p>ii. While condor_submit did work without a token, using FS authentication, the job never ran.\n\n</p><p>So far I have been unsuccessful in finding authentication setting that allow user gregory.mendell on xpcdev1 submit jobs and have them run, without a token.\n\n</p><p>3. A couple of other things I've noticed,\n\n</p><p>i. When condor was installed it created this file,\n\n</p><p>[root@xcondor ~]#  ls -l /etc/condor/passwords.d/POOL\n\n</p><p>-rw------- 1 root root 64 Sep 30 10:06 /etc/condor/passwords.d/POOL\n\n</p><p>It belongs to root, and when things fail, as above, one sees:\n\n</p><p>Can't open directory \"/etc/condor/passwords.d\" as PRIV_UNKNOWN, errno:\n13 (Permission denied)\n\n</p><p>ii. Also, I had to copy /etc/condor/passwords.d/POOL from xcondor to\nxpcdev1 and xnode1 to get things to work.\n\n</p><p>iii. Finally, this directory, which belongs to condor,\n\n</p><p>[root@xpcdev1 ~]# ls -ld /etc/condor/tokens.d/\n\n</p><p>drwx------ 2 condor condor 6 Jul 30 17:01 /etc/condor/tokens.d/\n\n</p><p>[root@xpcdev1 ~]# ls -l /etc/condor/tokens.d/\n\n</p><p>total 0\n\n</p><p>is always empty.\n\n</p><p>I'm not sure if i-iii above are expected or not. I thought tokens would\nshow up in /etc/condor/tokens.d/ for daemon to daemon authentication.\nBut maybe I misunderstood the documentation.\n\n</p><p>Thanks for your help!</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Nov-17 10:20:29 by gmendell:</em> <br/>\n\nOne other issue: When token authentication works, it works with a token that is world readable:\n\n<p>-bash-4.2$ ls -al /home/gregory.mendell/.condor/tokens.d/token\n\n</p><p>-rw-rw-r-- 1 gregory.mendell gregory.mendell 280 Sep 28 10:11 /home/gregory.mendell/.condor/tokens.d/token\n\n</p><p></p><hr/>\n<em>2020-Nov-24 15:47:33 by gmendell:</em> <br/>\n\nNotes from 24 Nov. 2020 between Greg Mendell and Zach Miller.\n\n<p>1. On the topic of allowing users to run condor_submit from the submit host without the user having a token, to clarify the above, add FS to BOTH of these options works:\n\n</p><p>SEC_DEFAULT_AUTHENTICATION_METHODS= FS, IDTOKENS\n\n</p><p>SEC_CLIENT_AUTHENTICATION_METHODS = FS, IDTOKENS\n\n</p><p>With the above, user gregory.mendell can successfully submit jobs without a token on xpcdev1, which runs the schedd.\n\n</p><p>2. However, user gregory.mendell cannot run condor_status without a token:\n\n</p><p>-bash-4.2$ whoami\n\n</p><p>gregory.mendell\n\n</p><p>-bash-4.2$ uname -a\n\n</p><p>Linux xpcdev1 3.10.0-1160.6.1.el7.x86_64 <span class=\"ticket\"><a class=\"abandoned\" href=\"tktview?tn=1\" title=\"Another Test\">#1</a></span> SMP Tue Nov 17 13:59:11 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\n\n</p><p>-bash-4.2$ condor_status\n\n</p><p>Error: communication error\n\n</p><p>AUTHENTICATE:1003:Failed to authenticate with any method\n\n</p><p>AUTHENTICATE:1004:Failed to authenticate using FS\n\n</p><p>3. On the central manager, xcondor, adding these options,\n\n</p><p>SEC_READ_AUTHENTICATION = OPTIONAL\n\n</p><p>ALLOW_READ = *.dcs.ligo-wa.caltech.edu\n\n</p><p>did not fix the problem of running condor_status.\n\n</p><p>Trying ALLOW_READ = * didn't work either.\n\n</p><p>4. There is a mystery around condor_status and user root on the submit host running the schedd. Note that user root does not have a token. (Early on, as indicated in this ticket above, I created a token for root, but removed it early on too.)\n\n</p><p>i. When FS is included in the options above, condor_status run as root fails:\n\n</p><p>[root@xpcdev1 ~]# condor_status\n\n</p><p>Error: communication error\n\n</p><p>AUTHENTICATE:1003:Failed to authenticate with any method\n\n</p><p>AUTHENTICATE:1004:Failed to authenticate using IDTOKENS\n\n</p><p>AUTHENTICATE:1004:Failed to authenticate using FS\n\n</p><p>ii. When FS is NOT included in the options above, i.e., setting,\n\n</p><p>SEC_DEFAULT_AUTHENTICATION_METHODS= IDTOKENS\n\n</p><p>SEC_CLIENT_AUTHENTICATION_METHODS = IDTOKENS\n\n</p><p>and running condor_status as root, it succeeds, even though root does not have a token:\n\n</p><p>[root@xpcdev1 ~]# condor_status\n\n</p><p>Name                                 <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpSys\" title=\"Op Sys\">OpSys</a></span>      Arch   State     Activity <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LoadAv\" title=\"Load Av\">LoadAv</a></span> Mem   <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ActvtyTime\" title=\"Actvty Time\">ActvtyTime</a></span>\n\n</p><p>slot1@xnode1.dcs.ligo-wa.caltech.edu LINUX      X86_64 Unclaimed Idle      0.000 1837  0+18:54:51\n\n</p><p></p><pre>               Machines Owner Claimed Unclaimed Matched Preempting  Drain\n</pre>\n\n<p></p><pre>  X86_64/LINUX        1     0       0         1       0          0      0\n</pre>\n\n<p></p><pre>         Total        1     0       0         1       0          0      0\n</pre>\n\n<p>though it still fails when run as user gregory.mendell,\n\n</p><p>-bash-4.2$ whoami\n\n</p><p>gregory.mendell\n\n</p><p>-bash-4.2$ condor_status\n\n</p><p>Error: communication error\n\n</p><p>SECMAN:2002:Configuration Problem: The security policy is invalid.\n\n</p><p>5. Another mystery is what actually happened when running condor_token_request_auto_approve succeeded:\n\n</p><p>[root@xcondor ~]# condor_token_request_auto_approve -netblock 10.21.199.0/24 -lifetime 3600\n\n</p><p>Before the above succeeded, on the submit box, xpcdev1, running the schedd, the logs showed this failure,\n\n</p><p>0/23/20 13:28:36 (pid:704572) Failed to request a new token: DAEMON:1:Failed to recieve response from remote daemon at at '&lt;10.21.199.1:9618?alias=xcondor.dcs.ligo-wa.caltech.edu&gt;'\n\n</p><p>After condor_token_request_auto_approve succeeded on the central manager, xcondor, then the logs on the submit box, xpcdev1, showed,\n\n</p><p>10/23/20 13:33:29 (pid:704990) SECMAN: resuming command 1 UPDATE_SCHEDD_AD to collector xcondor.dcs.ligo-wa.caltech.edu from TCP port 1208 (non-blocking).\n\n</p><p>10/23/20 13:33:29 (pid:704990) Inserting pre-auth metadata for TOKEN.\n\n</p><p>10/23/20 13:33:29 (pid:704990) SECMAN: resuming command 1 UPDATE_SCHEDD_AD to collector xcondor.dcs.ligo-wa.caltech.edu from TCP port 1208 (non-blocking).\n\n</p><p>10/23/20 13:33:29 (pid:704990) SECMAN: new session, doing initial authentication.\n\n</p><p>10/23/20 13:33:29 (pid:704990) SECMAN: Auth methods: TOKEN\n\n</p><p>10/23/20 13:33:29 (pid:704990) AUTHENTICATE: setting timeout for &lt;10.21.199.1:9618?alias=xcondor.dcs.ligo-wa.caltech.edu&gt; to 20.\n\n</p><p>10/23/20 13:33:29 (pid:704990) HANDSHAKE: in handshake(my_methods = 'TOKEN')\n\n</p><p>and job submission worked!\n\n</p><p>However, nothing appears in /etc/condor/tokens.d:\n\n</p><p>[root@xpcdev1 ~]# ls -al /etc/condor/tokens.d\n\n</p><p>total 0\n\n</p><p>drwx------ 2 condor condor   6 Nov 20 07:18 .\n\n</p><p>drwxr-xr-x 7 root   root   215 Nov 23 16:22 ..\n\n</p><p>even though SEC_TOKEN_SYSTEM_DIRECTORY is set to:\n\n</p><p>[root@xpcdev1 ~]# condor_config_val SEC_TOKEN_SYSTEM_DIRECTORY\n\n</p><p>/etc/condor/tokens.d\n\n</p><p>Note that the password file does exist:\n\n</p><p>[root@xpcdev1 ~]# ls -al /etc/condor/passwords.d/POOL\n\n</p><p>-rw------- 1 root root 64 Sep 30 10:06 /etc/condor/passwords.d/POOL\n\n</p><p>which I assume must be used somehow.\n\n</p><p>6. Finally, on the call I repeated that when user gregory.mendell has a token, everything works (condor_submit and condor_status), but it works even though the token is world readable:\n\n</p><p>-bash-4.2$ whoami\n\n</p><p>gregory.mendell\n\n</p><p>-bash-4.2$ uname -a\n\n</p><p>Linux xpcdev1 3.10.0-1160.6.1.el7.x86_64 <span class=\"ticket\"><a class=\"abandoned\" href=\"tktview?tn=1\" title=\"Another Test\">#1</a></span> SMP Tue Nov 17 13:59:11 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\n\n</p><p>-bash-4.2$ ls -al ~/.condor/tokens.d/token\n\n</p><p>-rw-rw-r-- 1 gregory.mendell gregory.mendell 280 Sep 28 10:11 /home/gregory.mendell/.condor/tokens.d/token\n\n</p><p>7. LIGO hopes to switch to Token Authentication when HTCondor has a release that the condor team believes works within their expectations/documentation, and once LIGO is able to test it successfully so that users logged onto a submit host running the schedd can run condor_q, condor_submit and condor_status without a token, with FS authentication on the submit host, and setting on the central manager collector host to allow condor_status to work.\n\n</p><p></p><hr/>\n<em>2020-Nov-24 15:58:56 by zmiller:</em> <br/>\n\nGreg, two things I should have also included:\n<ol>\n<li>On any machine that's going to query the collector (for example, the submit machine where you were running condor_status) you should include this in the config:\n<div class=\"code\">\n<pre class=\"code\">SEC_CLIENT_AUTHENTICATION = OPTIONAL\n</pre></div>\n\n</li><li>Make sure you run condor_reconfig on both the submit machine and central manager if you didn't already.\n</li></ol>\n\n<p>I forgot that if the client is configured to require authentication, then it will insist on doing so even if the server says it is optional.  The config setting in <span class=\"ticket\"><a class=\"abandoned\" href=\"tktview?tn=1\" title=\"Another Test\">#1</a></span> should fix that.\n\n</p><p></p><hr/>\n<em>2021-Apr-13 10:50:57 by pfc:</em> <br/>\n\nGreg, can this ticket be resolved?\n\n<p></p><hr/>\n<em>2021-May-04 10:40:36 by pfc:</em> <br/>\n\nClosing this ticket.  Greg, if you have more issues please open new JIRA tickets with them: <a class=\"external\" href=\"https://opensciencegrid.atlassian.net/secure/Dashboard.jspa?selectPageId=11612\">https://opensciencegrid.atlassian.net/secure/Dashboard.jspa?selectPageId=11612</a></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "incident", "last_change": "2021-May-04 10:40", "status": "resolved", "created": "2020-Oct-20 17:23", "fixed_version": "2020-Oct-20 17:23", "broken_version": "v080908", "priority": "2", "subsystem": "Tools", "assigned_to": "zmiller", "derived_from": "", "creator": "gmendell", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "zmiller@cs.wisc.edu, gmendell@caltech.edu", "due_date": ""}