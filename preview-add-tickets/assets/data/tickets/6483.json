{"id": 6483, "title": "Ticket #6483: Improve logging when a daemon gets a fatal signal", "description": "<blockquote>\nThe signal handler installed for fatal signals in daemoncore can do a much better job of logging information that would be helpful in diagnosing a crash. The following improvements should be made:\n\n<p></p><ul>\n<li>Log the signal number.\n</li><li>Use the enhanced signal handler that receives a siginfo_t, and log data from that struct.\n</li><li>Use dprintf()'s async-safe log-writing function for all logging in the signal handler.\n</li><li>Always install the signal handler on unix, not just when the Google coredumper is present.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2017-Dec-12 15:59:28 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> changes look good.\n\n<p></p><hr/>\n<em>2017-Dec-12 16:17:42 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> changes look good.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Dec-13 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52994\">[52994]</a></span>: Docs for improved signal handler logging. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6483\" onclick=\"get_ticket_and_populate_wrapper('6483'); return false;\" title=\"Improve logging when a daemon gets a fatal signal\">#6483</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52852\">[52852]</a></span>: Improve handling of failure to re-raise signal in signal handler. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6483\" onclick=\"get_ticket_and_populate_wrapper('6483'); return false;\" title=\"Improve logging when a daemon gets a fatal signal\">#6483</a></span> Try to write a message to the log, then exit with our EXCEPT exit code, bypassing at-exit process cleanup code.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-10 11:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52782\">[52782]</a></span>: Log more data when catching a fatal signal. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6483\" onclick=\"get_ticket_and_populate_wrapper('6483'); return false;\" title=\"Improve logging when a daemon gets a fatal signal\">#6483</a></span> Install the core-dump signal handler whenever backtrace() is available. In the signal handler, log the signal number and additional data about its origin (faulting address or sending process). Use the async-safe variant of dprintf().  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-10 11:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52781\">[52781]</a></span>: Make signal-safe logging function available to signal handlers. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6483\" onclick=\"get_ticket_and_populate_wrapper('6483'); return false;\" title=\"Improve logging when a daemon gets a fatal signal\">#6483</a></span> dprintf_dump_stack() uses a simple logging function that's safe to use in a signal handler. Make that function available for use by other signal handler code.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Dec-13 11:45", "status": "resolved", "created": "2017-Nov-10 09:52", "fixed_version": "2017-Nov-10 09:52", "broken_version": "", "priority": "3", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "#6476", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}