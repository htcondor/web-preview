{"id": 5625, "title": "Ticket #5625: Overhaul grid universe job leases", "description": "<blockquote>\nThe management of job leases in the grid universe needs several improvements. The calculation of leases is overly complex, especially when many jobs must share the same lease. Recently, users reported that the gridmanager was setting abnormally short leases for cream jobs, and it was difficult to trace the code to see how that could happen. There are also several inefficiencies in how leases are renewed for Condor-C jobs.\n\n<p>We propose the following changes to the job lease code for the grid universe:\n</p><ul>\n<li>All jobs managed by the same Resource object in the gridmanager share a single lease\n<ul>\n<li>Lease duration is minimum of all current jobs\n</li><li>Allow individual jobs to have no lease, where already supported (grid-type condor)\n</li></ul>\n</li><li>Remove CalculateJobLease() function\n</li><li>Simplify lease update sequence in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BaseResource\" title=\"Base Resource\">BaseResource</a></span> in the gridmanager\n<ul>\n<li>Don't require synching of lease update in local job queue before doing update to remote server\n</li><li>Remove ATTR_LAST_JOB_LEASE_RENEWAL_FAILED\n</li><li>Update lease expiration time in local Job objects only after remote operation succeeds\n</li></ul>\n</li></ul>\n\n<p>The following changes will be considered for a future release:\n\n</p><p></p><ul>\n<li>In c-gahp, use SetAttribute() with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NoAck\" title=\"No Ack\">NoAck</a></span> flag to update lease expiration times\n</li><li>Consider requiring leases for grid-type condor jobs\n<ul>\n<li>Make default lease duration configurable, possibly per grid-type</li></ul>\n</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-May-04 11:16:27 by jfrey:</em> <br/>\n\nOne issue with using the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NoAck\" title=\"No Ack\">NoAck</a></span> flag for lease updates in the c-gahp is that if one job disappears from the remote job queue, all lease updates will fail with no indication of why.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-28 16:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48684\">[48684]</a></span>: Docs for grid universe job lease overhaul. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5625\" title=\"Overhaul grid universe job leases\">#5625</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-04 14:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48360\">[48360]</a></span>: Fix compiler warning for a dprintf() message. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5625\" title=\"Overhaul grid universe job leases\">#5625</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-14 15:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48254\">[48254]</a></span>: Use new lease expiration in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorResource\" title=\"Condor Resource\">CondorResource</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5625\" title=\"Overhaul grid universe job leases\">#5625</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-14 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48252\">[48252]</a></span>: Simplify lease update sequence for grid jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5625\" title=\"Overhaul grid universe job leases\">#5625</a></span> Update lease expiration in local job ads after renewal with remote server succeeds, instead of before. Remove attribute ATTR_LAST_JOB_LEASE_RENEWAL_FAILED.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-14 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48251\">[48251]</a></span>: Fix BaseResource::GetLeaseExpiration() for jobs with no lease. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5625\" title=\"Overhaul grid universe job leases\">#5625</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-14 12:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48250\">[48250]</a></span>: Simplify job lease calculations in the gridmanager. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=5625\" title=\"Overhaul grid universe job leases\">#5625</a></span> Each <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BaseResource\" title=\"Base Resource\">BaseResource</a></span> object now maintains one lease for all of its jobs. Simplified lease calculations are made directly in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BaseResource\" title=\"Base Resource\">BaseResource</a></span>, with the duration equal to the minimum of lease durations of those jobs. For Condor-C, jobs can still have no\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-28 16:27", "status": "resolved", "created": "2016-Apr-13 15:08", "fixed_version": "2016-Apr-13 15:08", "broken_version": "v080400", "priority": "3", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}