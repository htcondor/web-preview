{"id": 5621, "title": "Ticket #5621: DAG halt should be propagated to sub-DAGs", "description": "<blockquote>\nJust talking with Karan and Gideon from ISI, and we agreed that DAG halting should be propagated to sub-DAGs.  I'm about 95% sure it isn't; Karan thought he did a test that shows that it is, but he's going to re-try the test.</blockquote>", "remarks": "<blockquote>\n<em>2017-Mar-23 13:59:12 by wenger:</em> <br/>\n\nHmm -- I'm thinking that if we do this we should probably add a config knob to restore the old behavior.\n\n<p><em>2017-Apr-26 09:50:00 by coatsworth:</em> <br/>\n\nI've taken a first pass at implementing this. Changes are in the V8_7-gt5621-subdag-halt branch.\n\n</p><p>The code to propagate halts is in dag.cpp and seems straightforward.\n\n</p><p>I've also added the config knob. There are several different ways to get this value through to the code which handles halt files. I've done my best to keep it consistent with existing approaches, hope this all looks okay.\n\n</p><p>Please have a look and let me know.\n\n</p><p></p><hr/>\n<em>2017-May-17 16:21:02 by wenger:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>There are a few things that need to be changed:\n\n</p><p></p><ul>\n<li>Most important, when the top-level DAG goes from the halted to the running state, that also needs to be propagated down to sub-DAGs (by removing the relevant halt files).\n\n<p></p></li><li>An optimization would be only creating and removing halt files for sub-DAGs that are actually in the queue.  (You can tell this from Job::GetStatus().)\n\n<p></p></li><li>I'd like to see the job_dagman_halt-A test extended to include this (or a new halt test created with a sub-DAG).\n\n<p></p></li><li>The DAGMAN_PROPAGATE_HALTS_TO_SUBDAGS knob needs to get documented in section  3.5 (see admin-man/configure.tex).\n\n<p></p></li><li>There needs to be a version history entry for this change.  That section should also reference the new config knob.\n\n<p></p></li><li>Section 2.10.8 Suspending a Running DAG of the manual needs to be changed to reflect the propagation of halting.\n</li></ul>\n\n<p></p><hr/>\n<em>2017-May-31 15:16:38 by coatsworth:</em> <br/>\n\nI've fixed the documentation, fixed the reverse propagation when a halt file is removed, and included a new test (job_dagman_halt-B).\n\n<p>Only thing I have not done is optimizing by creating/removing halt files only for sub-DAGs that are actually in the queue. I was a bit confused about the different Status states and how sub-DAGs might change status between halt creation/removal, worried this could lead to incorrect behavior. If you think it's important I'll look into it in more detail.</p></blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-31 12:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51658\">[51658]</a></span>: Modified the test to hopefully run deterministically (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-30 17:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51657\">[51657]</a></span>: Added test for sub-DAG propagation (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-22 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51655\">[51655]</a></span>: Halt file deletions now propogated to sub-DAGs (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-22 09:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50697\">[50697]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-25 17:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50581\">[50581]</a></span>: Added knob to revert to old behavior (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-25 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50577\">[50577]</a></span>: Fixed bug for SubDAG files in same folder as main DAG (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-24 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50575\">[50575]</a></span>: Basic implementation of halt propagation to sub-dags (<span class=\"ticket\"><a class=\"review\" href=\"tktview?tn=5621\" title=\"DAG halt should be propagated to sub-DAGs\">#5621</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Jun-01 11:12", "status": "review", "created": "2016-Apr-12 11:42", "fixed_version": "2016-Apr-12 11:42", "broken_version": "v080504", "priority": "4", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu, zmiller@cs.wisc.edu, vahi@isi.edu, ckoch5@wisc.edu, lmichael@wisc.edu, coatsworth@cs.wisc.edu", "due_date": ""}