{"id": 4710, "title": "Ticket #4710: Valgrind error in user log writing code", "description": "<blockquote>\nNote:  I suspect that this bug exists in 8.2 -- if it does, it should obviously be fixed in that branch.\n\n<p>Anyhow, I was running valgrind on DAGMan to check some changes, and it came up with this error:\n\n</p><p></p><pre>  ==11550== Conditional jump or move depends on uninitialised value(s)\n  ==11550==    at 0x4E0D8FC: WriteUserLog::freeLogs() (write_user_log.cpp:569)\n  ==11550==    by 0x4E0D334: WriteUserLog::Reset() (write_user_log.cpp:428)\n  ==11550==    by 0x4E0BD43: WriteUserLog::WriteUserLog(bool) (write_user_log.cpp:93)\n  ==11550==    by 0x447F1B: Dag::PostScriptReaper(Job*, int) (dag.cpp:1893)\n  ==11550==    by 0x454FBC: ScriptQ::ScriptReaper(int, int) (scriptQ.cpp:180)\n</pre>\n\n<p>Here's the code:\n\n</p><p></p><pre>  void WriteUserLog::freeLogs() {\n      // we do this only if local log files aren't being cached\n      if (log_file_cache != NULL) return;\n      for (std::vector&lt;log_file*&gt;::iterator j(logs.begin());  j != logs.end();  ++j) {\n          delete *j;\n      }\n  }\n</pre>\n\n<p>This gets called in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> constructors without log_file_cache having been set.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Nov-08 20:31:27 by wenger:</em> <br/>\n\njob_dagman_basic.dag was the DAG I ran...\n\n<p></p><hr/>\n<em>2014-Nov-10 18:49:44 by wenger:</em> <br/>\n\nOkay, this is also in 8.2.  Introduced in this commit:\n\n<p></p><pre>  commit b4a7657edfe662a47af0ef9462140ad055d6d9e2\n  Author: Erik Erlandson &lt;eerlands@redhat.com&gt;\n  Date:   Fri Mar 21 12:26:59 2014 -0700\n</pre>\n\n<p></p><pre>      Use a cache of open userlog files (and locks) to improve efficiency of\n      userlog output #4040\n</pre>\n\n<p></p><hr/>\n<em>2014-Nov-17 17:25:53 by eje:</em> <br/>\n\nlog_file_cache is set to NULL in the Reset() method, so this patch seems to introduce a redundant initialization.  Also, freeLogs() wants to know its value before it is cleared.  Is this some kind of pro forma valgrind complaint?\n\n<p></p><hr/>\n<em>2014-Nov-17 17:33:45 by wenger:</em> <br/>\n\nNo, it's not a pro forma complaint.  In the constructors (without my change), Reset() gets called before anything else.  Then Reset() calls freeLogs() <strong>before</strong> setting log_file_cache to NULL, and the first line of freeLogs() is\n\n<p></p><pre>  if (log_file_cache != NULL) return;\n</pre>\n\n<p></p><hr/>\n<em>2014-Nov-18 15:39:17 by eje:</em> <br/>\n\nOK I see my error, good catch.  Fix looks good to me, thanks!\n\n<p></p><hr/>\n<em>2014-Nov-19 12:19:09 by wenger:</em> <br/>\n\nOh, yeah -- no documentation for this because, as far as we know, it didn't produce a user-visible bug.</blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/852/gt4710_dif\">gt4710_dif</a>\n1102 bytes added by wenger on 2014-Nov-11 20:50:26 UTC.\n<br/>\nHere's a diff of the fix.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-19 12:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41682\">[41682]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=4710\" title=\"Valgrind error in user log writing code\">#4710</a></span>: Committing the fix after review by eje.  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Nov-19 12:19", "status": "resolved", "created": "2014-Nov-08 20:24", "fixed_version": "2014-Nov-08 20:24", "broken_version": "v080106", "priority": "1", "subsystem": "Libs", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu, zmiller@cs.wisc.edu, tannenba@cs.wisc.edu, eje@cs.wisc.edu", "due_date": ""}