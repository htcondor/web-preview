{"id": 2532, "title": "Ticket #2532: Finishing a unit test you're not in should be an error", "description": "<blockquote>\nIf there is a bug in the testing code, and one of the PASS, FAIL, or ABORT macros is called, but we're not currently in a test, the unit test binary will merrily mark it up as a pass/fail/abort and continue on.  This will lead to a summary claiming that more tests finished that started.  The batch test wrapper (lib_unit_tests.run) will correctly treat this as an error.  Tracking down the rogue code is a pain in the butt.  Having run into exactly this situation, I propose:\n\n<p></p><ol>\n<li>Implement <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2531\" onclick=\"get_ticket_and_populate_wrapper('2531'); return false;\" title=\"unit test PASS and FAIL macros should include/use __FILE__\">#2531</a></span>, so we know which file contains the unexpected PASS/FAIL/ABORT\n</li><li>Modify class Emitter to add \"bool in_test\"\n</li><li>Modify Emitter::Emitter to initialize in_test = false\n</li><li>Modify Emitter::emit_test:\n<ol>\n<li>if(in_test == true) { freak out }\n</li><li>in_test = true;\n</li></ol>\n</li><li>Modify Emitter::emit_result_success, Emitter::emit_result_failure, and Emitter::emit_result_abort\n<ol>\n<li>if(in_test == false) { freak out, reporting the file and line number }\n</li><li>in_test = false;</li></ol>\n</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Jul-16 13:28:20 by adesmet:</em> <br/>\n\nImplemented</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-16 13:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32800\">[32800]</a></span>: Unit tests now complain about getting a result when not in a test, or starting a test when the previous didn't return anything. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2532\" onclick=\"get_ticket_and_populate_wrapper('2532'); return false;\" title=\"Finishing a unit test you're not in should be an error\">#2532</a></span> Non user facing.  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Jul-16 13:28", "status": "resolved", "created": "2011-Oct-07 16:42", "fixed_version": "2011-Oct-07 16:42", "broken_version": "v070000", "priority": "4", "subsystem": "Tests", "assigned_to": "adesmet", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}