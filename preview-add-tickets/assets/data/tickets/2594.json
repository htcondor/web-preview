{"id": 2594, "title": "Ticket #2594: Negative process ages on mac", "description": "<blockquote>\nOn the mac machines in the batlab (both old and new), we occasionally see errors like this:\n<div class=\"code\">\n<pre class=\"code\">ProcAPI sanity failure on pid 1317, age = -1901480712\n</pre></div>\n\n\n<p>This error is printed by ProcAPI::do_usage_sampling(), which is called by ProcAPI::getProcInfo(). The likely problem is that the sysctl() calls made by getProcInfoRaw() don't fail if the given pid doesn't exist. They return success and leave the structures meant to contain the process info untouched. getProcInfo() and getProcInfoRaw() then read values out of these uninitialized structures.\n\n</p><p>ProcAPI::getProcInfo() could be called repeatedly with a non-existent pid by KillFamily::takesnapshot(), which remembers pids it saw in the past and checks if they're still alive.\n\n</p><p>getProcInfo()/getProcInfoRaw() need to be modified on Darwin to properly detect when a pid doesn't exist. It appears we can detect this by checking whether the second call to sysctl() sets bufSize to 0 or non-0.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-31 11:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28057\">[28057]</a></span>: rewrite of version history entry ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2594\" title=\"Negative process ages on mac\">#2594</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-27 16:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28017\">[28017]</a></span>: Make procapi on macos properly detect non-existent pids. <span class=\"ticket\"><a class=\"resolved\" href=\"tktview?tn=2594\" title=\"Negative process ages on mac\">#2594</a></span> If ProcAPI::getProcInfo() is called for a non-existent pid on macos, it uses random data from the heap as the pid's stats. This is because when sysctl() is called on an invalid pid, it returns success and indicates that no data was written\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Oct-27 16:14", "status": "resolved", "created": "2011-Oct-27 15:16", "fixed_version": "2011-Oct-27 15:16", "broken_version": "v070600", "priority": "4", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "", "due_date": ""}