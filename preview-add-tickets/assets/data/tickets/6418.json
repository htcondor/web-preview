{"id": 6418, "title": "Ticket #6418: Master isn't deleting CREDMON_COMPLETE file", "description": "<blockquote>\nThe master needs to delete the file CREDMON_COMPLETE under SEC_CREDENTIAL_DIRECTORY at startup so that credentials are refreshed appropriately. Due to a bad set of constructors and operator+ methods for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span>, the master builds an invalid path to the file, so it never deletes it.\n\n<p>This is the relevant code:\n</p><div class=\"code\">\n<pre class=\"code\">MyString cred_file;\ncred_file = p; // param(\"SEC_CREDENTIAL_DIRECTORY\")\ncred_file = cred_file + DIR_DELIM_CHAR + \"CREDMON_COMPLETE\";\n</pre></div>\n\n\n<p>DIR_DELIM_CHAR is a slash character (<code>'/'</code>) on unix. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span> code promotes the char to an int, then constructs a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span> of \"47\" to append to cred_file.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-26 14:59:35 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>:  Looks good.  Version history not required due to narrow scope of interested users.\n\n<p></p><hr/>\n<em>2018-Jan-09 12:30:56 by tannenba:</em> <br/>\n\nIMHO, this code should be using dircat() from directory_util.h in the utils lib.  It does exactly what is desired, and does it with a lot more error checking.\n\n<p>From directory_util.h:\n</p><div class=\"code\">\n<pre class=\"code\">/** Take two strings, a directory path, and a filename, and\n  concatenate them together.  If the directory path doesn't end with\n  the appropriate directory deliminator for this platform or has excess delimiters, this\n  function will ensure that only a single, correct directory delimiter is included in the\n  resulting full path.\n  for example all of the examples below write path/to/file\" into buf\n      dirscat(\"path/to\", \"file\", buf)\n      dirscat(\"path/to/\", \"/file\", buf)\n      dirscat(\"path/to//\", \"file\", buf)\n  @param dirpath The directory path.\n  @param filename The filename.\n  @param result  The output buffer\n  @return Value() of result parameter after it has been set by this function\n*/\nconst char* dircat(const char* dirpath, const char* filename, MyString &amp; result);\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-26 10:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52421\">[52421]</a></span>: Fix deletion of CREDMON_COMPLETE in the master. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6418\" onclick=\"get_ticket_and_populate_wrapper('6418'); return false;\" title=\"Master isn't deleting CREDMON_COMPLETE file\">#6418</a></span> Due to a weird set of methods in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span>, the master is constructing an invalid path to the CREDMON_COMPLETE file it wants to delete. The path string has \"47\" instead of \"/\" between the directory and filename. Switch to formatstr() to get the correct\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Jan-09 12:30", "status": "resolved", "created": "2017-Sep-26 10:26", "fixed_version": "2017-Sep-26 10:26", "broken_version": "v080505", "priority": "3", "subsystem": "DaemonMaster", "assigned_to": "jfrey", "derived_from": "#5338", "creator": "jfrey", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "jfrey@cs.wisc.edu tannenba@cs.wisc.edu zmiller@cs.wisc.edu", "due_date": ""}