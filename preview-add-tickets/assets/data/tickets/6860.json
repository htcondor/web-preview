{"id": 6860, "title": "Ticket #6860: scitokens: parentheses in requirements expr causes submit to fail", "description": "<blockquote>\nThe current expected behavior for condor_submit when someone submits a job requiring OAuth tokens is:\n\n<p></p><ol>\n<li>condor_submit checks (with the credd) if tokens are available. If they exist, then submit the job. If the tokens don't exist, then...\n</li><li>Send the user to a URL to gather tokens.\n</li><li>After gathering tokens, the user runs condor_submit again on the same job, which goes back to step (1).\n</li></ol>\n\n<p>It sounds like if there are parentheses in the requirements expression in a submit file that is requesting tokens, something breaks causing condor_submit to never believe that the tokens exist, so the user is always sent to the URL.\n\n</p><p>Example from Duncan Brown:\n\n</p><p></p><div class=\"verbatim\">\n<pre>I found a strange edge case in the condor_submit. If I have brackets in requirements, then every condor_submit is a new token request and I can never run a job. Here's my submit file:\n\n&gt; universe = vanilla\n&gt;\n&gt; output = scitokens_test.$(cluster).$(process).out\n&gt; error = scitokens_test.$(cluster).$(process).err\n&gt; log = scitokens_test.$(cluster).log\n&gt;\n&gt; executable = /usr/bin/env\n&gt;\n&gt; use_oauth_services = scitokens\n&gt;\n&gt; scitokens_oauth_permissions = xxx\n&gt; scitokens_oauth_resource = xxx\n&gt;\n&gt; requirements = (TARGET.CondorVersion is \"$CondorVersion: 8.8.0 Jan 03 2019 BuildID: 457757 PackageID: 8.8.0-1 $\")\n&gt;\n&gt; queue\n\nFirst submit, I get a request to get a token:\n\n&gt; [dbrown@sugwg-scitokens test_job]$ condor_submit token-test.sub\n&gt; Submitting job(s)\n&gt; Hello, dbrown.\n&gt; Please visit: xxx\n\nI can successfully get the token, now Jeff fixed the sever. But when I resubmit, I thinks the [token requirements] have changed:\n\n&gt; [dbrown@sugwg-scitokens test_job]$ condor_submit token-test.sub\n&gt; Submitting job(s)\n&gt; Hello, dbrown.\n&gt; Please visit: xxx\n\nIf I remove the brackets in requirements:\n\n&gt; [dbrown@sugwg-scitokens test_job]$ grep requirements token-test.sub\n&gt; requirements = TARGET.CondorVersion is \"$CondorVersion: 8.8.0 Jan 03 2019 BuildID: 457757 PackageID: 8.8.0-1 $\"\n\nthen it works as expected:\n\n&gt; [dbrown@sugwg-scitokens test_job]$ condor_submit token-test.sub\n&gt; Submitting job(s)\n&gt; Hello, dbrown.\n&gt; Please visit: xxx\n&gt;\n&gt; [dbrown@sugwg-scitokens test_job]$ condor_submit token-test.sub\n&gt; Submitting job(s).\n&gt; 1 job(s) submitted to cluster 6509687.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Jan-17 09:23:44 by jpatton:</em> <br/>\n\nI could not reproduce this, neither could Duncan:\n\n<p></p><div class=\"verbatim\">\n<pre>Hi Jason,\n\nHmmm... Now I can't reproduce the bracket problem either:\n\n[dbrown@sugwg-scitokens test_job]$ condor_submit bracket-test.sub\nSubmitting job(s)\nHello, dbrown.\nPlease visit: xxxx\n\n[dbrown@sugwg-scitokens test_job]$ vim bracket-test.sub\n[dbrown@sugwg-scitokens test_job]$ condor_submit bracket-test.sub\nSubmitting job(s).\n1 job(s) submitted to cluster 6509699.\n\nI wonder if I somehow munged the permissions when I was manually changing the permissions of the credential file. Let's chalk this up as user error unless I can reproduce it.\n\nCheers,\nDuncan.\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "defect", "last_change": "2019-Jan-17 09:28", "status": "abandoned", "created": "2019-Jan-16 11:13", "fixed_version": "2019-Jan-16 11:13", "broken_version": "v080800", "priority": "2", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "#6513", "creator": "jpatton", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "jpatton@cs.wisc.edu,tannenba@cs.wisc.edu", "due_date": ""}