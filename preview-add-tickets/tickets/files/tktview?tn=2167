<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="stylesheet" type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/cvstrac.10.css">
<link rel="stylesheet" type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/cvstrac.tj.css">
<link rel="stylesheet" type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/diff2html.css">
<link rel="alternate stylesheet"
      title="prosimii-screen"
      type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/prosimii-screen.css">
<link rel="alternate stylesheet"
      title="Default Stylesheet"
      type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/cvstrac_default.css">
<link rel="alternate" type="application/rss+xml"
   title="HTCondorWiki Timeline Feed" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/timeline.rss">
<link rel="index" title="Index" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/index">
<link rel="search" title="Search" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/search">
<link rel="help" title="Help"
   href="https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=CvstracDocumentation">
<title>HTCondorWiki: Ticket #2167</title>
<script type="text/javascript">
  function setFocus() {
    var firstForm, e;
    if ( document.forms && (firstForm = document.forms[0]) ) {
      if      ( (e = firstForm.elements["u"]) && e.type == "text" ) e.focus();
      else if ( (e = firstForm.elements["t"]) && e.type == "text" ) e.focus();
      else if ( (e = firstForm.elements["s"]) && e.type == "text" ) e.focus();
    }
  }
</script>
</head>
<body onload="setFocus()">
<div id="header">
<div class="midHeader">
<div class="iconHeader">
<a href="https://www.cs.wisc.edu/condor"><img src="https://research.cs.wisc.edu/htcondor/images/HTCondor_wiki_logo_small.png" alt="HTCondor High Throughput Computing" border=0></a>
</div>
</div>
</div><div id="header">
<h1 id="title">
Ticket #2167
</h1>
<p id="identity">
<a href="honeypot"><notatag arg="meaningless"></a>
<a href="login?nxp=/index.cgi/tktview%3Ftn%3D2167" title="Log in">Not logged in</a>
</p>
<ul id="navigation">
<li><a href="dir">Browse</a></li>
<li><a href="wiki?p=CvstracTicket">Help</a></li>
<li><a href="index">Home</a></li>
<li><a href="login">Login</a></li>
<li><a href="reportlist">Reports</a></li>
<li><a href="search?t=1">Search</a></li>
<li><a href="timeline">Timeline</a></li>
<li><a href="wiki">Wiki</a></li>
</ul>
<ul id="action">
<li><a href="tkthistory?tn=2167" rel="nofollow">History</a></li>
</ul>
</div>
<div id="content">
<h2>Ticket #2167: Propagate DAG node priorities down to job priorities</h2>
<blockquote>
This resulted from today's meeting with the Spalding lab people.

<p>Anyhow, they basically want node priorities to propagate down through sub-DAGs, and then to the actual Condor priorities of the node jobs within the sub-DAGs.  Since you can specify node priorities in each DAG, there would have to be some kind of concatenation of priorities at each level, and then DAGMan would eventually pass the result when it submitted a job.  Also, the user would be able to set priorities for the top-level DAGs (maybe we'd need a new condor_submit_dag command-line flag for this, because we don't want to encourage people to edit the .condor.sub files).  A DAG would get its priority from its Condor priority, so that way priorities could get propagated down through sub-DAGs.

<p>So, for example, if a top-level DAG itself had a priority of 5, and then it had a subdag external node with a priority of 3, and that sub-DAG had a node with a priority of 6, the job might end up getting submitted with a priority of 50306.  (Obviously, this would only work right for a certain range of priority values; and we'd have to think about how to handle negative priorities, since they are allowed.)  Hmm -- and we'd have to really think about this, because in that example, &quot;deeper&quot; nodes with have better priorities, which might not be what we want...

<p>There should probably be a flag to turn this on or off -- the implication if it's on is that DAGMan would override any Condor priorities set in node job submit files.</blockquote>

<table align="right" style="margin: 0 10px;" cellpadding=2 border=0>
<tr><td bgcolor="#a0b5f4" class="border1">
<table width="100%" border=0 cellpadding=4 cellspacing=0>
<tr bgcolor="#d0d9f4" class="bkgnd1">
<td valign="top" align="left">
[<a href="tktappend?tn=2167">Append remarks</a>]
</td></tr></table></td></tr></table>
<h3>Remarks:</h3>
<blockquote>
<em>2011-May-17 17:35:06 by wenger:</em> <br>

Maybe make node priorities floats instead of ints.

<p><hr>
<em>2011-May-18 12:52:10 by nwp:</em> <br>

Is <span class="ticket"><a href="tktview?tn=1992" class="resolved"
title="Implement First Come, First Served for dagman jobs"
>#1992</a></span> relevant for this ticket?

<p><hr>
<em>2011-May-18 13:44:52 by wenger:</em> <br>

Hmm -- I didn't even know about <span class="ticket"><a href="tktview?tn=1992" class="resolved"
title="Implement First Come, First Served for dagman jobs"
>#1992</a></span>.  If anything, I think it makes what we want to do more complicated, because which priority do we set?  I wish they'd have given a more detailed scenario of how this is supposed to be used -- I'm not totally sure what it gains us over just having one priority value.

<p><hr>
<em>2011-Jun-15 10:56:41 by nwp:</em> <br>

My plan now is to sum the priorities of the dag harmonically from the
root to a node, then multiply the user priority by that sum to give a priority for that job.  Then insert the priority in the node job file.  Negative priorities will be set to 1 for the first round, until we see what is the correct thing to do.  Another idea is to sum exponentially.  Here I mean

<p>Harmonic sum: <div class="restricted">s<sup>-1</sup>=x<sub>1</sub><sup>-1</sup>+...+x<sub>n</sub><sup>-1</sup></div>

<p>Exponential sum: <div class="restricted">2<sup>-s</sup>=2<sup>-x<sub>1</sub></sup>+...
2<sup>-x<sub>n</sub></sup></div>

<p>The point here is to preserve order.

<p><hr>
<em>2011-Jun-15 12:53:41 by psilord:</em> <br>

How do you handle diamond-style dag structures with your priority propagation math?

<p>Suppose you have a user priority and job priorities and this dag:
<div class="verbatim">
<PRE>
a -> b, c
b -> d -> e -> f
c, f -> g
</PRE></div>


<p>What's the priority of g?

<p><hr>
<em>2011-Jun-15 13:10:25 by nwp:</em> <br>

Good question. I am thinking I will initially take max_prio(S), where S is the set of parent dag nodes.

<p><hr>
<em>2011-Jun-15 16:17:34 by psilord:</em> <br>

There are different choices for the mixing of the contributions of the priorities from parental paths: max, min, average, statistical variance, choose one only, and [infinite set of functions]....

<p>Why are any of them better than any other? In practice, which one would be what the user wants to do?

<p>I could see something like a priority of a node dominating all nodes below it.
A high priority node would contaminate the future nodes with the same priority.
This is your max_prio(S) solution.

<p>It seems to makes sense, but I could see other functions that would be just as useful, like take the priority of the first parental node after being lexographically sorted.

<p>Is it possible for the user to supply a function which acts as a selector for
an arbitrary number of contributing priorities and have it default to max() unless otherwise specified? My intuition tell me no, since Condor isn't that
flexible in this context.... but if you could do it cheaply in your time, that
might be the way to go.

<p><hr>
<em>2011-Jun-15 16:19:36 by psilord:</em> <br>

Also, see my remark on ticket <span class="ticket"><a href="tktview?tn=1482" class="resolved"
title="Allow a cleanup/final DAG node that is always run"
>#1482</a></span> about priority calculations between jobs.
That can represent a DAG as well.

<p><hr>
<em>2011-Jun-15 16:23:06 by psilord:</em> <br>

Hrm, wrong ticket, lemme find the right one...

<p><hr>
<em>2011-Jun-15 16:27:24 by psilord:</em> <br>

Ah ok, here it is: <span class="ticket"><a href="tktview?tn=1992" class="resolved"
title="Implement First Come, First Served for dagman jobs"
>#1992</a></span>.

<p>This is related in that if my solution had been implemented, it wold allow any
set of jobs to have the priorities of an arbitrary DAG ordering. It might not
be directly applicable here, but it would be good to have in your mind.

<p><hr>
<em>2011-Jun-30 09:31:21 by nwp:</em> <br>

Currently, we want to avoid starving high-priority children that have low-priority parents, so the priorities get copied up, to the parents. But then
if a user declares a toplevel low priority DAG node, the priority gets overwritten. If you have a library of DAGs, you may want the toplevel priority to take precedence.  Of course then a solution is to have a policy that a library DAG node can only have a priority in a certain range, say, (0,100), and the toplevel DAG node policy would then be to have priority in the range of, say, (101,200).  (Currently here means the patch as it is on 30 June 2011).

<p><hr>
<em>2011-Jun-30 12:53:14 by nwp:</em> <br>

OK, here is a use case where I am not sure what to do:

<p>A-&gt;B, C-&gt;D.  Here A is high priority, B is low. C is low, D is high.

<p>This dag gets submitted. A runs first, finishes, and then B starts. C runs, and starts up D.  Does D then preempt B?  My intuition is that the sequence A,C,D,B is
better.

<p><hr>
<em>2011-Sep-14 15:13:46 by psilord:</em> <br>

Ok I reviewed it. Looks good.

<p><hr>
<em>2011-Sep-14 15:26:05 by nwp:</em> <br>

Merged to master at 2853cb6.  Documentation is already finished, so skipping docpending state.</blockquote>
<table align="right" style="margin: 0 10px;" cellpadding=2 border=0>
<tr><td bgcolor="#a0b5f4" class="border1">
<table width="100%" border=0 cellpadding=4 cellspacing=0>
<tr bgcolor="#d0d9f4" class="bkgnd1">
<td valign="top" align="left">
[<a href="tktappend?tn=2167">Append remarks</a>]
</td></tr></table></td></tr></table>


<h3>Properties:</h3>

<blockquote>
<table>
<tr>
  <td align="right">Type:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>enhance&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Last&nbsp;Change:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>2011-Sep-14 15:27</b></td>
</tr>
<tr>
  <td align="right">Status:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>resolved</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Created:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>2011-May-17 17:18</b></td>
</tr>
<tr>
  <td align="right">Fixed&nbsp;Version:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>v070702&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Broken&nbsp;Version:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>v070600&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Priority:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>3&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Subsystem:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>Dag&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Assigned&nbsp;To:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>nwp&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Derived From:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>
<span class="ticket"><a href="tktview?tn=804" class="abandoned"
title="DAGMan should pass current JobPrio to children"
>#804</a></span>  </b></td>
</tr>
<tr>
  <td align="right">Creator:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>wenger&nbsp;</b></td>
<td></td>
  <td align="right">Rust:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Customer Group:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>chtc&nbsp;</b></td>
<td></td>
  <td align="right">Visibility:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>public&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Notify:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>wenger@cs.wisc.edu, psilord@cs.wisc.edu, matt@cs.wisc.edu, tstclair@redhat.com&nbsp;</b></td>
<td></td>
  <td align="right">Due Date:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>20110812&nbsp;</b></td>
</tr>
</table>
</blockquote>
<h3>Related Check-ins:</h3>
<table cellspacing=0 border=0 cellpadding=0>
<tr><td valign="top" width=160 align="right">2011-Oct-06 10:55</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=27664">[27664]</a></span>: edit of prose describing DAGMan node priority and its propagation ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Karen Miller )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Sep-14 15:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=27209">[27209]</a></span>: Merged <span class="chng"><a href="chngview?cn=26860">[26860]</a></span>, <span class="chng"><a href="chngview?cn=26861">[26861]</a></span>, <span class="chng"><a href="chngview?cn=26862">[26862]</a></span>, <span class="chng"><a href="chngview?cn=26863">[26863]</a></span>, <span class="chng"><a href="chngview?cn=26864">[26864]</a></span>, <span class="chng"><a href="chngview?cn=26865">[26865]</a></span>, <span class="chng"><a href="chngview?cn=26866">[26866]</a></span>, <span class="chng"><a href="chngview?cn=27108">[27108]</a></span>, <span class="chng"><a href="chngview?cn=27162">[27162]</a></span>, <span class="chng"><a href="chngview?cn=27168">[27168]</a></span>, Merge branch 'V7_7-propogate_dag_node_priorities_down_to_job_priorities-branch'&nbsp;[...]
 (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Sep-12 16:18</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=27168">[27168]</a></span>: Address the implications of the priority scheme ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span> Also, the last commit does not compile, as I did not remove an argument from a call site.  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Sep-12 14:45</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=27162">[27162]</a></span>: Write a comment to explain the priority scheme ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span> Also, remove an unused argument.  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Sep-06 22:31</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=27108">[27108]</a></span>: Comment on new members in DAG structures for priorities ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26866">[26866]</a></span>: Document how priorities are propogated to DAGman nodes ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span> ===VersionHistory===  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26863">[26863]</a></span>: Get the default priority in condor_dagman ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26864">[26864]</a></span>: Retrieve the default priority from the command line or configuration ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26865">[26865]</a></span>: Add tests for propogation of priorities ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26860">[26860]</a></span>: Add priority field to <span class="wiki"><a title="Submit Dag Deep Options"
class="missing"
  href="wiki?p=SubmitDagDeepOptions">SubmitDagDeepOptions</a></span> structure ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span> This new priority field is for communicating between condor_submit_dag and condor_dagman.  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26861">[26861]</a></span>: Add <span class="wiki"><a title="Fix Priority"
class="missing"
  href="wiki?p=FixPriority">FixPriority</a></span> method to Job class in DAGman ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Nathan W. Panike )</td></tr>
<tr><td valign="top" width=160 align="right">2011-Aug-18 14:24</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=26862">[26862]</a></span>: Iterate over the nodes of a DAG to set the priorities ===GT=== <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>  (By Nathan W. Panike )</td></tr>
</table>
<h3>Attachments:</h3>
<blockquote>
<ul>
<li><a href="attach_get/383/2167-patch">2167-patch</a>
8222 bytes added by nwp on 2011-Jun-21 18:36:10 UTC.
<br>
Patch for <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>.  This is simple---no heavy Math here.  The idea is that we want to keep parent nodes from starving child nodes or needlessly delaying them, so we propogate the child priorities up its parents' nodes, and then run the DAG with these priorities set.  We also have added arguments to condor_submit_dag to set priorities from the command line (still need to add config option).  I want to get this out and have some other eyeballs see it and minds decide if it is sane.<br>
<li><a href="attach_get/391/2167-patch-2">2167-patch-2</a>
12396 bytes added by nwp on 2011-Jul-02 02:16:47 UTC.
<br>
I think this is a better patch for <span class="ticket"><a href="tktview?tn=2167" class="resolved"
title="Propagate DAG node priorities down to job priorities"
>#2167</a></span>.  We do not now propogate the child priorities toward the parents, and do not do an inefficient recursion.  Now the DAG priorities are copied faithfully to the condor jobs, and to the subdags.  <br>
</ul>
</blockquote>
</div>
</div>
<div id="footer" style="text-align:right">
<p>
This work is supported by NSF under Cooperative Agreement OAC-2030508 as part of the <a href="https://path-cc.io/"> PATh Project</a>. Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the NSF. Site built using <a href="about">CVSTrac</a>.
</div>
</body></html>