<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="stylesheet" type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/cvstrac.10.css">
<link rel="stylesheet" type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/cvstrac.tj.css">
<link rel="stylesheet" type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/diff2html.css">
<link rel="alternate stylesheet"
      title="prosimii-screen"
      type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/prosimii-screen.css">
<link rel="alternate stylesheet"
      title="Default Stylesheet"
      type="text/css" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/cvstrac_default.css">
<link rel="alternate" type="application/rss+xml"
   title="HTCondorWiki Timeline Feed" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/timeline.rss">
<link rel="index" title="Index" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/index">
<link rel="search" title="Search" href="https://htcondor-wiki.cs.wisc.edu/index.cgi/search">
<link rel="help" title="Help"
   href="https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=CvstracDocumentation">
<title>HTCondorWiki: Ticket #3686</title>
<script type="text/javascript">
  function setFocus() {
    var firstForm, e;
    if ( document.forms && (firstForm = document.forms[0]) ) {
      if      ( (e = firstForm.elements["u"]) && e.type == "text" ) e.focus();
      else if ( (e = firstForm.elements["t"]) && e.type == "text" ) e.focus();
      else if ( (e = firstForm.elements["s"]) && e.type == "text" ) e.focus();
    }
  }
</script>
</head>
<body onload="setFocus()">
<div id="header">
<div class="midHeader">
<div class="iconHeader">
<a href="https://www.cs.wisc.edu/condor"><img src="https://research.cs.wisc.edu/htcondor/images/HTCondor_wiki_logo_small.png" alt="HTCondor High Throughput Computing" border=0></a>
</div>
</div>
</div><div id="header">
<h1 id="title">
Ticket #3686
</h1>
<p id="identity">
<a href="honeypot"><notatag arg="meaningless"></a>
<a href="login?nxp=/index.cgi/tktview%3Ftn%3D3686" title="Log in">Not logged in</a>
</p>
<ul id="navigation">
<li><a href="dir">Browse</a></li>
<li><a href="wiki?p=CvstracTicket">Help</a></li>
<li><a href="index">Home</a></li>
<li><a href="login">Login</a></li>
<li><a href="reportlist">Reports</a></li>
<li><a href="search?t=1">Search</a></li>
<li><a href="timeline">Timeline</a></li>
<li><a href="wiki">Wiki</a></li>
</ul>
<ul id="action">
<li><a href="tkthistory?tn=3686" rel="nofollow">History</a></li>
</ul>
</div>
<div id="content">
<h2>Ticket #3686: condor_off fails to find startds</h2>
<blockquote>
John Hover reports:

<p><div class="verbatim">
<PRE>
I'm to the point of wanting to programmatically retire startds on nodes on
EC2, and I'm running into trouble.

The wiki

 https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=HowToShutDownCondor

says to use
 condor_off -startd -peaceful &lt;hostname>

but,

[root@gridtest03 sysconfig]# condor_status
Name               OpSys      Arch   State     Activity LoadAv Mem ActvtyTime

ip-10-12-75-199    LINUX      X86_64 Claimed   Busy      1.000 3759 0+01:24:20
ip-10-196-219-15   LINUX      X86_64 Claimed   Busy      1.020 3759 0+01:09:33
slot1@ip-10-29-147 LINUX      X86_64 Claimed   Busy      0.910 2144 0+00:44:34
slot2@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.190 2144 0+01:09:38
slot3@ip-10-29-147 LINUX      X86_64 Claimed   Busy      0.370 2144 0+01:06:35
slot4@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.170 2144 0+00:56:01
slot5@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.080 2144 0+01:09:39
slot6@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.110 2144 0+00:44:29
slot7@ip-10-29-147 LINUX      X86_64 Claimed   Busy      1.170 2144 0+02:12:53

                     Total Owner Claimed Unclaimed Matched Preempting Backfill

        X86_64/LINUX     9     0       9         0       0          0        0

               Total     9     0       9         0       0          0        0
[root@gridtest03 sysconfig]# condor_off -startd -peaceful ip-10-12-75-199
Can't find address for startd
Perhaps you need to query another pool.

[root@gridtest03 sysconfig]# condor_off -startd -peaceful -name "ip-10-29-147-9"
Can't find address for startd
Perhaps you need to query another pool.

This seems to send a message:

[root@gridtest03 sysconfig]# condor_off -startd -peaceful
"slot4@ip-10-29-147-9"
Sent "Set-Peaceful-Shutdown" command to startd slot4@ip-10-29-147-9
Can't find address for master slot4@ip-10-29-147-9
Perhaps you need to query another pool.

But the node never enters "Retiring" state.

I'm on a schedd with the collector on another host, but all these command
behave the same there.

What am I doing wrong?
</PRE></div>


<p>and also

<p><div class="verbatim">
<PRE>
BTW, this worked before on this same setup. So something must have changed.
I'm just asking for guidance on how to troubleshoot it. I'm guessing it has
to do with looking up startd names in the multi-collector/shared-port/CCB
environment.

I was hoping to present on this Thursday (I'm at CERN). :-)
</PRE></div>


<p>To which I replied:

<p><div class="verbatim">
<PRE>
I can't help but noticing you never tried the FQDN.  I have all
sorts of trouble all the time with HTCondor seemingly being unable to look
up its own names for things; I don't what the deal is, but I've been having
trouble for years.

        Also, IIRC, the ip-* names are Amazon's internal DNS names; you may
have better luck using the job-ad attribute EC2RemoteVirtualMachineName,
which will be the public DNS names.
</PRE></div>


<p>To which he replied:

<p><div class="verbatim">
<PRE>
I have tried the public IP and public FQDN, with and without quotes. Same
answer on those.

This sounds like a real problem, especially if you have faced it too. Can
you escalate this to the appropriate people (Todd T., Dan Bradley, others?).
If I can get an answer then you will have one too.

It would be great to get something definitive today on something as basic as
referring to a startd by name.
</PRE></div>
</blockquote>

<table align="right" style="margin: 0 10px;" cellpadding=2 border=0>
<tr><td bgcolor="#a0b5f4" class="border1">
<table width="100%" border=0 cellpadding=4 cellspacing=0>
<tr bgcolor="#d0d9f4" class="bkgnd1">
<td valign="top" align="left">
[<a href="tktappend?tn=3686">Append remarks</a>]
</td></tr></table></td></tr></table>
<h3>Remarks:</h3>
<blockquote>
<em>2013-Jun-10 11:32:17 by tlmiller:</em> <br>

Next step: confirm that the appropriate ad(s) exist in the primary collector.

<p><hr>
<em>2013-Jun-10 14:01:33 by tlmiller:</em> <br>

The attached master_condor_status.xml file was generated by:

<p><div class="verbatim">
<PRE>
condor_status -master -xml
</PRE></div>


<p>and the other two *.xml files probably by

<p><div class="verbatim">
<PRE>
condor_status -xml
</PRE></div>


<p>The attached *.txt files were generated by:

<p><div class="verbatim">
<PRE>
OK, attached is the output of...

 condor_status -any -l

from both the schedd (gridtest03.racf.bnl.gov) and the collector host
(gridui09.usatlas.bnl.gov).
</PRE></div>


<p><hr>
<em>2013-Jun-10 14:05:29 by tlmiller:</em> <br>

The master ads are present and (at least at first glance) appear to be sane, so the problem is probably elsewhere, which means it's time to look at what condor_off is doing.  I've also asked John what might have changed, since this used to work...

<p><hr>
<em>2013-Jun-12 10:08:41 by zmiller:</em> <br>

After further testing and looking at the code, it turns out that:

<p><div class="code">
<pre class="code">condor_off -peaceful -startd REMOTENODE</pre></div>


<p>has always been broken since it was introduced in 2006.  It should be noted that it works fine locally.  I am changing this ticket from &quot;incident&quot; to &quot;defect&quot;.  John has a workaround for now, which is to ssh to the execute node and run the command there (since it works fine locally).  This is kludgy and there's no guarantee of ssh access in general, so this definitely needs to be fixed.

<p>Proposed fix is to not have the tool be responsible for sending the &quot;Set-Peaceful-Shutdown&quot; message to any startds (or schedds or other daemons for that matter) and instead have the master do it before it sends the TERM signal.

<p><hr>
<em>2013-Jun-12 10:37:48 by danb:</em> <br>

DC_OFF_PEACEFUL is currently registered as an ADMINISTRATOR level command.  If it works locally, then does this mean local administrator operations are allowed?  Can jobs send administrative commands to condor??

<p>Anyway, the reason I had the tool send the DC_OFF_PEACEFUL command instead of having the master do it is that the master is not necessarily authorized to send administrative commands to its children and I didn't think we had another signal available for the purpose.  I agree that it would be good to solve the authorization problem so the master can send the command.  Now that we pass a security session down to the child, this could be a simple matter of registering the command for DAEMON level access.  Then the master should be authorized.

<p>I am surprised though that the existing implementation never worked.  What is broken?  I think I have used it in the past successfully.

<p><hr>
<em>2013-Jun-12 10:53:48 by zmiller:</em> <br>

Maybe it works if the name of the startd and master are: 1) identical, and 2) the fully qualified hostname.  It definitely does not work if they are different (which name are you specifying on the command line, the master or the startd?) or if the advertised name is different than the hostname (in John's case) or if you set STARTD_NAME and/or MASTER_NAME (how i tested).

<p><hr>
<em>2014-Feb-07 14:16:34 by jfrey:</em> <br>

What's going on with this ticket? Zach committed some changes for 8.1.0, but the ticket is still active and marked for 8.1.4. Someone on condor-users noticed a bug. When giving multiple names, names beyond the 7th or 8th or following an invalid name aren't found in the list of ads. I'm attaching a patch.</blockquote>
<table align="right" style="margin: 0 10px;" cellpadding=2 border=0>
<tr><td bgcolor="#a0b5f4" class="border1">
<table width="100%" border=0 cellpadding=4 cellspacing=0>
<tr bgcolor="#d0d9f4" class="bkgnd1">
<td valign="top" align="left">
[<a href="tktappend?tn=3686">Append remarks</a>]
</td></tr></table></td></tr></table>


<h3>Properties:</h3>

<blockquote>
<table>
<tr>
  <td align="right">Type:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>defect&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Last&nbsp;Change:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>2014-Feb-10 16:29</b></td>
</tr>
<tr>
  <td align="right">Status:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>resolved</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Created:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>2013-Jun-10 11:02</b></td>
</tr>
<tr>
  <td align="right">Fixed&nbsp;Version:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>v080100&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Broken&nbsp;Version:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>v080000&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Priority:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>1&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Subsystem:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>Tools&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Assigned&nbsp;To:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>zmiller&nbsp;</b></td>
<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
  <td align="right">Derived From:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>
  &nbsp;
  </b></td>
</tr>
<tr>
  <td align="right">Creator:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>tlmiller&nbsp;</b></td>
<td></td>
  <td align="right">Rust:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Customer Group:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>other&nbsp;</b></td>
<td></td>
  <td align="right">Visibility:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>public&nbsp;</b></td>
</tr>
<tr>
  <td align="right">Notify:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>tannenba@cs.wisc.edu, danb@cs.wisc.edu, jhover@bnl.gov, tlmiller@cs.wisc.edu,jfrey@cs.wisc.edu&nbsp;</b></td>
<td></td>
  <td align="right">Due Date:</td>
  <td bgcolor="#d0d0d0" class="bkgnd3"><b>&nbsp;</b></td>
</tr>
</table>
</blockquote>
<h3>Derived Tickets:</h3>
<table cellspacing=0 border=0 cellpadding=0>
<tr><td valign="top" width=160 align="right">
<span class="ticket"><a href="tktview?tn=4207" class="resolved"
title="Giving multiple names to The Tool can lead to incorrect failures"
>#4207</a></span></td>
<td valign="center" width=30 align="center">
<span class="icon ptr1">&nbsp;</span></td>
<td valign="top" align="left">
Giving multiple names to The Tool can lead to incorrect failures</td></tr>
</table>
<h3>Related Check-ins:</h3>
<table cellspacing=0 border=0 cellpadding=0>
<tr><td valign="top" width=160 align="right">2013-Aug-19 20:51</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=37283">[37283]</a></span>: Fix the resolution of &quot;names&quot; given to &quot;the tool&quot; when they aren't actual hostnames. <span class="ticket"><a href="tktview?tn=3686" class="resolved"
title="condor_off fails to find startds"
>#3686</a></span>  (By Zach Miller )</td></tr>
<tr><td valign="top" width=160 align="right">2013-Jul-17 11:37</td>
<td valign="top" width=30 align="center">
<span class="icon dot">&nbsp;</span></td>
<td valign="top" align="left"> 
Check-in <span class="chng"><a href="chngview?cn=36936">[36936]</a></span>: Changes to condor_off (and other tools) to make it more tolerant of differing Name vs. Machine. <span class="ticket"><a href="tktview?tn=3686" class="resolved"
title="condor_off fails to find startds"
>#3686</a></span>  (By Zach Miller )</td></tr>
</table>
<h3>Attachments:</h3>
<blockquote>
<ul>
<li><a href="attach_get/747/schedd_condor_status.xml">schedd_condor_status.xml</a>
16380 bytes added by tlmiller on 2013-Jun-10 18:30:36 UTC.
<li><a href="attach_get/748/master_condor_status.xml">master_condor_status.xml</a>
10824 bytes added by tlmiller on 2013-Jun-10 18:30:44 UTC.
<li><a href="attach_get/749/collector_condor_status.xml">collector_condor_status.xml</a>
16381 bytes added by tlmiller on 2013-Jun-10 18:30:52 UTC.
<li><a href="attach_get/750/schedd-status-any.txt">schedd-status-any.txt</a>
46205 bytes added by tlmiller on 2013-Jun-10 18:59:22 UTC.
<li><a href="attach_get/751/collector-status-any.txt">collector-status-any.txt</a>
46210 bytes added by tlmiller on 2013-Jun-10 18:59:29 UTC.
<li><a href="attach_get/771/gt3686_ShutdownDesignDoc_v2.doc">gt3686_ShutdownDesignDoc_v2.doc</a>
29696 bytes added by tannenba on 2013-Jun-28 19:29:16 UTC.
<br>
Design Document for gt <span class="ticket"><a href="tktview?tn=3686" class="resolved"
title="condor_off fails to find startds"
>#3686</a></span> version 2<br>
<li><a href="attach_get/822/tool.patch">tool.patch</a>
867 bytes added by jfrey on 2014-Feb-07 20:17:31 UTC.
<br>
Fix bug when providing multiple names of daemons to affect with The Tool.<br>
</ul>
</blockquote>
</div>
</div>
<div id="footer" style="text-align:right">
<p>
This work is supported by NSF under Cooperative Agreement OAC-2030508 as part of the <a href="https://path-cc.io/"> PATh Project</a>. Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the NSF. Site built using <a href="about">CVSTrac</a>.
</div>
</body></html>