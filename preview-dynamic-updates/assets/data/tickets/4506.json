{"id": 4506, "title": "Ticket #4506: condor_master crashes if LOCAL_CONFIG_DIR has unreadable files", "description": "<blockquote>\nIf one has LOCAL_CONFIG_DIR set and creates a new file in that directory with ownership of root, group ownership of root, and mode 0600, then the condor_master will crash upon execution of condor_reconfig.\n\n<p>On a full restart, you see something like this in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MasterLog\" title=\"Master Log\">MasterLog</a></span>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/21/14 18:23:55 Using config source: /etc/condor/condor_config\n07/21/14 18:23:55 Using local config sources:\n07/21/14 18:23:55    /etc/condor/config.d/facter\n07/21/14 18:23:55    /etc/condor/condor_config.local\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Sep-22 15:50:26 by gthain:</em> <br/>\n\nProposed solution -- condor_reconfig should not send the reconfig if the config files aren't readable.\n\n<p></p><hr/>\n<em>2015-Sep-22 15:51:20 by tpdownes:</em> <br/>\n\nConsider addition of \"parsing test\" in addition to file permission testing.\n\n<p></p><hr/>\n<em>2015-Sep-23 16:06:26 by tannenba:</em> <br/>\n\nOSG also reported the same issue in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5254\" onclick=\"get_ticket_and_populate_wrapper('5254'); return false;\" title=\"bad permissions on config files cause master to kill itself on reconfi\">#5254</a></span>.  Here is the wisdom from that ticket:\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nIf /etc/condor/config.d contains a configuration file that is not\nreadable by the condor user, then the master starts up normally, but a\nreconfig will cause it to exit without a log message or killing its\ndaemons.\n\nLooks like the master is acting as root when it reads the config files\non initial startup, but is acting as the condor user when doing a\nreconfig.  This inconsistency can keep admins from discovering the error\nin their config files in the first place.\n\nThe master prints the error message to stderr instead of logging it, and\nexits without shutting down any of its children.  These should probably\nboth be fixed.\n\nThe logging is most important to me, though I think that from an admin's\npoint of view, the ideal behavior is that if a reconfig fails due to\nbroken files (or any other reason), that Condor should keep running with\nthe old config.  I have no idea how feasible that is with the Condor\ncodebase.\n</td></tr></tbody></table></div>\n\n\n<p>Given this is an issue for both OSG and LIGO, I'd like to target it for early in the v8.4 series.\n\n</p><p></p><hr/>\n<em>2015-Sep-23 16:17:42 by tpdownes:</em> <br/>\n\nSo prioritize it as a 2?\n\n<p></p><hr/>\n<em>2015-Sep-23 16:48:18 by tannenba:</em> <br/>\n\nHi Tom, you can keep the priority at whatever makes sense for LIGO.  I already edited the target fixed version field in the ticket.\n\n<p></p><hr/>\n<em>2015-Sep-23 16:53:08 by johnkn:</em> <br/>\n\nKeeping in mind that the config files have to parse as valid in order for condor_reconfig to actually send any messages to any daemons,  I think we can reasonably assume that this problem is always permissions.  (That is unless there are people changing config files and then rebooting the machines, etc).\n\n<p>So The quick-and-dirty solution is to have condor_reconfig check to see that all of the config files that IT reads are group &amp; world readable before sending the reconfig message.\n\n</p><p>The better solution would be to change the behavior of the master on reconfig so that it first parses the new config files, and only if they are valid does it actually reconfigure and send the reconfig message on to its children\n\n</p><p></p><hr/>\n<em>2015-Sep-23 17:29:03 by johnkn:</em> <br/>\n\nI propose that if condor_reconfig is running as root, it should change it's uid to condor and then do an access check on each of the config files.  if any fail the access check it will print out an error message and then exit without sending the reconfig.\n\n<p></p><hr/>\n<em>2015-Oct-06 16:06:48 by johnkn:</em> <br/>\n\nI have a patch that changes condor_reconfig/on/off/restart to check to see if the config files are readable by the condor user if the tool is run as root. If any of the files are not readable by condor, it will print:\n\n<p></p><pre>    ERROR: The following configuration files cannot be read by user 'condor'. Aborting command\n    /scratch/rootly/condor841/local.localhost/config/00stuff\n</pre>\n\n<p></p><hr/>\n<em>2015-Oct-20 13:06:40 by adesmet:</em> <br/>\n\n<strong>Code Review:</strong> Approved.\n\n<p>Should generate a few new tickets for:\n</p><ul>\n<li>Daemons should be able to re-read their config files, but back up to old configuration on an error. (The only way to know you're looking at all of the configuration files is to read them, since any given file might add some more.)\n</li><li>Various tools, especially reconfig, restart, and off, should block until the daemon replies \"Yes!\" If not yes, should return something useful (\"Unable to re-read configuration.\" \"Permission denied.\")</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-23 12:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4b9392a9e24a8655cda244b6db290e283983f51c\">[46082]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=VersionHistory\" title=\"Version History\">VersionHistory</a></span> for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4506\" onclick=\"get_ticket_and_populate_wrapper('4506'); return false;\" title=\"condor_master crashes if LOCAL_CONFIG_DIR has unreadable files\">#4506</a></span>, also ignore piped command and failures other than EACCES when checking for access  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-07 08:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/51d372636ff78cc91084e41c25ac22993de6450f\">[45957]</a></span>: for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4506\" onclick=\"get_ticket_and_populate_wrapper('4506'); return false;\" title=\"condor_master crashes if LOCAL_CONFIG_DIR has unreadable files\">#4506</a></span>, add code to condor_on/off/restart/reconfig to check to see if config files are readable by the 'condor' user before sending the command when the command is invoked by root user. (actually when can_switch_ids() is true). This is intended to help detect the situation when an admin running as\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Oct-26 12:09", "status": "defer", "created": "2014-Aug-01 11:33", "fixed_version": "2014-Aug-01 11:33", "broken_version": "v080200", "priority": "5", "subsystem": "DaemonMaster", "assigned_to": "johnkn", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "downes@uwm.edu matyas@cs.wisc.edu cat@cs.wisc.edu tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}