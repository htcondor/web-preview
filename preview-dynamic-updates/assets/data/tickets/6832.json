{"id": 6832, "title": "Ticket #6832: Small bugs in curl_plugin", "description": "<blockquote>\nI came across some small bugs in curl_plugin while generating data for load-balanced HTTP file transfer. These don't have any serious impact on users but we should fix them. I'll let this sit for a while in case I find any other problems in the next few weeks.\n\n<p></p><ul>\n<li>When a HTTP transfer fails and is retried, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ConnectionTimeSeconds\" title=\"Connection Time Seconds\">ConnectionTimeSeconds</a></span> only reports the duration of the last connection. This should instead should the cumulative duration of all connections.\n\n<p></p></li><li>In some cases, file transfers fail and go on hold with the following error: \"FILETRANSFER:1:non-zero exit (4608) from /usr/libexec/condor/curl_plugin. Error: transfer closed with 5149571386 bytes remaining to read\". When this happens the retry mechanism should kick in and just try the transfer again.\n\n<p></p></li><li>Error reporting is generally not very good. We don't do a great job of distinguishing between transient and non-transient errors. Some failures result in generic non-descriptive messages showing up in the hold message. This generally needs to be overhauled and improved.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Jan-10 16:57:40 by bbockelm:</em> <br/>\n\nTry this:\n\n<p></p><div class=\"verbatim\">\n<pre>--- a/src/condor_filetransfer_plugins/curl_plugin.cpp\n+++ b/src/condor_filetransfer_plugins/curl_plugin.cpp\n@@ -46,7 +46,8 @@ main( int argc, char **argv ) {\n         diagnostic = 1;\n     }\n     else if(argc != 3) {\n-        return -1;\n+        printf(\"Usage: %s SOURCE DEST\\n\", argv[0]);\n+        return 1;\n     }\n\n     // Initialize win32 + SSL socket libraries.\n@@ -237,7 +238,14 @@ send_curl_request( char** argv, int diagnostic, CURL* handle, FileTransferStats*\n                 stats-&gt;TransferSuccess = false;\n                 stats-&gt;TransferError = error_buffer;\n                 // If we got an HTTP error code, need to change a couple more things\n-                if( return_code &gt; 400 ) {\n+                if( rval != CURLE_OK ) {\n+                    const char * curl_err = curl_easy_strerror( ( CURLcode ) rval );\n+                    if (curl_err) {\n+                        stats-&gt;TransferError = \"Client library encountered an error: \" + std::string(curl_err);\n+                    } else {\n+                        stats-&gt;TransferError = \"Client library encountered an unknown error.\";\n+                    }\n+                } else if( return_code &gt; 400 ) {\n                     rval = CURLE_HTTP_RETURNED_ERROR;\n                     stats-&gt;TransferError = \"Server returned HTTP error code \" + std::to_string((long long int)return_code);\n                 }\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Jan-10 17:03:49 by coatsworth:</em> <br/>\n\nThanks Brian! Just checked this in.\n\n<p></p><hr/>\n<em>2019-Apr-19 14:31:53 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good\n\n<p></p><hr/>\n<em>2019-May-10 14:40:43 by coatsworth:</em> <br/>\n\nI've got a couple tiny curl_plugin bugs that aren't big enough for a new ticket (4 diffs total). I'm going to append them here.\n\n<p></p><hr/>\n<em>2019-May-17 10:53:43 by tim:</em> <br/>\n\nNot really a user visible change. No version history needed.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-07 16:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a51ee99851c80110c6d1b9d9c7de41475fa026ba\">[58930]</a></span>: Fixed type in variable name (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6832\" onclick=\"get_ticket_and_populate_wrapper('6832'); return false;\" title=\"Small bugs in curl_plugin\">#6832</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-07 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b5c89e00658fc1f8952b870b3ae4183a354145c2\">[58929]</a></span>: Added null check abort on <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HeaderCallback\" title=\"Header Callback\">HeaderCallback</a></span> file transfer stats (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6832\" onclick=\"get_ticket_and_populate_wrapper('6832'); return false;\" title=\"Small bugs in curl_plugin\">#6832</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-10 14:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54888a3d8ed0c82ca8a50caa839ec9655e32ef67\">[56854]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5f23e340a1c1fb55cf39c579ac5ced896b6eda6e\">[56852]</a></span>, Merging minor curl_plugin fixes (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6832\" onclick=\"get_ticket_and_populate_wrapper('6832'); return false;\" title=\"Small bugs in curl_plugin\">#6832</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-10 14:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/467396e9c87d722ba714af2ec38d1da73244c769\">[56853]</a></span>: Fixed tiny curl_plugin bugs with libcurl error codes (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6832\" onclick=\"get_ticket_and_populate_wrapper('6832'); return false;\" title=\"Small bugs in curl_plugin\">#6832</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-19 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c7efa11bd16ebb769427f67f93fcbfafcda7504c\">[56668]</a></span>: Patched handling of error messages in curl_plugin (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6832\" onclick=\"get_ticket_and_populate_wrapper('6832'); return false;\" title=\"Small bugs in curl_plugin\">#6832</a></span>) Committer: Tim Theisen  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-10 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/75a1865089b8b8c931598a01d31c7f7c75cbc486\">[55973]</a></span>: Patched handling of error messages in curl_plugin (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6832\" onclick=\"get_ticket_and_populate_wrapper('6832'); return false;\" title=\"Small bugs in curl_plugin\">#6832</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-May-17 10:53", "status": "resolved", "created": "2018-Nov-26 17:15", "fixed_version": "2018-Nov-26 17:15", "broken_version": "v080800", "priority": "4", "subsystem": "FileTransfer", "assigned_to": "coatsworth", "derived_from": "", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu", "due_date": ""}