{"id": 4157, "title": "Ticket #4157: Daemons on Mac OS X busy-loop accepting bogus connections", "description": "<blockquote>\nOn the BaTLab macs, we observed large numbers of Condor daemons in a tight loop printing this:\n<div class=\"code\">\n<pre class=\"code\">DaemonCommandProtocol: TCP connection to  failed.\n</pre></div>\n\n\n<p>This was caused by setting TCP_KEEPALIVE and friends on listening sockets (part of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>). On OS X, once the modified keepalive interval elapses, the listen socket becomes closed. select() will then always say the fd is ready for reading, but calls to accept() will fail.\n\n</p><p>The fix is to never set the keepalive socket options on a socket that will be used for listening.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jan-16 12:25:22 by jfrey:</em> <br/>\n\nSince this bug never appeared in a release, there's no version history item.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-17 10:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8ab3a11c543d8057a05d85495429f6b72bdac537\">[39186]</a></span>: Revert \"Disable almost all tests on Darwin temporarily. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4157\" onclick=\"get_ticket_and_populate_wrapper('4157'); return false;\" title=\"Daemons on Mac OS X busy-loop accepting bogus connections\">#4157</a></span>\" This reverts commit fcfed444a4a7bfd89e826012f8efdd13c089a802. The tests should no longer break the macs.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-16 12:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/21641e2b51f18b7726705009103b76108ea6d730\">[39177]</a></span>: Don't set TCP_KEEPALIVE and friends on listening sockets. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4157\" onclick=\"get_ticket_and_populate_wrapper('4157'); return false;\" title=\"Daemons on Mac OS X busy-loop accepting bogus connections\">#4157</a></span> On OS X, if you set TCP_KEEPALIVE and friends on a listening socket, the socket will close after the modified keepalive interval. It will always show up ready for reading, but accept() will fail. This will send daemons into an endless loop\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-14 15:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fcfed444a4a7bfd89e826012f8efdd13c089a802\">[39154]</a></span>: Disable almost all tests on Darwin temporarily. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4157\" onclick=\"get_ticket_and_populate_wrapper('4157'); return false;\" title=\"Daemons on Mac OS X busy-loop accepting bogus connections\">#4157</a></span> There's a new bug on master that causes daemons to constantly try to accept bogus connections, chewing up as much cpu as possible. When enough daemons are hit by this in a test suite run, it can bring down the machine. Disable all but one test until\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jan-17 15:31", "status": "resolved", "created": "2014-Jan-14 15:22", "fixed_version": "2014-Jan-14 15:22", "broken_version": "v080104", "priority": "1", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "#4122", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "", "due_date": ""}