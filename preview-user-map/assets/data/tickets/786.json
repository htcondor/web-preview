{"id": 786, "title": "Ticket #786: VOMS static initializer allocates memory even when VOMS not used", "description": "<blockquote>\nThere's a static initializer in the VOMS code which allocate ~60k of memory in every condor process.  This is especially important in the shadow:\n<div class=\"code\">\n<pre class=\"code\">==8095== 51,036 bytes in 2,086 blocks are still reachable in loss record 20 of 21\n==8095==    at 0x4A05809: malloc (vg_replace_malloc.c:149)\n==8095==    by 0x684441: CRYPTO_malloc (in /scratch/gthain/condor73/src/release_dir/libexec/power_state)\n==8095==    by 0x6A4341: lh_new (in /scratch/gthain/condor73/src/release_dir/libexec/power_state)\n==8095==    by 0x687E47: OBJ_add_object (in /scratch/gthain/condor73/src/release_dir/libexec/power_state)\n==8095==    by 0x687F54: OBJ_create (in /scratch/gthain/condor73/src/release_dir/libexec/power_state)\n==8095==    by 0x630B48: vomsdata::Initializer::Initializer() (voms_api.cc:162)\n==8095==    by 0x7311C5: (within /scratch/gthain/condor73/src/release_dir/libexec/power_state)\n==8095==    by 0x4B57BA: (within /scratch/gthain/condor73/src/release_dir/libexec/power_state)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2009-Sep-29 23:51:42 by jfrey:</em> <br/>\n\nI have a patch to the VOMS external to changes the static initializer to instead be invoked that first time a vomsdata object is created. I've confirmed that it eliminates the extra heap overhead when GSI is not used and a proxy's VOMS extensions are still read properly.\n\n<p></p><hr/>\n<em>2009-Sep-30 11:06:34 by jfrey:</em> <br/>\n\nModified VOMS external pushed to V7_4-branch.\n\n<p></p><hr/>\n<em>2009-Dec-04 15:59:16 by jfrey:</em> <br/>\n\nThe fix for this problem caused GSI authentication to fail in CEDAR (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=992\" onclick=\"get_ticket_and_populate_wrapper('992'); return false;\" title=\"problems with GSI in 7.4.0\">#992</a></span>). A better fix has been made for 7.4.1 (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1019\" onclick=\"get_ticket_and_populate_wrapper('1019'); return false;\" title=\"ssl and voms interaction breaks some uses of GSI authentication\">#1019</a></span>).</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/103/initializer.patch\">initializer.patch</a>\n1145 bytes added by jfrey on 2009-Sep-30 04:52:23 UTC.\n<br/>\nPatch to eliminate static initializer.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-03 14:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a7740a14ba8923db1d25e46b1ec13c5be3ac3523\">[16480]</a></span>: Change VOMS external to version 1.8.8_2. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1019\" onclick=\"get_ticket_and_populate_wrapper('1019'); return false;\" title=\"ssl and voms interaction breaks some uses of GSI authentication\">#1019</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=992\" onclick=\"get_ticket_and_populate_wrapper('992'); return false;\" title=\"problems with GSI in 7.4.0\">#992</a></span> This is the version used by the VDT. This version doesn't have the memory bloat that <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span> attempted to fix. It also doesn't have the GSI authentication problem introduced by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span>, which is detailed in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=992\" onclick=\"get_ticket_and_populate_wrapper('992'); return false;\" title=\"problems with GSI in 7.4.0\">#992</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-30 10:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f2f9cae44d7d687d6b9f3440c1589a3f0d066dea\">[15796]</a></span>: Remove VOMS static initializer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span> The initializer is now called when a vomsdata object is first instantiated.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-04 15:59", "status": "resolved", "created": "2009-Sep-28 17:17", "fixed_version": "2009-Sep-28 17:17", "broken_version": "v070302", "priority": "2", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "#787", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu", "due_date": ""}