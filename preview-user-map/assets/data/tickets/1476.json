{"id": 1476, "title": "Ticket #1476: DAGMan leaves node jobs running when held/dag file removed/released", "description": "<blockquote>\n<div class=\"verbatim\">\n<pre>  Steps to Reproduce:\n  ===================\n  * Submit a dagman job, wait for it to queue up and start to run.\n  * Suspend the dagman parent process (condor_hold)\n  * Delete the submission.dag file\n  * Resume the dagman parent process (condor_release)\n</pre></div>\n\n\n<p>At this point, the actual DAGMan job is gone from the queue, but any node jobs submitted before the hold are still running...\n\n</p><p>We should remove all of the node jobs in this case (at least by default -- maybe have a config knob for whether to remove them?).</p></blockquote>", "remarks": "<blockquote>\nI tested the fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span> in this case, and it doesn't fix this problem (see also ticket <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=1910\" onclick=\"get_ticket_and_populate_wrapper('1910'); return false;\" title=\"Error case in the fix for #1490\">#1910</a></span>).\n\n<p></p><hr/>\n<em>2011-May-26 13:07:13 by wenger:</em> <br/>\n\nI finally got a chance to look at this.  I don't see any real problems.  The only thing I'd change is to make a small method in the Dag class (like Dag::RemoveAllCondorJobs() or something) to avoid having duplicate code in Dag::RemoveRunningJobs() and main_init().  Oh, yeah -- it would be great to make a test for this...\n\n<p></p><hr/>\n<em>2011-May-26 13:08:33 by wenger:</em> <br/>\n\nAlso, I don't see any need for a knob to allow the user to control this behavior -- when DAGMan is removed, all of its jobs should be removed.\n\n<p></p><hr/>\n<em>2011-May-31 14:56:29 by tstclair:</em> <br/>\n\nWhy wouldn't you just call RemoveRunningJobs()?   Am I missing something?\n\n<p></p><hr/>\n<em>2011-May-31 15:52:34 by wenger:</em> <br/>\n\nIf you just call RemoveRunningJobs(), it won't remove any jobs in this case, because if the DAG file is gone, DAGMan won't think there are any Condor jobs in the DAG.  So we need a subset of RemoveRunningJobs() that doesn't have the logic that decides whether there are any Condor jobs in the DAG.\n\n<p></p><hr/>\n<em>2011-Jun-08 13:40:11 by wenger:</em> <br/>\n\nI took at look at this just after Tim C committed it -- looks okay...</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/326/dagparse.patch\">dagparse.patch</a>\n1265 bytes added by jrt on 2011-Apr-18 21:55:06 UTC.\n<br/>\nCondor_dagman bails because it can't find the dag file. Without the dag file, it can't perform a recovery which is how a release is handled. Here's a patch that checks for a lock file when the dag file is not found. If there is a lock file, a condor_rm is done on the DAGManJobId._cluster followed by a cleanup and exit.\n\n<p>I didn't put in a knob to toggle behavior, but that could be added. I'm not sure letting the jobs complete has benefits or is practical. <br/>\n</p></li><li><a href=\"../files/366/dagparse2.patch\">dagparse2.patch</a>\n2346 bytes added by tstclair on 2011-Jun-02 21:14:06 UTC.\n<br/>\nupdated patch for review.  switch to call <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoveRunning\" title=\"Remove Running\">RemoveRunning</a></span> with a optional param to force removal.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-08 13:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/87561aeefb2d424aa1f4f6cce714ede67a2bee58\">[22134]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1476\" onclick=\"get_ticket_and_populate_wrapper('1476'); return false;\" title=\"DAGMan leaves node jobs running when held/dag file removed/released\">#1476</a></span> === Fixed: DAGMan leaves node jobs running when held/dag file removed/released  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jun-08 13:40", "status": "resolved", "created": "2010-Jun-29 13:46", "fixed_version": "2010-Jun-29 13:46", "broken_version": "v070402", "priority": "4", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu, psilord@cs.wisc.edu, matt@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}