{"id": 3072, "title": "Ticket #3072: JobRouter should forcex jobs that can't be removed", "description": "<blockquote>\nI found a case where the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> couldn't remove an orphaned jobs.  The source job got removed by the user, cleaning up the spool directory.\n\n<p>When restarting the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span>, it correctly identified the destination job as from the source job.  It tried to remove the destination job (grid universe, batch gahp).\n\n</p><p>The schedd passed the remove signal to the gridmanager; when the constructor of the infnbatch job fired, it failed to acquire the proxy, placing the job immediately on hold.\n\n</p><p>Every <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> poll interval, this occurs.\n\n</p><p>Minimal solution: if \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatusOnRelease\" title=\"Job Status On Release\">JobStatusOnRelease</a></span> = 3\" in the job's classad, forcibly remove it.\n\n</p><p>Thorough solution: when removing the job, set an attribute (\"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OrphanRemovedByRouter\" title=\"Orphan Removed By Router\">OrphanRemovedByRouter</a></span> = TRUE\").  If that is set on an orphan job, forcibly remove it.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Jun-21 09:41:12 by danb:</em> <br/>\n\nForcibly removing the orphan job may still leave behind an orphan in the \"remote\" batch system.  Is there a lease or something that will eventually take care of that?\n\n<p></p><hr/>\n<em>2012-Jun-21 09:44:51 by jfrey:</em> <br/>\n\nThere's no mechanism for a lease with the blahp, as most batch systems it submits into don't support leases.\n\n<p></p><hr/>\n<em>2012-Jun-21 09:55:41 by bbockelm:</em> <br/>\n\nHi Dan,\n\n<p>That's why my suggested solution is to only forcex after it has attempted to remove it once.\n\n</p><p>I guess the safer alternate would be to ignore jobs it has already attempted to remove?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Nov-26 11:19:35 by jfrey:</em> <br/>\n\nI've changed the gridmanager so that grid-type batch jobs can be removed after the job sandbox has been removed. There are some deeper issues with sandbox management between the job router and gridmanager, but that is beyond the scope of this ticket.\n\n<p></p><hr/>\n<em>2014-Dec-01 09:26:06 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good, I approve this change.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-26 11:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/563707f72f10a2d1c457a4259c79cfc36c6968c6\">[41769]</a></span>: Docs for removing grid-type batch jobs after proxy deletion. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3072\" onclick=\"get_ticket_and_populate_wrapper('3072'); return false;\" title=\"JobRouter should forcex jobs that can't be removed\">#3072</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-25 11:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c11bfb364611d4ac5552708f8e2c0d3144a9062b\">[41766]</a></span>: Ignore missing proxy when removing grid-type batch jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3072\" onclick=\"get_ticket_and_populate_wrapper('3072'); return false;\" title=\"JobRouter should forcex jobs that can't be removed\">#3072</a></span> In the HTCondor-CE, we can have a grid job's sandbox disappear before the gridmanager picks up the job for removal. The gridmanager immeidately puts the job on hold because it can't read the proxy. But we don't need the proxy to remove the\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Dec-01 09:26", "status": "resolved", "created": "2012-Jun-20 17:31", "fixed_version": "2012-Jun-20 17:31", "broken_version": "", "priority": "1", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "#4555", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu, jfrey@cs.wisc.edu, marian.zvada@cern.ch", "due_date": ""}