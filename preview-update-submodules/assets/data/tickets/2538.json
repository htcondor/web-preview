{"id": 2538, "title": "Ticket #2538: IPv6 \tx86_64_deb_6.0-updated master can't start collector", "description": "<blockquote>\nIPv6 branch.\n\n<p>Collector fails with:\n</p><div class=\"code\">\n<pre class=\"code\">10/10/11 17:00:38 ERROR \"Daemoncore: Can only inherit SafeSock or ReliSocks, not 9 (57)\" at line 9103 in file /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core.cpp\n</pre></div>\n\n\n<p>Problem: CONDOR_INHERIT environment variable is wrong.  The parent's sinful string is missing. FD 9 passed in to condor_getsockname. getsockname filled out the structure with a valid looking sockaddr_in:\n</p><ul>\n<li>sin_family = 2\n</li><li>sin_port = 28614\n</li><li><strong>sin_addr = {s_addr = 0}</strong>\n</li><li>sin_zero = \"\\000\\000\\000\\000\\000\\000\\000\"\n</li></ul>\n\n<p>Note the sin_addr.s_addr of 0. Very, very wrong.\n\n</p><p>Could be result of binding to INADDR_ANY. Why fail on this\nplatform only?\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#0  condor_getsockname (sockfd=&lt;value optimized out&gt;, addr=...)\n    at /home/condor/execute/dir_13396/userdir/src/condor_utils/condor_sockfunc_ex.cpp:22\n#1  0x000000000051cb5e in condor_getsockname_ex (sockfd=9, addr=...)\n    at /home/condor/execute/dir_13396/userdir/src/condor_utils/condor_sockfunc.cpp:159\n#2  0x00000000004ae972 in Sock::get_sinful (this=0x808b10)\n    at /home/condor/execute/dir_13396/userdir/src/condor_io/sock.cpp:1990\n#3  0x00000000004ba288 in Sock::get_sinful_public (this=0x808b10)\n    at /home/condor/execute/dir_13396/userdir/src/condor_io/cedar_no_ckpt.cpp:938\n#4  0x000000000047f495 in DaemonCore::InfoCommandSinfulStringMyself (this=0x7fc660, usePrivateAddress=false)\n    at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core.cpp:1115\n#5  0x00000000004934aa in DaemonCore::InitDCCommandSocket (this=0x7fc660, command_port=-1)\n    at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core.cpp:9286\n#6  0x0000000000477576 in main (argc=1, argv=&lt;value optimized out&gt;)\n    at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core_main.cpp:2175\n</pre></div>\n\n\n<p>We are binding to INADDR_ANY.  Given the following stack trace, addr.v4 is {sin_family = 2, sin_port = 0, sin_addr = {s_addr = 0}, sin_zero = \"\\000\\000\\000\\000\\000\\000\\000\"}.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#0  condor_bind (sockfd=9, addr=...) at /home/condor/execute/dir_13396/userdir/src/condor_utils/condor_sockfunc.cpp:38\n#1  0x00000000004b07e4 in Sock::_bind_helper (this=0x808b10, outbound=false, port=&lt;value optimized out&gt;, loopback=false)\n    at /home/condor/execute/dir_13396/userdir/src/condor_io/sock.cpp:2280\n#2  Sock::bind (this=0x808b10, outbound=false, port=&lt;value optimized out&gt;, loopback=false) at /home/condor/execute/dir_13396/userdir/src/condor_io/sock.cpp:629\n#3  0x000000000047ab7a in BindAnyCommandPort (rsock=0x808b10, ssock=0x808e40)\n    at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core.cpp:10318\n#4  0x000000000047ae0e in InitCommandSockets (port=-1, rsock=0x808b10, ssock=0x808e40, fatal=true)\n    at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core.cpp:10361\n#5  0x0000000000493716 in DaemonCore::InitDCCommandSocket (this=0x7fc660, command_port=-1)\n    at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core.cpp:9238\n#6  0x0000000000477576 in main (argc=1, argv=&lt;value optimized out&gt;) at /home/condor/execute/dir_13396/userdir/src/condor_daemon_core.V6/daemon_core_main.cpp:2175\n</pre></div>\n\n\n<p>So... why does it work anywhere?\n\n</p><p>At least one code path special cases to handle INADDR_ANY\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">    condor_sockaddr::to_ip_string_ex\n#0  condor_sockaddr::to_sinful (this=0xbffee564, buf=0x8248bc0 \"&lt;128.105.185.14:9618&gt;\", len=64) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_utils/condor_sockaddr.cpp:185\n#1  0x081bad67 in sock_to_string (sockd=9) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_utils/internet.cpp:228\n#2  0x0811d544 in ReliSock::listen (this=0xbfffdb08) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_io/reli_sock.cpp:133\n#3  0x080e703f in ReliSock::listen (this=0xbfffdb08, p=9618) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_includes/reli_sock.h:120\n#4  0x080cc786 in InitCommandSockets (port=9618, rsock=0xbfffdb08, ssock=0xbffeeb00, fatal=false) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_daemon_core.V6/daemon_core.cpp:10438\n#5  0x080d602a in DaemonCore::Create_Process(const char *, const ArgList &amp;, ._137, int, int, const Env *, const char *, FamilyInfo *, Stream **, int *, int *, int, sigset_t *, int, size_t *, int *, const char *, MyString *) (this=0x8265528, executable=0x828d6a8 \"/scratch/adesmet/CONDOR_SRC_TEST/release_dir/sbin/condor_collector\", args=..., priv=PRIV_ROOT, reaper_id=1, want_command_port=9618, env=0x828cf40, cwd=0x0, family_info=0xbfffdf30, sock_inherit_list=0x0, std=0x0, fd_inherit_list=0x0, nice_inc=0, sigmask=0x0, job_opt_mask=0, core_hard_limit=0x0, affinity_mask=0x0, daemon_sock=0x0, err_return_msg=0x0) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_daemon_core.V6/daemon_core.cpp:7468\n#6  0x080c1fe1 in daemon::RealStart (this=0x828cf00) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_master.V6/masterDaemon.cpp:801\n#7  0x080c25c4 in daemon::Start (this=0x828cf00, never_forward=false) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_master.V6/masterDaemon.cpp:547\n#8  0x080c2699 in Daemons::StartAllDaemons (this=0x8246000) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_master.V6/masterDaemon.cpp:1814\n#9  0x080c96e7 in main_init (argc=1, argv=0xbfffe4b8) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_master.V6/master.cpp:382\n#10 0x080f67d9 in main (argc=1, argv=0xbfffe4b8) at /u/a/d/adesmet/scratch/CONDOR_SRC_TEST/src/condor_daemon_core.V6/daemon_core_main.cpp:2354\n</pre></div>\n\n\n<p>Notes\n</p><ul>\n<li>condor_getsockname\n</li><li>condor_bind\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitCommandSockets\" title=\"Init Command Sockets\">InitCommandSockets</a></span>\n</li><li>condor_sockaddr::to_ip_string_ex</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-17 12:16:47 by adesmet:</em> <br/>\n\nFix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2216\" onclick=\"get_ticket_and_populate_wrapper('2216'); return false;\" title=\"IPv6: IP/hostname lookup problems when hostname maps to localhost\">#2216</a></span> was accidentally undone in a merge from master.  Reapplying.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-21 11:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/953dae75c784a1863df8438882cba1205c3e317a\">[27935]</a></span>: Reapply lost patch. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2538\" onclick=\"get_ticket_and_populate_wrapper('2538'); return false;\" title=\"IPv6 \tx86_64_deb_6.0-updated master can't start collector\">#2538</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-17 12:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b671a0199b868fdf169f71cb7d33e5438766ee81\">[27857]</a></span>: Add ASSERT to check for bug that has now manifested twice. (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2538\" onclick=\"get_ticket_and_populate_wrapper('2538'); return false;\" title=\"IPv6 \tx86_64_deb_6.0-updated master can't start collector\">#2538</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2216\" onclick=\"get_ticket_and_populate_wrapper('2216'); return false;\" title=\"IPv6: IP/hostname lookup problems when hostname maps to localhost\">#2216</a></span>)  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-21 15:52", "status": "resolved", "created": "2011-Oct-11 10:56", "fixed_version": "2011-Oct-11 10:56", "broken_version": "", "priority": "1", "subsystem": "", "assigned_to": "adesmet", "derived_from": "#2466", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20111017"}