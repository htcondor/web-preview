{"id": 3577, "title": "Ticket #3577: ExitCode is not propagated from Shadow to Schedd", "description": "<blockquote>\nFor some reason, on a subset of my local jobs, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span> is not propagated to the schedd.\n\n<p>I've included the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShadowLog\" title=\"Shadow Log\">ShadowLog</a></span>.  Look at job 20142.0.  You see the following line:\n\n</p><p>04/16/13 20:53:08 (20142.0) (16846): Inside RemoteResource::updateFromStarter()\n\n</p><p>which shows the updated classad includes <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span>.  However, there's no corresponding SetAttribute(ExitCode = 195) logged.\n\n</p><p>A quick perusal of the code doesn't show any reason why this would be.  If I look at the user log, it has the correct status.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Apr-17 07:11:40 by bbockelm:</em> <br/>\n\nI narrowed this down a bit.  The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span> is only missing if output is transferred by the Shadow.\n\n<p>I'm assigning this to Dan as it appears he's the last one to touch this particular area of the code.  The propagation of the status is a bit twisted.\n\n</p><p></p><hr/>\n<em>2013-Apr-17 16:54:48 by danb:</em> <br/>\n\nThe problem appears to be caused by an old bug that was tickled by new code in 7.9.4.\n\n<p>The old bug is this: In QmgrJobUpdater::updateJob(), it pushes attributes to the schedd --- possibly a subset of the dirty attributes.  If the transaction succeeds, it clears the dirty flag on all attributes, not just the ones that were pushed.\n\n</p><p>New code in 7.9.4 updates an attribute to indicate whether file transfer is in progress.  Depending on a race between reaping the file transfer process and receiving the final update from the starter, this could result in attributes in the final update to the schedd not being pushed.  When the race condition strikes, the following appears in the shadow log:\n\n</p><p></p><pre>    Delaying shutdown of shadow, because file transfer is still active.\n</pre>\n\n<p></p><hr/>\n<em>2014-Jun-12 14:25:58 by tannenba:</em> <br/>\n\nNote that besides causing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span> to be incorrect in condor_history (as mentioned in the version history blurb), this bug also causes Condor-C grid jobs to always report a zero <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/720/ShadowLog\">ShadowLog</a>\n288393 bytes added by bbockelm on 2013-Apr-17 02:17:57 UTC.\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-19 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0dffb6a64f765bc75ef56c85eaa4b70c52170cff\">[35466]</a></span>: add known bug <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3577\" onclick=\"get_ticket_and_populate_wrapper('3577'); return false;\" title=\"ExitCode is not propagated from Shadow to Schedd\">#3577</a></span> to 7.9.5 version history (OKed to do this post 7.9.5 release)  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-19 12:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c31a767c643fdfb20960d6ca424ff46aa1d0fffb\">[35459]</a></span>: minor edit of 7.9.6 version history item (and spelling correction) ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3577\" onclick=\"get_ticket_and_populate_wrapper('3577'); return false;\" title=\"ExitCode is not propagated from Shadow to Schedd\">#3577</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-18 10:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/adf86f8dc0bf129cf86964a17a3b3fe29e1ddc6d\">[35452]</a></span>: Document fix for race condition that prevents <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span> from being updated. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3577\" onclick=\"get_ticket_and_populate_wrapper('3577'); return false;\" title=\"ExitCode is not propagated from Shadow to Schedd\">#3577</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-17 17:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89f3dd72eac294713418246b822ac46dc83f948b\">[35447]</a></span>: Fix QmgrJobUpdater::updateJob() to only unset dirty flag on attributes it pushed. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3577\" onclick=\"get_ticket_and_populate_wrapper('3577'); return false;\" title=\"ExitCode is not propagated from Shadow to Schedd\">#3577</a></span> This fixes a race condition in which <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExitCode\" title=\"Exit Code\">ExitCode</a></span> was not pushed to the schedd in the final update from the shadow.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jun-12 14:25", "status": "resolved", "created": "2013-Apr-16 21:17", "fixed_version": "2013-Apr-16 21:17", "broken_version": "v070904", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "tstclair@redhat.com,dan@hep.wisc.edu", "due_date": ""}