{"id": 7118, "title": "Ticket #7118: condor-annex-ec2 startup script needs better throttles", "description": "<blockquote>\nThe University of Manchester, via AWS, is reporting that they not infrequently don't see all of the instances which start as a result of their Spot Fleet request join the pool.  The error they sent along was\n\n<p></p><div class=\"code\">\n<pre class=\"code\">    An error occurred (RequestLimitExceeded) when calling the\n    DescribeInstances operation (reached max retries: 4): Request limit\n    exceeded.\n</pre></div>\n\n\n<p>Examination of <code>condor_examples/condor-annex-ec2</code> and <code>condor_examples/49ec2-instance.sh</code> (the new and old scripts, respectively) reveal a typo in the handling of the Spot Fleet -specific throttle, and than the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DescribeInstances\" title=\"Describe Instances\">DescribeInstances</a></span> throttle does not attempt to splay the requests any.  We may also need to add an actual exponential back-off; question has been asked of the AWS contact.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Jul-02 14:38:23 by tlmiller:</em> <br/>\n\nTesting with an updated version of the HTCondor configuration -based script works; of 1000 spot instances, 987 joined the pool (although it did take 10-20 minutes).  One of the missing 13 was aborted at launch by Amazon for aan unspecified reason; the other 12 had network connectivity issues that Amazon noticed but declined to fix.\n\n<p>I'll update the init.d / system.d script and test it shortly.\n\n</p><p></p><hr/>\n<em>2019-Jul-02 17:18:31 by tlmiller:</em> <br/>\n\nTested the init.d/system.d style; 996 of 1000 joined the pool, with 4 noted as having connectivity issues.\n\n<p></p><hr/>\n<em>2019-Jul-02 17:20:07 by tlmiller:</em> <br/>\n\n<ol>\n<li>Update 8.8's default AMIs (in the US regions, starting from <code>ami-0c2bae939a03e211a</code> in <code>us-east-1</code>.).\n<ul>\n<li>Update 8.9's default AMIs (in the EU regions).\n</li></ul>\n</li><li>Make AMI <code>ami-055d0036a0449c2db</code> GPU-ready.\n</li><li>Update 8.9's default AMIs (in all eight? regions).\n</li></ol>\n\n<p></p><hr/>\n<em>2019-Jul-27 18:49:48 by tlmiller:</em> <br/>\n\nHTCondor can not simultaneously run Docker jobs and have encrypted execute directories.  The latter has been enabled for the default Annex AMI since the beginning, but we thought the former capability would be a good addition.  Which is more important?\n\n<p>(If the answer is 'Docker', copy ami-0c76... to everywhere and reset the param table defaults (don't forget to include Europe on the master branch).)\n\n</p><p>See also <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6690\" onclick=\"get_ticket_and_populate_wrapper('6690'); return false;\" title=\"Ensure that Docker jobs run on condor_annex default AMI\">#6690</a></span>.\n\n</p><p></p><hr/>\n<em>2019-Aug-02 14:21:28 by tlmiller:</em> <br/>\n\nThe answer is 'Docker', but the named image still needs to turn off encrypted execute directories. :(</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-02 16:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9de38959a844d12b1f77694adfcebcd8b33a607c\">[57569]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7118\" onclick=\"get_ticket_and_populate_wrapper('7118'); return false;\" title=\"condor-annex-ec2 startup script needs better throttles\">#7118</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6690\" onclick=\"get_ticket_and_populate_wrapper('6690'); return false;\" title=\"Ensure that Docker jobs run on condor_annex default AMI\">#6690</a></span>) Update default annex AMI; now supports Docker.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-02 14:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b36b0cfe10f3d94531a28cb608ca65b7e4bf93af\">[57564]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7118\" onclick=\"get_ticket_and_populate_wrapper('7118'); return false;\" title=\"condor-annex-ec2 startup script needs better throttles\">#7118</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6690\" onclick=\"get_ticket_and_populate_wrapper('6690'); return false;\" title=\"Ensure that Docker jobs run on condor_annex default AMI\">#6690</a></span>) Update default annex AMI; now supports Docker.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-03 13:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/80f55b569e69961c862212c66559b13f8963658a\">[57317]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7118\" onclick=\"get_ticket_and_populate_wrapper('7118'); return false;\" title=\"condor-annex-ec2 startup script needs better throttles\">#7118</a></span>) Update the default AMI IDs (on master, for Europe). The new AMIs should no longer fail to join the pool when started in large numbers.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-03 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aea430d8ef8694c50cbcdcd00875ac955c855da3\">[57303]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7118\" onclick=\"get_ticket_and_populate_wrapper('7118'); return false;\" title=\"condor-annex-ec2 startup script needs better throttles\">#7118</a></span>) Update the default AMI IDs. The new AMIs should no longer fail to join the pool when started in large numbers.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-02 14:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/71bd1de8e5691ae2323ea87d21680510f44ae3b7\">[57289]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7118\" onclick=\"get_ticket_and_populate_wrapper('7118'); return false;\" title=\"condor-annex-ec2 startup script needs better throttles\">#7118</a></span>) Add retries to annex EC2 scripts so that (temporarily) exceeding the rate request limit at instance start-up doesn't cause permanent failure.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Aug-02 17:12", "status": "resolved", "created": "2019-Jun-19 15:21", "fixed_version": "2019-Jun-19 15:21", "broken_version": "", "priority": "2", "subsystem": "Annex", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}