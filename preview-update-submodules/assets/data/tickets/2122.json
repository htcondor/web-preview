{"id": 2122, "title": "Ticket #2122: Allow PRE script to skip node job", "description": "<blockquote>\nLogan from Botany wants the following behavior: he wants a PRE script to be able to decide that a node job should not be run, but the node should be considered successful (if the output that would be generated by the node job already exists).\n\n<p>I'm thinking that we could do this by adding a new keyword that specifies an exit code from the PRE script that will skip the node job, like this:\n\n</p><p></p><pre>  SKIP &lt;node name&gt; &lt;exit code&gt;\n</pre>\n\n<p>or\n\n</p><p></p><pre>  PRE_SKIP &lt;node name&gt; &lt;exit code&gt;</pre>\n</blockquote>", "remarks": "<blockquote>\nI implemented the PRE_SKIP keyword, with test cases.  I pushed it onto the branch <code>V7_7-implement_pre_skip_key_word-branch</code> and am sending it over to Kent for review.\n\n<p></p><hr/>\n<em>2011-Jun-01 16:01:48 by wenger:</em> <br/>\n\nSee TEMPTEMP comments in dag.cpp for info about possible problems w/ rescue DAGs.\n\n<p>Also, the test scripts (job_dagman_pre_skip-A.run, etc.) all fail for me.\n\n</p><p></p><hr/>\n<em>2011-Jun-04 17:15:19 by nwp:</em> <br/>\n\nFixed code to address concerns in previous remark, and fixed the tests.\n\n<p></p><hr/>\n<em>2011-Jun-04 20:21:34 by nwp:</em> <br/>\n\nAdded documentation in the user manual at c22e81a in CONDOR_DOC\n\n<p></p><hr/>\n<em>2011-Jun-07 13:51:12 by wenger:</em> <br/>\n\nIn test B and test C, the B_A and C_A node jobs are actually run even though the PRE script returns the skip value.  Obviously, this needs to be fixed in DAGMan; also, the tests need to be fixed to that they fail if the job is run.\n\n<p></p><hr/>\n<em>2011-Jun-07 13:57:00 by wenger:</em> <br/>\n\nThe PRE_SKIP setting is not preserved in a rescue DAG.\n\n<p></p><hr/>\n<em>2011-Jun-21 12:02:55 by smoler:</em> <br/>\n\nDocumentation for this new feature is now on master branch -- for 7.7.1\n\n<p></p><hr/>\n<em>2011-Jul-12 22:00:26 by wenger:</em> <br/>\n\nI just did a bit more cleanup on this.  However, there is still some temporary code (marked with TEMPTEMP comments) in place, because the jobstate_log test fails, and I'm still playing a bit with how a skip should show up in the jobstate.log file.\n\n<p></p><hr/>\n<em>2011-Jul-13 17:05:51 by wenger:</em> <br/>\n\nOkay, I've got the jobstate.log-related stuff fixed up -- go ahead and merge!</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2966\" onclick=\"get_ticket_and_populate_wrapper('2966'); return false;\" title=\"Test combination of PRE_SKIP and recovery\">#2966</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nTest combination of PRE_SKIP and recovery</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-01 15:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a215dfca9bce365c8fd813328a434e75019be218\">[27070]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2057\" onclick=\"get_ticket_and_populate_wrapper('2057'); return false;\" title=\"Always run POST script, even if PRE script fails\">#2057</a></span> (also kind of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>): changed PRE_SKIP to skip the POST script, if any, since with the new \"always run the POST script\" feature there isn't much point to PRE_SKIP otherwise; changed job_dagman_pre_skip-B to make sure the POST script really <strong>is</strong> skipped.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-12 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6cba3af818768419dd1cf90cdffa02c93baf72e9\">[22410]</a></span>: Whitespace changes urged by Kent ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-07 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bdf28cf2cff3fc74401a169f9f0d315ea9134d54\">[22380]</a></span>: Partway through fixing up the 'pre skip' (gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>) tests -- I think job job_dagman_pre_skip-A is okay at this point; the others still need more work.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-22 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9599b19f4329f17e052226f25ab7385bf1e48e08\">[22274]</a></span>: Renamed a couple of test files that somehow got committed with stars on the end of the names... This is for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-22 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ef51c4692e9c111862d9c1b8aa1051401a6556a8\">[22273]</a></span>: Renamed a couple of test files that somehow got committed with stars on the end of the names... This is for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-21 12:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/90a300432ab6509b6f2304063ffee55a4f19b8e4\">[26136]</a></span>: document new PRE_SKIP key word for DAGMan; gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-21 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/78e8c8ddc8b739092233b041aa7aab35288a4ba9\">[26134]</a></span>: removal of PRE_SKIP documentation; gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>; feature not ready for 7.7.0  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-14 13:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7c98a5a5071bd692b6c402b576a020020bbeccd7\">[22178]</a></span>: Add another test to CMakeLists.txt ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-14 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d9b9b961f22caef477e09dc5bd0d49bbad72739f\">[22177]</a></span>: Test case to verify PRE_SKIP node gets written to rescue DAG ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-14 11:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b80a1336bf89ed16c289044cec3c00a617043456\">[22176]</a></span>: Write out the PRE_SKIP node in the rescue DAG ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-14 10:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d62ea4c6ff77b4a2e0ac29c1b94b0ad1d704cba\">[22173]</a></span>: Fix up tests for PRE_SKIP key word ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-14 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/580d6054cfe5bebf49a8777083ba1f026321b492\">[22172]</a></span>: Use Dag::TerminateJob instead of Job::TerminateSuccess ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TerminateJob\" title=\"Terminate Job\">TerminateJob</a></span> fixes up the queues properly for queuing the child jobs  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-04 20:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c22e81aa2616b7c15f3f6660ea750b55a75a7969\">[26111]</a></span>: Document new semantics of PRE_SKIP DAGman command <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-04 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3adc8835a4ac04003c2837a3f305d2ad9404acb7\">[22103]</a></span>: Fix test cases ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> We expect to see failure in job_dagman_pre_skip-A. Revise command in job_dagman_pre_skip-B. Look for the correct files and check the .dag.dagman.out file for the PRE_SKIP indicator.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-04 16:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cf2612edf66f1852de66d43515854382574b63e0\">[22102]</a></span>: Implement changes from Kent's review ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> Write to jobstate.log Call <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TerminateSuccess\" title=\"Terminate Success\">TerminateSuccess</a></span> rather than setting noop  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-01 15:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c3fd6b54697b5df43dc9d4f0c71f21d803457b4e\">[22069]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>: review of Nathan's implementation of this. Changed some of the code to be more in the existing style (both in terms of formatting and higher-level structure); added some notes about possible problems with rescue DAGs caused by skip implementation.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 15:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4bdd101c370e1744cd5462b4bf7b537f62826e72\">[21853]</a></span>: Test to make sure PRE_SKIP kills POST script ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/36e685e49a0a1fcbc66048429353e2f3c27cc841\">[21852]</a></span>: Kill the POST script if PRE_SKIP kills the job ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4ea0c1c7a81e171a68af8fbef7bd742728a52c30\">[21851]</a></span>: Add tests for PRE_SKIP node in DAG ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 14:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f92a448b312063610cf8f68452e504b6eab4cfd8\">[21850]</a></span>: Parse a PRE_SKIP node ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 14:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3f6d658ed567b81768c09a3e118a7e8be652018e\">[21849]</a></span>: Add code in dag class to handle PRE_SKIP ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> When DAGman checks the return value of the PRE script, it ignores failure if the return value matches the PRE_SKIP value given in the DAG submit file. In that case, we mark the DAG job as a noop and move on. This does not handle the case where there\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c35feb10554210bb2c4dd19b2781ca204b9b09aa\">[21848]</a></span>: Job class data and methods for PRE_SKIP ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2122\" onclick=\"get_ticket_and_populate_wrapper('2122'); return false;\" title=\"Allow PRE script to skip node job\">#2122</a></span> Add a _preskip data member to the Job class. Add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HasPreSkip\" title=\"Has Pre Skip\">HasPreSkip</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GetPreSkip\" title=\"Get Pre Skip\">GetPreSkip</a></span> to interrogate whether a job has a PRE_SKIP value, and what that value is. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AddPreSkip\" title=\"Add Pre Skip\">AddPreSkip</a></span> method adds a PRE_SKIP script to the job.  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Jan-29 13:57", "status": "resolved", "created": "2011-May-03 13:48", "fixed_version": "2011-May-03 13:48", "broken_version": "v070600", "priority": "3", "subsystem": "Dag", "assigned_to": "nwp", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu, psilord@cs.wisc.edu", "due_date": ""}