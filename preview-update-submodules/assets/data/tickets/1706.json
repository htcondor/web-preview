{"id": 1706, "title": "Ticket #1706: too many links in spool directory", "description": "<blockquote>\nThe following appears in the shadow log when spool is on an ext3 filesystem and there are more than 16k jobs running:\n\n<p></p><div class=\"verbatim\">\n<pre>10/08/10 22:31:52 (51652.0) (35391): FileTransfer::Init(): mkdir(/home/sfiligoi/glidecondor/condor_local/spool/cluster51652.proc0.subproc0) failed, Too many links (errno: 31)\n10/08/10 22:31:52 (51652.0) (35391): FileTransfer::Init(): mkdir(/home/sfiligoi/glidecondor/condor_local/spool/cluster51652.proc0.subproc0.tmp) failed, Too many links (errno: 31)\n10/08/10 22:31:52 (51652.0) (35391): Can't open directory \"/home/sfiligoi/glidecondor/condor_local/spool/cluster51652.proc0.subproc0.tmp\" as PRIV_USER, errno: 2 (No such file or directory)\n10/08/10 22:31:52 (51652.0) (35391): Can't open directory \"/home/sfiligoi/glidecondor/condor_local/spool/cluster51652.proc0.subproc0\" as PRIV_USER, errno: 2 (No such file or directory)\n</pre></div>\n\n\n<p>In the case where spooling is not needed, this is mostly harmless, because we never use these directories.\n\n</p><p><span class=\"section\"></span></p><h2>Proposed Fix</h2>\n\n<p>Create a hierarchy of directories: $(SPOOL)/&lt;cluster mod 10000&gt;/&lt;proc mod 10000&gt;/cluster&lt;cluster&gt;.proc&lt;proc&gt;.subproc&lt;subproc&gt;.  This avoids exhausting the ext3 link limit at scales of up to 320M spooled clusters or 320M procs.  The hash could be more clever, but this one has the advantage of being easy to reproduce in case some user has need to find the spool directory for a job.\n\n</p><p>On startup, the schedd will need to move spool file/directories around and adjust the references to these paths in the job classads.  This needs to be done carefully so that if the process is interrupted part way through it will get completed when the schedd is restarted.\n\n</p><p>As part of the fix, I am also adding a spool version stamp so that we can improve the upgrade/downgrade process.  Incompatibilities can be detected and conversion to a new format can be more efficiently triggered by simply looking at the version of the existing spool.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Oct-12 11:58:10 by danb:</em> <br/>\n\nIf someone needed to downgrade from this version to a previous version, they would need to move all of the clusterX.procY.subprocZ directories into the top of the spool directory.  That's one advantage of keeping the (ugly) names of those directories the same and only changing the path to them.\n\n<p></p><hr/>\n<em>2010-Oct-12 12:20:09 by gthain:</em> <br/>\n\nMoving the .tmp directories to be under the main per job directory would double the number of entries.  e.g. instead of\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$SPOOL/cluster51.subproc0   and\n$SPOOL/cluster51.subproc0.tmp\n\nhave\n\n$SPOOL/cluster51.subproc0  and\n$SPOOL/cluster51/subproc0.tmp\n\n</pre></div>\n\n\n<p>which could be done in conjunction with this change.\n\n</p><p></p><hr/>\n<em>2010-Oct-22 11:06:54 by danb:</em> <br/>\n\nIn my original plan, I proposed storing the name of the spool directory in the job ad.  While this still may be a good idea, I have dropped it from the plan for this ticket.  Since the schedd operates on the sandbox in at least two different priv states (user and condor), any change that makes the path to the sandbox user-modifiable needs to be carefully thought through to avoid security issues.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-07 21:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5a106f5d0ea97a59801815600f5d750360548188\">[19890]</a></span>: Make shadow check spool version compatibility. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1706\" onclick=\"get_ticket_and_populate_wrapper('1706'); return false;\" title=\"too many links in spool directory\">#1706</a></span> This addresses problems that can be caused during an upgrade in which new binaries are installed while the old schedd is still running. If the old schedd starts up a new shadow, the shadow will now detect if the spool version is incompatible and will\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Oct-29 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6cc31734a7f3cf17d4fed472e0f819ef1d578ce9\">[25757]</a></span>: Documented improved spool scaling under ext3. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1706\" onclick=\"get_ticket_and_populate_wrapper('1706'); return false;\" title=\"too many links in spool directory\">#1706</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Oct-29 12:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5fd69b3d6f75cf697a2998174802966a1962e4c5\">[19264]</a></span>: Addressed problem of too many entries in the spool directory. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1706\" onclick=\"get_ticket_and_populate_wrapper('1706'); return false;\" title=\"too many links in spool directory\">#1706</a></span> This problem affects spooling of more than 16k jobs to an ext3 directory, because we run into the 32k link limit (two spool directories per job).\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Oct-29 12:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41bd738a6d80bfb3828baf3f7c9de0523eaa0295\">[19263]</a></span>: Ignore the filename passed by the client to SendSpoolFile(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1706\" onclick=\"get_ticket_and_populate_wrapper('1706'); return false;\" title=\"too many links in spool directory\">#1706</a></span> This allows us to change the way spooled executables are named in the future without breaking compatibility with older versions of condor_submit.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Oct-29 17:20", "status": "resolved", "created": "2010-Oct-12 11:37", "fixed_version": "2010-Oct-12 11:37", "broken_version": "v070400", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "sfiligoi@fnal.gov, dan@hep.wisc.edu, matt@cs.wisc.edu", "due_date": ""}