{"id": 6228, "title": "Ticket #6228: Milestone 2 for schedd late materialization", "description": "<blockquote>\nTasks for Milestone 2 for late materialization in the SCHEDD.\n\n<p></p><ul>\n<li>Do partial $() substitution in condor_submit before making the digest.  In particular $ENV() needs to be substituted.  To reduce the workload on the SCHEDD, would also like to do any $() substitution that doesn't depend on one of the queue variables.\n\n<p></p></li><li>Transmit the submit digest to the schedd rather than writing it to disk and having the schedd read the digest from disk. The schedd will write the submit digest to a subdirectory of the $(SPOOL) directory, in much the same way that it now writes the spooled executable.\n\n<p></p></li><li>Read the foreach data from disk using non-blocking reads.\n\n<p></p></li><li>Add -factory option to condor_q and add a way to include the cluster ads in condor_q queries of the schedd</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2017-Aug-22 09:49:18 by johnkn:</em> <br/>\n\n8.7.3 has $ENV() substitution in condor_submit, but does not substitute anything else.  Optimized $() substitution is deferred to an unspecified future milestone.\n\n<p></p><hr/>\n<em>2017-Sep-06 11:40:28 by johnkn:</em> <br/>\n\nreading of the foreach data is now using the async_reader class, but it still populates a stringlist of items in the job factory - so no foreach item is ever removed from memory until the entire job factory is destroyed.  This needs to be changed so that only the items that have not yet been used are kept in memory.\n\n<p>Also with milestone 2. There is not yet any policy for materializing jobs other than the original policy that keeps N jobs materialized at all times.  And there is no indication of materialization failure other than that in the schedd log itself.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6350\" onclick=\"get_ticket_and_populate_wrapper('6350'); return false;\" title=\"Add a utitily class that can do getline from a  file without blocking\">#6350</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd a utitily class that can do getline from a  file without blocking</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6357\" onclick=\"get_ticket_and_populate_wrapper('6357'); return false;\" title=\"Transmit submit digest to schedd as text to be spooled\">#6357</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nTransmit submit digest to schedd as text to be spooled</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-01 16:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c1d18c5e652cfe6d6e75785ef18b4e2f352daa0c\">[52237]</a></span>: Change the SCHEDD so that it impersonates the user while parsing the submit digest for a job factory. this is a fix for previous commit to <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span> We do this because if the submit digest has a reference to a foreach file, the file needs to be opened as the submitting user.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-17 22:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bcd7b68db8e377acea27f134b2c41052d7097592\">[52143]</a></span>: fix the empty() method of qelm to return the correct value when there is exactly one item in the queue. this fix is for the previous <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span> changes  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-16 11:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/acca400befb58930e041769e350388d4142a783d\">[52118]</a></span>: use dynamic_cast in the classad log interface for the schedd. fix is for the previous <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span> changes.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-16 11:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9589a0a537248806140b83eb77882377e098abd9\">[52117]</a></span>: remove reference counting in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueCluster\" title=\"Job Queue Cluster\">JobQueueCluster</a></span> object from the previous commit to <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span> as it was causing heap corruption of the schedd on Debian  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-16 11:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/382568022713ec9eb3531cc579b88f83e13499f9\">[52116]</a></span>: milestone 2 for late materialization <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span>. spool the submit digest use an async reader to read the itemdata (all of the itemdata is still being held in memory, however) config changes to parse from a memory stream schedd changes to add a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueCluster\" title=\"Job Queue Cluster\">JobQueueCluster</a></span> object reference counting of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueCluster\" title=\"Job Queue Cluster\">JobQueueCluster</a></span>\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-16 10:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/033f21d35e853410f56c88d8e139474f8b924191\">[52114]</a></span>: use dynamic_cast in the classad log interface for the schedd. fix is for the previous <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span> changes.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-11 16:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1e585b52d4b66e9a2f0aec54b14d310806170723\">[52078]</a></span>: remove reference counting in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueCluster\" title=\"Job Queue Cluster\">JobQueueCluster</a></span> object from the previous commit to <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span> as it was causing heap corruption of the schedd on Debian  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-11 09:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8196b43a4cf670fa3efcf037f8e0dfae83758318\">[52060]</a></span>: milestone 2 for late materialization <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span>. spool the submit digest use an async reader to read the itemdata (all of the itemdata is still being held in memory, however) config changes to parse from a memory stream schedd changes to add a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueCluster\" title=\"Job Queue Cluster\">JobQueueCluster</a></span> object reference counting of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueCluster\" title=\"Job Queue Cluster\">JobQueueCluster</a></span>\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-18 16:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a044d0f49062f4a9f336d69adbd4d1f40bd05105\">[50507]</a></span>: for <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=6228\" onclick=\"get_ticket_and_populate_wrapper('6228'); return false;\" title=\"Milestone 2 for schedd late materialization\">#6228</a></span>, When doing late materialization, do $ENV() substitution in condor_submit before writing the submit digest. This commit also improves the expand_macro function in the config system, and adds code to condor_config_val to test and to expose this functionality. This commit also removes the unnecessary\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Sep-08 11:25", "status": "review", "created": "2017-Apr-18 16:19", "fixed_version": "2017-Apr-18 16:19", "broken_version": "", "priority": "2", "subsystem": "", "assigned_to": "tannenba", "derived_from": "#6166", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}