{"id": 3417, "title": "Ticket #3417: How do you get glidein from behind a NAT?", "description": "<blockquote>\nI have a host S behind a NAT firewall F.  I installed HTCondor on S, with the intention of using it as a schedd to submit jobs for glidein to OSG to get more resources and to begin to drag LMCG HTCondor installation into this decade.  In the sequel, let us label glidein.chtc.wisc.edu as host O (for OSG).\n\n<p>I installed HTCondor on S using a 7.9.1 RPM from HTCondor yum repository.  I have the following settings on S:\n</p><div class=\"code\">\n<pre class=\"code\">USE_SHARED_PORT = True\nSHARED_PORT_ARGS = -p 9617\nTCP_FORWARDING_HOST = &lt;IP address of F&gt;\nFLOCK_TO = cm.chtc.wisc.edu condor.cae.wisc.edu glidein.chtc.wisc.edu\nTCP_UPDATE_COLLECTORS = $(FLOCK_TO)\nPRIVATE_NETWORK_NAME = lmcg.wisc.edu\nPRIVATE_NETWORK_INTERFACE = em1\nFILESYSTEM_DOMAIN = lmcg.wisc.edu\nUID_DOMAIN = lmcg.wisc.edu\nSEC_DEFAULT_AUTHENTICATION_METHODS = FS_REMOTE, GSI\nSEC_DEFAULT_NEGOTIATION = NEVER\n</pre></div>\n\nOn F, I have an iptables rule:\n<div class=\"code\">\n<pre class=\"code\">60493 3630K DNAT       tcp  --  any    any     anywhere             F    tcp dpt:9617 to:&lt;ip address of S&gt;\n</pre></div>\n\nI asked for and received a certificate from Dan Bradley (following instructions in <a class=\"external\" href=\"https://chtc-sa.cs.wisc.edu/trac/pub/wiki/GlideinWMS/AddSubmitNode\">Adding a submit node</a>).  I installed it in <code>/etc/grid-security</code>, as directed.\nWhen I run <code>openssl x509 -noout -subject -in hostcert.pem</code>, I get the following output: <div class=\"code\">\n<pre class=\"code\">subject= /DC=org/DC=doegrids/OU=Services/CN=F\n</pre></div>\n\nPlease remember that this certificate is installed on S.\n\n<p>I have successfully flocked to chtc pool.\n\n</p><p>I have not been able to flock to glidein, despite valiant efforts of Nate Yehle.\nThe best message I get is:\n</p><div class=\"code\">\n<pre class=\"code\">01/08/13 11:56:27 Attempting to send update via TCP to collector glidein.chtc.wisc.edu &lt;128.104.59.136:9618&gt;\n01/08/13 11:56:27 condor_write(): Socket closed when trying to write 3946 bytes to collector glidein.chtc.wisc.edu, fd is 14\n01/08/13 11:56:27 Buf::write(): condor_write() failed\n</pre></div>\n\n\n<p>Is this supposed to work?  Does the host S need to have a routable IP address?  It is a 192.168.0/24 address.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-08 13:15:34 by nwp:</em> <br/>\n\nOK, I had a long IM with Dan Bradley and he helped me fix it.\n\n<p>First, I changed <code>SEC_DEFAULT_NEGOTIATION</code> from <code>NEVER</code> to <code>PREFERRED</code>. Is this <code>PREFERRED</code> the same as <code>OPTIONAL</code> or <code>REQUIRED</code>?  Is this going to preclude getting local resources and flocking to CHTC with this setting?\n\n</p><p>Then I had to update my certificate authorities in <code>/etc/grid-security/certificates</code>.  Dan directed me to <a class=\"external\" href=\"http://vdt.cs.wisc.edu/vdt_rpms/vdt-ca-certs/\">ca-certs archive</a> and then to <a class=\"external\" href=\"https://www.opensciencegrid.org/bin/view/Documentation/Release3/YumRepositories\">OSG Yum Repositories</a>.\n\n</p><p>Evidently I do not have an account, so the above information should be transcribed to <a class=\"external\" href=\"https://chtc-sa.cs.wisc.edu/trac/pub/wiki/GlideinWMS/AddSubmitNode\">How to Add a submit node for Glideins</a>.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2014-Aug-07 12:04", "status": "resolved", "created": "2013-Jan-08 11:24", "fixed_version": "2013-Jan-08 11:24", "broken_version": "", "priority": "3", "subsystem": "Engagement", "assigned_to": "nwp", "derived_from": "", "creator": "nwp", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu gthain@cs.wisc.edu jfrey@cs.wisc.edu dan@hep.wisc.edu nyehle@cs.wisc.edu", "due_date": ""}