{"id": 793, "title": "Ticket #793: Grand unified param() system uses too much RAM", "description": "<blockquote>\nThe grand unified param() system uses too much RAM, apparently because it strdups items into the heap for reasons that should be investigated.\n\n<p>The original idea was the grand unified param code would put the param table in shared static data via the perl script that would generate static code.  We need to avoid using heap space because (1) on principle: the table <em>is</em> all just static initialized data and (2) to be practical: if it is implemented as static code, memory usage will be shared across all shadow processes.\n\n</p><p>For 7.4.0, we should simple make the function(s) generated the perl script a no-op since we aren't using it anyway <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/91f964a0d8acb1d969655babf3faeeb0c21f5987\">[15724]</a></span>.\n\n</p><p>For 7.5.x, we should get rid of the (most likely) unneeded heap allocations in the generated code.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Oct-01 10:10:13 by psilord:</em> <br/>\n\nThe temporary fix has been completed. 7.4 doesn't insert the param data into the table at all so save on space, and it is still inserted in 7.5. The method of skipping is a little wonky as I could not easily use the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVerInfo\" title=\"Condor Ver Info\">CondorVerInfo</a></span> object. Just inspect the commits associated with this ticket to understand what I did.\n\n<p></p><hr/>\n<em>2009-Oct-01 10:11:05 by psilord:</em> <br/>\n\nI have yet to implement the memory saving code in the master.\n\n<p></p><hr/>\n<em>2009-Nov-17 13:21:12 by psilord:</em> <br/>\n\nLowered priority to 3 until we start working on this again, changed it to code enhancement instead of todo for the 7.5 series.\n<hr/>\n<em>2010-Oct-20 15:59:08 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2010-Nov-18 21:29:17 by danb:</em> <br/>\n\nI just committed a patch for 7.5.5 that avoids putting the param info strings in the heap.  This saves about 200k in the linux 64-bit shadow.\n\n<p></p><hr/>\n<em>2010-Nov-18 21:35:26 by psilord:</em> <br/>\n\nAre you sure that's going to work? What about reconfig? I'm thinking this patch is too easy. I hope you ran it across valgrind under full reconfigs with changes config file entries and other such tests....</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-19 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9978cbac7aa12f3e26b6f51bf94f4526037dcf72\">[19476]</a></span>: Make param info strings const to make it clear that they point to static memory. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=793\" onclick=\"get_ticket_and_populate_wrapper('793'); return false;\" title=\"Grand unified param() system uses too much RAM\">#793</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-18 21:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/617b2696b707e1c2996689d4d8af3daa93321fd0\">[25785]</a></span>: Documented fix for shadow memory usage. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=793\" onclick=\"get_ticket_and_populate_wrapper('793'); return false;\" title=\"Grand unified param() system uses too much RAM\">#793</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-18 21:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0433a24af148291d9fdd269c9bc7db81fbea4eb0\">[19464]</a></span>: Avoid putting param info strings in the heap to save memory in the shadow. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=793\" onclick=\"get_ticket_and_populate_wrapper('793'); return false;\" title=\"Grand unified param() system uses too much RAM\">#793</a></span> In the 64-bit linux shadow, this saves about 200k of heap.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-01 10:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/01cf48be85aee1c32cd9fbbabf92a1e518202979\">[15829]</a></span>: Comment out the line which skips the insertion of the param info on the master branch. This enables it for the 7.5 series of Condor. See ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=793\" onclick=\"get_ticket_and_populate_wrapper('793'); return false;\" title=\"Grand unified param() system uses too much RAM\">#793</a></span> and d4628c741d5efba5cbe8e4f3c194f76728108fd4.  (By Peter Keller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-01 10:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4628c741d5efba5cbe8e4f3c194f76728108fd4\">[15826]</a></span>: Due to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=793\" onclick=\"get_ticket_and_populate_wrapper('793'); return false;\" title=\"Grand unified param() system uses too much RAM\">#793</a></span>, we skip the insertion of the param info data into the hash table. This is skipped on the V7_4-branch, but not skipped on the trunk (which is 7.5). I used the skipping method I did to avoid having to implement a C interface to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVerInfo\" title=\"Condor Ver Info\">CondorVerInfo</a></span> C++ object.  (By Peter Keller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Nov-18 21:35", "status": "resolved", "created": "2009-Sep-29 16:26", "fixed_version": "2009-Sep-29 16:26", "broken_version": "v070500", "priority": "3", "subsystem": "Libs", "assigned_to": "psilord", "derived_from": "#787", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tannenba@cs.wisc.edu,matt@cs.wisc.edu", "due_date": ""}