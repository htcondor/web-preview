{"id": 6660, "title": "Ticket #6660: condor_submit should exit early if executable script has CRLF EOLs", "description": "<blockquote>\nThis is an issue that has surfaced several times in the CHTC -\n\n<p>A user edits their (bash) shell script on a windows machine, saves it with DOS/Windows line endings, and copies the script back to the submit machine.\n\n</p><p>The job is submitted, and on the execute node, the executable script fails to execute because technically the CR in the CRLF line ending is interpreted as part of the script name, as if the script intended to use <code>/bin/bash&lt;CR&gt;</code> as an interpreter.\n\n</p><p>The error usually looks something like:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">012 (110929593.000.000) 04/21 02:50:35 Job was held.\nError from slot1_2@e347.chtc.wisc.edu: Failed to execute\n'/var/lib/condor/execute/slot1/dir_26337/condor_exec.exe': (errno=2: 'Nosuch file or directory')\nCode 6 Subcode 2\n</pre></div>\n\n\n<p>Which (1) is not especially helpful/obvious to the user in determining the problem (the line endings in the script) and (2) does not even appear to the user until the job lands on an execute node and fails there.\n\n</p><p>Instead, we can do a simple check at submit time (there are other such checks there already) to fail right away with a useful error message.\n\n</p><p>We can <code>#ifdef</code> this check to apply only to non-windows platforms, just in case <code>#!</code> interpreter scripts are somehow being used in windows also.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Apr-24 17:48:01 by edquist:</em> <br/>\n\nI've pushed <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7d4d4670476fa4c5963331dfd65a4ff4b312b565\">[54796]</a></span> to <code>V8_6-gt6660_crlf_submit_check-branch</code>, (based on <code>V8_6-branch</code>, per Tim T).\n\n<p>Note that it has to be applied slightly different in <code>master</code>, due to some restructuring in <code>submit.cpp</code>\n\n</p><p>on master:\n<a class=\"external\" href=\"https://github.com/edquist/htcondor/commit/fed07158f1b54c59b1d664e821f8dd3ff8d60173\">https://github.com/edquist/htcondor/commit/fed07158f1b54c59b1d664e821f8dd3ff8d60173</a>\n\n</p><p>on V8_6:\n<a class=\"external\" href=\"https://github.com/edquist/htcondor/commit/7d4d4670476fa4c5963331dfd65a4ff4b312b565\">https://github.com/edquist/htcondor/commit/7d4d4670476fa4c5963331dfd65a4ff4b312b565</a>\n\n</p><p>I can make a merge commit off of <code>master</code> that includes both, if that's helpful.\n\n</p><p></p><hr/>\n<em>2018-May-07 16:21:53 by edquist:</em> <br/>\n\nI've added <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6f90f0b0033906e8f3e3f50011184b3756d22249\">[54879]</a></span> with the change on branch <code>master-gt6660_crlf_submit_check-branch</code> against <code>master</code>, as the change is a bit different between <code>8.6</code> and <code>master</code>.  If it's a hassle to include both, maybe just get it into <code>master</code>.\n\n<p>TJ, TimT, what do you guys think?\n\n</p><p></p><hr/>\n<em>2018-May-09 10:14:23 by edquist:</em> <br/>\n\nFeedback from TJ in person yesterday was:\n\n<p></p><ul>\n<li>use the <code>safe_fopen*</code> wrappers instead of <code>fopen</code> directly\n</li><li>remove the <code>#if !defined(WIN32)</code> conditional, as a windows submit host could still submit onto a linux exec node\n</li><li>either make this check a warning instead of an error, or else make an option to allow crlf <code>#!</code> scripts (in case someone is running a <code>#!</code> python script on windows)\n</li></ul>\n\n<p>I've pushed <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fc98acfd1e1140887644815eb18fa356d2c7d312\">[54891]</a></span> and <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4dd55f170ffa01a2d716831bc6da19b8a1048d7f\">[54892]</a></span> to <code>master-gt6660_crlf_submit_check-branch</code> to address these.\n\n</p><p>For TJ's last item, I made a <code>-allow-crlf-script</code> option, and left the default to error out and mention the option.  (Having an error by default seems more useful, since with a warning the jobs will still end up in the queue, and you either have to kill them or wait for them to fail on the exec nodes.)\n\n</p><p>I've tested a build with these changes and everything works as expected.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Sep-25 09:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/176129b48e2560d00d75505871717c539950de1b\">[55464]</a></span>: documentation and version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6660\" onclick=\"get_ticket_and_populate_wrapper('6660'); return false;\" title=\"condor_submit should exit early if executable script has CRLF EOLs\">#6660</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-08 18:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4dd55f170ffa01a2d716831bc6da19b8a1048d7f\">[54892]</a></span>: add -allow-crlf-script option to condor_submit (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6660\" onclick=\"get_ticket_and_populate_wrapper('6660'); return false;\" title=\"condor_submit should exit early if executable script has CRLF EOLs\">#6660</a></span>) And per TJ, do the crlf checking for scripts on windows, also.  (By Carl Edquist )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-08 18:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fc98acfd1e1140887644815eb18fa356d2c7d312\">[54891]</a></span>: use safe_fopen and rb mode per TJ (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6660\" onclick=\"get_ticket_and_populate_wrapper('6660'); return false;\" title=\"condor_submit should exit early if executable script has CRLF EOLs\">#6660</a></span>)  (By Carl Edquist )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-07 16:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6f90f0b0033906e8f3e3f50011184b3756d22249\">[54879]</a></span>: detect script executables with CRLF endings at submit time (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6660\" onclick=\"get_ticket_and_populate_wrapper('6660'); return false;\" title=\"condor_submit should exit early if executable script has CRLF EOLs\">#6660</a></span>)  (By Carl Edquist )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-24 17:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7d4d4670476fa4c5963331dfd65a4ff4b312b565\">[54796]</a></span>: detect script executables with CRLF endings at submit time (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6660\" onclick=\"get_ticket_and_populate_wrapper('6660'); return false;\" title=\"condor_submit should exit early if executable script has CRLF EOLs\">#6660</a></span>)  (By Carl Edquist )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Oct-08 13:56", "status": "resolved", "created": "2018-Apr-24 16:11", "fixed_version": "2018-Apr-24 16:11", "broken_version": "", "priority": "4", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "", "creator": "edquist", "rust": "", "customer_group": "other", "visibility": "public", "notify": "edquist@cs.wisc.edu", "due_date": ""}