{"id": 6657, "title": "Ticket #6657: Support new GCE credentials file format", "description": "<blockquote>\nThe Google Cloud SDK has changed how it writes user credentials on disk. Before, they were written as plain-text JSON in the file <code>~/.config/gcloud/credentials</code>. Now, they're stored in two sqlite database files: <code>~/.config/gcloud/credentials.db</code> and <code>~/.config/gcloud/access_tokens.db</code>.\n\n<p>Both file formats can store credentials for multiple user accounts. The current gce_gahp code assumes the file will contain credentials for just one account. If the file has multiple credentials, the gce_gahp will retrieve the ones that appear last. If the file has a mix of user and service credentials, the gce_gahp can end up with a mix of data from both credential types.\n\n</p><p>We should add an optional gce account attribute in the job ad and corresponding field to the gahp commands. If the user doesn't specify an account, the gahp can pick a random one, but should ensure it uses data for just one account.\n\n</p><p>Google's client SDK (gcloud) has a well-defined location for the credentials file(s). We should make specifying the location of the credentials file in the job ad optional, defaulting to the well-known location.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Jun-15 16:41:55 by jfrey:</em> <br/>\n\nThis code is on branch V8_7-gt6657-gce_credentials ready to be merged. Waiting for sqlite devel packages to be installed on all of the batlab machines.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7218\" onclick=\"get_ticket_and_populate_wrapper('7218'); return false;\" title=\"Wrong GCE credentials used for some requests\">#7218</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nWrong GCE credentials used for some requests</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7555\" onclick=\"get_ticket_and_populate_wrapper('7555'); return false;\" title=\"Reading service account credentials broken in gce_gahp\">#7555</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nReading service account credentials broken in gce_gahp</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-26 15:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7bc59905b45bb1b5086ab32dd4d2db44c247a22b\">[55223]</a></span>: Docs for reading new GCE credentials file format. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-19 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bff18134525286c0736775436dd1e8fd6ae88cc7\">[55191]</a></span>: Add build sqlite build dependency for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 15:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fbea419c529205df6d804a40783542429e6d6b5\">[55061]</a></span>: Make gce_auth_file optional in submit file. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span> If the filename isn't given, then the gce_gahp will look in the default location.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 15:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a5e8bc286b6b47288627b2980132aac18c0059cb\">[55060]</a></span>: GCE GAHP accepts NULL for default credentials file location. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span> If an empty string or 'NULL' is given for the credentials filename, the gahp will look in the default location used by the gcloud tools.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 15:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dbbe388d6e8c5710232e9fc8ca704776a3989763\">[55059]</a></span>: Update some comments in the gce gahp code. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 11:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/36e6d7ba84620e3757dd9ac8d4e5ff0938a2dcd4\">[55058]</a></span>: Add new gce_account attribute in submit file. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span> This optional attribute allows the user to specify which gce account to use when their credentials file has info for multiple accounts. If the attribute isn't set, then a random account in the credentials file is picked.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-14 11:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/461bc757d8d5f6a09bc2c54323a59ec5eb885bc3\">[55057]</a></span>: Allow specifying account name in gce gahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span> Gce gahp commands now include a parameter to specify which account to use, when the credentials file contains information for multiple accounts. An empty account name or a name of 'NULL' means use credentials for a radnom account in the credentials file.\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-08 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e0c65a32d2be7dc002149d358698dc3b2edb998e\">[55056]</a></span>: Overhaul code to read old GCE credential file format. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span> When a credentials file has info for multiple GCE accounts, information from only one account is used, and which account can be specified (like when reading the new sql file format). Also, restore detection of incomplete credential data.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jun-07 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d3e747fead4b2babf983a29201313356151c9a08\">[55055]</a></span>: Read new sqlite credentials file format for grid-type gce. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6657\" onclick=\"get_ticket_and_populate_wrapper('6657'); return false;\" title=\"Support new GCE credentials file format\">#6657</a></span> If the file doesn't look like an sqlite database, retry reading in the old json text format. Internal support for selecting a specific account's credentials for the sqlite file format. When we have a refresh token, try getting a new access\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Jul-26 15:59", "status": "resolved", "created": "2018-Apr-20 14:21", "fixed_version": "2018-Apr-20 14:21", "broken_version": "", "priority": "3", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "a92656", "customer_group": "fermi", "visibility": "public", "notify": "", "due_date": ""}