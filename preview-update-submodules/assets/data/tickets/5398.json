{"id": 5398, "title": "Ticket #5398: Cannot create more than 100 dynamic slots because of Disk allocation", "description": "<blockquote>\nCustomer reports\n\n<p>I have configures an htcondor cluster with dynamic slots. this works so\nfar, however, one behavior seems strange and i have no idea why this is\nhappening and how to fix it:\n\n</p><p>the dynamic \"masterslot\" is configure like this in the config file of\nthe execution host:\n\n</p><p></p><pre>    SLOT_TYPE_1 = 100%\n    SLOT_TYPE_1_PARTITIONABLE = TRUE\n    NUM_SLOTS_TYPE_1 = 1\n    NUM_SLOTS = 1\n</pre>\n\n<p>the execution host has 144 CPUs. when i submit some jobs, new slots\nappear as expected. the strange thing is, when i look at the classads of\nthis new slot, i see this:\n\n</p><p></p><pre>    TotalSlotDisk = 431664.0\n    TotalDisk = 43166420\n</pre>\n\n<p>so, in contrast to the manual, every slot gets assigned 1/100 of the\ntotaldisk value, although they are supposed to be equal. the value of\n<code>TotalSlotDisk</code> does not depend on anything i put into the submission file\nlike request_disk. it is always like this, independent of how many jobs\nare submitted and how many resources they actually request.\n\n</p><p>another strange thing happens when i configure the slot like this:\n\n</p><p></p><pre>     SLOT_TYPE_1 = cpu=100%,memory=100%,disk=50%\n</pre>\n\n<p>this leads to the following output when, on the idle cluster, i issue:\n\n</p><p></p><pre>   condor_status -avail -autoformat Disk\n</pre>\n\n<p></p><pre>   21583144\n</pre>\n\n<p>this number is right in that case, because it is, as expected, 50% of\nthe available disk space. however, this does not change the\n<code>TotalSlotDisk</code> and <code>TotalDisk</code> within the busy dynamic slots as soon as i\nsubmit jobs.\n\n</p><p>The problem appears to be in schedd_negotiate.cpp, line 267 in the current sources:\n\n</p><p></p><pre>   disk = (MAX((int) ceil((disk / total_disk) * 100), 1)) * int(total_disk/100.0);\n</pre>\n\n<p>this sets the disk variable to at least 1% of the total_disk. which is exactly what the customer experiences.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Dec-14 16:49:31 by johnkn:</em> <br/>\n\nCODE_REVIEW: change looks good.\n\n<p></p><hr/>\n<em>2016-Mar-03 08:30:54 by tim:</em> <br/>\n\nRelated to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5535\" onclick=\"get_ticket_and_populate_wrapper('5535'); return false;\" title=\"Partitionable slots can sometimes provision too little disk\">#5535</a></span></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-02 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/78c3b4b7f64de855e8d42c10a698c413936c21e2\">[47672]</a></span>: Temporarily revert <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5398\" onclick=\"get_ticket_and_populate_wrapper('5398'); return false;\" title=\"Cannot create more than 100 dynamic slots because of Disk allocation\">#5398</a></span>, as it induced a rounding problem that prevented dynamic slots with a lot of disk from matching This reverts commit 05832b35170cc29339b80e24969efafebe6e7021.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-07 09:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a8a94082c1fbe4e43b370e663a3fb2e810d91096\">[46364]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5398\" onclick=\"get_ticket_and_populate_wrapper('5398'); return false;\" title=\"Cannot create more than 100 dynamic slots because of Disk allocation\">#5398</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-05 15:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05832b35170cc29339b80e24969efafebe6e7021\">[46354]</a></span>: Allow more than 100 dynamic slots <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5398\" onclick=\"get_ticket_and_populate_wrapper('5398'); return false;\" title=\"Cannot create more than 100 dynamic slots because of Disk allocation\">#5398</a></span> By allowing disk to be specified in units of less than 1 percent.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Mar-03 08:30", "status": "resolved", "created": "2015-Nov-16 11:21", "fixed_version": "2015-Nov-16 11:21", "broken_version": "v080000", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "johnkn", "rust": "a29101", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}