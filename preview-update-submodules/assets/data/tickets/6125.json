{"id": 6125, "title": "Ticket #6125: default condor_q behavior in 8.6.0 has issues (-global)", "description": "<blockquote>\ncondor_q by default now uses a new command int, QUERY_JOB_ADS_WITH_AUTH, instead of QUERY_JOB_ADS.  This is because the default is to show the jobs only for the user doing the query, and one way to do this is to authenticate the user so the schedd knows exactly who is making the query.  The new command int is registered with \"authentication required\".  However, this breaks in a couple scenarios:\n\n<p>1) The administrator has disabled security negotiation (SEC_DEFAULT_NEGOTIATION=NEVER) or authentication (SEC_DEFAULT_AUTHENTICATION=NEVER).  In this case, even a query against a local schedd will not work, because authentication is required but cannot happen.\n\n</p><p>2) Doing 'condor_q -global' will fail when querying remote schedds if the admin has not set up authentication methods that work across machines.  This is quite common, as by default FS is used, which only works locally, and other mechanisms require some additional configuration.\n\n</p><p>As such, we propose to use CLAIMTOBE as a last resort.  This satisfies the requirement that the user authenticate, and although it's potentially imperfect, this is not a security issue as the schedd is just trying to do a \"best effort\" guess at which jobs to send.  The user can always include the -alljobs flag to condor_q in which case the old command int is used.\n\n</p><p>However, it's not quite as simple as just adding CLAIMTOBE into the auth methods list, since the administrator may have explicitly configured their pool's DEFAULT or READ authentication methods, and we don't want to make their configuration less secure than they intended.\n\n</p><p>As such, we should only add CLAIMTOBE to the list of methods for READ access if neither DEFAULT nor READ methods have been set by the admin.  This needs to be done in code, not just in the param table.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Feb-03 12:42:15 by tannenba:</em> <br/>\n\nAlso, something should be done with regards to sites that have set\n\n<p></p><pre>   SEC_DEFAULT_AUTHENTICATION = NEVER\n</pre>\n\n<p>As it is now, for sites that have done this, they are understandably very\nconfused when condor_q fails to work.  For instance, see <a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2017-February/msg00016.shtml\">this post in htcondor-users</a>.\n\n</p><p></p><hr/>\n<em>2017-Feb-03 13:26:19 by zmiller:</em> <br/>\n\nFor people that have negotiation and/or authentication set to \"NEVER\", the only option that will work for them is to use the old behavior of using the command int QUERY_JOB_ADS instead of QUERY_JOB_ADS_WITH_AUTH.  This means essentially that they need to set CONDOR_Q_ONLY_MY_JOBS to false.  We can do the following:\n\n<p>If SEC_WHATEVER_NEGOTIATION or SEC_WHATEVER_AUTHENTICATION is set to NEVER, then condor_q should disregard the setting of CONDOR_Q_ONLY_MY_JOBS and always assume it is false.\n\n</p><p></p><hr/>\n<em>2017-Feb-15 16:56:26 by tannenba:</em> <br/>\n\nConfig-based work-around for those running v8.6.0:\n\n<p>Summary: Make sure your SEC_READ_AUTHENTICATION_METHODS and SEC_CLIENT_AUTHENTICATION_METHODS both include CLAIMTOBE in addition to any other methods you had set up.\n\n</p><p>If you have already set them explicitly, you can just append to condor_config.local:\n\n</p><p></p><pre>   SEC_CLIENT_AUTHENTICATION_METHODS = $(SEC_CLIENT_AUTHENTICATION_METHODS) CLAIMTOBE\n   SEC_READ_AUTHENTICATION_METHODS = $(SEC_READ_AUTHENTICATION_METHODS) CLAIMTOBE\n</pre>\n\n<p>If you have not set those, but have set SEC_DEFAULT_AUTHENTICATION_METHODS, then you can append this to condor_config.local:\n\n</p><p></p><pre>   SEC_CLIENT_AUTHENTICATION_METHODS = $(SEC_DEFAULT_AUTHENTICATION_METHODS) CLAIMTOBE\n   SEC_READ_AUTHENTICATION_METHODS = $(SEC_DEFAULT_AUTHENTICATION_METHODS) CLAIMTOBE\n</pre>\n\n<p>If you have not set anything at all regarding authentication methods, then you  should append this to condor_config.local:\n\n</p><p></p><pre>   SEC_CLIENT_AUTHENTICATION_METHODS = CLAIMTOBE, FS, PASSWORD, SSL, GSI, KERBEROS\n   SEC_READ_AUTHENTICATION_METHODS = CLAIMTOBE, FS\n</pre>\n\n<p></p><hr/>\n<em>2017-Feb-15 16:58:40 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Zach, is commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1b44fc4ed094e04bd75d6f3000429ab21f5ff18\">[50127]</a></span> sufficient?  I.e. if CERTIFICATE_MAPFILE is defined, won't it still not work without explicit (and non-obvious) intervention on the part of the poor sysadmin?\n\n</p><p></p><hr/>\n<em>2017-Feb-16 12:56:15 by zmiller:</em> <br/>\n\nTodd, yes there is still an issue there, but it's a pretty gnarly one.  It's unfortunate, but here's the saga:\n\n<p>First, Most CERTIFICATE_MAPFILE examples (At least, the one in manual section 3.8.4 talking about the map file) do include the dummy rule for CLAIMTOBE.  So I'd say there's a pretty good chance people won't hit this case.\n\n</p><p>Second, that logic would need to go in the SchedD, since that's who is doing the mapping.  condor_q <strong>could</strong> attempt to infer that it should use the old command, but that would mean loading and parsing the mapfile, hoping that it's the same one the (local) schedd is using (and can't be done for querying a remote SchedD).  Then, we need to see if there are any existing entries for CLAIMTOBE, in which case the admin has explicitly set something up and we don't know if CLAIMTOBE will work or not... (maybe they set it up to go to a dummy user, for example).\n\n</p><p>In short, it's a lot of complicated and hacky logic.  I would much prefer that the (poor, unsuspecting sysadmin) explicitly add the rule to their mapfile than add such convoluted code for this case.  Consistency, and all that.\n\n</p><p></p><hr/>\n<em>2017-Feb-16 13:54:12 by tannenba:</em> <br/>\n\nHow about the idea of in the simply having some default rules in a map files, such as if and only if there are no CLAIMTOBE rules explicitly listed, then you get\n\n<p></p><pre>   CLAIMTOBE (.*) \\1\n</pre>\n\n<p>?\n\n</p><p></p><hr/>\n<em>2017-Feb-16 14:20:05 by zmiller:</em> <br/>\n\nAh, gotcha.  I was focused on the client trying to detect which command to send.  But I think adding the default rule(s) make sense and is small enough we can do it in the stable series.  People shouldn't be relying on the mapfile for access control (like in the old days of gridmap files) so I think no one will be suprised in that sense by this change.\n\n<p></p><hr/>\n<em>2017-Feb-22 14:26:59 by zmiller:</em> <br/>\n\nUpon further review, we already do the \"right thing\" for CLAIMTOBE.  If no entry exists in the map file the canonical name is assumed to be whatever user was claimed.  So I believe this ticket can now be resolved.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-01 13:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/82a4d868f909eead943a21b79fb3389b8ed3f637\">[50244]</a></span>: Version history for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6125\" onclick=\"get_ticket_and_populate_wrapper('6125'); return false;\" title=\"default condor_q behavior in 8.6.0 has issues (-global)\">#6125</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-09 17:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8f7a39e297d1b28ee5f1429d56fe2efb90fb88c4\">[50130]</a></span>: Have the condor_q fall back to old command int QUERY_JOB_ADS if authentication will not happen. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6125\" onclick=\"get_ticket_and_populate_wrapper('6125'); return false;\" title=\"default condor_q behavior in 8.6.0 has issues (-global)\">#6125</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-09 16:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1b44fc4ed094e04bd75d6f3000429ab21f5ff18\">[50127]</a></span>: Add CLAIMTOBE to the list of default methods for CLIENT and READ. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6125\" onclick=\"get_ticket_and_populate_wrapper('6125'); return false;\" title=\"default condor_q behavior in 8.6.0 has issues (-global)\">#6125</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Mar-01 13:15", "status": "defer", "created": "2017-Feb-03 11:15", "fixed_version": "2017-Feb-03 11:15", "broken_version": "v080600", "priority": "5", "subsystem": "Security", "assigned_to": "johnkn", "derived_from": "#5857", "creator": "zmiller", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "tannenba@cs.wisc.edu downes@uwm.edu zmiller@cs.wisc.edu johnkn@cs.wisc.edu,pcouvare@caltech.edu", "due_date": "20170210"}