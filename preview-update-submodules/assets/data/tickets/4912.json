{"id": 4912, "title": "Ticket #4912: condor_qedit not handling options properly, resulting in segv", "description": "<blockquote>\nI noticed that running \"condor_qedit --help\" results in an immediate segfault.\n\n<p>That --help is not a valid option aside, the same thing actually happens when you pass a valid attribute-name without an attribute-value.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ gdb condor_qedit\n...\n(gdb) run --help\nStarting program: /usr/bin/condor_qedit --help\n[Thread debugging using libthread_db enabled]\n\nProgram received signal SIGSEGV, Segmentation fault.\n__strlen_sse2 () at ../sysdeps/x86_64/strlen.S:32\n32\t\tmovdqu\t(%rdi), %xmm1\n(gdb) bt\n#0  __strlen_sse2 () at ../sysdeps/x86_64/strlen.S:32\n#1  0x00000032a5927f7e in match_prefix (s1=0x0, s2=0x402683 \"-constraint\") at /usr/src/debug/condor-8.2.7/src/condor_utils/match_prefix.cpp:26\n#2  0x00000000004019ed in main (argc=2, argv=0x7fffffffe4e8) at /usr/src/debug/condor-8.2.7/src/condor_tools/qedit.cpp:175\n</pre></div>\n\n\n<p>And in particular, the argv[2], NULL, is getting passed into strlen()\n</p><div class=\"code\">\n<pre class=\"code\">(gdb) up\n#1  0x00000032a5927f7e in match_prefix (s1=0x0, s2=0x402683 \"-constraint\") at /usr/src/debug/condor-8.2.7/src/condor_utils/match_prefix.cpp:26\n26\t\tsize_t\ts1l = strlen(s1);\n(gdb) p s1\n$1 = 0x0\n(gdb) up\n#2  0x00000000004019ed in main (argc=2, argv=0x7fffffffe4e8) at /usr/src/debug/condor-8.2.7/src/condor_tools/qedit.cpp:175\n175\t\twhile (match_prefix(argv[nextarg], \"-constraint\")) {\n(gdb) p nextarg\n$2 = 2\n</pre></div>\n\n\n<p>My guess is, at a minimum, this trouble area in qedit.cpp:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">169         } else if (!match_prefix(argv[nextarg], \"-constraint\")) {\n170                 constraint.formatstr(\"(%s == \\\"%s\\\")\", ATTR_OWNER, argv[nextarg]);\n171                 nextarg++;\n172                 UseConstraint = true;\n173         }\n174\n175         while (match_prefix(argv[nextarg], \"-constraint\")) {\n</pre></div>\n\n\n<p>could use one of these blocks inserted before the while loop at line 175:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">        if (argc &lt;= nextarg) {\n                usage(argv[0]);\n        }\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Apr-30 11:52:42 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good\n\n<p></p><hr/>\n<em>2015-Nov-03 16:07:10 by zmiller:</em> <br/>\n\ncondor_qedit still segfaults if passed just the single argument \"-debug\" and nothing else.  I created ticket <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5364\" onclick=\"get_ticket_and_populate_wrapper('5364'); return false;\" title='\"condor_qedit -debug\" causes segfault'>#5364</a></span> for that issue, and am leaving this resolved.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5364\" onclick=\"get_ticket_and_populate_wrapper('5364'); return false;\" title='\"condor_qedit -debug\" causes segfault'>#5364</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n\"condor_qedit -debug\" causes segfault</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-25 10:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/312805a53970a1a1fc9effea4288563226386481\">[43460]</a></span>: prevent reading past end of argv in qedit with missing attr-value <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4912\" onclick=\"get_ticket_and_populate_wrapper('4912'); return false;\" title=\"condor_qedit not handling options properly, resulting in segv\">#4912</a></span> an attribute-name without an attribute-value resulted in a segv here.  (By Carl Edquist )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Nov-03 16:07", "status": "resolved", "created": "2015-Feb-24 18:10", "fixed_version": "2015-Feb-24 18:10", "broken_version": "v080207", "priority": "4", "subsystem": "Tools", "assigned_to": "edquist", "derived_from": "", "creator": "edquist", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}