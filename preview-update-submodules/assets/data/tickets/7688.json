{"id": 7688, "title": "Ticket #7688: don't probe filetransfer plugins if not using them", "description": "<blockquote>\n<strong>There is a branch:  V8_9-gt7688-branch</strong>\n\n<p>There is a method in the <code>FileTransfer</code> object called <code>InitializePlugins()</code>.  This invokes each plugin handler with the \"<code>-classad</code>\" option to see which methods are supported.\n\n</p><p>This is called explicitly in the starter when it prints its classad so that we can advertise the support methods.  However, <code>InitializePlugins()</code> is also called inside the <code>SimpleInit()</code> method.\n\n</p><p>This seems helpful, but the end result is that almost every time we are instantiating <code>FileTransfer</code> object, we are probing all the plugins.  The list of supported plugins has now growb to include box, gdrive, and likely more.  Additionally, some of these plugins are written in scripted languages which needs to fire up an interpreter as well.  The overhead of invoking all these plugins when every Shadow starts up is significant at scale.\n\n</p><p>Currently, the only place that actually USES the plugins is the starter.  We should therefor skip the probing by default in all other places where it is not needed.\n\n</p><p>This means:\n</p><ol>\n<li>Don't do it in the shadow at all\n</li><li>Do it in the starter if plugins are actually used\n</li><li>Do it in the starter when explicitly asked (By calling <code>FileTransfer::GetSupportedMethods()</code>)</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Jun-19 11:38:47 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>In <code>FileTransfer::InitializeJobPlugins()</code>, there are a couple checks for <code>IsClient()</code> to determine if the code is executing within the starter (the one place we need to call the plugins with <code>-classad</code>). These checks need to include <code>!simple_init</code>. <code>condor_submit</code>, <code>condor_c-gahp</code>, and <code>condor_transfer_data</code> are all file-transfer clients and they don't need to do this initialization. The starter is the only client that has <code>simple_init</code> set to <code>false</code>.\n</li></ul>\n\n<p></p><hr/>\n<em>2020-Jun-24 10:45:44 by zmiller:</em> <br/>\n\nI reworked the code a bit and moved the plugin probing into <code>Init()</code> instead of <code>SimpleInit()</code>, as well as cleanly separated adding plugins to the inputfiles and adding plugins to the plugin table.\n\n<p></p><hr/>\n<em>2020-Jun-25 13:43:45 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The new changes look good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-03 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a1f993befb1fba7c1b689bfe415088bbef93e039\">[60326]</a></span>: Add version history for not probing file transfer plugins <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7688\" onclick=\"get_ticket_and_populate_wrapper('7688'); return false;\" title=\"don't probe filetransfer plugins if not using them\">#7688</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-25 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8252eab46f8639e61eb521c53832a22910f83c9e\">[60000]</a></span>: Only probe transfer plugins when necessary. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7688\" onclick=\"get_ticket_and_populate_wrapper('7688'); return false;\" title=\"don't probe filetransfer plugins if not using them\">#7688</a></span> This is a squashed commit of the following changes that were made on the V8_9-gt7688-branch:\u00a0[...]\n (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-24 17:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2f3424462432331e687d0107745129cd57e3dca1\">[59978]</a></span>: Give a useful error message if plugins are disabled. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7688\" onclick=\"get_ticket_and_populate_wrapper('7688'); return false;\" title=\"don't probe filetransfer plugins if not using them\">#7688</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-24 10:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c1ad760f863306b5ae6ccef694050dfc5b5a60d6\">[59966]</a></span>: Clean up plugin detection so it only happens in the Starter, and only when it needs to. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7688\" onclick=\"get_ticket_and_populate_wrapper('7688'); return false;\" title=\"don't probe filetransfer plugins if not using them\">#7688</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-18 13:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/df8d3c9c65517041d76ef7b8c79c5d72166831ed\">[59913]</a></span>: Avoid probing file transfer plugins when not necessary. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7688\" onclick=\"get_ticket_and_populate_wrapper('7688'); return false;\" title=\"don't probe filetransfer plugins if not using them\">#7688</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Aug-03 14:37", "status": "resolved", "created": "2020-Jun-16 10:26", "fixed_version": "2020-Jun-16 10:26", "broken_version": "v080900", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "support", "visibility": "public", "notify": "zmiller@cs.wisc.edu", "due_date": ""}