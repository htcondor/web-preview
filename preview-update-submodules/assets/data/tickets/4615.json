{"id": 4615, "title": "Ticket #4615: Removed jobs go back to running", "description": "<blockquote>\nThe CMS pool is having issues with jobs running after they have been \"condor_rm\"'d - causing many user complaints and inconsistent monitoring issues.\n\n<p>Jaime and I did some detective work, and the sequence is like this:\n\n</p><p></p><ol>\n<li>User kills task\n</li><li>schedd sends SIGUSR1 to condor_dagman, indicating it should kill all jobs and exit\n</li><li>condor_dagman does \"condor_rm -const $STUFF\" which matches all the jobs in the task\n</li><li>Job starts staging out files, gets a glexec error.  Job goes on hold.\n</li><li>After a few minutes, glexec error is automatically cleared by <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRelease\" title=\"Periodic Release\">PeriodicRelease</a></span>.\n</li><li>Job is now idle.\n</li><li>Job goes back to executing.\n</li></ol>\n\n<p>The problem is that when the job is put on hold by the shadow, it does not set the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatusOnRelease\" title=\"Job Status On Release\">JobStatusOnRelease</a></span>.  It seems that this attribute should have been set when the job was removed by condor_rm (currently, it is set when a user runs \"condor_hold\" for a removed job in actOnJobs).</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Sep-26 16:06:42 by tannenba:</em> <br/>\n\nTicket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4619\" onclick=\"get_ticket_and_populate_wrapper('4619'); return false;\" title=\"Shadow error causes job to be un-removed\">#4619</a></span> looks to be a dupe - we will put the implementation to fix this in that ticket.  Jaime and I just talked about it, he will get to it early next week.\n\n<p>Some thoughts:\n\n</p><p></p><ul>\n<li>Seems dumb to allow the shadow reaper to put the job on hold in the first place if the job is already in removed state.\n\n<p></p></li><li>Some lower level of the schedd (qmgmt? something lower than <code>actOnJobs</code>) should be setting <code>JobStatusOnRelease</code>.\n\n<p></p></li><li>condor_dagman should not issue a condor_rm in the above case.  It is redundant - dagman should just let the schedd remove the child jobs itself, without the need for a fork/exec of condor_rm and another incoming schedd connection.  See <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4618\" onclick=\"get_ticket_and_populate_wrapper('4618'); return false;\" title=\"Remove DAGMan code that condor_rms node jobs on condor_rm of DAGMan\">#4618</a></span> (and also <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=3278\" onclick=\"get_ticket_and_populate_wrapper('3278'); return false;\" title=\"Condor_rm of recovered DAG sometimes leaves node jobs running\">#3278</a></span> may be of interest).</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4619\" onclick=\"get_ticket_and_populate_wrapper('4619'); return false;\" title=\"Shadow error causes job to be un-removed\">#4619</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nShadow error causes job to be un-removed</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2014-Oct-22 15:20", "status": "resolved", "created": "2014-Sep-26 11:06", "fixed_version": "2014-Sep-26 11:06", "broken_version": "", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu tannenba@cs.wisc.edu", "due_date": ""}