{"id": 7367, "title": "Ticket #7367: Jobs not getting OOM killed when out of memory", "description": "<blockquote>\nWhen cgroups are enabled in the vanilla universe, the starter subscribed to per-cgroup OOM killer notification.  When the OOM killer fires, it can be because 1 of 2 reasons:\n\n<p>1) Processes in this cgroup are using more memory than their limit.\n2) Processes in this cgroup are below their memory limit, but processes outside cgroup limits (usually everything on the system that isn't a condor job.\n\n</p><p>A while back, we decided to not kill a job in case <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=2\" onclick=\"get_ticket_and_populate_wrapper('2'); return false;\" title=\"Get Dan Forrests Std Univ stuff into the code\">#2</a></span>, and continue running, to allow the system to choose something else to kill.  To make this decision, we compare the amount of memory used by the processes in the cgroup vs the limit.\n\n</p><p>However, there's a bug in our implementation.  Our code to measure the amount of memory used simply totals rss + total_mapped_file.  The OOM limit is based on all used pages, including various kernel structures.  When we first implemented this, we hacked around this by coding a 10% buffer.\n\n</p><p>This buffer was removed in ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6925\" onclick=\"get_ticket_and_populate_wrapper('6925'); return false;\" title=\"Jobs killed by OOM even when using less RAM than requested\">#6925</a></span>.  Since this commit, CHTC gets jobs stuck, repeatedly hitting the OOM killer, but not putting them on hold.\n\n</p><p>In the short term, I'm going to restore the 10% buffer, and in the long term, give condor the ability to read the total amount of memory a cgroup is using, as viewed by the OOM limit.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Dec-12 14:26:45 by tannenba:</em> <br/>\n\nNot sure why this ticket was resolved without any version history or documentation ... moved it back to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DocPending\" title=\"Doc Pending\">DocPending</a></span>.\n\n<p></p><hr/>\n<em>2019-Dec-30 10:50:31 by tim:</em> <br/>\n\nThe documentation was present. <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GitTrac\" title=\"Git Trac\">GitTrac</a></span> dropped the ball with the doc commit.\n\n<p>(However, the second documentation commit was much better.)</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7424\" onclick=\"get_ticket_and_populate_wrapper('7424'); return false;\" title=\"jobs hang instead of being held when using too much memory\">#7424</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\njobs hang instead of being held when using too much memory</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-20 16:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c4d5afe3c2a383c987e2e0c5b9f36cf5d30f8b8a\">[58736]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7367\" onclick=\"get_ticket_and_populate_wrapper('7367'); return false;\" title=\"Jobs not getting OOM killed when out of memory\">#7367</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-09 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cc9df14b911a927123072669b40b99c0ea11be53\">[58622]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7367\" onclick=\"get_ticket_and_populate_wrapper('7367'); return false;\" title=\"Jobs not getting OOM killed when out of memory\">#7367</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-12 15:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6110e94594a0bd8e65bae20163fffacf3a887a92\">[58435]</a></span>: Revert \"Avoid killing jobs using between 90% and 99% of memory limit. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6925\" onclick=\"get_ticket_and_populate_wrapper('6925'); return false;\" title=\"Jobs killed by OOM even when using less RAM than requested\">#6925</a></span>\" <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7367\" onclick=\"get_ticket_and_populate_wrapper('7367'); return false;\" title=\"Jobs not getting OOM killed when out of memory\">#7367</a></span> This reverts commit 4ee91f14c3a654273269a653851610437063153a.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Dec-30 10:50", "status": "resolved", "created": "2019-Nov-12 15:26", "fixed_version": "2019-Nov-12 15:26", "broken_version": "v080900", "priority": "2", "subsystem": "", "assigned_to": "gthain", "derived_from": "#6925", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}