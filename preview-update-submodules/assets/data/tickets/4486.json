{"id": 4486, "title": "Ticket #4486: Calling posix_memalign() prevents standard universe from linking.", "description": "<blockquote>\nSee CHTC-Requests #36960.\n\n<p>If a user program calls <code>posix_memalign()</code>, it will get the stock glibc implementation, which pulls in the stock glibc's <code>malloc.o</code>, which conflicts with our (<code>mmap()</code> -avoiding) implementation of malloc.  The linker reports  <code>libcondor_c</code> redefining symbols from <code>libcondorsyscall</code> (<code>__libc_memalign</code>, <code>free</code>, <code>malloc</code>, <code>realloc</code>).\n\n</p><p>We currently remap <code>memalign()</code> (the 'obsolete version' of <code>posix_memalign()</code>, according to the Linux man pages) to <code>__libc_memalign()</code> precisely to avoid this problem.  It's therefore highly likely that remapping <code>posix_memalign()</code> to a <code>memalign()</code> wrapper function would solve this problem.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-30 13:24:00 by tlmiller:</em> <br/>\n\nThe following patch permits the link to occur.  I also claim it implements <code>posix_memalign()</code> correctly, but I'll need help from the user to really test it properly.\n\n<p></p><div class=\"verbatim\">\n<pre>diff --git a/src/condor_syscall_lib/switches.remap-LINUX.h b/src/condor_syscall_\nindex b3d7ea3..ba8b6f4 100644\n--- a/src/condor_syscall_lib/switches.remap-LINUX.h\n+++ b/src/condor_syscall_lib/switches.remap-LINUX.h\n@@ -778,19 +778,23 @@ int __wprintf_chk(int /* flag */, const wchar_t *format, .\n /* This forces malloc.o from libc.a to not be brought in, and allows stduniv\n        code to use the malloc-user.c API instead */\n REMAP_TWO( memalign, __libc_memalign, void*, size_t, size_t )\n-#endif\n-\n-#endif /* REMOTE_SYSCALLS */\n\n+/* As above, except that our allocator doesn't provide posix_memalign(). */\n+int posix_memalign( void ** ptr, size_t alignment, size_t size ) {\n+       if( size == 0 ) { return NULL; }\n+       if( alignment % sizeof(void *) != 0 ) { return EINVAL; }\n+       // Zero is not a power of two.  Iff alignment is a power of two, it has\n+       // a single one bit in position p; all other bits are zero.  Subtracting\n+       // 1 from alignment causes the bit in position p to become zero.  Thus,\n+       // alignment &amp; (alignment - 1) is 0 iff alignment is a power of two.\n+       if( (alignment == 0) || (alignment &amp; (alignment - 1)) ) { return EINVAL; }\n+       * ptr = memalign( alignment, size );\n+       if( * ptr == NULL ) { return ENOMEM; }\n+       return 0;\n }\n\n+#endif\n\n+#endif /* REMOTE_SYSCALLS */\n\n-\n-\n-\n-\n-\n-\n-\n-\n+}\n\n</pre></div>\n\n\n<p>(No, that's not an extra right brace at the end of the patch.  The whole header file is <code>extern \"C\" {}</code>, and diff decided I reused the former final right brace rather than inserting a new one.)\n\n</p><p></p><hr/>\n<em>2014-Aug-27 11:15:33 by tlmiller:</em> <br/>\n\nAdding this to the Ubuntu 14 / Debian 8 full port(s) doesn't seem to have broken anything.  We should still confirm it actually helps with the user's application.\n\n<p></p><hr/>\n<em>2014-Oct-03 11:02:04 by tlmiller:</em> <br/>\n\nUser is working on test.\n\n<p></p><hr/>\n<em>2014-Oct-13 17:21:50 by tlmiller:</em> <br/>\n\nUser reported successful compilation.  Is arranging for test of binary.\n\n<p></p><hr/>\n<em>2014-Nov-05 10:13:13 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> This change looks good.\n\n<p></p><hr/>\n<em>2014-Nov-05 10:13:52 by tim:</em> <br/>\n\nWe need to move the version history item from 8.2.3 to 8.2.4. This change was not released in 8.2.3.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-06 12:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/87562973234f1b5e544f57f20cfe5b83a2ad479a\">[41603]</a></span>: move the existing version history item from the 8.2.3 subsection to the 8.2.4 subsection <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-24 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e59f8a3456d9b2a4b7c8d970e0805eb87a7a7f09\">[41476]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span>) Commit the fix again, with more feeling.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-13 15:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96a36dc14715a8574df6e2d85b2c2a315405cea7\">[41392]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span>) Commit the fix again, with more feeling.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-02 16:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/117fba7ab86e8fff7ad1b3508b72ea0a3cc6382d\">[41076]</a></span>: edit of 8.2.3 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-29 11:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5be864699780e6d350393ce582eb1e8e01645bca\">[41058]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4540\" onclick=\"get_ticket_and_populate_wrapper('4540'); return false;\" title=\"EC2 GAHP crashes if $ENV{USER} not set.\">#4540</a></span>.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-27 11:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bc9de331a1fde52e50a0a7dcb7d178e52e743ed1\">[41048]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c4415b82c6f176914bad478fdaf03c9cf1bc62bc\">[41025]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e16428e9bea20b8c4e49bbbc412415d9b8154fef\">[41031]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1b77855531276e215c725e669e434ea7df246026\">[41038]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/314f087bf85dbc8d2466b0ce9c23f476466ca4bc\">[41039]</a></span>, Debian 8 (Testing) full port. Includes support for Ubuntu 14.04 LTS. Includes <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span>. We should change condor_tests/CMakeLists.txt, externals/bundles/glibc/CMakeLists.txt, and nmi_tools/glue/SubmitInfo.pm when Debian 8 exits testing and its platform identifier\u00a0[...]\n (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Nov-07 10:09", "status": "resolved", "created": "2014-Jul-24 15:44", "fixed_version": "2014-Jul-24 15:44", "broken_version": "", "priority": "4", "subsystem": "Std", "assigned_to": "smoler", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}