{"id": 4588, "title": "Ticket #4588: Export a log reader API from the python bindings", "description": "<blockquote>\nThe <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log is an important concept - especially for the schedd - which we should expose through the python bindings (currently, it's only exposed through libcondorapi).  This would allow easier development of appropriately-privileged external daemons to tail the activity of the schedd and synchronize out to external systems.\n\n<p>Why use this versus ...\n</p><ul>\n<li>Global user log?  The log reader API provides details at the level of the individual attributes.  The Global user log only includes state transitions.\n</li><li>Schedd plug-ins?  Plug-ins run in-process (potentially causing security issues, memory leaks, or crashes) and wouldn't provide an easier development path - C++ plugin versus python code.  As seen in recent issues with classad loadable plugins, the HTCondor plugin infrastructure provides no versioning help -- there's no way to know if you are loading an incompatible plugin and about to cause the schedd to crash.\n</li></ul>\n\n<p>The API design would expose a new class with the following methods:\n</p><ul>\n<li>constructor: given a filename, returns a new instance.  Unfortunately, this must be based on filename (as opposed to an open file pointer) due to the\n</li><li>Next (and __iter__): Returns the next event in the log.  Appropriate for for-loops.\n<ul>\n<li>A slight twist, Poll, will be provided that is appropriate for while-loops.\n</li></ul>\n</li><li>Wait: Block until a new event is available.\n</li><li>setBlocking: Determine whether or not \"next\" should block when there are no events available.\n</li><li>Watch: Return a file descriptor which will be marked as \"ready for read\" in a select() call when there are new events available.  Meant to be used for event-loop-based programs.\n</li></ul>\n\n<p>Basically, the object is meant to behave as a pythonic iterator (i.e., appropriate for for-loops).  The various iterators should return a dictionary which is a rough equivalent of the existing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogEntry\" title=\"Class Ad Log Entry\">ClassAdLogEntry</a></span>.  Note this inverts the control flow from the existing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogReader\" title=\"Class Ad Log Reader\">ClassAdLogReader</a></span> (which is callback-based) to allow better interaction with event loops.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Feb-19 12:26:05 by smoler:</em> <br/>\n\nThere is no documentation yet for this new class.  This ticket is to remain open until the documentation is complete.\n\n<p></p><hr/>\n<em>2015-Feb-21 11:37:52 by bbockelm:</em> <br/>\n\nHi Karen,\n\n<p>Sorry for the belated documentation.  Here's a few explanations:\n\n</p><p><span class=\"subsection\"></span></p><h3>LogReader </h3>\nThe <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LogReader\" title=\"Log Reader\">LogReader</a></span> provides a parser for reading and tailing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> transaction logs; the best example of a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> transaction log is the one kept by the schedd in <code>job_queue.log</code>.\n\n<p>This is meant to allow a python program to mirror the contents of a schedd's log.\n\n</p><p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LogReader\" title=\"Log Reader\">LogReader</a></span> is iterable, meaning it can be used in loop constructs, such as:\n\n</p><p></p><div class=\"verbatim\">\n<pre>for event in LogReader(\"/var/lib/condor/spool/job_queue.log\"):\n  print event\n</pre></div>\n\n\n<p>The events produced by the iterator are python dictionaries describing the next event in the log file.\n\n</p><p><span class=\"subsection\"></span></p><h3>LogReader methods</h3>\n\n<p></p><ul>\n<li>Constructor: Takes in the name of a file to parse.\n</li><li><strong>next()</strong>: Returns a python dictionary containing the next event in the log file.  If blocking mode is enabled, this blocks indefinitely until a new event is available.  If blocking mode is disabled, this raises a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StopIteration\" title=\"Stop Iteration\">StopIteration</a></span> exception when no new event is available.\n</li><li><strong>poll(timeout)</strong>: Returns a python dictionary containing the next event in the log file.  This will block until a new event is available or a timeout is hit.  The timeout parameter is specified in milliseconds; set 0 to return immediately or -1 to block indefinitely.  Returns None on timeout.\n</li><li><strong>setBlocking(blocking)</strong>: Set whether or not the next() function should block when no event is available.  Returns the previous value of the object's blocking state.\n</li><li><strong>wait()</strong>: Wait until a new event is available; no value is returned.\n</li><li><strong>watch()</strong>: Returns a file descriptor.  When select() indicates there is data available on this descriptor, a new event may be available.  If -1 is returned, the API is not available on the current platform.</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5945\" onclick=\"get_ticket_and_populate_wrapper('5945'); return false;\" title=\"Documentation for Pyton LogReader binding missing\">#5945</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDocumentation for Pyton <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LogReader\" title=\"Log Reader\">LogReader</a></span> binding missing</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-24 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8e17d667889e1a26e821810f876083402a17a99f\">[43455]</a></span>: fix for EL5 PROPER build <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span> See also: <a class=\"external\" href=\"https://jira.opensciencegrid.org/browse/SOFTWARE-1807\">https://jira.opensciencegrid.org/browse/SOFTWARE-1807</a>  (By Carl Edquist )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-19 12:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/df8d88719f5bc1bfa1cd29ed1ec97f5a26d6241a\">[43416]</a></span>: add version history for totally undocumented <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LogReader\" title=\"Log Reader\">LogReader</a></span> class <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 15:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c9407a29b104e60c21d44a0ccfc83bb1b81800b1\">[41998]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b908eace3c12154c33ee4b4c4ee2bb440024e576\">[41165]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b3139430363bcbe3d876d5d65d450c020e4582d4\">[41168]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9146cb00215a0b6490202a00f50adc24af87447f\">[41169]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4d0ee19fc9783d7ccb562f9da07ffaa1818cf052\">[41171]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/02f683d00f8acbd806830b4c96f54a4840071856\">[41172]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/232ca242bb8ac0b04f43d6cb6b1ee3179e74203e\">[41204]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/712725d86d46411d995f3b6c8ebefe3f08a3fdec\">[41979]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c49d863e92bccea3ebf8901fe5bd83283a2e51df\">[41980]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a8112354b71b0777be4978f0fa2c48790055a2b5\">[41981]</a></span>, Merge branch 'V8_3-gt4588'. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span> Conflicts: src/python-bindings/CMakeLists.txt  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 08:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c49d863e92bccea3ebf8901fe5bd83283a2e51df\">[41980]</a></span>: Bugfixes for inotify and event tests. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 07:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/712725d86d46411d995f3b6c8ebefe3f08a3fdec\">[41979]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/af6b879419042db66353b08d456bb3deb0ac71d4\">[40764]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/24abffdead8e4196ebb16037c4ab9b433d56998f\">[40774]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d5dbc639d2789296e72939df9c6a5c80e6ec690\">[40776]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/802abad7a48a47d7e778b163d7013277bbf92d9c\">[40777]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/85f73e80c6cf86a0e7d54a41a1ef9da1e0b6a540\">[40778]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9fb950ec2ad8ac5376b13cdc9a8754080e8ca3a0\">[40779]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/647042496f6dfc2b0eb58013e6017c1b38eedc3f\">[40795]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/551b4d833833a20689c5809125ee3a50efc34e7f\">[40798]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1437b6cec1438399e53d00f2f1bfe670a9a153a9\">[40799]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/49c9b8abb4a2db9f748b136b9673123a357d3ce0\">[40800]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/520064ad40c8ec8059a7fb7781855a57e65aff5e\">[40810]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6cab9a30cacf515f51762bf3683319999e0940e\">[40812]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/47647b47ec9f047367cadd9069d0136925901a2d\">[40839]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c4e0c0d0a068bc84573ecacf122101ce85a8358b\">[40840]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1411e282dcc55276d4f1a0a131f481d6157b944d\">[40843]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1a072eef173a51ce1b03126a43147ae02a20be3\">[40848]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbab2acdbd5e6ed8fa604403f374a176485cfc52\">[40852]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b5dfa5966275c3250afadbd2eda6f049f694ce92\">[41178]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c2d6c8b8bb5debdc461500c3ade38210dc2c9ad1\">[41179]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c7525d9e4ed3b0c12d4704e48f7dbc20a9fa3dff\">[41180]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e63543f36fa745fd94d75d86d10716e5174587bc\">[41181]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cc6050a9e490acb68ca0d79a5d88cd044d50b850\">[41182]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f1edb81a3d713cac3e6806ca2178911266548dbf\">[41183]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7e5b09740fe6ae6660d739c7d5deb0d2c8607f2c\">[41184]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbebede754d44e058f61ac5dc11e4f1aaa506f54\">[41185]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b373997a7a98dc8c73e704882d8bcc33ca3d95a7\">[41186]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c4f716eb43ab45dd389a82334abe798d0b36ec0\">[41187]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d55c18409a49338c2b4ab3530ed7853264fe4901\">[41302]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6d4349fcabaee916b728dbe48d5cb0c5e028d6a\">[41303]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f905b5ca153391f51218ae414488803395f38fcb\">[41304]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1c9bcde2b67df87a6bc4d66196699af20ab32717\">[41305]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ee7227f230b4d2b18d06f6a1df1d9c7d2012f2a9\">[41306]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/69026141a5bfd2c488090d64d8e6909b4dc3578d\">[41307]</a></span>,\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 07:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0a0d8c45db48bba7ed39b41096116f4b65e3bba8\">[41977]</a></span>: Rename enum entries to avoid macros on Solaris. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-22 08:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/232ca242bb8ac0b04f43d6cb6b1ee3179e74203e\">[41204]</a></span>: Improve event iterator. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span> This commit gives the event iterator the same test coverage and options for blocking as the log reader.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-16 20:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/02f683d00f8acbd806830b4c96f54a4840071856\">[41172]</a></span>: Addition of the log reader API for python. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4588\" onclick=\"get_ticket_and_populate_wrapper('4588'); return false;\" title=\"Export a log reader API from the python bindings\">#4588</a></span> This is an iterator-based API for reading through a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log (such as written by the schedd). The parser and probe is reused from the existing ClassAdLog* API, but the control flow was rewritten to match the inverted, iterator-based style preferred\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Oct-04 10:53", "status": "resolved", "created": "2014-Sep-15 12:15", "fixed_version": "2014-Sep-15 12:15", "broken_version": "", "priority": "4", "subsystem": "Tools", "assigned_to": "tim", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}