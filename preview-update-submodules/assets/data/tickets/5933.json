{"id": 5933, "title": "Ticket #5933: cpu_exceeded startd policies are invalid", "description": "<blockquote>\nAdding the following line to a startd config\n\n<p></p><div class=\"verbatim\">\n<pre>use POLICY:Hold_If_Cpus_Exceeded\n</pre></div>\n\n\n<p>results in the following errors\n\n</p><p></p><div class=\"verbatim\">\n<pre>root@execute0062:/etc/condor/config.d# condor_reconfig\nInternal Configuration Error: use policy: preempt_if_cpus_exceeded is invalid\nInternal Configuration Error: use POLICY:Hold_If_Cpus_Exceeded: Hold_If_Cpus_Exceeded is invalid\nConfig source Error \"/etc/condor/config.d/03preemption\", Line 1: at use POLICY:Hold_If_Cpus_Exceeded:Hold_If_Cpus_Exceeded\nConfiguration Error Line 1 while reading config source /etc/condor/config.d/03preemption\n</pre></div>\n\n\n<p>When I look at the code for Hold_If_Cpus_Exceeded, it looks like it includes preempt_if_cpus_exceeded. I don't see anything obviously invalid about them.\n\n</p><p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/19e1b8b6bfe595303a19c3754e9d04e0d757734f/src/condor_utils/param_info.in#L8405\">https://github.com/htcondor/htcondor/blob/19e1b8b6bfe595303a19c3754e9d04e0d757734f/src/condor_utils/param_info.in#L8405</a>\n\n</p><p>I am making use of several policies. Maybe that's the problem? $(HOUR) is properly defined elsewhere.\n\n</p><p></p><div class=\"verbatim\">\n<pre>use POLICY:Hold_If_Cpus_Exceeded\nuse POLICY:Always_Run_Jobs\nuse POLICY:Limit_Job_Runtimes\nMAX_JOB_RUNTIME = (24*$(HOUR))\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Oct-13 10:06:12 by johnkn:</em> <br/>\n\nLine continuations (i.e. the trailing \\) are not allowed in metaknobs.\n\n<p></p><hr/>\n<em>2016-Oct-13 10:06:12 by johnkn:</em> <br/>\n\nThe use of params that self-reference and also have defaults was broken. i.e.\n\n<p></p><pre>    PREEMPT = $(PREEMPT:FALSE) || $(NEW_CLAUSE)\n</pre>\n\n<p>would result in infinite recursion when the metaknob is used unparsed because the self reference isn't detected as a self reference. see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5963\" onclick=\"get_ticket_and_populate_wrapper('5963'); return false;\" title=\"param self-ref with default broken\">#5963</a></span>\n\n</p><p></p><hr/>\n<em>2016-Oct-13 11:25:46 by johnkn:</em> <br/>\n\nThe default value for a $() expansion may not contain \"\" or () or most other special characters.  so this:\n\n<p></p><pre>   $(HOLD_REASON_CPU_EXCEEDED:\"cpu usage exceeded request_cpus\")\n</pre>\n\n<p>never gets expanded because it doesn't parse as a valid $() expansion.\n</p><hr/>\n<em>2016-Oct-13 11:38:46 by johnkn:</em> <br/>\n\nThose policies will only compose correctly when used in a specific order, which is this:\n\n<p></p><pre>    use POLICY : Always_Run_Jobs\n    use POLICY : Limit_Job_Runtimes\n    use POLICY : Hold_If_Cpus_Exceeded\n    MAX_JOB_RUNTIME = (24*$(HOUR))\n</pre>\n\n<p>Or Alternatively:\n\n</p><p></p><pre>   use POLICY : Always_Run_Jobs, Limit_Job_Runtimes, Hold_If_Cpus_Exceeded\n</pre>\n\n<p></p><hr/>\n<em>2016-Oct-13 18:58:18 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> of <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4243d6189be06a2a93bfbbe9cbf17665dc851cc4\">[49416]</a></span> : change looks good.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5963\" onclick=\"get_ticket_and_populate_wrapper('5963'); return false;\" title=\"param self-ref with default broken\">#5963</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nparam self-ref with default broken</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-13 12:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/563655486b2fae62ca4a87c635413f9802ebe98f\">[49428]</a></span>: rework unsupported $() expansions in some POLICY metaknobs. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5933\" onclick=\"get_ticket_and_populate_wrapper('5933'); return false;\" title=\"cpu_exceeded startd policies are invalid\">#5933</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-12 15:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4243d6189be06a2a93bfbbe9cbf17665dc851cc4\">[49416]</a></span>: Remove line continuation characters from meta-knobs, they don't work there <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5933\" onclick=\"get_ticket_and_populate_wrapper('5933'); return false;\" title=\"cpu_exceeded startd policies are invalid\">#5933</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "todo", "last_change": "2016-Nov-28 16:56", "status": "defer", "created": "2016-Sep-29 18:43", "fixed_version": "2016-Sep-29 18:43", "broken_version": "v080400", "priority": "5", "subsystem": "", "assigned_to": "gthain", "derived_from": "#5250", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}