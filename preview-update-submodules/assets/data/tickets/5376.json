{"id": 5376, "title": "Ticket #5376: Allow involuntary Spot terminations without shrinking ASG.", "description": "<blockquote>\nInvestigate what happens in our current set-up if the Spot instance is involuntarily terminated.  We do <em>not</em> want the size of the ASG to change if we're not shutting down for lack of work.\n\n<p>An involuntary termination should trigger the initscript first; whichever HTCondor shutdown mode the init script uses, the daemon shutdown config knob should use the other, and may need to configure a very short retirement time to make the one behave like the other.</p></blockquote>", "remarks": "<blockquote>\n<div class=\"restricted\"><p><i>An involuntary termination should trigger the initscript first; whichever HTCondor shutdown mode the init script uses, the daemon shutdown config knob should use the other, and may need to configure a very short retirement time to make the one behave like the other.</i></p></div>We shouldn't have to set a very short retirement time if we're only shutting down voluntarily because of a lack of work.  (We may have to give up on a master-triggered lease to allow updating.)\n\n<p>More importantly, MASTER_SHUTDOWN triggers on all shutdowns (that is, including fast ones).  We need some way to determine from the shutdown script which type of shutdown we're doing, or some other way to determine if we should shrink the ASG.  (We should always change the termination type, and should arguably do that on start-up.  It would be nice to be able to do that in the template....)\n\n</p><p></p><hr/>\n<em>2015-Nov-11 14:36:27 by tlmiller:</em> <br/>\n\nI'm checking to see if the 'spot/termination-time' metadata is available after the power off occurs, since that's the actual condition we care about.\n\n<p></p><hr/>\n<em>2015-Nov-17 11:14:18 by tlmiller:</em> <br/>\n\nIt didn't seem to behave reliably, although testing -- especially for Spot -- is hard.  Instead, since what we want to do is distinguish between just HTCondor shutting down and the whole system shutting down, just check -- before we call shutdown ourselves -- to see what the system's runlevel is.  This seems reliable with externally-terminate dedicated instances; tests for Spot proceeding.\n\n<p></p><hr/>\n<em>2015-Dec-10 16:06:22 by tlmiller:</em> <br/>\n\nThis seems to be working pretty well.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-17 14:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0d1f5d4be891a50843f360ed94239e261af599df\">[46283]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5376\" onclick=\"get_ticket_and_populate_wrapper('5376'); return false;\" title=\"Allow involuntary Spot terminations without shrinking ASG.\">#5376</a></span>) Allow instances to log their terminations.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-17 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f39cc3c8ad21a53c0fa98efe3ff90ee43b856fcc\">[46282]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5376\" onclick=\"get_ticket_and_populate_wrapper('5376'); return false;\" title=\"Allow involuntary Spot terminations without shrinking ASG.\">#5376</a></span>) Count machines, not slots, when determining if an annex has been built.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-17 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/76085fe830e7bf47fa26d9d0e9f1a67c619b7a8b\">[46279]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5376\" onclick=\"get_ticket_and_populate_wrapper('5376'); return false;\" title=\"Allow involuntary Spot terminations without shrinking ASG.\">#5376</a></span>) The check to see if the machine is shutting down (rather than just HTCondor) seems more reliable.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-12 13:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/688c4d00f80c4f438ad9013841b1d3260a7c03cc\">[46278]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5376\" onclick=\"get_ticket_and_populate_wrapper('5376'); return false;\" title=\"Allow involuntary Spot terminations without shrinking ASG.\">#5376</a></span>) Only decrease the desired size of the autoscaling group when the instance is not being terminated by Spot.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-12 13:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1848028f1bf4f4930d45d06fb4380ea355a6ce78\">[46254]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5376\" onclick=\"get_ticket_and_populate_wrapper('5376'); return false;\" title=\"Allow involuntary Spot terminations without shrinking ASG.\">#5376</a></span>) Allow users to update the stack and still use the command-line tool.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "experimental", "last_change": "2015-Dec-10 16:06", "status": "resolved", "created": "2015-Nov-09 13:26", "fixed_version": "2015-Nov-09 13:26", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "tlmiller", "derived_from": "#5324", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}