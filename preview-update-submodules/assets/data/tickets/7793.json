{"id": 7793, "title": "Ticket #7793: Group mapping in the negotiator", "description": "<blockquote>\nWhen flocking into a pool, the accounting group configuration of the schedd may not line up with the accounting group setup at the remote pool.  This is because the schedd's group configurations are in the local pools \"namespace\" whereas the flocked-to pool has a distinct namespace.\n\n<p>We should provide the ability for the flocked-to negotatior to \"map\" from the incoming namespace to the local one (the <code>ACCOUNTING_DOMAIN</code>).\n\n</p><p>The <code>ACCOUNTING_DOMAIN</code>, defaulting to <code>UID_DOMAIN</code>, peels off another bit of the functionality of <code>UID_DOMAIN</code> - leaving the latter more focused on OS-level identities (especially after the rework of the <code>User/Owner</code> attributes).\n\n</p><p>I propose using the mapfile mechanism to provide a group prefix for the remote schedd.  That is, suppose the submitter has the accounting principle of <code>bbockelm@example.com</code> flocking to the pool <code>chtc.wisc.edu</code>.  Then, if you have a group mapfile with the following entry:\n\n</p><p></p><div class=\"verbatim\">\n<pre>* example.com remote_group\n</pre></div>\n\n\n<p>The submitter will then be mapped to <code>remote_group.bbockelm@chtc.wisc.edu</code> by the remote pool's negotiator.\n\n</p><p>Further, if we want the schedd admin to control their user priorities (suppose the admin's identity in CHTC is <code>foo@example.com</code>), then <code>foo@example.com</code> should have the ability to set the priority factor for any submitter in the <code>remote_group</code>.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Aug-14 08:44:36 by bbockelm:</em> <br/>\n\nHistorical note: original version of this ticket had the schedd identity mapped instead of taking the namespace approach.  After a few discussions, it became obvious the old approach was incorrect: we don't want to tie together identity of the schedd and accounting here.\n\n<p></p><hr/>\n<em>2020-Aug-20 17:00:59 by gthain:</em> <br/>\n\nThe work generally looks fine, I made some remarks about the code itself.\n\n<p>I'm a bit considered about setting up the fine grained auth for set_prio.  This seems might fiddly, and I doubt an admin is going to get it right the first time.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-04 10:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/158f0c6921ff08239308b3a58d41936775817961\">[61225]</a></span>: Fix warning-as-error warning in previous commit <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7793\" onclick=\"get_ticket_and_populate_wrapper('7793'); return false;\" title=\"Group mapping in the negotiator\">#7793</a></span> Committer: Tim Theisen  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-02 12:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5c7b81e760154925d90277f9d5e9c8ce987def01\">[61197]</a></span>: Fix warning-as-error warning in previous commit <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7793\" onclick=\"get_ticket_and_populate_wrapper('7793'); return false;\" title=\"Group mapping in the negotiator\">#7793</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-21 12:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0d7d0ed6537db5a1947654fc0cd2138231fb8594\">[61195]</a></span>: Touch-up usage of std::vector <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7793\" onclick=\"get_ticket_and_populate_wrapper('7793'); return false;\" title=\"Group mapping in the negotiator\">#7793</a></span> Minor changes suggested by code-review.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-13 23:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/317905f168bb04eae39314f308be1386217c3db9\">[61194]</a></span>: Change mapping inputs to be the accounting domain <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7793\" onclick=\"get_ticket_and_populate_wrapper('7793'); return false;\" title=\"Group mapping in the negotiator\">#7793</a></span> After some discussions, it became apparent that the security subsystem was the wrong place to hang the mapping on. In reality, we want to firm up the concept of an <strong>accounting domain</strong>. That is, the namespace of submitters to a particular negotiator.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-08 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/923adaf50ce712ff4cb2157a7595afd6564a1cdf\">[61192]</a></span>: Map submitters based on schedd identity <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7793\" onclick=\"get_ticket_and_populate_wrapper('7793'); return false;\" title=\"Group mapping in the negotiator\">#7793</a></span> This change allows a negotiator administrator to add a group prefix to submitter names based on the identity of the remote schedd (allowing a flocking schedd to map to the pool's group scheme).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-08 14:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/244f7390536c6b86023afe185f84c5fc513bb8f1\">[61191]</a></span>: Provide fine-grained authz for setpriofactor <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7793\" onclick=\"get_ticket_and_populate_wrapper('7793'); return false;\" title=\"Group mapping in the negotiator\">#7793</a></span> This adds a new map type for the negotiator (`PRIORITY_FACTOR_AUTHORIZATION`) which authorizes an authenticated user to map all groups with a specific prefix. For example, if we have these config knobs:\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Oct-09 10:03", "status": "docpending", "created": "2020-Aug-08 14:49", "fixed_version": "2020-Aug-08 14:49", "broken_version": "", "priority": "4", "subsystem": "DaemonsCM", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelman@morgridge.org", "due_date": ""}