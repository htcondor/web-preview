{"id": 5648, "title": "Ticket #5648: too much time recomputing autoclusters", "description": "<blockquote>\nSome SCHEDD's at the Brookhaven site are spending many MINUTES (sometimes almost an hour) rebuilding the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PrioRec\" title=\"Prio Rec\">PrioRec</a></span> array.   More detailed profiling seems to indicate that the time is being spent in the code that removes jobid's from one autocluster -&gt; jobidset because the code is doing a brute force scan through all of the autoclusters to find the correct one to remove the job from.\n\n<p>This can apparently take up to 15 seconds per-job when the number of autoclusters is quite large. This is unacceptably slow.\n\n</p><p>Fortunately, the index into the autocluster-&gt;jobidset map is known just one layer up in the call tree, so this removal can be hugely improved, and even if the old clusterid is NOT known or is wrong, the jobidset will still be garbage collected correctly by the mark/sweep code.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Apr-27 14:55:17 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: This change avoids searching through all the auto-clusters. I approve this change.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/940/detailed_autocluster_timings.diff\">detailed_autocluster_timings.diff</a>\n15457 bytes added by johnkn on 2016-Apr-26 20:33:43 UTC.\n<br/>\npatch to gather detailed timing data for calulations of the autocluster for a job.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-29 09:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37615d9f2db24906e03452c4f33219fd1ee8f54b\">[48324]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5648\" onclick=\"get_ticket_and_populate_wrapper('5648'); return false;\" title=\"too much time recomputing autoclusters\">#5648</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-29 09:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/72f86a8bb27336778613e64f5f66c395d565b188\">[48323]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5648\" onclick=\"get_ticket_and_populate_wrapper('5648'); return false;\" title=\"too much time recomputing autoclusters\">#5648</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-27 09:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1f6f72b0b67f492510b873ab844001c3c95a47c1\">[48319]</a></span>: fix for bug spending too much time recomputing autoclusters <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5648\" onclick=\"get_ticket_and_populate_wrapper('5648'); return false;\" title=\"too much time recomputing autoclusters\">#5648</a></span>  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Apr-29 09:40", "status": "resolved", "created": "2016-Apr-26 15:32", "fixed_version": "2016-Apr-26 15:32", "broken_version": "v080400", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "johnkn@cs.wisc.edu", "due_date": ""}