{"id": 4111, "title": "Ticket #4111: Non-blocking response to condor_q", "description": "<blockquote>\nBlocking behavior in the schedd when responding to condor_q is quite problematic in terms of scalability.  This led us to forking a child process for handling condor_q -- which can cause significant memory usage for busy schedds.\n\n<p>I propose to add a new protocol for handling condor_q responses which does not block the schedd on writing to the TCP socket (or iterating through large queues).</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Dec-10 08:18:52 by bbockelm:</em> <br/>\n\nImplementation pushed here: <a class=\"external\" href=\"https://github.com/bbockelm/htcondor/tree/non_blocking_condor_q\">https://github.com/bbockelm/htcondor/tree/non_blocking_condor_q</a>\n\n<p></p><hr/>\n<em>2014-Mar-10 10:01:11 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>A couple of comments as I've reviewed this.\n\n</p><p>It would have been better to get smaller chunks to review and merge, even if each chunk isn't useful by itself.  I think we could have gotten the whole patch in earlier in that case.\n\n</p><p>I'd like to see more commenting throughout the code.  I'll be adding these post-merge.\n\n</p><p>The \"-2 means CEDAREWOULDBLOCK\" could certainly use a #define or enum\n\n</p><p>If someone issues a condor_q, and stops the client, I think the schedd will hold on to that socket for an arbitrary amount of time.  Should there be a timeout for this?</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4384\" onclick=\"get_ticket_and_populate_wrapper('4384'); return false;\" title=\"Version check for command QUERY_JOB_ADS off by one\">#4384</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nVersion check for command QUERY_JOB_ADS off by one</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/814/Non-Blocking+condor_q+Design+Document.docx\">Non-Blocking condor_q Design Document.docx</a>\n131865 bytes added by bbockelm on 2013-Dec-10 14:17:13 UTC.\n<br/>\nAttached is a design document for this feature.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-03 10:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7eaf9b076fe240b53fec0b2a9cd2fff75b30b834\">[39849]</a></span>: De-boostification of classad_log.h. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> remove include files that aren't needed.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-24 18:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e372266ac39b79dda39e813ebf0888704052068b\">[39700]</a></span>: condor_q should not try non-forking protocol w/ v8.1.4 schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> The v8.1.4 schedd as released does not understand the new protocol, only v8.1.5 and above has it.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-13 10:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/85322afc79faa1d803f3b670d13eb00a5f8f1cf5\">[39612]</a></span>: Fix small memory leak in condor_q <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-12 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1dabe10bd21eddc7b8f9f9113fce7a6dfd9b2a3c\">[39599]</a></span>: Edit and move version history item for this 8.1.5 feature to the 8.1.5 version history section (was placed in 8.1.4's section), and minor grammar correction on new xquery() Python binding. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-11 12:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1ac5182c27157dddb649d61aa77e11be10c7b3fb\">[39576]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4f289b5b45d2e39ff010dabc2a0a8a916398bdb1\">[39563]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1b7c59233526b102c7d310edc43a4640345bf19c\">[39564]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/34c7bf6899acd0c4097ae6686c0bb2fcff2366c9\">[39565]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fec723c980c93bc0802bf045a8946856a93cf8ec\">[39566]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/844eb6e14e47709b7fd79108e323f8652482f598\">[39567]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e74f80bbb4cc4810f723182a114aa2598a079050\">[39568]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/15a8977748a0afc501eacfc756f04deda6681a1c\">[39569]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3745e2d2c151c02c1329af6828da41c99e1fff42\">[39570]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7af7603c2049ba59842c2ec1bf8daf04b1863221\">[39571]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b8806b65dc7905ab5c826166f232f6d1998017a8\">[39572]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f8c6c983db907e3d55457731e42da1df0fac4bf0\">[39573]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a7bcb79888e02aee2a9f0fda0df453c92824d50c\">[39574]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/80403c80edb8955a8526f1684961fa4b678e2a8c\">[39575]</a></span>, Merge branch 'non_blocking_condor_q' <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 11:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/80403c80edb8955a8526f1684961fa4b678e2a8c\">[39575]</a></span>: Fix memory usage when receiving packet. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> Committer: Greg Thain  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 11:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f8c6c983db907e3d55457731e42da1df0fac4bf0\">[39573]</a></span>: Fix ownership issues which cause segfaults with some condor_q flags. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> Committer: Greg Thain  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 11:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7af7603c2049ba59842c2ec1bf8daf04b1863221\">[39571]</a></span>: Implement non-blocking condor_q. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> Have the condor_q CLI utilize the non-blocking protocol starting with HTCondor 8.1.4. Committer: Greg Thain  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 11:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/15a8977748a0afc501eacfc756f04deda6681a1c\">[39569]</a></span>: Clean up non-blocking mode. Rename python binding to 'xquery', to match python naming conventions. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span>\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 10:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e74f80bbb4cc4810f723182a114aa2598a079050\">[39568]</a></span>: Implement new query command in python. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> Committer: Greg Thain  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 10:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/844eb6e14e47709b7fd79108e323f8652482f598\">[39567]</a></span>: Initial implementation of server-side for a non-blocking condor_q protocol. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> Committer: Greg Thain  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-10 10:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4f289b5b45d2e39ff010dabc2a0a8a916398bdb1\">[39563]</a></span>: Add support for callbacks in the Schedd.query method. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4111\" onclick=\"get_ticket_and_populate_wrapper('4111'); return false;\" title=\"Non-blocking response to condor_q\">#4111</a></span> Committer: Greg Thain  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Apr-01 10:11", "status": "resolved", "created": "2013-Dec-10 08:16", "fixed_version": "2013-Dec-10 08:16", "broken_version": "", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "bbockelm", "derived_from": "#4136", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}