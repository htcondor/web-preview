{"id": 2565, "title": "Ticket #2565: WANT_HOLD doesn't put jobs on hold", "description": "<blockquote>\nThe following configuration in 7.7.1 and 7.7.2 results in the job being evicted and returning to the idle state, rather than going on hold:\n\n<p></p><pre>   PREEMPT = True\n   WANT_HOLD = True\n</pre>\n\n<p>However, WANT_HOLD succeeds if the hold subcode is set to something non-zero:\n   WANT_HOLD_SUBCODE = 1\n\n</p><p>The problem was introduced in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2329\" onclick=\"get_ticket_and_populate_wrapper('2329'); return false;\" title='periodic_remove &amp;&amp; \"\"_hold would inadvertantly cause a release_claim'>#2329</a></span>.  If I revert 3de9e262 and 2e4eddc4, the problem goes away.  The strange dependence on hold subcode comes from this code in UniShadow::holdJob():\n\n</p><p></p><pre>    // exit immediately if the remote side is failing out or has already exited.\n        if ( hold_reason_subcode != 0 ||\n       ( iPrevExitReason != JOB_SHOULD_HOLD &amp;&amp; iPrevExitReason != -1 ))\n    {\n        // don't wait for final update b/c there isn't one.\n        DC_Exit( JOB_SHOULD_HOLD );\n    }\n</pre>\n\n<p>I think this code is using hold_reason_subcode to determine whether this is a remote hold event or periodic_hold.  This is not the right way to differentiate.  In fact, hold_reason_subcode may be non-zero for periodic_hold if the user sets periodic_hold_subcode, so this test can be wrong in both cases.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-21 14:10:09 by tstclair:</em> <br/>\n\ncaused timeouts in on_exit_hold tests.\n\n<p></p><hr/>\n<em>2011-Oct-24 14:11:55 by danb:</em> <br/>\n\nOops.  on_exit_hold was indeed broken.  The shadow just kept running and never exited.  Unreverted and fixed.\n\n<p></p><hr/>\n<em>2011-Nov-03 09:05:27 by tstclair:</em> <br/>\n\nIs this resolved now?\n\n<p></p><hr/>\n<em>2011-Nov-03 10:00:18 by danb:</em> <br/>\n\nYes.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 18:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92cf56e98e9e2b8fcb7df1177036184a37b99250\">[27988]</a></span>: Fix bad memory access in my previous patch for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2565\" onclick=\"get_ticket_and_populate_wrapper('2565'); return false;\" title=\"WANT_HOLD doesn't put jobs on hold\">#2565</a></span> After calling shadow_user_policy.checkAtExit(), the shadow may have been recycled and all the old shadow objects may have been deleted, so don't try to access them!  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-24 14:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c56e3366c99fe25e8b61a10fed4c115ac19b81f4\">[27959]</a></span>: Fixed problem with on_exit_hold introduced by my previous patch for WANT_HOLD. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2565\" onclick=\"get_ticket_and_populate_wrapper('2565'); return false;\" title=\"WANT_HOLD doesn't put jobs on hold\">#2565</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-24 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6d13aecf897cc0f31de209a58e76fb0bca1e2094\">[27958]</a></span>: Revert \"Revert \"Fixed problem with execute side putting jobs on hold with hold subcode of zero. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2565\" onclick=\"get_ticket_and_populate_wrapper('2565'); return false;\" title=\"WANT_HOLD doesn't put jobs on hold\">#2565</a></span>\"\" This reverts commit 841a02fc683ecabcb83c27da1972a8b45d0d56a5.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-21 13:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/841a02fc683ecabcb83c27da1972a8b45d0d56a5\">[27940]</a></span>: Revert \"Fixed problem with execute side putting jobs on hold with hold subcode of zero. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2565\" onclick=\"get_ticket_and_populate_wrapper('2565'); return false;\" title=\"WANT_HOLD doesn't put jobs on hold\">#2565</a></span>\" This reverts commit e3bccbb539ca5fb1aa3af8749773842d8f903df7.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-20 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a088b462942deb38e34f09493a07f4572a355bb2\">[27929]</a></span>: Documented fix for execute side putting jobs on hold with a hold subcode of zero. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2565\" onclick=\"get_ticket_and_populate_wrapper('2565'); return false;\" title=\"WANT_HOLD doesn't put jobs on hold\">#2565</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-20 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e3bccbb539ca5fb1aa3af8749773842d8f903df7\">[27928]</a></span>: Fixed problem with execute side putting jobs on hold with hold subcode of zero. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2565\" onclick=\"get_ticket_and_populate_wrapper('2565'); return false;\" title=\"WANT_HOLD doesn't put jobs on hold\">#2565</a></span> This affects, for example, WANT_HOLD when the subcode is unset. It was broken since 7.7.1.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-03 10:00", "status": "resolved", "created": "2011-Oct-19 15:59", "fixed_version": "2011-Oct-19 15:59", "broken_version": "v070701", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "#2329", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tstclair@redhat.com, dan@hep.wisc.edu", "due_date": ""}