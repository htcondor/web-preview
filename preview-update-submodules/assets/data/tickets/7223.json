{"id": 7223, "title": "Ticket #7223: CCB interferes with new negotiator auth sessions", "description": "<blockquote>\nWhen we create a pre-negotiated security session in the negotiator from the schedd's capability -- and the CCB is used -- the negotiator creates a security session with this key.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">&lt;192.168.2.85:9618?CCBID=XYZ.XYZ.XYZ.XYZ:9618%3faddrs%3dXYZ.XYZ.XYZ.XYZ-9618%26alias%3dflock.example.com#25188186212331&amp;PrivNet=condor-login-56c47bcc47-8vr5n&amp;addrs=192.168.2.85-9618&amp;alias=condor-login-56c47bcc47-8vr5n&amp;noUDP&amp;sock=schedd_35_95e7_2&gt;\n</pre></div>\n\n\n<p>A second later, the negotiator tries to contact the schedd.  The daemon client code causes the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SecMan\" title=\"Sec Man\">SecMan</a></span> code to look for a session named this:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">&lt;192.168.2.85:9618?CCBID=XYZ.XYZ.XYZ.XYZ:9618%3faddrs%3dXYZ.XYZ.XYZ.XYZ-9618%26alias%3dflock.example.com#25188186212331&amp;addrs=192.168.2.85-9618&amp;alias=condor-login-56c47bcc47-8vr5n&amp;noUDP&amp;sock=schedd_35_95e7_2&gt;\n</pre></div>\n\n\n<p>(Note that the <code>PrivNet</code> portion is missing)\n\n</p><p>Since the key is different, the cache lookup fails.  An authorization handshake is tried and - in this case - fails.\n\n</p><p>I <strong>think</strong> this is a sinful string issue, so assigning to Todd Miller.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Aug-30 10:00:32 by bbockelm:</em> <br/>\n\nUpdated the \"broken version\" to 8.9.3, given that this feature isn't out yet.\n\n<p>Note that this only affects things when the <strong>schedd</strong> is behind the CCB.  I suspect that's an uncommon setup as it requires the startds to be on the public internet.  The site that noticed the bug ultimately wasn't really affected because they had worker nodes behind the NAT and turned off the CCB for the schedd.\n\n</p><p></p><hr/>\n<em>2019-Aug-30 13:59:11 by tlmiller:</em> <br/>\n\nI think it's a misfeature in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonClient\" title=\"Daemon Client\">DaemonClient</a></span> --\n\n<p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/master/src/condor_daemon_client/daemon.cpp#L2110\">https://github.com/htcondor/htcondor/blob/master/src/condor_daemon_client/daemon.cpp#L2110</a>\n\n</p><p>-- which only bites us just now because we didn't use to use full Sinfuls for the session IDs (which caused other problems).\n\n</p><p>I'm guessing the easiest patch would be strip the <code>Priv*</code> attributes from the Sinful before using it as a session key.\n</p><hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-May-11 15:20:14 by tlmiller:</em> <br/>\n\nResolving as duplicate of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7582\" onclick=\"get_ticket_and_populate_wrapper('7582'); return false;\" title=\"SINful mangled when flocking\">#7582</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2020-May-11 15:20", "status": "resolved", "created": "2019-Aug-29 16:49", "fixed_version": "2019-Aug-29 16:49", "broken_version": "v080903", "priority": "2", "subsystem": "CCB", "assigned_to": "tlmiller", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelman@morgridge.org tannenba@cs.wisc.edu tlmiller@cs.wisc.edu dabrown@syr.edu zmiller@cs.wisc.edu", "due_date": ""}