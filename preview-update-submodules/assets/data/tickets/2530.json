{"id": 2530, "title": "Ticket #2530: Xen/KVM modified disk images not transferred back to submit machine", "description": "<blockquote>\nWhen a Xen or KVM VM shuts down and the vm-gahp's call to virDomainLookupByName() fails with error VIR_ERR_NO_DOMAIN, the vm-gahp removes all files in the execute directory when it shuts down. This means that the modified disk images don't get transferred back to the submit machine.\n\n<p>Should the vm-gahp ever remove all files in the execute directory? The starter will decide if files should be transferred back to the submit machine and clean up the execute directory.\n\n</p><p>This was reported by the BNL ATLAS group. Another thing they noticed is that should_transfer_files and when_to_transfer_output aren't consulted by condor_submit for Xen jobs. It even prints warnings about not consulting them.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-12 15:26:34 by tstclair:</em> <br/>\n\nThe patch looks ok, but what is the root for this use case.\n\n<p></p><hr/>\n<em>2011-Oct-12 15:36:25 by jfrey:</em> <br/>\n\nThe BNL ATLAS user was seeing his VM jobs complete after experiencing the VIR_ERR_NO_DOMAIN case in VirshType::Status(). The jobs enter the completed state and leave the queue, but the vm-gahp deletes the disk image files.\n\n<p>Are you saying that VIR_ERR_NO_DOMAIN case shouldn't occur when a vm shuts itself down? That it's a sign of a failure? If so, we can't treat it as a successfully completed job. We need to return it to idle status to rerun or put it on hold.\n\n</p><p>I have a call with the user this afternoon. I'll confirm whether his vms shut themselves down after completing their work.\n\n</p><p></p><hr/>\n<em>2011-Oct-12 16:14:15 by tstclair:</em> <br/>\n\nMy mistake offset while reading.  That is a normal workflow.\n\n<p></p><hr/>\n<em>2011-Oct-12 16:42:35 by jfrey:</em> <br/>\n\nI am leery of marking a vm as done in the VIR_ERR_SYSTEM_ERROR case. We may need to handle that case differently.\n\n<p></p><hr/>\n<em>2011-Oct-17 16:56:39 by jfrey:</em> <br/>\n\nThe problem with should_transfer_files and when_to_transfer_output is in a child ticket (<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=2556\" onclick=\"get_ticket_and_populate_wrapper('2556'); return false;\" title=\"File transfer attributes ignored for vm universe\">#2556</a></span>).</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=2556\" onclick=\"get_ticket_and_populate_wrapper('2556'); return false;\" title=\"File transfer attributes ignored for vm universe\">#2556</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFile transfer attributes ignored for vm universe</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/474/vm.patch\">vm.patch</a>\n1258 bytes added by jfrey on 2011-Oct-07 19:40:26 UTC.\n<br/>\nPatch to stop vm-gahp from removing all files when a libvirt vm shuts down.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-12 11:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4a865024634f6870c5212d9570a75c0b3994b43d\">[27783]</a></span>: Xen/KVM modified disk images not transferred back to submit machine <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2530\" onclick=\"get_ticket_and_populate_wrapper('2530'); return false;\" title=\"Xen/KVM modified disk images not transferred back to submit machine\">#2530</a></span> When a running Xen or KVM vm is reported 'not found' by libvirt, the vm-gahp reported the vm as completed, but ended up removing all files in the execute directory. It no longer removes the files. ===VersionHistory:Complete===\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Oct-17 16:56", "status": "resolved", "created": "2011-Oct-07 14:36", "fixed_version": "2011-Oct-07 14:36", "broken_version": "v070600", "priority": "2", "subsystem": "VM", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": "20111014"}