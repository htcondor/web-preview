{"id": 4489, "title": "Ticket #4489: Collector runs very slowly on 3.14 Linux kernels", "description": "<blockquote>\nIn the collector, in order to improve performance, we try to increase the size of the per-socket TCP send and receive buffers, with the setsockopt system call.  However, there's no guarantee that the OS will honor a request of any given size, so what condor does on startup is to progressively request an ever increasing buffer size, starting at 1024 bytes (!), going up to the desired value of 500k.  Every time the code tries to set the buffer, we check what it was set to. HTCondor stops trying to increase the size when either we hit the required size, or the system isn't increasing the buffer size since the last request.\n\n<p>Apparently, on the 3.14 kernel, the kernel doesn't support setting the send buffer less than about 4k bytes, so our initial two attempts to set it to 1k and 2k both result in setting it to 4k. Condor notices that the size isn't going up, and stops trying, even though the actual size is bigger than the requested size.   Oddly, we follow the same algorithm for the receive buffer, but there's no kernel surprises there.\n\n</p><p>SO, the collector ends up with a TCP send buffer smaller than the usual cedar packet size, which causes the collector to run in lock-step with its clients, and then things get very slow indeed.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Aug-06 16:32:36 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Before the patch, <code>set_os_buffers(X)</code> would set the size of UDP/TCP buffers to the greater of either a) the parameter given (X),  or b) to the largest value allowed by the OS.  The patch got rid of clause (b).  This is a problem because <code>set_os_buffers()</code> is used not only by TCP, but also by UDP to set the incoming collector UDP buffers very large (attempts to go with 10MB by default).  Patch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e78a2a7d29d7a94df9d7d43d91b4feb210bf7a5a\">[40769]</a></span> effectively gets rid of the large collector UDP incoming buffer by default on many platforms, so I reverted it.  Instead, I made a patch that keeps the original ramp-up behavior of <code>set_os_buffers()</code>, but a) fixes the specific problem described above on the 3.14 kernels, and b) ramps up 4k at a time instead of just 1k at a time.  Another commit also puts <code>COLLECTOR_SOCKET_BUFSIZE</code> into the param table instead of the never-used-anywhere <code>NEGOTIATOR_SOCKET_BUFSIZE</code>.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-06 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b8dab7754c2bc27402717323265599e4d11cb33d\">[40872]</a></span>: Add COLLECTOR_SOCKET_BUFSIZE to param table. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4489\" onclick=\"get_ticket_and_populate_wrapper('4489'); return false;\" title=\"Collector runs very slowly on 3.14 Linux kernels\">#4489</a></span> Also remove NEGOTIATOR_SOCKET_BUFSIZE from param table, which was never being used.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-06 16:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54de959766af084539a6ebb8f82294f4435c98ea\">[40871]</a></span>: Fix bug setting socket buffer sizes on newer linux kernels. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4489\" onclick=\"get_ticket_and_populate_wrapper('4489'); return false;\" title=\"Collector runs very slowly on 3.14 Linux kernels\">#4489</a></span> The problem was on the 3.14 kernel, the kernel doesn't support setting the send buffer less than about 4k bytes, so our initial attempts to set it to 1k and 2k both result in setting it to 4k. Condor notices that the size isn't going up,\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-06 13:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a9dd29dcf968c20463c983bbc688708a723800b8\">[40869]</a></span>: Revert \"Don't try to ramp up TCP send buffer sizes <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4489\" onclick=\"get_ticket_and_populate_wrapper('4489'); return false;\" title=\"Collector runs very slowly on 3.14 Linux kernels\">#4489</a></span>\" This reverts commit e78a2a7d29d7a94df9d7d43d91b4feb210bf7a5a.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-31 11:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/326412f2d56df4e38c5cbf61fcee4a2d34603459\">[40805]</a></span>: edit 8.2.2 version history item <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4489\" onclick=\"get_ticket_and_populate_wrapper('4489'); return false;\" title=\"Collector runs very slowly on 3.14 Linux kernels\">#4489</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-29 11:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2be6cafdfb8bf17dd845de0b5306a9b7854673aa\">[40792]</a></span>: Document <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4489\" onclick=\"get_ticket_and_populate_wrapper('4489'); return false;\" title=\"Collector runs very slowly on 3.14 Linux kernels\">#4489</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-28 17:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e78a2a7d29d7a94df9d7d43d91b4feb210bf7a5a\">[40769]</a></span>: Don't try to ramp up TCP send buffer sizes <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4489\" onclick=\"get_ticket_and_populate_wrapper('4489'); return false;\" title=\"Collector runs very slowly on 3.14 Linux kernels\">#4489</a></span> This fails in odd ways on new kernels. Just try to set it to the requested value.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-06 17:02", "status": "defer", "created": "2014-Jul-28 16:46", "fixed_version": "2014-Jul-28 16:46", "broken_version": "v080000", "priority": "5", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": "20140728"}