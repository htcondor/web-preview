{"id": 7557, "title": "Ticket #7557: Log mapping failures when the URL contains a trailing slash", "description": "<blockquote>\nIf the authenticated identity field of a SCITOKENS entry in the condor_mapfile ends in a slash, e.g.:\n\n<p></p><div class=\"verbatim\">\n<pre>SCITOKENS https://jobsub.fnal.gov/ dteam\n</pre></div>\n\n\n<p>Authentication will succeed with a valid token but mapping will fail:\n\n</p><p></p><div class=\"verbatim\">\n<pre>03/12/20 13:03:37 (D_ALWAYS:2) MapFile: Canonicalization File: method='SCITOKENS' principal='https://jobsub.fnal.gov/' canonicalization='dteam'\n...\n03/12/20 13:39:15 (D_SECURITY) SSL authentication succeeded to https://jobsub.fnal.gov,dbox@fnal.gov\n03/12/20 13:39:15 (D_SECURITY) AUTHENTICATE: do_authenticate is 0.\n03/12/20 13:39:15 (D_SECURITY) AUTHENTICATE: auth_status == 256 (SCITOKENS)\n03/12/20 13:39:15 (D_SECURITY) Authentication was a Success.\n03/12/20 13:39:15 (D_SECURITY) ZKM: setting default map to scitokens@unmapped\n03/12/20 13:39:15 (D_SECURITY) ZKM: name to map is 'https://jobsub.fnal.gov,dbox@fnal.gov'\n03/12/20 13:39:15 (D_SECURITY) ZKM: pre-map: current user is 'scitokens'\n03/12/20 13:39:15 (D_SECURITY) ZKM: pre-map: current domain is 'unmapped'\n03/12/20 13:39:15 (D_SECURITY) ZKM: map file already loaded.\n03/12/20 13:39:15 (D_SECURITY) ZKM: attempting to map 'https://jobsub.fnal.gov,dbox@fnal.gov'\n03/12/20 13:39:15 (D_SECURITY) ZKM: 1: attempting to map 'https://jobsub.fnal.gov,dbox@fnal.gov'\n03/12/20 13:39:15 (D_SECURITY) ZKM: 2: mapret: 1 included_voms: 0 canonical_user:\n03/12/20 13:39:15 (D_ALWAYS:2) ZKM: did not find user .\n03/12/20 13:39:15 (D_SECURITY) ZKM: post-map: current user is 'scitokens'\n03/12/20 13:39:15 (D_SECURITY) ZKM: post-map: current domain is 'unmapped'\n03/12/20 13:39:15 (D_SECURITY) ZKM: post-map: current FQU is 'scitokens@unmapped'\n</pre></div>\n\n\n<p>We should log to <code>D_ALWAYS</code> whenever a mapping fails that would otherwise succeed due to a trailing slash in the mapfile.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Mar-12 14:43:04 by bbockelm:</em> <br/>\n\nDumb question - does it work without the trailing slash?\n\n<p></p><hr/>\n<em>2020-Mar-12 14:47:45 by zmiller:</em> <br/>\n\nYeah, there is this line:\n<div class=\"code\">\n<pre class=\"code\">ZKM: name to map is 'https://jobsub.fnal.gov,dbox@fnal.gov'\n</pre></div>\n\nand there is no trailing slash in there.  So I would not expect it to match.  As BBock suggested, you probably just want to remove it.\n\n<p></p><hr/>\n<em>2020-Mar-12 15:02:58 by zmiller:</em> <br/>\n\nSpoke with BLin in person.  Proposed solution is kludgey but not difficult:  If the method is SCITOKENS (only) and the pattern ends with a slash, remove it before attempting to map.  There would be a knob to enable this behavior, because silently changing it without a way to undo that is Not Cool (TM)\n\n<p></p><hr/>\n<em>2020-Mar-12 15:10:50 by blin:</em> <br/>\n\nYeah, it does work without the trailing slash. Zach and I just discussed it and the annoying thing is that copy-pasting the issuer URL from my browser yields a trailing slash and it's easy to overlook this minor difference.\n\n<p>Though as Zach said, we'd have to add a knob for this, and the resulting behavior could be equally confusing for users. So this is probably best solved with clear documentation and examples instead of more code.\n\n</p><p></p><hr/>\n<em>2020-Mar-12 18:13:07 by bbockelm:</em> <br/>\n\nHm.  Per RFC 7519, the issuer name is supposed to a <code>StringOrUri</code> type.  The definition of <code>StringOrUri</code> is:\n\n<p></p><div class=\"verbatim\">\n<pre>   StringOrURI\n      A JSON string value, with the additional requirement that while\n      arbitrary string values MAY be used, any value containing a \":\"\n      character MUST be a URI [RFC3986].  StringOrURI values are\n      compared as case-sensitive strings with no transformations or\n      canonicalizations applied.\n</pre></div>\n\n\n<p>So, despite the URLs being clearly equivalent (see section 6 of RFC 3986), the JWT definition says explicitly not to do this.\n\n</p><p>Given there's an explicit message about this, I would prefer to have a <code>D_ALWAYS</code> warning whenever there's a match for everything modulo the trailing slash.\n\n</p><p></p><hr/>\n<em>2020-Jul-29 10:01:51 by zmiller:</em> <br/>\n\nIf the entry contains a trailing slash, we complain in the log file.\n\n<p>If <code>SEC_SCITOKENS_ALLOW_EXTRA_SLASH</code> is true, we allow the mapping to succeed anyway.  Otherwise it fails.  Per BrianB's comment above, this technically shouldn't be a successful mapping, so the default for <code>SEC_SCITOKENS_ALLOW_EXTRA_SLASH</code> is false.\n\n</p><p></p><hr/>\n<em>2020-Oct-25 10:50:21 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: This change does not check the result of mapping with the trailing slash. It complains about the trailing slash whether or not the mapping succeeded and whether or not there was actually was an trailing slash.\n\n<p>Zach, please create a JIRA ticket to fix that up and document the knob.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Oct-25 13:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/366c4e879cd04402e2b04bc28015842370d0f1f5\">[61558]</a></span>: Final build for 8.9.9 Includes version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7681\" onclick=\"get_ticket_and_populate_wrapper('7681'); return false;\" title=\"Use externals from EPEL for RPMs\">#7681</a></span>, <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7557\" onclick=\"get_ticket_and_populate_wrapper('7557'); return false;\" title=\"Log mapping failures when the URL contains a trailing slash\">#7557</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7843\" onclick=\"get_ticket_and_populate_wrapper('7843'); return false;\" title=\"Add the ability to specify a custom remote Bosco install dir\">#7843</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-29 09:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/419028f6ec1bd3da63327e2e757140cabbae9876\">[60266]</a></span>: Assist admins using SCITOKENS by pointing out when their CERTIFICATE_MAPFILE entries contain a trailing '/'. Also just allow the mapping to succeed if SEC_SCITOKENS_ALLOW_EXTRA_SLASH is set to true. <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7557\" onclick=\"get_ticket_and_populate_wrapper('7557'); return false;\" title=\"Log mapping failures when the URL contains a trailing slash\">#7557</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Oct-25 10:50", "status": "docpending", "created": "2020-Mar-12 14:39", "fixed_version": "2020-Mar-12 14:39", "broken_version": "v080905", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#4555", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu, bbockelman@morgridge.org, tannenba@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}