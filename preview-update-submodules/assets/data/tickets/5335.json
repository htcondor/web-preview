{"id": 5335, "title": "Ticket #5335: Make CredD non-blocking for STORE_CRED", "description": "<blockquote>\nCurrently the CredD blocks after doing a store cred, SIGHUPping the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CredMon\" title=\"Cred Mon\">CredMon</a></span>, and polling for the existence of the .cc file.  For scalability, the Credd must continue to service commands while this is happening.</blockquote>", "remarks": "<blockquote>\n<em>2016-Oct-20 14:11:03 by jfrey:</em> <br/>\n\nWe also need to change condor_submit to talk to the credd before connecting to the schedd. Otherwise, only one condor_submit can talk to the credd at a time.\n\n<p>This requires that condor_submit talk to the credd regardless of how send_credential is set in the submit file. Thus, we propose eliminating the send_credential submit macro. Condor_submit would always generate a credential and send it to the credd if SEC_CREDENTIAL_PRODUCER is set. Condor_submit would also still set <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SendCredential\" title=\"Send Credential\">SendCredential</a></span> in the job ad (if it talks to the credd), as this tells the starter whether it needs to fetch the credential.\n\n</p><p></p><hr/>\n<em>2016-Nov-21 13:56:09 by zmiller:</em> <br/>\n\nNot adding documentation or version history for this since it's updating brand-new code and highly CERN-specific.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6d4fbe4385beef778d2ba29fe866d6b0f414c0a9\">[49486]</a></span>: fix misplaced #endif that broke windows build. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0af6206539057ce1c135bb6b133f65794389473d\">[49485]</a></span>: Fix potential param leaks by using auto_free_ptr. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f92a71663fcd142f4bb3942d4fc86e18b539cc12\">[49483]</a></span>: Fix some ifdefery. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 14:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/22bc92e4f67034196969c6fbb4cc8b9288124109\">[49482]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span> make return type of credmon_poll_continue match the prototype in the header file.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e406cf4b94bfaf669d9e15986b5f6e0a1d9fcb9e\">[49481]</a></span>: Duplicate the Stream (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span>) since daemoncore will otherwise clean it up after calling the command handler. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 14:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/19ff8e6242dbc484bdf4235c350e2514f5185c97\">[49480]</a></span>: fix previous commit to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span> to build on Windows.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 13:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0e907cc11029361ea42dc3caa98de66655ac01d5\">[49479]</a></span>: Add debug messages and clean up warnings. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-27 12:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8c1c337d13ed099dfc11f764f730c505f61f9a49\">[49478]</a></span>: Pass necessary state to timer handler. Does not currently work for the Stream member. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-20 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c048b3b6fa9905a49def467fd4f6cf3a73cede29\">[49455]</a></span>: Remove send_credential submit file attribute. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span> The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SendCredential\" title=\"Send Credential\">SendCredential</a></span> job ad attribute is still present, and is set to True in condor_submit if a credential is sent to the credd.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-20 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8da96151004ebf6539e4d734e80217dfaa2233bc\">[49454]</a></span>: condor_submit should do STORE_CRED before contacting schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span> Having condor_submit contact the credd while connected to the schedd kills the scalability gains we want. Now, condor_submit always contacts the credd before it contacts the schedd, regardless of how send_credential is set.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-13 11:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1e07523e757c042ca2c3400af7e8b9c75ad8040b\">[49426]</a></span>: Snapshot of work done so far on <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5335\" onclick=\"get_ticket_and_populate_wrapper('5335'); return false;\" title=\"Make CredD non-blocking for STORE_CRED\">#5335</a></span> (non-blocking store cred).  (By zmiller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Nov-21 13:58", "status": "resolved", "created": "2015-Oct-22 16:47", "fixed_version": "2015-Oct-22 16:47", "broken_version": "", "priority": "1", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#5272", "creator": "zmiller", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "zmiller@cs.wisc.edu, tannenba@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}