{"id": 6883, "title": "Ticket #6883: condor_gpu_discovery doesn't work with CUDA 10", "description": "<blockquote>\nwith CUDA version 10, NVIDIA has changed the cuda runtime API in a way that is incompatible with condor_gpu_discovery, so the wrong values get reported for some attributes of the GPU.\n\n<p>The workaround for users for now is to use version 9 of the libraries. Michael Pelletier suggests: </p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  In the meantime, you can also install the 9.2 release, and then set up the library path for condor_gpu_discovery to refer to /usr/local/cuda-9.2 instead of /usr/local/cuda, and that should get you through until they come out with an update for CUDA 10 support.</td></tr></tbody></table></div>\n\n\n<p>The main cause of the problem appears to be that NVIDIA changed the <code>cudeDeviceProp</code> structure, but did not change the name of the API that populates it - And the structure is not versioned in any way.  The API that populates it will just assume it was passed a structure of the size and layout that it was built for.\n\n</p><p>In the current condor_gpu_discovery, the NVIDIA CUDA 10 runtime is just writing past the end of the structure that we pass it.  Example code from NVIDIA completely ignores this issue, so at present we do not know what to check before allocating the structure to pass to the API, we might have to do some sort of heuristic check of the populated structure to figure out what version the NVIDIA libararies think they populated.\n\n</p><p><strong>update</strong>\nWe have decided to use the runtime version to decide whether to use the Cuda10 or pre-Cuda10 version of the structure.  We have also decided to prefer the driver library over the runtime library, which is a reverse of the previous preference.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Jan-28 16:18:35 by tannenba:</em> <br/>\n\nShouldn't this ticket be targeted for the v8.8.x series since it is essentially a porting issue, not new functionality?\n\n<p></p><hr/>\n<em>2019-Jan-29 11:37:28 by tlmiller:</em> <br/>\n\nAdding myself to the notify list in case we need to make similar changes to the monitor.\n\n<p></p><hr/>\n<em>2019-Jan-29 13:33:56 by johnkn:</em> <br/>\n\nAfter further investigation, it seems like the best way forward is to stop using the cuda runtime to do GPU discovery, and instead use libnvcuda (the driver library).  We can get all of the information we need except the runtime version from libnvcuda, and the API for that will likely be more stable.\n\n<p></p><hr/>\n<em>2019-Jan-30 10:22:38 by mvpelletier:</em> <br/>\n\nI just made an inquiry with Craig Fullman, Raytheon's NVIDIA account exec. I'll update the ticket as soon as I hear back from him.\n\n<p></p><hr/>\n<em>2019-Feb-06 12:47:01 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Found a typo in condor_gpu_discovery.cpp on line 80 -- the second domain should have a square bracket to the right.  But that covers it.  (I detect a lot of opportunities for more general code clean-up, but that's another ticket.)</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nGPU utilization can use different device index than GPU discovery</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/65300c43a4ef65a699fd4b63007b3553942fcba1\">[56168]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6883\" onclick=\"get_ticket_and_populate_wrapper('6883'); return false;\" title=\"condor_gpu_discovery doesn't work with CUDA 10\">#6883</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-06 09:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4632ffddc4803ac70ad69a5dec434ad48592d297\">[56130]</a></span>: fix to make GPU discovery work with CUDA10 as well as with earlier versions. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6883\" onclick=\"get_ticket_and_populate_wrapper('6883'); return false;\" title=\"condor_gpu_discovery doesn't work with CUDA 10\">#6883</a></span> this commit also makes gpu_utilization build on Windows. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Feb-12 15:00", "status": "resolved", "created": "2019-Jan-28 11:46", "fixed_version": "2019-Jan-28 11:46", "broken_version": "v080800", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, michael.v.pelletier@raytheon.com", "due_date": ""}