{"id": 3527, "title": "Ticket #3527: condor_negotiator wegding when MPI jobs are in queue", "description": "<blockquote>\nI apologize in advance for lacking all the details you might need to debug this, but Greg encouraged me to submit anyway.\n\n<p>What I know is simply this: when one specific user submitted a specific batch of MPI jobs, the negotiator reliably and repeatedly wedged and had to be killed by the master (~10 times/day).  When the jobs were removed, this stopped happening.  It seemed 100% correlated.\n\n</p><p>Prior to the Negotiator wedging there is nothing visibly amiss in its own log.  Then the Master reports the following:\n\n</p><p></p><div class=\"verbatim\">\n<pre>02/20/13 11:13:16 ERROR: Child pid 9024 appears hung! Killing it hard.\n02/20/13 11:13:16 DaemonCore: pid 9024 exited with status 9, invoking reaper 1 &lt;Daemons::DefaultReaper()&gt;\n02/20/13 11:13:16 The NEGOTIATOR (pid 9024) was killed because it was no longer responding\n02/20/13 11:13:16 Sending obituary for \"/usr/sbin/condor_negotiator\"\n02/20/13 11:13:26 restarting /usr/sbin/condor_negotiator in 10 seconds\n02/20/13 11:13:26 DaemonCore: return from reaper for pid 9024\n02/20/13 11:13:36 Started DaemonCore process \"/usr/sbin/condor_negotiator\", pid and pgroup = 11851\n</pre></div>\n\n\n<p>Just before asking the user to remove the jobs, I enabled D_FULLDEBUG and D_NETWORK and will send the resulting <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NegotiatorLog\" title=\"Negotiator Log\">NegotiatorLog</a></span> via email.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Mar-11 12:38:29 by gthain:</em> <br/>\n\nSo the issue looks straightforward on the surface -- the user has submitted at least 100 8-way parallel jobs, and the negotiator is in the process of giving out 800 matches for the jobs in one negotiation cycle, and this is taking over an hour, and so the negotiator is not responsive to the master, and the master kills it.\n\n<p></p><hr/>\n<em>2013-Mar-11 14:38:08 by pfc:</em> <br/>\n\nSorry, help me understand how this is resolved.  Is the answer:\n\n<p>* Condor can't and won't handle 100 8-way MPI jobs being submitted at once so tell users to never do that (\"Doctor, my hurts when I bang it against the wall\")?\n\n</p><p>* Increase the speed with which the negotiator hands out these matches (how?)\n\n</p><p>* Throttle the negotiation process somehow when submit lots of MPI jobs (how?)\n\n</p><p>* Something else?\n\n</p><p></p><hr/>\n<em>2013-Mar-11 15:00:00 by gthain:</em> <br/>\n\nSorry about that -- we had talked about this here, but I guess I never sent you an update.\n\n<p>To fix the immediate problem, let's turn on the negotiator throttles -- let's set\n\n</p><p>NEGOTIATOR_MAX_TIME_PER_PIESPIN\nand\nNEGOTIATOR_MAX_TIME_PER_SUBMITTER\n\n</p><p>down to something like 40 minutes.  (values in seconds.)\n\n</p><p></p><hr/>\n<em>2013-Mar-11 15:12:17 by pfc:</em> <br/>\n\nUh... I just tried to change this, and then checked whether it \"took\" or not, and see the following (from our central manager host):\n\n<p></p><div class=\"verbatim\">\n<pre>[root@condor ~]# condor_config_val -name negotiator NEGOTIATOR_MAX_TIME_PER_PIESPIN -config -v\nConfiguration source:\n        /etc/condor/condor_config\nLocal configuration source:\n        /etc/condor/condor_config.local\n\nNEGOTIATOR_MAX_TIME_PER_PIESPIN: 31536000\n  Defined in '/etc/condor/condor_config', line 2328.\n\n[root@condor ~]# condor_config_val NEGOTIATOR_MAX_TIME_PER_PIESPIN -config -v\nConfiguration source:\n        /etc/condor/condor_config\nLocal configuration source:\n        /etc/condor/condor_config.local\n\nNEGOTIATOR_MAX_TIME_PER_PIESPIN: 2400\n  Defined in '/etc/condor/condor_config', line 2328.\n</pre></div>\n\n\n<p>Note the different answers depending on whether condor_config_val is looking in the config file, or asking the negotiator directly, despite the config filenames and line numbers being identical.\n\n</p><p></p><hr/>\n<em>2013-Mar-11 15:15:00 by pfc:</em> <br/>\n\nI should add that I did a <div class=\"code\">\n<pre class=\"code\">condor_restart -negotiator</pre></div>\n after making the config change, and confirmed that the negotiator restarted.\n\n<p></p><hr/>\n<em>2013-Mar-11 15:18:59 by pfc:</em> <br/>\n\nOkay, I just added D_CONFIG to NEGOTIATOR_DEBUG and confirmed that the 2400 second changes <em>did</em> take effect.\n\n<p>If I'm not misunderstanding something and the \"condor_config_val -negotiator\" issue above is indeed a bug, then I'll shunt it to another ticket and we can proceed to focus on the issue at hand here.\n</p><hr/>\n<em>2013-Mar-28 17:16:00 by johnkn:</em> <br/>\n\nBulk change of target version from v070808 to v070809 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2013-Apr-08 13:21:14 by pfc:</em> <br/>\n\nThis is happening again even with NEGOTIATOR_MAX_TIME_PER_PIESPIN and NEGOTIATOR_MAX_TIME_PER_SUBMITTER set to 2400 seconds.\n\n<p>This is a big problem as it prevents us from running our MPI workflows without disabling the negotiator... any other solutions?\n\n</p><p></p><hr/>\n<em>2013-May-23 11:01:51 by gthain:</em> <br/>\n\nOn the LIGO call, we recommended lowering the timeout from 2400 to something like five minutes, which should fix the problem -- have we see any further occurances since?\n\n<p></p><hr/>\n<em>2013-Jun-03 16:03:58 by pfc:</em> <br/>\n\nNot sure why this is marked pending with a an upcoming version references in the Fixed field, as Greg's suggestion did not resolve the problem but Greg would like more information so I need to reproduce the issue (ideally with him watching live).  It might be a while until it's safe for me to do this, since it's destructive to the pool.  In the meantime, this issue should remain open.\n\n<p></p><hr/>\n<em>2013-Jul-24 11:08:05 by pfc:</em> <br/>\n\nOur pool is now configured with:\n<div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_MAX_TIME_PER_PIESPIN = 15 * $(MINUTE)\nNEGOTIATOR_MAX_TIME_PER_SUBMITTER = 15 * $(MINUTE)\n</pre></div>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3802\" onclick=\"get_ticket_and_populate_wrapper('3802'); return false;\" title=\"8.0.0 negotiator hanging/killed\">#3802</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n8.0.0 negotiator hanging/killed</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2015-Sep-22 14:53", "status": "defer", "created": "2013-Mar-06 13:03", "fixed_version": "2013-Mar-06 13:03", "broken_version": "v070807", "priority": "5", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "", "creator": "pfc", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pfcouvar@syr.edu, tstclair@redhat.com, johnkn@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}