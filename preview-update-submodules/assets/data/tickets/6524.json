{"id": 6524, "title": "Ticket #6524: startd may delete a starter object before the starter is reaped.", "description": "<blockquote>\nWhile working on <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6500\" onclick=\"get_ticket_and_populate_wrapper('6500'); return false;\" title=\"startd should retry deletion of sandbox until it succeeds\">#6500</a></span>, I discovered a race condition in the STARTD whereby a claim object can be deleted before the condor_starter corresponding to the Starter c++ object that it tracks has been reaped.\n\n<p>When this happens, the STARTD never attempts to delete the job sandbox, and also does not add the sandbox to the deletion retry list. (because Starter::exited is never called, and that is where that code lives)\n\n</p><p>The STARTD should be changed so that the instance of the Starter class is not deleted until the condor_starter has been reaped.  This will involve making the Starter object not owned by the Claim object, but instead have independent lifetime, with the pid of the condor_starter being used to lookup the Starter object when it is needed. (note that in the current code, there is no need for Starter objects to exist beyond the scope of a single function if there is no condor_starter pid to associate them with)\n\n</p><p>As a part of this fix, the s_starter member of the Claim class will be removed, as well as the c_claim back pointer in the Starter class. Mostly these pointers will just become function arguments, but in a few cases they will be looked up using the condor_starter pid as the key.\n\n</p><p>Because the fix for this race condition requires quite a lot of code refactoring, we will not be making the fix in stable.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6568\" onclick=\"get_ticket_and_populate_wrapper('6568'); return false;\" title=\"Startd always kills jobs after 40 minutes (job lease not renewed)\">#6568</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nStartd always kills jobs after 40 minutes (job lease not renewed)</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-01 14:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a16e23a91143aa6504a6e36c06dd235c49926aee\">[54409]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6500\" onclick=\"get_ticket_and_populate_wrapper('6500'); return false;\" title=\"startd should retry deletion of sandbox until it succeeds\">#6500</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6532\" onclick=\"get_ticket_and_populate_wrapper('6532'); return false;\" title=\"condor_q should not batch jobs by executable\">#6532</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6287\" onclick=\"get_ticket_and_populate_wrapper('6287'); return false;\" title=\"condor_q -l does not sort jobs\">#6287</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6524\" onclick=\"get_ticket_and_populate_wrapper('6524'); return false;\" title=\"startd may delete a starter object before the starter is reaped.\">#6524</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6494\" onclick=\"get_ticket_and_populate_wrapper('6494'); return false;\" title=\"condor_q -tot -global shows no output\">#6494</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-09 10:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ce3d2092e1306dd3375aa5593cbdf3b2536b5467\">[53116]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6524\" onclick=\"get_ticket_and_populate_wrapper('6524'); return false;\" title=\"startd may delete a starter object before the starter is reaped.\">#6524</a></span>, add null checks to make coverity happy.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-08 15:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cf65d547af15b0c2d0e1e1ef3c541ec5759c56d5\">[53107]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6524\" onclick=\"get_ticket_and_populate_wrapper('6524'); return false;\" title=\"startd may delete a starter object before the starter is reaped.\">#6524</a></span>. sever the ownership relationship between the Claim object and the Starter object in the STARTD - keeping the Starter objects around until they are reaped. This fixes a race condition where the Claim could be destroyed before the Starter was reaped which would result in the sandbox cleanup\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Mar-01 14:44", "status": "resolved", "created": "2018-Jan-08 13:32", "fixed_version": "2018-Jan-08 13:32", "broken_version": "v080000", "priority": "4", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "#6500", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}