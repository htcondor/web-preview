{"id": 4137, "title": "Ticket #4137: Non-blocking authentication", "description": "<blockquote>\nAuthentication has always been a sore spot for blocking.  We do the first few round-trips in a non-blocking manner - but as soon as we hand off to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> to do the \"real work\", everything blocks.\n\n<p>It's straightforward work to give the same treatment to the remaining condor_io layers involved in authentication.\n\n</p><p>Branch posted here:\n\n</p><p><a class=\"external\" href=\"https://github.com/bbockelm/htcondor/tree/non_blocking_auth\">https://github.com/bbockelm/htcondor/tree/non_blocking_auth</a>\n\n</p><p>Includes a non-blocking version of FS and GSI auth.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Dec-29 08:39:02 by bbockelm:</em> <br/>\n\nAfter a few bugfixes, this branch passes NMI tests.\n\n<p></p><hr/>\n<em>2014-Jan-02 10:56:12 by tannenba:</em> <br/>\n\nHere is the significant wisdom here (ideally to be part of the design doc):\n\n<p>Previously, HTCondor interfaced with GSI using using globus_gss_assist_init_sec_context() and globus_gss_assist_accept_sec_context(). This is problematic because these APIs block the caller while performing multiple synchronous network round-trips.\n\n</p><p>However, the GSS API does have have non-blocking native interface; the \"assist\" part of \"globus_gss_assist_init_sec_context\" is a wrapper library around the GSS API which provides a blocking API.\n\n</p><p>This work will change HTCondor to use the non-blocking interface, allowing a return to the main event loop handler between GSI network round trips.\n\n</p><p>Hooray!!!! :) :) :)\n\n</p><p></p><hr/>\n<em>2014-Aug-07 16:20:33 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>In <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCommandProtocol\" title=\"Daemon Command Protocol\">DaemonCommandProtocol</a></span>, remove the call to\nCommandNumToTableIndex() in Authenticate(), PostAuthenticate() and\nExecCommand(). m_cmd_index should already have the correct value, set in\nReadCommand().\n\n<p></p></li><li>In <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCommandProtocol\" title=\"Daemon Command Protocol\">DaemonCommandProtocol</a></span>, does the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorErr\" title=\"Condor Err\">CondorErr</a></span> m_errstack need to\npersist between calls? Otherwise, why make it a class member?\n\n<p></p></li><li>In DaemonCommandProtocol::Authenticate(), you always call\nReliSock::authenticate() in non-blocking mode. Shouldn't you consult\nm_nonblocking to decide if you want to be blocking or nonblocking?\n\n<p></p></li><li>In DaemonCommandProtocol::AuthenticateContinue(), you always call\nReliSock::authenticate_continue() in blocking mode. Shouldn't you call\nit in non-blocking mode?\n\n<p></p></li><li>In SecManStartCommand::authenticate_inner(), ReliSock::authenticate()\nis always called in non-blocking mode. Should this be based on\nSecManStartCommand::m_nonblocking?\n\n<p></p></li><li>Should Authentication::authenticate_finish() be protected or private?\nNo one outside of the class should be calling it, correct?\n\n<p></p></li><li>In Authentication, these new data members aren't initialized in the\nconstructor: m_auth, m_continue_handshake, m_continue_auth.\nThe destructor should delete m_auth, and m_auth should be set to NULL\nwhen the pointer is moved to authenticator_.\n\n<p></p></li><li>In Condor_Auth_FS, in the FS_REMOTE code, you dprintf() an empty\nm_new_dir instead of the template path.\n\n<p></p></li><li>In Condor_Auth_FS, for both the local and remote cases, the code\naround condor_mkstemp is overly convoluted. Why not leave new_dir as a\nchar* that's strdup()'d and then free()'d after use? When\ncondor_mkstemp() fails, it's clearer if you set m_new_dir to \"\".\n\n<p></p></li><li>In Condor_Auth_X509, authenticate_server_gss_complete() could be\nfolded into authenticate_server_gss(). That may allow you to turn\nm_client_name into a local variable.\n\n<p></p></li><li>In Condor_Auth_X509, I don't see why m_input_token and\nm_input_token_desc need to be class members. They're only used in\nauthenticate_server_gss() and they're always freed before the function\nreturns.\nIt appears that m_input_chan_bindings and m_mech_type are unnecessary as\nwell. You could just use GSS_C_NO_CHANNEL_BINDINGS and GSS_C_NO_OID when\ncalling gss_accept_sec_context().\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Aug-07 20:28:17 by bbockelm:</em> <br/>\n\nI believe I took care of everything except m_errstack; I'm not convinced that a badly written authentication object won't stash and use it between calls.\n\n<p>Ran the code through batlab and tests looked good.\n\n</p><p>Per our phone, merging this - any further fixes can go straight to master.\n\n</p><p></p><hr/>\n<em>2014-Sep-10 13:43:31 by jfrey:</em> <br/>\n\nYou didn't address the concern about SecManStartCommand::authenticate_inner() also calling ReliSock::authenticate() in non-blocking mode.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4662\" onclick=\"get_ticket_and_populate_wrapper('4662'); return false;\" title=\"Minor bug in non-blocking authentication\">#4662</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMinor bug in non-blocking authentication</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5101\" onclick=\"get_ticket_and_populate_wrapper('5101'); return false;\" title=\"Infinite loop in non-blocking authentication\">#5101</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nInfinite loop in non-blocking authentication</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5198\" onclick=\"get_ticket_and_populate_wrapper('5198'); return false;\" title=\"GSI authentication broken in blocking mode\">#5198</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nGSI authentication broken in blocking mode</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-24 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fb9a8d718e8143856c36017b42c1a12d65dbaf8d\">[43694]</a></span>: Fixed a UMI bug that could surpress an x509 auth error. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-24 14:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/32e202989002d32bb50ba01ff646a4390b859f86\">[43693]</a></span>: Fixed a UMI bug that could surpress an x509 auth error. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-11 13:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ca97ea2709f12e35e7c0f125c8dcb37b4121153a\">[41153]</a></span>: super minor 8.3.1 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-11 11:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b4e3d1660eccf7eedb060d0a3d4a499d7865c23f\">[41147]</a></span>: Docs for non-blocking authentication. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-08 11:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/90454dc1dfc1489c59f953ed12d9a115573e944a\">[40916]</a></span>: Minor cleanup of non-blocking authentication code. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span> Fix some Coverity complaints and remove some unnecessary variables.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-07 20:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c18cdf69917d10e77bf17cf5bcb6f36d9867e49f\">[40909]</a></span>: Make HTCondor authentication non-blocking. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span> This makes the daemon command protocol and authentication framing non-blocking, as well as the X509 and FS authentication methods. The remaining authentication methods can be picked off one-at-a-time. Squashed commit of non_blocking_auth branch.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-07 20:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ad3e66ddc1b0f4c63dc6c020850473d3c965f611\">[40910]</a></span>: Additional code review items. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-07 20:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9368b43d040cc22f3e52ecf24dcc98bcb94a9c7a\">[40908]</a></span>: Additional code review items. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-07 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/047d14edb44c3352a3e5f13efec5e797eb11487a\">[40898]</a></span>: Make HTCondor authentication non-blocking. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4137\" onclick=\"get_ticket_and_populate_wrapper('4137'); return false;\" title=\"Non-blocking authentication\">#4137</a></span> This makes the daemon command protocol and authentication framing non-blocking, as well as the X509 and FS authentication methods. The remaining authentication methods can be picked off one-at-a-time. Squashed commit of non_blocking_auth branch.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Oct-16 11:16", "status": "resolved", "created": "2013-Dec-27 09:03", "fixed_version": "2013-Dec-27 09:03", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "jfrey", "derived_from": "#4136", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, burt@fnal.gov, tannenba@cs.wisc.edu", "due_date": ""}