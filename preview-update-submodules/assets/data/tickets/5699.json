{"id": 5699, "title": "Ticket #5699: job queue log corrupted with history file snippets", "description": "<blockquote>\nCERN observed the job_queue.log corrupted in such a way that it has snippets of the history file inserted into it.  Somehow the fd for the job queue and the history file got swapped!\n\n<p>Two theories came to mind:\n\n</p><p></p><ol>\n<li>CERN was running <a class=\"external\" href=\"https://github.com/a2o/snoopy\">Snoopy logger</a> (specifically snoopy-1.7.10-1.el6) on this schedd instance, which audits activity via LD_PRELOAD and has caused bugs for us in the past.  Maybe it is again?\n\n<p></p></li><li>The code in HTCondor to append to the History file looks like it could continue to use a stdio File* buffer after it has been de-allocated in the event that there was a failure to write to the History file. If this File* address is reused by glibc (after rotating the job_queue.log for instance), we could potentially observe this bug.\n</li></ol>\n\n<p>This ticket proposes patches to clean up the code that detects and handles failures to write to the history file.\n\n</p><p>P.S. This was also found in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddLog\" title=\"Schedd Log\">ScheddLog</a></span>:\n</p><div class=\"code\">\n<pre class=\"code\">05/26/16 16:58:25 \"ERROR \"fsync of /var/lib/condor-ce/spool/job_queue.log failed, errno = 9\" at line 585 in file /slots/01/dir_4917/userdir/.tmpKEQAWF/BUILD/condor-8.4.4/src/condor_utils/classad_log.h\n</pre></div>\n\n\n<p>and on another occasion, this was found:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">6/03/16 22:54:52 ERROR \"Failed to write real job queue log: fflush failed (errno 32); no local backup available.\" at line 553 in file /slots/01/dir_4917/userdir/.tmpKEQAWF/BUILD/condor-8.4.4/src/condor_utils/log_transaction.cpp\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-13 12:57:12 by iain.steers:</em> <br/>\n\nHi Todd,\n\n<p>Think it's fairly safe at this point to say that it was definitely snoopy which swapped the fds.\n\n</p><p>We've had no re-occurrences since I removed snoopy from the schedds.\n\n</p><p>Interesting that it only ever happened on the one CE.\n\n</p><p></p><hr/>\n<em>2016-Jun-26 14:23:39 by tannenba:</em> <br/>\n\nGiven that the real culprit was snoppy, the commits to the code are just clean-up work to prevent potential future bugs.  Thus there is no need for a version history blurb.\n\n<p></p><hr/>\n<em>2016-Jun-28 15:25:05 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>These changes look good.\n\n</p><p>One problem I noticed in OpenHistoryFile(): If fdopen() fails, then <code>fd</code> should be closed.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-28 15:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c84bd2b2ba5eb9374ae28d1427e26a6ea3cbaf56\">[48683]</a></span>: Don't leak an fd if fdopen() fails. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5699\" onclick=\"get_ticket_and_populate_wrapper('5699'); return false;\" title=\"job queue log corrupted with history file snippets\">#5699</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-26 14:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a8ec12f3469a307488524aa3e7f3db4e0a268b15\">[48655]</a></span>: Return an error if fPrintAd fails to write a file. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5699\" onclick=\"get_ticket_and_populate_wrapper('5699'); return false;\" title=\"job queue log corrupted with history file snippets\">#5699</a></span> Previously fPrintAd() unconditionally returned success. Sigh.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-26 13:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96610fe973752485736f4563ba374f966de5d2c4\">[48654]</a></span>: Clean-up code that writes to the History file to handle errors. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5699\" onclick=\"get_ticket_and_populate_wrapper('5699'); return false;\" title=\"job queue log corrupted with history file snippets\">#5699</a></span> Fix bug where History file append code could continue to use a stdio File* buffer after it has been de-allocated in the event that there was a failure to write to the History file.\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Jun-29 10:11", "status": "resolved", "created": "2016-May-27 14:12", "fixed_version": "2016-May-27 14:12", "broken_version": "v080200", "priority": "3", "subsystem": "Libs", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "iain.steers@cern.ch, jfrey@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}