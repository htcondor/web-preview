{"id": 5467, "title": "Ticket #5467: Prevent bad privilege state change sequences", "description": "<blockquote>\nCertain sequences of privilege state change calls can result in the process being in an incorrect privilege state. If the user uid/gid is reinitialized when already in user priv-state, then supplemental groups are lost. If a daemon tries to switch to user priv-state before initializing which account to use, then the process ends up in root priv-state.\n\n<p>We attempted to prevent these situations in 8.4 (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>), but reverted the change when it broke otherwise-working production installations. We plan to retry in 8.5 and fix the resulting failures.\n\n</p><p>We will make the following changes:\n</p><ul>\n<li>set_user_ids() and init_user_ids() will return failure if the process is in PRIV_USER or PRIV_USER_FINAL state and the requested id is different. Otherwise, supplement groups will be lost.\n</li><li>Switching to PRIV_USER or PRIV_USER_FINAL will cause an EXCEPT() if the user id hasn't been set. We EXCEPT() because the privilege-switching functions can't return an error to the caller.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Apr-04 17:47:27 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.  As this is already documented and released, moving to resolved state.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-07 13:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/692ae346cb96835418f732127da2006c78226b81\">[47439]</a></span>: Docs for priv-state code safe-guarding. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5467\" onclick=\"get_ticket_and_populate_wrapper('5467'); return false;\" title=\"Prevent bad privilege state change sequences\">#5467</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-07 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/355230f3063ca5828f13b83bc54e32ba3be540e3\">[47433]</a></span>: Build file catalog as correct user in schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5467\" onclick=\"get_ticket_and_populate_wrapper('5467'); return false;\" title=\"Prevent bad privilege state change sequences\">#5467</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-07 10:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b639670f9c44a5b2b880f9b7dfd059183b7d3bfe\">[47432]</a></span>: Add guards to prevent bad user priv state call sequences. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5467\" onclick=\"get_ticket_and_populate_wrapper('5467'); return false;\" title=\"Prevent bad privilege state change sequences\">#5467</a></span> Don't allow user priv ids to be modified while in user priv state. Don't allow switching to user priv state if user ids aren't set. Without these checks, the resulting privilege state won't be what the caller wants.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Apr-04 17:48", "status": "resolved", "created": "2016-Jan-06 16:50", "fixed_version": "2016-Jan-06 16:50", "broken_version": "v080400", "priority": "4", "subsystem": "Security", "assigned_to": "jfrey", "derived_from": "#4522", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "zmiller@cs.wisc.edu", "due_date": ""}