{"id": 2245, "title": "Ticket #2245: INSANE showing up in NegotiatorLog", "description": "<blockquote>\nWhen <code>MatchList</code> caching is enabled in the negotiator (which is the default), the negotiator scans through all the startd ads to find the machine ad (called <code>bestSoFar</code>) that is the highest ranked match to a particular job. During this same scan, it puts all the machine ads that match the job into a list (the <code>MatchList</code>), and sorts the list based on the ranking criteria.  It then pops the top entry off the <code>MatchList</code> (called <code>bestCached</code>) and compares it to the machine ad it found during the scan.  If these do not match, then a scary entry appears in the <code>NegotiatorLog</code>:\n\n<p></p><pre>   INSANE: bestCached != bestSoFar\n</pre>\n\n<p>It then returns <code>bestSoFar</code>.  The end result is not only a scary message in the log, but also whenever this happens the negotiator ends up matching the same slot twice in the same pie spin!  The reason this is all happening is because the sort is qsort(), which is not a stable sort - i.e. if you give qsort an already sorted list, entries with the same weight may be swapped.\n\n</p><p>The patch below gets rid of the unnecessary comparison, and also always returns the top entry from the <code>MatchList</code> to the schedd if <code>MatchList</code> caching is enabled.  This fixes both the <code>INSANE</code> warning in the log and also the bug of giving out the same match twice.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Aug-06 08:42:03 by johnkn:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Code looks good. Although if bestSoFar is always pulled from the match list, it's time to remove the redundant sorting code at lines 4171 to 4218.\n\n<p></p><hr/>\n<em>2013-Aug-06 12:00:52 by tannenba:</em> <br/>\n\nThanks for review, but disagree w/ above re time to remove redundant sort code... it is still needed for the case when matchlist caching is disabled in the config file. We could get rid of the code if we knew nobody used the knob to disable matchlist caching, but iirc folks do use that knob in certain situations (condor-g matchmaking where matches get reused perhaps? don't recall off the top of my head).</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-14 11:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9424b69245494ca45d50fa80ac6d759f424e3397\">[37214]</a></span>: minor 8.0.2 version history item edit ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2245\" onclick=\"get_ticket_and_populate_wrapper('2245'); return false;\" title=\"INSANE showing up in NegotiatorLog\">#2245</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-05 14:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55d64a47bf8ba46b9868115077ff2e510dc4d925\">[37097]</a></span>: Added version history entry for INSANE negotiator bugfix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2245\" onclick=\"get_ticket_and_populate_wrapper('2245'); return false;\" title=\"INSANE showing up in NegotiatorLog\">#2245</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-05 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c4a3e4c4d89c5cb8122d95b398cb19b622872e7a\">[37096]</a></span>: Fix bug that can cause matchmaker to give out same slot twice. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2245\" onclick=\"get_ticket_and_populate_wrapper('2245'); return false;\" title=\"INSANE showing up in NegotiatorLog\">#2245</a></span> This bug can occur whenever matchlist caching is enabled. This same bug was also causing the scary <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NegotiatorLog\" title=\"Negotiator Log\">NegotiatorLog</a></span> entry of INSANE: bestCached != bestSoFar. This message worried people.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Aug-06 12:01", "status": "resolved", "created": "2011-Jun-15 14:33", "fixed_version": "2011-Jun-15 14:33", "broken_version": "v070400", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "support", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}