{"id": 4694, "title": "Ticket #4694: job log corrupted on file system with spool full", "description": "<blockquote>\nprocess:\n\n<p>as root:\n\n</p><p></p><ol>\n<li>/dev/zero of=spoolmnt bs=1024 count=3072\n</li><li>mkdir /mnt/bttestspool\n</li><li>losetup /dev/loop0\n</li><li>losetup /dve/loop0 spoolmnt\n</li><li>mkfs -t ext3 -m 1 -v /dev/loop0\n</li><li>mount -t ext3 /dev/loop0 /mnt/bttestspool\n</li></ol>\n\n<p></p><div class=\"code\">\n<pre class=\"code\">\nHave a submit file for 6 secong sleep jobs tst.cmd\n\nuniverse   = vanilla\nexecutable = /bin/sleep\nlog        = tst.log\narguments = 6\nnotification = never\nqueue 1000\n\nrun a personal htcondor with the following added\n\nDAEMON_LIST = MASTER SCHEDD STARTD COLLECTOR NEGOTIATOR\nSPOOL = /mnt/bttestspool\nNUM_CPUS = 20\nNEGOTIATOR_INTERVAL = 5\nMAX_JOB_QUEUE_LOG = 10 mb\nMAX_DEFAULT_LOG = 1 mb\n\ncondor_master&amp;\ncondor_submit tst.cmd\n\nwatch for loopback to fill\n\nCheck schedd quit\ncheck job_queue.log\n\n\nget validate_job_queue.exe from built condor_tests(\"make test4)\n\ncopy to mounted loopback\n\nfind in your release_dir lib/libcondor_utils_8_3_2.so\n\nexport LD_LIBRARY_PATH=/home/bt/rawcondor/lib:$LD_LIBRARY_PATH\n\nfill /mnt/bttestspool with 1/2 meg file\n\ndd if=/dev/zero of=/mnt/bttestspool/fill bs=1024 count=500\ndd if=/dev/zero of=/mnt/bttestspool/fill2 bs=1024 count=200\ndd if=/dev/zero of=/mnt/bttestspool/fill3 bs=1024 count=200\n\n\nfill 500k\n\n\n\n\n\n\n\n\nWARNING: Encountered corrupt log record 80023 (byte offset 2257234)\n    103 5.672 105\nLines following corrupt log record 80023 (up to 3):\n    103 5.676 LastJobLeaseRenewal 1415040356\n    103 5.676 TransferringOutput false\n    106\nERROR \"Error: corrupt log record 80023 (byte offset 2257234) occurred inside closed transaction, recovery failed\" at line 1329 in file /slots/01/dir_29472/userdir/src/condor_utils/classad_log.cpp\n\nfirst file in ~bt/public\n\nAnother interesting case was with no rotated log\n\nThe initial job queue log filled partition quickly writing basic job attributes\nand ended up partway through job 839.\n\n{code}\n101 1.836 Job Machine\n103 1.836 GlobalJobId \"matlab-build-5.chtc.wisc.edu#1.836#1415303691\"\n103 1.836 ProcId 836\n103 1.836 EnteredCurrentStatus 1415303691\n103 1.836 JobStatus 1\n103 1.836 foo \"1\"\n101 1.837 Job Machine\n103 1.837 GlobalJobId \"matlab-build-5.chtc.wisc.edu#1.837#1415303691\"\n103 1.837 ProcId 837\n103 1.837 EnteredCurrentStatus 1415303691\n103 1.837 JobStatus 1\n103 1.837 foo \"1\"\n101 1.838 Job Machine\n103 1.838 GlobalJobId \"matlab-build-5.chtc.wisc.edu#1.838#1415303691\"\n103 1.838 ProcId 838\n103 1.838 EnteredCurrentStatus 1415303691\n103 1.838 JobStatus 1\n103 1.838 foo \"1\"\n101 1.839 Job Machine\n103 1.839 Global\n</pre></div>\n\n\n<p>I could not talk to schedd\n\n</p><p>I removed 2 bytes per job freeing a little space. The schedd started rotated the log and only had space for a stub job_queue.log and lost all the jobs.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">total 1.9M\n-rw------- 1 bt   bt    157 Nov  6 14:02 job_queue.log\n-rw------- 1 root bt      0 Nov  6 13:54 job_queue.log~\n-rw------- 1 bt   bt   160K Nov  6 14:02 job_queue.log.1\ndrwx------ 2 root root  12K Nov  6 10:34 lost+found\n-rw-r--r-- 1 root root 1.0M Nov  6 11:08 stuff1m\n-rw-r--r-- 1 root root 200K Nov  6 13:54 stuff200k\n-rw-r--r-- 1 root root 400K Nov  6 13:53 stuff400k\n-rwxr-xr-x 1 bt   bt   113K Nov  6 10:59 validate_job_queue.ex\n\njob_queue.log holds\n\ncat job_queue.log\n\n107 2 CreationTimestamp 1415303672\n101 0.0 Job Machine\n103 0.0 MyType \"Job\"\n103 0.0 TargetType \"Machine\"\n103 0.0 CurrentTime time()\n103 0.0 NextClusterNum 1\n\n\n\n\n\n\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Nov-03 16:18:04 by tannenba:</em> <br/>\n\nAt first blush, it looks like the the schedd kept attempting to write/flush/sync the job_queue.log after the disk filled up (and presumably the schedd encountered an error).  This makes me suspect a bug in commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c8da35e5add70b7765bff1d7552045745e8bc1ab\">[11757]</a></span>, which has a bunch of inline logic that delays the schedd from excepting upon first seeing a write error when committing a transaction.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2014-Nov-13 08:30", "status": "new", "created": "2014-Nov-03 13:06", "fixed_version": "2014-Nov-03 13:06", "broken_version": "v080302", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "", "derived_from": "", "creator": "bt", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}