{"id": 6539, "title": "Ticket #6539: scheduler universe and dagman jobs leaked if condor_master dies", "description": "<blockquote>\nHTCondor is supposed to have a \"belt and suspenders\" approach to ensure it does not leave a mess of orphaned processes.  Even in the event of the condor_master blowing up, the condor_schedd (and all other condor daemons under the master) should notice that the master went away (daemons poll to see if the master is still alive every 2 minutes) and proceed to shutdown if the master disappears.\n\n<p><strong>Unfortunately the schedd has a bug where on shutdown it only sends a sigterm to ONE scheduler universe job</strong>. The issue is when the master died the procd committed suicide, then the schedd would commmit suicide the first time it tried to reap a child. So if you have 50 dagmans in the queue, only one of them will be killed by the schedd upon shut down.  In the normal case where the condor_master is still alive, this bug isn't a big deal because the condor_master will kill any/all pids left behind by the schedd.  But if the condor_master is dead, this schedd bug is really bad.\n\n</p><p><strong>Recipe to reproduce the bug</strong>\n\n</p><p></p><ol>\n<li>Submit 2 scheduler universe jobs.\n</li><li>Do a <code>ps auxw | grep condor_scheduniv_exec</code> and observe the two scheduler universe jobs running.\n</li><li>Now <code>kill -9</code> the condor_master\n</li><li>Within two minutes the condor_schedd will notice the master is gone, and will shutdown and exit.  However, after the condor_schedd is gone, <code>ps auxw | grep condor_scheduniv_exec</code> will show one of the two scheduler universe processes was left behind.\n</li></ol>\n\n<p><strong>Plan to fix the bug</strong>\n\n</p><p>One way to fix the bug would require the procd to hang around for some period of time after the condor_master has died in order to honor requests from the schedd (or startd, or starter, etc).  This approach has been deemed to complicated for the stable series.\n\n</p><p>Instead, we will configure systemd to cleanup any processes left behind after the condor_master exits.  Although not directly related, we will also modify daemon core to do a shutdown fast instead of a shutdown graceful whenever an HTCondor daemon notices its parent has died.\n\n</p><p>p.s. The approach in check-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fed525d5262c533a41c38fba4856ee3c66d812f0\">[54166]</a></span> was deemed to risky upon code review, and was reverted.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Jan-24 15:45:37 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> of check-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fed525d5262c533a41c38fba4856ee3c66d812f0\">[54166]</a></span> (was reverted) - with this change, the schedd now sends a sigterm to ALL shadows, as well as all scheduler and local universe jobs before it reaps any children when it is doing a graceful shutdown.\n\n<p>Prior to this change, the schedd would only sigterm ONE shadow OR ONE scheduler universe job or ONE local universe job each time the attempt_shutdown() timer ticked. it would then (likely) reap that child, wait a second and tick the timer again.\n\n</p><p>The reason that the condor_dagman processes leaked when the master died was because the procd committed suicide, then the schedd would commmit suicide the first time it tried to reap a child.\n\n</p><p></p><hr/>\n<em>2018-Feb-27 11:56:52 by matyas:</em> <br/>\n\n<strong>CODE REVIEW</strong> This is fine as a last resort but if the schedd and other daemons are smart enough to notice that the master has gone away, we should give them a chance to do so.\n\n<p><a class=\"external\" href=\"https://www.freedesktop.org/software/systemd/man/systemd.kill.html\">https://www.freedesktop.org/software/systemd/man/systemd.kill.html</a> says that the default timeout for SIGKILLing a process is 90 seconds. We should increase it via the <code>TimeoutStopSec</code> option to 2 minutes plus some padding.\n\n</p><p></p><hr/>\n<em>2018-Mar-08 15:47:40 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong> for Todd's changes. They look good. Thank you.\n\n<p></p><hr/>\n<em>2018-Mar-09 11:32:25 by tim:</em> <br/>\n\n<strong>DOC REVIEW</strong>: Looks good</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=6536\" onclick=\"get_ticket_and_populate_wrapper('6536'); return false;\" title=\"Master should check if it had to kill grandchildren.\">#6536</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMaster should check if it had to kill grandchildren.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-09 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7564aa73e3219905b9d7c2ec8ab326ffbb134424\">[54474]</a></span>: Version history: reorder, fix typos, addtl info for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6521\" onclick=\"get_ticket_and_populate_wrapper('6521'); return false;\" title=\"Optimal preen connections to schedd\">#6521</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-01 15:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c01e85cb058d75871bcb677d3d56f3d906396294\">[54412]</a></span>: shutdown fast instead of graceful if parent processes dies. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-01 08:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3a4dcb2eb7498ba5d88c98cc944efaff2acdfcf9\">[54396]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>) Extend <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimeoutStopSeconds\" title=\"Timeout Stop Seconds\">TimeoutStopSeconds</a></span> to 150 In theory, this allows to discover that the master has left and the schedd and other daemons will notice and leave after 2 minutes.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-26 21:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0005ac19079b44765c2a2b3bb3a91b3a009cd2e4\">[54368]</a></span>: Update version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-26 17:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8cb2dc0c25d6485a6f273c0a107a16040c0b1c7a\">[54366]</a></span>: Revert \"Schedd must sigterm all child processes on shutdown. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>\" This reverts commit fed525d5262c533a41c38fba4856ee3c66d812f0.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-26 17:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bc9356ddadfd8ed3d7331483c04bd6266de8a856\">[54367]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>) Update systemd configuration for better shutdown Use the \"mixed\" kill mode to shutdown HTCondor, the master receives a SIGQUIT and starts shutting down. After it exits (or 90 seconds) systemd will send a SIGKILL to any remaing processes in the condor cgroup.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9df29984b6353d33da7a1b0f86ceee3310d02551\">[54168]</a></span>: Version history entry for bug fix <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fed525d5262c533a41c38fba4856ee3c66d812f0\">[54166]</a></span>: Schedd must sigterm all child processes on shutdown. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6539\" onclick=\"get_ticket_and_populate_wrapper('6539'); return false;\" title=\"scheduler universe and dagman jobs leaked if condor_master dies\">#6539</a></span> This patch fixes a bug where the schedd would not sigterm all child processes on shutdown, which resulted in scheduler universe jobs (ie dagman) being leaked in the event the condor_master dies.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Mar-09 11:32", "status": "resolved", "created": "2018-Jan-24 13:56", "fixed_version": "2018-Jan-24 13:56", "broken_version": "v080400", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tim", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "tannenba@cs.wisc.edu gthain@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}