{"id": 355, "title": "Ticket #355: Event Log reader library ASSERTS upon log rotation", "description": "<blockquote>\n<a class=\"external\" href=\"mailto:Sergey.Mitsyn@cern.ch\">Sergy M</a> at CERN reports the following:\n\n<p>I've been working tightly with Sergey Belov on Condor's user log reader client for Dashboard. He said that i should write to you about encountered problems with read user log condor library.\n\n</p><p>Currently I've faced with my log reader exiting with current assertion fault:\n\n</p><p></p><pre>   3/24 09:45:58 ERROR \"Assertion ERROR on (m_lock-&gt;isLocked())\" at line\n   1274 in file read_user_log.cpp\n</pre>\n\n<p>(in one line; my email client wraps the line).\n\n</p><p>The error is caused by log rotation. The same behavior is encountered with test_log_reader from the condor_src package. The condor version is 7.2.1, but i believe that the same may be true for 7.2.0.\n\n</p><p>After strace-ing my logreader's process, I've got this output (for readability, without opening&amp;closing \"/dev/null\" by dprintf and with my comments):\n\n</p><p></p><div class=\"verbatim\">\n<pre>\n// at this point of execution, a check for rotation log is being made\n\n// this line prints some debug info\n// (descriptor 6 is the \"/dev/null\")\n\nwrite(6, \"readEvent: checking to see if file\n(/home/condor/local.vtb-generic-99/log/EventLog) matches: NOMATCH\\n\",\n101) = 101\n\n// this closes the log file (descriptor 4 is the log file)\n\nclose(4)                                = 0\n\n// and now it tries to lock the closed file\n\nfcntl64(4, F_SETLKW, {type=F_WRLCK, whence=SEEK_SET, start=0, len=0}) =\n-1 EBADF (Bad file descriptor)\n\n// dprint\n\nwrite(6, \"FileLock::obtain(1) failed - errno 9 (Bad file descriptor)\\n\",\n59) = 59\n\n// prints to stderr\n\nwrite(2, \"ERROR \\\"Assertion ERROR on (m_lock-&gt;isLocked())\\\" at line 1274\nin file read_user_log.cpp\\n\", 87) = 87\nexit_group(4)                           = ?\nProcess 9247 detached\n\n</pre></div>\n\n\n<p>After examining the source code in read_user_log.cpp, i've found out that on line 865 logreader calls <code>CloseLogFile( )</code>, which closes the logfile descriptor without closing it's FILE*.\n\n</p><p>After that, of course, the <code>ReopenLogFile()</code> is called, which does <em>not</em> reopen the file because of FILE* pointer being not null.\n\n</p><p>The consequences are obvious.\n\n</p><p>A possible fix is in the diff below, but i dont know what consequences may be caused by this modification. Through, with this fix it does not exit with assertion fault on log rotation anymore. :)\n\n</p><p>--\nSergey Mitsyn.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">diff -U0 ~/src/cond_x/condor-7.2.1/src/condor_c++_util/read_user_log.cpp read_user_log.cpp\n--- /root/src/cond_x/condor-7.2.1/src/condor_c++_util/read_user_log.cpp 2009-02-16 17:44:05.000000000 +0100\n+++ read_user_log.cpp   2009-03-23 17:19:13.000000000 +0100\n@@ -865 +865 @@\n-                               CloseLogFile( );\n+                               CloseLogFile( true );\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\nWaiting for confirmation from Sergey that this is fixed.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Apr-03 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/75f7691af4e69e9ab3bdd14add36b20527c14258\">[24710]</a></span>: Documented my fix to gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=355\" onclick=\"get_ticket_and_populate_wrapper('355'); return false;\" title=\"Event Log reader library ASSERTS upon log rotation\">#355</a></span>  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Mar-31 12:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cfe2e4e724f540051123792e3474dbea980ec577\">[14341]</a></span>: Fixed a double close of the event log fp when the reader is invoked by the writer to count events (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=355\" onclick=\"get_ticket_and_populate_wrapper('355'); return false;\" title=\"Event Log reader library ASSERTS upon log rotation\">#355</a></span>)  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Mar-31 12:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4be0d842d956d75146c901abd973762c9ec51a24\">[14340]</a></span>: Revert \"Revert \"Fixed a couple of bugs in my previous commit (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=355\" onclick=\"get_ticket_and_populate_wrapper('355'); return false;\" title=\"Event Log reader library ASSERTS upon log rotation\">#355</a></span>)\"\" This reverts commit 64182f4e3d68fee7b34c6e8e83d85b067489b4aa.  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Mar-30 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0a5047faa23a081a71d8d7ffa6fe53dc632aba36\">[14320]</a></span>: Revert \"Fixed a couple of bugs in my previous commit (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=355\" onclick=\"get_ticket_and_populate_wrapper('355'); return false;\" title=\"Event Log reader library ASSERTS upon log rotation\">#355</a></span>)\" This reverts commit ab6fd52b735a5dd91fcdf222d8327ad37dc5008c.  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Mar-30 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e2d2035d4eee8fb0dd997afee576655ecde1e915\">[14319]</a></span>: Fixed a couple of bugs in my previous commit (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=355\" onclick=\"get_ticket_and_populate_wrapper('355'); return false;\" title=\"Event Log reader library ASSERTS upon log rotation\">#355</a></span>)  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Mar-30 15:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6164c3611ff140f1b14806cb50f0ca5d7dc704b8\">[14316]</a></span>: Fixed a number of bugs that could cause the log reader to not properly close it's file handle/descriptor pair (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=355\" onclick=\"get_ticket_and_populate_wrapper('355'); return false;\" title=\"Event Log reader library ASSERTS upon log rotation\">#355</a></span>)  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 08:23", "status": "resolved", "created": "2009-Mar-30 14:31", "fixed_version": "2009-Mar-30 14:31", "broken_version": "v070201", "priority": "1", "subsystem": "Libs", "assigned_to": "nleroy", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "other", "visibility": "public", "notify": "Sergey.Mitsyn@cern.ch, tannenba@cs.wisc.edu", "due_date": ""}