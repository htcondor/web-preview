{"id": 2364, "title": "Ticket #2364: privsep does not work on new RH6 CHTC nodes", "description": "<blockquote>\nprivsep fails when it tries to run jobs on the new RH6 CHTC nodes.\n\n<p></p><div class=\"verbatim\">\n<pre>08/08/11 14:33:31 privsep_get_switchboard_response: error received: error switching to uid 997\n08/08/11 14:33:31 privsep_create_process: privsep_get_switchboard_response failure\n08/08/11 14:33:31 ERROR \"Create_Process(/var/lib/condor/execute/slot1/dir_13218/condor_exec.exe,soma.paramfile.0, ...)\n failed: \" at line 560 in file\n /home/condor/execute/dir_14089/userdir/src/condor_starter.V6.1/os_proc.cpp\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Aug-09 17:46:11 by danb:</em> <br/>\n\nI have found that a personal condor successfully runs jobs in privsep mode on the same machine.  It is using the same binaries, the same privsep_config, the same execute directory, the same path to the switchboard binary, and the same slot execute user.\n\n<p>I have also experimented with having this \"personal\" startd join the CHTC pool.  It successfully runs jobs from other schedds.\n\n</p><p>My only theory is that something else in the condor configuration is breaking the switchboard, but that doesn't really make sense, because the switchboard shouldn't depend on condor configuration.  Maybe the environment?\n\n</p><p></p><hr/>\n<em>2011-Aug-09 18:28:04 by danb:</em> <br/>\n\nI found the crucial configuration that causes the problem to happen:\n\n<p></p><div class=\"verbatim\">\n<pre>USE_GID_PROCESS_TRACKING = True\nMIN_TRACKING_GID = 1100\nMAX_TRACKING_GID = 1199\n</pre></div>\n\n\n<p>I don't yet understand why this is problematic.\n\n</p><p></p><hr/>\n<em>2011-Aug-10 15:47:13 by danb:</em> <br/>\n\nThe reason gid tracking breaks privsep is that privsep on these nodes is incorrectly configured.  valid-target-gids does not contain the supplemental groups used for process tracking.\n\n<p>It is rather unfortunate that the error reported by condor in this case is \"error switching to uid 997\".  It took me a long time to go from that to the actual problem.\n\n</p><p></p><hr/>\n<em>2011-Aug-10 16:15:57 by danb:</em> <br/>\n\nThe following code in safe.unix.cpp is responsible for the error message.  One simple way to improve it would be to also print the tracking_gid, so that the user has a clue that either the uid or the gid might be the problem.\n\n<p></p><pre>    r = safe_switch_to_uid(uid, tracking_gid, safe_uids, safe_gids);\n    if (r &lt; 0) {\n        fatal_error_exit(1, \"error switching to uid %lu\",\n                         (unsigned long) uid);\n    }\n</pre>\n\n<p></p><hr/>\n<em>2011-Aug-11 09:23:41 by kupsch:</em> <br/>\n\nThe function safe_switch_to_uid() returns many different error values that can be used to determine why the switch was not successful.  -8 is returned if a group id is not valid.  The function could be modified to return -9 if the tracking gid is not valid, versus -8 for a supplementary group being not valid.\n\n<p>If the tracking ids are not secret (probably not since an attacker can see them using ps), then there probably is no harm to creating better error messages based on the return value of safe_switch_to_uid().</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-12 15:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a74b0ea86e090ba260903f39aa2749305e5504c9\">[26756]</a></span>: Documented improvement of error reporting in safe_switch_to_uid(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2364\" onclick=\"get_ticket_and_populate_wrapper('2364'); return false;\" title=\"privsep does not work on new RH6 CHTC nodes\">#2364</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-12 15:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/489ed67ff7a2c4c81083d0c3a13c9fea37a96faf\">[26755]</a></span>: Improved error reporting in safe_switch_to_uid(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2364\" onclick=\"get_ticket_and_populate_wrapper('2364'); return false;\" title=\"privsep does not work on new RH6 CHTC nodes\">#2364</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Aug-04 14:57", "status": "resolved", "created": "2011-Aug-08 15:47", "fixed_version": "2011-Aug-08 15:47", "broken_version": "v070700", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": "20110812"}