{"id": 3560, "title": "Ticket #3560: improve dprintf code to support audit logs (time based rotation)", "description": "<blockquote>\nThe audit log will be configured as a secondary dprintf log, that listens only for D_AUDIT messages and rotates based on time rather than on file size.  So the dprintf code needs to be able to handle time based rotation.\n\n<p>Basic data structures will need to know the rotation interval, and how long to keep old logs around.  log files will have a file extension that indicates the start of the time period that the log represents.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Apr-17 14:25:17 by johnkn:</em> <br/>\n\nas of April-10, time based rotation basically works.  but uses the file modify time on daemon startup, so there is the potential for a race condition that would result in a file skipping a rotation.\n\n<p>The rotation code also currently (and erroneously) always rotates a the oldest file to .old rather than deleting it.\n\n</p><p></p><hr/>\n<em>2015-Feb-11 16:04:41 by bbockelm:</em> <br/>\n\nWhat's the status of this ticket?  Can we close it out?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-15 17:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/282a40da71f94ed99c04de1c0ae87770c76d20ac\">[35711]</a></span>: MAX_&lt;SUBSYS&gt;_LOG can be specified in bytes or (new) in amount of time to rotation. Suffixes identify scale of time or size. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-07 17:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aec470eec260f1cc6076fe6aa4eb8630e64665ac\">[35641]</a></span>: Edit many 7.9.6 version history items, including those for tickets (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3539\" onclick=\"get_ticket_and_populate_wrapper('3539'); return false;\" title=\"change recommended configuration for disabling preemption\">#3539</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3586\" onclick=\"get_ticket_and_populate_wrapper('3586'); return false;\" title=\"move python bindings out of contrib\">#3586</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3398\" onclick=\"get_ticket_and_populate_wrapper('3398'); return false;\" title=\"Batch GAHP cannot set remote memory or walltime requests\">#3398</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span>, <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2949\" onclick=\"get_ticket_and_populate_wrapper('2949'); return false;\" title=\"peaceful shutdown cannot be escalated to graceful\">#2949</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3493\" onclick=\"get_ticket_and_populate_wrapper('3493'); return false;\" title=\"Audit Log for Condor schedds\">#3493</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3496\" onclick=\"get_ticket_and_populate_wrapper('3496'); return false;\" title=\"monitor file transfer i/o activity\">#3496</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3597\" onclick=\"get_ticket_and_populate_wrapper('3597'); return false;\" title=\"CPU affinity enforcement broken with partitionable slots\">#3597</a></span>, <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=3601\" onclick=\"get_ticket_and_populate_wrapper('3601'); return false;\" title=\"autofs doesn't work with 7.9\">#3601</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3579\" onclick=\"get_ticket_and_populate_wrapper('3579'); return false;\" title=\"condor_updates_stats doesn't work anymore\">#3579</a></span>,) and (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3570\" onclick=\"get_ticket_and_populate_wrapper('3570'); return false;\" title=\"Starter leaks FDs to file transfer plugin\">#3570</a></span>, <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=3588\" onclick=\"get_ticket_and_populate_wrapper('3588'); return false;\" title=\"DHCPREQUEST doesn't have the ending 0xff byte to mark end of options f\">#3588</a></span>)  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-06 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/87f854c05b729e55fc96f01c47330305fb3676c5\">[35613]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-10 16:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0eaa3919c8b4de7cbc4f938b572396ca582ef32a\">[35370]</a></span>: time based log rotation using modify time % period <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span> since creation time is not available on either windows or linux. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-09 14:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0d1f12a18ddb2a3b434e180b958dfa7f3bab1627\">[35358]</a></span>: add specialized dprintf call to sock.h &amp; sock.cpp that passes connection id <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-09 11:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/32333ef800cf199e5f89bfcfe1a662fa33750864\">[35354]</a></span>: change dprintf conversation id to DPF_IDENT type, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span> fix bug in building aggregate set of listener categories change audit_log macro to allow a dprintf flags parameter. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-08 17:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a6f33af884f81cac04418af6f9c77ff5ff75ee6\">[35352]</a></span>: allow a conversation id to be passed to dprintf, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span> and then print it as part of the dprintf header when D_IDENT flag is specified for the log file. D_IDENT added automatically for logs specified by {daemon}_AUDIT_LOG. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-04 17:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb3d453f14c984354be17625007eb860cee5c720\">[35341]</a></span>: fix dprintf code to better handle secondary log destinations. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span> allow messages to secondary logs that arent in the primarly log. fix a double-rendering bug for secondary log. interpret the D_FAILURE flag to mean \"also log to D_ERROR category listeners\" ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-03 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2452ed0fef49812cf98a7591b92796c904948497\">[35325]</a></span>: Add dprintf log rotation by time limit <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3560\" onclick=\"get_ticket_and_populate_wrapper('3560'); return false;\" title=\"improve dprintf code to support audit logs (time based rotation)\">#3560</a></span>. the param MAX_{DAEMON}_LOG or MAX_{DAEMON}_{CATEGORY}_LOG now accepts a units specifier after the integer size value. units can be Sec,Min,Hour,Day,Week to enable time based log rotation. so to get 90 days of audit logs config would be MAX_SCHEDD_AUDIT_LOG\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Aug-01 21:12", "status": "resolved", "created": "2013-Apr-02 11:44", "fixed_version": "2013-Apr-02 11:44", "broken_version": "v070905", "priority": "2", "subsystem": "Daemons", "assigned_to": "johnkn", "derived_from": "#3493", "creator": "johnkn", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "johnkn@cs.wisc.edu jfrey@cs.wisc.edu", "due_date": ""}