{"id": 1198, "title": "Ticket #1198: remove_kill_sig and kill_sig not used by condor_rm in vanilla universe", "description": "<blockquote>\nIn vanilla universe, condor_rm sends sigkill to job which means there is no way for the job to checkpoint itself, close files, etc in a soft kill manner. Use of sigkill should be last resort. Signals should be escalated such that remove_kill_sig is used. If no remove_kill_sig is specified, kill_sig should be used. The attached patch provides remove_kill_sig||kill_sig -&gt; QUIT -&gt; KILL signal escalation. If remove_kill_sig or kill_sig are not specified, the system defaults to previous condor_rm behavior.</blockquote>", "remarks": "<blockquote>\n<em>2010-Feb-23 10:09:37 by rrati:</em> <br/>\n\nproc_family_direct.cpp:\n- Typo in the EXCEPT?  signal_family -&gt; signal_children?\n\n<p>There's a lot of code similarity between ProcFamily*::signal_child and signal_process.  It'd be nice if we could restructure the code to use functions for the common functionality.\n\n</p><p>Please use an enumerated type for params to killHard rather than hard coded values.  Also for startKillTimer.\n\n</p><p>Rather than sigkillStarter1 and sigkillStarter2, how about a more descriptive name like sigkillStarterSIGKILL and sigkillStarterSIGQUIT.\n\n</p><p>The if in Starter::killHard can be simplified to something like:\n...\n\n</p><p>} else {\n   if (level==1) {\n      kill_sig=3; //SIGQUIT\n   }\n   if (daemonCore-&gt;Signal_Children(s_pid, kill_sig) == FALSE) {\n      dprintf(D_ALWAYS,\n              \"error killing process family of starter with pid %u\\n\",\n        s_pid);\n      return false;\n   } else {\n      dprintf(D_FULLDEBUG, \"in starter:killHard  starting kill timer\\n\");\n      startKillTimer(leve);\n}\n\n</p><p>submit.cpp:\n  If the sig_name isn't set by the job ad, then I believe you'll end up setting sig_name = NULL, which is then freed.  This isn't good practice, and could cause issues on some architectures.\n\n</p><p></p><hr/>\n<em>2010-Feb-24 13:50:30 by jrt:</em> <br/>\n\nproc_family_direct.cpp: - Typo in the EXCEPT? signal_family -&gt; signal_children?\n\n<p>-fixed\n\n</p><p>There's a lot of code similarity between ProcFamily*::signal_child and\nsignal_process. It'd be nice if we could restructure the code to use functions\nfor the common functionality.\n\n</p><p>-There was some duplicate code in signal_children that was removed.\n\n</p><p>&gt;Please use an enumerated type for params to killHard rather than hard coded\n&gt;values. Also for startKillTimer.\n\n</p><p>-fixed\n\n</p><p>Rather than sigkillStarter1 and sigkillStarter2, how about a more descriptive name like sigkillStarterSIGKILL and sigkillStarterSIGQUIT.\n\n</p><p>-fixed\n\n</p><p>The if in Starter::killHard can be simplified to something like: ...\n\n</p><p>} else { if (level==1) { kill_sig=3; //SIGQUIT } if (daemonCore-&gt;Signal_Children(s_pid, kill_sig) == FALSE) { dprintf(D_ALWAYS, \"error killing process family of starter with pid %u\\n\", s_pid); return false; } else { dprintf(D_FULLDEBUG, \"in starter:killHard starting kill timer\\n\"); startKillTimer(leve); }\n\n</p><p>-Actually wrote it this way on purpose so as to provide default behavior. I was just concerned if a programmer somehow used a level that was out of bounds. This section was changed somewhat due to the enum.\n\n</p><p>submit.cpp: If the sig_name isn't set by the job ad, then I believe you'll end up setting sig_name = NULL, which is then freed. This isn't good practice, and could cause issues on some architectures.\n\n</p><p>-fixed, We could avoid making this and the change in classad_helpers.cpp if people were OK with changing the default behavior (when no kill_sig or remove_kill_sig is specified by the jdf) to be TERM-&gt;QUIT-&gt;KILL rather than just KILL. That would mean kill_sig defaults to TERM unless specified in the jdf.\n\n</p><p></p><hr/>\n<em>2010-Mar-15 11:47:01 by rrati:</em> <br/>\n\nMade some changes to the implementation, namely moving the signal escalation into the starter from the startd.\n\n<p></p><hr/>\n<em>2010-Mar-17 14:36:15 by rrati:</em> <br/>\n\nCustom signals are already not supported on windows, so signal escalation (including the new kill_sig_timeout) is also not supported on Windows.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1289\" onclick=\"get_ticket_and_populate_wrapper('1289'); return false;\" title=\"Custom Signals can be defined for vanilla universe jobs\">#1289</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCustom Signals can be defined for vanilla universe jobs</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2142\" onclick=\"get_ticket_and_populate_wrapper('2142'); return false;\" title=\"KILLING_TIMEOUT overrides KILL policy\">#2142</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nKILLING_TIMEOUT overrides KILL policy</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/138/signal.patch\">signal.patch</a>\n18932 bytes added by jrt on 2010-Feb-10 16:24:21 UTC.\n<br/>\nvanilla u condor_rm patch<br/>\n</li><li><a href=\"../files/141/signal.patch\">signal.patch</a>\n18858 bytes added by jrt on 2010-Feb-24 19:33:28 UTC.\n<br/>\nupdated patch that addresses most of the concerns<br/>\n</li><li><a href=\"../files/143/signal.patch\">signal.patch</a>\n19197 bytes added by jrt on 2010-Mar-02 15:10:52 UTC.\n<br/>\nrevised patch removing some dup code.<br/>\n</li><li><a href=\"../files/147/signal.patch\">signal.patch</a>\n13693 bytes added by rrati on 2010-Mar-15 16:46:03 UTC.\n<br/>\nMoves signal escalation into starter and allows the job submit file to define 'sig_kill_timeout' which will define how long the starter will wait before hard killing the job.  sig_kill_timeout must be less than killing_timeout, or the starter will wail killing_timeout-1 before hard killing the job.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-22 14:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/50cb90ec273d8e9ca977c6d4ae5217990261a011\">[25378]</a></span>: updated submit cmd kill_sig, added new cmd kill_sig_timeout, added associated job <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> attributes, and defn of config knob KILLING_TIMEOUT (gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1289\" onclick=\"get_ticket_and_populate_wrapper('1289'); return false;\" title=\"Custom Signals can be defined for vanilla universe jobs\">#1289</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1198\" onclick=\"get_ticket_and_populate_wrapper('1198'); return false;\" title=\"remove_kill_sig and kill_sig not used by condor_rm in vanilla universe\">#1198</a></span>)  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-17 07:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0336df130570374ebac24d5a4c87986ef5b632e9\">[17645]</a></span>: Fixed windows build broken with signal escalation (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1198\" onclick=\"get_ticket_and_populate_wrapper('1198'); return false;\" title=\"remove_kill_sig and kill_sig not used by condor_rm in vanilla universe\">#1198</a></span>)  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-16 10:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89647a48e9952262d54644e053c9e4714a9734c3\">[17639]</a></span>: Fixed issue with undefined job timeout resulting in escalation timer firing immediately (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1198\" onclick=\"get_ticket_and_populate_wrapper('1198'); return false;\" title=\"remove_kill_sig and kill_sig not used by condor_rm in vanilla universe\">#1198</a></span>)  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-16 10:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/47ae8502643325b6919f35c9bf68adcbfb5d6cc2\">[17638]</a></span>: Fixed merge issues (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1198\" onclick=\"get_ticket_and_populate_wrapper('1198'); return false;\" title=\"remove_kill_sig and kill_sig not used by condor_rm in vanilla universe\">#1198</a></span>)  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-16 10:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0081bcdd32d1dcd8302c03dc30dc40529b0af068\">[17637]</a></span>: - Removed commented out code and performed some cleanup - The startd will now always wait killing_timeout regardless of what timeout the job sets, and the starter will use the smaller value of the job timeout and killing_timeout-1 - The starter also won't EXCEPT if it is unable to set the signal escalation\u00a0[...]\n (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-16 10:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1a9c09e6bee81484b0a488c5b96422bbd4c613aa\">[17636]</a></span>: Moved the signal escalation into the starter. The starter will use the signal defined by the job, then kill the job if it doesn't respond. Job submit files can set 'kill_sig_timeout' to tell the starter how long to wait after sending the custom signal before outright killing the job. The startd will\u00a0[...]\n (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-16 10:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/efd5906c1588f262f997f45dcc4582197c452797\">[17635]</a></span>: Vanilla Universe jobs can be killed gracefully allowing them to checkpoint and cleanup, rather than be forcably removed from the system. (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1198\" onclick=\"get_ticket_and_populate_wrapper('1198'); return false;\" title=\"remove_kill_sig and kill_sig not used by condor_rm in vanilla universe\">#1198</a></span>) Committer: Robert Rati  (By Jon Thomas )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Mar-17 14:36", "status": "resolved", "created": "2010-Feb-10 10:23", "fixed_version": "2010-Feb-10 10:23", "broken_version": "v070401", "priority": "2", "subsystem": "Daemons", "assigned_to": "jrt", "derived_from": "", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, rrati@redhat.com", "due_date": ""}