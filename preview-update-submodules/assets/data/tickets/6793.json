{"id": 6793, "title": "Ticket #6793: pslot preemption bug could preempt some dslots in error", "description": "<blockquote>\nA bug in <code>Matchmaker::pslotMultiMatch()</code> can result in preemption of dslots unnecessarily when ALLOW_PSLOT_PREEMPTION=True.</blockquote>", "remarks": "<blockquote>\n<em>2018-Oct-15 14:43:35 by tlmiller:</em> <br/>\n\nJaimeF also agrees that the code in question looks buggy.  Since GregT is in China for the next two weeks, I've started work on the obvious patch and will ask the customer to test it.\n\n<p></p><hr/>\n<em>2018-Oct-15 15:07:19 by tlmiller:</em> <br/>\n\nAssuming the BaTLab tests pass, it seems like the following should work.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">commit 7a10cd53fdc1597245ff5f19b20dedc661523135\nAuthor: Todd L Miller &lt;tlmiller@cs.wisc.edu&gt;\nDate:   Mon Oct 15 15:00:13 2018 -0500\n\n    (#6793)  See if the naive fix works.\n\ndiff --git a/src/condor_negotiator.V6/matchmaker.cpp b/src/condor_negotiator.V6/\nmatchmaker.cpp\nindex d930398..7247353 100644\n--- a/src/condor_negotiator.V6/matchmaker.cpp\n+++ b/src/condor_negotiator.V6/matchmaker.cpp\n@@ -6953,6 +6953,7 @@ Matchmaker::pslotMultiMatch(ClassAd *job, ClassAd *machine, double preemptPrio,\n        }\n\n                // In rank order, see if by preempting one more dslot would cause pslot to match\n+       std::list&lt;int&gt; usableDSlots;\n        for (unsigned int slot = 0; slot &lt; ranks.size() &amp;&amp; ranks[slot].second &lt;= newRank; slot++) {\n                int dSlot = ranks[slot].first; // dslot index in childXXX list\n\n@@ -7000,10 +7001,10 @@ Matchmaker::pslotMultiMatch(ClassAd *job, ClassAd *machine, double preemptPrio,\n                                continue;\n                        }\n\n-                       // Finally, if we made it here, this slot is a candidate for preemption,\n-                       // fall through and try to merge its resources into the pslot to match\n-                       // and preempt this one.\n-\n+                       // Finally, if we made it here, this slot is a candidate for\n+                       // preemption, fall through and try to merge its resources into\n+                       // the pslot to match and preempt this one.\n+                       usableDSlots.push_back(slot);\n                }\n\n                        // for each splitable resource, get it from the dslot, and add to pslot\n@@ -7039,7 +7040,10 @@ Matchmaker::pslotMultiMatch(ClassAd *job, ClassAd *machine, double preemptPrio,\n                        dprintf(D_FULLDEBUG, \"Matched pslot by rank preempting %d dynamic slots\\n\", slot + 1);\n                        dslot_claims.clear();\n\n-                       for (unsigned int child = 0; child &lt; slot + 1; child++) {\n+//                     for (unsigned int child = 0; child &lt; slot + 1; child++) {\n+                       auto i = usableDSlots.begin();\n+                       for( ; i != usableDSlots.end(); ++i ) {\n+                               int child = *i;\n                                dslot_claims += child_claims[ranks[child].first];\n                                dslot_claims += \" \";\n                                // TODO Move this clearing of claim ids to\n</pre></div>\n\n\n<p></p><hr/>\n<em>2018-Oct-17 16:28:21 by tlmiller:</em> <br/>\n\nSent the Windows 10 build from run ID 451957 to the user for testing.\n\n<p></p><hr/>\n<em>2018-Oct-17 16:53:58 by jfrey:</em> <br/>\n\nI have tested this patch and it works properly. There is one change that's needed. In the dprintf(\"Matched pslot by rank preempting %d dynamic slots\\n\") message, the final argument should be changed to <code>(int)usableDSlots.size()</code>.\n\n<p></p><hr/>\n<em>2018-Oct-17 17:24:21 by tlmiller:</em> <br/>\n\nChange made.  Patch approved by TJ for 8.6.13; hopefully we'll get good new from the user, too.\n\n<p></p><hr/>\n<em>2018-Oct-18 11:13:55 by jfrey:</em> <br/>\n\nOne more change is required. The <code>usableDSlots.push_back(slot);</code> statement needs to be moved below the following closing brace. It needs to happen regardless of the relative ranks of candidate job and currently-running job.\n\n<p></p><hr/>\n<em>2018-Oct-18 11:49:12 by tlmiller:</em> <br/>\n\nI'm not adding documentation for the second patch, as the code was never released and the description of the fix didn't change.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-18 11:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0346bfc53f6d569f47a31763f7595927ff7ddc74\">[55586]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6793\" onclick=\"get_ticket_and_populate_wrapper('6793'); return false;\" title=\"pslot preemption bug could preempt some dslots in error\">#6793</a></span>) Make pure rank preemption work for pslots.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-17 17:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e13f984748802535e104b2a49d6ca04aa92127a2\">[55584]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6793\" onclick=\"get_ticket_and_populate_wrapper('6793'); return false;\" title=\"pslot preemption bug could preempt some dslots in error\">#6793</a></span>) Fix a bug in Matchmaker::pslotMultiMatch() where the negotiator could preempt dslots it had decided not to.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Oct-19 15:24", "status": "resolved", "created": "2018-Oct-09 15:25", "fixed_version": "2018-Oct-09 15:25", "broken_version": "v080611", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "tlmiller", "derived_from": "#4699", "creator": "tlmiller", "rust": "s94137", "customer_group": "other", "visibility": "public", "notify": "Alex.Butterworth@gresearch.co.uk", "due_date": ""}