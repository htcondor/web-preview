{"id": 5821, "title": "Ticket #5821: Adding preemptible and service accounts to gce_gahp", "description": "<blockquote>\n<pre>    Enhance gce_gahp with preemptible instances and service accounts\n</pre>\n\n<p></p><pre>        - Add a new boolean gce_preemptible attribute.  Setting this\n          will allow gce_gahp to submit preemptible instances that have\n          lower cost but can be terminated.\n        - Add support for service accounts that have no refresh token\n          but instead have access tokens with a limited expiration.</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Aug-02 15:43:54 by dstrain:</em> <br/>\n\nI also need help modifying documentation to include the new attribute and updating the information regarding some obsolete gce attributes.\n\n<p>(For instance, gce_image is no longer a GCS URL, it is the name of the image.\nSee <a class=\"external\" href=\"https://cloud.google.com/compute/docs/reference/beta/instances/insert\">https://cloud.google.com/compute/docs/reference/beta/instances/insert</a> (disks[].initializeParams.sourceImage))\n\n</p><p></p><hr/>\n<em>2016-Aug-03 13:33:01 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This is an initial review before I disappear on vacation. I'll do a more thorough review after I return.\n\n</p><p></p><ul>\n<li>Try to match the indenting style of the surrounding code. For most code, that will be tabs with stops set to 4 spaces.\n\n<p></p></li><li>In submit.cpp, the symbol ATTR_GCE_METAPREEMPTIBLE is used but never defined. Should it be ATTR_GCE_PREEMPTIBLE?\n\n<p></p></li><li>If the only permitted values for <code>preemptible</code> are <code>true</code> and <code>false</code>, then the value should be a boolean type in condor_submit and condor_gridmanager.\n\n<p></p></li><li>Use timegm() instead of mktime(). timegm() or an equivalent appears to be available on all of our supported platforms.\n</li></ul>\n\n<p></p><hr/>\n<em>2016-Aug-03 13:36:11 by dstrain:</em> <br/>\n\nThanks for the review!  I will fix all of these.  Shall I re-send the patch in git format again once I have done so?\n\n<p>When are you returning from vacation, so I can plan accordingly?\n\n</p><p></p><hr/>\n<em>2016-Aug-10 16:19:18 by jfrey:</em> <br/>\n\nI'll take a look at the new patch tomorrow.\n\n<p></p><hr/>\n<em>2016-Aug-11 16:16:48 by jfrey:</em> <br/>\n\nI've committed the 2nd patch with some minor revisions. I don't know how to test with a service account. Are you able to do that, Doug?\n\n<p></p><hr/>\n<em>2016-Aug-11 17:08:26 by dstrain:</em> <br/>\n\nThanks!\n\n<p>I have appended a screenshot with how to get a service account key.  You may also have to give the account instance api permission.  More info here:\n<a class=\"external\" href=\"https://cloud.google.com/iam/docs/service-accounts?hl=en_US&amp;_ga=1.190817323.1246630748.1450485206\">https://cloud.google.com/iam/docs/service-accounts?hl=en_US&amp;_ga=1.190817323.1246630748.1450485206</a>\n\n</p><p>I have also done some testing with my patch.  I'll resync with the git repo and do some more testing.  The main thing I am worried about is the corner cases with the authentication expiring (the service account auth only lasts an hour).  These take a while to test since you have to wait an hour for the auth to expire.\n\n</p><p>Also, there are some documentation fixes that should be done to add gce_preemptible to the documentation.  Also, gce_image in the following link should be updated.  It's not a GCS url anymore.  You should now specify an image name, such as \"projects/debian-cloud/global/images/family/debian-8\" or \"global/images/IMAGE_NAME\".\n<a class=\"external\" href=\"http://research.cs.wisc.edu/htcondor/manual/v8.5.4/5_3Grid_Universe.html#SECTION00637100000000000000\">http://research.cs.wisc.edu/htcondor/manual/v8.5.4/5_3Grid_Universe.html#SECTION00637100000000000000</a>\n\n</p><p>Can you assist with the documentation changes?\n\n</p><p></p><hr/>\n<em>2016-Aug-12 10:27:57 by jfrey:</em> <br/>\n\nI've already made the changes to the documentation about gce_preemptible. I can do the rest today.\n\n<p>The documentation lives in the <code>doc</code> directory of the git repository. You can run <code>make ref.pdf</code> while in that directory to build the manual.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/958/0001-Enhance-gce_gahp-with-preemptible-instances-and-serv.patch\">0001-Enhance-gce_gahp-with-preemptible-instances-and-serv.patch</a>\n13080 bytes added by dstrain on 2016-Aug-02 20:20:23 UTC.\n<br/>\nAttached is a patch in git format (from \"git format-patch -n) taken from condor head (last commit 087f539, \"condor_status -ads support for xml,json...\")\n\n<p>Let me know if you want me to send the patch in another format or change anything.<br/>\n</p></li><li><a href=\"../files/959/0002-Enhance-gce_gahp-with-preemptible-instances-and-serv.patch\">0002-Enhance-gce_gahp-with-preemptible-instances-and-serv.patch</a>\n12659 bytes added by dstrain on 2016-Aug-05 23:15:36 UTC.\n<br/>\nAttached is the 2nd revision for the code patch.\n\n<p>- Tried to match formatting.  Let me know if I missed anything\n- Fixed ATTR_GCE_METAPREEMPTIBLE typo\n- Changed mktime() to timegm()\n- Changed gce_preemptible to bool\n\n</p><p>Please let me know if you have additional concerns.\n<br/>\n</p></li><li><a href=\"../files/961/service_accounts.png\">service_accounts.png</a>\n163159 bytes added by dstrain on 2016-Aug-11 22:00:20 UTC.\n<br/>\nScreenshot to create a key for a service account. Go to IAM Admin =&gt; Service account.  From there, you can create a service account and create a key.\n\n<p>Then, gcloud auth activate-service-account EMAIL --key-file KEY_FILE\nThen, gcloud auth login EMAIL<br/>\n</p></li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-11 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b5ed68827207f187eb46703a4a9abe3667936f70\">[48994]</a></span>: Docs for gce_preemptible submit attr and service account support. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5821\" onclick=\"get_ticket_and_populate_wrapper('5821'); return false;\" title=\"Adding preemptible and service accounts to gce_gahp\">#5821</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-11 15:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c8cda629586a32e12b8e804718485275e986b69\">[48993]</a></span>: For GCE, support service accounts with no refresh token. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5821\" onclick=\"get_ticket_and_populate_wrapper('5821'); return false;\" title=\"Adding preemptible and service accounts to gce_gahp\">#5821</a></span> These accounts instead have an access token with a limited expiration. Committer: Jaime Frey  (By Doug Strain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-11 15:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6bc91579de18b412b6ce23e27addab6d745ee61f\">[48992]</a></span>: Add gce_preemptible to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SubmitHash\" title=\"Submit Hash\">SubmitHash</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5821\" onclick=\"get_ticket_and_populate_wrapper('5821'); return false;\" title=\"Adding preemptible and service accounts to gce_gahp\">#5821</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-11 15:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6781ffd8024966c672acd782057c1c73b88b65d\">[48991]</a></span>: Allow submission of preemptible GCE instances. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5821\" onclick=\"get_ticket_and_populate_wrapper('5821'); return false;\" title=\"Adding preemptible and service accounts to gce_gahp\">#5821</a></span> New submit attribute gce_preemptible allows the user to specify whether GCE instances should be preemptible. Committer: Jaime Frey  (By Doug Strain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Sep-08 16:03", "status": "resolved", "created": "2016-Aug-02 15:16", "fixed_version": "2016-Aug-02 15:16", "broken_version": "v080104", "priority": "4", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "dstrain", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "dstrain@google.com", "due_date": ""}