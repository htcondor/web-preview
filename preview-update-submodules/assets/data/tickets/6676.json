{"id": 6676, "title": "Ticket #6676: singularity should use --pwd argument when on shared filesystems", "description": "<blockquote>\nI'm working a bit with singularity and how to make it work on shared filesystems. I think I\"ve got an easy one to fix.\n\n<p>Here is my submit file. I'm working on Debian 9 with a backport of the 8.6.8 release from debian testing. I've got a specific execute node I'm working with whose relevant config is below.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">executable = /bin/ls\nArguments = -lh\n+SingularityImage = \"/cvmfs/ligo-containers.opensciencegrid.org/dockerhub/ligo/software:stretch\"\nrequirements = Machine == \"execute3012.nemo.uwm.edu\"\ninitialdir = /home/tpdownes/singularity-testing\nUniverse = vanilla\nError = singularity-$(ClusterId).err\nOutput = singularity-$(ClusterId).out\nLog = singularity-$(ClusterId).log\naccounting_group = cgca.condor\nQueue 1\n</pre></div>\n\n\n<p>I have singularity.conf configured on the execute node to bind mount /home but to make no attempt to bind mount the specific users directory. The point being that I want users to be able to traverse to other user's home directories (a common use case) and this combination is the one that is most predictable for both the Condor use case and the <code>singularity shell</code> use case at the command line.\n</p><div class=\"code\">\n<pre class=\"code\">mount home = no\nbind path = /home\n</pre></div>\n\n\n<p>On condor, I have to explicitly give it /home to bind:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">SINGULARITY_JOB = !isUndefined(TARGET.SingularityImage)\nSINGULARITY_IMAGE_EXPR = TARGET.SingularityImage\nSINGULARITY_BIND_EXPR = \"/home:/home:rw\"\n</pre></div>\n\n\n<p>This causes the execution of\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">05/11/18 10:10:20 Attempting to run: '/usr/bin/singularity /usr/bin/singularity --version'.\n05/11/18 10:10:20 [singularity version] 2.5.1-dist\n05/11/18 10:10:20 Parsing bind mount specification for singularity: /home:/home:rw\n05/11/18 10:10:20 Arguments updated for executing with singularity: /usr/bin/singularity exec -B /home:/home:rw -B /localscratch/condor/execute/dir_122520 -B /home/tpdownes/singularity-testing -C /cvmfs/ligo-containers.opensciencegrid.org/dockerhub/ligo/software:stretch /bin/ls -lh\n05/11/18 10:10:20 Running job via singularity.\n</pre></div>\n\n\n<p>But... the output is that of my home directory even though I've explicitly set <code>initialdir</code> above (just to be extra-certain). Manually running\n</p><div class=\"code\">\n<pre class=\"code\">/usr/bin/singularity exec --pwd $(pwd) -B /home:/home:rw -B /localscratch/condor/execute/dir_122520 -B /home/tpdownes/singularity-testing -C /cvmfs/ligo-containers.opensciencegrid.org/dockerhub/ligo/software:stretch /bin/ls -lh\n</pre></div>\n\n\n<p>Has the expected behavior. So does, of course, the same submit file without <code>+SingularityImage</code>. So I think the solution is to use the <code>--pwd</code> argument explicitly, at least on shared filesystems. It may be relevant even for the non-shared case, too.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-May-11 10:25:21 by tpdownes:</em> <br/>\n\nSetting\n<div class=\"code\">\n<pre class=\"code\">SINGULARITY_TARGET_DIR = /srv\n</pre></div>\n\n\n<p>only has the expected impact of properly bind mounting the scratch dir to /srv\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">05/11/18 10:23:34 Attempting to run: '/usr/bin/singularity /usr/bin/singularity --version'.\n05/11/18 10:23:34 [singularity version] 2.5.1-dist\n05/11/18 10:23:34 Parsing bind mount specification for singularity: /home:/home:rw\n05/11/18 10:23:34 Arguments updated for executing with singularity: /usr/bin/singularity exec -B /home:/home:rw -B /localscratch/condor/execute/dir_123375:/srv -B /home/tpdownes/singularity-testing -C /cvmfs/ligo-containers.opensciencegrid.org/dockerhub/ligo/software:stretch /bin/ls -lh\n05/11/18 10:23:34 Running job via singularity.\n</pre></div>\n\n\n<p>It has no impact on the actual working directory of singularity. Which remains the user home directory.\n\n</p><p></p><hr/>\n<em>2018-May-11 11:04:14 by tpdownes:</em> <br/>\n\nOutwardly appears that you're <a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/5bd644152df22f6a83abb1741996d06a04e7da05/src/condor_starter.V6.1/singularity.cpp#L195\">explicitly ignoring this use case</a>.\n\n<p></p><hr/>\n<em>2019-Jun-05 09:59:36 by gthain:</em> <br/>\n\nSingularity doesn't like to have bind mounts inside of other bind mounts. This happens with a condor shared filesystem often, because singularity, by default bind mounts home directories.  To fix this, condor will disable this by default, with a knob\n\n<p>SINGULARITY_MOUNT_HOME = true</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-02 14:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/07686a742ca9a69b561ecc86fda0cd0c71de7189\">[57282]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6676\" onclick=\"get_ticket_and_populate_wrapper('6676'); return false;\" title=\"singularity should use --pwd argument when on shared filesystems\">#6676</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-05 10:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3c24539ccaad310d1d12eeb12d2fd07c36cd707f\">[57106]</a></span>: Singularity should not mount users home directory by default <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6676\" onclick=\"get_ticket_and_populate_wrapper('6676'); return false;\" title=\"singularity should use --pwd argument when on shared filesystems\">#6676</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Jul-09 15:14", "status": "resolved", "created": "2018-May-11 10:19", "fixed_version": "2018-May-11 10:19", "broken_version": "v080608", "priority": "3", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "downes@uwm.edu,pcouvare@caltech.edu, gthain@cs.wisc.edu", "due_date": ""}