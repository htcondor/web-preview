{"id": 5986, "title": "Ticket #5986: Selector shouldn't allocate fd_sets if checking a single fd", "description": "<blockquote>\nThe Selector class contains an optimization to use poll() instead of select() when checking the status of a single fd. But it still allocates and initializes fd_sets in this case. We should improve it to avoid these operations when only one fd is being queried.</blockquote>", "remarks": "<blockquote>\n<em>2017-Sep-11 10:05:39 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-01 11:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5905216b77d9c9b886c5b19507b5d93c452f722a\">[51974]</a></span>: Don't touch max_fd in Selector::init_fd_sets() <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5986\" onclick=\"get_ticket_and_populate_wrapper('5986'); return false;\" title=\"Selector shouldn't allocate fd_sets if checking a single fd\">#5986</a></span> max_fd is always updated by add_fd(). Trying to set it in init_fd_sets() may record the wrong value when called from add_fd().  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-31 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aa0b652715afbe72530047c3410c4f131e4fa86a\">[51969]</a></span>: Fix wrong bit operator in Selector conditionals. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5986\" onclick=\"get_ticket_and_populate_wrapper('5986'); return false;\" title=\"Selector shouldn't allocate fd_sets if checking a single fd\">#5986</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-31 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3befc71980f6e7d1a3b3afe1a11723d50243f1d1\">[51968]</a></span>: Revert \"Revert \"Don't allocate fd_sets in Selector when using poll(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5986\" onclick=\"get_ticket_and_populate_wrapper('5986'); return false;\" title=\"Selector shouldn't allocate fd_sets if checking a single fd\">#5986</a></span>\"\" This reverts commit 03488031af54284e729178e4526780ca09387acd. Un-revert improvements to Selector class, now on a branch for debugging.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-31 15:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/03488031af54284e729178e4526780ca09387acd\">[51965]</a></span>: Revert \"Don't allocate fd_sets in Selector when using poll(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5986\" onclick=\"get_ticket_and_populate_wrapper('5986'); return false;\" title=\"Selector shouldn't allocate fd_sets if checking a single fd\">#5986</a></span>\" This reverts commit 12076cf519f49f592f65f1045ed4fbe77b5ae6b9. This change has several problems that need to be fixed.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-28 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/12076cf519f49f592f65f1045ed4fbe77b5ae6b9\">[51961]</a></span>: Don't allocate fd_sets in Selector when using poll(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5986\" onclick=\"get_ticket_and_populate_wrapper('5986'); return false;\" title=\"Selector shouldn't allocate fd_sets if checking a single fd\">#5986</a></span> Avoid allocating and initializing fd_sets in the Selector class until needed (when a second fd is added and we thus decide to use select() instead of poll()).  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Sep-11 10:06", "status": "resolved", "created": "2016-Oct-31 11:18", "fixed_version": "2016-Oct-31 11:18", "broken_version": "v080500", "priority": "4", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}