{"id": 6195, "title": "Ticket #6195: Job Router crash on error reading job_queue.log", "description": "<blockquote>\nThe Job Router can crash when it has trouble reading the schedd's job_queue.log file. This is due to fclose() being called twice on the same FILE struct. Reported by CERN.\n\n<p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogReader\" title=\"Class Ad Log Reader\">ClassAdLogReader</a></span> object shares one FILE struct between two <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogParser\" title=\"Class Ad Log Parser\">ClassAdLogParser</a></span> objects. One parser checks whether the job log has grown or rotated, and the other reads the log events for processing. On certain errors reading the file, both parser objects will close the FILE struct.\n\n</p><p>I propose to modify <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogParser\" title=\"Class Ad Log Parser\">ClassAdLogParser</a></span> such that if it is given a FILE struct (instead of calling fopen() itself), it will not call fclose() on it. That will remove this double-close situation. I will make some further changes to reduce the chance for leaking open files when the caller isn't careful about calling closeFile() when necessary.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Apr-04 13:31:01 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> changes look good.\n\n<p></p><hr/>\n<em>2017-Apr-11 15:35:40 by jfrey:</em> <br/>\n\nNo additional documentation needed, as this is a bug fix.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-11 15:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a7031bf047b72d562cc0e09c9626547bd46f57bb\">[50448]</a></span>: Docs for job router crash on bad job_queue.log entries bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6195\" onclick=\"get_ticket_and_populate_wrapper('6195'); return false;\" title=\"Job Router crash on error reading job_queue.log\">#6195</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-23 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1661359d4d52018468cd685e5de41cf9d249b866\">[50361]</a></span>: Fix job router error messages to include <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log filename. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6195\" onclick=\"get_ticket_and_populate_wrapper('6195'); return false;\" title=\"Job Router crash on error reading job_queue.log\">#6195</a></span> Fix method name in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NewClassAdJobLogConsumer\" title=\"New Class Ad Job Log Consumer\">NewClassAdJobLogConsumer</a></span> to override method from the base class, so that the log filename is available for error messages.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-16 15:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8eb6098857fe9a84b569644de43449c7533c2d3b\">[50331]</a></span>: Eliminate double-fclose() on error reading <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log file. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6195\" onclick=\"get_ticket_and_populate_wrapper('6195'); return false;\" title=\"Job Router crash on error reading job_queue.log\">#6195</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogParser\" title=\"Class Ad Log Parser\">ClassAdLogParser</a></span> no longer closes a FILE struct that it didn't create itself. This fixes a double-close bug in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogReader\" title=\"Class Ad Log Reader\">ClassAdLogReader</a></span>, which uses a single FILE struct shared between two <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogParser\" title=\"Class Ad Log Parser\">ClassAdLogParser</a></span> objects. <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLogParser\" title=\"Class Ad Log Parser\">ClassAdLogParser</a></span> is also more\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Apr-11 15:35", "status": "resolved", "created": "2017-Mar-16 14:05", "fixed_version": "2017-Mar-16 14:05", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "", "due_date": ""}