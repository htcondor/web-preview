{"id": 4443, "title": "Ticket #4443: Allow sysadmins to enable PR_SET_NO_NEW_PRIVS", "description": "<blockquote>\nprctl(PR_SET_NO_NEW_PRIVS, ...) can be invoked by the forked starter (no root privs required) before it exec's to the user's job.\n\n<p>This prctl flag prevents any processes launched by the job from gaining any capabilities (for example, by executing a setuid binary).\n\n</p><p>This may not actually be a desired thing at all sites - for example, CMS relies on glexec which is setuid - but it is likely going to cover the majority of cases.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-04 09:58:45 by bbockelm:</em> <br/>\n\ngthain, could you kindly review this branch?\n\n<p></p><hr/>\n<em>2014-Jul-10 16:53:54 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks like turning off privs breaks condor_ssh_to_job\n\n</p><p>Priv sep is officially no longer supported, so we don't need to check for it.\n\n</p><p>If a particular build of condor doesn't support PR_SET_NO_NEW_PRIVS, should it be fatal if someone tries to turn it on?  I'm thinking about a pool of mixed distro pool.\n\n</p><p></p><hr/>\n<em>2014-Jul-10 19:53:02 by bbockelm:</em> <br/>\n\nHi Greg,\n\n<p>That's a bit surprising - do you know what would be wrong with ssh_to_job?  I didn't think that would be setuid...\n\n</p><p>I would indeed like to make things Big Loud and Fatal if NO_NEW_PRIVS is enabled but the distro doesn't support it - if a site depends on it for security, I don't like to fail silently.  Since the machine ad is available when it is evaluated, sysadmins can conditionally disable it on a mixed distro pool.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Jul-11 08:20:29 by gthain:</em> <br/>\n\nNo idea what is wrong -- it was a bit of a surprise to me, too.  We don't start sshd as root, and it isn't setuid/setgid, nor is ssh-keygen.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-04 12:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/36b95503432cb95d9a007b1a12945e9b24ff6a8a\">[40550]</a></span>: Evaluate JOB_NO_NEW_PRIVS within a classad context <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=4443\" onclick=\"get_ticket_and_populate_wrapper('4443'); return false;\" title=\"Allow sysadmins to enable PR_SET_NO_NEW_PRIVS\">#4443</a></span>. Evaluate JOB_NO_NEW_PRIVS within the context of the job and machine ads (if they exist). This allows sysadmins to conditionally enable this feature. For example, setting:\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-04 09:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0b63d78ceb145a387d33d78d7b3472f4490f5e21\">[40548]</a></span>: Add support for PR_SET_NO_NEW_PRIVS (<span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=4443\" onclick=\"get_ticket_and_populate_wrapper('4443'); return false;\" title=\"Allow sysadmins to enable PR_SET_NO_NEW_PRIVS\">#4443</a></span>). This adds a new parameter, JOB_NO_NEW_PRIVS (defaults to False) which causes prctl(PR_SET_NO_NEW_PRIVS, 1) to be invoked prior to exec'ing the job. When this prctl flag is set, the job and its dependent processes will be unable to acquire new privileges (for\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Jul-11 08:20", "status": "review", "created": "2014-Jul-03 08:15", "fixed_version": "2014-Jul-03 08:15", "broken_version": "", "priority": "4", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}