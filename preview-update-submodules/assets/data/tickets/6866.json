{"id": 6866, "title": "Ticket #6866: scitokens: Skip credd redirect to webpage", "description": "<blockquote>\nThe TOKENS/OAuth mode assumes a very specific behavior of the CREDMON - particularly that the user needs to go to a corresponding URL run on the schedd.\n\n<p>This is not true in the case of the OSG-Connect hosts, where the CREDMON has the private key needed to issue its own tokens.  I propose adding a new flag, <code>CREDMON_WEB_REDIRECT=[true||false]</code> (naming should be parallel with <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6862\" onclick=\"get_ticket_and_populate_wrapper('6862'); return false;\" title=\"scitokens: admin cannot define hostname:port of credmon webserver\">#6862</a></span>) that allows the credd to skip any web requests and just wait for the CREDMON_COMPLETE file.\n\n</p><p>With this, I think we can migrate the OSG-Connect setup to use the new TOKENS mode.\n\n</p><p>[Note: this ticket might be deeper than expected as we might need the jobs to start life on hold until the corresponding credential appears... Needs to be investigated by the implementer]</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-07 21:17:36 by bbockelm:</em> <br/>\n\nIt seems that the credd redirect to webpage can be done for a single provider if <code>SEC_CREDENTIAL_PRODUCER</code> is set (provided you don't mind it's called \"scitokens\"; see  <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=6909\" onclick=\"get_ticket_and_populate_wrapper('6909'); return false;\" title='scitokens: Do not force credential to be named \"scitokens.top\"'>#6909</a></span>).\n\n<p>It appears that <code>SEC_CREDENTIAL_PRODUCER</code> has undocumented magic values such as <code>CREDENTIAL_ALREADY_STORED</code> (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6091\" onclick=\"get_ticket_and_populate_wrapper('6091'); return false;\" title=\"DAGMan cannot submit jobs with AFS / Kerberos support enabled\">#6091</a></span>); I'd like to add more semantics:\n\n</p><p></p><ol>\n<li>If <code>SEC_CREDENTIAL_PRODUCER</code> is set to <code>SEND_CREDENTIAL_REQUEST</code>, instead of fork/exec'ing the credential producer, it will send the job's blocking credential requests as a list of base64-encoded classads to the credd.  These \"credential requests\" will have the same contents as the OAuth credential requests (that may end up requesting the user to go to the web UI).\n</li><li>If the admin sets <code>&lt;SERVICENAME&gt;_BLOCKING = True</code> in the configuration file, then we assume that any credential requests for this particular service are sent as above and not as part of the requests sent for \"oauth mode\" that might result in a web URL being generated.\n</li></ol>\n\n<p>This will allow the credmon to get all the requests that do not require a full OAuth2 workflow at once and process them before the job is queued.\n</p><hr/>\n<em>2020-Apr-10 07:46:13 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2020-Nov-09 10:53", "status": "new", "created": "2019-Jan-16 20:47", "fixed_version": "2019-Jan-16 20:47", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "jpatton@cs.wisc.edu,tannenba@cs.wisc.edu,bbockelman@morgridge.org", "due_date": ""}