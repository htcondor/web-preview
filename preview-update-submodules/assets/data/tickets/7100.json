{"id": 7100, "title": "Ticket #7100: Per-submitter Flocking", "description": "<blockquote>\nIt currently is quite complex for a user to \"bring their own resources\" to an existing HTCondor setup.  It requires careful coordination with the schedd's sysadmin and a very deep level of trust: the sysadmin basically must trust that user with any job (from any user) within the schedd.\n\n<p>We should allow the user to control which collectors they would like their jobs to flock to; in the case where the collector is not on the list of admin-approved flocks, the user should have to maintain their own authentication mechanism (only starting with TOKENS is acceptable).\n\n</p><p>This way, Anyone With A Credit Card can launch some startds and a collector on Amazon, setup TOKEN auth, and <code>condor_qedit</code> existing jobs to be able to flock to their new condor-in-the-cloud.\n\n</p><p>See design doc: <a class=\"external\" href=\"https://docs.google.com/document/d/18EA4_KVbVlXHiY5Hi33mYR8pmMTTQfikqtyd8Yh34lw/edit#\">https://docs.google.com/document/d/18EA4_KVbVlXHiY5Hi33mYR8pmMTTQfikqtyd8Yh34lw/edit#</a></p></blockquote>", "remarks": "<blockquote>\n<em>2019-Jul-22 21:44:49 by bbockelm:</em> <br/>\n\nOk, this one is ready to review:\n\n<p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/54\">https://github.com/htcondor/htcondor/pull/54</a>\n\n</p><p>The only churn past the original design is to use the refactored / common token request code and to make the submitter advertising non-blocking for user-level flocking.\n\n</p><p></p><hr/>\n<em>2019-Jul-24 11:32:27 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Fixed a typo in one place and updated a copy-paste comment in another.\n\n</p><p>I think this could use a review by Zach with respect to the new security aspects.\n\n</p><p>Otherwise, it looks pretty good.\n\n</p><p></p><hr/>\n<em>2019-Jul-24 11:33:08 by tlmiller:</em> <br/>\n\nTesting in BaTLab failed: <a class=\"external\" href=\"http://submit-3.batlab.org/results/run-details.php?runid=476081\">http://submit-3.batlab.org/results/run-details.php?runid=476081</a>\n\n<p></p><hr/>\n<em>2019-Jul-27 19:23:52 by tlmiller:</em> <br/>\n\nFirst test run of fixes:\n\n<p><a class=\"external\" href=\"http://submit-3.batlab.org/results/run-details.php?runid=476350\">http://submit-3.batlab.org/results/run-details.php?runid=476350</a>\n\n</p><p>Every platform failed <code>job_core_basic_par</code>, <code>cmd_status_shows-submitters</code>, <code>job_core_chirp_par</code>, and three failed <code>job_services_during_neg_cycle</code>, in addition to a few other platform-specific failures that may be transients.\n\n</p><p>Re-running after another merge from master to help see if these are real problems.\n\n</p><p>Second test run of fixes:\n\n</p><p><a class=\"external\" href=\"http://submit-3.batlab.org/results/run-details.php?runid=476636\">http://submit-3.batlab.org/results/run-details.php?runid=476636</a>\n\n</p><p></p><hr/>\n<em>2019-Jul-29 12:31:29 by bbockelm:</em> <br/>\n\nThanks!\n\n<p>I was able to reproduce &amp; fix all failures except <code>job_services_during_neg_cycle</code> (which appears to be better behaved on the second submission).  Fixes were pushed to the original github branch.\n\n</p><p>Please test again.\n\n</p><p></p><hr/>\n<em>2019-Jul-29 13:10:30 by tlmiller:</em> <br/>\n\nThanks for the patches.  New test run:\n\n<p><a class=\"external\" href=\"http://submit-3.batlab.org/results/run-details.php?runid=476679\">http://submit-3.batlab.org/results/run-details.php?runid=476679</a>\n\n</p><p></p><hr/>\n<em>2019-Jul-29 15:19:15 by tlmiller:</em> <br/>\n\nTrying again with\n\n<p><a class=\"external\" href=\"http://submit-3.batlab.org/results/run-details.php?runid=476696\">http://submit-3.batlab.org/results/run-details.php?runid=476696</a>\n\n</p><p>after a network issue blew up some builds (and newly remerged from master for some test fixes).\n\n</p><p></p><hr/>\n<em>2019-Jul-31 16:55:39 by tlmiller:</em> <br/>\n\nNew test runs look pretty good to me.  I think that means we're ready to merge?\n\n<p></p><hr/>\n<em>2019-Jul-31 19:34:56 by tlmiller:</em> <br/>\n\nBrian concurred.  Merge pushed.  Hopefully nothing bad happens (more changes to master since the last test, but they merged cleanly).\n\n<p></p><hr/>\n<em>2019-Aug-01 13:04:10 by tlmiller:</em> <br/>\n\nIn addition to the usual (reference-style) documentation, consider writing a little user-focused document about the scenario proposed in this ticket.  (Some of the documentation may well be clumsy; this identifies opportunities for further improvement.)</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7179\" onclick=\"get_ticket_and_populate_wrapper('7179'); return false;\" title=\"condor_annex should use TOKEN auth\">#7179</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_annex should use TOKEN auth</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-30 10:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7436a1c8e1b785d13523b9d33b4ff558dab9baf9\">[58292]</a></span>: Version history for <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7281\" onclick=\"get_ticket_and_populate_wrapper('7281'); return false;\" title=\"Exchange a SCITOKEN for a TOKEN\">#7281</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-01 13:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/150bc74fd61fab0747a4a6106128c50a2b33d7a6\">[57539]</a></span>: Punch hole for negotiators in the same way as startds. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span> Committer: Tim Theisen  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-31 22:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b6e3b3f8f5b52c6e1308a6c59c05a3585f36402e\">[57536]</a></span>: Avoid a potential segfault when finishing update. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-29 12:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/569c1f6761161883858cb4b01ef95d338563bd1b\">[57512]</a></span>: Fix counting of non-flocked jobs per submitter. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span> A conditional was reversed, causing running jobs to be ignored for the home pool. Additionally, this touches up some debugging lines I found necessary while trying to understand this problem.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-29 12:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4d783cb8a468f9de4a8db80bf61cfb8da512fa25\">[57511]</a></span>: Ensure <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DedicatedScheduler\" title=\"Dedicated Scheduler\">DedicatedScheduler</a></span> submitter ad is recorded. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span> Without this, the schedd doesn't know the remote negotiator is allowed to negotiate with the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DedicatedScheduler\" title=\"Dedicated Scheduler\">DedicatedScheduler</a></span>.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-25 10:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/85d5512d689d963e1d73fa473f903c6c3b3034d6\">[57487]</a></span>: Ensure we utilize the correct keys for submitter and pool maps. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-25 10:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a2dff799ac6b08cee79a45707b00ff390db31fbe\">[57486]</a></span>: Punch hole for negotiators in the same way as startds. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-23 17:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6b87727a21ff4045e9b15ebb01d203796f6da9db\">[57464]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span>) Minor code-review fix-ups.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Nov-17 15:32", "status": "resolved", "created": "2019-Jun-06 22:09", "fixed_version": "2019-Jun-06 22:09", "broken_version": "", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "bbockelm", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelman@morgridge.org, tlmiller@cs.wisc.edu, peter.couvares@ligo.org", "due_date": ""}