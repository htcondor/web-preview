{"id": 749, "title": "Ticket #749: Schedd creates unnecessary job spool dirs", "description": "<blockquote>\nThis description is copied from Red Hat Bugzilla ( <a class=\"external\" href=\"https://bugzilla.redhat.com/show_bug.cgi?id=523806\">https://bugzilla.redhat.com/show_bug.cgi?id=523806</a> )\n\n<p>In cases that require no file transfer (e.g. in which the spool directory is on\na shared filesystem or the local filesystem), the condor schedd will attempt to\nstat, chown, and delete the spool directory when the job completes or is\nremoved.  This poses a problem in environments using NFS spool directories,\nsince these operations are between one and two orders of magnitude slower on\nNFS (and may also unacceptably load the NFS server).\n\n</p><p>How reproducible:\n\n</p><p>Submit a job with a spool directory on a shared filesystem.\n\n</p><p>Expected results:\n\n</p><p>The schedd should neither create nor delete job spool directories in this case.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Sep-25 11:06:50 by willb:</em> <br/>\n\nThere is a fix on branch 7_4-ticket-749\n\n<p></p><hr/>\n<em>2009-Sep-25 11:47:16 by adesmet:</em> <br/>\n\nThe diff, for reference:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">----------------------- src/condor_schedd.V6/schedd.cpp -----------------------\nindex e8f5afa..b73a6e5 100644\n@@ -2133,13 +2133,22 @@ bool\n jobIsSandboxed( ClassAd * ad )\n {\n \tASSERT(ad);\n \tint stage_in_start = 0;\n+\tMyString should_xfer;\n+\tMyString cleanup_anyway;\n+\n \tad-&gt;LookupInteger( ATTR_STAGE_IN_START, stage_in_start );\n \tif( stage_in_start &gt; 0 ) {\n \t\treturn true;\n \t}\n\n+\tif( ad-&gt;LookupString( ATTR_SHOULD_TRANSFER_FILES, should_xfer ) &amp;&amp;\n+\t    (should_xfer.upper_case(), should_xfer == \"NO\" ) &amp;&amp;\n+\t    !(ad-&gt;LookupString( \"CleanUpSpuriousJobSandboxes\", cleanup_anyway ))) {\n+\t  return false;\n+\t}\n+\n \tint univ = CONDOR_UNIVERSE_VANILLA;\n \tad-&gt;LookupInteger( ATTR_JOB_UNIVERSE, univ );\n \tswitch( univ ) {\n \tcase CONDOR_UNIVERSE_SCHEDULER:\n</pre></div>\n\n\n<p></p><ol>\n<li>What's <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CleanUpSpuriousJobSandboxes\" title=\"Clean Up Spurious Job Sandboxes\">CleanUpSpuriousJobSandboxes</a></span> doing in there?  It doesn't appear anywhere else in the code, doesn't have an ATTR_ macro, and generally seems suspect.\n\n<p></p></li><li>What does ATTR_SHOULD_TRANSFER_FILES have to do with a job having or not having a sandbox? Something as simple as \"condor_submit -s myjob.submit\" will leave you with a job with a sandbox, but ATTR_SHOULD_TRANSFER_FILES as NO.\n</li></ol>\n\n<p></p><hr/>\n<em>2009-Sep-25 14:15:08 by adesmet:</em> <br/>\n\nAs is, the patch will likely cause problems for jobs that spool their input (condor_submit -s, Condor-C, etc).  Also, the upgrade path (qediting) is messy.\n\n<p>Further investigation by willb and I reveals deeper, more suspicious behavior.\n\n</p><p>The directories in question are referred to as the \"sandbox\" in the code.\n\n</p><p>The spooled input code path works as expected:\n\n</p><p></p><ol>\n<li>Spooled jobs create the sandbox inside file_transfer.cpp around line 340 inside FileTransfer::SimpleInit.  The sandbox is owned by PRIV_CONDOR.\n\n<p></p></li><li>The sandbox must be owned by PRIV_USER when the job runs, so it's chowned in aboutToSpawnJobHandler (schedd.cpp:2323).\n\n<p></p></li><li>The sandbox is chowned back to PRIV_CONDOR in jobIsFinished (schedd.cpp:2614).\n\n<p></p></li><li>The sandbox is deleted when the job leaves the queue (location not currently known)\n</li></ol>\n\n<p>However, just before step 2 above, there is a surprise.  In aboutToSpawnJobHandler (schedd.cpp:2257) if the sandbox doesn't exist, <em>it is created</em>.  I have no idea why.  I can think of no cases where a sandbox might not exist before, but must exist when the job starts.  This code dates back to 2006 and was written by wright, so it's likely part of the original sandbox work.\n\n</p><p>So:\n\n</p><p></p><ol>\n<li>Why does aboutToSpawnJobHandler create the sandbox?  Can we remove this code entirely?  (This would eliminate the mkdirs above and hopefully solve Red Hat's problem.)\n\n<p></p></li><li>jobIsSandboxed used to be clever.  But it was buggy, so now it's stupid and assumes that all vanilla jobs (among others) are sandboxed, even if they aren't.  Is it possible to be clever and safe?  The problem appears to be lack of a reliable job ad attribute indicating a sandboxed job.  Getting this right would also solve the problem.\n</li></ol>\n\n<p></p><hr/>\n<em>2009-Oct-15 11:11:42 by willb:</em> <br/>\n\nI've pushed a more comprehensive fix to the V7_4_1-spurious-spool-elimination branch.  This branch introduces a new attribute (\"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NeverCreateJobSandbox\" title=\"Never Create Job Sandbox\">NeverCreateJobSandbox</a></span>\") for jobs that should not be sandboxed.  The new attribute is respected by both the shadow and schedd and is set automatically by condor_submit for jobs that do not require file transfer (only if these jobs are not submitted via \"condor_submit -s\" or via remote submit).\n\n<p>This fix does not introduce any upgrade issues; a condor_submit with the fix will not affect old schedds or shadows, and schedds or shadows that do not include the fix will simply continue to have the old sandboxing behavior when running jobs submitted with a new condor_submit.\n\n</p><p></p><hr/>\n<em>2009-Oct-15 11:15:33 by willb:</em> <br/>\n\nI should note that the fix mentioned in my previous comment is not unduly clever; it simply shortcircuits jobIsSandboxed if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NeverCreateJobSandbox\" title=\"Never Create Job Sandbox\">NeverCreateJobSandbox</a></span> is set in the job ad.  Refactoring this part of the schedd (specifically, verifying that it's OK to fix the behavior Alan mentions above in aboutToSpawnJobHandler) is still worth doing.\n<hr/>\n<em>2010-Aug-23 17:42:37 by adesmet:</em> <br/>\n\nBulk change of target version from v070403 to v070404 using ./ticket_target_mover.\n<hr/>\n<em>2010-Oct-27 16:39:01 by adesmet:</em> <br/>\n\nBulk change of target version from v070404 to v070405 using ./ticket-target-mover.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1088\" onclick=\"get_ticket_and_populate_wrapper('1088'); return false;\" title=\"NeverCreateJobSandbox is wonky in Condor-C\">#1088</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NeverCreateJobSandbox\" title=\"Never Create Job Sandbox\">NeverCreateJobSandbox</a></span> is wonky in Condor-C</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-16 09:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/12e4b8188278bcbabbd8df49c234087b1b8bcb86\">[16086]</a></span>: condor_submit now sets <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NeverCreateJobSandbox\" title=\"Never Create Job Sandbox\">NeverCreateJobSandbox</a></span> attribute when appropriate (i.e. no spool requested, should_transfer_files = NO). Related to ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=749\" onclick=\"get_ticket_and_populate_wrapper('749'); return false;\" title=\"Schedd creates unnecessary job spool dirs\">#749</a></span>.  (By Will Benton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-16 09:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a3994e0ff3d9231dea54e60ea69ffbebfd06a359\">[16085]</a></span>: Shadow now initializes a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> object only if ATTR_NEVER_CREATE_JOB_SANDBOX is set. Related to ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=749\" onclick=\"get_ticket_and_populate_wrapper('749'); return false;\" title=\"Schedd creates unnecessary job spool dirs\">#749</a></span>.  (By Will Benton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-15 17:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e99e49ad8c55bdcded97b142424ec7ce8a5be455\">[16080]</a></span>: Fixed spurious spool dir creation and deletion in the schedd. In the past, we have created and deleted sandboxes for submissions that do not require sandbox directories (typically, those that do not require file transfer). This is a problem in environments using NFS spool directories (or spool directories\u00a0[...]\n (By Will Benton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-15 16:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/98e483712c957215a56921ae27aaea98bf3b79c2\">[16079]</a></span>: Added the declaration of a \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NeverCreateJobSandbox\" title=\"Never Create Job Sandbox\">NeverCreateJobSandbox</a></span>\" attribute for job ads. This attribute, when set in a given job's ad, should cause the schedd and shadow to refrain from creating, modifying, destroying, or inspecting job spool directories for that job. Related to ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=749\" onclick=\"get_ticket_and_populate_wrapper('749'); return false;\" title=\"Schedd creates unnecessary job spool dirs\">#749</a></span>.  (By Will Benton )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Nov-15 09:10", "status": "resolved", "created": "2009-Sep-21 15:04", "fixed_version": "2009-Sep-21 15:04", "broken_version": "v070302", "priority": "3", "subsystem": "Daemons", "assigned_to": "willb", "derived_from": "", "creator": "willb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "willb@redhat.com,matt@cs.wisc.edu,danb@cs.wisc.edu", "due_date": ""}