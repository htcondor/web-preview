{"id": 5787, "title": "Ticket #5787: Create condor-ec2 package to simplify use of HTCondor in the cloud.", "description": "<blockquote>\nFirst pass will be an RPM.\n\n<p>The package will install (and configure HTCondor to use) a master shutdown script that shuts down the whole machine.  It will include example code to show users how to distinguish between voluntary exits and exits during a system shutdown.\n\n</p><p>The package will install (into the preconfigured default location) a script which will (a) advertise the instance's ID, (b) advertise and set TCP_FORWARDING_HOST to the instance's public IP, and (c) if the instance's IAM profile allows reflection and includes a role which which permits the download of a specific file in S3, download it and unpack it in <code>/etc/condor/config.d</code>.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jul-14 16:58:18 by tlmiller:</em> <br/>\n\nThe current config script does not actually unpack the downloaded file yet.\n\n<p></p><hr/>\n<em>2016-Aug-15 10:31:37 by tlmiller:</em> <br/>\n\nThe 'bug-fixed' script now does.\n\n<p></p><hr/>\n<em>2016-Aug-15 11:22:54 by tlmiller:</em> <br/>\n\nI don't really do packaging, so I'd appreciate it if you could review that for me, Tim.  Thanks.\n\n<p></p><hr/>\n<em>2016-Aug-15 13:26:50 by tlmiller:</em> <br/>\n\nMy proposed version history item follows.  I'd rather append \"See manual section X\" for details than \"see the ticket for details,\" so I won't commit it until somebody has a better idea or we actually get that manual section written.\n\n<p></p><div class=\"verbatim\">\n<pre>\\item HTCondor now provides a 'condor-ec2' RPM, intended to assist our\ncustomers in preparing EC2 images for service in an HTCondor pool.  Installing\nthis RPM changes the default configuration of HTCondor in a number of ways.\n\\Ticket{5787}\n</pre></div>\n\n\n<p></p><hr/>\nThe EC2 RPM contains three files: a master shutdown script, a configuration file, and a script that will be executed by the HTCondor configuration system once on start-up.  We will describe these in reverse (that is, chronological) order.\n\n<p>The configuration script is called by a new line in the default HTCondor configuration file (that does nothing if the script isn't installed).  That script (<code>49ec2-instance.sh</code>) generates output which HTCondor writes to <code>49ec-instance.config</code>.  The script extracts the instance's public IP address and instance ID from the EC2 metadata server, and writes them in configuration file format to standard out.  (The configuration file in the RPM, described below, makes use of this information.)  The script then installs a firewall rule which prevents non-root users from accessing the metadata server.  This protects the instance against jobs which might try to use one of the roles associated with the instance.  The script will examine those roles; if one grants permission to read a specific S3 object (as opposed to from an S3 bucket), the script will download that file and (if it's a .tar.gz) untar it into the config.d directory.\n\n</p><p>The configuration file (<code>50ec2.config</code>) sets the TCP_FORWARDING_HOST to the public IP address and has the startd advertise its instance ID.  It also activates execute directory encryption.  Finally, it configures the startd to shut down after being unclaimed for 15 minutes, the master to shut itself down when the startd shuts down, and the master to run a script when it shuts down.\n\n</p><p>The master shutdown script (<code>master_shutdown_script.sh</code>) simply shuts the machine down when the master exits.  It contains code to distinguish between the master shutting down because the instance was unclaimed for fifteen minutes, or because the instance itself is shutting down (usually because of being outbid on Spot), but only for example purposes.\n\n</p><p></p><hr/>\n<em>2016-Sep-15 09:11:16 by tim:</em> <br/>\n\n<strong>Code Review:</strong> This looks good to me. Thank you for the addition.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-02 14:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7fac0bbf82f1ad6ef8ae0ee89ceb100bb7404f19\">[49714]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6034\" onclick=\"get_ticket_and_populate_wrapper('6034'); return false;\" title=\"Work around my_popenv error sensitivity.\">#6034</a></span>) Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5787\" onclick=\"get_ticket_and_populate_wrapper('5787'); return false;\" title=\"Create condor-ec2 package to simplify use of HTCondor in the cloud.\">#5787</a></span>) Bugfixes.\" This reverts commit a3df3e9d0f548691309a9cd253d0607cdc70ec75.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-02 14:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/42d8fcef7cb5ed8f1d4b49c413c5222273b12cb9\">[49715]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6034\" onclick=\"get_ticket_and_populate_wrapper('6034'); return false;\" title=\"Work around my_popenv error sensitivity.\">#6034</a></span>) Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5787\" onclick=\"get_ticket_and_populate_wrapper('5787'); return false;\" title=\"Create condor-ec2 package to simplify use of HTCondor in the cloud.\">#5787</a></span>) Construct the condor-ec2 RPM.\" This reverts commit 64a2713b029c9348f6f886faf4ce0d35e448ccdb.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-02 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7091e20be0275dc6ebdbfe2e116c6f3adeb06f3c\">[49713]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6034\" onclick=\"get_ticket_and_populate_wrapper('6034'); return false;\" title=\"Work around my_popenv error sensitivity.\">#6034</a></span>) Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5787\" onclick=\"get_ticket_and_populate_wrapper('5787'); return false;\" title=\"Create condor-ec2 package to simplify use of HTCondor in the cloud.\">#5787</a></span>) Construct the condor-ec2 RPM.\" This reverts commit 64a2713b029c9348f6f886faf4ce0d35e448ccdb.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-02 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8aeab02680ddd6f5f10cd205d55e787c90c77e0a\">[49712]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6034\" onclick=\"get_ticket_and_populate_wrapper('6034'); return false;\" title=\"Work around my_popenv error sensitivity.\">#6034</a></span>) Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5787\" onclick=\"get_ticket_and_populate_wrapper('5787'); return false;\" title=\"Create condor-ec2 package to simplify use of HTCondor in the cloud.\">#5787</a></span>) Bugfixes.\" This reverts commit a3df3e9d0f548691309a9cd253d0607cdc70ec75.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-21 19:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a3df3e9d0f548691309a9cd253d0607cdc70ec75\">[48832]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5787\" onclick=\"get_ticket_and_populate_wrapper('5787'); return false;\" title=\"Create condor-ec2 package to simplify use of HTCondor in the cloud.\">#5787</a></span>) Bugfixes.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-14 16:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/64a2713b029c9348f6f886faf4ce0d35e448ccdb\">[48790]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5787\" onclick=\"get_ticket_and_populate_wrapper('5787'); return false;\" title=\"Create condor-ec2 package to simplify use of HTCondor in the cloud.\">#5787</a></span>) Construct the condor-ec2 RPM.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Jan-09 10:37", "status": "resolved", "created": "2016-Jul-14 16:54", "fixed_version": "2016-Jul-14 16:54", "broken_version": "", "priority": "4", "subsystem": "Packaging", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}