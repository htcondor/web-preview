{"id": 3897, "title": "Ticket #3897: Remotely queryable history", "description": "<blockquote>\ncondor_history is one of the few commands which can only be performed on the local node - there's no \"remote condor_history\".\n\n<p>Let's fix that!  I propose the schedd should have a new command for querying history (takes a constraint, projection, and max # of matches).  It should Create_Process a helper, pass the helper the socket, and the helper should perform the equivalent of condor_history.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Sep-06 10:02:16 by bbockelm:</em> <br/>\n\nDesign doc posted on Google Docs.\n\n<p></p><hr/>\n<em>2013-Sep-08 18:05:59 by bbockelm:</em> <br/>\n\nThere's been a lot of discussion about authorization for this.  Based on feedback (especially from Igor S), I made this more widely usable.  With the latest push,\n\n<p></p><ul>\n<li>This command only requires READ access.\n</li><li>Concurrency limits on this query (HISTORY_HELPER_MAX_CONCURRENCY, default 2 processes at a time).  Once the concurrency limit is hit, additional queries will be queued (<strong>not</strong> blocking the schedd) and responded to in FIFO order.\n</li><li>A limited number of history ads will be searched (HISTORY_HELPER_MAX_HISTORY, default 10000)\n</li><li>A maximum number of requests can be queued (1000, not adjustable).\n</li><li>Setting either HISTORY_HELPER_MAX_CONCURRENCY or HISTORY_HELPER_MAX_HISTORY to 0 will disable remote history (giving a reasonable error message to the client).\n</li></ul>\n\n<p></p><hr/>\n<em>2013-Sep-09 08:39:21 by bbockelm:</em> <br/>\n\nDesign doc updated to reflect above comment.\n\n<p>Further discussion with GregT - once the current code / design is reviewed / committed, I'll have another follow-up ticket for allowing the remote client to specify the direction.\n\n</p><p></p><hr/>\n<em>2013-Sep-12 13:05:54 by gthain:</em> <br/>\n\nCouple of questions about the design doc:  what kinds of errors are you expecting the server to report back to the client, and how to these errors get translated into the condor_history exit code?\n\n<p></p><hr/>\n<em>2013-Sep-12 13:17:09 by bbockelm:</em> <br/>\n\nHi Greg:\n\n<p>Here are the errors that a user reasonably may see from the server:\n</p><ul>\n<li>2 - Unable to evaluate projection list\n</li><li>3 - Unable to convert projection list to string\n</li><li>4 - Failed to launch history helper process\n</li><li>5 - Error opening history file\n</li><li>10 - Remote history has been disabled on this schedd\n</li></ul>\n\n<p>(filtering out some highly unlikely failure cases)\n\n</p><p>The condor_history exit code is set to the error code.  Of course, other errors can occur client side (unable to connect to server, unable to parse expressions); this results in exit code 1.\n\n</p><p>The client can also detect other errors (malformed ads encountered by server or server and client disagree on the number of ads sent over the wire); this results in exit code 1.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2013-Sep-12 13:21:17 by gthain:</em> <br/>\n\n* DESIGN REVIEW * Approved.\n\n<p></p><hr/>\n<em>2013-Sep-18 17:29:59 by johnkn:</em> <br/>\n\nCODE_REVIEW:\nin condor_history use of -name for remote machine name conflicts with (obsolete?) use of -name for quill database name.  At the very least the useage printout needs to be fixed.\n\n<p></p><hr/>\n<em>2013-Sep-18 17:59:30 by bbockelm:</em> <br/>\n\nHi TJ,\n\n<p>I don't understand your comment.  \"condor_history -help\" does show the correct help text (see below).  What do you see?\n\n</p><p>Quill hasn't been buildable for at least a year, maybe two (at least one, if not two dev series).  I saw the conflict and figured having the same flag name as condor_q trumped the issue of the older flags.\n\n</p><p>Brian\n\n</p><p></p><div class=\"verbatim\">\n<pre>Usage: ./src/condor_tools/condor_history [options]\n\twhere [options] are\n\t\t-help\t\t\tThis screen\n\t\t-file &lt;file&gt;\t\tRead history data from specified file\n\t\t-userlog &lt;file&gt;\tRead job data specified userlog file\n\t\t-backwards\t\tList jobs in reverse chronological order\n\t\t-forwards\t\tList jobs in chronological order\n\t\t-match &lt;number&gt;\t\tLimit the number of jobs displayed\n\t\t-format &lt;fmt&gt; &lt;attr&gt;\tPrint attribute attr using format fmt\n\t\t-autoformat &lt;attr1&gt; [&lt;attr2 ...]\tPrint attr using automating formatting\n\t\t-long\t\t\tVerbose output (entire classads)\n\t\t-wide\t\t\tDon't truncate fields to fit into screen width\n\t\t-constraint &lt;expr&gt;\tAdd constraint on classads\n\t\t-name &lt;schedd-name&gt;\tRemote schedd to read from\n\t\t-pool &lt;collector-name&gt;\tPool remote schedd lives in.  If neither pool nor name\n\t\t\t\t\tis specified, then the local history file is used.\n\t\trestriction list\n\twhere each restriction may be one of\n\t\t&lt;cluster&gt;\t\tGet information about specific cluster\n\t\t&lt;cluster&gt;.&lt;proc&gt;\tGet information about specific job\n\t\t&lt;owner&gt;\t\t\tInformation about jobs owned by &lt;owner&gt;\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Sep-19 13:58:08 by bbockelm:</em> <br/>\n\nI resolved the code question via IRC today.\n\n<p>For documentation topics -\n\n</p><p>Version history:\ncondor_history and the python bindings can now query remote schedds.  This is available to any user with READ authorization; to control the behavior, please adjust HISTORY_HELPER_MAX_CONCURRENCY or HISTORY_HELPER_MAX_CONCURRENCY.\n\n</p><p>Configuration:\n\n</p><p></p><ul>\n<li>HISTORY_HELPER_MAX_CONCURRENCY - This specifies the maximum number of concurrent remote condor_history queries allowed at a time (defaults to 2).  When there are more than HISTORY_HELPER_MAX_CONCURRENCY clients, further queries will be queued in a non-blocking manner. Setting this option to 0 disables remote history access.\n</li><li>HISTORY_HELPER_MAX_HISTORY - This specifies the maximum number of ads to parse on behalf of remote history clients.  The default is 10,000.  This allows the system administrator to indirectly manage the maximum amount of CPU time spent on each client.  Setting this option to 0 disables remote history access.\n</li></ul>\n\n<p>For the condor_history man page - see above comment for the \"condor_history -help\" output.  Basically, we've added \"-pool\" and \"-name\" options which match the condor_q behavior.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-31 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aa580f15e183de53bb6e8e53783fdbb5c3781fcb\">[38056]</a></span>: quick edits of 8.1.2 version history items for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3894\" onclick=\"get_ticket_and_populate_wrapper('3894'); return false;\" title=\"condor_config_val -dump should work remotely\">#3894</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-31 13:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cb3d1c08d9bcc3a0e6fa2e2974aaf52dcaf90e3d\">[38053]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-31 13:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a5ee358a0e9d33faa13edbb4f320f7fd961388e\">[38050]</a></span>: add -name and -pool options to condor_history man page for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-19 10:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7e64f8a4e79cca77d050c113bbfea8ca96cb0796\">[37664]</a></span>: Rename ifdef'd out option name. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span> This way, if we ever get Quill working again, we won't have conflicting option names.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-08 17:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1d26b2b78c8fd54f5ddba67ea9f1750062d9492d\">[37519]</a></span>: Make remote history available under READ authorization. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span> - Add a non-blocking concurrency-limit. - Add a limit to the number of history ads scanned. - If either limit is set to 0, then remote history is disabled.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-06 09:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cb4cc42a5c9516f2d1bb55a555959d20de8fe21b\">[37493]</a></span>: Add remote query options to condor_history CLI. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-05 22:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d48e3285a14dac808f685de4229d8e7d2e8602d9\">[37486]</a></span>: Add initial version of remote condor_history; only python client is currently included. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3897\" onclick=\"get_ticket_and_populate_wrapper('3897'); return false;\" title=\"Remotely queryable history\">#3897</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Oct-31 15:13", "status": "resolved", "created": "2013-Sep-05 22:21", "fixed_version": "2013-Sep-05 22:21", "broken_version": "", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}