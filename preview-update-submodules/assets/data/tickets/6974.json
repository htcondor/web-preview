{"id": 6974, "title": "Ticket #6974: condor_dagman should use submit_utils", "description": "<blockquote>\ncondor_dagman currently submits jobs by forking a condor_submit process. We should update it to use the submit_utils library. This is mostly a performance optimization, but will also help us work around an issue where condor_submit fails intermittently.\n\n<p>There are some things that condor_submit does that will not happen anymore with this change\n\n</p><p></p><ul>\n<li>file checks (currently disabled by default anyway)\n</li><li>remote submission (do we even need this?)\n</li><li>submit -spool\n</li><li>late materialize submission (not hard to add)\n</li><li>query the Credd for OAuth tokens before submit\n</li><li>multiple QUEUE statements (a single complex QUEUE statement will work)\n</li><li>warnings about unused submit file macros\n</li><li>myproxy password. This is normally a condor_submit command line argument so I don't think this will be an issue\n</li><li>some config knobs ignored\n<ul>\n<li>SANDBOX_TRANSFER_METHOD\n</li><li>SEC_CREDENTIAL_PRODUCER\n</li></ul>\n</li></ul>\n\n<p>We will add a config knob <code>DAGMAN_USE_CONDOR_SUBMIT</code> which will default to true.  When this knob is false, dagman will use submit utils intead to read the submit file into memory, and then talk directly to the schedd to submit jobs.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Jun-14 13:27:08 by coatsworth:</em> <br/>\n\n<strong class=\"two\">CODE REVIEW</strong>\n\n<p>Overall looks good. Couple of minor things:\n\n</p><p><em>dag.h:</em>\n</p><ul>\n<li>Line 1244: Why is _dry_run an int and not a bool?\n</li></ul>\n\n<p><em>dagman_submit.cpp:</em>\n</p><ul>\n<li>Normally I would chide you for using gotos, but in this case it makes the logic easier to follow. Although you did spell \"finish\" wrong ;)\n</li><li>Line 554: Is this line needed? If we not we should remove it.\n</li><li>Line 680: What's the point of the Dagman input parameter?\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Jun-19 11:48:09 by johnkn:</em> <br/>\n\n_dry_run is an int to allow for the future possibility of options flags for dry-run, something that condor_submit does now.\n\n<p>finis is latin (or French?) either way not a misspelling, an affectation.\n\n</p><p>line 544 is to help remember that the submit myproxy stuff is a command line argument that we (might) want to support here.\n\n</p><p>The dagman argument at 680 is to allow us to move the param calls out of send_reschedule and into the dagman class in the future.\n\n</p><p></p><hr/>\n<em>2019-Jun-19 12:02:43 by coatsworth:</em> <br/>\n\nTJ and I talked about these in person and I accept all his explanations. No changes needed at this point. Sending back for documentation + version history.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7568\" onclick=\"get_ticket_and_populate_wrapper('7568'); return false;\" title=\"Better messaging for DAGMan direct job submission\">#7568</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nBetter messaging for DAGMan direct job submission</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=7720\" onclick=\"get_ticket_and_populate_wrapper('7720'); return false;\" title=\"Complete condor_dagman direct submission and set to default\">#7720</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nComplete condor_dagman direct submission and set to default</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-19 12:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d2aea747d49b1cadaac3a8fc5fbc5ecb94decb30\">[57173]</a></span>: doc and version history for DAGMAN_USE_CONDOR_SUBMIT. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-11 16:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4f1c1ce0de203b1764ed052c49df36bc3c0d4758\">[57138]</a></span>: re-add change from <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span> that was lost when resolving the merge V8_8-branch to master  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-07 13:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e1d5fd8bd44c248431ee29c25ef738b7e3606b7c\">[57123]</a></span>: condor_dagman can submit jobs directly to the schedd without calling condor_submit. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span> by default, dagman will still use condor_submit to submit jobs. but if you configure DAGMAN_USE_CONDOR_SUBMIT = false it will instead use the submit_utils library code to load the submit file and then send jobs\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-03 11:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/16a9f03cf1303280e53a39aefe252e62b202ba87\">[57059]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6e959b03cc9e8e91af20e4b39a30e252bfd6c20d\">[56753]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6375a357a8281fc993db834b187c33e2db7de191\">[56754]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/43cef108ac5f201499d744d6f24aa57a5b0cd623\">[56755]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8e31c54478821e4ff90f2dd907dda0ce3a02d5c0\">[56759]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/924b82a357815278520e17e86eea79e6ce588f0d\">[56760]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/241200db54f0603d3d9b0dae3413428dacbf32bb\">[56787]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/258ab18e23e7a0f017d24789e040443295180b92\">[56788]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1a8f85db3e3fa3af07c996cd463931be112255b5\">[56794]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e44b2fcc606da15f0fac796ecf6856ee9290c39a\">[56795]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/00a4aa11fc8caf26d6b3d0d7fae97de2df641c72\">[56796]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3f84698d8ce026a62e66eaa07f2930d242794f4d\">[56797]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ad6a5a5a1d718bd9cf8dc8607001d8b2fcb28986\">[56798]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cd6732c6f3064073b3882445ea8189fb0af48c1\">[56799]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e58e284d502482b45069eb4527eb8fad8b69ffa7\">[56800]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3c8708383bb8fd2862bdd73a0f66cdd8603838d6\">[56802]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/80786a2bdace115587bd64d70856ec723a748d34\">[56817]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/71d2d24965acb9d009c4063b1f76346716e8f440\">[56820]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db553e23fd8033c71e18a1fd52969c38efdde60e\">[56821]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4a6c99785774c27230af1ca878370d184198b449\">[56822]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cef369b27bf55dd531269c69c62e91692f6e538\">[56823]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/155d534ea931fdb445b01aebd59d022f03ef9db2\">[56824]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/605396fc06f89e31a1cb88ce505263ea21f1e201\">[56839]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/25c6af810ded0d6d9901e2b8e8f022b30b72bfab\">[56840]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a391385a74af3ab22e0843b4ab5594821005d2fd\">[56841]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6dcfa1f708d51f5d38f9e60f2cc3f12a0e4a5b7e\">[56842]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/249c809b4a3d4b58c8ff5b54da95d848ae3b23b9\">[56847]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/baa99c86c801a31f4306f9264c9724a051c36829\">[56848]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/467396e9c87d722ba714af2ec38d1da73244c769\">[56853]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54888a3d8ed0c82ca8a50caa839ec9655e32ef67\">[56854]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/156d95930e60ef583ea14e2ca6cd755a15604c56\">[56856]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a5cd6d43b22c85313c7808ce5025d53b611549ec\">[56857]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ae3e09dfe0f8603cb27c909d99f82e68ff5c6574\">[56859]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92e489178f06000fe19d4a3075ff28aa64e23f6e\">[56862]</a></span>,\u00a0[...]\n (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jun-03 11:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2128440046d2417b6d8760d1ce5ad8c5a76c18cd\">[57058]</a></span>: Added basic plumbing into condor_dagman to submit jobs via submit_utils (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-03 10:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/78bbcebab5496d037f5658b89b57eb83f595e8b6\">[56495]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ee400f9b2680dddf6aaca9e789a861fdecf72ba7\">[56492]</a></span>, Merge branch 'V8_9-gt6974-dagman-submit-utils' (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-02 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ee400f9b2680dddf6aaca9e789a861fdecf72ba7\">[56492]</a></span>: Moved schedd connection functionality from condor_submit to condor_utils (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-01 15:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b84bf226cf668016de0807301ad387c52b35d2c6\">[56485]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/40196ecfde2f52e8b915f964c21ffffad47ae103\">[56449]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a12bac5584accfd0885f61bf6b280b0468f9d474\">[56460]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/631375f80fe2859aa3ddf59fedd958aa4b826f39\">[56461]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7204aa6f9612eccca6ae6ce07409cfd302ab6c74\">[56464]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b237be7f7270ecbc2f32a1c4314ea3a73c8cd5b5\">[56465]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8ec9b075ac5cb8e9e109e3933df89dd2536340c7\">[56477]</a></span>, Merge branch 'master' of /p/condor/repository/CONDOR_SRC (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-01 15:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89e7747c6bb11e12507effe700de8242cf4110ab\">[56484]</a></span>: Moved schedd connection classes from submit to submit_utils (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6974\" onclick=\"get_ticket_and_populate_wrapper('6974'); return false;\" title=\"condor_dagman should use submit_utils\">#6974</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Jul-01 11:22", "status": "resolved", "created": "2019-Apr-01 14:59", "fixed_version": "2019-Apr-01 14:59", "broken_version": "v080600", "priority": "3", "subsystem": "Dag", "assigned_to": "johnkn", "derived_from": "#6181", "creator": "coatsworth", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}