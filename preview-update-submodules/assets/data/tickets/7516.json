{"id": 7516, "title": "Ticket #7516: S3 file transfer needs accurate error messaging", "description": "<blockquote>\nCurrently, any error with s3 file transfers (credentials not found, invalid credentials, invalid URL, etc) all result in the same generic catch-all hold message:\n\n<p><code>FILETRANSFER: plugin for type s3 not found!</code>\n\n</p><p>It is possible to look up the correct error message in the <code>ShadowLog</code>, but this is very misleading to users, as well as developers. We should fix this so the errors that show up in the <code>StarterLog</code> and hold messages are accurate.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Feb-21 16:03:02 by tlmiller:</em> <br/>\n\nIn particular -- and this doesn't cover all the problem cases -- it's infuriating when the shadow log says\n\n<p></p><div class=\"code\">\n<pre class=\"code\">02/21/20 15:58:47 (903.0) (3805): DoUpload: Will sign s3://aws-chtc-development-2.s3-us-east-2.amazonaws.com/initial-aws-account-instructions for remote transfer.\n02/21/20 15:58:47 (903.0) (3805): DoUpload: Failed to sign URL - AWS SigV4:3:Invalid format for domain-based buckets.  Must be of the form s3://&lt;bucket&gt;.s3.&lt;region&gt;.amazonaws.com/&lt;object&gt;\n...\n02/21/20 15:58:47 (903.0) (3805): DoUpload: sending file s3://aws-chtc-development-2.s3-us-east-2.amazonaws.com/initial-aws-account-instructions\n02/21/20 15:58:47 (903.0) (3805): DoUpload: sending s3://aws-chtc-development-2.s3-us-east-2.amazonaws.com/initial-aws-account-instructions as URL.\n...\n</pre></div>\n\n\n<p>Which is to say that the shadow knew it was an S3 URL, failed to sign it, and then decided to give the S3 plug-in a try.  This seems stupid, and made worse by not checking to see if the putative plug-in is available.\n\n</p><p></p><hr/>\n<em>2020-Feb-21 16:09:43 by tlmiller:</em> <br/>\n\nThere's another problem where uploading to the wrong region will not be reported as a failure but of course doesn't succeed.  I believe this is the upload side of\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7292\" onclick=\"get_ticket_and_populate_wrapper('7292'); return false;\" title=\"curl_plugin shout treat HTTP redirection without Location as failure\">#7292</a></span>, and we can more-or-less just cut-and-paste the solution.\n\n<p></p><hr/>\n<em>2020-Feb-26 15:01:49 by tlmiller:</em> <br/>\n\nBrianB says that there's no good reason -- especially now that the code has been proven to mostly work -- to try and use an admin-defined fallback instead of just failing.  He further points out that it might be wise to send something in the reply <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> indicating failure to make sure that the clean-up is orderly (as opposed to having the shadow put the job on hold and just close the socket on its way out the door).\n\n<p></p><hr/>\n<em>2020-Feb-27 15:41:11 by tlmiller:</em> <br/>\n\nThis patch only addresses the issues that can be detected before trying to download the pre-signed URLs.  (On the other hand, once we get to trying to download the pre-signed URLs, we shouldn't be seeing the plug-in message any more, so maybe there should be a child ticket for properly reporting problems that happen with downloads?)\n\n<p>(I'll let Mark work on those issues, since he knows the curl plugin.)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-27 15:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ea95c7a11e3a52b50fb23404c1cf031a90030e57\">[59061]</a></span>: (<span class=\"ticket\"><a class=\"active\" href=\"/wiki-archive/tickets/?ticket=7516\" onclick=\"get_ticket_and_populate_wrapper('7516'); return false;\" title=\"S3 file transfer needs accurate error messaging\">#7516</a></span>) Properly report problems from generate_presigned_url(). Turn those problems into hold messages, rather than just hoping that there's a back-up S3 plug-in.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Nov-09 12:24", "status": "active", "created": "2020-Feb-21 11:45", "fixed_version": "2020-Feb-21 11:45", "broken_version": "v080905", "priority": "3", "subsystem": "FileTransfer", "assigned_to": "coatsworth", "derived_from": "#7289", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, tlmiller@cs.wisc.edu, bbockelman@morgridge.org", "due_date": ""}