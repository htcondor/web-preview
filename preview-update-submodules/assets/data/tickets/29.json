{"id": 29, "title": "Ticket #29: DAGMan overwrites X509_CERT_DIR and friends", "description": "<blockquote>\nI want to change DAGMan so that it stores a\nsnapshot of its environment on startup.  Then when DAGMan spawns\ncondor_submit, it temporarily restores that environment snapshot for the\nduration of the condor_submit.  Since condor_submit_dag does\n\"getenv=true\", that means that if jobs submitted by DAGMan include\ngetenv=true in their submit files, these jobs will see the same\nenvironment that condor_submit_dag had.\n\n<p>For implementation, taking and restoring the environment \"snapshot\" should be easy by leveraging the fancy-pants Environment class we have in c++_util.</p></blockquote>", "remarks": "<blockquote>\nFixed in the trunk\n\n<p>wenger 2009-02-11: the above changes didn't really fix the X509_CERT_DIR issues -- the config code messes with the value of X509_CERT_DIR before condor_submit_dag even gets ahold of it.  (See also <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=166\" onclick=\"get_ticket_and_populate_wrapper('166'); return false;\" title=\"Create regression test of evironment for DAGMan jobs with getenv=true\">#166</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=208\" onclick=\"get_ticket_and_populate_wrapper('208'); return false;\" title=\"Dagman.out files broken for external subdags\">#208</a></span>.)\n\n</p><p>wenger 2009-02-19: a few more details: X509_CERT_DIR gets overwritten in condor_auth_config() (in condor_c++_util/condor_config.cpp).  Note that this happens <strong>both</strong> in condor_submit_dag and condor_dagman itself.\n\n</p><p>wenger 2009-02-19: okay, discussed this with Nick and Jaime.  Proposed short-term solution is to add methods in the Env class to take a \"snapshot\" of X509_CERT_DIR, etc., before config mucks with them, and then a second method to restore the values before actually passing them along to the job.  This would have to go into condor_submit and condor_submit_dag (and we need to make sure condor_dagman itself is okay, too).  Note: this isn't planned as a long-term solution, just something to get the problem fixed for 7.2.1 or 7.2.2.\n\n</p><p></p><hr/>\n<em>2009-Jun-10 12:11:05 by tannenba:</em> <br/>\n\nAt LIGO meeing 6/5/09 it was mentioned this issue as not a very high priority right now (because of a work-around).  It should get fixed at some point, but isn't as much of a fire as it was.  Adjusting the priority on this ticket.\n<hr/>\n<em>2010-Aug-23 17:42:37 by adesmet:</em> <br/>\n\nBulk change of target version from v070403 to v070404 using ./ticket_target_mover.\n<hr/>\n<em>2010-Oct-27 16:39:01 by adesmet:</em> <br/>\n\nBulk change of target version from v070404 to v070405 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2013-May-28 15:23:58 by tannenba:</em> <br/>\n\nI am resolving this ticket, as the immediate issues were fixed long ago, and the low priority long-term fix has not been missed in 4+ years.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=166\" onclick=\"get_ticket_and_populate_wrapper('166'); return false;\" title=\"Create regression test of evironment for DAGMan jobs with getenv=true\">#166</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCreate regression test of evironment for DAGMan jobs with getenv=true</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Feb-11 16:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/476adb055da9ac4602ed864b9191be3dbdb0e1ae\">[13911]</a></span>: Fixed gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=208\" onclick=\"get_ticket_and_populate_wrapper('208'); return false;\" title=\"Dagman.out files broken for external subdags\">#208</a></span> (dagman.out files broken for external subdags) -- restored checking in condor_submit environment handling that avoids overriding variables set in \"environment=...\" (the changes for gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=29\" onclick=\"get_ticket_and_populate_wrapper('29'); return false;\" title=\"DAGMan overwrites X509_CERT_DIR and friends\">#29</a></span> broke this).  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jan-22 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8830fdc74bea398cd3379a1fd02b5a766fe3c148\">[14180]</a></span>: 1. Added \"Import()\" method in the Env class to import the environment from the process. 2. Used the above to allow condor_submit_dag to get the process environment and pass it to the end jobs. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=29\" onclick=\"get_ticket_and_populate_wrapper('29'); return false;\" title=\"DAGMan overwrites X509_CERT_DIR and friends\">#29</a></span> 3. Updated condor_submit to take advantage of the above Import().  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jan-21 14:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7a6474199f35eed50bcc2598752641f656603c11\">[13535]</a></span>: 1. Added \"Import()\" method in the Env class to import the environment from the process. 2. Used the above to allow condor_submit_dag to get the process environment and pass it to the end jobs. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=29\" onclick=\"get_ticket_and_populate_wrapper('29'); return false;\" title=\"DAGMan overwrites X509_CERT_DIR and friends\">#29</a></span> 3. Updated condor_submit to take advantage of the above Import().  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-May-28 15:24", "status": "defer", "created": "2009-Jan-16 09:12", "fixed_version": "2009-Jan-16 09:12", "broken_version": "v070200", "priority": "5", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "tannenba", "rust": "a18026", "customer_group": "ligo", "visibility": "public", "notify": "tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}