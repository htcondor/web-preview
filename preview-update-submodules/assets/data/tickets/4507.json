{"id": 4507, "title": "Ticket #4507: Improve threading of the HTCondor python module", "description": "<blockquote>\nCMS noticed that the current python bindings don't play well with threading.\n\n<p>That is, when a call to the HTCondor python library is made, we hold on to the GIL (global interpreter lock) that means no other python thread can make progress while the HTCondor call is made.\n\n</p><p>We can improve this:\n</p><ol>\n<li>We can have a module-level lock in the htcondor module.  This would allow other threads to proceed <strong>as long as</strong> they aren't also making HTCondor library calls.  Because libclassads should be threadsafe with caching turned off, we don't need to coordinate across the two modules.\n</li><li>We can invert control for schedd queries by using the non-blocking read interface.  That is, start the query, release the GIL when things would block, call select() the fd and reacquire the lock when there's network data to read.  We would need a object-level lock to prevent two concurrent queries from happening on the same schedd object.</li></ol>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-11 10:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6c3a6f49f8213bf01c07e29ef00bf6e80343daf1\">[41143]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-13 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f281b4de0e83ee4ccc2b60a8655eee594663d21a\">[40964]</a></span>: Release GIL while waiting on schedd response. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-13 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ba2100b218449e445e98948d3a35cceaf3516a81\">[40965]</a></span>: Make locking more fine-grained in the htcondor module. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span> Prior to this commit, any queries into the HTCondor python module would block the entire python process, including all other threads. With this work, we release the GIL around communication with the remote server and acquire a module-level\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-13 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1c44a2e4a0df418c279a593d4086b6cf15c031af\">[40966]</a></span>: Disable classad caching when the HTCondor module loads. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-10 17:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/979fbf73972ca355b0eadb4d0547a904b756af8c\">[40934]</a></span>: Disable classad caching when the HTCondor module loads. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-10 14:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0acc44c687ada49359a532b9e0c38a33490df458\">[40933]</a></span>: Make locking more fine-grained in the htcondor module. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span> Prior to this commit, any queries into the HTCondor python module would block the entire python process, including all other threads. With this work, we release the GIL around communication with the remote server and acquire a module-level\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-01 19:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e9a19d581ed57a001a259ff871c6d6c20e7c37d6\">[40822]</a></span>: Release GIL while waiting on schedd response. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4507\" onclick=\"get_ticket_and_populate_wrapper('4507'); return false;\" title=\"Improve threading of the HTCondor python module\">#4507</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Sep-11 10:41", "status": "resolved", "created": "2014-Aug-01 14:47", "fixed_version": "2014-Aug-01 14:47", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "tim", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, marco.mascheroni@cern.ch", "due_date": ""}