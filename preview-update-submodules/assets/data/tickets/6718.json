{"id": 6718, "title": "Ticket #6718: Fix spooling of late materialization itemdata", "description": "<blockquote>\nJust before releasing 8.7.9, we discovered that the new item data spooling feature (qmgmt command <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SendMaterializeData\" title=\"Send Materialize Data\">SendMaterializeData</a></span>) was leaking memory by creating a new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object but not adding it to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactoriesSubmitPending\" title=\"Job Factories Submit Pending\">JobFactoriesSubmitPending</a></span>. The item data was being stored in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object and written into the spool directory. When the subsequent <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetJobFactory\" title=\"Set Job Factory\">SetJobFactory</a></span> qmgmt command was processed, a second <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object was created (and added to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactoriesSubmitPending\" title=\"Job Factories Submit Pending\">JobFactoriesSubmitPending</a></span>). Lacking an in-memory copy of the item data, it read the data from disk.\n\n<p>The handler for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SendMaterializeData\" title=\"Send Materialize Data\">SendMaterializeData</a></span> should be adding its <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactoriesSubmitPending\" title=\"Job Factories Submit Pending\">JobFactoriesSubmitPending</a></span> and the handler for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetJobFactory\" title=\"Set Job Factory\">SetJobFactory</a></span> should be using that object instead of creating a new one. But the code for reading the item data from the network directly into the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object hadn't been tested and it was too close to the release of 8.7.9, so we fixed the leak by deleting the first <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object after the item data was received.\n\n</p><p>Now, we should replace that quick fix with the real fix and test that it works.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Oct-22 15:13:54 by jfrey:</em> <br/>\n\nThis small memory and performance fix doesn't merit a version history entry.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-24 11:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eb898e5bc78d0e96268b41bff75cc950d17d4dca\">[55208]</a></span>: Fix spooling of late materialization item data. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6718\" onclick=\"get_ticket_and_populate_wrapper('6718'); return false;\" title=\"Fix spooling of late materialization itemdata\">#6718</a></span> Don't create and discard a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object to spool item data over the qmgmt connection. Instead, the item data will be saved in memory as well as written to disk, avoiding the need to re-read the disk copy later.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Oct-22 15:13", "status": "resolved", "created": "2018-Jul-23 16:50", "fixed_version": "2018-Jul-23 16:50", "broken_version": "v080709", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#6680", "creator": "jfrey", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}