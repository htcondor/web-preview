{"id": 5259, "title": "Ticket #5259: Shared port daemon leaks file descriptors.", "description": "<blockquote>\nThe shared port audit log code has a file descriptor leak.  This code is triggered when using an on-disk file (on Linux) to pass a socket from the shared port daemon to the target daemon.  An on-disk file will be used (on Linux) if CONDOR_PRIVATE_SHARED_PORT_COOKIE is not set in the environment of the target daemon.  This will only occur if USE_SHARED_PORT is false for the master, and will only matter if USE_SHARED_PORT is true for the target daemon.\n\n<p>The glideInWMS factories (and possibly front-ends) use this configuration model, probably to avoid dealing with shared-port collector trees.  The relevant config fragment is something like:\n\n</p><p></p><div class=\"verbatim\">\n<pre>USE_SHARED_PORT = FALSE\nDAEMON_LIST = $(DAEMON_LIST) SHARED_PORT\nSCHEDD.USE_SHARED_PORT = TRUE\nSHADOW.USE_SHADED_PORT = TRUE\n</pre></div>\n\n\n<p>There is a work-around: starting the master with CONDOR_PRIVATE_SHARED_PORT_COOKIE set in the environment, as it will propogate down to the target daemon(s).  Note that this should <em>not</em> be set in any world-readable file (including /etc/sysconfig/condor), because it would allow unauthorized processes to use the shared port daemon.  Consider adjusting /etc/init.d/condor and setting that to be mode 0700 instead; or upgrade to 8.4.0 when it's available.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Sep-10 16:06:28 by tlmiller:</em> <br/>\n\nThere should be a child ticket for turning off the auditing code entirely if the shared port audit log is disabled.  (for 8.4.1)\n\n<p></p><hr/>\n<em>2015-Sep-10 16:40:02 by tlmiller:</em> <br/>\n\n<ol>\n<li>Fix FD leak.  [in testing, build ID 340819]\n</li><li>Explain shared port audit log code logic.  [in testing, build ID 340819]\n</li><li>Convert #if to #ifdef for USE_ABSTRACT_DOMAIN_SOCKET.  [in testing, build ID 340819]\n</li><li>Set CONDOR_PRIVATE_SHARED_PORT_COOKIE in the master unconditionally. [in testing, build ID 340841]\n</li></ol>\n\n<p></p><hr/>\n<em>2015-Sep-11 09:52:37 by tlmiller:</em> <br/>\n\nTesting was not all green, but all failures appear to be either known (gsi) or transient (segfaults in the destructors on the way out).  Asking TimT to review.\n\n<p></p><hr/>\n<em>2015-Sep-11 10:35:28 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good\n\n<p></p><hr/>\n<em>2015-Oct-07 11:01:54 by bbockelm:</em> <br/>\n\nNote:  this can also be triggered if the master doesn't recognize your daemon as DC.  For example, CMS was running a secondary schedd on a host like this:\n\n<p></p><div class=\"verbatim\">\n<pre>SECONDSCHEDD = $(SCHEDD)\n... buncha other settings ...\nDAEMON_LIST = $(DAEMON_LIST), SECONDSCHEDD\n</pre></div>\n\n\n<p>and hit this issue.  I think we needed:\n\n</p><p></p><div class=\"verbatim\">\n<pre>DC_DAEMON_LIST =+ SECONDSCHEDD\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-11 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8ebcfaf8af43a5077915fb9a89ba312554fe1585\">[45831]</a></span>: Version History for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5259\" onclick=\"get_ticket_and_populate_wrapper('5259'); return false;\" title=\"Shared port daemon leaks file descriptors.\">#5259</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-10 17:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ffef6e210212732b0460159ba4e529cab7e5b50\">[45829]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5259\" onclick=\"get_ticket_and_populate_wrapper('5259'); return false;\" title=\"Shared port daemon leaks file descriptors.\">#5259</a></span>) Master always initializes the daemon socket dir, because a daemon might be using shared port even if it isn't.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-10 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/580682635841b957737215f5e2dd146363bde9aa\">[45828]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5259\" onclick=\"get_ticket_and_populate_wrapper('5259'); return false;\" title=\"Shared port daemon leaks file descriptors.\">#5259</a></span>) Fix FD leak, explain shared port audit log code, make all USE_ABSTRACT_DOMAIN_SOCKET conditionals #ifdef.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Oct-07 11:01", "status": "resolved", "created": "2015-Sep-10 16:01", "fixed_version": "2015-Sep-10 16:01", "broken_version": "v080307", "priority": "1", "subsystem": "DaemonSharedP", "assigned_to": "tim", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tim@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}