{"id": 6655, "title": "Ticket #6655: Spooling empty input sandbox fails", "description": "<blockquote>\nWhen spooling the input sandbox to the schedd, if there are no files to send, then the transfer fails.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">% cat noxfer.desc\nexecutable=/bin/bash\ntransfer_executable=false\narguments=--version\nqueue\n% condor_submit -spool noxfer.desc\nSubmitting job(s).\n1 job(s) submitted to cluster 310.\n\nDCSchedd::spoolJobFiles:7002:File transfer failed for target job 310.0: SUBMIT at 128.105.121.64 failed to send file(s) to &lt;128.105.121.64:12345&gt;\nERROR: Failed to spool job files.\n%\n</pre></div>\n\n\n<p>This was first first reported on condor-users; see the <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/htcondor-users/2018-April/msg00084.shtml\">post</a> for details.\n\n</p><p>The problem is in FileTransfer::DoDownload(). It switches to user priv just before receiving the first file from the client. If there are no files, then the priv change doesn't occur. At the end of the transfer, it always writes a commit file. But if no files were transferred, then it's in the wrong priv state. This only affects daemons running as root.\n\n</p><p>The priv state change should be hoisted above the per-file for loop.\n\n</p><p>This bug was introduced by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5226\" onclick=\"get_ticket_and_populate_wrapper('5226'); return false;\" title=\"Eliminate chowning of job spool directories\">#5226</a></span> in HTCondor 8.5.0, which changed the ownership of the job spool directory at file transfer time.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-May-02 16:25:57 by coatsworth:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p></p><ul>\n<li>This is a fairly simple fix, and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DoDownload\" title=\"Do Download\">DoDownload</a></span> makes extensive use of return_and_resetpriv() so I'm not worried about leaking privileges. All looks good.\n\n<p></p></li><li>Only minor detail would be an updated comment, so that people know why you put the code block where you did, and they don't move it around later.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-03 11:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bf4e4f29190b662612deef985494eafb210cf07e\">[54828]</a></span>: Update comment above relocated priv switch, per code review. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6655\" onclick=\"get_ticket_and_populate_wrapper('6655'); return false;\" title=\"Spooling empty input sandbox fails\">#6655</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-19 11:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a7deeb2cb31be7347d5fbdf5b400f3c6552a1fe7\">[54757]</a></span>: Docs for 0-file transfer failure bug. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6655\" onclick=\"get_ticket_and_populate_wrapper('6655'); return false;\" title=\"Spooling empty input sandbox fails\">#6655</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-19 11:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/236af1288f97a7c60d64c427560e6d72f1ba8403\">[54756]</a></span>: Always change priv state when receiving files in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6655\" onclick=\"get_ticket_and_populate_wrapper('6655'); return false;\" title=\"Spooling empty input sandbox fails\">#6655</a></span> When a client spooled an input sandbox of zero files to the schedd, the transfer would fail because the schedd was in the wrong priv state when trying to write the commit file.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-May-03 11:14", "status": "resolved", "created": "2018-Apr-19 11:40", "fixed_version": "2018-Apr-19 11:40", "broken_version": "v080600", "priority": "3", "subsystem": "FileTransfer", "assigned_to": "jfrey", "derived_from": "#5226", "creator": "jfrey", "rust": "", "customer_group": "users", "visibility": "public", "notify": "", "due_date": ""}