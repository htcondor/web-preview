{"id": 7438, "title": "Ticket #7438: POOL_HISTORY_MAX_STORAGE ignored on Windows", "description": "<blockquote>\nfrom condor_users, a user reports\n<div class=\"snip\">\n<pre class=\"sniplabel\">snip </pre>\n<pre class=\"snip\">We are running condor 8.8.0 on Windows cluster and noticed that the history files directory grows indefinitely regardless the settings \"POOL_HISTORY_MAX_STORAGE = 50000000\":\n\n Directory of C:\\condor\\history\n\n12/18/2019  05:35 PM        18,616,459 viewhist0.0.new\n11/01/2018  12:21 AM         1,666,782 viewhist0.0.old\n12/18/2019  05:35 PM         3,405,423 viewhist0.1.new\n01/08/2019  09:29 PM         1,666,711 viewhist0.1.old\n12/18/2019  05:03 PM         1,269,576 viewhist0.2.new\n12/18/2019  05:35 PM       898,349,280 viewhist1.0.new\n10/10/2018  10:41 PM         1,667,005 viewhist1.0.old\n12/18/2019  05:35 PM       225,003,773 viewhist1.1.new\n10/12/2018  10:17 AM         1,668,903 viewhist1.1.old\n12/18/2019  05:03 PM        56,321,841 viewhist1.2.new\n10/18/2018  07:37 AM         1,676,836 viewhist1.2.old\n[...]\n              24 File(s)  1,260,128,938 bytes\n\nCollectorLog confirms that all settings are correct:\n12/18/19 11:44:17 Configuration: SAMPLING_INTERVAL=60, MAX_STORAGE=50000000, MaxFileSize=1666666, POOL_HISTORY_DIR=C:\\condor\\history\n\nIf I manually delete \".old\" files then almost immediately those big files are renamed into \".old\". Therefore my guess is that the problem is related to some bug in condor when it rotates history files reached the size limit. Most probably \"rename\" function is used without prior deleting of old file. This is crucial in Windows compare to Linux since rename simply fails if destination file already exists.\n\nAny ideas if anything else could be a reason?\n</pre></div>\n\n\n<p>The problem is indeed that the code assumes that rename(old,new) will delete an existing <strong>new</strong> and the rename <strong>old</strong> over it, but on Windows this rename fails if <strong>new</strong> already exists.  we have a utility function that uses <code>RenameFileEx</code> on windows that we should be using in this code.</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2020-Apr-10 07:51:12 by tim:</em> <br/>\n\nBulk change of target version from v080808 to v080809 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-May-03 07:58:13 by tim:</em> <br/>\n\nDocumentation complete\n\n<p></p><hr/>\n<em>2020-May-04 13:30:00 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Patch looks fine after commit to <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/284afa9052bc0f0b376015e2a28faf145c10eb9d\">[59548]</a></span></p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-01 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/284afa9052bc0f0b376015e2a28faf145c10eb9d\">[59548]</a></span>: fix argument order for previous commit to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7438\" onclick=\"get_ticket_and_populate_wrapper('7438'); return false;\" title=\"POOL_HISTORY_MAX_STORAGE ignored on Windows\">#7438</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-24 16:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3caf1e6f2ea00fdeb66f03be17ad51aa79d9a6b7\">[59481]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7438\" onclick=\"get_ticket_and_populate_wrapper('7438'); return false;\" title=\"POOL_HISTORY_MAX_STORAGE ignored on Windows\">#7438</a></span>, POOL_HISTORY_MAX_STORAGE doesn't work on Windows  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-May-04 13:30", "status": "resolved", "created": "2019-Dec-18 17:17", "fixed_version": "2019-Dec-18 17:17", "broken_version": "v080000", "priority": "3", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "users", "visibility": "public", "notify": "", "due_date": ""}