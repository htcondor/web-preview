{"id": 4197, "title": "Ticket #4197: NUM_CPUS should have a default value in the config system", "description": "<blockquote>\nthe configuration value <code>NUM_CPUS</code>, can be used to override the number of CPUS that the STARTD uses for provisioning the slots, but it has no default value in the config system. This causes a great deal of user confusion, and in fact even developer confusion. For instance <code>VM_MAX_NUMBER</code> is set to <code>$(NUM_CPUS)</code> by default, but by default <code>NUM_CPUS</code> has no value!\n\n<p>The STARTD behaves as if <code>NUM_CPUS</code> was set by default to either <code>DECTECTED_CORES</code> (which includes hyperthreads) or to the actual number of physical cores depending on the configuration value of <code>COUNT_HYPERTHREAD_CPUS</code>.\n\n</p><p>Unfortunately, this cannot be the default value of of <code>NUM_CPUS</code> since we don't know the state of <code>COUNT_HYPERTHREAD_CPUS</code> until after config has already been parsed. So the solution seems to be to have a new detected config variable <code>DETECTED_CPUS</code>.  This is initially set to the number of hyperthreaded cores, then config is parsed.   Then it is set to the number of physical, or hyperthreaded cores depending on the final state of <code>COUNT_HYPERTHREAD_CPUS</code>.\n\n</p><p>The new config variable <code>DETECTED_CPUS</code> cannot be modified by the user (we just set it again after config is done).  As a user convenience, there will also be a new detected config variable <code>DETECTED_PHYSICAL_CPUS</code> which is the count of only physical cpus, and will not include hyperthreads.  <code>NUM_CPUS</code> will be set to <code>$(DETECTED_CPUS)</code> in the param table, but can still be overridden by the startd.\n\n</p><p>the implementation of sysapi_ncpus should be changed to always return the count of actual physical and actual hyperthreaded cores, so that queries of sysapi get back real values.  The STARTD should be changed to param NUM_CPUS when provisioning rather than using sysapi_ncpus.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-27 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6b881de90eaf5a1ca8e29c75124548ba8ea61724\">[39493]</a></span>: clean up and complete documentation for 8.1.4 new pre-defined knobs DETECTED_PHYSICAL_CPUS and DETECTED_CPUS. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4197\" onclick=\"get_ticket_and_populate_wrapper('4197'); return false;\" title=\"NUM_CPUS should have a default value in the config system\">#4197</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-24 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c615ec227c5b9bd4740245d1c5590d9410024fd\">[39459]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4197\" onclick=\"get_ticket_and_populate_wrapper('4197'); return false;\" title=\"NUM_CPUS should have a default value in the config system\">#4197</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4110\" onclick=\"get_ticket_and_populate_wrapper('4110'); return false;\" title=\"condor_q should show MATCH_EXP_JobDescription if present\">#4110</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-04 19:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5404c8d1068142ac11af3ed02f6b363ea391e7b9\">[39316]</a></span>: make default NUM_CPUS available to reference in a config file <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4197\" onclick=\"get_ticket_and_populate_wrapper('4197'); return false;\" title=\"NUM_CPUS should have a default value in the config system\">#4197</a></span> This commit also adds DETECTED_CPUS and DETECTED_PHYSICAL_CPUS to the config system as automatic non-overridable param values; It changes the sysapi into an api for quering the actual number of CPUS. After this change code that wishes\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-27 15:27", "status": "resolved", "created": "2014-Feb-04 13:29", "fixed_version": "2014-Feb-04 13:29", "broken_version": "v080100", "priority": "3", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}