{"id": 2038, "title": "Ticket #2038: Long file paths corrupt memory in file locking code", "description": "<blockquote>\nIf the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileLock\" title=\"File Lock\">FileLock</a></span> class is given a file with path longer than 255 characters, it will corrupt memory, leading to a crash. FileLock::CreateHashName() creates a buffer of size _POSIX_PATH_MAX and passes it to the libc function realpath(). realpath() is expecting a buffer of size PATH_MAX. On our platforms, _POSIX_PATH_MAX is 256 with PATH_MAX is 1024 or 4096.\n\n<p>We saw this crash the schedd on submit.chtc.wisc.edu when jobs were submitted with a user log path of 256 characters.\n\n</p><p>We should review any other code that uses _POSIX_PATH_MAX.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Apr-05 18:31:55 by jfrey:</em> <br/>\n\nPushed commit to V7_6-branch for 7.6.0. FileLock::CreateHashName() now uses PATH_MAX.\n\n<p></p><hr/>\n<em>2011-Apr-27 13:07:52 by danb:</em> <br/>\n\nContrary to the previous \"fixed version\" in this ticket, the patch did not get released in 7.6.0.  It is on V7_6-branch and will therefore be released in 7.6.1.\n\n<p></p><hr/>\n<em>2011-Apr-27 13:12:16 by danb:</em> <br/>\n\nSuggested workaround for this problem:\n\n<p></p><pre>   CREATE_LOCKS_ON_LOCAL_DISK = false\n</pre>\n\n<p>I originally recommended the following alternative workaround, but it DOES NOT WORK!  See <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2116\" onclick=\"get_ticket_and_populate_wrapper('2116'); return false;\" title=\"ENABLE_USERLOG_LOCKING is ignored when writing log events\">#2116</a></span> for why.\n\n</p><p></p><pre>   ENABLE_USERLOG_LOCKING = false\n</pre>\n\n<p></p><hr/>\n<em>2011-Apr-28 09:43:30 by burt:</em> <br/>\n\n<div class=\"verbatim\">\n<pre>ENABLE_USERLOG_LOCKING = false</pre></div>\n may be an insufficient workaround.  When I tried this, did a condor_reconfig, and then did a condor_qedit on an idle job in the queue, the schedd crashed with\n\n<p></p><div class=\"verbatim\">\n<pre>Stack dump for process 23026 at timestamp 1304001582 (30 frames)\ncondor_schedd(dprintf_dump_stack+0x56)[0x66f2f6]\ncondor_schedd(_Z18linux_sig_coredumpi+0x4d)[0x59be2d]\n/lib64/libpthread.so.0[0x38b140e7c0]\n/lib64/libc.so.6(abort+0x28f)[0x38b0c31e8f]\n/lib64/libc.so.6[0x38b0c6a84b]\n/lib64/libc.so.6[0x38b0c722ef]\n/lib64/libc.so.6(cfree+0x4b)[0x38b0c7273b]\ncondor_schedd(_ZN8MyStringD1Ev+0x11)[0x627c51]\ncondor_schedd(_ZN15ExtraParamTable16AddInternalParamEPKc+0x79)[0x6755d9]\ncondor_schedd(param_with_default_abort+0x3a7)[0x643857]\ncondor_schedd(_ZN12WriteUserLog9ConfigureEb+0x78)[0x6b4bd8]\ncondor_schedd(_ZN12WriteUserLog18internalInitializeEiiiPKc+0x32)[0x6b5772]\ncondor_schedd(_ZN12WriteUserLog10initializeEPKciiiS1_+0x89)[0x6b58b9]\ncondor_schedd(_ZN12WriteUserLog10initializeEPKcS1_S1_iiiS1_+0xb6)[0x6b59b6]\ncondor_schedd(_ZN9Scheduler17InitializeUserLogE7PROC_ID+0x1be)[0x52226e]\ncondor_schedd(_ZN9Scheduler24WriteAttrChangeToUserLogEPKcS1_S1_S1_+0x57)[0x5223e7]\ncondor_schedd(_Z12SetAttributeiiPKcS0_h+0xe97)[0x5135e7]\ncondor_schedd(_Z12do_Q_requestP8ReliSockRb+0x10b8)[0x51cb68]\ncondor_schedd(_Z8handle_qP7ServiceiP6Stream+0x53)[0x5109e3]\ncondor_schedd(_ZN10DaemonCore18CallCommandHandlerEiP6Streamb+0x105)[0x580685]\ncondor_schedd(_ZN10DaemonCore9HandleReqEP6StreamS1_+0x13af)[0x58c20f]\ncondor_schedd(_ZN10DaemonCore22HandleReqSocketHandlerEP6Stream+0x50)[0x58e0c0]\ncondor_schedd(_ZN10DaemonCore24CallSocketHandler_workerEibP6Stream+0x498)[0x58e678]\ncondor_schedd(_ZN10DaemonCore35CallSocketHandler_worker_demarshallEPv+0x1a)[0x58eb1a]\ncondor_schedd(_ZN13CondorThreads8pool_addEPFvPvES0_PiPKc+0x38)[0x660d48]\ncondor_schedd(_ZN10DaemonCore17CallSocketHandlerERib+0x149)[0x589919]\ncondor_schedd(_ZN10DaemonCore6DriverEv+0x1bb5)[0x5906e5]\ncondor_schedd(main+0xe47)[0x59e5a7]\n/lib64/libc.so.6(__libc_start_main+0xf4)[0x38b0c1d994]\ncondor_schedd(__gxx_personality_v0+0x411)[0x4fa779]\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Apr-28 10:44:23 by jfrey:</em> <br/>\n\nDue to bad code layout in the event log writing code, it appears ENABLE_USERLOG_LOCKING is almost always ignored and locking is done. Looks like we need another ticket.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2039\" onclick=\"get_ticket_and_populate_wrapper('2039'); return false;\" title=\"Reduce use of _POSIX_PATH_MAX\">#2039</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nReduce use of _POSIX_PATH_MAX</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2116\" onclick=\"get_ticket_and_populate_wrapper('2116'); return false;\" title=\"ENABLE_USERLOG_LOCKING is ignored when writing log events\">#2116</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nENABLE_USERLOG_LOCKING is ignored when writing log events</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-05 18:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1cb3ef77abae9377876f43843ac5bae2817930d4\">[21276]</a></span>: Fix buffer overflow in file locking code. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2038\" onclick=\"get_ticket_and_populate_wrapper('2038'); return false;\" title=\"Long file paths corrupt memory in file locking code\">#2038</a></span> FileLock::CreateHashName() passes a buffer of size POSIX_PATH_MAX to realpath() instead of a buffer of size PATH_MAX (which is larger). A user log path longer than 255 characters will corrupt memory.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Apr-29 17:03", "status": "resolved", "created": "2011-Apr-05 18:14", "fixed_version": "2011-Apr-05 18:14", "broken_version": "v070502", "priority": "2", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "#1310", "creator": "jfrey", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "burt@fnal.gov", "due_date": ""}