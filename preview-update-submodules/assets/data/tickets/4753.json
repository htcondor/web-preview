{"id": 4753, "title": "Ticket #4753: Daemon log rotation broken when using clone()", "description": "<blockquote>\nIn <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3106\" onclick=\"get_ticket_and_populate_wrapper('3106'); return false;\" title=\"Rotation of shared daemon log can result in writing to old file\">#3106</a></span>, we fixed a bug where a race between a daemon and its forked child process to rotate the daemon log can result in the daemon writing to the rotated log file. The solution was to have the child process not perform log rotation. This is indicated via a new flag, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugRotateLog\" title=\"Debug Rotate Log\">DebugRotateLog</a></span>, which is set to false in the child process. This same code is used in Create_Process() when spawning a new child daemon. When clone() is used to create the child, changing the flag in the child also changes it in the parent, and it's never changed back. As a result, the schedd on linux will stop rotating its log after spawning a shadow/starter/gridmanager.\n\n<p>As a workaround, you can set USE_CLONE_TO_CREATE_PROCESSES=False in the config file.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-10 11:04:01 by johnkn:</em> <br/>\n\nCODE_REVIEW: commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1482c9bd5a7d5c3833a56fc6a6672bd67c1daf2c\">[41826]</a></span> looks like a good fix for this bug.  The original problem of having children of the SCHEDD rotate will still need to be addressed for the clone case in a later fix.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4761\" onclick=\"get_ticket_and_populate_wrapper('4761'); return false;\" title=\"Cloned children shouldn't rotate daemon log\">#4761</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCloned children shouldn't rotate daemon log</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-09 11:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ea13284bd21c382cdc86bea70cfdd614f13fa815\">[41860]</a></span>: minor 8.2.6 version history item edit <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4753\" onclick=\"get_ticket_and_populate_wrapper('4753'); return false;\" title=\"Daemon log rotation broken when using clone()\">#4753</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-05 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1482c9bd5a7d5c3833a56fc6a6672bd67c1daf2c\">[41826]</a></span>: Avoid dprintf() file manipulations when in cloned child process. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4753\" onclick=\"get_ticket_and_populate_wrapper('4753'); return false;\" title=\"Daemon log rotation broken when using clone()\">#4753</a></span> Any changes to the files that dprintf() has open or locked while in a cloned child may foul up the parent process.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-05 13:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/079b9c3e77328e49ea58b7e20949447a756fdefb\">[41825]</a></span>: Daemon log rotation disabled in schedd when using clone(). <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4753\" onclick=\"get_ticket_and_populate_wrapper('4753'); return false;\" title=\"Daemon log rotation broken when using clone()\">#4753</a></span> In the dprintf() code, the flag <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugRotateLog\" title=\"Debug Rotate Log\">DebugRotateLog</a></span> controls whether the process should worry about rotating the log. We set this to false in children fork()d from a daemon to avoid a race between parent and child to rotate the log. Unfortunately,\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Dec-10 11:04", "status": "defer", "created": "2014-Dec-05 11:58", "fixed_version": "2014-Dec-05 11:58", "broken_version": "v080204", "priority": "5", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "#3106", "creator": "jfrey", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}