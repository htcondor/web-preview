{"id": 4144, "title": "Ticket #4144: Improve systemd support", "description": "<blockquote>\nThere are a few features in systemd that we can utilize to improve the user experience.  In particular, the following come to mind:\n<ul>\n<li><strong>Socket activation</strong>: systemd can reserve one or more sockets for HTCondor at boot time and pass them to the master (this would solve a very annoying problem if the HTCondor socket overlaps with the ephemeral port range and someone steals the socket on restart).  This would require shared_port to be used, but would even allow us to have systemd control the precise sockets (IPv4 / IPv6 / unix) and network interfaces used by HTCondor.  This is something HTCondor does by itself, but would now be done in a way consistent with the rest of the system.\n</li><li><strong>Watchdog</strong>: systemd has a well-defined heartbeat protocol we can utilize.  This would allow systemd to restart the master if it ever hard-hangs.\n</li><li><strong>Status message</strong>: The condor_master can push an arbitrary string which is included as a part of the output of \"systemctl status condor.service\".  I think it'd be useful to list all of the daemons which are currently down.  If the master calls EXCEPT(), we should record it here.\n</li><li><strong>journald logging</strong>: We can send log messages directly to journald which can do fancy indexing by default (as well as forwarding on to syslog).\n</li></ul>\n\n<p>See <a class=\"external\" href=\"http://cgit.freedesktop.org/systemd/systemd/tree/src/systemd/sd-daemon.h\">http://cgit.freedesktop.org/systemd/systemd/tree/src/systemd/sd-daemon.h</a> for more info.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Dec-31 14:47:04 by bbockelm:</em> <br/>\n\nExample output:\n<div class=\"verbatim\">\n<pre>$ systemctl status condor.service\ncondor.service - Condor Distributed High-Throughput-Computing\n   Loaded: loaded (/etc/systemd/system/condor.service; disabled)\n   Active: active (running) since Tue 2013-12-31 14:44:57 CST; 1min 22s ago\n  Process: 18876 ExecStop=/home/bbockelm/projects/condor-build/release_dir/sbin/condor_off -master (code=exited, status=0/SUCCESS)\n Main PID: 18881 (condor_master)\n   Status: \"Problems: SCHEDD=RESTART in 9s\"\n   CGroup: /system.slice/condor.service\n           \u251c\u250018881 /home/bbockelm/projects/condor-build/release_dir/sbin/condor_master -f\n           \u251c\u250018882 condor_procd -A /var/run/condor/procd_pipe -L /var/log/condor/ProcLog -R 10000000 -S 60 -C 992\n           \u251c\u250018883 condor_shared_port -f\n           \u251c\u250018884 condor_collector -f\n           \u251c\u250018886 condor_negotiator -f\n           \u251c\u250018952 condor_startd -f\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Dec-31 14:48:08 by bbockelm:</em> <br/>\n\nBranch posted: <a class=\"external\" href=\"https://github.com/bbockelm/htcondor/tree/systemd_integration\">https://github.com/bbockelm/htcondor/tree/systemd_integration</a>\n\n<p></p><hr/>\n<em>2014-Jan-02 07:35:08 by bbockelm:</em> <br/>\n\nSocket activation pushed too.  If you add a socket file like this:\n\n<p></p><div class=\"verbatim\">\n<pre>[Unit]\nDescription=HTCondor Socket\n\n[Socket]\nListenStream=9618\nListenStream=/var/lock/condor/daemon_sock/collector\n</pre></div>\n\n\n<p>(and \"Requires=condor.socket\" to condor.service), then a \"condor_status\" will startup HTCondor and block until the collector responds.\n\n</p><p>More importantly, this means that port 9618 is always reserved for the HTCondor service and no one else can steal it.\n\n</p><p></p><hr/>\n<em>2014-Jul-28 08:29:02 by bbockelm:</em> <br/>\n\nOk, branch is updated to include the latest shared port changes.  Further, I switched from linking against libsystem-daemon.so directly to dlopen'ing it at runtime.  This should keep the binaries usable for glideins.\n\n<p>Socket activation, logging to journald, and status integration are all working nicely.\n\n</p><p>I think it's ready for review!\n\n</p><p></p><hr/>\n<em>2015-Jan-05 14:47:53 by bbockelm:</em> <br/>\n\nCopied branch from github to UW git.  Note that not all commit messages got the ticket number in them (I did some before I filed the ticket; rebasing across 1800 commits proved impossible).  :(\n\n<p>To see all commits not in master, you can do:\n</p><div class=\"verbatim\">\n<pre>git log master..V8_3-gt4144\n</pre></div>\n\n\n<p>Alternately, I think I have manually associated all the missing ones with this ticket.\n\n</p><p></p><hr/>\n<em>2016-Apr-05 13:45:56 by tannenba:</em> <br/>\n\nRHEL7 (systemd) deployments are now rapidly increasing, and these patches have been waiting for review for nearly a year.  Tim, could we have an ETA in the due date field?  Or should we create some sub-tickets (milestones) to get some of the simpler/issue-free patches merged into master sooner, and then tackle any more complicated items later?  Thanks.\n\n<p></p><hr/>\n<em>2016-Apr-21 10:37:08 by tim:</em> <br/>\n\nThis work will apply to EL7 and Ubuntu 14. So, I'll have to verify proper functioning on Ubuntu 14. In Debian 8, the libsystemd-daemon library was folded into the main systemd library. So, I'll have to make a derived ticket for Debian 8.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5690\" onclick=\"get_ticket_and_populate_wrapper('5690'); return false;\" title=\"systemd socket activation causes host-based security grief\">#5690</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nsystemd socket activation causes host-based security grief</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-15 11:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/06b64cc0a1bada6160ef54a8bd4b64f0797fcd72\">[49202]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>) Disable socket activation, the security system has fits with it.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-15 11:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/83cc9b114a74ac805db5310c4ff3f60c8af8f8fa\">[49201]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>) Package configuration files for systemd  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-01 08:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5b5089d35008d9491e2818de453dce00f4d5b5be\">[48460]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>) Version history for systemd integration.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-May-24 14:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbfd349762d2ff50795ddadb593cb74b155d8e4d\">[48410]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>) Disable socket activation, the security system has fits with it.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-22 15:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/698eb6f53d855966f8a7621ce9ef35018f84f9a1\">[48277]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>) Package configuration files for systemd  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-22 10:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/35ae2546cb2753b61c353ec03612c421d8c2b98a\">[48276]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>) First cut at getting systemd integration to work  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-28 08:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b6b67282a5b5cec4d580020600355eb022cc787b\">[42103]</a></span>: Touchup the example service/socket file for systemd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-27 20:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05c8494e1a551ddcdab14a988f27653a0edb106e\">[42102]</a></span>: Add journald support to procd.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-27 13:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5e4ba0017b7ebc87d5b84c2b74ab7a5efebda081\">[42101]</a></span>: Switch from linking against systemd library to dlopen'ing and using the appropriate functions. This keeps the resulting binaries more portable.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-27 09:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ea86b78e5c5a0c8222094713f84fb0e99825287f\">[42100]</a></span>: Bugfixes for systemd integration. Notably, do not inherit unix sockets from systemd; we now use anonymous sockets instead.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-01 12:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/98041ff7e350026c07e8cdb7f501106a535bcf6f\">[42098]</a></span>: Allow the client to connect to IPv6 even if it's in IPv4 mode.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-01 12:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5f9214acb8157381365abfc4a24121bde81140aa\">[42097]</a></span>: Fix multiple socket activations when using systemd.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-31 21:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e01de23627c9b42241575f14cf0048bd0249b331\">[42096]</a></span>: Add systemd-style socket activation.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-31 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d6c73a268220c4a9122d84dbabac6f25b709ae95\">[42095]</a></span>: Implement systemd status integration. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4144\" onclick=\"get_ticket_and_populate_wrapper('4144'); return false;\" title=\"Improve systemd support\">#4144</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-31 12:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/25cc445420b91c5c0e8ffc168c796474a24e77a6\">[42094]</a></span>: Make setup of syslog forwarding easier.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-01 08:46", "status": "resolved", "created": "2013-Dec-30 20:03", "fixed_version": "2013-Dec-30 20:03", "broken_version": "", "priority": "2", "subsystem": "DaemonMaster", "assigned_to": "tim", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu epaulson@unit1127.com", "due_date": ""}