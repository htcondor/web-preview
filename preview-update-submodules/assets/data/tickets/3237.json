{"id": 3237, "title": "Ticket #3237: Negotiator writes malformed Accountnew.log", "description": "<blockquote>\nDue to changes in ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3221\" onclick=\"get_ticket_and_populate_wrapper('3221'); return false;\" title=\"negotiator ASSERTs\">#3221</a></span>, the 7.8.4 negotiator writes malformed entries in the Accountantlog.new.  that problem has been corrected (checkins in parent ticket) but this ticket is here to deal with the fallout.\n\n<p>The 7.8.5 negotiator must be able to repair a corrupt log generated by a 7.8.4 negotiator to make upgrading easy for users.  The current proposal is to write C++ code that does the equivalent of:\n  </p><div class=\"code\">\n<pre class=\"code\">sed -i -e 's/&lt; /&lt;/g' -e 's/ , /,/g' -e 's/ &gt;/&gt;/g' Accountantnew.log</pre></div>\n\n\n<p>And have the 7.8.5 negotiator invoke this code when it detects the log is corrupt.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-02 16:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1eae27dba881a866235638751ba696972deb6b43\">[33561]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3221\" onclick=\"get_ticket_and_populate_wrapper('3221'); return false;\" title=\"negotiator ASSERTs\">#3221</a></span> (also <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span>). negotiator would write corrupt resource entries into Accountantnew.log, which will crash 7.9.0 negotiator  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-27 11:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/598d9cabfab5293ce40eb8dc1c5cb6f3c31e8622\">[33527]</a></span>: Fix const correctness bug <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span> Fedora 17 correctly smacked me on the fingers for passing a string constant into a char *  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-27 11:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b1cdc187d0f981694e17db5a4ece5620331b878f\">[33519]</a></span>: include&lt;stdlib.h&gt;, needed for exit() <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span> (That it worked without on RH and Mac is not something we can rely on. And indeed, it broke Debian)  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-27 11:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b0ce43e749f4178c69fdf95d3d762625382bafc\">[33518]</a></span>: Define O_BINARY on unix for accountant log fixer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span> Committer: Alan De Smet  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-27 10:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/01978c587b41b3e622d0744c7bd527eeeb472cc7\">[33517]</a></span>: Define O_BINARY on unix for accountant log fixer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-26 17:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/973cbf2a7d4b84f0b3cbf51caafd792a578ac7ac\">[33510]</a></span>: fix <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span> for windows. open output file in O_BINARY, and close files before trying to rename them.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-26 16:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8a0b5b1769cfaa594764f20e3c7493daf3af0a1d\">[33509]</a></span>: Forgot to write new file in binary; fixes Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-26 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/61150679fa4eb007b150ed323e597a574d7cd8cc\">[33508]</a></span>: accountant_log_fixer fixes corrupt Accountantlog.new files created by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3221\" onclick=\"get_ticket_and_populate_wrapper('3221'); return false;\" title=\"negotiator ASSERTs\">#3221</a></span> (This fix is part of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3237\" onclick=\"get_ticket_and_populate_wrapper('3237'); return false;\" title=\"Negotiator writes malformed Accountnew.log\">#3237</a></span>)  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-18 15:59", "status": "resolved", "created": "2012-Sep-26 16:28", "fixed_version": "2012-Sep-26 16:28", "broken_version": "v070804", "priority": "1", "subsystem": "Daemons", "assigned_to": "zmiller", "derived_from": "#3221", "creator": "zmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20120927"}