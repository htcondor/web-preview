{"id": 6858, "title": "Ticket #6858: Pass credentials through to the file transfer plugin", "description": "<blockquote>\nAfter much discussion at the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SciTokens\" title=\"Sci Tokens\">SciTokens</a></span> retreat, we came up with the following scheme for specifying a particular HTTPS file transfer should be done with a given credential:\n\n<p></p><ol>\n<li>Each credential <code>foo</code> is contained in a file in <code>$_CONDOR_CREDS/foo.use</code>.\n</li><li>If a user wants to specify the HTTPS transfer <a class=\"external\" href=\"https://download.com/bar\">https://download.com/bar</a> needs the <code>foo</code> credential, then they specify the URL <code>foo+https://download.com/bar</code>.\n</li><li>The schedd and starter do matching of the file transfer plugins based on everything <em>right</em> of the <code>+</code>.  That is, it forces <code>foo+https://</code> URLs to match with a plugin advertising <code>https</code> support.\n</li><li>The corresponding HTTPS plugin is responsible for locating and using the correct credentials in the <code>$_CONDOR_CREDS</code> directory.\n</li><li>We work with the facilitators to determine whether users would prefer to write <code>transfer_input_files = foo+https://download.com/bar</code> or have a simpler alias of <code>foo_input_files = <a class=\"external\" href=\"https://download.com/bar\">https://download.com/bar</a> ,</code>.  If necessary, the latter would be transformed into the former by the submit library.</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-06 11:00:24 by bbockelm:</em> <br/>\n\nMigrated over to rapidjson since that's already inside the HTCondor sources.\n\n<p>Unfortunately, gittrac doesn't seem to allow history rewrites.  Here's the updated branch:\n\n</p><p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/compare/master...bbockelm:V8_9-gt6858?expand=1\">https://github.com/htcondor/htcondor/compare/master...bbockelm:V8_9-gt6858?expand=1</a>\n\n</p><p></p><hr/>\n<em>2019-Mar-08 09:37:51 by bbockelm:</em> <br/>\n\nThis approach was temporarily on hold until we decided if we wanted to take a more ambitious approach (turning the transfer input / output commands into a list of classads -- that would have provided a more natural place to add this metadata).\n\n<p>We have since decided to not take that approach.  Chatting with ToddT yesterday, we still think this is the best way to go.\n\n</p><p>Accordingly, I have rebased the branch and retested.  The following work:\n\n</p><p></p><ol>\n<li>Normal HTTPS transfers (no credentials present) via the multifile curl plugin.\n</li><li>Adding a scitoken to the environment and doing the same URL prefixed with <code>scitoken+</code>.\n</li></ol>\n\n<p>I have manually inspected the headers received by the server and confirmed that the Authorization header is properly set to the contents of my token in the second case.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-09 13:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7661597f495b3717ba924586c691684d2320c83b\">[56540]</a></span>: Added full documentation under Submitting a Job page (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-27 15:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/86a02baea79b7af458b7874ce7000d395a54aa12\">[56452]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-08 13:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a3a6cc2b248043cc2becd8f96ccf51cb078bd9d0\">[56322]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span>) Fix windows build breakage  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-08 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3810c709437648db0432c4cd9c2b2d43dc37da5d\">[56319]</a></span>: Have multifile_curl_plugin utilize provided token. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> If a credential name is passed as part of the URL given to the multifile_curl_plugin, then try to parse it as an OAuth token response. Extract the access_token value from the JSON object and add it to the Authorization header used with HTTP\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-08 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ea3f78c067ce4c25bf07979d95c00025dc335f60\">[56320]</a></span>: Set $_CONDOR_CREDS for file transfer plugins. gt <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This allows the file transfer plugins to locate the appropriate credential directory for the job.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-08 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/07b708588eaea517d85193db7b011b646e247443\">[56317]</a></span>: Only match against the \"suffix\" of the URL scheme. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This causes the URL matching for the file transfer plugins to only look at the \"suffix\" of the URL scheme (everything after the last `+` character). So a URL of the form `foo+https://` would match against a plugin advertising support for `https`.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-08 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2b870c1d2ceda322c68fc89cdf5ba43c09080fc2\">[56318]</a></span>: Add support for the new scheme-suffix approach in curl plugins. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This is the file-transfer-plugin-side of only using the scheme suffix for performing transfers.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-17 09:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4930ccf4b4c72f862733e1c525570468621bc4b4\">[56010]</a></span>: Ensure the error messages always are recorded in the hold message. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-17 09:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fef10703dd3882d18c32212f14a00ec23f0e2ed7\">[56009]</a></span>: Bugfix: Parse the token appropriately as JSON. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-17 09:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a4e2ae040d695de777750b228c06114362f07e45\">[56008]</a></span>: Set $_CONDOR_CREDS for file transfer plugins. gt <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This allows the file transfer plugins to locate the appropriate credential directory for the job.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-16 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f614355289066e6fdfa532ff73033dea3fe970f5\">[55999]</a></span>: Have multifile_curl_plugin utilize provided token. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> If a credential name is passed as part of the URL given to the multifile_curl_plugin, then try to parse it as an OAuth token response. Extract the access_token value from the JSON object and add it to the Authorization header used with HTTP\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-16 09:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/06c8e3036bbd33f556dd9b34b66e9353df4f8f8a\">[55998]</a></span>: Add picojson header-only JSON parser to condor_utils. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This adds the header-only picojson library (BSD license; upstream is <a class=\"external\" href=\"https://github.com/kazuho/picojson\">https://github.com/kazuho/picojson</a> and is compatible with the HTCondor license) to condor_utils.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-16 09:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b281e5e1c3b3c70e9f22dc5e988b5c6d642424f7\">[55997]</a></span>: Add support for the new scheme-suffix approach in curl plugins. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This is the file-transfer-plugin-side of only using the scheme suffix for performing transfers.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-16 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e127537be578f20b91078dd62550b6a29accc3c7\">[55996]</a></span>: Only match against the \"suffix\" of the URL scheme. GT <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6858\" onclick=\"get_ticket_and_populate_wrapper('6858'); return false;\" title=\"Pass credentials through to the file transfer plugin\">#6858</a></span> This causes the URL matching for the file transfer plugins to only look at the \"suffix\" of the URL scheme (everything after the last `+` character). So a URL of the form `foo+https://` would match against a plugin advertising support for `https`.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Apr-08 10:57", "status": "resolved", "created": "2019-Jan-16 09:32", "fixed_version": "2019-Jan-16 09:32", "broken_version": "", "priority": "2", "subsystem": "", "assigned_to": "coatsworth", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelman@morgridge.org; tannenba@cs.wisc.edu", "due_date": ""}