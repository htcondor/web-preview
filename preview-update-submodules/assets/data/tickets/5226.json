{"id": 5226, "title": "Ticket #5226: Eliminate chowning of job spool directories", "description": "<blockquote>\nJob directories under the SPOOL directory are created owned by the condor user acount. They are chowned to the job owner's account just before the job runs and chowned back to the condor account when the job enters the Completed or Removed status. This behavior was added in the 6.7.x series to allow for temporary user accounts on the submit machine, similar to the slot user accounts on execute machines. A job owner wouldn't need an OS account on the submit machine. The schedd could assign a temporary account to them when it was time for the job to run. After the job completed, the account could released for use by another job owner. During the time the job owner didn't have an OS account, the job files would be owned by the condor user. This dynamic, late binding of job owners to OS accounts was never implemented, but the chowning of job files remained in place.\n\n<p>If a job has hundreds of files or more, chowning them can become an expensive operation that blocks the schedd. Chowning makes it harder to place the SPOOL directory on a shared filesystem, since it requires root privileges. Eliminating chowning would allow the schedd to process completed jobs more quickly (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5168\" onclick=\"get_ticket_and_populate_wrapper('5168'); return false;\" title=\"Increase rate of schedd job completion\">#5168</a></span>).\n\n</p><p>We should eliminate this chowning, and have job files under SPOOL be owned by the job owner for their entire lifetime.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Sep-11 10:58:47 by jfrey:</em> <br/>\n\nSome more work needs to be done for the SOAP interface, particularly in the presence of more restrictive spool permissions (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4896\" onclick=\"get_ticket_and_populate_wrapper('4896'); return false;\" title=\"Make spool permissions more restrictive\">#4896</a></span>). The SOAP interface does all file accesses as user condor. When writing input files, the schedd may not know the job owner yet, so it can't create the spool directory as the user. As a work-around, the SOAP code still writes the input files as condor, and the job spool directory is chowned to the job owner when the transaction is committed. If the authenticated client identity is not a queue superuser, then the schedd does know the job owner and could create the files as that user. This potential optimization is not currently done.\n\n<p>To read output files, the SOAP code needs to be modified to change its priv-state to the job owner. In the normal case, it could look up the owner in the job ad. Things get more complicated if we want to support submitting a job with input files and then reading those files within a single transaction, or gracefully support CHOWN_JOB_SPOOL_FILES changing while jobs are in the queue.\n\n</p><p></p><hr/>\n<em>2015-Sep-17 14:53:33 by jfrey:</em> <br/>\n\nThis change doesn't affect the ickpt file that's created when copy_to_spool=True is set in the submit file. That file remains owned by the condor user for its entire lifetime, as before.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5770\" onclick=\"get_ticket_and_populate_wrapper('5770'); return false;\" title=\"Audit log reads job proxy as wrong user\">#5770</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAudit log reads job proxy as wrong user</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6655\" onclick=\"get_ticket_and_populate_wrapper('6655'); return false;\" title=\"Spooling empty input sandbox fails\">#6655</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSpooling empty input sandbox fails</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-06 09:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6a290029c6b2f5a0a8ff03b14581ed307c7d47a\">[45942]</a></span>: Document new config knob CHOWN_JOB_SPOOL_FILES. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5226\" onclick=\"get_ticket_and_populate_wrapper('5226'); return false;\" title=\"Eliminate chowning of job spool directories\">#5226</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-05 17:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a6f7cc7acc294a9ebc4dd8062fda2d2ffe4aca68\">[45932]</a></span>: Version history for eliminating chowning of job spool directories. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5226\" onclick=\"get_ticket_and_populate_wrapper('5226'); return false;\" title=\"Eliminate chowning of job spool directories\">#5226</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-17 13:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/219b8dc0b8f9c858c1f93226db150d87939464a7\">[45857]</a></span>: Make SOAP file access work with user-owned spooled job files. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5226\" onclick=\"get_ticket_and_populate_wrapper('5226'); return false;\" title=\"Eliminate chowning of job spool directories\">#5226</a></span> When not chowning spool files, switch to user prive state to read job files.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-04 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/704388287afa4f2385fe11f33134147bf61bed6d\">[45796]</a></span>: Move user ids init for file transfer in the schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5226\" onclick=\"get_ticket_and_populate_wrapper('5226'); return false;\" title=\"Eliminate chowning of job spool directories\">#5226</a></span> FileTransfer::SimpleInit() accesses the job's spool directory, so the user priv uids need to be initialized before it's called.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-21 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ae842403e00e7f43c15bb6c38facee4f439c9638\">[45645]</a></span>: Reduce chowning of job spool directories. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5226\" onclick=\"get_ticket_and_populate_wrapper('5226'); return false;\" title=\"Eliminate chowning of job spool directories\">#5226</a></span> Add a new (default) option to have job files in the SPOOL directory spend most/all of their time owned by the job owner. This eliminates the chowning of files that currently happens before the job starts running and after it completes. When the new config\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Oct-06 09:24", "status": "resolved", "created": "2015-Aug-20 15:24", "fixed_version": "2015-Aug-20 15:24", "broken_version": "v080200", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}