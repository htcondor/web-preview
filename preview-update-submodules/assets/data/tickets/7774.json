{"id": 7774, "title": "Ticket #7774: Confusing error message during authentication", "description": "<blockquote>\nWhile trying to figure out a security issue today, I got this message in my log:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">07/31/20 15:00:56 Can't connect to queue manager: SECMAN:2010:Received \"DENIED\" from server for user karpel@submittest0000.chtc.wisc.edu using method IDTOKENS.|AUTHENTICATE:1004:Failed to authenticate using PASSWORD|AUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n\n\n<p>BrianB noted that it looks like the auth error stack wasn't being cleared between the authentication and authorization steps, so the error message contains authentication failures even though we did manage to eventually authenticate, but then failed to authorize. This is, at best, confusing: the error message should be clearer about what the last error that occurred is.\n\n</p><p>I marked this ticket for the dev series, but I suppose this may be stable-worthy. I leave it up to ZKM's judgement...\n\n</p><p>Full log:\n</p><div class=\"code\">\n<pre class=\"code\">07/31/20 15:00:55 SECMAN: no cached key for {&lt;128.104.100.69:9618?addrs=128.104.100.69-9618+[2607-f388-107c-501-dcad-beff-feef-cafe]-9618&amp;alias=submittest0000.chtc.wisc.edu&amp;noUDP&amp;sock=schedd_3303664_4ba5&gt;,&lt;1112&gt;}.\n07/31/20 15:00:55 SECMAN: Security Policy:\nAuthMethods = \"FS,PASSWORD,TOKEN\"\nAuthentication = \"REQUIRED\"\nCryptoMethods = \"BLOWFISH,3DES\"\nEnact = \"NO\"\nEncryption = \"OPTIONAL\"\nIntegrity = \"OPTIONAL\"\nIssuerKeys = \"POOL\"\nNewSession = \"YES\"\nOutgoingNegotiation = \"REQUIRED\"\nServerPid = 30049\nSessionDuration = \"60\"\nSessionLease = 3600\nSubsystem = \"TOOL\"\nTrustDomain = \"127.0.0.1:0\"\n07/31/20 15:00:55 SECMAN: negotiating security for command 1112.\n07/31/20 15:00:55 SECMAN: sending DC_AUTHENTICATE command\n07/31/20 15:00:55 SECMAN: sending following classad:\nAuthMethods = \"FS,PASSWORD,TOKEN\"\nAuthentication = \"REQUIRED\"\nCommand = 1112\nConnectSinful = \"&lt;128.104.100.69:9618?addrs=128.104.100.69-9618+[2607-f388-107c-501-dcad-beff-feef-cafe]-9618&amp;alias=submittest0000.chtc.wisc.edu&amp;noUDP&amp;sock=schedd_3303664_4ba5&gt;\"\nCryptoMethods = \"BLOWFISH,3DES\"\nEnact = \"NO\"\nEncryption = \"OPTIONAL\"\nIntegrity = \"OPTIONAL\"\nIssuerKeys = \"POOL\"\nNewSession = \"YES\"\nOutgoingNegotiation = \"REQUIRED\"\nRemoteVersion = \"$CondorVersion: 8.9.7 May 20 2020 BuildID: UW_Python_Wheel_Build $\"\nServerPid = 30049\nSessionDuration = \"60\"\nSessionLease = 3600\nSubsystem = \"TOOL\"\nTrustDomain = \"127.0.0.1:0\"\n07/31/20 15:00:55 SECMAN: server responded with:\nAuthMethods = \"FS\"\nAuthMethodsList = \"FS,PASSWORD,TOKEN\"\nAuthentication = \"YES\"\nCryptoMethods = \"BLOWFISH,3DES\"\nEnact = \"YES\"\nEncryption = \"YES\"\nIntegrity = \"YES\"\nIssuerKeys = \"POOL,key1\"\nRemoteVersion = \"$CondorVersion: 8.9.8 Jun 29 2020 BuildID: 508520 PackageID: 8.9.8-0.508520 $\"\nServerTime = 1596225655\nSessionDuration = \"60\"\nSessionLease = 3600\nTrustDomain = \"cm.chtc.wisc.edu\"\n07/31/20 15:00:55 SECMAN: new session, doing initial authentication.\n07/31/20 15:00:55 SECMAN: authenticating RIGHT NOW.\n07/31/20 15:00:55 SECMAN: AuthMethodsList: FS,PASSWORD,TOKEN\n07/31/20 15:00:55 SECMAN: Auth methods: FS,PASSWORD,TOKEN\n07/31/20 15:00:55 AUTHENTICATE: setting timeout for &lt;128.104.100.69:9618?addrs=128.104.100.69-9618+[2607-f388-107c-501-dcad-beff-feef-cafe]-9618&amp;alias=submittest0000.chtc.wisc.edu&amp;noUDP&amp;sock=schedd_3303664_4ba5&gt; to 20.\n07/31/20 15:00:55 AUTHENTICATE: in authenticate( addr == '&lt;128.104.100.69:9618?addrs=128.104.100.69-9618+[2607-f388-107c-501-dcad-beff-feef-cafe]-9618&amp;alias=submittest0000.chtc.wisc.edu&amp;noUDP&amp;sock=schedd_3303664_4ba5&gt;', methods == 'FS,PASSWORD,TOKEN')\n07/31/20 15:00:55 AUTHENTICATE: can still try these methods: FS,PASSWORD,TOKEN\n07/31/20 15:00:55 HANDSHAKE: in handshake(my_methods = 'FS,PASSWORD,TOKEN')\n07/31/20 15:00:55 HANDSHAKE: handshake() - i am the client\n07/31/20 15:00:55 HANDSHAKE: sending (methods == 2564) to server\n07/31/20 15:00:55 HANDSHAKE: server replied (method = 4)\n07/31/20 15:00:55 AUTHENTICATE: will try to use 4 (FS)\n07/31/20 15:00:55 AUTHENTICATE: do_authenticate is 1.\n07/31/20 15:00:55 AUTHENTICATE_FS: used dir /tmp/FS_XXXH443AB, status: 0\n07/31/20 15:00:55 AUTHENTICATE: method 4 (FS) failed.\n07/31/20 15:00:55 AUTHENTICATE: can still try these methods: PASSWORD,TOKEN\n07/31/20 15:00:55 HANDSHAKE: in handshake(my_methods = 'PASSWORD,TOKEN')\n07/31/20 15:00:55 HANDSHAKE: handshake() - i am the client\n07/31/20 15:00:55 HANDSHAKE: sending (methods == 2560) to server\n07/31/20 15:00:55 HANDSHAKE: server replied (method = 512)\n07/31/20 15:00:55 AUTHENTICATE: will try to use 512 (PASSWORD)\n07/31/20 15:00:55 AUTHENTICATE: do_authenticate is 1.\n07/31/20 15:00:55 PW.\n07/31/20 15:00:55 PW: getting name.\n07/31/20 15:00:55 PW: Generating ra.\n07/31/20 15:00:55 PW: Client sending.\n07/31/20 15:00:55 Client sending: 0, 20(condor_pool@jtk-work), 256\n07/31/20 15:00:55 PW: Client receiving.\n07/31/20 15:00:55 Wrote server ra.\n07/31/20 15:00:55 PW: Client using pool password.\n07/31/20 15:00:55 PW: Client setting keys.\n07/31/20 15:00:55 PW: Client checking T.\n07/31/20 15:00:55 Calculating hkt 'condor_pool@jtk-work' (20), 'condor_pool@chtc.wisc.edu' (25).\n07/31/20 15:00:55 Hash supplied by server doesn't match that calculated by the client.\n07/31/20 15:00:55 PW: CLient sending two.\n07/31/20 15:00:55 In client_send_two.\n07/31/20 15:00:55 Client sending: 0() 0 0\n07/31/20 15:00:55 Sent ok.\n07/31/20 15:00:55 AUTHENTICATE: method 512 (PASSWORD) failed.\n07/31/20 15:00:55 AUTHENTICATE: can still try these methods: TOKEN\n07/31/20 15:00:55 HANDSHAKE: in handshake(my_methods = 'TOKEN')\n07/31/20 15:00:55 HANDSHAKE: handshake() - i am the client\n07/31/20 15:00:55 HANDSHAKE: sending (methods == 2048) to server\n07/31/20 15:00:55 HANDSHAKE: server replied (method = 2048)\n07/31/20 15:00:55 Will use issuer cm.chtc.wisc.edu for remote server.\n07/31/20 15:00:55 AUTHENTICATE: will try to use 2048 (IDTOKENS)\n07/31/20 15:00:55 AUTHENTICATE: do_authenticate is 1.\n07/31/20 15:00:55 PW.\n07/31/20 15:00:55 PW: getting name.\n07/31/20 15:00:55 Looking for tokens in directory /home/jtk/.condor/personal/tokens.d for issuer cm.chtc.wisc.edu\n07/31/20 15:00:55 TOKEN: Will use tokens found in /home/jtk/.condor/personal/tokens.d/remote-submit-test.\n07/31/20 15:00:55 JWT object was signed with server key POOL (out of 2 possible keys)\n07/31/20 15:00:55 PW: Generating ra.\n07/31/20 15:00:55 PW: Client sending.\n07/31/20 15:00:55 Client sending: 0, 35(karpel@submittest0000.chtc.wisc.edu), 256\n07/31/20 15:00:55 PW: Client receiving.\n07/31/20 15:00:55 Wrote server ra.\n07/31/20 15:00:55 PW: Client using pre-derived key of length 32.\n07/31/20 15:00:55 PW: Client checking T.\n07/31/20 15:00:55 Calculating hkt 'karpel@submittest0000.chtc.wisc.edu' (35), 'condor_pool@chtc.wisc.edu' (25).\n07/31/20 15:00:55 PW: CLient sending two.\n07/31/20 15:00:55 In client_send_two.\n07/31/20 15:00:55 In calculate_hk.\n07/31/20 15:00:55 Client calculated hk.\n07/31/20 15:00:55 Client sending: 35(karpel@submittest0000.chtc.wisc.edu) 256 20\n07/31/20 15:00:55 Sent ok.\n07/31/20 15:00:55 Setting session key.\n07/31/20 15:00:55 Key length: 32\n07/31/20 15:00:55 PW: CLient set session key.\n07/31/20 15:00:55 AUTHENTICATE: auth_status == 2048 (IDTOKENS)\n07/31/20 15:00:55 Authentication was a Success.\n07/31/20 15:00:55 ZKM: setting default map to condor_pool@chtc.wisc.edu\n07/31/20 15:00:55 ZKM: post-map: current user is 'condor_pool'\n07/31/20 15:00:55 ZKM: post-map: current domain is 'chtc.wisc.edu'\n07/31/20 15:00:55 ZKM: post-map: current FQU is 'condor_pool@chtc.wisc.edu'\n07/31/20 15:00:55 AUTHENTICATE: Exchanging keys with remote side.\n07/31/20 15:00:56 In Condor_Auth_Passwd::unwrap.\n07/31/20 15:00:56 AUTHENTICATE: Result of end of authenticate is 1.\n07/31/20 15:00:56 SECMAN: about to enable message authenticator.\n07/31/20 15:00:56 SECMAN: successfully enabled message authenticator!\n07/31/20 15:00:56 SECMAN: about to enable encryption.\n07/31/20 15:00:56 SECMAN: successfully enabled encryption!\n07/31/20 15:00:56 SECMAN: received post-auth classad:\nReturnCode = \"DENIED\"\nServerTime = 1596225656\nSid = \"submittest0000:1177844:1596225655:24825\"\nTriedAuthentication = true\nUser = \"karpel@submittest0000.chtc.wisc.edu\"\nValidCommands = \"60004,60012,60021,60052,421,478,480,486,488,489,487,499,502,464,1112,481,509,511,521,74000,507,60007,457,60020,443,441,6,12,5,515,516,519,1111,471\"\n07/31/20 15:00:56 SECMAN: FAILED: Received \"DENIED\" from server for user karpel@submittest0000.chtc.wisc.edu using method IDTOKENS.\n07/31/20 15:00:56 Can't connect to queue manager: SECMAN:2010:Received \"DENIED\" from server for user karpel@submittest0000.chtc.wisc.edu using method IDTOKENS.|AUTHENTICATE:1004:Failed to authenticate using PASSWORD|AUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Jul-31 15:36:08 by zmiller:</em> <br/>\n\nI agree that the errstack is not being cleared after a successful authentication and that it should be.  IMHO This seems easy to fix and could make it into stable.\n\n<p></p><hr/>\n<em>2020-Aug-05 08:33:36 by bbockelm:</em> <br/>\n\nProposed implementation:\n\n<p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/125\">https://github.com/htcondor/htcondor/pull/125</a>\n\n</p><p></p><hr/>\n<em>2020-Aug-06 22:19:58 by bbockelm:</em> <br/>\n\nCode reviewed by Jaime and merged.\n\n<p>Josh, enjoy your improved error message!  While it's relatively simple, I'd prefer to not backport unless we get a request to do so.\n\n</p><p>Given it's a tweak to an error message I prefer no version history.  Marking as resolved.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-07 07:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/48af11a2ac0911b56b0dd7a5cdf8db116496ebb6\">[60409]</a></span>: Clear errstack after successful auth'n. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7774\" onclick=\"get_ticket_and_populate_wrapper('7774'); return false;\" title=\"Confusing error message during authentication\">#7774</a></span> After we have successfully authenticated, we should clear out the error state object. Otherwise, any prior authentication failure is included in the error stack resulting in a confusing error message for authorization failures.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-05 08:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/af894fccec8b39e76222be4eeb09fee536eddc96\">[60402]</a></span>: Clear errstack after successful auth'n. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7774\" onclick=\"get_ticket_and_populate_wrapper('7774'); return false;\" title=\"Confusing error message during authentication\">#7774</a></span> After we have successfully authenticated, we should clear out the error state object. Otherwise, any prior authentication failure is included in the error stack resulting in a confusing error message for authorization failures.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Aug-06 22:20", "status": "resolved", "created": "2020-Jul-31 15:29", "fixed_version": "2020-Jul-31 15:29", "broken_version": "", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "karpel", "rust": "", "customer_group": "other", "visibility": "public", "notify": "karpel@wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}