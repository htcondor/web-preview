{"id": 3506, "title": "Ticket #3506: Master should restart all daemons when network address changes", "description": "<blockquote>\nIf a machine's IP address changes, all Condor daemons on that machine can no longer be contacted, even from tools or daemons on that same machine. This situation is very likely to occur on laptops, which frequently move between different wired and wireless networks. BOSCO is making Condor installations on laptops more common, so addressing this problem is becoming more important.\n\n<p>The condor_master should periodically examine the IP addresses of the local machine and restart all of the daemons (including itself) if it detects a change. The master already does this for substantial jumps in the system clock.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Mar-13 14:12:02 by tlmiller:</em> <br/>\n\nBaTLab is also having chronic problems with distributions lying (or being mistaken) about their network being ready during startup.  This causes the master to start up on 127.0.0.1, and, among other problems, reject DC_CHILDALIVE because the daemon in question is using the execute node's public IP.  Sequences like the following are particularly aggravating:\n\n<p></p><div class=\"restricted\"><pre>03/13/13 13:02:39 PERMISSION DENIED to unauthenticated@unmapped from host\n  127.0.0.1 for command 60008 (DC_CHILDALIVE), access level DAEMON: reason:\n  cached result for DAEMON; see first case for the full reason\n03/13/13 13:05:52 Got SIGHUP.  Re-reading config files.\n03/13/13 13:05:52 Enumerating interfaces: lo 127.0.0.1 up\n03/13/13 13:05:52 Enumerating interfaces: em1 128.104.103.3 up\n03/13/13 13:05:52 Enumerating interfaces: virbr0 192.168.122.1 up\n03/13/13 13:05:52 Setting maximum accepts per cycle 8.\n03/13/13 13:05:52 Reconfiguring all running daemons.\n03/13/13 13:05:52 Sent SIGHUP to STARTD (pid 1465)\n03/13/13 13:05:58 WARNING: forward resolution of localhost6 doesn't match\n  127.0.0.1!\n03/13/13 13:05:58 WARNING: forward resolution of localhost6.localdomain6\n  doesn't match 127.0.0.1!\n03/13/13 13:05:58 PERMISSION DENIED to unauthenticated@unmapped from host\n  127.0.0.1 for command 60008 (DC_CHILDALIVE), access level DAEMON: reason:\n  DAEMON authorization policy contains no matching ALLOW entry for this request;\n  identifiers used for this host:\n  127.0.0.1,localhost,localhost.localdomain,localhost4,localhost4.localdomain4,\n  localhost.localdomain, hostname size = 5, original ip address = 127.0.0.1\n</pre></div>My initial suggestion was then for a knob that would, after the interface enumeration on a SIGHUP is done, check if the what it would select for the 'main' interface is now different, and if so, restart.  A periodic check would be even tastier.\n\n<p></p><hr/>\n<em>2013-Mar-21 16:12:38 by tlmiller:</em> <br/>\n\nActually, tastiest would be to have a configuration option that cause the master to block until a 'real' interface became available.  Defining 'real' is nontrivial, but for BaTLab, \"non-private\" would work just fine.\n\n<p></p><hr/>\n<em>2014-Jul-10 14:27:39 by tlmiller:</em> <br/>\n\nLIGO's been bit by this as well, although since they specify NETWORK_INTERFACE, the master exits (unable to find an interface).  It seems like it should be easy to work around your particular situation -- if the master can't find an\ninterface to bind to, it should sleep for a while and then restart.\n\n<p>For the laptop case (and a few others), it would be convenient to have a blacklist (e.g., I know I /don't/ want loopback or any of the VM interfaces, but I could be using eth0 or wlan0, or maybe usb0, and I have no idea what the IP might be, and it could be a private address).</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/687/NetworkAddressMonitoring.doc\">NetworkAddressMonitoring.doc</a>\n26112 bytes added by jfrey on 2013-Feb-21 21:25:46 UTC.\n<br/>\nDesign document for master monitoring of network address.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "", "type": "enhance", "last_change": "2014-Jul-10 14:34", "status": "new", "created": "2013-Feb-21 11:59", "fixed_version": "2013-Feb-21 11:59", "broken_version": "v070800", "priority": "2", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, adesmet@cs.wisc.edu", "due_date": ""}