{"id": 4792, "title": "Ticket #4792: simple option to condor_q to query the negotiator's autocluster", "description": "<blockquote>\nTo perform matching (to determine what pilots are needed), glideinWMS currently queries the schedd for all jobs matching a certain constraint, returning several significant attributes. We've found that this query is prohibitively expensive - on a test with 500k idle jobs in queue, this took over 40 minutes to return\nHowever, glideinWMS takes the result of the query and counts the number of jobs with identical significant attributes (the total count is then used to gauge demand). In other words - it performs auto-clustering! If the schedd could provide the auto-clusters (and job count per auto-cluster) as a query protocol, then we could greatly reduce the cost of the query.\n\n<p>There is no immediate need to query anything other than the autocluster information currently built by the schedd.\n\n</p><p>note: this ticket is the former <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4613\" onclick=\"get_ticket_and_populate_wrapper('4613'); return false;\" title=\"General Auto-cluster query tool\">#4613</a></span>, since the scope of that task was substantially reduced after that ticket already had several commits (that no longer apply.)</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Sep-26 16:56:14 by tannenba:</em> <br/>\n\nDoes glideInWMS need or expect these resource request counts in any particular order?  For instance, does glideInWMS expect to receive these requests in FIFO or job priority order?  I don't know if it tries to create glideins for the 'most important' jobs first, or if that doesn't matter....  I <em>think</em> the answer is glideinWMS does not expect any particular ordering, but I am not sure, and it could be important.\n\n<p>Also, does the condor_q performed now by glideinwms have both a constraint (selection) <em>and</em> a projection via <code>-format</code> or <code>-autoformat</code> ?  If so, can I assume that the attributes requested in the projection are the significant attributes that glideinwms wants to autocluster with?   I <em>think</em> the answer is yes, based on phone conversations, but would like confirmation from someone knowledgeable on glideinWMS implementation.  Thanks.\n\n</p><p></p><hr/>\n<em>2014-Sep-26 17:04:48 by bbockelm:</em> <br/>\n\nHi ToddT,\n\n<p>In my understanding of the code and previous discussions with the developers, I don't believe job ordering matters.  Only the total job counts matter, as this is used to estimate the number of glideins to request.\n\n</p><p>I can confirm that both a projection and constraint appear to be used.\n\n</p><p>I have previously added Burt as a watcher and hope he can chime in if I'm wrong.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Dec-18 17:45:53 by johnkn:</em> <br/>\n\nTo make this work, there are two fairly small changes needed\n\n<p></p><ol>\n<li>Change the schedd to keep track of the count of jobs for each autocluster\n</li><li>Add a -autocluster command to condor_q which will return the autocluster information including the count of jobs in each autocluster.\n</li></ol>\n\n<p></p><hr/>\n<em>2015-Jan-07 15:41:41 by bbockelm:</em> <br/>\n\nHi TJ,\n\n<p>I can't quite tell - is this ticket still active?  Poking through the commit, it seems that everything is done.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jan-07 17:22:52 by johnkn:</em> <br/>\n\nThe code does not yet handle constraints.  and I found a bug in the way the iterator interacts with the V3 queue protocol when not forking. So still I active development.  should be done in a day or so.\n\n<p></p><hr/>\n<em>2015-Jan-07 20:00:56 by bbockelm:</em> <br/>\n\nThanks!  Just enthusiastic about trying things out...</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-17 10:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5547981dc685a40876466d0c8d1256dfa04f04cb\">[43379]</a></span>: correct a typo introduced into the condor_q man page when doing doc for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-17 10:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd7c64bbb824509492dd4149d0f2a0200fd7a0b2\">[43378]</a></span>: edit and complete documentation for new condor_q -autocluster option <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-16 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3db864d2c4c7b086d07bcf1bc7e6210963604f13\">[43369]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4797\" onclick=\"get_ticket_and_populate_wrapper('4797'); return false;\" title=\"SCHEDD should have blacklist and whitelist for significant attributes\">#4797</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4806\" onclick=\"get_ticket_and_populate_wrapper('4806'); return false;\" title='condor_q should support \"-limit\" to control the number of results'>#4806</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4828\" onclick=\"get_ticket_and_populate_wrapper('4828'); return false;\" title=\"CONDOR_Q_USE_V3_PROTOCOL should be on by default\">#4828</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-29 14:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0b91cc9672976e739d0e08f50dc113d504d26194\">[42471]</a></span>: fix memory leaks found by covertity in previous commit for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-08 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1d0c94fc0bda5c65fb83708ee7cb0cc7ff1e48fd\">[42151]</a></span>: use more efficient <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GetInternalRefs\" title=\"Get Internal Refs\">GetInternalRefs</a></span> over <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GetReferences\" title=\"Get References\">GetReferences</a></span> in autocluster <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-08 08:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/26144767f139c26bf47dcb3abc3434c9286073e0\">[42132]</a></span>: add support for -constraint with condor_q -autocluster, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span> this commit also fixes a potential problem with the iteration of the autoclusters in the schedd when the code does not fork to handle the query. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 10:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b7b9c9f7d2a69d43f360458872b5966444536b64\">[41982]</a></span>: add condor_q -autocluster to query the schedds negotiator autocluster information <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4792\" onclick=\"get_ticket_and_populate_wrapper('4792'); return false;\" title=\"simple option to condor_q to query the negotiator's autocluster\">#4792</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-May-13 11:16", "status": "resolved", "created": "2014-Dec-18 17:44", "fixed_version": "2014-Dec-18 17:44", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "#4490", "creator": "johnkn", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, burt@fnal.gov, tannenba@cs.wisc.edu, parag@fnal.gov, johnkn@cs.wisc.edu", "due_date": ""}