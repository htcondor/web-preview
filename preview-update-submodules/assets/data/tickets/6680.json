{"id": 6680, "title": "Ticket #6680: late materialization itemdata should be spooled", "description": "<blockquote>\nWhen submitting late materialization jobs, itemdata from the QUEUE statement should be sent to the schedd and stored in the SPOOL directory beside the spooled submit digest.\n\n<p>a new RPC will be added to the SCHEDD qmgr.  <code>SendMaterializeData</code> which will accept a cluster id and a stream of lines of data. The RPC can only be called during submission (after <code>NewCluster</code> is called) and the cluster id must be the one returned by <code>NewCluster</code>\n\n</p><p>The schedd will write the stream of materialize data into a file at </p><div class=\"code\">\n<pre class=\"code\">$(SPOOL)/$(Cluster)%10000/condor_submit.$(Cluster).items</pre></div>\n  It will also store the materialization data into a pending job factory in anticipation of getting a <code>SendJobFactory</code> RPC and then a cluster ad.\n\n<p>This RPC will then return the full path name to the spooled itemdata so that the client can include that filename in the submit digest that it sends using a subsequent <code>SentJobFactory</code> RPC\n\n</p><p>The spooled materialize data file will be used when the Schedd is restarted.\n\n</p><p>In order to future-proof the file format, and to support submit from python bindings.  The materialization itemdata will support using the 0x1F character as a field separator as an optional alternate to the current space and/or comma field separator used by the current submit file parser.\n\n</p><p>When the queue statement indicates that there are multiple fields, the itemdata splitter will check for the 0x1F chararacter, and if it finds one, then it will split only on the 0x1F character.  If not, then it will split on space and/or comma as it does now.\n\n</p><p>It is recommended (but not required) that clients using the <code>SendMaterializationData</code> RPC use 0x1f as the field separator.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6718\" onclick=\"get_ticket_and_populate_wrapper('6718'); return false;\" title=\"Fix spooling of late materialization itemdata\">#6718</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFix spooling of late materialization itemdata</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-24 10:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/52dd80331299fd8a4d68181cdc3743108cdc4f42\">[55206]</a></span>: Fix delete of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6680\" onclick=\"get_ticket_and_populate_wrapper('6680'); return false;\" title=\"late materialization itemdata should be spooled\">#6680</a></span> Must use DestroyJobFactory() function, as <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> is an incomplete type in this place in the code.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jul-24 08:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c64356f073771ce60b6751916713d6109e0a9189\">[55204]</a></span>: Fix memory leak in item data spooling code. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6680\" onclick=\"get_ticket_and_populate_wrapper('6680'); return false;\" title=\"late materialization itemdata should be spooled\">#6680</a></span> This is a temporary fix for a memory leak when spooling item data over the qmgmt connection. The real fix is to put the newly-allocated <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactory\" title=\"Job Factory\">JobFactory</a></span> object into <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobFactoriesSubmitPending\" title=\"Job Factories Submit Pending\">JobFactoriesSubmitPending</a></span> (as in the commented-out line).  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-11 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1ec7aff037af7ae1421e313f798ce922a8d94a24\">[54927]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6680\" onclick=\"get_ticket_and_populate_wrapper('6680'); return false;\" title=\"late materialization itemdata should be spooled\">#6680</a></span>, spool the submit itemdata when doing late materialization and for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6679\" onclick=\"get_ticket_and_populate_wrapper('6679'); return false;\" title=\"Add submit from foreach itemdata to python bindings\">#6679</a></span>, add support for submit with itemdata to the python bindings. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Jul-26 14:17", "status": "resolved", "created": "2018-May-11 14:56", "fixed_version": "2018-May-11 14:56", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "#6679", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}