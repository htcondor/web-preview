{"id": 6806, "title": "Ticket #6806: Non-qmgmt code shouldn't mess with Q_SOCK", "description": "<blockquote>\nSeveral command handlers in the schedd temporarily set Q_SOCK via [un]setQSock() calls so that they can use OwnerCheck() to see if the authenticated user is allowed to modify certain jobs in the queue. Q_SOCK is meant to be the connection information for the QMGMT command. If we're ever going to allow asynchronous handling of QMGMT commands, then these modifications of Q_SOCK can muck things up. And they're completely unnecessary. The callers can use OwnerCheck2(), which doesn't reference Q_SOCK.</blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-05 12:04:44 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : changes look good. but I did see a missing check for NULL Q_SOCK that should be part of this patch.  qmgmt.cpp line 3629</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-06 15:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/60c43969ee66f0fbbc45cec8fe324b2764746bf4\">[56136]</a></span>: Add NULL check for Q_SOCK in SetAttribute(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6806\" onclick=\"get_ticket_and_populate_wrapper('6806'); return false;\" title=\"Non-qmgmt code shouldn't mess with Q_SOCK\">#6806</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-09 11:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/48d3cab84dc56157a0eed4601d8dcf944877f800\">[55966]</a></span>: Remove unused variant of OwnerCheck() in the schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6806\" onclick=\"get_ticket_and_populate_wrapper('6806'); return false;\" title=\"Non-qmgmt code shouldn't mess with Q_SOCK\">#6806</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jan-09 11:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c5fbd9b0d0cd36ed3aa2ca9447ac654acbd1ce93\">[55965]</a></span>: More non-qmgmt code that shouldn't mess with Q_SOCK. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6806\" onclick=\"get_ticket_and_populate_wrapper('6806'); return false;\" title=\"Non-qmgmt code shouldn't mess with Q_SOCK\">#6806</a></span> Transferd-related code now calls OwnerCheck2(), which doesn't consult Q_SOCK.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-25 15:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bf6117ef850bfef7dda53a5ab573edb52ad8fecf\">[55630]</a></span>: Non-qmgmt code shouldn't mess with Q_SOCK. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6806\" onclick=\"get_ticket_and_populate_wrapper('6806'); return false;\" title=\"Non-qmgmt code shouldn't mess with Q_SOCK\">#6806</a></span> Non-qmgmt command handlers are temporarily setting Q_SOCK so that they can have OwnerCheck() and SetAttribute() return failure if the user isn't authorized to modify the affected jobs. This is unnecessary and likely to mess up any future work to allow\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Feb-08 11:16", "status": "resolved", "created": "2018-Oct-25 13:21", "fixed_version": "2018-Oct-25 13:21", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}