{"id": 3565, "title": "Ticket #3565: mmap'ing in a standard universe job crashes the shadow", "description": "<blockquote>\nIf a standard universe job calls mmap, the shadow crashes with\n\n<p>04/08/13 09:42:53 (23559697.0) (22450):ERROR \"Assertion ERROR on (syscall_sock-&gt;end_of_message())\" at line 3803 in file /slots/01/dir_7267/userdir/src/condor_syscall_lib/receivers.cpp\n\n</p><p>After which the job goes to Idle and the process repeats itself.\n\n</p><p>Note that mmap isn't supported in standard universe, and the code is trying to return ENOSYS, but the client hangs up earlier than expected.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-May-13 13:04:36 by tlmiller:</em> <br/>\n\nInvestigation revealed two problems:\n\n<p>(1) The direct cause of the crash was code( void * ) being unimplemented (and empty messages, by default, not being allowed).  Implementing this function eliminated the crash.  However,\n\n</p><p>(2) The code generator only sets errno in the job for functions which return (void) pointers if that pointer is NULL... and (void *)-1 is a legal error value for mmap().\n\n</p><p>One possibility is to check in the mmap() switch if the remote syscal returned -1 and assume it only does so for E_NOSYS.  (This is currently true -- if the remote syscall is made at all, it always returns -1 and ENOSYS.)\n\n</p><p>However, it appears that the only thing the remote syscall does is log the fact the call to mmap() failed, via CONDOR_NotSupported() calling job_report_store_error().  This 'job report' appears to be accessible only via the notification e-mail.  This suggests it wouldn't be much of a loss simply to handle mmap() entirely within the job.\n\n</p><p></p><hr/>\n<em>2013-May-15 13:25:21 by tlmiller:</em> <br/>\n\nIt doesn't look as hard as I thought it would to write custom senders/receivers (especially with the generated code to start from), so I'm just fixing those to check for MAP_FAILED instead of NULL for mmap().\n\n<p></p><hr/>\n<em>2013-May-16 09:30:07 by gthain:</em> <br/>\n\nTodd:\n\n<p>How about we make this a reinterpret_cast to make it clearer what's going on, and then you can push it to master.\n\n</p><p></p><hr/>\n<em>2013-May-16 16:47:02 by tlmiller:</em> <br/>\n\nDone.\n\n<p></p><hr/>\n<em>2013-May-17 13:45:51 by tlmiller:</em> <br/>\n\nForgot a state.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/726/gt-3565.diff\">gt-3565.diff</a>\n5439 bytes added by tlmiller on 2013-May-15 20:52:26 UTC.\n<br/>\nProposed patch.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-29 15:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/57b83a2fd7367cc4684b529cfe2d289e334c98ca\">[35935]</a></span>: better wording for version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3565\" onclick=\"get_ticket_and_populate_wrapper('3565'); return false;\" title=\"mmap'ing in a standard universe job crashes the shadow\">#3565</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-17 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/94d4f09c06dae239d63f28775daebc54ea63f06f\">[35752]</a></span>: (<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3565\" onclick=\"get_ticket_and_populate_wrapper('3565'); return false;\" title=\"mmap'ing in a standard universe job crashes the shadow\">#3565</a></span>) Document standard universe fix.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-16 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e4a578ef90d631eb5c5685bbf029cb959bbef3cf\">[35717]</a></span>: (<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3565\" onclick=\"get_ticket_and_populate_wrapper('3565'); return false;\" title=\"mmap'ing in a standard universe job crashes the shadow\">#3565</a></span>) Make mmap() behave less badly in standard universe.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-May-17 14:06", "status": "defer", "created": "2013-Apr-08 09:48", "fixed_version": "2013-Apr-08 09:48", "broken_version": "v070800", "priority": "5", "subsystem": "Std", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}