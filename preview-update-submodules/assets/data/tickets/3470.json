{"id": 3470, "title": "Ticket #3470: Allow old signal escalation semantics and to use remove_killI_sig", "description": "<blockquote>\nThe semantics of signal escalation changed, requiring that jobs add job_wants_graceful_removal in the submit file if it wants to use a custom exit signal for removal.  Additionally, it removed the usage of remove_kill_sig as an optional for defining a custom signal for removal.  It would be nice to have the option of whether to require jobs to specify if they want to use a custom signal (new method) or to use a custom signal if it is defined (original method) as well as to allow remove_kill_sig to be used to define the signal.  If both remove_kill_sig and kill_sig are defined, remove_kill_sig should be preferred (as it was before).</blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-31 13:34:44 by tstclair:</em> <br/>\n\nInitial inspection looks ok to me, I'll let Dan chime in on his verdict.\n\n<p></p><hr/>\n<em>2013-Jan-31 15:32:11 by danb:</em> <br/>\n\nThis syntax looks wrong to me:\n\n<p></p><pre>    MachineMaxVacateTime = $(KILLING_TIMEOUT-1)\n</pre>\n\n<p>According to the following code, the meaning of JOBS_REQUEST_GRACEFUL_REMOVAL is <em>not</em> that it is the default for WANT_GRACEFUL_REMOVAL.\n\n</p><p></p><pre>    if( param_boolean(\"JOBS_REQUEST_GRACEFUL_REMOVAL\",false) )\n        thejobAd-&gt;LookupBool(ATTR_WANT_GRACEFUL_REMOVAL, job_wants_graceful_removal );\n    } else if( findSoftKillSig(thejobAd) != -1 || findRmKillSig(thejobA&amp;d) != -1 ) {\n        job_wants_graceful_removal = true;\n    }\n</pre>\n\n<p>Instead, it is a switch between the new and old behavior.  This is confusing to anyone who isn't intimately familiar with the history of all this.  If it is false (the default), then graceful removal is only used if a custom kill signal is defined.  The job's definition of WANT_GRACEFUL_REMOVAL is ignored.  If JOBS_REQUEST_GRACEFUL_REMOVAL is true, then graceful removal only happens if he job also sets WANT_GRACEFUL_REMOVAL to true.\n\n</p><p>I would perfer that if the job sets WANT_GRACEFUL_REMOVAL to true or to false, then we honor that setting.  Make sense?\n\n</p><p></p><hr/>\n<em>2013-Jan-31 16:21:31 by danb:</em> <br/>\n\nThe new patch assumes that LookupBool() leaves the result value alone if the attribute is not defined.  While that may be how it is currently implemented, I don't see anything in the header file that guarantees these semantics.  I'll leave it up to you how paranoid to be.  One solution would be to update the header file ;-)\n\n<p>Other than that point, I see no issues with the new patch.\n\n</p><p></p><hr/>\n<em>2013-Feb-01 08:41:15 by rrati:</em> <br/>\n\nAdded protection for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LookupBool\" title=\"Lookup Bool\">LookupBool</a></span> semantic change if the attribute isn't defined.  Better safe than sorry. :)\n\n<p></p><hr/>\n<em>2013-Feb-01 08:41:46 by rrati:</em> <br/>\n\nPlease consider this change for inclusion the stable release.\n\n<p></p><hr/>\n<em>2013-Feb-18 16:18:06 by smoler:</em> <br/>\n\nDocumentation task to be completed:\n\n<p>Add documentation of the <code>GRACEFULLY_REMOVE_JOBS</code> config knob. This is a schedd param that controls whether jobs are gracefully removed by default. It can be overridden by a job setting want_graceful_removal in the submit description file. The default value is TRUE.\n\n</p><p></p><hr/>\n<em>2013-May-20 15:15:18 by tannenba:</em> <br/>\n\nLooks like this changed semantics from v7.8 and v8.0 - do we need to warn users who are upgrading?\n\n<p></p><hr/>\n<em>2013-May-20 16:38:02 by danb:</em> <br/>\n\nHi Todd,\n\n<p>I think I overlooked the fact that GRACEFULLY_REMOVE_JOBS is true by default when I reviewed the update to this patch.  It certainly is a surprise to me.  If we want to keep that behavior, I agree that users should be warned.\n\n</p><p>--Dan\n\n</p><p></p><hr/>\n<em>2013-May-21 15:39:01 by tstclair:</em> <br/>\n\nThe documentation might go something like: \"8.0 series signal escalation semantics have changed to better align with previous versions (7.6 &amp; prior) when kill_sig is present.  By default  'GRACEFULLY_REMOVE_JOBS = TRUE' replaces 'JOBS_REQUEST_GRACEFUL_REMOVAL=FALSE' from the 7.8 series.  Should users depend on the 7.8 series signal escalation semantics, they can set 'GRACEFULLY_REMOVE_JOBS = FALSE'.\"\n\n<p>I'm not exactly certain where this goes in the manual so I'm kicking back to TT.\n\n</p><p></p><hr/>\n<em>2013-May-21 15:53:02 by danb:</em> <br/>\n\nHi Tim,\n\n<p>I'm not sure I agree that the new behavior is more in line with 7.6 behavior.  The new default is GRACEFULLY_REMOVE_JOBS=TRUE.  This was never the default prior to 7.9.  By default, removal was done via a fast shutdown of the starter, not a graceful one.  This influences how the job is shut down and whether file transfer has an opportunity to save state.\n\n</p><p>Maybe there is some other behavior you have in mind when you say it is more in line with 7.6?\n\n</p><p></p><hr/>\n<em>2013-May-21 16:04:27 by tstclair:</em> <br/>\n\nshould append 'when kill_sig is present' [EDITED].  Also feel free to edit the notice.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=3486\" onclick=\"get_ticket_and_populate_wrapper('3486'); return false;\" title=\"Document GRACEFULLY_REMOVE_JOBS for signal escalation semantics fix\">#3486</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDocument GRACEFULLY_REMOVE_JOBS for signal escalation semantics fix</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-18 16:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/575e48202bf772acfae872c35d41daf4c6ee38fc\">[34961]</a></span>: documentation, including of new knob GRACEFULLY_REMOVE_JOBS, and proper version history items on correct branch of manual. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-18 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6fddc8c718db6276ae022023c6dc62c143b1e03d\">[34960]</a></span>: Revert \"Version history for custom signal semantics fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span>\" Commit placed on wrong branch. This reverts commit 4edafa3115837781935719c561f5e4a76bab31b9.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-07 12:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4edafa3115837781935719c561f5e4a76bab31b9\">[34877]</a></span>: Version history for custom signal semantics fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span>  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-04 17:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/39bb636d40e6b2979b0e596ca1a50713455da4df\">[34845]</a></span>: Fix documentation of KILLING_TIMEOUT. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span> It is not related to user-defined custom kill signals anymore. It is only for timing out on fast shutdown of the starter and reverting to hard killing.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-01 08:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5f796f3143e25dd325a7a1ee3d8bf8a7830914f3\">[34814]</a></span>: Added protection against <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LookupBool\" title=\"Lookup Bool\">LookupBool</a></span> changing semantics. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span>  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-31 16:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d6086140203c78b8508cbc81c3136897911f0a42\">[34813]</a></span>: Changed JOBS_REQUEST_GRACEFUL_REMOVAL -&gt; GRACEFULLY_REMOVE_JOBS and it is now a default for whether to gracefully remove jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span>  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-31 10:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c0fe10f015766bcc6562da8d7e272c1ce4fe7885\">[34805]</a></span>: Restore old signal escalation semantics by adding JOBS_REQUEST_GRACEFUL_REMOVAL which defaults to false. Also allow remove_kill_sig to define the kill signal and prefer it to kill_sig if both are defined. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3470\" onclick=\"get_ticket_and_populate_wrapper('3470'); return false;\" title=\"Allow old signal escalation semantics and to use remove_killI_sig\">#3470</a></span>  (By Robert Rati )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-May-21 16:06", "status": "resolved", "created": "2013-Jan-31 10:55", "fixed_version": "2013-Jan-31 10:55", "broken_version": "v070703", "priority": "2", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "#2536", "creator": "rrati", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, dan@hep.wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}