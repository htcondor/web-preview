{"id": 3658, "title": "Ticket #3658: DAGMan interprets warning from submit as failure", "description": "<blockquote>\nTry the following submit file:\n<div class=\"code\">\n<pre class=\"code\">executable = /bin/sleep\narguments = 100\nuniverse = vanilla\noutput = 3650.$(cluster).$(process).out\nerr = 3650.$(cluster).$(process).err\nlog = 3650.$(cluster).log\nqueue 5\n</pre></div>\n\nwith the following DAG file\n<div class=\"code\">\n<pre class=\"code\">job 0 3650.cmd\n</pre></div>\n\n\n<p>The jobs are submitted, but DAGMan does not believe they are, so you get 6 identical clusters, and DAGMan exits, leaving a rescue DAG and running jobs behind.\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_q\n\n\n-- Submitter: nwp@llunet.cs.wisc.edu : &lt;128.105.14.28:59257&gt; : llunet.cs.wisc.edu\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  79.1   nwp             5/25 10:04   0+00:01:05 R  0   0.0  sleep 100\n  79.2   nwp             5/25 10:04   0+00:01:05 R  0   0.0  sleep 100\n  79.3   nwp             5/25 10:04   0+00:01:05 R  0   0.0  sleep 100\n  79.4   nwp             5/25 10:04   0+00:01:04 R  0   0.0  sleep 100\n  80.0   nwp             5/25 10:04   0+00:01:02 R  0   0.0  sleep 100\n  80.1   nwp             5/25 10:04   0+00:01:02 R  0   0.0  sleep 100\n  80.2   nwp             5/25 10:04   0+00:01:02 R  0   0.0  sleep 100\n  80.3   nwp             5/25 10:04   0+00:01:02 R  0   0.0  sleep 100\n  80.4   nwp             5/25 10:04   0+00:00:00 I  0   0.0  sleep 100\n  81.0   nwp             5/25 10:04   0+00:00:00 I  0   0.0  sleep 100\n  81.1   nwp             5/25 10:04   0+00:00:00 I  0   0.0  sleep 100\n  81.2   nwp             5/25 10:04   0+00:00:00 I  0   0.0  sleep 100\n  81.3   nwp             5/25 10:04   0+00:00:00 I  0   0.0  sleep 100\n  81.4   nwp             5/25 10:04   0+00:00:00 I  0   0.0  sleep 100\n\n14 jobs; 0 completed, 0 removed, 6 idle, 8 running, 0 held, 0 suspended\n</pre></div>\n\n\n<p>See attached dagman.out file also</p></blockquote>", "remarks": "<blockquote>\n<em>2013-May-25 10:20:08 by nwp:</em> <br/>\n\nError message from condor_submit is:\n<div class=\"code\">\n<pre class=\"code\">WARNING: the line `err = 3650.$(cluster).$(process).err' was unused by condor_submit. Is it a typo?\n</pre></div>\n\n\n<p>Then DAGMan reports an error:\n</p><div class=\"code\">\n<pre class=\"code\">05/25/13 10:04:57 ERROR: parse_condor_submit failed:\n        WARNING: the line `err = 3650.$(cluster).$(process).err' was unused by condor_submit. Is it a typo?\n05/25/13 10:04:57 ERROR: submit attempt failed\n05/25/13 10:04:57 submit command was: condor_submit -a dag_node_name' '=' '0 -a +DAGManJobId' '=' '75 -a DAGManJobId' '=' '75 -a submit_event_notes' '=' 'DAG' 'Node:' '0 -a dagman_log' '=' '/scratch/nwp/3650/3650.dag.nodes.log -a +DAGManNodesMask' '=' '\"0,1,2,4,5,7,9,10,11,12,13,16,17,24,27\" -a DAG_STATUS' '=' '0 -a FAILED_COUNT' '=' '0 -a +DAGParentNodeNames' '=' '\"\" -a notification' '=' 'never 3650.cmd\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-May-25 22:34:35 by nwp:</em> <br/>\n\nThe problem is that the WARNING line from condor_submit output contains the string \"cluster\".  DAGMan expects such a line to have the cluster Id in it, and does a scanf for <code>\" %d job(s) submitted to cluster %d\"</code>, and the warning line\ndoes not satisfy that.\n\n<p>Have DAGMan search for <code>\" submitted to cluster \"</code>, which will be more restrictive.\n\n</p><p></p><hr/>\n<em>2013-May-25 22:47:12 by nwp:</em> <br/>\n\nMaybe we should have DAGMan unconditionally run condor_rm, rather than checking that we have submitted jobs (at line 520, in src/condor_dagman/dagman_main.cpp).\n\n<p></p><hr/>\n<em>2013-May-26 20:05:55 by wenger:</em> <br/>\n\nYes, it seems like there are several things going on:\n<ul>\n<li>It seems like condor_submit shouldn't generate a warning in that case.\n</li><li>DAGMan should recognize that the job(s) actually got submitted.\n</li><li>The jobs weren't removed at the end.\n</li></ul>\n\n<p>Maybe we should have DAGMan always do a condor_rm of any child jobs at the end (or at least if anything went wrong).  The down side is that doing that will put more load on the schedd, so I think we should consider whether we want to always do it, and maybe also have another config knob (yay!) to turn that off.\n\n</p><p>I guess the thing is, even if condor_submit shouldn't generate a warning in this case, I imagine there are \"legitimate\" warnings that will cause similar problems -- so having DAGMan be fussier with what it recognizes in the condor_submit output would probably be good.  I guess maybe something else to do would be to get the actual exit code of condor_submit, and compare that to whether we thought the output was okay...\n\n</p><p></p><hr/>\n<em>2013-May-26 20:08:01 by wenger:</em> <br/>\n\nOkay, duh -- condor_submit is complaining because it's \"err\" not \"error\" -- so it <strong>is</strong> a legitimate warning in this case.\n\n<p></p><hr/>\n<em>2013-May-28 14:47:16 by bbockelm:</em> <br/>\n\nTo ask a dumb question - why does DAGMan uses condor_submit instead of invoking the C++ API directly?  Historical?  Clever design decision that's eluding me?\n\n<p></p><hr/>\n<em>2013-Jun-03 11:04:58 by nwp:</em> <br/>\n\nPushed onto <code>V8_0-gittrac_3658-branch</code>\n\n<p></p><hr/>\n<em>2013-Jun-03 14:11:07 by nwp:</em> <br/>\n\nThe post script in the B node for this DAG is supposed to succeed the node, but it never runs when the job fails!  Is this a regression?\n\n<p></p><hr/>\n<em>2013-Jun-03 14:15:30 by nwp:</em> <br/>\n\nOK, so <code>DAGMAN_ABORT_ON_SCARY_SUBMIT</code> short circuits the \"always run post script\" code.  Maybe this is not a regression; is it documented anywhere?\n\n<p></p><hr/>\n<em>2013-Jun-03 14:18:25 by wenger:</em> <br/>\n\nDAGMAN_ABORT_ON_SCARY_SUBMIT is documented in the config section.  It doesn't explicitly say that this overrides running the POST script -- but I guess I would consider \"aborting\" to mean that DAGMan immediately goes away...\n\n<p></p><hr/>\n<em>2013-Jun-07 15:35:46 by wenger:</em> <br/>\n\n<strong class=\"two\">CODE REVIEW</strong>\n\n<p>Hmm -- I'm not totally happy with this, but I'm also not sure whether it's worth making a bigger fix.  I think the parsing change is fine; the thing I'm not so happy with is condor_submit() returning true when the parsing fails.  I guess you could say that that's correct, since a job actually did get submitted.\n\n</p><p>But long-term, at least, I guess I'd be happier if condor_submit() returned one of three values:\n</p><ul>\n<li>okay\n</li><li>submit failed, should be retried\n</li><li>submit failed, but should <strong>not</strong> be retried\n</li></ul>\n\n<p>I guess my feeling at this point is to go ahead and merge this change for v8.0.1, but also make a derived ticket from this one to clean things up better...</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=3685\" onclick=\"get_ticket_and_populate_wrapper('3685'); return false;\" title=\"Clean up submit failures\">#3685</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nClean up submit failures</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/741/3650.dag.dagman.out\">3650.dag.dagman.out</a>\n40759 bytes added by nwp on 2013-May-25 15:16:43 UTC.\n<br/>\ndagman.out file from run above.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-25 12:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/10902b2b7e426ebb6b620c759cdcd23893d504d4\">[36676]</a></span>: edit 8.0.1 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3658\" onclick=\"get_ticket_and_populate_wrapper('3658'); return false;\" title=\"DAGMan interprets warning from submit as failure\">#3658</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-10 14:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/598d00084af67cb44a0b04a1f0f6dcd3bff73c19\">[36525]</a></span>: Make DAGMan be more restrictive in accepting condor_submit output <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3658\" onclick=\"get_ticket_and_populate_wrapper('3658'); return false;\" title=\"DAGMan interprets warning from submit as failure\">#3658</a></span> condor_dagman would try to match any line containing \"cluster\" to the output \"%d job(s) submitted to cluster %d\", and fail, even though the submit actually succeeded. Let us be more restrictive on what we accept.\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jun-10 14:54", "status": "resolved", "created": "2013-May-25 10:15", "fixed_version": "2013-May-25 10:15", "broken_version": "v080000", "priority": "3", "subsystem": "Dag", "assigned_to": "nwp", "derived_from": "", "creator": "nwp", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}