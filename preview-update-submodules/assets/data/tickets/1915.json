{"id": 1915, "title": "Ticket #1915: schedd EXCEPTs on shutdown due to bad reference count", "description": "<blockquote>\nThe following error happens when the schedd is shut down:\n\n<p></p><div class=\"verbatim\">\n<pre>02/14/11 15:55:32 (pid:20530) ERROR \"Assertion ERROR on (m_ref_count == 0)\" at line 98 in file /scratch/danb/CONDOR_SRC/src/condor_utils/classy_counted_ptr.h\n</pre></div>\n\n\n<p>This is happening in <code>DaemonCore::Cancel_And_Close_All_Sockets()</code>.  The problem is that one of the sockets that is closed has a non-zero reference count, because the asynchronous negotiation code increments the reference count before registering the socket.  Currently, <code>Cancel_And_Close_All_Sockets()</code> does not call the socket callback, so any code that is waiting to receive a callback will never happen.\n\n</p><p>There are two possible solutions:\n\n</p><p></p><ol>\n<li>Get rid of <code>DaemonCore::Cancel_And_Close_All_Sockets()</code>.\n\n<p></p></li><li>Fix <code>DaemonCore::Cancel_And_Close_All_Sockets()</code> to call socket handlers after closing the sockets.  This gives the handler a chance to clean up.\n</li></ol>\n\n<p>Doing the second option correctly would require some care.  For example, the socket handler might try to register more sockets or delete the socket we are currently dealing with.  We would probably need to prevent more sockets from being registered.\n\n</p><p>Since no daemon but the schedd calls this function, I am going to just go with the first option: get rid of the function.  The only purpose it is serving is to clean things up to make memory leak detection easier.  If we decide we need that, we can try to implement this function the right way, and use it uniformly in all condor daemons, rather than just in the schedd.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Feb-14 18:01:13 by danb:</em> <br/>\n\nI am fixing this for 7.6.0 rather than 7.5.6 after discussion with Alan.  We agreed that this problem was not important enough to risk delaying the release.\n\n<p></p><hr/>\n<em>2011-Mar-01 14:16:13 by danb:</em> <br/>\n\nChange of plan: 7.5.6 is being rebased off of the 7.6 branch, so this fix goes into 7.5.6 after all.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-04 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6b288691a88e93a5b092379986fa40b09bceef26\">[20925]</a></span>: Fix crash in schedd destructor introduced in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1915\" onclick=\"get_ticket_and_populate_wrapper('1915'); return false;\" title=\"schedd EXCEPTs on shutdown due to bad reference count\">#1915</a></span>. This bug was internal to 7.5.6.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-01 14:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0e69e45444b3c8fc12ebf0866febb438b32cfc4d\">[25938]</a></span>: Documented fix for schedd reference-count exception during shutdown. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1915\" onclick=\"get_ticket_and_populate_wrapper('1915'); return false;\" title=\"schedd EXCEPTs on shutdown due to bad reference count\">#1915</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-01 14:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/129eefaa2edba036467148e59e8a01c41419218b\">[25920]</a></span>: Revert \"Documented fix for schedd reference-count exception during shutdown. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1915\" onclick=\"get_ticket_and_populate_wrapper('1915'); return false;\" title=\"schedd EXCEPTs on shutdown due to bad reference count\">#1915</a></span>\" This fix is going into 7.5.6, so I am moving the documentation there. This reverts commit 85594998f398d38ed80453263e61d7e6157a0f21.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Feb-24 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/85594998f398d38ed80453263e61d7e6157a0f21\">[25918]</a></span>: Documented fix for schedd reference-count exception during shutdown. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1915\" onclick=\"get_ticket_and_populate_wrapper('1915'); return false;\" title=\"schedd EXCEPTs on shutdown due to bad reference count\">#1915</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Feb-14 17:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89b5fc63c2ed23e3adee9d961f6b1b837eac15d0\">[20412]</a></span>: Fix schedd exception on shutdown caused by bad reference count. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1915\" onclick=\"get_ticket_and_populate_wrapper('1915'); return false;\" title=\"schedd EXCEPTs on shutdown due to bad reference count\">#1915</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Mar-01 14:16", "status": "resolved", "created": "2011-Feb-14 17:43", "fixed_version": "2011-Feb-14 17:43", "broken_version": "v070505", "priority": "3", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}