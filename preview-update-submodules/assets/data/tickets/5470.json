{"id": 5470, "title": "Ticket #5470: TimerRemove attribute broken", "description": "<blockquote>\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemover\" title=\"Timer Remover\">TimerRemover</a></span> is a job attribute that sets a lease on a job submission to the schedd. The value is interpreted as a unix epoch time after which the job should be removed. The submitter can update the time periodically. It is used by Condor-C when a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobLeaseDuration\" title=\"Job Lease Duration\">JobLeaseDuration</a></span> is set in the source job ad (the default for Condor-C jobs is no lease).\n\n<p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemover\" title=\"Timer Remover\">TimerRemover</a></span> is evaluated as part of the job policy expressions. If the schedd delegates evaluation of these expressions to another daemon (shadow, gridmanager, job router), it will need to forward subsequent updates of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> expression. It appears this does not happen at the moment. As a result, jobs for which <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> is being updated in the schedd will end up being removed by one of these other daemons if they are doing job policy evaluation.\n\n</p><p>This involves several bug fixes, primarily to ensure that updates to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> are forwarded to any daemon that assumes responsibility for evaluating the job policy expressions.</p></blockquote>", "remarks": "<blockquote>\nThis is a regression from version 8.2. In 8.2, any update of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> is propagated to the shadow or gridmanager. I suspect <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4613\" onclick=\"get_ticket_and_populate_wrapper('4613'); return false;\" title=\"General Auto-cluster query tool\">#4613</a></span> disrupted the dirty attribute tracking of the schedd's job queue.\n\n<p></p><hr/>\n<em>2016-Jan-14 16:23:48 by jfrey:</em> <br/>\n\nThe introduction of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueJob\" title=\"Job Queue Job\">JobQueueJob</a></span> object in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4613\" onclick=\"get_ticket_and_populate_wrapper('4613'); return false;\" title=\"General Auto-cluster query tool\">#4613</a></span> caused this regression. The method LogNewClassAd::Play() enables dirty attribute tracking on each <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> created in the collection. Starting with <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4613\" onclick=\"get_ticket_and_populate_wrapper('4613'); return false;\" title=\"General Auto-cluster query tool\">#4613</a></span>, this ad is then handed to ClassAdLogTable::insert() in the schedd code, which creates a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueJob\" title=\"Job Queue Job\">JobQueueJob</a></span> object, copies all attributes from the original ad into it, and deletes the original ad. It doesn't propagate the dirty tracking bit from the original ad.\n\n<p>A fix for 8.4 would be for ClassAdLogTable::insert() to propagate the dirty tracking bit from the source ad, or always enable it in the new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueJob\" title=\"Job Queue Job\">JobQueueJob</a></span> ad.\nIn 8.5, we should investigate leaving dirty tracking disabled and explicitly setting dirty flags where needed. Also, eliminate the ad copy in ClassAdLogTable::insert(), as the source ad should already be a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueJob\" title=\"Job Queue Job\">JobQueueJob</a></span> object.\n\n</p><p></p><hr/>\n<em>2016-Feb-01 11:01:47 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good, except for a quibble with check-in 47472.  The code opts for simplicity by always forwarding the evaluated value, which is fine, but the conditional evaluates ATTR_TIMER_REMOVE_CHECK rather than looking it up.  This probably further simplifies the code, but raises the question of what the semantics are when ATTR_TIMER_REMOVE_CHECK fails to evaluate.  This should never occur in practice, but a comment saying \"bad user, don't do that\" might be appropriate.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-01 15:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cd84a40602066644bf03e2fa529b51f961379aa\">[47533]</a></span>: Add comment about <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> in the job router suggested by code review. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5470\" onclick=\"get_ticket_and_populate_wrapper('5470'); return false;\" title=\"TimerRemove attribute broken\">#5470</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-19 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b3de6d5ce840a9b34158bdeab8ac84ae7fd358b4\">[47482]</a></span>: Mark attributess set via SetTimerAttribute() as dirty. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5470\" onclick=\"get_ticket_and_populate_wrapper('5470'); return false;\" title=\"TimerRemove attribute broken\">#5470</a></span> This call is used by the c-gahp to update the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> attribute, which we want to propagate to the shadow or gridmanager. Since the call doesn't take a flags argument, we need to always treat it as a dirty change.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-19 10:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2ecd703d26a10dfb2fa6e695eb3b73e34b500d94\">[47475]</a></span>: Docs for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5470\" onclick=\"get_ticket_and_populate_wrapper('5470'); return false;\" title=\"TimerRemove attribute broken\">#5470</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-19 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96a58058be3dd74f6ed2dbaae02371ab9691f9d9\">[47472]</a></span>: Fix evaluation of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> in the Job Router. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5470\" onclick=\"get_ticket_and_populate_wrapper('5470'); return false;\" title=\"TimerRemove attribute broken\">#5470</a></span> Update <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> from the source job ad when doing job policy evaluation. Remove <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerRemove\" title=\"Timer Remove\">TimerRemove</a></span> from the destination job ad.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-19 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb20acc67f303fa7615be92333adf6fd6d223ee1\">[47473]</a></span>: Fix propagation of modified attributes to the shadow/gridmanager. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5470\" onclick=\"get_ticket_and_populate_wrapper('5470'); return false;\" title=\"TimerRemove attribute broken\">#5470</a></span> Ensure that dirty attribute tracking is enabled in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Feb-01 15:58", "status": "resolved", "created": "2016-Jan-11 16:44", "fixed_version": "2016-Jan-11 16:44", "broken_version": "v080303", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#5469", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}