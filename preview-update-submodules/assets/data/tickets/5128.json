{"id": 5128, "title": "Ticket #5128: Collector tries to authenticate with self", "description": "<blockquote>\nAt startup, the collector currently tries to detect whether it is trying to update itself; it is doing this incorrectly (it compares its default sinful with the collectors to update sinful as a string comparison).  This causes a 30-second 'hang' of the daemon when using default settings.\n\n<p>I think the fix looks like this:\n\n</p><p></p><div class=\"verbatim\">\n<pre>--- a/src/condor_collector.V6/collector.cpp\n+++ b/src/condor_collector.V6/collector.cpp\n@@ -1350,10 +1350,12 @@ void CollectorDaemon::Config()\n        if( myself == NULL ) {\n                EXCEPT( \"Unable to determine my own address, aborting rather than hang.  You may need to make sure the shared port daemon is running first.\" );\n        }\n+       Sinful mysinful(myself);\n        while( collectorsToUpdate-&gt;next( daemon ) ) {\n                const char * current = daemon-&gt;addr();\n                if( current == NULL ) { continue; }\n-               if( strcmp( myself, current ) == 0 ) {\n+               Sinful theirsinful(current);\n+               if( mysinful.addressPointsToMe(theirsinful) ) {\n                        collectorsToUpdate-&gt;deleteCurrent();\n                }\n        }\n</pre></div>\n\n\n<p>The fix above just papers over the issue, as it still relies on the concept of a 'default' socket.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-06 10:16:11 by tim:</em> <br/>\n\nThis code was added in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4850\" onclick=\"get_ticket_and_populate_wrapper('4850'); return false;\" title=\"Collector ad is dropped for personal HTCondor\">#4850</a></span>\n\n<p></p><hr/>\n<em>2015-Jul-06 10:22:01 by tlmiller:</em> <br/>\n\nBrian writes:\n\n<p></p><div class=\"verbatim\">\n<pre>Originally released in 8.3.6, it causes the condor_collector to hang for 30\nseconds every time it tries to send an update of its own ad.\n</pre></div>\n\n\n<p>I'm a little surprised that (a) it's 30 seconds instead of 20 and (b) that it recovers at all.\n\n</p><p></p><hr/>\n<em>2015-Jul-06 10:30:56 by bbockelm:</em> <br/>\n\nHi ToddM,\n\n<p>Years of research, I suppose.  Authentication timeouts default to 30s while \"normal\" communication is 20s.\n\n</p><p>After the timeout, the authentication fails and the collector seems to move on.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jul-06 10:38:26 by tlmiller:</em> <br/>\n\nA fix which takes multiple sockets into account -- addressing the issue of addresses, as it were -- sounds like prime 8.5.x territory to me.  (Notionally, we could use InfoCommandSinfulStringsMyself() (after it's been fixed to properly handle TCP_FORWARDING_HOST?) and check each of those with addressPointsToMe(), but it seems like it would make more sense to work with AddressV1 instead... I will consult with AdS.)\n\n<p></p><hr/>\n<em>2015-Jul-06 10:44:41 by bbockelm:</em> <br/>\n\nYeah - it might be useful to split this ticket between \"quick and dirty for 8.3.7\" and \"fundamentally fix\".\n\n<p></p><hr/>\n<em>2015-Jul-06 10:51:49 by bbockelm:</em> <br/>\n\nFor Tim - the code was added in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4850\" onclick=\"get_ticket_and_populate_wrapper('4850'); return false;\" title=\"Collector ad is dropped for personal HTCondor\">#4850</a></span>, but the break occurred due to the sinful format changes in  <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=4934\" onclick=\"get_ticket_and_populate_wrapper('4934'); return false;\" title=\"Support IPv4 clients connecting to a mixed-mode pool.\">#4934</a></span>.  It's probably just that the solution in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4850\" onclick=\"get_ticket_and_populate_wrapper('4850'); return false;\" title=\"Collector ad is dropped for personal HTCondor\">#4850</a></span> wasn't terribly future-proofed because it used string comparison instead of a logical comparison.\n\n<p></p><hr/>\n<em>2015-Jul-06 16:37:34 by tlmiller:</em> <br/>\n\nSee <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5134\" onclick=\"get_ticket_and_populate_wrapper('5134'); return false;\" title=\"Identity and AddressV1\">#5134</a></span> for the \"real fix\" ticket.\n\n<p></p><hr/>\n<em>2015-Jul-30 16:18:39 by tlmiller:</em> <br/>\n\nSee follow-up bug at <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5185\" onclick=\"get_ticket_and_populate_wrapper('5185'); return false;\" title=\"Collector still tries to authenticate itself.\">#5185</a></span>.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5185\" onclick=\"get_ticket_and_populate_wrapper('5185'); return false;\" title=\"Collector still tries to authenticate itself.\">#5185</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCollector still tries to authenticate itself.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-21 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb80b95af7386458e285813967097a60a3bb5c69\">[45376]</a></span>: add to existing <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5128\" onclick=\"get_ticket_and_populate_wrapper('5128'); return false;\" title=\"Collector tries to authenticate with self\">#5128</a></span> version history item that bug fix does not work when using condor_shared_port.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-16 15:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f5c04d042f8dcde300c3cbf5bb9dfc8b62f2c444\">[45326]</a></span>: minor edit of 8.3.7 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5128\" onclick=\"get_ticket_and_populate_wrapper('5128'); return false;\" title=\"Collector tries to authenticate with self\">#5128</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-13 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c342739bf935b2c8a29b326abe9be87fa635ec8f\">[45292]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5128\" onclick=\"get_ticket_and_populate_wrapper('5128'); return false;\" title=\"Collector tries to authenticate with self\">#5128</a></span>) Version history.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-06 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3a520efb0279ef9cd3ee18fed18327e830c444d2\">[45217]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5128\" onclick=\"get_ticket_and_populate_wrapper('5128'); return false;\" title=\"Collector tries to authenticate with self\">#5128</a></span>) The collector will recognize its own address more reliably now.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jul-30 16:18", "status": "resolved", "created": "2015-Jul-01 22:10", "fixed_version": "2015-Jul-01 22:10", "broken_version": "v080306", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "tlmiller", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}