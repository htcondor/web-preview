{"id": 7359, "title": "Ticket #7359: Python bindings multi-thread programs crash talking to Schedd", "description": "<blockquote>\nThere have been multi-threaded python programs that have multiple threads talking to the same Schedd.  Even when these threads don't share a Schedd object, they can still crash because there is global state in condor library code that is not properly protected by a critical section.</blockquote>", "remarks": "<blockquote>\nWe're taking a two-pronged approach to fixing this:\n\n<p>TJ is working on breaking the dependence on global state in the bindings. This should make these problem that REANA observed not actually crash Python, although it will still cause exceptions due to deadlocking the schedd (<a class=\"external\" href=\"https://github.com/reanahub/reana-job-controller/issues/190\">https://github.com/reanahub/reana-job-controller/issues/190</a>).\n\n</p><p>Josh is working on applying a shared Python lock to every function call in the bindings, which should make it impossible for two threads to be in our code at the same time. We can slowly roll this protection back from individual functions if/when we clean up the underlying interfaces to be thread-safe. We can also make the lock be per-daemon, if we also add a way to uniquely identify daemons to the bindings.\n\n</p><p>Unclear as of yet how much of this will go back into stable, but probably none of it, because TJ will likely break backwards compatibility for <code>Schedd.edit</code>.\n\n</p><p></p><hr/>\n<em>2019-Dec-12 12:32:32 by jpatton:</em> <br/>\n\n<strong>REVIEW:</strong> Looks good to me, the latest commits fix the \"unhashable\" problems in both 3.7 and 2.7, assuming that the other Python 3 versions will be fine. Thanks for updating and making __init__.py a little less hacky too :)\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7417\" onclick=\"get_ticket_and_populate_wrapper('7417'); return false;\" title=\"python-bindings use after free for transaction object\">#7417</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\npython-bindings use after free for transaction object</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7429\" onclick=\"get_ticket_and_populate_wrapper('7429'); return false;\" title=\"dprintf calls in python bindings are not thread safe\">#7429</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ndprintf calls in python bindings are not thread safe</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-16 11:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6680a75d0a99a9edb6cc5709a03312a6b6925d0c\">[58665]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7359\" onclick=\"get_ticket_and_populate_wrapper('7359'); return false;\" title=\"Python bindings multi-thread programs crash talking to Schedd\">#7359</a></span>) paper over strange behavior of Transaction.__enter__ on py2  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-13 11:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/75d268bf3b8e5cf984ab9f26d84de8d9b3307b2d\">[58655]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7359\" onclick=\"get_ticket_and_populate_wrapper('7359'); return false;\" title=\"Python bindings multi-thread programs crash talking to Schedd\">#7359</a></span>) add docs and version history  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-11 15:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ecbc3df3b6c3543c03932020e5420268d1b7e12e\">[58638]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7359\" onclick=\"get_ticket_and_populate_wrapper('7359'); return false;\" title=\"Python bindings multi-thread programs crash talking to Schedd\">#7359</a></span>) fix problems with unhashable objects and functools.wraps on py2  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-09 10:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/11a8ffa2af47ddfd5efe9ba63664fc110e8435ea\">[58612]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7359\" onclick=\"get_ticket_and_populate_wrapper('7359'); return false;\" title=\"Python bindings multi-thread programs crash talking to Schedd\">#7359</a></span>) cleanup  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-06 11:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0ac92f1151a1af79dab2685e51edba12482ba268\">[58604]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7359\" onclick=\"get_ticket_and_populate_wrapper('7359'); return false;\" title=\"Python bindings multi-thread programs crash talking to Schedd\">#7359</a></span>) first pass on global Python-level lock for the bindings; also work on htcondor.__init__ in general  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-May-04 09:46", "status": "resolved", "created": "2019-Nov-06 10:40", "fixed_version": "2019-Nov-06 10:40", "broken_version": "", "priority": "2", "subsystem": "", "assigned_to": "karpel", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "karpel@wisc.edu johnkn@cs.wisc.edu tannenba@cs.wisc.edu tlmiller@cs.wisc.edu bbockelman@morgride.org", "due_date": ""}