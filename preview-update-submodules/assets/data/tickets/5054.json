{"id": 5054, "title": "Ticket #5054: file transfer appears to not always encrypt files when requested", "description": "<blockquote>\nUsing the default security settings, it appears that HTCondor will transfer files unencrypted on the wire even if the submit file explicitly requests an encrypted transfer.\n\n<p>To reproduce the problem the same way I did, set\n\n</p><p></p><pre>   STARTER_DEBUG = D_SECURITY D_FULLDEBUG\n</pre>\n\n<p>and then submit a test job that transfer a couple of input directory (that are populated with some files), and request that all job input files are encrypted on the wire.  My test.sub submit file:\n\n</p><p></p><pre>   executable = c:\\utils\\sleep.exe\n   arguments = 10\n   encrypt_input_files = *\n   transfer_input_files = c:\\temp\\swamp_configs, c:\\temp\\patch\n   should_transfer_files = YES\n   when_to_transfer_output = ON_EXIT\n   log = test.log\n   universe = vanilla\n   queue\n</pre>\n\n<p>After the job ran, I observed the following in the <code>StarterLog</code> on the execute machine:\n\n</p><p></p><pre>   05/13/15 14:46:03 FILETRANSFER: incoming file_command is 2\n   05/13/15 14:46:03 NOT enabling crypto - there was no key exchanged.\n</pre>\n\n<p>I did the same test on both Linux and Windows using v8.3.5 pre-release, and got the same results.  I did not change any <code>SEC_*</code> settings in my condor_config file(s).</p></blockquote>", "remarks": "<blockquote>\n<em>2015-May-13 16:27:03 by tannenba:</em> <br/>\n\nOn a related note: I boldly assert that if HTCondor is told to encrypt a file transfer and it cannot comply, the file transfer should fail - it should not fall back in transferring the file in the clear.\n\n<p>Looking at the source code in <a class=\"file\" href=\"rlog?f=src/condor_utils/file_transfer.cpp\">/src/condor_utils/file_transfer.cpp</a>, we see the following lines:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">dprintf( D_SECURITY, \"FILETRANSFER: incoming file_command is %i\\n\", reply);\nif( !reply ) {\n\tbreak;\n}\nif (reply == 2) {\n\ts-&gt;set_crypto_mode(true);\n} else if (reply == 3) {\n\ts-&gt;set_crypto_mode(false);\n}\nelse {\n\ts-&gt;set_crypto_mode(socket_default_crypto);\n}\n</pre></div>\n\n\n<p>Seems to me that this code should check the return values from method <code>set_crypto_mode()</code>, and if this method fails, the file transfer should fail (ideally propagating a reason to the user log).\n\n</p><p></p><hr/>\n<em>2015-May-27 15:16:37 by zmiller:</em> <br/>\n\nI looked into this in depth.  There is no crypto key to use if authentication between the shadow and starter does not occur.  This is currently the default in both the CHTC pool and HTCondor version 8.3.5.\n\n<p>I propose the following changes:\n\n</p><p></p><ol>\n<li>Change the CHTC to use a special kind of authentication called \"match password\".  I have emailed our sysadmin to request this change and will let you know when it is in place.  This causes crypto keys to be exchanged and per-file encryption is then possible.\n\n<p></p></li><li>Change the default in HTCondor 8.3.6 to have \"match password\" enabled by default.  This obviates the need for item 1 above, but item 1 does no harm and this item is a good change to make for ALL pools, not just CHTC.\n\n<p></p></li><li>When doing file transfer, put the job on hold if encryption for a file was requested but unable to happen due to lack of encryption keys.  I have already completed this code, am testing it, and will check it in for 8.3.6.  This way you can be assured your job will never run and files will never be transferred if encryption was unavailable for any reason.\n</li></ol>\n\n<p>Due to other various hold-ups, we will not have release candidate binaries for 8.3.6 until Monday (slipped from Thursday this week).  I suggest we all check in then.\n\n</p><p></p><hr/>\n<em>2015-May-28 08:54:21 by bbockelm:</em> <br/>\n\nMatch auth should only really be used if the channel from negotiator-&gt;schedd is secure.\n\n<p>Should we also change defaults so that is true also?\n\n</p><p>I'm somewhat uncomfortable making a significant security default change as a side-impact of a different ticket.\n\n</p><p></p><hr/>\n<em>2015-May-28 10:09:53 by zmiller:</em> <br/>\n\nBrian:\n\n<p>I disagree.  Are you saying that using match password is somehow worse than no auth at all?  It only uses information that was already being sent.  Let's talk later today if you have a chance.\n\n</p><p>As for enabling it by default:  We had planned to do that before 8.4.0.  It wasn't just because of this ticket.  I should have made a separate ticket, I suppose, but it wasn't a side-effect.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5304\" onclick=\"get_ticket_and_populate_wrapper('5304'); return false;\" title=\"Need more permissions for match password auth\">#5304</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nNeed more permissions for match password auth</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-12 12:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cd0398a182e410913af215370662d54f83e42ea6\">[45039]</a></span>: add 8.3.6 version history item and change knob defn <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5054\" onclick=\"get_ticket_and_populate_wrapper('5054'); return false;\" title=\"file transfer appears to not always encrypt files when requested\">#5054</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-28 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e40d3c576cb54da2ab38a564312c4d8f35167f87\">[44900]</a></span>: Make sure stub function returns a value to appease warnings-as-errors. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5054\" onclick=\"get_ticket_and_populate_wrapper('5054'); return false;\" title=\"file transfer appears to not always encrypt files when requested\">#5054</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-28 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/06bfb3b81ff6e662c7321cecf6ac7d7e838bf8ce\">[44902]</a></span>: Make sure stub function returns a value to appease warnings-as-errors. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5054\" onclick=\"get_ticket_and_populate_wrapper('5054'); return false;\" title=\"file transfer appears to not always encrypt files when requested\">#5054</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-28 00:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6b4029595ac2cad473ac37e52261dc3fbc42f865\">[44899]</a></span>: Error in coding: Check actual error code (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5054\" onclick=\"get_ticket_and_populate_wrapper('5054'); return false;\" title=\"file transfer appears to not always encrypt files when requested\">#5054</a></span>)  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-27 22:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5b7b77d96d1d292201425daff3cf8133a06a4a65\">[44897]</a></span>: Change default of SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION to true. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5054\" onclick=\"get_ticket_and_populate_wrapper('5054'); return false;\" title=\"file transfer appears to not always encrypt files when requested\">#5054</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-27 22:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5f0e01ed3f536cb134e214b13682f4927c937c62\">[44896]</a></span>: Put job on hold when encryption fails <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5054\" onclick=\"get_ticket_and_populate_wrapper('5054'); return false;\" title=\"file transfer appears to not always encrypt files when requested\">#5054</a></span>  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jun-14 20:01", "status": "resolved", "created": "2015-May-13 16:21", "fixed_version": "2015-May-13 16:21", "broken_version": "v080200", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "zmiller", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "psbennett@wisc.edu, tannenba@cs.wisc.edu, rkleiman@wisc.edu", "due_date": ""}