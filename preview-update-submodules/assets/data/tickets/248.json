{"id": 248, "title": "Ticket #248: Job Hooks leave starter in wrong privstate", "description": "<blockquote>\n(This ticket was once <span class=\"drupalnode\"><a href=\"http://drupal-old.batlab.cs.wisc.edu/node/1628\">1628 (backup)</a> <a href=\"http://nmi.cs.wisc.edu/node/1628\">1628 (public)</a></span> and was copied over.  The original submitter was psilord.)\n\n<p>Submitted by psilord on Mon, 2008-08-11 13:42.\n\n</p><p>Reproduction:\n\n</p><p>Install condor 7.1.2 prerelease (as of 2008-9-10) as root, use the job hooks feature. After running the initial job hooks, one gets an error like this:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">8/8 09:03:57 in VanillaProc::StartJob()\n8/8 09:03:57 in OsProc::StartJob()\n8/8 09:03:57 IWD: /autohome/u100/rherban/condortest\n8/8 09:03:57 passwd_cache: setgroups( rherban ) failed.\n8/8 09:03:57 set_user_egid - ERROR: initgroups(rherban, 6751) failed, errno: Operation not permitted\n8/8 09:03:57 Input file: /autohome/u100/rherban/condortest/in.blast\n8/8 09:03:57 Failed to open '/autohome/u100/rherban/condortest/out.blast' as standard output: Permission denied (errno 13)\n8/8 09:03:57 Failed to open '/autohome/u100/rherban/condortest/err.blast' as standard error: Permission denied (errno 13)\n8/8 09:03:57 Failed to open some/all of the std files...\n8/8 09:03:57 Aborting OsProc::StartJob.\n8/8 09:03:57 Failed to start job, exiting\n</pre></div>\n\n\n<p>Expected behaviour:\n\n</p><p>The job should execute under the correct permissions. The above error does not happen in 7.1.0.\n\n</p><p>Additional notes:\n\n</p><p>See admin 18237 which was the rust user that found the problem.</p></blockquote>", "remarks": "<blockquote>\n<em>Submitted by rrati on Tue, 2008-08-12 10:18.</em>\n\n<p>Assigned to:\tAnonymous\t&gt;&gt; rrati\nStatus:\tactive\t&gt;&gt; patch (code needs review)\n\n</p><p>This should fix the issue, but the windows code changes in DaemonCore::Create_Process need to be closely reviewed since I'm not sure I handled it correctly.  The problem was that before condor was forking to create a process to run the hooks, it was doing checks on the executable/command as the priv mode specified.  For the conodr_final priv, it was changing to ruid condor instead of changing to euid condor for the checks so the starter ended up permanently as the condor user and thus wasn't able to access files not world readable.\n\n</p><p>(adesmet: this is attachment job-hooks-starter-condor-uid-fix.1.patch)\n\n</p><p></p><hr/>\n<em>Submitted by gquinn on Tue, 2008-08-12 13:59.</em>\n\n<p>Status:\tpatch (code needs review)\t&gt;&gt; patch (code needs work)\n\n</p><p>The change to <code>uids.C</code> and the UNIX path of <code>DaemonCore::Create_Process()</code> look good. On the Windows side, use of <code>CreateProcessAsUser</code> and the <code>CREATE_NEW_CONSOLE</code> flag are specific to launching stuff as the user and don't apply to <code>PRIV_CONDOR_FINAL</code>. So you can simply remove all changes to the Window-specific path of <code>DaemonCore::Create_Process()</code> from the diff.\n\n</p><p></p><hr/>\n<em>Submitted by gquinn on Tue, 2008-08-12 14:07.</em>\n\n<p>When I reviewed the original patch for <code>CONDOR_PRIV_FINAL</code>, I suggested running the test suite against a root-running Condor install. I guess that didn't catch this bug because there are no job hook tests :( I'm guessing that additionally Rob does his job hook development / testing using a personal Condor, otherwise he probably would have seen this right away. Before committing this patch, I suggest at least some quick testing of job hooks running under a root Condor.\n\n</p><p></p><hr/>\n<em>Submitted by rrati on Tue, 2008-08-12 15:18.</em>\n\n<p>Status:\tpatch (code needs work)\t&gt;&gt; patch (code needs review)\n\n</p><p>Here's the updated patch with the windows code removed.\n\n</p><p>When I originally tested the change to the PRIV_CONDOR_FINAL, I didn't use a job that wrote/used any files that didn't have world readable permissions.  I did run the test on a personal Condor as well as a root Condor, and I ran the list_quick test suite with batch_test.pl as well.  Obviously a complication job would've been a good idea when running this test, and it would've shown this issue.\n\n</p><p>TO test this fix, I ran with a root Condor using the following job:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">Cmd = \"/bin/date\"\nOut = \"/home/rsquared/date.output\"\nErr = \"/home/rsquared/date.err\"\nIwd = \"/home/rsquared\"\nOwner = \"rsquared\"\n</pre></div>\n\n\n<p>This job caused failures in the starter when trying to access the output files before the fix, but did not after the fix.\n\n</p><p>(adesmet: this is attachment job-hooks-starter-condor-uid-fix.2.patch)\n\n</p><p></p><hr/>\n<em>Submitted by gquinn on Tue, 2008-08-12 15:59.</em>\n\n<p>Status:\tpatch (code needs review)\t&gt;&gt; patch (ready to commit)\n\n</p><p>Patch looks ready for 7.1.2. Thanks for the additional testing.\n\n</p><p></p><hr/>\n<em>Submitted by psilord on Tue, 2008-08-12 16:20.</em>\n\n<p>Robert, are you able to put this patch into V7_1_2-branch, or do you need someone else to do it?\n\n</p><p></p><hr/>\n<em>Submitted by rrati on Tue, 2008-08-12 16:56.</em>\n\n<p>Matt pushed the commits a little while ago.\n\n</p><p></p><hr/>\nSubmitted by gquinn on Wed, 2009-01-14 11:32.\n\n<p>Status:\tpatch (ready to commit)\t&gt;&gt; fixed\n\n</p><p>The above comment seems to indicate this is fixed, so I'm marking it as such.\n\n</p><p></p><hr/>\nadesmet: The above comments were all copied over from <span class=\"drupalnode\"><a href=\"http://drupal-old.batlab.cs.wisc.edu/node/1628\">1628 (backup)</a> <a href=\"http://nmi.cs.wisc.edu/node/1628\">1628 (public)</a></span>\n\n<p></p><hr/>\n<em>2009-Feb-25 15:23:29 by adesmet:</em> <br/>\n\nIt looks like the first patch, the one rejected by gquinn, was pushed to V7_1_2-branch in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89b7ed194a2e1416c4fd1a3b62cc847046561e25\">[12499]</a></span> /89b7ed194a2e1416c4fd1a3b62cc847046561e25.  It was never merged to any other branches.  So it was in the 7.1.2 release, but nothing else.  Even if it had been merged, it's the wrong patch.  support 7788 has observed the same bug.\n\n<p></p><hr/>\n<em>2009-Feb-27 18:58:49 by adesmet:</em> <br/>\n\nFixed in 7.2 in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ab2ec4137ae9d7389ec97dcadc114d35dc43d913\">[14048]</a></span>.  Fixed in master in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a0e82301155e706b3ab73a7931b3bdea209d7cdf\">[14050]</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/28/job-hooks-starter-condor-uid-fix.1.patch\">job-hooks-starter-condor-uid-fix.1.patch</a>\n3233 bytes added by adesmet on 2009-Feb-25 21:12:37 UTC.\n<br/>\nSubmitted by rrati on Tue, 2008-08-12 10:18. <br/>\n</li><li><a href=\"../files/29/job-hooks-starter-condor-uid-fix.2.patch\">job-hooks-starter-condor-uid-fix.2.patch</a>\n1469 bytes added by adesmet on 2009-Feb-25 21:12:52 UTC.\n<br/>\nSubmitted by rrati on Tue, 2008-08-12 15:18. <br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "", "type": "defect", "last_change": "2009-Dec-17 17:33", "status": "resolved", "created": "2009-Feb-25 14:53", "fixed_version": "2009-Feb-25 14:53", "broken_version": "v070102", "priority": "2", "subsystem": "", "assigned_to": "adesmet", "derived_from": "", "creator": "adesmet", "rust": "s7788", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}