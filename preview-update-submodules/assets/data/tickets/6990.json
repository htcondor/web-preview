{"id": 6990, "title": "Ticket #6990: Introduce \"secure\" random numbers", "description": "<blockquote>\nWhile tinkering with a separate branch, I had the need to create a random request ID that is difficult for an attacker to guess.\n\n<p>Looking at the HTCondor random number generator (e.g., <code>get_random_int</code> inside <code>src/condor_utils/get_random_num.cpp</code>), we currently use lrand48.  This is a fine generator for doing things like generating random sleep intervals as it has a known distribution across its range.\n\n</p><p>However, <code>lrand48</code> is not a cryptographically secure RNG: that is, from a small sequence of output values, it's possible to reverse-engineer the state of the generator -- and hence possible to guess the next values in the sequence.  So, for example, it should not be used to generate credentials, shared secrets, etc: if an attacker can get HTCondor to generate a sufficient number of secrets, they can guess the next secret sent to a user.\n\n</p><p>I propose we separate out the two use cases: rename the existing <code>get_random_int</code> to <code>get_random_int_insecure</code> and introduce a <code>get_random_int_prng</code> that is appropriate for credential or secrets generation.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-May-02 20:57:53 by bbockelm:</em> <br/>\n\nOk, we are a GO for a hard requirement on OpenSSL.  Branch merged.  Look out for build breakage.\n\n<p>No user-visible changes; shouldn't need documentation.\n\n</p><p></p><hr/>\n<em>2019-May-03 10:51:15 by jfrey:</em> <br/>\n\nThese changes break the builds and introduce some non-trivial problems. The primary one is adding a dependency on OpenSSL to the remote syscall library. I've reverted the merge into master and fixed up the branch so that it can be merged again once everything is fixed.\n\n<p>The branch should not be merged again until a full run through NMI succeeds.\n\n</p><p></p><hr/>\n<em>2019-May-29 07:50:02 by tim:</em> <br/>\n\nJust because there are no user visible changes does not mean no version history. I think that it might be important to mention that we switched to cryptographically secure random number where needed.\n\n<p></p><hr/>\n<em>2019-May-29 08:33:37 by bbockelm:</em> <br/>\n\nSure, will update.\n\n<p></p><hr/>\n<em>2019-May-29 08:42:55 by bbockelm:</em> <br/>\n\nAh - another reason to add the release note: HTCondor no longer builds without OpenSSL.  While this won't affect the users of the binary artifacts (e.g., all RPMs already depended on OpenSSL), there might be some source code users lurking out there who would want to take notice.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-29 08:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3216eb25a476eae3d85c4b2e52c72a9192e7ec6e\">[56983]</a></span>: Add a simple explanation for the CSRNG change. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-07 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/141c814fd655e08afa7c9ebd679a5759241fc4e9\">[56774]</a></span>: Remove OpenSSL dependency from libcondorapi in build scripts. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-06 13:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4fac1e2d9978b8c0e52580573ce301d82b2497d4\">[56758]</a></span>: Update libcondorapi dependencies. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span> libcondorapi now depends on OpenSSL. This can be undone by changing the insecure random number functions back to using lrand48() and friends.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-06 10:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a568a7967e9d245878d4070c66e67efb7c90e363\">[56757]</a></span>: Move randomizing functions out of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span> This avoids adding a dependency on OpenSSL for the remote syscall library. For now leave out randomlyGeneratePRNG(), which is identical to randomlyGenerateInsecure().  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-06 10:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0ada108f81c3b390e9efb2f22e8a507460db1c05\">[56756]</a></span>: Fix return types of random number functions. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span> The int-based functions should return signed non-negative values. The uint-based functions should return unsigned values.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-06 06:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bdc7f957dd5b0177f9ebacc524f75215279c49ec\">[56772]</a></span>: Revert back to insecure implementation. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span> While we're OK with making OpenSSL a hard build dependency, there is a use of the random number generator in libcondorapi (surprise!).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-29 20:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/21a0a25f1103b1008455d70b627c9d30ee577303\">[56718]</a></span>: Overhaul the API and implementation of random numbers. Pull out the various unneeded APIs and rename them to reflect that the new ones are CSRNG and not \"just\" PRNGs. Implement the insecure variants using the CSRNGs; we can always revisit this and make them weaker if more speed is needed.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-11 12:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/483f3897164a3d588517452843619d34b7827399\">[56569]</a></span>: Remove our private implementation of Mersenne Twister. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span> Utilize the HTCondor-wide random number routines instead of copy/pasted local one to safe_sock; helps us consolidate the API, making things easier to review.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-11 12:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/892aeaa05b9dc56c01752ab647de6733e3e33baa\">[56568]</a></span>: Separate out random number use cases. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6990\" onclick=\"get_ticket_and_populate_wrapper('6990'); return false;\" title='Introduce \"secure\" random numbers'>#6990</a></span> The existing `get_random_num` does not use a cryptographically-secure RNG; that's fine for a large number of use cases (e.g., calculating random values for `sleep()`) but potentially dangerous in security settings that rely on the attackers' inability to guess\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-May-29 08:42", "status": "resolved", "created": "2019-Apr-11 12:11", "fixed_version": "2019-Apr-11 12:11", "broken_version": "", "priority": "3", "subsystem": "Libs", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}