{"id": 4375, "title": "Ticket #4375: VM universe should better handle failures to launch (guest VM)", "description": "<blockquote>\nIn a team meeting a while back, Miron made it clear that HTCondor itself should better handle the case in which a VM universe job fails to launch due to a broken hypervisor state. With KVM, at least, what happens now is that the failure-to-launch causes a Shadow Exception and the job goes on hold. It seems sensible to me that (a) HTCondor should better report the problem to the user, and perhaps to a log, and (b) the job should go back into the queue to be rerun. Put another way, it is not the user's fault that the job failed to launch, so HTCondor should take responsibility for it.\n\n<p>This ticket is related to other VM universe ones that are about monitoring the health of the underlying hypervisor, but it is not a duplicate.</p></blockquote>", "remarks": "<blockquote>\nToddT, TimC, and ToddM discussed this.  If I (and TimC) recall correctly, we agreed to the following as the immediate plan.\n\n<p></p><ol>\n<li>The VM universe will be improved to identify failures to launch.\n</li><li>On a failure to launch, the job will be rescheduled.\n</li><li>The startd will maintain one or more machine-ad attributes indicating which \"subsystem\" failed to launch.  (A subsystem might just be a job universe, to start.)  More detail needs to be determined here.  We suggested at least a single attribute listing all failed subsystems; subsystems would be removed from this list if and only if a job succeeded to launch (subject to administrative action).  We could potentially add additional attributes (e.g., HasWorkingVM), to simplify writing requirements expressions; or additonal information (e.g., WhyIsTheVMBroken), for the convenience of the administrator.\n</li><li>Bonus features: add a flag (like -vm or -java) to condor_status to filter by <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BrokenSubsystem\" title=\"Broken Subsystem\">BrokenSubsystem</a></span> and display it.\n</li></ol>\n\n<p>This proposal may obviate the need for <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=4524\" onclick=\"get_ticket_and_populate_wrapper('4524'); return false;\" title=\"Put startds on hold for failures to launch.\">#4524</a></span>.\n\n</p><p>We agreed that follow-up work should include <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=4542\" onclick=\"get_ticket_and_populate_wrapper('4542'); return false;\" title=\"Maintain [Last]EvictReason in job ad.\">#4542</a></span> (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EvictReason\" title=\"Evict Reason\">EvictReason</a></span>).  Additional follow-up work may include setting the default requirements and/or start expressions to use these attributes.  Additional follow-up work will include detecting failures to launch in other job universe (<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=4543\" onclick=\"get_ticket_and_populate_wrapper('4543'); return false;\" title=\"FTL in other universes.\">#4543</a></span>).\n\n</p><p></p><hr/>\n<em>2014-Sep-04 13:54:23 by tlmiller:</em> <br/>\n\n<strong>Issues for Review</strong>\n\n<p></p><ul>\n<li>Is there a less-dramatic way to all of the following?\n<ol>\n<li>Force the job to be rescheduled.\n</li><li>Write a message to the log (set by the user in the submit file).\n</li><li>(Required, but only for future work.)  Force an update to the job ad (in the schedd).  [#4542]\nWould it make more sense to add a new event type?\n</li></ol>\n\n<p></p></li><li>Is adding a new CA_* command OK?  ToddT thinks job updates should go through the starter's pipe to the startd, but that only seems to apply if we happen to know that the JIC is an instance of JICShadow.  I would also need to know more about the semantics and persistence of those updates.\n\n<p></p></li><li>The idea of having a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastBrokenReason\" title=\"Last Broken Reason\">LastBrokenReason</a></span> was stolen from other attributes like <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HoldReason\" title=\"Hold Reason\">HoldReason</a></span>.  However, the analogy is flawed in two major ways: primus, a broken universe may be \"fixed\" by running some other job (that is, without any specific human intervention); secondus, as a consequence, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BrokenReason\" title=\"Broken Reason\">BrokenReason</a></span> may change without the machine leaving the broken state.  Does this suggest we should reconsider allowing the machine to run jobs while broken?\n\n<p></p></li><li>See <a class=\"external\" href=\"https://docs.google.com/a/wisc.edu/document/d/1BJ8_xh1ywGKu_xFZBkNOqQruugfyOhwERi01RmMWqRQ\">https://docs.google.com/a/wisc.edu/document/d/1BJ8_xh1ywGKu_xFZBkNOqQruugfyOhwERi01RmMWqRQ</a> for a brain-dump on attribute naming.\n\n<p></p></li><li>What can we do, in the message from the first point, to help the administrator locate the corresponding, and hopefully more-helpful, messages in the VM GAHP and/or starter log(s)?\n\n<p></p></li><li>Is condor_update_machine_ad the appropriate approach for a command-line tool for telling HTCondor to try running VM universe jobs (or whatever) again?  If we can use the pipe from the starter, do we need to keep the current mechanism for the admin anyway?\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Sep-04 14:11:02 by tlmiller:</em> <br/>\n\nA brief overview of the current implementation:\n\n<p>As our concern is with failures to launch VM jobs, we begin in VMProc::StartJob().  We inspect the return and error codes from the call to the VM GAHP.  For those which are not determined to be the user's fault, we call jic-&gt;notifyStarterError() to propagate a status message back to the user, and in such a way that doing so causes the job to be rescheduled.  We then notify the startd that the VM universe is broken.\n\n</p><p>The mechanism for doing so is a new daemon core command.  It's another in the CA_AUTH_* series, chosen because that series of commands already handles <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> transport, and I thought it would be wise not to attempt to enumerate all possible failure cases and/or attribute schemas.  The mechanics of the implementation therefore required fewer than fifty lines of code, comments included.  The business logic is quite a bit larger.  By using a new daemon core command, we also expose this interface to the administrator is a natural way.\n\n</p><p>That logic takes care of updating the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> list of universes known to be broken and rolling/updating the Reason variables.  Doing these operations in the startd (a) ensures consistency and (b) obviates the need for a round-trip so the starter can acquire the information it requires to merge the ads itself.\n\n</p><p>I added a -broken flag to condor_status which is generally uninteresting.  It presently doesn't print the reason(s) for the broken universe(s), because doing that right would really require either regex projections or a second round-trip.\n\n</p><p></p><hr/>\n<em>2014-Sep-09 21:02:30 by tlmiller:</em> <br/>\n\nDiscussed the current implementaton briefly with TJ.  I will investigate extending the ulog pseudo-op, if necessary with a new event (rescheduled) to write a message to the log and force a job-ad update to the schedd.  This may be less incorrect than dying with a shadow exception, which causes some unnecessary log-spam.  (Additonal code may be necessary; I'm not sure what the starter code does after you return false from StartJob().)  He also seemed to think that adding a CA_AUTH_* command was a reasonable way to handle updating the machine (rather than job) ads.\n\n<p>I wrote a design document after our discussion:\n<a class=\"external\" href=\"https://docs.google.com/a/wisc.edu/document/d/1RVXLXzHI73YuQfvmGyidLFzs1jTaGcIzPrPo6_x7fs0/edit\">https://docs.google.com/a/wisc.edu/document/d/1RVXLXzHI73YuQfvmGyidLFzs1jTaGcIzPrPo6_x7fs0/edit</a>\n\n</p><p></p><hr/>\n<em>2014-Sep-17 14:47:29 by tlmiller:</em> <br/>\n\nThe design doc is a little light on implementation specifics, but I think it captures the points that have come up in discussion, and if the abstract design is good, I don't think we're talking about anything complicated anyway.\n\n<p></p><hr/>\n<em>2014-Sep-17 14:48:40 by tlmiller:</em> <br/>\n\nUpdated existing code to reflect updated design doc, except with respect to the proposed alternative for the rescheduling mechanism.  Additionally, the 'U?' errors should probably be treated as 'U' errors and tickets generated appropriately.  The errors should also be documented to the greatest extent reasonable, especially the 'U' errors.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4853\" onclick=\"get_ticket_and_populate_wrapper('4853'); return false;\" title=\"Fix condor_status -absent\">#4853</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFix condor_status -absent</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-23 11:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0df6e0df005fba2bc9cefa62ecfd6dba9f8a8853\">[42028]</a></span>: Additional files in unified RPM for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4569\" onclick=\"get_ticket_and_populate_wrapper('4569'); return false;\" title=\"Debugging tools for JobRouter.\">#4569</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-22 17:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/015f6e6678bd29287f423f5e702636181a2c5fa3\">[42015]</a></span>: edit new doc for condor_uptate_machine_ad tool <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 16:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55c251d437bdf1bef9f015cf3caa6ec024f0b4e1\">[41992]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) <strong>couhg</strong> Add the man page. <strong>cough</strong>  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-18 13:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7f7da5d609767ce62ada2df7aaddfc0cabb15446\">[41962]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) Document VM universe's handling of failures to launch.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-31 10:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/59b833786696eb4e7d975cb6bdafef0cdbc49f0c\">[41536]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) Correct build failures.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-13 16:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9524bd48f9ff55f9d49ab3fae18328d8fff448a6\">[41390]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) Put VMU jobs that failed to launch on hold if it might be the user's fault. Rewrite how we reschedule FTL jobs to minimize log spew. (The vanilla universe spews about shadow suicide, so we do as well.)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-17 15:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/01bf2870759f6c6ccc3fb151aa9b2904b53678bf\">[41177]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) Update the code to match the lastest proposal's attribute names.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-04 11:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6be7975cee095ee1ca18c4501da6118f2747ed3f\">[41100]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) Add condor_update_machine_ad, for use by administrators who have fixed a problem identified by the starter.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-04 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/10daa19e2ddfb2d5fef841116be70d8abedb2aed\">[41099]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) VM universe jobs that fail to launch for a reason not related to the job no longer put the job on hold; instead, it's rescheduled, and the starter tells the startd that the VM universe is broken.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-04 11:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d8cb4bb2e09fcba5a562cf22d1210c23db8ab2e\">[41098]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4375\" onclick=\"get_ticket_and_populate_wrapper('4375'); return false;\" title=\"VM universe should better handle failures to launch (guest VM)\">#4375</a></span>) Fix a misreported error in the VM GAHP.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Dec-18 13:53", "status": "resolved", "created": "2014-May-22 16:22", "fixed_version": "2014-May-22 16:22", "broken_version": "v080100", "priority": "3", "subsystem": "VM", "assigned_to": "tlmiller", "derived_from": "", "creator": "cat", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "cat@cs.wisc.edu, tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}