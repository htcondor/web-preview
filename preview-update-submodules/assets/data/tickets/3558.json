{"id": 3558, "title": "Ticket #3558: FD leak in blahp", "description": "<blockquote>\nIt appears the blahp has (or had - this is on the BOSCO released version of blahp, I think) a file descriptor leak.  From the end of \"lsof\":\n\n<p></p><div class=\"verbatim\">\n<pre>batch_gah 16302 sfiligoi 3525w  unknown                          /home/sfiligoi/bosco/sandbox/abe0/abe0a3d3/cabinet-10-10-6.t2.ucsd.edu_9618_cabinet-10-10-6.t2.ucsd.edu#5026.0#1364477546/x509_Gordon2@v1_0@GordonGF@fnalfesrv156.minus,v2.dot,main_0_959056.proxy (deleted) (stat: No such file or directory)\nbatch_gah 16302 sfiligoi 3527w  unknown                          /home/sfiligoi/bosco/sandbox/b2a4/b2a47ab9/cabinet-10-10-6.t2.ucsd.edu_9618_cabinet-10-10-6.t2.ucsd.edu#4910.0#1364475885/x509_Gordon2@v1_0@GordonGF@fnalfesrv156.minus,v2.dot,main_0_959056.proxy (deleted) (stat: No such file or directory)\nbatch_gah 16302 sfiligoi 3530w  unknown                          /home/sfiligoi/bosco/sandbox/c553/c553d7bb/cabinet-10-10-6.t2.ucsd.edu_9618_cabinet-10-10-6.t2.ucsd.edu#4771.0#1364472962/x509_Gordon2@v1_0@GordonGF@fnalfesrv156.minus,v2.dot,main_0_959056.proxy (deleted) (stat: No such file or directory)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Apr-01 12:05:25 by jfrey:</em> <br/>\n\nI did some initial code inspection and didn't see any obvious ways to leak a file descriptor to the job's proxy. I ran some tests on the proxy handling functions we add with proxy-tools.patch and didn't see any leaks on successful execution or any error conditions.\n\n<p></p><hr/>\n<em>2013-Apr-01 20:16:08 by bbockelm:</em> <br/>\n\nWhat version did you use?  If it's 7.9.4/5, maybe the bug got fixed by upstream?\n\n<p>What about proxy renewal?\n\n</p><p></p><hr/>\n<em>2013-Apr-02 09:42:04 by jfrey:</em> <br/>\n\nUpstream hasn't changed recently for BOSCO or UW-Madison releases.\n\n<p></p><hr/>\n<em>2013-Apr-23 09:52:30 by Francesco.Prelz:</em> <br/>\n\nAs\n\n<p>1. descriptors to open files are reference-counted in OpenSSL\n2. the default threading model in Globus is 'none' (mutex lock/unlock are NOPs)\n3. blahpd services various commands in pthreads (and these may be\n   operating on the same proxy file)\n\n</p><p>the 'activate_globus()' function that was patched into the blahpd should\nset the Globus threading model to 'pthread' (globus_thread_set_model(\"pthread\"))\nso that the reference counts in OpenSSL are protected by proper mutexes.\n\n</p><p></p><hr/>\n<em>2013-Apr-23 14:53:43 by jfrey:</em> <br/>\n\nThank you for the suggestion, Francesco! I'll add the call and see if that helps.\n\n<p></p><hr/>\n<em>2013-May-07 14:30:03 by jfrey:</em> <br/>\n\nI'm resolving this ticket, as Francesco's suggestion sounds very likely to fix the problem observed by Igor. If it doesn't, then we'll open a new ticket for additional investigation.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-07 14:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4fd5436cd878a6a711b056c73bf129f02ab400e9\">[35624]</a></span>: Version history for blahp FD leak. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3558\" onclick=\"get_ticket_and_populate_wrapper('3558'); return false;\" title=\"FD leak in blahp\">#3558</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-23 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/19a0c1cc652ae4efec39910d5393717433f24219\">[35519]</a></span>: Hopeful fix for FD leak in the blahp when handling proxies. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3558\" onclick=\"get_ticket_and_populate_wrapper('3558'); return false;\" title=\"FD leak in blahp\">#3558</a></span> Incorrect threading model in Globus can lead to fouling up OpenSSL's reference counting of open files when reading credentials.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-May-07 14:30", "status": "resolved", "created": "2013-Mar-31 13:48", "fixed_version": "2013-Mar-31 13:48", "broken_version": "v070902", "priority": "4", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}