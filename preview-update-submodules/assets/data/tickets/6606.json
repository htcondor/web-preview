{"id": 6606, "title": "Ticket #6606: Don't overwrite OMP_NUM_THREADS env variable if user has set it", "description": "<blockquote>\nCondor sets OMP_NUM_THREADS isn't primarily to ensure that cpu usage doesn't exceed the requested usage -- the cgroup cpu shares option we set enforces that.  And, there's nothing condor can do to prevent a job from changing this environment variable after condor has spawned the job.   However, we see a large number of applications linked with open mp, often, in the case of 3rd party code, without the user knowing open mp is under the hood.  The default for openmp is to spawn as many threads as cores detected, and this, combined with the cpu limiting, causes massive code slowdowns.  The machine wasn't overloaded, and neighboring jobs on the same machine weren't effected, but when there are 32 threads competing for one core, we could see orders of magnitude performance impacts.\n\n<p>But, if the user explicitly sets OMP_NUM_THREADS in their job ad, we should honor that, and trust that they know best.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-19 09:13:03 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> looks good. one concern, what if they set to empty ?  is that even possible?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-21 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e624a719e27fdc947c071f0357858c2b1c5e201e\">[54545]</a></span>: Documnet <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6606\" onclick=\"get_ticket_and_populate_wrapper('6606'); return false;\" title=\"Don't overwrite OMP_NUM_THREADS env variable if user has set it\">#6606</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-15 11:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/669e6702fb84839dd2aa98a6b27a43c99c4e3577\">[54517]</a></span>: Don't set OMP_NUM_THREADS if the user has already set it <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6606\" onclick=\"get_ticket_and_populate_wrapper('6606'); return false;\" title=\"Don't overwrite OMP_NUM_THREADS env variable if user has set it\">#6606</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Oct-01 16:53", "status": "resolved", "created": "2018-Mar-15 11:04", "fixed_version": "2018-Mar-15 11:04", "broken_version": "v080600", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "#4884", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "peter.couvares@ligo.org, josh.willis@ligo.org, alex.nitz@ligo.org, collin.capano@ligo.org,pcouvare@caltech.edu", "due_date": ""}