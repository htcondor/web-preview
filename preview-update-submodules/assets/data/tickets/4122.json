{"id": 4122, "title": "Ticket #4122: Detect broken TCP connections faster than 2 hours", "description": "<blockquote>\nRAL reported the schedd would fail jobs after a transient network issue.  It seems that the shadow is quite brittle in handling this right now!\n\n<p>Below is a diagnosis of the incident, based on the D_ALL logs.\nLuckily, there are two fairly simple ways to fix this:\n</p><ol>\n<li>Have the schedd inform the shadow when the job lease is updated.  This is fairly simple (make <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobLeaseDuration\" title=\"Job Lease Duration\">JobLeaseDuration</a></span> a dirty attribute), but there may be scalability issues to think about.  It may be better to introduce a new command between the schedd and shadow specific to lease updates.\n</li><li>Set TCP keepalive on the shadow socket to be on the order of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobLeaseDuration\" title=\"Job Lease Duration\">JobLeaseDuration</a></span> / 2.\n</li></ol>\n\n<p>In this ticket, we have opted to pursue option 2.\n\n</p><p></p><div class=\"verbatim\">\n<pre>\nInfo/logs on RAL incident:\n\n1) The starter and shadow are disconnected on the network.\n2) The starter continues to send periodic classad updates to the shadow, but these fail.  The shadow does not notice the TCP socket is dead.\n3) In the meantime, the startd sends keepalive packets to the schedd (except for the period where the disconnect occurred).  This causes the schedd to keep the claim alive.\n - NOTE!  The schedd does not inform the shadow it has an updated JobLeaseDuration.\n4) After slightly more then 2 hours, the default TCP socket keepalive policy causes the shadow to notice its socket is dead.\n - Because the schedd does not inform the shadow that it has received the keepalive from the startd, the shadow doesn't realize the job lease is still valid.\n5) Because it thinks the lease is expired, the shadow exits with code 107 (JOB_NOT_CKPTED).  The schedd restarts the job.\n\nSo it seems that HTCondor can't survive this particular temporary network disconnect between schedd and worker nodes!  This behavior has existed since at least 7.5.6.\n\nTo replicate this, you must have one of the two:\n(a) The starter and the shadow disagree on the state of the TCP socket.\n - This can happen if the starter tried to write into the socket while the network was out (causing the starter to realize the network is dead but not the shadow).\n - As it requires two nodes to duplicate, it's going to be a pain to write a test case. :)\n(b) Any network issue after the job has run for more JobLeaseDuration.\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Dec-20 08:12:55 by bbockelm:</em> <br/>\n\nFurther investigation shows that the starter job updates reset the job lease within the shadow.\n\n<p>Hence, fixing this boils down to promptly detecting broken TCP connections (if the connection is functioning, then the starter updates will take care of the rest).\n\n</p><p>The current proposal is to tune TCP keepalive from within HTCondor, defaulting it to the same interval (5 minutes) as the starter update interval.  This way, by default, TCP keepalive will only generate activity if there's something wrong with the starter.\n\n</p><p>This ticket prompted the review of a few other networking timeouts.  In particular, the CCB heartbeat interval (once every 20 minutes, reconnecting only after 60 minutes of no heartbeats) is too long compared to the default job lease duration.\n\n</p><p></p><hr/>\n<em>2014-Jan-07 15:12:00 by tannenba:</em> <br/>\n\nAdded code to consolidate keep-alive logic into one place, to set TCP_USER_TIMEOUT if available (so that dead sockets get closed even if we keep writing to them, like we do with the started in the incident explained in this ticket), and to support Windows.\n\n<p></p><hr/>\n<em>2014-Jan-07 16:12:51 by bbockelm:</em> <br/>\n\n<strong>CODE REVIEW</strong>:\n\n<p></p><ul>\n<li>The last patch uses a C-style cast instead of a C++ one.  It's a good habit to switch to a C++ one.\n</li><li>The error message for the TCP_USER_TIMEOUT is a copy/paste of a prior error message and doesn't actually talk about TCP_USER_TIMEOUT.\n</li></ul>\n\n<p>Please fix at least the latter.  Other than that, LGTM.\n\n</p><p></p><hr/>\n<em>2014-Jan-08 16:13:20 by tannenba:</em> <br/>\n\nThanks for code review.  Issues identified in code review are now fixed in two most recent patches.  Resolving.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4157\" onclick=\"get_ticket_and_populate_wrapper('4157'); return false;\" title=\"Daemons on Mac OS X busy-loop accepting bogus connections\">#4157</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDaemons on Mac OS X busy-loop accepting bogus connections</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-22 16:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d76b4e58c89be3ad3521dde7d1bcb7e5216d500e\">[39213]</a></span>: edit documentation for new TCP_KEEPALIVE_INTERVAL knob <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-09 11:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d8b8f03184b7de702f7a51c733fd532c9c50918a\">[39127]</a></span>: Fix build issue on Windows with types to setsockopt(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-08 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a6190a0d45548bfd723f5e2ad595155ba1154b3a\">[39124]</a></span>: Fix error message text for TCP_USER_TIMEOUT. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-08 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d95ba4ce7a4cbe4fe7b3a26b7eb0b17979433487\">[39125]</a></span>: Replace some C-style casts with C++ style casts for setsockopt. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-07 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/99a8a555750d83445cbaa773177b63eb75c73aa5\">[39121]</a></span>: Set TCP_USER_TIMEOUT to help close dead tcp sockets. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span> Use TCP_USER_TIMEOUT, which is amount of time before an ack must be received for sent data, to make sure the connection fails in a reasonable amount of time even if there is traffic on it.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-07 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/87594da39faddab5323e34673044bb64494e3316\">[39120]</a></span>: Add support for TCP_KEEPALIVE_INTERVAL on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-07 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37cdb12fc5b6a840576f79914188f2e270514fcc\">[39119]</a></span>: Added Windows function GetLastErrorString() in util lib. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span> Finally a util lib function for Win32 to get an error string returned in a static buffer (like strerror) so it is easy to use in dprintf messages. Note this is for Win32/Winsock errors, not C library errnos - for C library errno calls, use\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-07 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f099234d4dce6f19a91cbdd8c8ab5d9c1af83ad9\">[39118]</a></span>: Consolidate all socket keepalive handling in CEDAR in one place. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-20 11:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/acbce02a18e5cabd9cf533c14cd1e872a362e3dd\">[39081]</a></span>: Fix unexpected build failures on Mac and Solaris. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-20 10:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05cb130f4fc2f8ca636b64c1723f2705c7357f2d\">[39080]</a></span>: Documentation and version history for TCP_KEEPALIVE_INTERVAL. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-20 10:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5e9bdb47cd2f5a9b721196b8d884a07651b2f380\">[39079]</a></span>: Have CEDAR manage the TCP_KEEPALIVE settings for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSocks\" title=\"Reli Socks\">ReliSocks</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4122\" onclick=\"get_ticket_and_populate_wrapper('4122'); return false;\" title=\"Detect broken TCP connections faster than 2 hours\">#4122</a></span> Keepalive is set to 6 minutes. 360 seconds was picked because it's slightly greater than the default UPDATE_INTERVALs for the starter and updating the collector via TCP, but still small enough that a dead TCP socket should be detected\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jan-08 16:18", "status": "resolved", "created": "2013-Dec-14 09:25", "fixed_version": "2013-Dec-14 09:25", "broken_version": "v070506", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}