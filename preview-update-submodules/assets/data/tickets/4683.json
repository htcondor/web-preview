{"id": 4683, "title": "Ticket #4683: condor_status -schedd returns incorrect number of jobs in a CE", "description": "<blockquote>\nWhen running `condor_status -schedd -pool` against a CE, it returns the wrong number of running/idle/held jobs (often displaying 0) even if there are jobs in the CE's queue. Example:\n\n<p></p><div class=\"verbatim\">\n<pre>$ condor_q -name red.unl.edu -pool red.unl.edu:9619\n...\n1537 jobs; 79 completed, 3 removed, 361 idle, 1089 running, 5 held, 0 suspended\n$ condor_ce_status -schedd -pool red.unl.edu:9619\nName                 Machine    TotalRunningJobs TotalIdleJobs TotalHeldJobs\n\nred.unl.edu          red.unl.ed                0             0              4\nsleeper@red.unl.edu  red.unl.ed                0             0              0\n                      TotalRunningJobs      TotalIdleJobs      TotalHeldJobs\n\n\n               Total                 0                  0                  4\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Oct-28 21:10:32 by bbockelm:</em> <br/>\n\nWe've previously discussed this with Jaime / ToddT --\n\n<p>The problem is that these totals only include jobs managed by the schedd.  Because the jobs are marked as managed by the job router, they are zeroed out in the status.\n\n</p><p>I'd rather these statistics take into account all jobs of the given status, regardless of where they are managed or universe.\n\n</p><p></p><hr/>\n<em>2014-Dec-18 19:30:49 by bbockelm:</em> <br/>\n\nAs more schedds advertise to the central OSG collector, more admins are asking about this issue.  Accordingly, I am bumping the priority.\n\n<p></p><hr/>\n<em>2015-Jan-12 10:34:17 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>Why have a new function for the stats that we want to count across all jobs? It'd be cleaner to leave them in count_a_job(), next to the update of scheduler.JobsTotalAds.\n\n<p></p></li><li>Scheduler/local universe jobs that are running and were just held/remove will now be counted in both JobsHeld/Removed and Scheduler/LocalUniverseJobsRunning. Is that going to confuse people?\n\n<p></p></li><li>Existing bug: Local universe jobs aren't counted in LocalUniverseJobsRunning/Idle if usesLocalStartd()==true.\n</li></ul>\n\n<p></p><hr/>\n<em>2015-Jan-12 21:11:58 by bbockelm:</em> <br/>\n\nOk - I was able to solve the first two issues.  I simply restored the old behavior of never including scheduler/local universe jobs in the held/removed job counts.\n\n<p>The third one looks tricky, especially as I can't figure out why local jobs w/ a startd are not marked as serviceable in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3129\" onclick=\"get_ticket_and_populate_wrapper('3129'); return false;\" title=\"Have schedd dynamically spawn local startd\">#3129</a></span>.  You might have to file a separate ticket and work with Greg on this.\n\n</p><p></p><hr/>\n<em>2015-Jan-13 10:13:46 by jfrey:</em> <br/>\n\nI think scheduler/local universe jobs should be included in the JobsHeld/Removed stats when they're not included in Sched/LocalUniverseJobsRunning stats. More specifically, if cur_hosts==0, then count it as held/removed.\n\n<p>Agreed on the third item. It's not something for this ticket.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-22 16:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fc43f25646ad912e1f54caf67b9822bec3971401\">[42332]</a></span>: Docs for change in total job counts in the scheduler ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4683\" onclick=\"get_ticket_and_populate_wrapper('4683'); return false;\" title=\"condor_status -schedd returns incorrect number of jobs in a CE\">#4683</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-22 11:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/631417128076e199f165000eed5550e06085bf35\">[42308]</a></span>: Include local and scheduler universe jobs in Held/Removed counts. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4683\" onclick=\"get_ticket_and_populate_wrapper('4683'); return false;\" title=\"condor_status -schedd returns incorrect number of jobs in a CE\">#4683</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-12 21:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38cdeafc020afcd3726d6fc08c710cdf121bd31e\">[42178]</a></span>: Address review comments. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4683\" onclick=\"get_ticket_and_populate_wrapper('4683'); return false;\" title=\"condor_status -schedd returns incorrect number of jobs in a CE\">#4683</a></span> In particular, - Fold count_a_job_global_stats back into count_a_job - Retain previous behavior of never including held / removed jobs in the counts for scheduler/local universe.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-29 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/23aa9cd197e34cc7f23de7f67e164f4c6e4861f5\">[42050]</a></span>: Keep schedd-wide count of running and idle jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4683\" onclick=\"get_ticket_and_populate_wrapper('4683'); return false;\" title=\"condor_status -schedd returns incorrect number of jobs in a CE\">#4683</a></span> As the schedd-wide count of running / idle jobs don't affect the matchmaking, keep these counts even for jobs which we don't service. The upshot is that \"condor_status -schedd\" will return believable numbers on the HTCondor-CE.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Feb-25 15:23", "status": "resolved", "created": "2014-Oct-28 14:46", "fixed_version": "2014-Oct-28 14:46", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "jfrey", "derived_from": "#4555", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu blin@cs.wisc.edu marian.zvada@cern.ch", "due_date": ""}