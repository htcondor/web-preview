{"id": 6096, "title": "Ticket #6096: Fix systemctl config to perform a fast shutdown when stopping", "description": "<blockquote>\nOn Linux systems using init, doing a <code>service condor stop</code> command is the equivalent of doing a <code>condor_off -master -fast</code>.  This is exactly what we want.\n\n<p>Unfortunately, currently on systems using systemd, doing a <code>systemctl stop condor</code> is the equivalent of sending SIGKILL to all the condor daemons.  This means the HTCondor daemons do not have a chance to do any clean-up, such as removing their classads from the central manager.  This has frustrated folks several times, <a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2017-October/msg00014.shtml\">as reported in htcondor-users</a>.\n\n</p><p>To get the desired behavior under systemd, we need to tell systemd to send a SIGQUIT signal to just the condor_master process when stopping the service.  Note that we cannot use the systemd <em>ExecStop</em> directive accomplish this, because <code>condor_off</code> is asynchronous and systemd assumes synchronous -- as soon as the <em>ExecStop</em> command returns, systemd immediately kills all daemons with SIGKILL.  So instead, we need to <strong>not</strong> specify <em>ExecStop</em> and instead use <em>KillMode</em> and <em>KillSignal</em> to instruct systemd to send SIGQUIT to the condor_master.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-10 13:50:29 by tannenba:</em> <br/>\n\nWorkaround options for folks running versions of HTCondor older than v8.6.7 on a systemd Linux:\n\n<p>Option 1: Copy the file <code>/usr/lib/systemd/system/condor.service</code> to <code>/etc/systemd/system/condor.service</code>, and then edit <code>/etc/systemd/system/condor.service</code> as shown in diff patch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/87ec6608cfa54c165ee9a99d9cf4402b774fec5c\">[52539]</a></span>.  Then as root run <code>systemctl daemon-reload</code> to re-read the systemd config change.\n\n</p><p>or\n\n</p><p>Option 2: Instead of doing <code>systemctl stop condor</code>, do <code>condor_off -master -fast</code>.\n\n</p><p></p><hr/>\n<em>2017-Oct-23 08:42:06 by tim:</em> <br/>\n\n<strong>Code Review:</strong> Good job. Thank you, Todd.\n\n<p></p><hr/>\n<em>2017-Oct-25 10:25:06 by tim:</em> <br/>\n\n<strong>Doc Review:</strong> OK</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-10 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c95734757e9f8be348d7d6f2287ee7560572037c\">[52541]</a></span>: Version history blurb for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6096\" onclick=\"get_ticket_and_populate_wrapper('6096'); return false;\" title=\"Fix systemctl config to perform a fast shutdown when stopping\">#6096</a></span>.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-10 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/87ec6608cfa54c165ee9a99d9cf4402b774fec5c\">[52539]</a></span>: Have systemd do a fast shutdown instead of sigkill when stopping. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6096\" onclick=\"get_ticket_and_populate_wrapper('6096'); return false;\" title=\"Fix systemctl config to perform a fast shutdown when stopping\">#6096</a></span> To get a fast shutdown when stopping the HTCondor service, we need to tell systemd to send a SIGQUIT signal to just the condor_master process when stopping the service. Note that we cannot use the systemd <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExecStop\" title=\"Exec Stop\">ExecStop</a></span> directive accomplish\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Oct-25 10:25", "status": "resolved", "created": "2017-Jan-19 16:07", "fixed_version": "2017-Jan-19 16:07", "broken_version": "v080400", "priority": "2", "subsystem": "Packaging", "assigned_to": "tannenba", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}