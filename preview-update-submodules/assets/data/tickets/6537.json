{"id": 6537, "title": "Ticket #6537: Simplify hashtable code", "description": "<blockquote>\nWe have six or seven different implementations of the same hash function for strings, plus one bad hash function. We should consolidate these.\n\n<p>We also have the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashKey\" title=\"Hash Key\">HashKey</a></span> class, which is completely unnecessary. It just adds complexity and string copying. We should get rid of it.\n\n</p><p>We should have one <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> constructor, which doesn't take table size as an argument (which is ignored anyway). If possible, we should get rid of the allowDuplicateKeys option.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Feb-15 10:31:47 by jfrey:</em> <br/>\n\nThere are no user-facing changes here, so no documentation required.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-13 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6265c98fde118823609ac307bfd7987a73e2142\">[54287]</a></span>: Fix double-delete in schedd's job queue table. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> In ClassAdLogTable::insert(), on failure we need to delete the new ad if we made one, but the caller will delete the ad it passed in.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-12 12:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d9f220a0c49230366a43e1cda8b7bb50bbde037\">[54278]</a></span>: The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> hash function now returns a size_t. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> This allows the hash functions to be used with std::unordered_map.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-12 12:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d3fafda25d2250d2b1c4791cd4bcbf14ced48afc\">[54277]</a></span>: Remove HashTable::getNext(), unnecessary without duplicate keys. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-08 10:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6605c17130c2b64e9457204d5ee5b589c543aae\">[54276]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> duplicate behavior is now given as an argument to insert(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> Our <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> now always rejects duplicates by default. A new optional argument to insert() can override this behavior in the few places we need values to be updated.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6099462ae9ee58c1b11c4a56a8a883fb57e9b139\">[54274]</a></span>: Fix <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> usage in passwd_cache. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> Fix a possible use-after-delete bug in passwd_cache::cache_groups(). Remove updateDuplicateKeys option in passwd_cache's <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTables\" title=\"Hash Tables\">HashTables</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5933585d59947f115d8e0119f0b105649de6b384\">[54275]</a></span>: Remove a couple unnecessary uses of HashTable's update duplicates mode. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fea68b97aa1518e5f5b73ed87a14fd66bca8f0e\">[54269]</a></span>: Replace <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> with allowDuplicateKeys in winreg startd code. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b8da53c86fcae190314dce7141d9e9db976ef2e7\">[54270]</a></span>: Remove allowDuplicateKeys behavior in our <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b3b3ef011caadd20668e97eb22e5585400650d00\">[54267]</a></span>: Reject ads with duplicate keys in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> Previously, the code would create two ads which could not both be accessed. Now, creation of the second ad fails but leaves the first ad unaffected.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3e5da2a0580f7cbbee729913b8b8330af6b4453b\">[54268]</a></span>: Reject duplicate request ids in the vm-gahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> Previously, duplicates were allowed but not handled properly.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-07 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cce8f50f711fb7f7be6e4906a52f6853a129907d\">[54266]</a></span>: Change <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> to std::set in condor_submit and condor_wait. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> These tools were using <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> as a convoluted set of strings.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-06 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/964c1caf11753c5f71d3459e6aace00cb9a48293\">[54265]</a></span>: Convert more <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTables\" title=\"Hash Tables\">HashTables</a></span> to not allow duplicate keys. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> These cases required no code changes beyond an ASSERT() or dprintf().  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-05 10:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/18a7789b6aaa0d7f74df1246f01fb39bc0174cd5\">[54264]</a></span>: Reject duplicates in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTables\" title=\"Hash Tables\">HashTables</a></span> where we don't expect them. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> For <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> objects where we don't expect duplicate keys, change the insert behavior from allow to reject. In these cases, the insert() call is already guarded by a lookup() call, or I've added an ASSERT() on insert() failing.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-05 09:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1a2229f0c241fd306dacefac63ecc7637c01e019\">[54263]</a></span>: Update <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> constructors in contrib modules. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-03 10:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cdf6b996b2cec1651a66d8bc91c79eb22fc1059d\">[54262]</a></span>: Merge <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> constructors. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> now has one constructor with no table size parameter and a default duplicate key behavior of reject.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-03 09:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/619a48536329aa893e78d75a236574f82c7f8dc3\">[54261]</a></span>: Fix config of one of the tests. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-03 09:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e23e8b9891ab7cf6f1b3cc2bc27f1c6d3a3ac05e\">[54260]</a></span>: Make allowDuplicateKeys mode explicit in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> The old, almost never correct, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> mode of allowDuplicateKeys must now be explicitly requested. It's no longer the default.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-02 15:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1b0979b42f521b4d4508d58e91169596351f70e8\">[54259]</a></span>: Remove alternate key type for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span> template. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> All operations on a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span> now use a single key type. The key type must be convertible to and from std::string and have a hashFunction() function for its type.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-26 09:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1926c34554a57acf4a2f975d81b56edc6db6521e\">[54258]</a></span>: Remove all usage of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashKey\" title=\"Hash Key\">HashKey</a></span> class. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> The remaining usage was tied to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 13:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c8ad86497fd6a346c01e33ca9e82aba9321665ca\">[54257]</a></span>: Remove most usage of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashKey\" title=\"Hash Key\">HashKey</a></span> class. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashKey\" title=\"Hash Key\">HashKey</a></span> class is unneeded and can add extra copying of strings. The key type for a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> can be a std::string or <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Jan-24 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2223825159b24b00670b06af90d520b07cc87a1e\">[54256]</a></span>: Unify string hash functions for Condor's <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> class. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6537\" onclick=\"get_ticket_and_populate_wrapper('6537'); return false;\" title=\"Simplify hashtable code\">#6537</a></span> Many different, near-identical, hash functions we had for string keys for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> are now consolidated into one (plus a case-insensitive variant).  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Feb-15 10:31", "status": "resolved", "created": "2018-Jan-22 10:34", "fixed_version": "2018-Jan-22 10:34", "broken_version": "", "priority": "4", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}