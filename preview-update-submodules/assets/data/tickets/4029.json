{"id": 4029, "title": "Ticket #4029: condor_sos - a tool for the admin to manage a swamped daemon", "description": "<blockquote>\nImagine a HTCondor daemon like the condor_schedd under such extreme load that client commands like condor_q timeout.  To fix the problem, the administrator would like to inspect what is going on, run a few condor_q commands to see what is happening, maybe run some condor_hold or condor_rm commands, etc.  But unfortunately, the administrator cannot get in a word edgewise to the swamped daemon, and therefore cannot really do anything intelligent to fix/diagnose the problem!\n\n<p>Proposed enhancement is for daemons to have an unadvertised \"super\" command port for use by the administrator; incoming commands to this port are serviced ahead of all other incoming commands. This way the administrator has a reasonable chance of not having their commands time out, even if the daemon is extremely busy.\n\n</p><p>For now, this super command port will not be advertised in any classads.  To create a super command port, place <code>&lt;SUBSYSTEM&gt;_SUPER_ADDRESS_FILE</code> in the config file to specify where to write a file with the super command port (just like the regular ADDRESS_FILE).  Administrators will then be able to use the <code>condor_sos</code> command line tool to access this special port, for instance \"condor_sos condor_q\" or \"condor_sos condor_hold abusiveUser\".  In addition, if the user running a client tool to talk to a local daemon happens to be root, then the super command port will also be used.  In other words, if root runs \"condor_q\" it is equivalent to running \"condor_sos condor_q\".</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Nov-01 16:33:59 by tannenba:</em> <br/>\n\nSome testing thoughts...\n\n<p></p><div class=\"code\">\n<pre class=\"code\">[tannenba@localhost]$ condor_q\n\n\n-- Submitter: localhost.localdomain : &lt;192.168.80.128:46927&gt; : localhost.localdomain\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n\n0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended\n\n[tannenba@localhost]$ condor_sos condor_q\n\n\n-- Submitter: localhost.localdomain : &lt;192.168.80.128:40211&gt; : localhost.localdomain\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n\n0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended\n[tannenba@localhost spool]$\n</pre></div>\n\n\n<p>Note in the above that condor_q reports the ip address and port it is using to talk to the local schedd.  We can use this to verify that a different port is used when running just \"condor_q\" along vs running \"condor_sos condor_q\".  In the above, note the first one is using port 46927, and the latter is port 40211.  Also, whenever a condor_sos command is picked up by a daemon, a dprintf D_ALWAYS message is logged:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">[tannenba@localhost]$ grep \"superuser command\" `condor_config_val schedd_log`\n11/01/13 15:35:17 (pid:12531) Received a superuser command\n</pre></div>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4075\" onclick=\"get_ticket_and_populate_wrapper('4075'); return false;\" title=\"condor_preen removes .schedd_address.super file\">#4075</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_preen removes .schedd_address.super file</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-17 12:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d9d4139bf609c67709c91fb4ce685788e083acf6\">[39030]</a></span>: first pass documentation for new condor_sos and higher priority command port for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> daemons. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4029\" onclick=\"get_ticket_and_populate_wrapper('4029'); return false;\" title=\"condor_sos - a tool for the admin to manage a swamped daemon\">#4029</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-04 10:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b4649f2214063f60513b14927fbaa0d1b53b4bfb\">[38087]</a></span>: delete super socks on exit instead of re-deleting the normal socks <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4029\" onclick=\"get_ticket_and_populate_wrapper('4029'); return false;\" title=\"condor_sos - a tool for the admin to manage a swamped daemon\">#4029</a></span> ===VersionHistory:None=== bug never shipped  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-01 15:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ee27ebe7e36964528f6cf4a7ce588649e5703ea\">[38084]</a></span>: Added tool condor_sos and a high priority port in daemoncore. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4029\" onclick=\"get_ticket_and_populate_wrapper('4029'); return false;\" title=\"condor_sos - a tool for the admin to manage a swamped daemon\">#4029</a></span> By default, the schedd and the collector will create a super port for use by condor_sos.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Dec-23 17:11", "status": "resolved", "created": "2013-Oct-31 18:54", "fixed_version": "2013-Oct-31 18:54", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}