{"id": 4923, "title": "Ticket #4923: Cannot restart the collector on Windows, or shutdown takes a long time", "description": "<blockquote>\nOn Windows, the master is unable to restart the collector (or any daemon using a well-known port).  Upon attempting to restart the collector, the <code>MasterLog</code> would contain errors like the following:\n\n<p></p><pre>  03/04/15 14:00:45 Collector port not defined, will use default: 9618\n  03/04/15 14:00:45 Sock::bind failed: WSAError = 10048\n  03/04/15 14:00:45 Failed to listen(9618) on TCP/IPv4 command socket. Does this computer have IPv4 support?\n  03/04/15 14:00:45 Warning: Failed to create IPv4 command socket.\n  03/04/15 14:00:45 ERROR: Create_Process failed trying to start C:\\condor\\bin\\condor_collector.exe\n</pre>\n\n<p>The problem is the master is unable to restart the collector because port 9618 is already in use because when the master started the collector the first time, DaemonCore::Create_Process() posted a listen on 9618 and marked that listen socket as inheritable.  It then starts a condor_procd if one is not already running (as of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2911\" onclick=\"get_ticket_and_populate_wrapper('2911'); return false;\" title=\"RFE: MASTER.USE_PROCD = TRUE\">#2911</a></span>).  The result is the condor_procd inherited the 9618 listen socket, and thus that socket will stay in use until the procd is killed.\n\n</p><p>Besides failing to restart the collector, this bug also manifested itself when sometimes doing a <code>net stop condor</code> or \"condor_master -master\" on Windows would take a really long time.  The reason was the master is waiting for all other daemons to exit, but if the collector shuts down first, other daemons may have to timeout waiting for the condor_procd to respond to collector commands sent to 9618.  By fixing this bug, these timeouts will no longer occur, since now as soon as the collector shuts down clients will receive a connection refused error immediately.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Apr-06 15:30:47 by johnkn:</em> <br/>\n\nCODE_REVIEW: change looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-07 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/979c53ced4c0e5c5cb6bd421fabfe537ba4e6381\">[43542]</a></span>: Version history entry for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4923\" onclick=\"get_ticket_and_populate_wrapper('4923'); return false;\" title=\"Cannot restart the collector on Windows, or shutdown takes a long time\">#4923</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-07 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d32a16f12e942c1d5a387704959c08a83da6d127\">[43541]</a></span>: Start procd BEFORE setting up socks to inherit in Create_Process. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4923\" onclick=\"get_ticket_and_populate_wrapper('4923'); return false;\" title=\"Cannot restart the collector on Windows, or shutdown takes a long time\">#4923</a></span> This change prevents sockets from being leaked to the procd. Before this change, for instance, the condor_master could not restart the collector because the listen socket on port 9618 was in use by the procd!  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Apr-06 15:30", "status": "resolved", "created": "2015-Mar-04 14:42", "fixed_version": "2015-Mar-04 14:42", "broken_version": "v070900", "priority": "2", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}