{"id": 5555, "title": "Ticket #5555: Broken LOWPORT/HIGHPORT on Windows.", "description": "<blockquote>\nIn Sock::bindWithin(), when we compute the (semi-random) offset into the port range, it's possible for there to be integer overflow, now that we're no longer taking the pseudorandom value mod 1000000.  If overflow occurs, the offset can be negative, and since the initial bind() on Windows (basically) always succeeds (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4711\" onclick=\"get_ticket_and_populate_wrapper('4711'); return false;\" title=\"Delayed bind() result causes slow client tools on Windows\">#4711</a></span>), we won't notice.\n\n<p>The obvious solution is to add the mod 1000000 back in, but the function could really use a rewrite to (a) do all of its math in unsigned shorts and (b) use one of the util lib's random number generators rather than trying to roll its own.  A PRNG would probably be better in terms of avoiding duplicate initial port numbers anyway, since we don't have to worry about sampling errors.\n\n</p><p>Ben Cotton's customer wants this fix before the end of April, when they'd like to go into production.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Mar-10 13:52:03 by johnkn:</em> <br/>\n\nthe fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5375\" onclick=\"get_ticket_and_populate_wrapper('5375'); return false;\" title=\"choice of random port in range is not very random on windows\">#5375</a></span> used a signed quantity for the random value, which would allow the the value to go below LOWPORT on windows. (linux uses a random value &lt; 1million, but windows random value is a full 32 bit int).\n\n<p></p><hr/>\n<em>2016-Mar-10 13:57:15 by tannenba:</em> <br/>\n\nCan someone explain why the code doesn't simply call <code>get_random_uint()</code> from the util lib instead of these bizarre platform dependent attempts to generate a random number?\n\n<p></p><hr/>\n<em>2016-Mar-22 15:10:47 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Approved.  Hopefully more-accurately than last time.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5572\" onclick=\"get_ticket_and_populate_wrapper('5572'); return false;\" title=\"Clean up port-randomization code.\">#5572</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nClean up port-randomization code.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-21 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38767a3d051dfd09c5760492d5f8709827db6ba5\">[48065]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5552\" onclick=\"get_ticket_and_populate_wrapper('5552'); return false;\" title=\"Propagate memory and disk usage in Condor-C and Job Router\">#5552</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5535\" onclick=\"get_ticket_and_populate_wrapper('5535'); return false;\" title=\"Partitionable slots can sometimes provision too little disk\">#5535</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5555\" onclick=\"get_ticket_and_populate_wrapper('5555'); return false;\" title=\"Broken LOWPORT/HIGHPORT on Windows.\">#5555</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5504\" onclick=\"get_ticket_and_populate_wrapper('5504'); return false;\" title=\"condor_off -peaceful does not contact all requested machines\">#5504</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-10 13:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2507fd92a4ecdb32a003a527c19bb79da007f601\">[47694]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5555\" onclick=\"get_ticket_and_populate_wrapper('5555'); return false;\" title=\"Broken LOWPORT/HIGHPORT on Windows.\">#5555</a></span>, a bug that could result in port values below LOWPORT being assigned on Windows. introduced by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5375\" onclick=\"get_ticket_and_populate_wrapper('5375'); return false;\" title=\"choice of random port in range is not very random on windows\">#5375</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Mar-22 15:10", "status": "resolved", "created": "2016-Mar-09 14:46", "fixed_version": "2016-Mar-09 14:46", "broken_version": "v080402", "priority": "2", "subsystem": "Libs", "assigned_to": "tlmiller", "derived_from": "#5375", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, johnkn@cs.wisc.edu, ben.cotton@cyclecomputing.com, tannenba@cs.wisc.edu", "due_date": "2016-04-30"}