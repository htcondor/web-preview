{"id": 7093, "title": "Ticket #7093: Refactor/merge Scheduler:: and ResMgr:: try_token_request()", "description": "<blockquote>\nIt's unclear where the common code belongs, but the <code>Scheduler::try_token_request()</code> and <code>ResMgre::try_token_request()</code> functions are very similar and should probably be merged to reduce future technical burden.\n\n<p>It seems like <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> might be a good place to put this function (although the decision about when to call it and with which arguments will have to remain daemon-specific).</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Jun-20 08:53:50 by bbockelm:</em> <br/>\n\nAdditional refactoring requested from <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7094\" onclick=\"get_ticket_and_populate_wrapper('7094'); return false;\" title=\"Auto-request tokens based on missing trust domains.\">#7094</a></span>:\n\n<p></p><ul>\n<li>Add a callback for failure so we can convert the detection of authorization failures to use non-blocking mechanisms.\n</li><li>Right now, an empty identity indicates to use the default.  We should add an explicit define so it is obvious in the future (as opposed to looking like a programmer oversight).\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Jun-20 09:29:18 by bbockelm:</em> <br/>\n\nAnother thing to investigate here --\n\n<p>Currently, <code>DC_FINISH_TOKEN_REQUEST</code> requires encryption as we're not going to send a token back in the clear!  Auto-approval mode, where we trust the network explicitly, doesn't use this RPC.\n\n</p><p>However, if we use DaemonCore's \"force authentication\" feature, it refuses to the RPC for users that are authenticated-but-unmapped.  It seems we want a slight twist on this -- force authentication but do not require the user to be mapped.\n\n</p><p></p><hr/>\n<em>2019-Jul-14 20:36:43 by bbockelm:</em> <br/>\n\nOk, with 3 days left to go before the code freeze...\n\n<p>Here's the PR for the refactor:\n\n</p><p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/63\">https://github.com/htcondor/htcondor/pull/63</a>\n\n</p><p>It not only gives the startd and schedd a common implementation of the token request workflow (improvement: both now support collector lists correctly!) but also switches everything to non-blocking.\n\n</p><p>The nonblocking piece is useful in itself, but it also solves some memory management issues (as the <code>SecMan</code> which invokes the callback knows the socket is still valid).\n\n</p><p></p><hr/>\n<em>2019-Jul-15 16:34:09 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Added two-subtickets for future work.  Otherwise, OK.\n\n</p><p></p><hr/>\n<em>2019-Jul-15 16:48:37 by tlmiller:</em> <br/>\n\nOn second thought, this is all internal code-cleanup and should have no user-visible effects.  Brian, if you agree, please just go ahead and mark the ticket resolved.\n\n<p></p><hr/>\n<em>2019-Jul-15 16:50:33 by bbockelm:</em> <br/>\n\nYup, agreed!\n\n<p>Thanks for the \"review under pressure\".  Much appreciated!</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=7150\" onclick=\"get_ticket_and_populate_wrapper('7150'); return false;\" title=\"Sinful alias and daemon name inconsistencies\">#7150</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSinful alias and daemon name inconsistencies</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7151\" onclick=\"get_ticket_and_populate_wrapper('7151'); return false;\" title=\"Improve usability of StartCommandRequest\">#7151</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove usability of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartCommandRequest\" title=\"Start Command Request\">StartCommandRequest</a></span></td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2021-Mar-09 11:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0924155cc02edd2443c28ec689f3d7e0453c8a2a\">[62455]</a></span>: (HTCONDOR-323) Avoid double free of token request. This patch avoids invoking the callback when sending updates to the collector multiple times. Unnecessarily invoking this callback more than once was causing double free memory errors in the Token Request data structures.\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-15 16:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/30f49551876a1a6e2f8bffd672f42f389d839f9c\">[57430]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7093\" onclick=\"get_ticket_and_populate_wrapper('7093'); return false;\" title=\"Refactor/merge Scheduler:: and ResMgr:: try_token_request()\">#7093</a></span>) Add parameter names in a few places without them. Fix a typo in the timer management part of the token callback in the startd.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-14 20:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/48c152643dd756b43d438c502cedd9bcfc87ec2c\">[57429]</a></span>: Bugfixes found during testing. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7093\" onclick=\"get_ticket_and_populate_wrapper('7093'); return false;\" title=\"Refactor/merge Scheduler:: and ResMgr:: try_token_request()\">#7093</a></span> Random smattering of fixes to get things working: - Request tokens for the primary collector(s) of the schedd. - Clear up some type confusion in callback (void *) casts. - Make sure the correct authorization is requested in the schedd. - Use the collector name, not\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-14 16:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a92ebf0420cb3fe645383852d61485ff31626c19\">[57428]</a></span>: Add forgotten header file. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7093\" onclick=\"get_ticket_and_populate_wrapper('7093'); return false;\" title=\"Refactor/merge Scheduler:: and ResMgr:: try_token_request()\">#7093</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-14 14:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6d713c461e9c5e90c923c92e256006f0ffc8b6e1\">[57427]</a></span>: Have token request utilize callbacks. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7093\" onclick=\"get_ticket_and_populate_wrapper('7093'); return false;\" title=\"Refactor/merge Scheduler:: and ResMgr:: try_token_request()\">#7093</a></span> With this, we utilize the new callback interface when sending updates to the collector. On failure, we have the ability to trigger a token request (if the daemon had setup such a thing beforehand).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-11 23:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8ac9c377d9bd1f441e50e3aaf5168d6aaa7a45d2\">[57426]</a></span>: Add callback function for sending updates. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7093\" onclick=\"get_ticket_and_populate_wrapper('7093'); return false;\" title=\"Refactor/merge Scheduler:: and ResMgr:: try_token_request()\">#7093</a></span> With this, the caller of `DCCollector::sendUpdate` can provide a callback function and expect it to be invoked on success or failure.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-11 22:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0cf689b7b0bdad063db3a95af63d648cd37b6d9b\">[57425]</a></span>: Refactor 10 parameter functions into a struct. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7093\" onclick=\"get_ticket_and_populate_wrapper('7093'); return false;\" title=\"Refactor/merge Scheduler:: and ResMgr:: try_token_request()\">#7093</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Jul-15 16:52", "status": "resolved", "created": "2019-Jun-04 14:29", "fixed_version": "2019-Jun-04 14:29", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "bbockelm", "derived_from": "#7006", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}