{"id": 1552, "title": "Ticket #1552: LOCAL_CONFIG_DIR", "description": "<blockquote>\nTony reports that editing files with vi in LOCAL_CONFIG_DIR is problematic, because condor tries to read the .filename.swp file.  emacs backup files could pose a similar problem.\n\n<p><span class=\"section\"></span></p><h2>Proposal </h2>\n\n<p>Add a configurable filename pattern that can be used to blacklist (or maybe also whitelist) files in LOCAL_CONFIG_DIR.  Example:\n\n</p><p>LOCAL_CONFIG_DIR_EXCLUDE_REGEXP = (\\..*)|(.*~)|(#.*)\n\n</p><p>This would be a good STUDENTTASK.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Aug-17 14:54:36 by danb:</em> <br/>\n\nWill, thanks for the patch!  Some comments:\n\n<p></p><ol>\n<li>In the call to EXCEPT(), do not pass the regexp parse error directly.  EXCEPT() is like printf().  The first argument is a format string.  If the error message happens to have percent signs in it, then they will be interpreted argument substitution commands.  Anyway, you should provide more context in the error message such as this:\n<div class=\"code\">\n<pre class=\"code\">EXCEPT(\"LOCAL_CONFIG_DIR_EXCLUDE_REGEXP is not a valid regular expression: %s\",_errstr ? _errstr : \"\")\n</pre></div>\n\n\n<p></p></li><li>The return value of param() is a string that needs to be freed by the caller.\n\n<p></p></li><li>When we skip a file due to this regexp, please log something to that effect at debug level D_FULLDEBUG|D_CONFIG.\n\n<p></p></li><li>The default value of this configuration setting should be specified in param_info.in.  I think the default should exclude files beginning with \".\" as well as vi and emacs tmp files, so maybe this: ^((\\..*)|(.*~)|(#.*))$\n</li></ol>\n\n<p></p><hr/>\n<em>2010-Aug-18 09:42:36 by danb:</em> <br/>\n\nBy default, we should also exclude filenames ending in .rpmsave and .rpmnew.\n<hr/>\n<em>2010-Oct-20 16:03:30 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2010-Nov-12 10:58:41 by tmckay:</em> <br/>\n\nBegan with the original patch, incorporated feedback items from danb above.  Modified a bit for readability, changed allocation of Regexp to static since it's small.  Tested using the following rough sequence with rebuilt condor_master:\n\n<p>Add the following lines to condor_config.local on a personal Condor\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">##LOCAL_CONFIG_DIR_EXCLUDE_REGEXP =\nLOCAL_CONFIG_DIR = /home/mckay/condor/local.tmckaylt\nMASTER_DEBUG=D_CONFIG\n</pre></div>\n\n\n<p>Created spurious files in local config dir:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ cd /home/mckay/condor/local.tmckaylt\n$ touch \"#blah\" blah~ blah.rpmnew blah.rpmsave .blah\n</pre></div>\n\n\n<p>Empty <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MasterLog\" title=\"Master Log\">MasterLog</a></span>, run condor_master, check logs.\nLast two lines from grep represent config files read.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ rm /home/mckay/condor/local.tmckaylt/log/MasterLog\n$ condor_master\n$ grep local\\.tmckaylt /home/mckay/condor/local.tmckaylt/log/MasterLog\n11/12/10 11:38:36 Ignoring config file based on LOCAL_CONFIG_DIR_EXCLUDE_REGEXP, '/home/mckay/condor/local.tmckaylt/#blah'\n11/12/10 11:38:36 Ignoring config file based on LOCAL_CONFIG_DIR_EXCLUDE_REGEXP, '/home/mckay/condor/local.tmckaylt/blah.rpmsave'\n11/12/10 11:38:36 Ignoring config file based on LOCAL_CONFIG_DIR_EXCLUDE_REGEXP, '/home/mckay/condor/local.tmckaylt/.blah'\n11/12/10 11:38:36 Ignoring config file based on LOCAL_CONFIG_DIR_EXCLUDE_REGEXP, '/home/mckay/condor/local.tmckaylt/blah~'\n11/12/10 11:38:36 Ignoring config file based on LOCAL_CONFIG_DIR_EXCLUDE_REGEXP, '/home/mckay/condor/local.tmckaylt/blah.rpmnew'\n11/12/10 11:38:36    /home/mckay/condor/local.tmckaylt/condor_config.local\n11/12/10 11:38:36    /home/mckay/condor/local.tmckaylt/condor_config.local\n</pre></div>\n\n\n<p>Override LOCAL_CONFIG_DIR_EXCLUDE_REGEXP in condor_config.local:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">LOCAL_CONFIG_DIR_EXCLUDE_REGEXP =\nLOCAL_CONFIG_DIR = /home/mckay/condor/local.tmckaylt\nMASTER_DEBUG=D_CONFIG\n</pre></div>\n\n\n<p>Repeat test, all files parsed:\n</p><div class=\"code\">\n<pre class=\"code\">$ rm /home/mckay/condor/local.tmckaylt/log/MasterLog\n$ condor_master\n$ grep local\\.tmckaylt /home/mckay/condor/local.tmckaylt/log/MasterLog\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/condor_config.local\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/#blah\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/.blah\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/blah.rpmnew\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/blah.rpmsave\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/blah~\n11/12/10 11:50:31    /home/mckay/condor/local.tmckaylt/condor_config.local\n</pre></div>\n\n\n<p>Change regular expression to something illegal:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">LOCAL_CONFIG_DIR_EXCLUDE_REGEXP = ((.*\\.rmpsave|(.*\\.rpmnew))\nLOCAL_CONFIG_DIR = /home/mckay/condor/local.tmckaylt\nMASTER_DEBUG=D_CONFIG\n</pre></div>\n\n\n<p>Run again:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_master\nERROR \"LOCAL_CONFIG_DIR_EXCLUDE_REGEXP config parameter is not a valid regular expression.  Value: ((.*\\.rmpsave|(.*\\.rpmnew)),  Error: missing )\" at line 937 in file condor_config.cpp\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Nov-13 07:54:36 by matt:</em> <br/>\n\nAdd an entry to condor_config.generic for this, and have it uncommented since there is no default in the code - even though there is a default in the param table.\n\n<p></p><hr/>\n<em>2010-Nov-13 07:56:24 by matt:</em> <br/>\n\nFor the test, you could automate by putting unique params in each of the files you intend to filter and run condor_config_val -dump to see if they are present.\n\n<p></p><hr/>\n<em>2010-Nov-19 09:21:10 by danb:</em> <br/>\n\nThe patch looks good to me.  Matt, why would you prefer to have the config value uncommented in condor_config.generic?  I usually prefer to have things commented out in the example config file so that stale config files are less likely to preserve stale defaults (also we save a little memory).\n\n<p></p><hr/>\n<em>2010-Nov-19 09:50:48 by matt:</em> <br/>\n\nOnly because there is no default in the code. I had an eye more toward 7.4 where the param table is turned off. On 7.5 I guess there essentially is a default in the code, present in the param table.\n\n<p>Whatever it takes to have a sane blacklist by default.\n\n</p><p></p><hr/>\n<em>2010-Nov-30 10:24:46 by tmckay:</em> <br/>\n\nAdded Matt's patch to condor_config.generic example (attached), with the regexp line commented out as discussed above since the param table should be in effect.\n\n<p></p><hr/>\n<em>2010-Nov-30 10:44:19 by danb:</em> <br/>\n\nI'm happy with this patch.  Go ahead and commit if you were waiting for me to say that.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/216/localCondorConfigDirExclude.patch\">localCondorConfigDirExclude.patch</a>\n2370 bytes added by mccardel on 2010-Aug-17 19:22:53 UTC.\n</li><li><a href=\"../files/249/LOCAL_CONFIG_DIR_1552_update.patch\">LOCAL_CONFIG_DIR_1552_update.patch</a>\n3581 bytes added by tmckay on 2010-Dec-06 16:31:34 UTC.\n<br/>\nFiles moved from condor_c++_util to condor_utils since patch was originally done, updated patch.  Include condor_config.generic in the same patch file.  Remove original patches.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-21 12:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f533b37c0bd6b3078b4e629d517ec9ec404111e3\">[25866]</a></span>: Documented LOCAL_CONFIG_DIR_EXCLUDE_REGEXP. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1552\" onclick=\"get_ticket_and_populate_wrapper('1552'); return false;\" title=\"LOCAL_CONFIG_DIR\">#1552</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-10 10:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eacd421dca6f9c609ed613d3cbc45e3b73f9c156\">[19625]</a></span>: Add filename filter for configuration files in LOCAL_CONFIG_DIR (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1552\" onclick=\"get_ticket_and_populate_wrapper('1552'); return false;\" title=\"LOCAL_CONFIG_DIR\">#1552</a></span>)  (By tmckay )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Dec-10 11:07", "status": "resolved", "created": "2010-Aug-03 13:23", "fixed_version": "2010-Aug-03 13:23", "broken_version": "v070504", "priority": "4", "subsystem": "", "assigned_to": "tmckay", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "dan@hep.wisc.edu tiradani@fnal.gov matt@cs.wisc.edu tstclair@redhat.com", "due_date": ""}