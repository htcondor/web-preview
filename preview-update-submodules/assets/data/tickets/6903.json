{"id": 6903, "title": "Ticket #6903: GPU utilization can use different device index than GPU discovery", "description": "<blockquote>\nThere was a report on condor_users that the device indexes reported by <code>condor_gpu_utilization</code> don't match the indexes reported by <code>condor_gpu_discovery</code> on the same machine.  A close reading of the NVIDIA header files for the nvml library seem to confirm that this is a possibility.\n\n<p>The nvml library may enumerate the GPUs in a different order than the driver and runtime library do.  Apparently we are supposed to use the nvml functions <code>nvmlDeviceGetHandleByPciBusId</code> or <code>nvmlDeviceGetHandleDeviceByUuid</code> rather than <code>nvmlDeviceGetHandleByIndex</code> as we currently do.\n\n</p><p>This means that <code>condor_gpu_utilization</code> will have to replicate at least some of the device enumeration code in <code>condor_gpu_discovery</code> so that it will know what Uuid or PciID had been assigned to each CUDA index, and then adjust its <code>SlotMergeConstraint</code> to tie utilization values to the correct CUDA devices\n\n</p><p>In the long run, it might be less work to move the functionality of <code>condor_gpu_utilization</code> into <code>condor_gpu_discovery</code>, perhaps by making it part of the <code>-dynamic</code> output.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-22 14:52:24 by tlmiller:</em> <br/>\n\nThe branch has cleaner code, but only for condor_gpu_utilization.  Even if we end up combining the two tools, condor_gpu_discovery would benefit from a code-cleanup, hopefully including using the \"new\" (refactored) gpu enumeration and library loading codes.\n\n<p></p><hr/>\n<em>2019-Mar-19 18:11:40 by tlmiller:</em> <br/>\n\nFinally tested this with Windows GPUs, and it seems to work just fine.\n\n<p></p><hr/>\n<em>2019-Apr-02 14:44:49 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong>.  in condor_gpu_utilization line 152, we ignore a failure to get the device handle by <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PciBusId\" title=\"Pci Bus Id\">PciBusId</a></span>, but then in the loop at line 184, we try and use the device handle that we don't have, this happens also in the loop at line 210.\n\n<p></p><hr/>\n<em>2019-Apr-02 15:30:18 by tlmiller:</em> <br/>\n\nThanks for the catch; code updated.  One of the checks is superfluous right now, but I figured it wouldn't hurt in case we ever changed the loop that it's in.  I added a (currently) redundant check to getElapsedTimeForDevice() in case we forget about this later.\n\n<p></p><hr/>\n<em>2019-Apr-08 16:12:47 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong>: looks good. checkin <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6c6aee795ba4391e0e0793af75d7f104a8ce4c5d\">[56490]</a></span> fixes the problem with reporting on devices that we can't get handles.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-08 16:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b5d73768ae2472fb1df89c7671bcb9bf832f0ddb\">[56522]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Thanks to TJ for the catch here. After ignoring a failure to obtain the device handle, ignore the device in all subsequent code.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-02 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6c6aee795ba4391e0e0793af75d7f104a8ce4c5d\">[56490]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Thanks to TJ for the catch here. After ignoring a failure to obtain the device handle, ignore the device in all subsequent code.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-27 11:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a3ff598dd22f31c50a54b59dc951b4bc2e4c07bb\">[56450]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6901\" onclick=\"get_ticket_and_populate_wrapper('6901'); return false;\" title=\"Try harder to load libnvidia-ml\">#6901</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-25 10:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8aebb4a24f68cc295c2b2e7fcbd90f25fc072cb3\">[56247]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Don't use the quoted PCI bus ID (derp). When building for testing, build with debug symbols.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-22 21:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/af939d5aacf057ff20bc7a19a3b9eb70507e61ba\">[56245]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Use PCI bus IDs when simulating, too.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-22 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6d27f620996c03be07758ff4cf202916daac9955\">[56243]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Fix condor_gpu_utilization -dynamic to look up NVML devices by PCI (bus) ID. Also remove some dead code. We don't need to check for \u200bNVML_ERROR_NO_PERMISS\u200bION, because we just ignore the device if we can't find it anyway.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 14:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f80c937776f45b0825c638514de8df678ec9c70d\">[56190]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Windows build fix? (no. 3)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 14:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92befcd7ebb97074a1f11c640dfeab20af11f849\">[56189]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Coalesce gpu_function_pointers* and cuda_device_enumeration*; their relationship was kind of incestuous anyways. Hopefully this also actually fixes the Windows build problems.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 14:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92167f655cbd9995cbfb2de295c28a06a51aa48e\">[56187]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Windows build fix?  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aa2d09472b0c7028d87ea0722c449f8449e76b38\">[56186]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Rather than duplicate (and in future source files which might use them), move the Windows.h include mage to condor_gpu_utilization.cpp itself. Also, #define RTLD_LAZY for Windows.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 13:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d6e2eff8031df6138e0495138c973c3f4c67acf2\">[56185]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Build condor_gpu_utilization in its new home.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 10:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4cca96ecef6f609c4fd9f4db58632f32ef5363e0\">[56183]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6903\" onclick=\"get_ticket_and_populate_wrapper('6903'); return false;\" title=\"GPU utilization can use different device index than GPU discovery\">#6903</a></span>) Refactor NVidia-specific library-loading and function pointer-filling code to make it accessible to condor_gpu_utilization. Use that code to match NVML devices to CUDA driver / runtime devices via their PCI ID. For now, leave the refactored code duplicated in condor_gpu_discovery, since that\u00a0[...]\n (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Apr-09 09:36", "status": "resolved", "created": "2019-Feb-06 12:58", "fixed_version": "2019-Feb-06 12:58", "broken_version": "v080800", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "tlmiller", "derived_from": "#6883", "creator": "johnkn", "rust": "", "customer_group": "users", "visibility": "public", "notify": "", "due_date": ""}