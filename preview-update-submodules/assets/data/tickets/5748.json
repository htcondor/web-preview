{"id": 5748, "title": "Ticket #5748: Pslot preemption can preempt incorrectly", "description": "<blockquote>\nWhen the negotiator identifies a match that requirements pslot preemption, it records the claim ids of the dslots that need preemption in the machine ad under the attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PreemptDslotClaims\" title=\"Preempt Dslot Claims\">PreemptDslotClaims</a></span>. When the match is sent to the schedd, this attribute is looked up to retrieve the information to send to the schedd.\n\n<p>But we can't set this attribute when the match is identified. We have to wait until we're ready to send the match to a schedd. With a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span>, these two points will probably be separated in time, and the second one may not happen.\n\n</p><p>A pslot can be matched with preemption for one submitter, saved in a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span>, and then go unused for that submitter (e.g. submitter doesn't have enough jobs to use all matches). The pslot can then match without preemption for another submitter. We don't want that second submitter to receive the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PreemptDslotClaims\" title=\"Preempt Dslot Claims\">PreemptDslotClaims</a></span> value set for the first submitter.\n\n</p><p>For a simple fix, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PreemptDslotClaims\" title=\"Preempt Dslot Claims\">PreemptDslotClaims</a></span> can be set only when matchmakingAlgorithm() is about to return the machine ad as a match for a request. For ads going into a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span>, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PreemptDslotClaims\" title=\"Preempt Dslot Claims\">PreemptDslotClaims</a></span> value should be stored beside the ad in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span> entry.\n\n</p><p>A better fix would be for matchmakingAlgorithm() to return a data structure that contains both the machine ad and additional information (like the dslot claims).</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Sep-27 11:20:09 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-30 10:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2afc09efebf4a5353f09d0f87d504370390eb598\">[48707]</a></span>: Docs for pslot preemption wrong dslot claim list bugfix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5748\" onclick=\"get_ticket_and_populate_wrapper('5748'); return false;\" title=\"Pslot preemption can preempt incorrectly\">#5748</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-30 10:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ff28dcc991c68935728bb50f2ccf561bbb3f4a8f\">[48706]</a></span>: Pslot preemption can preempt wrong dslots. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5748\" onclick=\"get_ticket_and_populate_wrapper('5748'); return false;\" title=\"Pslot preemption can preempt incorrectly\">#5748</a></span> Don't set <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PreemptDslotClaims\" title=\"Preempt Dslot Claims\">PreemptDslotClaims</a></span> in the machine ad until we want to send the ad to a schedd. If we set it while building the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span> and then don't use the ad for the current submitter, we could send the ad to a subsequent submitter with an inappropriate\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Sep-27 11:20", "status": "resolved", "created": "2016-Jun-23 16:40", "fixed_version": "2016-Jun-23 16:40", "broken_version": "v080104", "priority": "4", "subsystem": "DaemonsCM", "assigned_to": "gthain", "derived_from": "#3667", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}