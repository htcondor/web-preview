{"id": 1959, "title": "Ticket #1959: Implement per-job PID namespaces.", "description": "<blockquote>\nSince Linux kernel 2.6.24, it is possible to create PID namespaces.  This makes a process believe it is PID 1, while processes in the global namespace see the \"normal\" PIDS for the process and its descendants.  Reference: <a class=\"external\" href=\"http://lwn.net/Articles/259217/\">http://lwn.net/Articles/259217/</a>\n\n<p>If a Condor job is launched with its own namespace, we'd have the following advantages:\n</p><ul>\n<li>Cleanup: when \"PID 1\" dies, the kernel kills the rest of the processes in the namespace.\n</li><li>Separation: two jobs running under the same Unix user account cannot see each other.\n</li></ul>\n\n<p>In order to implement this, one also has to implement a separate mount namespace for the job as you must remount /proc for \"ps\" to work as expected.  That leads to the tantalizing possibility of having a per-job /tmp and /var/tmp; I'll address this in a later ticket.  Here's what the job runtime environment will look like:\n</p><div class=\"code\">\n<pre class=\"code\">[bbockelm@rcf-bockelman condor]$ condor_run ps faux\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nbbockelm     1  0.0  0.0 106200  1132 ?        SN   14:15   0:00 /bin/bash /home/bbockelm/projects/condor/.condor_run.17238\nbbockelm     2  0.0  0.0 108052  1000 ?        RN   14:15   0:00 ps faux\n</pre></div>\n\n\n<p>Patch to come.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Mar-28 12:23:12 by tannenba:</em> <br/>\n\n<hr/>\n<em>2011-Mar-28 12:19:35 by tannenba:</em> <br/>\n\n<strong>Initial Feedback</strong>\n\n<p>First off, thanks for the interesting work and the patch!  Thoughts below.\n\n</p><p></p><ol>\n<li>Should the code to create a new pid namespace be implemented in daemon core, or should it be a standalone command-line tool?  Since it would need to run as root, options are this tool could be setuid or invoked as a hook via Condor or via the switchboard.\n\n<p></p></li><li>If the pid namespace creation stays in daemon core, we need at least a road map plan for how this functionality would work with priv sep enabled.\n\n<p></p></li><li>As written, the patch uses pthread conditionals to synchronize between the parent and child processes for procd registration.  This is not desired, nor required. One way to eliminate both the pthread calls (nothing but the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorThreads\" title=\"Condor Threads\">CondorThreads</a></span> class should call pthreads directly) and the need for this synchronization is to always have the child process register with the procd as before, and have the parent pass the global pid to the child via the already in-place pipe. Another idea would be for the parent to always register w/ the procd, and to have the child block pending a message on the pipe from the parent telling the child a successful procd registration has occurred. The former may be preferred due to less code churn. In either event, the same codepath to register w/ the procd should be used regardless of if a new pid namespace is being created or not.\n\n<p></p></li><li>Functionality to remap /tmp and friends should be a different patch/ticket. Though not ideal, it is ok to rebase the patch off of this one if it makes it easier, but it needs to be a seperate commit that could be merged/revoked independently w/ a separate discussion thread (ticket).\n</li></ol>\n\n<p></p><hr/>\n<em>2011-Mar-28 13:07:54 by bbockelm:</em> <br/>\n\nHi Todd,\n\n<p>3, 4 are no problem.  I think the main part to discuss is 1 and 2.\n\n</p><p>One aspect of privsep I don't understand is the propagation of error messages.  If the switchboard is successfully invoked, but exec fails, how does this error message propagate back?\n\n</p><p>Since CLONE_NEWPID can definitely fail on an otherwise-functional system, I would prefer proper error propagation.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2011-Mar-30 08:43:17 by bbockelm:</em> <br/>\n\nHi,\n\n<p>I did some more research into implementing this with privsep.  There appears to be no way to have a process \"switch PID namespace\".  It can only be done when clone() is called.  Unfortunately, the only thread in a process that will perform exec (regardless of the thread that calls exec) is the thread group leader, preventing us from playing games with CLONE_THREAD.\n\n</p><p>Hence, any use of PID namespaces requires a parent and child process.  For non-privsep this is OK: the parent is the starter, the child is the job.  To implement this in privsep, we would need to have an additional process in the tree: starter -&gt; shim -&gt; job.  We would need to make the shim correctly reap the job, have the same lifetime of the job, and have the same exit code as the job.  In other words, we'd have a non-trivial, long-lasting process with elevated privileges (<strong>and</strong> change the running semantics on sysadmins!  Right now, PID namespaces is rather invisible to admins, although it does change semantics for users): quite a project to do and security audit.\n\n</p><p>Another, more-plausible, approach would be to have the shim short-lived and reparent back to the starter (CLONE_PARENT).  This would require the switchboard to synchronize with the starter and inform it of the child's final PID.  In general, I think the switchboard ought to do this sort of synchronization with the starter in order to gracefully communicate other exec failures.  However, if the infrastructure isn't already there to synchronize via pipe ... I would personally call it out of scope for this ticket.\n\n</p><p>Thoughts?  I'll add ZKM to the ticket to see what he thinks.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2011-May-02 18:26:50 by bbockelm:</em> <br/>\n\nHi Todd, all,\n\n<p>Can I bump this ticket?  Been about a month ready for another review, I think.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2011-Nov-29 14:21:06 by eje:</em> <br/>\n\nOne open issue is generalizing current checks for \"small pid\" relating to preventing security holes, so they don't trigger when pid namespaces are in effect.\n\n<p>Places I identified:\n\n</p><p></p><div class=\"verbatim\">\n<pre>./src/condor_procd/procd_main.cpp:247:\t\t\t\tif (root_pid == 1) {\n./src/condor_procd/procd_main.cpp:340:\tif (own_pi-&gt;ppid == 1) {\n./src/condor_utils/killfamily.cpp:234:\t\tif ( (*old_pids)[i].ppid == 1 || (*old_pids)[i].pid == 0 ) {\n./src/condor_daemon_core.V6/daemon_core.cpp:5716:\tif ( signed_pid &gt; -10 &amp;&amp; signed_pid &lt; 3 ) {\n</pre></div>\n\n\n<p>Pete Keller suggested abstracting these checks into a function, like \"bool is_safe_pid(int pid)\", which allows small pids when it knows pid namespaces are being used, but otherwise does not for legacy behavior.\n\n</p><p></p><hr/>\n<em>2012-Apr-05 11:42:49 by adesmet:</em> <br/>\n\nPossibly related: <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2558\" onclick=\"get_ticket_and_populate_wrapper('2558'); return false;\" title=\"condor_startd can sometimes crash after enabling fetchwork\">#2558</a></span>.  clone() was causing grief for the startd, so it was disabled for all daemons except the schedd.\n\n<p></p><hr/>\n<em>2012-Jul-25 15:56:08 by tstclair:</em> <br/>\n\nPatch doesn't apply cleanly and wasn't targeted to release.\n<hr/>\n<em>2012-Oct-22 14:58:32 by zmiller:</em> <br/>\n\nBulk change of target version from v070901 to v070902 using ./ticket-target-mover.\n<hr/>\n<em>2012-Dec-11 16:37:58 by johnkn:</em> <br/>\n\nBulk change of target version from v070902 to v070903 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2013-Jan-10 11:55:33 by gthain:</em> <br/>\n\nA key requirement here is that many OSG site do not run with slot users, and all users from any given site are mapped to the same OS user.  As a result, two jobs from two different users which land on the same machine can kill each others jobs (perhaps unintentionally), gdb attach, etc.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"active\" href=\"/wiki-archive/tickets/?ticket=1965\" onclick=\"get_ticket_and_populate_wrapper('1965'); return false;\" title=\"condor_master should be able to have its own PID namespace\">#1965</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_master should be able to have its own PID namespace</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2015\" onclick=\"get_ticket_and_populate_wrapper('2015'); return false;\" title=\"Take advantage of filesystem namespaces\">#2015</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nTake advantage of filesystem namespaces</td></tr>\n</tbody></table>", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/285/condor_pid_namespaces_v1.patch\">condor_pid_namespaces_v1.patch</a>\n22524 bytes added by bbockelm on 2011-Mar-10 20:46:55 UTC.\n<br/>\nThis patch implements a per-job PID namespace.  It's diff'd off the patch in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1831\" onclick=\"get_ticket_and_populate_wrapper('1831'); return false;\" title=\"Take advantage of cgroups-based capabilities on new Linux platforms\">#1831</a></span> and won't apply against trunk.\n\n<p>There are a few things left undone:\n</p><ul>\n<li>How should we present this new behaviour to the sysadmin?  I assume we want some sort of CONDOR_CONFIG variable.\n</li><li>We really don't need to depend on cgroups for this.  Separate the two.\n</li></ul>\n\n<p>This is a <strong>hard</strong> patch to review because it does careful surgery to DaemonCore's <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreateProcessForkit\" title=\"Create Process Forkit\">CreateProcessForkit</a></span>.  I try to include many comments.\n\n</p><p>The hard part about this patch is that the child thinks it is 'pid 1' and tries to register with the procd as pid 1.  So, I used pthreads cond's to properly synchronize the child and parent thread.  The child stops, the parent wakes up and registers the child with the procd, and wakes the child.  The child continues its usual startup sequence, remounts /proc, and calls exec.  The parent then uses 'poll' on the error pipe and will stall until the child either exec's or exits.  So, even though the synchronization and registration is handled differently, the same conditions should hold true when the parent leaves fork_and_exec as the previous implementation.\n\n</p><p>This is some deep voodoo; because of the mix of pthreads and the poll trick, I'd appreciate it if someone can give a thorough review and feedback.<br/>\n</p></li><li><a href=\"attach_get/288/condor_pid_namespaces_v2.patch\">condor_pid_namespaces_v2.patch</a>\n38861 bytes added by bbockelm on 2011-Mar-11 21:19:18 UTC.\n<br/>\nv2 of the patch.  A few notes:\n<ul>\n<li>No longer tied to cgroups; instead, creates a new PID namespace if USE_PID_NAMESPACES = true in the config.  Diff is based from my local cgroups branch.\n</li><li>Adds USE_FS_NAMESPACES; if set to true, it will mask /tmp, /var/tmp, and $EXECUTE with $_CONDOR_SCRATCH_DIR, $_CONDOR_SCRATCH_DIR, and $IWD respectively.  Hence, \"condor_run ls /tmp\" will return blank; you also can't peak at other job's sandboxes.  This works with any Linux 2.6 kernel.\n</li><li>Adds SQUASH_DIRS: set this to a list of directories to \"squash\" them to point at $_CONDOR_SCRATCH_DIR.  Useful for sites that have other world-writeable directories.  SQUASH_DIRS should work on any 2.6 kernel.\n</li></ul>\n\n<p>Ok, now the issues:\n</p><ul>\n<li>If $IWD is a subdirectory of $EXECUTE, then we alter the call to exec accordingly.  <strong>However</strong>, it's possible the env now reports to \"squashed\" directories.  How should we mangle the environment?\n</li><li>Is squashing $EXECUTE even the right thing to do?  Is there some better way to hide the other jobs' sandboxes?\n</li><li>I'd appreciate an expect in the condor_starter evaluate how I pass the remap object through to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span>.  I put it in vanilla_proc, but maybe it belongs in os_proc?\n</li></ul>\n<br/>\n</li><li><a href=\"attach_get/294/condor_pid_namespaces_v3_756_1959.patch\">condor_pid_namespaces_v3_756_1959.patch</a>\n37975 bytes added by bbockelm on 2011-Mar-19 16:36:58 UTC.\n<br/>\nNext version of this patch:\n<ul>\n<li>Remove the squashing of $EXECUTE for now.  I've decided this can't be accomplished without the full knowledge of the starter.  Because of the complexity that would be added to the patch - increasing the difficulty of the review - I've left it off for now.  We'll revisit in the future, as this is really necessary to completely sandbox the job.\n</li><li>Rebased against V7_5_6-branch.  This should help with the review; no cgroups are required.</li></ul>\n<br/>\n</li><li><a href=\"attach_get/307/condor_pid_namespaces_v4.patch\">condor_pid_namespaces_v4.patch</a>\n25369 bytes added by bbockelm on 2011-Mar-30 13:31:20 UTC.\n<br/>\nThe new version of this patch has the following changes:\n\n<p></p><ul>\n<li>Remove usage of pthreads; synchronization only happens using pipes.\n</li><li>The control path is now identical regardless of whether PID namespaces are in use.\n</li><li>Separate out all the FS namespace functionality to make the patch minimal.\n</li></ul>\n\n<p>This should be ready for review, I believe.<br/>\n</p></li><li><a href=\"attach_get/368/condor_pid_namespaces_v5.patch\">condor_pid_namespaces_v5.patch</a>\n25635 bytes added by bbockelm on 2011-Jun-03 02:10:33 UTC.\n<br/>\nUpdate of the PID namespace patch against the latest master (small merge issues due to the inclusion of cgroups into master).<br/>\n</li><li><a href=\"attach_get/530/condor_pid_namespaces_v6.patch\">condor_pid_namespaces_v6.patch</a>\n7528 bytes added by bbockelm on 2012-Feb-11 03:16:11 UTC.\n<br/>\nHere's a completely rewritten approach for implementing PID namespaces.  This is far less destructive to the existing code, and uses the fact that the clone syscall acts like POSIX fork.\n\n<p>No more careful surgery to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreateProcessForkit\" title=\"Create Process Forkit\">CreateProcessForkit</a></span>!<br/>\n</p></li><li><a href=\"attach_get/533/condor_pid_namespaces_v6.patch\">condor_pid_namespaces_v6.patch</a>\n7542 bytes added by bbockelm on 2012-Feb-14 17:43:39 UTC.\n<br/>\nFix of small bug in ALLOWED_FLAGS in v6 patch.<br/>\n</li><li><a href=\"attach_get/535/condor_pid_namespaces_v7.patch\">condor_pid_namespaces_v7.patch</a>\n8945 bytes added by bbockelm on 2012-Feb-16 20:25:47 UTC.\n<br/>\nThis version moves the remounting of /proc into the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FilesystemRemap\" title=\"Filesystem Remap\">FilesystemRemap</a></span> object.  This allows PID namespaces to be used in conjunction with NAMED_CHROOT.<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-27 13:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/29e953f6d4a7d6358f003dec6b203f4616c62df5\">[35025]</a></span>: final wording update for doc on per job PID namespaces ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1959\" onclick=\"get_ticket_and_populate_wrapper('1959'); return false;\" title=\"Implement per-job PID namespaces.\">#1959</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-22 11:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4330d2a0bb8421b2d07aa7e88b76aa2a71c1a5ca\">[34997]</a></span>: last 2 details on per job PID namespaces did not make it into the 7.9.4 manual. Done now. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1959\" onclick=\"get_ticket_and_populate_wrapper('1959'); return false;\" title=\"Implement per-job PID namespaces.\">#1959</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-14 12:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b8a82b093edf952a4e2f5ff4a02e9a4e4efc47b7\">[34924]</a></span>: documentation (missing a couple of details) of per job PID namespaces ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1959\" onclick=\"get_ticket_and_populate_wrapper('1959'); return false;\" title=\"Implement per-job PID namespaces.\">#1959</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-23 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0aca358dcdaf68a0163e6cfcd6040c53638a8a6c\">[34733]</a></span>: Implement USE_PID_NAMESPACE <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1959\" onclick=\"get_ticket_and_populate_wrapper('1959'); return false;\" title=\"Implement per-job PID namespaces.\">#1959</a></span> On Linux, allows jobs to run in separate pid namespaces  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Feb-18 16:20", "status": "resolved", "created": "2011-Mar-10 14:33", "fixed_version": "2011-Mar-10 14:33", "broken_version": "v070700", "priority": "1", "subsystem": "Daemons", "assigned_to": "smoler", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com matt@cs.wisc.edu tannenba@cs.wisc.edu zmiller@cs.wisc.edu eje@cs.wisc.edu bbockelm@cse.unl.edu", "due_date": "20120130"}