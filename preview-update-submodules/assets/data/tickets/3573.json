{"id": 3573, "title": "Ticket #3573: Execute directories left behind when privsep is in use", "description": "<blockquote>\nI have tracked this down and I am writing down what I learned:\n\n<p>What we knew going in: execute directories were being left behind for some strange reason.  Looking at the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StarterLog\" title=\"Starter Log\">StarterLog</a></span>, it looks like the execute directories correspond to jobs that were hard-killed (kill -9) (or maybe the power went out) -- there is no statement corresponding to the end of a job in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StarterLog\" title=\"Starter Log\">StarterLog</a></span>.\n\n</p><p>What I found out:  first off, the code was doing the wrong thing.  Here is a line from <code>/etc/condor/privsep_config</code>:\n</p><div class=\"code\">\n<pre class=\"code\">valid-dirs = /var/lib/condor/execute/slot1\n</pre></div>\n\nThe code was doing a simple string comparison against this and \"<code>//var/lib/condor/execute/slot1</code>\", so the two slashes at the beginning were screwing up the comparison.\n\n<p>Second problem, after I fixed the above: privsep was still barfing.  It barfed because of the following:\n</p><div class=\"code\">\n<pre class=\"code\">$ ls -ld /var/lib/condor\ndrwxr-xr-x 4 condor condor 4096 Apr 12 00:15 /var/lib/condor\n</pre></div>\n\nNote that the owner of the directory is condor, but user condor is not in the trusted-uids list in <code>/etc/condor/privsep_config</code>! (The execute directories are under <code>/var/lib/condor/execute</code> on this machine.) Indeed the configuration is\n<div class=\"code\">\n<pre class=\"code\">valid-caller-uids = condor\nvalid-caller-gids = condor : 1100-1199\n\nvalid-target-uids = nobody : boinc : ghostusr : slot1 : slot2 : slot3 : slot4 : slot5 : slot6 : slot7 : slot8 : slot9 : slot10 : slot11 : slot12 : slot13 : slot14 : slot15 : slot16 : slot17 : slot18 : slot19 : slot20 : slot21 : slot22 : slot23 : slot24 : slot25\nvalid-target-gids = boinc : nobody: ghostusr : slot1 : slot2 : slot3 : slot4 : slot5 : slot6 : slot7 : slot8 : slot9 : slot10 : slot11 : slot12 : slot13 : slot14 : slot15 : slot16 : slot17 : slot18 : slot19 : slot20 : slot21 : slot22 : slot23 : slot24 : slot25 : 1100-1199\n</pre></div>\n\nSo I ran\n<div class=\"code\">\n<pre class=\"code\"># chown root.root /var/lib/condor\n# chown root.root /var/lib/condor/execute\n</pre></div>\n\nThen I restarted the startd, and it cleaned up the execute directories.\n\n<p>Possible solutions/workarounds: condor should be in the valid-target-* lists, or the execute directories should be owned by nobody or root.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Apr-12 09:40:17 by nwp:</em> <br/>\n\nPushed onto V7_9-gittrac_3573-branch, which is based off of V7_9_5-branch.  Would like to get this reviewed and merged, to be released with htcondor version 7.9.5 if possible.\n\n<p></p><hr/>\n<em>2013-Apr-12 09:41:19 by zmiller:</em> <br/>\n\nthe directory may end up owned by condor if for whatever reason the starter is killed while the sandbox is being staged in.  the reason for this is that in <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span> mode, the transfers are done as the condor user and then the sandbox is chowned to the real user.  hence, if it gets interrupted there, the directory will still be owned by condor.\n\n<p>i do not see any problem in adding condor to the target user list.  the switchboard can only be called by the condor user.  the condor user should be able to act on behalf of the condor user without any security implications.\n\n</p><p></p><hr/>\n<em>2013-Apr-12 10:00:15 by nwp:</em> <br/>\n\nIt looks like we don't have a default privsep config in the git tree.  Is that something that the CHTC admins create and is puppet-ized?\n\n<p></p><hr/>\n<em>2013-Apr-12 11:19:32 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> by zmiller\n\n<p>no major problems.  some comments:\n\n</p><p>MyString.cpp and filesystem_remap.cpp:\n<br/>\n\nthese changes were not related to the issue at hand, don't affect the meaning\nof the code, don't have any drastic improvement in performance, and don't\nnecessarily improve readability.  as such, i think this code should have been\nleft alone.\n\n</p><p>directory_util.cpp, lines 79 and 107:\n<br/>\n\nthe conditions (*filename) and (*subdir) are not needed.  null !=\nDIR_DELIM_CHAR so the loop will already abort when it encounters a null.\n\n</p><p>all other changes look good.  i do wonder if we should just add a function in\ncondor to compress slashes in pathnames, and then call that when we are done\nconcatenating paths rather than micro-manage each individual addition of them.\n\n</p><p></p><hr/>\n<em>2013-Apr-12 11:20:23 by moate:</em> <br/>\n\nWe currently puppetize the privsep configuration.  On a somewhat related note, it would be <strong>really</strong> nice if the HTCondor RPM created the execute directory with privsep-compatible permissions like so:\n\n<p>/var/lib/condor         0755 root:root\n/var/lib/condor/execute 0755 root:root\n\n</p><p>The permissions that the RPM creates those directories with currently allow world-readability, I believe.  A startd with privsep configured will not run when that is the case, and it has bitten us a few times (although puppet now handles this correctly).\n\n</p><p></p><hr/>\n<em>2013-Apr-12 11:43:33 by nwp:</em> <br/>\n\nIt looks like the problem is not actually fixed, as jobs are landing on the machine and failing with messages such as\n<div class=\"code\">\n<pre class=\"code\">04/12/13 11:32:25 ERROR \"CondorPrivSepHelper::initialize_sandbox: privsep_create_dir error on /var/lib/condor/execute/slot1/dir_17880\" at line 101 in file /slots/10/dir_10148/userdir/src/condor_starter.V6.1/condor_privsep_helper.UNIX.cpp\n04/12/13 11:32:25 ShutdownFast all jobs.\n04/12/13 11:32:25 ERROR \"Assertion ERROR on (m_sandbox_initialized)\" at line 164 in file /slots/10/dir_10148/userdir/src/condor_starter.V6.1/condor_privsep_helper.UNIX.cpp\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Apr-12 13:48:18 by nwp:</em> <br/>\n\nFixed this last one.  It turns out the starter assumes the switchboard had a problem if anything is written back from the switchboard.  Just had to update to latest version, taking out all the debug statements from the switchboard.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-16 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54661604655b25479fb0ac8bd4521d119d1dc4be\">[35411]</a></span>: edit of known bug version history item in 7.9.5 for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3573\" onclick=\"get_ticket_and_populate_wrapper('3573'); return false;\" title=\"Execute directories left behind when privsep is in use\">#3573</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-15 14:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/59275c84723c14fd15d805c0c1bd4f54c8d90f20\">[35408]</a></span>: minor edit of 7.9.6 version history item for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3573\" onclick=\"get_ticket_and_populate_wrapper('3573'); return false;\" title=\"Execute directories left behind when privsep is in use\">#3573</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-15 10:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1a4faf6f70cd4bf76c2f0991bc6837d5b8561717\">[35401]</a></span>: Add a known bug to version history <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3573\" onclick=\"get_ticket_and_populate_wrapper('3573'); return false;\" title=\"Execute directories left behind when privsep is in use\">#3573</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-12 16:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a6880de600bac9ca18743873589a9e3aa4a4611b\">[35399]</a></span>: Fix leaking directory problem under privsep <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3573\" onclick=\"get_ticket_and_populate_wrapper('3573'); return false;\" title=\"Execute directories left behind when privsep is in use\">#3573</a></span> Say exactly what we are trying to remove. We need to trim off the front of a string too, so that we do not get \"//\". Handle case where string has length 0 Incorporate changes from Zach's review Version history  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Apr-22 11:12", "status": "resolved", "created": "2013-Apr-12 09:15", "fixed_version": "2013-Apr-12 09:15", "broken_version": "v070905", "priority": "2", "subsystem": "Daemons", "assigned_to": "nwp", "derived_from": "", "creator": "nwp", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu moate@cs.wisc.edu nyehle@cs.wisc.edu zmiller@cs.wisc.edu johnkn@cs.wisc.edu", "due_date": ""}