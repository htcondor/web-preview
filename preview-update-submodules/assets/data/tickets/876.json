{"id": 876, "title": "Ticket #876: Changing NUM_SLOTS caused startds to EXCEPT", "description": "<blockquote>\nDuring a recent reconfiguration of some machines, NUM_SLOTS was changed to 1 (from undefined).  The machines had 2 CPUs and thus NUM_CPUS and NUM_SLOTS were autodetected as 2.  After receiving a reconfig, most or all of the startds went along their merry ways, but one EXCEPTed.  It should not have.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">10/21 13:38:43 Got SIGHUP.  Re-reading config files.\n10/21 13:38:43 History file rotation is enabled.\n10/21 13:38:43   Maximum history file size is: 20971520 bytes\n10/21 13:38:43   Number of rotated history files is: 2\n10/21 13:38:43 ERROR \"Assertion ERROR on (cur_type_index[t] == type_nums[t])\" at line 507 in file ResMgr.cpp\n10/21 13:38:43 slot1: Changing state and activity: Claimed/Busy -&gt; Preempting/Killing\n10/21 13:38:43 startd exiting because of fatal exception.\n</pre></div>\n\n\n<p>A longer extract of the log is attached.\n\n</p><p><span class=\"section\"></span></p><h2>Proposed solution</h2>\n\n<p>Added 2012-1-13.\n\n</p><p></p><ol>\n<li>Make this set of configuration settings require a restart. Ignore changes at runtime.  Be sure to document it. <a class=\"external\" href=\"http://research.cs.wisc.edu/condor/manual/v7.6/3_3Configuration.html#sec:Macros-Requiring-Restart\">Manual section in question</a>\n</li><li><span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=2766\" onclick=\"get_ticket_and_populate_wrapper('2766'); return false;\" title=\"Warn of restart-only config changes on reconfig\">#2766</a></span> When one or more of these settings change, emit a warning to the log.\n</li></ol>\n\n<p>configuration settings to ignore on reconfig:\n</p><ul>\n<li>NUM_SLOTS\n</li><li>NUM_CPUS (already done?)\n</li><li>NUM_SLOTS_TYPE_*</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2009-Oct-21 15:07:45 by adesmet:</em> <br/>\n\nAnother cluster with NUM_CPUS=8 was reconfiged with NUM_SLOTS=4.  Most or all of the cluster freaked out with errors like this:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">10/21 13:39:45 slot8: State change: WANT_HOLD is FALSE\n10/21 13:39:45 IPVERIFY: unable to resolve IP address of carnot.che.wisc.edu\n10/21 13:39:46 IPVERIFY: unable to resolve IP address of carnot.che.wisc.edu\n10/21 13:39:46 IPVERIFY: unable to resolve IP address of carnot.che.wisc.edu\n10/21 13:39:46 IPVERIFY: unable to resolve IP address of carnot.che.wisc.edu\n10/21 13:39:46 IPVERIFY: unable to resolve IP address of carnot.che.wisc.edu\n10/21 13:39:46 slot6: Got KILL_FRGN_JOB while in Preempting state, ignoring.\n10/21 13:39:46 slot4: Got KILL_FRGN_JOB while in Preempting state, ignoring.\n10/21 13:39:46 slot1: Got KILL_FRGN_JOB while in Preempting state, ignoring.\n10/21 13:39:46 Starter pid 11382 exited with status 0\n10/21 13:39:46 slot1: State change: starter exited\n10/21 13:39:46 slot1: Changing state and activity: Preempting/Vacating -&gt; Delete/Idle\n10/21 13:39:46 slot1: Resource no longer needed, deleting\n10/21 13:39:46 p&lt;AD&gt;E^D: State change: starter exited\n10/21 13:39:46 &lt;90&gt;ESC&lt;B5&gt;o;: Warning: starter exited while in unexpected state Unknown\n10/21 13:39:46 ERROR \"Unknown state in ResState::leave_action\" at line 560 in file ResState.cpp\n10/21 13:39:46 slot5: Changing state and activity: Claimed/Retiring -&gt; Preempting/Killing\n10/21 13:39:46 slot7: Changing state and activity: Claimed/Retiring -&gt; Preempting/Killing\n</pre></div>\n\n\n<p>The binary garbage where a slot should have been specified was present in all cases, although the exact garbage varied.\n\n</p><p>Matt F points out <a class=\"external\" href=\"https://bugzilla.redhat.com/show_bug.cgi?id=526847\">https://bugzilla.redhat.com/show_bug.cgi?id=526847</a> which may be related.\n</p><hr/>\n<em>2010-Aug-23 17:07:50 by adesmet:</em> <br/>\n\nBulk change of target version from v070402 to v070404 using ./ticket_target_mover.\n<hr/>\n<em>2010-Oct-27 16:39:01 by adesmet:</em> <br/>\n\nBulk change of target version from v070404 to v070405 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2011-Aug-16 14:39:51 by cweiss:</em> <br/>\n\nI have not been able to reproduce the problem in Condor 7.7.0. Therefore I am going to mark this ticket as \"deferred\" as nothing was actually actively resolved.\n\n<p></p><hr/>\n<em>2012-Jan-10 12:28:20 by adesmet:</em> <br/>\n\ncondor-support #8118 (LIGO) ran into this on 7.6.5.  I was able to reproduce.\n\n<p></p><hr/>\n<em>2012-Jan-10 13:18:44 by adesmet:</em> <br/>\n\nReproduced on 7.7.4.\n\n<p></p><hr/>\n<em>2012-Jan-10 15:29:29 by adesmet:</em> <br/>\n\nResState::enter_action calls ResMgr::deleteResource which calls ResMgr::removeResource which calls Resource::~Resource whichs deletes the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResState\" title=\"Res State\">ResState</a></span> at the start of the chain. As we pop back up the call stack, when we get back to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResState\" title=\"Res State\">ResState</a></span>, we're inside of a deleted object.\n\n<p>Full call stack:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#2  0x001c0fe1 in operator delete(void*) () from /usr/lib/libstdc++.so.6\n#3  0x0812552f in Resource::~Resource (this=0x85ca208, __in_chrg=&lt;value optimized out&gt;)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/Resource.cpp:190\n#4  0x0812df05 in ResMgr::removeResource (this=0x85c1bd0, rip=0x85ca208)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/ResMgr.cpp:1926\n#5  0x0812e18a in ResMgr::deleteResource (this=0x85c1bd0, rip=0x85ca208)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/ResMgr.cpp:1935\n#6  0x0812c00b in ResState::enter_action (this=0x85ca3b0, s=delete_state, a=idle_act, statechange=true)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/ResState.cpp:808\n#7  0x0812b2de in ResState::change (this=0x85ca3b0, new_state=delete_state, new_act=idle_act)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/ResState.cpp:139\n#8  0x0812b3fe in ResState::change (this=0x85ca3b0, new_state=delete_state)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/ResState.cpp:193\n#9  0x0812b595 in ResState::starterExited (this=0x85ca3b0)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/ResState.cpp:943\n#10 0x081247ee in Resource::starterExited (this=0x85ca208, cur_claim=0x85ca408)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/Resource.cpp:652\n#11 0x0813df3a in Claim::starterExited (this=0x85ca408, status=0)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/claim.cpp:1390\n#12 0x0815766a in reaper (pid=4069, status=0)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_startd.V6/startd_main.cpp:742\n#13 0x08161778 in DaemonCore::CallReaper (this=0x859c618, reaper_id=5, whatexited=0x84926e3 \"pid\", pid=4069,\n    exit_status=0) at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_daemon_core.V6/daemon_core.cpp:9625\n#14 0x0816997d in DaemonCore::HandleProcessExit (this=0x859c618, pid=4069, exit_status=0)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_daemon_core.V6/daemon_core.cpp:9729\n#15 0x08169b39 in DaemonCore::HandleDC_SERVICEWAITPIDS (this=0x859c618)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_daemon_core.V6/daemon_core.cpp:9291\n#16 0x081621ee in DaemonCore::Driver (this=0x859c618)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_daemon_core.V6/daemon_core.cpp:3078\n#17 0x0817e200 in main (argc=1, argv=0xbfffe598)\n    at /u/a/d/adesmet/scratch/CONDOR_SRC/src/condor_daemon_core.V6/daemon_core_main.cpp:2377\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Jan-11 11:08:17 by adesmet:</em> <br/>\n\nHow I reproduced support #8118:\n\n<p></p><ol>\n<li>Take a \"stock\" install (condor_install --make-personal-condor)\n</li><li>Modify the local configuration file with:\n<div class=\"code\">\n<pre class=\"code\">NUM_CPUS = 4\nSTART=TRUE\nSTOP=FALSE\nPREEMPT= FALSE\nKILL=FALSE\nSUSPEND=FALSE\nRELEASE=TRUE\n</pre></div>\n\n</li><li>Submit some sleep jobs\n<div class=\"code\">\n<pre class=\"code\">universe=vanilla\nexecutable=/bin/sleep\narguments=600\nnotification=never\nwhen_to_transfer_output=on_exit\nshould_transfer_files = yes\noutput=eraseme.$(Cluster).$(Process).out\nerror=eraseme.$(Cluster).$(Process).err\nlog=eraseme.$(Cluster).log\nqueue 8\n</pre></div>\n\n</li><li>Once all 4 slots are running, add the following to the local configuration:\n<div class=\"code\">\n<pre class=\"code\">SLOT_TYPE_1 = cpu=1, mem=2000, disk=1/8\nNUM_SLOTS_TYPE_1 = 1\n</pre></div>\n\n</li><li>condor_reconfig\n</li></ol>\n\n<p>Observe crash.\n</p><hr/>\n<em>2012-Oct-22 14:58:32 by zmiller:</em> <br/>\n\nBulk change of target version from v070901 to v070902 using ./ticket-target-mover.\n<hr/>\n<em>2012-Dec-11 16:35:11 by johnkn:</em> <br/>\n\nBulk change of target version from v070902 to v070903 using ./ticket-target-mover.\n<hr/>\n<em>2013-Jan-22 10:54:51 by johnkn:</em> <br/>\n\nBulk change of target version from v070903 to v070904 using ./ticket-target-mover.\n<hr/>\n<em>2013-Mar-05 10:58:27 by johnkn:</em> <br/>\n\nBulk change of target version from v070904 to v070905 using ./ticket-target-mover.\n<hr/>\n<em>2013-Apr-22 11:10:10 by johnkn:</em> <br/>\n\nBulk change of target version from v070905 to v070906 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/119/StartLog\">StartLog</a>\n8760 bytes added by adesmet on 2009-Oct-21 19:43:53 UTC.\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-11 13:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37e7866e18a845661052ebc7f9b19a2983f31abb\">[29069]</a></span>: Add a bit more information in the log message for a \"can't happen\" exception. Added information I wished I had when I ran into this exact can't happen situation while investigating <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=876\" onclick=\"get_ticket_and_populate_wrapper('876'); return false;\" title=\"Changing NUM_SLOTS caused startds to EXCEPT\">#876</a></span>. This will only show up if everything has gone wrong. It's not really user facing, so no version history entry.  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Apr-22 11:10", "status": "new", "created": "2009-Oct-21 14:43", "fixed_version": "2009-Oct-21 14:43", "broken_version": "v070700", "priority": "2", "subsystem": "Daemons", "assigned_to": "johnkn", "derived_from": "", "creator": "adesmet", "rust": "s8118", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20110817"}