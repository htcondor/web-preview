{"id": 1282, "title": "Ticket #1282: update defaults and minimize condor_config(s)", "description": "<blockquote>\n<span class=\"subsection\"><h3>Goals + Motivations</h3></span>\n<ul>\n<li>Minimize condor_config files, two primary purposes:\n<ul>\n<li>condor_config is overly complex, and most users don't care about 90% of it.\n</li><li>Each param which exists in a file causes a malloc.  Increases shadow memory bloat.\n</li></ul>\n</li><li>Auto generate defaults for windows baked into the code, reduce need for installer mundging\n<ul>\n<li>Provide a single definitive source for default values.\n</li></ul>\n</li><li>Provide a file which can be easily consumed by other tools and 3rd parties.\n<ul>\n<li>Easy to read and parse.\n</li></ul>\n</li><li>General cleanup work for outdated or non-existent params.\n</li></ul>\n\n<p><strong>THE FOLLOWING ARE NOT GOALS</strong>\n</p><ul>\n<li>This does not touch the config system in any way.\n</li></ul>\n\n<p><span class=\"subsection\"></span></p><h3>Proposed Solution</h3>\n\n<p>A very simple file format with easy platX &amp; langX parse capabilities is .json, by trimming the cruft from the original param table + enabling arrays around defaults we can easily meet the above requirements.\n\n</p><p>e.g. params.json -&gt; mini-exec -&gt; param_info_init.c\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">{\n  \"defaults\": [\n        {\n            \"name\": \"%s_ENVIRONMENT\",\n            \"nsprintf\": [\"MASTER\", \"COLLECTOR\"],\n            \"type\":\"string\",\n            \"range\":\"*\",\n            \"value\": [ \"NIX\", \"WIN\" ],\n            \"description\" : \"Changes to the daemon environment.\",\n            \"restart\": \"false\"\n        }\n\n    ]\n}\n</pre></div>\n\n\n<p><span class=\"subsection\"></span></p><h3>Milestones </h3>\n<ul>\n<li>raw convert + prune <strong>[DONE - this ticket]</strong>\n</li><li>Shift condor_config entries into defaults <strong>[NEEDS NEW TICKET]</strong>\n</li><li>Address BrianB's Q-re: memory utilization of the param table generation <strong>[NEEDS NEW TICKET]</strong>\n</li></ul>\n\n<p><span class=\"subsection\"></span></p><h3>Testing </h3>\nVerifying the behavior is quite easy, because you can compare the output (param_info_init.c) before&lt;-&gt;after</blockquote>", "remarks": "<blockquote>\n<em>2011-Jun-03 15:24:38 by tstclair:</em> <br/>\n\ninput solicited on format.\n\n<p></p><hr/>\n<em>2011-Jun-06 10:19:02 by willb:</em> <br/>\n\nThe \"range\" attribute is IMHO essential.  But I think it should be a structured value, so we could do things like\n\n<p></p><ul>\n<li><code>{\"type\":\"inclusive-range\", \"limits\":[0,100]}</code>\n</li><li><code>{\"type\":\"enum\", \"values\":[\"foo\", \"bar\", \"etc\"]}</code>\n</li><li><code>{\"type\":\"regex\", \"pattern\":\"/(foo|bar)*/\"}</code>\n</li></ul>\n\n<p>and so on.\n\n</p><p>In places where it's possible to do so, we should have subsystem annotations like in Wallaby.  (In the future. we could infer this automatically in many cases as part of the build process.)\n\n</p><p>I think the right way to handle dynamically-named params is probably with param hashes or something similar (as psilord and I proposed).  But we could maybe also have the param name be a regular expression and have it bind variables that appear in the metadata body, something like this:\n\n</p><p></p><pre>    { \"param_table\": [\n    \t{\n    \t\t\"name\": [\"regexp\", \"([A-Z]+)\\\\.BOGON_FILTER\"],\n    \t\t\"type\": \"string\",\n    \t\t\"description\" : \"Path to the bogon filter for the $1 subsystem\",\n    \t\t\"restart\": [\"if\", [\"==\", \"$1\", \"MASTER\"], \"true\", \"false\"]\n    \t}\n</pre>\n\n<p></p><pre>    ] }\n</pre>\n\n<p>(Note that I'm imagining static conditionals based on a particular match as well.  Perhaps this is too ambitious.)\n\n</p><p>It's not clear to me what the \"default\" value does in the above example.\n\n</p><p>Minor nit:  prefer \"json\" to \"jason\" in order to have editor support without configuration.\n\n</p><p></p><hr/>\n<em>2011-Jun-06 10:52:37 by tstclair:</em> <br/>\n\ndamn you spell checker!  8oP\n\n<p></p><hr/>\n<em>2011-Jun-06 10:59:00 by tstclair:</em> <br/>\n\nThe defaults are just placeholders for the real system defaults..\n\n<p>e.g. condor_config.generic\n\n</p><p>for parameters.  By providing defaults for the different flavors, we can elim the special magic inside of the windows installer + tests + a few other places within the code.\n\n</p><p></p><hr/>\n<em>2011-Jun-06 11:58:18 by willb:</em> <br/>\n\nSo defaults could be a map from OS (or pairs of OS/Arch, but arch is less and less relevant these days) to value?\n\n<p></p><hr/>\n<em>2012-Sep-26 17:08:45 by eje:</em> <br/>\n\nIs there a proposed scheme or tool for translating the json abstract syntax tree into the param_info.cpp, or wallaby db?\n\n<p></p><hr/>\n<em>2012-Sep-26 18:00:30 by eje:</em> <br/>\n\nIf we use this kind of scheme (which I like):\n\n<p></p><div class=\"code\">\n<pre class=\"code\">\"name\": [\"regexp\", \"([A-Z]+)\\\\.BOGON_FILTER\"]</pre></div>\n\n\n<p>It might require that we do param look-up via a linear search:  \"find the first regexp that matches the query name\"\n\n</p><p>An alternative would be to compile everything into a giant composed FSA that maps input into first matching, in linear time by following the FSA.  That would be some effort.\n\n</p><p></p><hr/>\n<em>2012-Sep-27 09:59:04 by tstclair:</em> <br/>\n\nUber simple python or perl app can parse the .json and spew .cpp\n\n<p></p><hr/>\n<em>2012-Oct-04 09:35:23 by bbockelm:</em> <br/>\n\nWhen doing this work, we should recall that we just went through a large amount of headache to generate code which goes into the \"read-only\" section of the shared lib, instead of the uninitialized-data section.\n\n<p>While implementing, make sure to look at the resulting binaries with \"nm\" and make sure all the param-related symbols are listed as \"R\".\n\n</p><p>Contact me if you don't know how to check for this, and I'll try to dredge up more useful tips from my memory.\n\n</p><p></p><hr/>\n<em>2012-Oct-15 16:21:33 by tstclair:</em> <br/>\n\nI'm actually finding a fair number of what I would consider to be bugs in the old generated stuff.\n\n<p></p><hr/>\n<em>2012-Oct-15 18:12:14 by bbockelm:</em> <br/>\n\nSure, I believe there are bugs.  I just want to make sure we don't regress on the linked library issue while fixing them.\n\n<p></p><hr/>\n<em>2012-Nov-30 12:44:33 by rrati:</em> <br/>\n\nWhile we're at it, it would be nice to be able to group parameters into logical \"features\" with sane default values.  This would make it much easier to know which parameters affect which bits of condor as well as ease pool setup and modifications.\n<hr/>\n<em>2012-Dec-11 16:37:45 by johnkn:</em> <br/>\n\nBulk change of target version from v070902 to v070903 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2015-Aug-01 20:31:33 by bbockelm:</em> <br/>\n\nThis appears to be abandoned.  Marking as such.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1278\" onclick=\"get_ticket_and_populate_wrapper('1278'); return false;\" title=\"Create process check for .exe on file not found\">#1278</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCreate process check for .exe on file not found</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1283\" onclick=\"get_ticket_and_populate_wrapper('1283'); return false;\" title=\"Windows script check when creating a process\">#1283</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nWindows script check when creating a process</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=2293\" onclick=\"get_ticket_and_populate_wrapper('2293'); return false;\" title=\"param system can't specify default-over-null\">#2293</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nparam system can't specify default-over-null</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-19 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d8397d7cccafc3d7cf4e77c2fa7637b0ab6ee81b\">[33709]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> F17 warning removal.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-18 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55ef3ef01bbcd23d2f93227264c2bd55c5bea360\">[33698]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> revert update  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-17 14:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbe3f23af941cfc11e9689ed3e691c06c5f4ed3d\">[33689]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> Cleanup work  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-08 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2873163fd23c2f3fd8205dc24e7b067f77cd1714\">[33600]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> fstream symantic differences which caused failures on older system, switched to ifstream for generator  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-05 15:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0832c7d6526d15a791f66f8fb38c8a6f396113bf\">[33598]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> It all builds with new json &amp; c++ generator, now onto windows.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-02 10:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0723286564e5e4578e8ce00ea923e5f6aeb32ce2\">[33551]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> Transform of the default table to json with quill pruning.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-01 10:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b06320615bc297cbbe4cfdc5afe40f0b8c393c0c\">[33547]</a></span>: Ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1282\" onclick=\"get_ticket_and_populate_wrapper('1282'); return false;\" title=\"update defaults and minimize condor_config(s)\">#1282</a></span> Initial commit to put in place a new .json generator for platX defaults.  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Aug-01 20:31", "status": "abandoned", "created": "2010-Mar-16 22:10", "fixed_version": "2010-Mar-16 22:10", "broken_version": "v070400", "priority": "3", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "#2961", "creator": "tstclair", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com, willb@redhat.com, eje@cs.wisc.edu, tannenba.cs.wisc.edu, johnkn@cs.wisc.edu", "due_date": "PARENT"}