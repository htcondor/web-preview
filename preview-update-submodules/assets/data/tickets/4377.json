{"id": 4377, "title": "Ticket #4377: DNS query while holding event log lock is bad", "description": "<blockquote>\nWhen writing the job execute event to the job event logs, we call gethostbyaddr() to convert the IP address of the executing machine into a hostname. This can be a blocking network operation that can take many seconds to complete. We do this while holding the lock on the event log file. This is a bad combination.\n\n<p>On a LIGO submit machine, we've observed gethostbyaddr() take 5 seconds to complete. With hundreds of shadows attempting to write to the same user job log, we saw shadows taking multiple hours to acquire the lock on the file before writing their events. In the meantime, their starters timed out while waiting for responses to their RPCs and aborted job execution.\n\n</p><p>The call to gethostbyaddr() occurs in ExecuteEvent::writeEvent().\nOriginally, this call was used to report the execute hostname in the Quill log of events. Later, the Quill code was changed so that the upper layer provided the name to record via the ExecuteEvent::setRemoteName() method. But the gethostbyaddr() was kept for a dprintf(). The dprintf() should use the name given in setRemoteName() and the gethostbyaddr() call should be removed.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-May-27 16:13:42 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-30 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb8b29fa06087d5db8249e1bf78d37a48f44feb9\">[40289]</a></span>: Version history for DNS query while writing execute event. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4377\" onclick=\"get_ticket_and_populate_wrapper('4377'); return false;\" title=\"DNS query while holding event log lock is bad\">#4377</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-27 15:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2c1e1dd10db0ab2571f974fa737d15354153aaba\">[40229]</a></span>: Don't use DNS while holding the event log lock. <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=4377\" onclick=\"get_ticket_and_populate_wrapper('4377'); return false;\" title=\"DNS query while holding event log lock is bad\">#4377</a></span> While writing the execute event (and holding the lock on the file), we were calling gethostbyaddr() to convert the IP address of the stard to a hostname. This is bad because gethostbyaddr() can block for many seconds. Instead, we can use the remoteName\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-May-30 16:10", "status": "defer", "created": "2014-May-27 15:35", "fixed_version": "2014-May-27 15:35", "broken_version": "v080000", "priority": "5", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "gthain@cs.wisc.edu,tlmiller@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}