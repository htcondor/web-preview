{"id": 4491, "title": "Ticket #4491: Scalable claim keepalive protocol", "description": "<blockquote>\nThe current claim keepalive protocol necessitates a new TCP connection from startd to schedd every 5 minutes.\n\n<p>While the startd has a live starter, we should have the keepalives go from starter to shadow over the existing TCP connection.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Aug-12 14:26:28 by tannenba:</em> <br/>\n\nLooking at daemon core statistics, it looks like 45%+ of all incoming connections to the schedd are due to claim keepalives (!!!).\n\n<p></p><pre>   C:\\home\\tannenba&gt;condor_status -pool glidein-collector.t2.ucsd.edu -schedd -statistics dc:2 -direct submit-6.t2.ucsd.edu -format %d \"100*DCCommand_ALIVE/DCCommands\" -format \"%% of commands were claim alives, schedd running for %s\\n\" \"interval(MonitorSelfAge)\"\n</pre>\n\n<p></p><pre>   43% of commands were claim alives, schedd running for 17+11:36:18\n</pre>\n\n<p>When you consider that shadow communications to the schedd do not go through the shared_port, it likely means that 90%+ of incoming connections to the shared_port are claim keepalives!\n\n</p><p></p><hr/>\n<em>2014-Aug-12 17:42:36 by johnkn:</em> <br/>\n\nhere's a simple perl script that reads a file containing DC stats attributes and prints a table\nif you save this as dc_stats.cmd it will work in windows also\n\n<p></p><div class=\"code\">\n<pre class=\"code\">@rem=' print DC stats as a table\n@c:\\perl\\bin\\perl.exe \"%~f0\" %*\n@goto :EOF ';\n#!/usr/bin/env perl\n\nmy $file = $ARGV[0];\n\nmy %attrs;\nmy %attrs_rt;\n\nopen FH, $file or die \"could not open $file - $!\";\nwhile (&lt;FH&gt;) {\n   # print $_;\n   if ($_ =~ /^([a-zA-Z_]*) = (.*)/) {\n      my $attr = $1;\n      my $val = $2;\n      $attrs{$attr} = $val;\n      if ($attr =~ /Runtime$/) {\n         my $tag = $attr;\n         $tag =~ s/Runtime$//;\n         $attrs_rt{$tag} = $val;\n      }\n   }\n}\n\n      #1234567890 1234567890 12345678\nprint '     Calls    Runtime Sec/Call  Attribute' . \"\\n\";\nfor my $key (sort(keys(%attrs_rt))) {\n    my $rt = $attrs_rt{$key};\n    my $num = $attrs{$key};\n    my $sec_per = 0; if ($num) { $sec_per = $rt / $num; }\n    printf \"%10s %10.3f %8.3f  %s\\n\", $num, $rt, $sec_per, $key;\n}\n</pre></div>\n\n\n<p></p><hr/>\n<em>2014-Oct-29 10:23:54 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Only looking at the dedicated scheduler code, the keep alive code looks good here.  I've tested some simple scenarios which work correctly with the new code paths.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4807\" onclick=\"get_ticket_and_populate_wrapper('4807'); return false;\" title=\"Startd slots stuck in Preemtping/Killing state forever\">#4807</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nStartd slots stuck in Preemtping/Killing state forever</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6597\" onclick=\"get_ticket_and_populate_wrapper('6597'); return false;\" title=\"Slots can become stuck in Claimed/Busy forever after a job completes\">#6597</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSlots can become stuck in Claimed/Busy forever after a job completes</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/848/dcruntime.cmd\">dcruntime.cmd</a>\n9279 bytes added by johnkn on 2014-Oct-10 22:26:02 UTC.\n<br/>\nA better perl script for displaying DC and Schedd runtime stats as a table.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-22 18:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/de84a4ee7e201e92b5a7d98322945d9d6e37754e\">[42020]</a></span>: Edit existing 8.3.2 version history items for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4603\" onclick=\"get_ticket_and_populate_wrapper('4603'); return false;\" title=\"DAEMON_SOCKET_DIR=auto breaks partial use of shared port\">#4603</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4657\" onclick=\"get_ticket_and_populate_wrapper('4657'); return false;\" title=\"Support EC2 block-device mapping.\">#4657</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4660\" onclick=\"get_ticket_and_populate_wrapper('4660'); return false;\" title=\"Add sub-second accurate timestamps to dprintf logs\">#4660</a></span>. Add new version history items for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=374\" onclick=\"get_ticket_and_populate_wrapper('374'); return false;\" title=\"dlopen Kerberos\">#374</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4735\" onclick=\"get_ticket_and_populate_wrapper('4735'); return false;\" title=\"Speed up V3 query protocol\">#4735</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4594\" onclick=\"get_ticket_and_populate_wrapper('4594'); return false;\" title=\"Fix time-slicing for ClassAd iterator\">#4594</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4491\" onclick=\"get_ticket_and_populate_wrapper('4491'); return false;\" title=\"Scalable claim keepalive protocol\">#4491</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4585\" onclick=\"get_ticket_and_populate_wrapper('4585'); return false;\" title=\"Detect SO version of libraries we dlopen() at compile time\">#4585</a></span>.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-28 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0fcc38c02f98524ff1b0b5aa9088e28b79f0737d\">[41503]</a></span>: Only send slot keepalives when there is no starter. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4491\" onclick=\"get_ticket_and_populate_wrapper('4491'); return false;\" title=\"Scalable claim keepalive protocol\">#4491</a></span> Previously, the startd would constantly connect to the schedd to send alive messages on the claim. Now if knob STARTER_HANDLES_ALIVES is True in the schedd (the default), the slot lease is automatically renewed while a starter/shadow exists, thus\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Dec-23 16:33", "status": "resolved", "created": "2014-Jul-29 08:16", "fixed_version": "2014-Jul-29 08:16", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "tannenba", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, isfiligoi@ucsd.edu", "due_date": ""}