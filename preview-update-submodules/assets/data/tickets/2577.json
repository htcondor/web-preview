{"id": 2577, "title": "Ticket #2577: held job is removed from the queue", "description": "<blockquote>\nIn 7.7.2, when a running job is held with condor_hold, and if a starter update is received before the job goes away, the job's status is changed from held to running.  If the job then exits on its own, this causes the job to leave the queue rather than to stay in the held state.\n\n<p>I was able to produce this effect by overriding the hard-kill signal by setting kill_sig in the job submit file and making the job ignore this signal.  I believe the race condition could happen even when kill_sig is not overridden, but the window of opportunity would be smaller.\n\n</p><p>In 7.7.1, when the shadow receives the update from the starter, the job's status in the queue stays as held rather than switching to running.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Oct-25 13:08:47 by danb:</em> <br/>\n\nI have found that the bug is old but it only became visible as of 7.7.2, commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9e94ba70784155f83c87f88006f661aa642ded6f\">[26910]</a></span> for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2368\" onclick=\"get_ticket_and_populate_wrapper('2368'); return false;\" title=\"[RFE] add support for condor_suspend &amp;&amp; condor_continue\">#2368</a></span>.  The old bug goes back to at least 7.6, probably earlier.\n\n<p>The bug: Once deactivation has been initiated, if the shadow receives a job ad update, recordResumeEvent() is called, because the state of the \"remoteresource\" transitions from FINISHED back to EXECUTING.  This results in an unsuspend event being logged to the user log, even though the job was not suspended.\n\n</p><p>As of 7.7.2, the function recordResumeEvent() sets the job status to running.  This is overwriting the hold status.  Arguably, this is the correct behavior for this function, but this function is called some times when it should not be, so this new behavior causes trouble.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 13:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/abfbb144fd10ce1462d964157078808a50e6c4b6\">[27979]</a></span>: Added ticket number to version history item. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2577\" onclick=\"get_ticket_and_populate_wrapper('2577'); return false;\" title=\"held job is removed from the queue\">#2577</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 13:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9d90fe21a9f389c7469d4a4095740edc0ac6d536\">[27978]</a></span>: Documented fix for race condition when putting jobs on hold. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2577\" onclick=\"get_ticket_and_populate_wrapper('2577'); return false;\" title=\"held job is removed from the queue\">#2577</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-25 13:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/40c1cef98bed1fc1fb6e3c0401701f4cc1c72bc0\">[27977]</a></span>: Fix race condition when putting running jobs on hold. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2577\" onclick=\"get_ticket_and_populate_wrapper('2577'); return false;\" title=\"held job is removed from the queue\">#2577</a></span> After running condor_hold, a job update received by the shadow after requesting a deactivation but before the job was evicted would cause the job to change from the held state to the running state. Then when the job was finally evicted, the\u00a0[...]\n (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-03 08:56", "status": "resolved", "created": "2011-Oct-24 18:11", "fixed_version": "2011-Oct-24 18:11", "broken_version": "v070702", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": "20111025"}