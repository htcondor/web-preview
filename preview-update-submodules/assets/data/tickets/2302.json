{"id": 2302, "title": "Ticket #2302: authentication timeouts in glidein schedd", "description": "<blockquote>\nThe schedd on submit-2.t2.ucsd.edu experienced performance problems caused by 20s timeouts when trying to establish new security sessions with startds.\n\n<p></p><div class=\"verbatim\">\n<pre>07/13/11 13:25:55 (pid:19461) Shadow pid 4172 for job 197951.47 exited with status 107\n07/13/11 13:25:55 (pid:19461) Match record (glidein_16204@heplnc145.pp.rl.ac.uk &lt;130.246.45.145:36623?CCBID=169.228.130.23:9787#51539&amp;noUDP&gt; for uscms1766, 197951.47) deleted\n07/13/11 13:26:05 (pid:19461) DC_AUTHENTICATE: required authentication of 128.120.80.17 failed: AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using GSI|GSI:5005:Failed t\no authenticate with client.  Client does not trust our certificate.  You may want to check the GSI_DAEMON_NAME in the condor_config|GSI:5004:Failed to gss_assist_gridmap /DC=org/DC=doegrids/OU=Services/CN=uscmspilot09/glidein-1.t2.ucsd.edu to a local user.  Check the grid-mapfile.\n07/13/11 13:26:05 (pid:19461) CCBClient: deadline expired for reverse connection to startd at &lt;10.11.1.221:49979&gt;.\n 07/13/11 13:26:05 (pid:19461) Failed to send RELEASE_CLAIM to startd at &lt;10.11.1.221:49979&gt;: CEDAR:6008:deadline expired|SECMAN:2003:deadline for connection to startd at &lt;10.11.1.221:49979&gt; has expired.\n</pre></div>\n\n\n<p>Note that the RELEASE_CLAIM message doesn't provide very useful information about which startd it is trying to talk to.  This should be improved.\n\n</p><p>Normally, all communication between the schedd and startd happens via match password security sessions, so GSI should not be necessary.  However, Condor falls back to creating a new security session if anything goes wrong with the creation of the match password session.\n\n</p><p>Some attempts to create match password security sessions are failing.  This is due to pre-existing entries in the session cache, based on the following log:\n\n</p><p></p><div class=\"verbatim\">\n<pre>07/13/11 14:32:40 (pid:19461) SECMAN: failed to create session &lt;10.1.3.72:58072&gt;#1310575699#5.\n07/13/11 14:32:40 (pid:19461) SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION: failed to create security session for &lt;10.1.3.72:58072&gt;#1310575699#5#\n..., so will try to obtain a new security session\n</pre></div>\n\n\n<p>Why would the session already exist in the cache?  Hash key collision?  Reuse of the same claim id?  (When a match is deleted the old session is kept around for 10 minutes, so there is a 10 minute window in which reuse of the same claim id would collide.)  More information needs to be added to the log when a collision occurs in order to diagnose the problem.\n\n</p><p>It may be a good idea to have a mode in which the match password session is not optional.  This would prevent the fallback to potentially performance-killing authentication protocols.\n\n</p><p>In the mean time, I have recommended a much smaller timeout during authentication with a setting such as this:\n\n</p><p>SEC_CLIENT_AUTHENTICATION_TIMEOUT = 5</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Jul-14 12:02:47 by danb:</em> <br/>\n\nI have fixed the only case that I am aware of that could explain the failure to create the match password session.  I have also improved logging so that if there is some other remaining problem, it will be easier to diagnose.  I am going to resolve this ticket until we find evidence that there is still a problem.\n\n<p></p><hr/>\n<em>2011-Jul-14 16:47:07 by danb:</em> <br/>\n\nI originally made the fix for the SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION failure in master branch (7.7.1), but Igor said it was important to have this in 7.6, so I have put the fix in V7_6-branch (7.6.3).</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-14 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd4f635b71e60f63db611f0d483df513dcdfc111\">[22516]</a></span>: Improved handling of match password session expiration. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2302\" onclick=\"get_ticket_and_populate_wrapper('2302'); return false;\" title=\"authentication timeouts in glidein schedd\">#2302</a></span> ===VersionHistory=== Fixed a case in which SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION failed in the schedd. The failure happened when the schedd failed to claim a slot and then the negotiator gave the schedd a new match to the same\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-14 11:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/385408f592c7b8fbc70eb81003271dcfe0169749\">[22511]</a></span>: Improved handling of match password session expiration. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2302\" onclick=\"get_ticket_and_populate_wrapper('2302'); return false;\" title=\"authentication timeouts in glidein schedd\">#2302</a></span> ===VersionHistory=== Fixed a case in which SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION failed in the schedd. The failure happened when the schedd failed to claim a slot and then the negotiator gave the schedd a new match to the same\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-13 17:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aa75e3a880b5b9a5c8610d4e2efeb02f5fb44391\">[22498]</a></span>: Improved logging when sending RELEASE_CLAIM to the startd. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2302\" onclick=\"get_ticket_and_populate_wrapper('2302'); return false;\" title=\"authentication timeouts in glidein schedd\">#2302</a></span> ===VersionHistory=== The name of the slot is now logged when the condor_schedd logs messages about attempts to send the RELEASE_CLAIM command to the condor_startd. Committer: Alan De Smet  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-13 17:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/45091c2c237433d3ac0dbd38d66f787e408072df\">[22490]</a></span>: Improved logging when sending RELEASE_CLAIM to the startd. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2302\" onclick=\"get_ticket_and_populate_wrapper('2302'); return false;\" title=\"authentication timeouts in glidein schedd\">#2302</a></span> ===VersionHistory=== The name of the slot is now logged when the condor_schedd logs messages about attempts to send the RELEASE_CLAIM command to the condor_startd.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-04 15:03", "status": "resolved", "created": "2011-Jul-13 17:20", "fixed_version": "2011-Jul-13 17:20", "broken_version": "v070600", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu,sfiligoi@fnal.gov", "due_date": ""}