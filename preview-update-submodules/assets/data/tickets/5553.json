{"id": 5553, "title": "Ticket #5553: 1 minute startup block if DNS record missing", "description": "<blockquote>\nWhen any HTCondor program starts, be it daemon or command line tool, it does a DNS lookup on our best guess for a hostname. It's trying to find a fully qualified domain name as well as an IP address.  However, if the lookup fails <em>for any reason</em> we will retry every 3 seconds for up to 1 minute. The program blocks during this period. This is particularly noticeable on command line tools. The code always run as it provides configuration variables like IP_ADDRESS, which may be necessary to correctly interpret the configuration file.\n\n<p>The unwanted behavior appears in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/88c1a0005e224738c5f1ee6beeacda17a7529cd1\">[37747]</a></span> 8c1a0005e224738c5f1ee6beeacda17a7529cd1 as a fix for \"<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3956\" onclick=\"get_ticket_and_populate_wrapper('3956'); return false;\" title=\"some schedd ads have a blank Name attr, make malformed GlobalJobIds\">#3956</a></span>: some schedd ads have a blank Name attr, make malformed <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GlobalJobIds\" title=\"Global Job Ids\">GlobalJobIds</a></span>\".  The code in question has been completely rewritten, but the behavior was carefully preserved.  It's in init_local_hostname_impl in <a class=\"file\" href=\"rlog?f=src/condor_utils/ipv6_hostname.cpp\">/src/condor_utils/ipv6_hostname.cpp</a>, around line 117.  Look for \"SLEEP_DUR = 3\".\n\n</p><p>The original commit (88c1a) was trying intended to retry <em>only</em> for EAI_AGAIN. That is likely correct behavior.  However, it will retry even for permanent errors (say,  EAI_NONAME).\n\n</p><p>Proposed fix: immediately after this code:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">int ret = ipv6_getaddrinfo(test_hostname.Value(), NULL, ai, hint);\nif(ret == 0) { gai_success = true; break; }\n</pre></div>\n\n\n<p>Add something like\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">if(ret != EAI_AGAIN) {\n\tgai_success = false;\n\tdprintf(...) // Details about the error returned and note about failure.\n\tbreak;\n}\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Mar-15 15:29:53 by adesmet:</em> <br/>\n\n<strong>Code review: Approved</strong></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-14 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ec8f31e4811b9129c60f4635e5bad23276364274\">[47729]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5553\" onclick=\"get_ticket_and_populate_wrapper('5553'); return false;\" title=\"1 minute startup block if DNS record missing\">#5553</a></span>) Version history item.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-14 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3283a6aaabf512464e529202366d83a43336ba13\">[47728]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5553\" onclick=\"get_ticket_and_populate_wrapper('5553'); return false;\" title=\"1 minute startup block if DNS record missing\">#5553</a></span>) Only retry DNS lookups when we're supposed to (EAI_AGAIN).  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Mar-15 15:30", "status": "resolved", "created": "2016-Mar-08 17:13", "fixed_version": "2016-Mar-08 17:13", "broken_version": "v080004", "priority": "4", "subsystem": "Libs", "assigned_to": "tlmiller", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu,bbockelm@cse.unl.edu", "due_date": ""}