{"id": 6629, "title": "Ticket #6629: condor_annex fails when uploading config files to us-east-2", "description": "<blockquote>\nHeath Skarlupka reports from <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=IceCube\" title=\"Ice Cube\">IceCube</a></span>:\n\n<p></p><div class=\"verbatim\">\n<pre>condor_annex -aws-spot-fleet -slots 1 \\\n    -aws-spot-fleet-config-file /home/annex/spot_fleet_configs/us-east-2.json \\\n    -config-dir /home/annex/condor_configs -annex-name ohio -duration 1 -no-owner \\\n    -aws-ec2-url https://ec2.us-east-2.amazonaws.com \\\n    -aws-events-url https://events.us-east-2.amazonaws.com \\\n    -aws-lambda-url https://lambda.us-east-2.amazonaws.com \\\n    -aws-s3-url https://s3.us-east-2.amazonaws.com\n...\nUpload failed: 'E_HTTP_RESPONSE_NOT_200 (400)' (1): '&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\\n&lt;Error&gt;\n<code>AuthorizationHeaderMalformed</code>&lt;Message&gt;The authorization header is malformed; the region\n'us-east-1' is wrong; expecting 'us-east-2'&lt;/Message&gt;\n&lt;Region&gt;us-east-2&lt;/Region&gt;&lt;RequestId&gt;3C44D45A17C4119F&lt;/RequestId&gt;&lt;HostId&gt;wgvQ3M4Wl4fDq7ci1zNQK2734JuF5eF7NlJ2Krday9ySIDnrLliyIxmixxDr6euSYHQ+0mPoARc=&lt;/HostId&gt;&lt;/Error&gt;'.\n</pre></div>\n\n\n<p>The problem is that the 'region' value (used only by the security code) is wrongly always set to 'us-east-1' for S3 uploads.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-28 17:52:49 by tlmiller:</em> <br/>\n\nAdditionally, it's silly to make Heath specify all those URLs on the command line.  Either (or both):\n\n<p></p><ul>\n<li>store the URLs specified on the -setup command line in the config file\n</li><li>add a command-line switch to specify the region (that sets all those URLs)\n</li></ul>\n\n<p></p><hr/>\n<em>2018-Mar-28 18:09:51 by tlmiller:</em> <br/>\n\nThe patch works, but doesn't fully solve the problem: 'aws s3 cp s3url://... .' no longer works for region-specific buckets.  It will work if you supply the '--region &lt;name&gt;' flag, but now we have a different bootstrapping problem to solve....\n\n<p>Maybe the issue that required region-specific buckets has been solved?  Could try that, instead, maybe....\n\n</p><p></p><hr/>\n<em>2018-Mar-30 10:50:06 by tlmiller:</em> <br/>\n\n<code>49ec2-config.sh</code> already knows what region it's in, so that's not a boot-strapping problem.  And since the whole issue is that the bucket is region-specific, we can safely assume that the region the instance launched in is the region whose S3 bucket we specified.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6632\" onclick=\"get_ticket_and_populate_wrapper('6632'); return false;\" title=\"Add -[aws-?]region flag to condor_annex\">#6632</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd -[aws-?]region flag to condor_annex</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-30 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4184df395463e153cd1af03e0b850da4587a7723\">[54638]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6629\" onclick=\"get_ticket_and_populate_wrapper('6629'); return false;\" title=\"condor_annex fails when uploading config files to us-east-2\">#6629</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6632\" onclick=\"get_ticket_and_populate_wrapper('6632'); return false;\" title=\"Add -[aws-?]region flag to condor_annex\">#6632</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6633\" onclick=\"get_ticket_and_populate_wrapper('6633'); return false;\" title=\"Add default AMI IDs for all regions we currently support.\">#6633</a></span>) Release notes.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-29 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/736f2ec86acead9a1880868f7b3b85d33f290a4e\">[54611]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6629\" onclick=\"get_ticket_and_populate_wrapper('6629'); return false;\" title=\"condor_annex fails when uploading config files to us-east-2\">#6629</a></span>) Update default AMI to have a larger disk, HTCondor 8.6.10, and the version of 49ec2-config.sh that works with any region.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-29 14:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3a08559da26685576ca444a52845bee87c65dd77\">[54610]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6629\" onclick=\"get_ticket_and_populate_wrapper('6629'); return false;\" title=\"condor_annex fails when uploading config files to us-east-2\">#6629</a></span>) Fix 49ec2-config.sh to work with arbitrary S3 regions, now that that's necessary.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-28 17:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ead22a646a271737d2ff167d3e90346674cfce44\">[54600]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6629\" onclick=\"get_ticket_and_populate_wrapper('6629'); return false;\" title=\"condor_annex fails when uploading config files to us-east-2\">#6629</a></span>) Derive the region from the URL when uploading to S3.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "incident", "last_change": "2018-Mar-30 16:40", "status": "resolved", "created": "2018-Mar-28 17:51", "fixed_version": "2018-Mar-28 17:51", "broken_version": "", "priority": "2", "subsystem": "Annex", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}