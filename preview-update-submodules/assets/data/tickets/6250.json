{"id": 6250, "title": "Ticket #6250: Provide a knob to express job query constraint for negotiator", "description": "<blockquote>\nCurrently, there are knobs to restrict which nodes/resources a negotiator will consider during a negotiation cycle.  I would like a knob that would provide the corresponding functionality for jobs.\n\n<p>Example:\n\n</p><p>GPGrid runs two negotiators.  One negotiates dedicated local nodes using hard quotas.  The other negotiates OSG resources using priorities.  The users specify in their job classads attributes that specify whether they want to run under their quota or on the priority based resources.  I would like to have a knob in the negotiator that passes a constraint to the Schedd such that the schedd only returns jobs to the negotiator for match making that match the constraint.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-May-12 10:12:21 by jfrey:</em> <br/>\n\nAre you currently encountering a problem that necessitates this feature, or are you anticipating future problems with inefficient matchmaking?\n\n<p></p><hr/>\n<em>2017-May-19 08:38:03 by tiradani:</em> <br/>\n\nThis is not current problem.  It is partially a matter of efficiency, but it will become a problem when we scale up similar to the CMS Global Pool and to the HEPCloud Google demo.  At those scales, negotiation could not keep up.\n\n<p></p><hr/>\n<em>2018-Jan-03 10:20:30 by tiradani:</em> <br/>\n\nCan we elevate the urgency of this ticket?  CMS would like to integrate the Global Pool with HEPCloud.  The easiest way at the moment would be to flock, but that would only work if we can specify job constraints for the negotiator.\n\n<p></p><hr/>\n<em>2018-Feb-21 09:48:32 by jfrey:</em> <br/>\n\nThis is now possible using the new config param NEGOTIATOR_JOB_CONSTRAINT. It's read by the negotiator and sent to the schedds for evaluation. Schedds older than 8.7.7 will ignore this expression and continue to send all ads to the negotiator. If we feel this is a problem, we can add code to the negotiator to apply this expression to jobs coming from older schedds.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-21 09:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/887db92e61f8deb8f77dc18a56355e112a0ac8a7\">[54339]</a></span>: Docs for new param NEGOTIATOR_JOB_CONSTRAINT. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6250\" onclick=\"get_ticket_and_populate_wrapper('6250'); return false;\" title=\"Provide a knob to express job query constraint for negotiator\">#6250</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-15 12:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0af7a8639c8dbfa64fb57503c2ae992830af9a49\">[54298]</a></span>: Switch all callers to newer attribute reference tracking functions. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6250\" onclick=\"get_ticket_and_populate_wrapper('6250'); return false;\" title=\"Provide a knob to express job query constraint for negotiator\">#6250</a></span> Also update unit tests.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-14 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/81a4875055e6006f66a04195fa7f71e10f60c1d7\">[54292]</a></span>: Add config knob to constrain which jobs the negotiator will consider. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6250\" onclick=\"get_ticket_and_populate_wrapper('6250'); return false;\" title=\"Provide a knob to express job query constraint for negotiator\">#6250</a></span> The new knob, NEGOTIATOR_JOB_CONSTRAINT, is an expression evaluated against the job. If False, then the negotiator doesn't want to consider the job for matchmaking. The knob is read by the negotiator and then sent to the schedd\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-14 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/512d48fdc1652462e2f3a0c292bba41a42ef0060\">[54293]</a></span>: Speed up significant attribute calculations in the negotiator. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6250\" onclick=\"get_ticket_and_populate_wrapper('6250'); return false;\" title=\"Provide a knob to express job query constraint for negotiator\">#6250</a></span> Use a stl::set instead of a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span> to store the attribute names. Build a merged set of full attribute names from all machines and then trim the names down once.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-14 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/58554cadc6097c7cb9eb298ad1fe79140d77fc1d\">[54294]</a></span>: Fix a bug in trimming attribute references that start with '.'. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6250\" onclick=\"get_ticket_and_populate_wrapper('6250'); return false;\" title=\"Provide a knob to express job query constraint for negotiator\">#6250</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-14 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/26d5cde4e40a3fa6caed141d49f62066e43023a1\">[54295]</a></span>: Add more efficient functions for getting attribute references. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6250\" onclick=\"get_ticket_and_populate_wrapper('6250'); return false;\" title=\"Provide a knob to express job query constraint for negotiator\">#6250</a></span> Use std::set instead of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span>.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Feb-21 13:18", "status": "resolved", "created": "2017-May-05 09:03", "fixed_version": "2017-May-05 09:03", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "jfrey", "derived_from": "", "creator": "tiradani", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "fkhan@fnal.gov tiradani@fnal.gov tannenba@cs.wisc.edu", "due_date": ""}