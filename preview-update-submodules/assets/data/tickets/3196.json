{"id": 3196, "title": "Ticket #3196: SPOOL is wrong with multiple schedds", "description": "<blockquote>\nJohn Wiegand at Fermi noticed a bug in Condor when multiple schedds are defined.  See the <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-May/msg00149.shtml\">initial message</a>, <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-June/msg00005.shtml\">reply</a>, and <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-August/msg00054.shtml\">simple demonstration</a> of the bug.</blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-21 22:40:22 by nwp:</em> <br/>\n\nThe easy solution is to eliminate the default value of JOB_QUEUE_LOG in the param table (that is, revert 395c915).\n\n<p>Or, is it envisioned that something like the following is supposed to work?\n</p><div class=\"code\">\n<pre class=\"code\">SCHEDD.xxyyz.SPOOL=/foo\nSCHEDD.yywwt.SPOOL=/foo2\nJOB_QUEUE_LOG=$(SPOOL)/bar\n</pre></div>\n\nThen JOB_QUEUE_LOG evaluates to /foo/bar for schedd xxyyz and to /foo2/bar for schedd yywwt.\n\n<p>What is the downside of a simple revert?\n\n</p><p></p><hr/>\n<em>2012-Aug-22 08:37:11 by tstclair:</em> <br/>\n\nFrom what I recollect about the param system, the above is not possible in some cases.\n\n<p>Thus the only solution that is valid is removal from the param table.\n\n</p><p></p><hr/>\n<em>2012-Aug-22 09:38:52 by nwp:</em> <br/>\n\nI am setting this to review for Greg T, since Greg put this in the param table in the first place.\n\n<p></p><hr/>\n<em>2012-Sep-12 13:42:06 by nwp:</em> <br/>\n\nLet's get some wisdom written down on this topic.  For concreteness, lets consider an example from a configuration file.\n<div class=\"code\">\n<pre class=\"code\">LOCAL_DIR= /scratch/nwp/personal-condor\nSPOOL= $(LOCAL_DIR)/spool\nSCHEDD.SCHEDDJOBS2.SCHEDD_NAME   = schedd_jobs2\nSCHEDD.SCHEDDJOBS2.SCHEDD_LOG    = $(LOG)/SchedLog.$(SCHEDD.SCHEDDJOBS2.SCHEDD_NAME)\nSCHEDD.SCHEDDJOBS2.LOCAL_DIR = $(LOCAL_DIR)/$(SCHEDD.SCHEDDJOBS2.SCHEDD_NAME)\nSCHEDD.SCHEDDJOBS2.SPOOL = $(SCHEDD.SCHEDDJOBS2.LOCAL_DIR)/spool\n</pre></div>\n\nI think this configuration is enough to show what is involved.\n\n<p>At this point in the code, there are two ways to look up a configuration/param macro.  The code either calls param and associated param_*; functions, or it can\ncall lookup_macro.  Now, with the configuration above, what happens?\n\n</p><p>Let's assume we are in the schedd, with a local-name set to <code>SCHEDDJOBS2</code>. When the code calls <code>param(\"LOCAL_DIR\")</code>, <code>param</code> first tries to lookup <code>\"SCHEDD.SCHEDDJOBS2.LOCAL_DIR\"</code>, then <code>\"SCHEDD.LOCAL_DIR\"</code>, then <code>\"LOCAL_DIR\"</code>.  Of course the first lookup succeeds (and the other two are not looked up), and param will find <code>\"$(LOCAL_DIR)/$(SCHEDD.SCHEDDJOBS2.SCHEDD_NAME)\"</code>.  Then <code>param</code> calls <code>lookup_macro</code>.  The <code>lookup_macro</code> code does not try to scope the <code>LOCAL_DIR</code> on the right-hand side, so it returns <code>\"/scratch/nwp/personal-condor\"</code>, and it looks up <code>\"SCHEDD.SCHEDDJOBS2.SCHEDDNAME\"</code>, to get <code>\"schedd_jobs2\"</code>. So <code>param(\"LOCAL_DIR\")</code> returns <code>\"/scratch/nwp/personal-condor/schedd_jobs2\"</code> and\n<code>lookup_macro(\"LOCAL_DIR\")</code> returns <code>\"/scratch/nwp/personal-condor\"</code>.\n\n</p><p>I tried to simply add the param scoping behavior into lookup_macro, but I just got into an infinite loop, since the code kept expanding <code>SCHEDD.SCHEDDJOBS2.LOCAL_DIR</code> over and over; essentially, the code was trying\nto figure out what\n</p><div class=\"code\">\n<pre class=\"code\">SCHEDD.SCHEDDJOBS2.LOCAL_DIR = $(SCHEDD.SCHEDDJOBS2.LOCAL_DIR)/$(SCHEDD.SCHEDDJOBS2.SCHEDD_NAME)\n</pre></div>\n\nmeans; on its face, it is not clear what is the meaning; so I stopped working on it.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-28 12:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c371c7d2ba5358f5d0106e08f0214c272b6836f0\">[33195]</a></span>: rewrote version history item about bug where multiple schedds share 1 job queue ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3196\" onclick=\"get_ticket_and_populate_wrapper('3196'); return false;\" title=\"SPOOL is wrong with multiple schedds\">#3196</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-22 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f8b961dfc9f152f4085d06d2204176592ad11747\">[33133]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3196\" onclick=\"get_ticket_and_populate_wrapper('3196'); return false;\" title=\"SPOOL is wrong with multiple schedds\">#3196</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-22 09:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8be59f05792efc5da3b03c8c0435840fe95e135e\">[33132]</a></span>: Revert default definition of JOB_QUEUE_LOG <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3196\" onclick=\"get_ticket_and_populate_wrapper('3196'); return false;\" title=\"SPOOL is wrong with multiple schedds\">#3196</a></span>  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Sep-12 13:42", "status": "resolved", "created": "2012-Aug-16 15:37", "fixed_version": "2012-Aug-16 15:37", "broken_version": "v070705", "priority": "1", "subsystem": "Daemons", "assigned_to": "nwp", "derived_from": "", "creator": "nwp", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "weigand@fnal.gov tannenba@cs.wisc.edu timm@fnal.gov tstclair@redhat.com", "due_date": ""}