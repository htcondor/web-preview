{"id": 5224, "title": "Ticket #5224: JobRouter Hook crashes condor_job_router", "description": "<blockquote>\nI'm testing a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span> translate hook with HTCondor-CE and everytime my jobs invoke the hook the CE's condor_job_router process crashes.\n\n<p>Hook config in /etc/condo-ce/config.d/99-local.conf\n\n</p><p></p><div class=\"verbatim\">\n<pre>PILOT_HOOK_TRANSLATE_JOB = /usr/libexec/htcondor-job-router/pilot-translate.py\n</pre></div>\n\n\n<p>My submit script (attached) contains this line:\n\n</p><p></p><div class=\"verbatim\">\n<pre>+HookKeyword = \"PILOT\"\n</pre></div>\n\n\n<p>The error in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouterLog\" title=\"Job Router Log\">JobRouterLog</a></span>:\n\n</p><p></p><div class=\"verbatim\">\n<pre>07/24/15 17:58:27 JobRouter (src=80283.0,route=Local_PBS): claimed job\n07/24/15 17:58:27 Hook PILOT_HOOK_TRANSLATE_JOB: /usr/libexec/htcondor-job-router/pilot-translate.py\n07/24/15 17:58:27 error opening watchdog pipe /var/lock/condor-ce/procd_pipe.watchdog: Permission denied (13)\n07/24/15 17:58:27 ProcFamilyClient: error initializing LocalClient\n07/24/15 17:58:27 ProcFamilyProxy: error initializing ProcFamilyClient\n07/24/15 17:58:27 waiting a second to allow the ProcD to be restarted\n</pre></div>\n\n\n<p>The above errors repeat a few times then this is printed:\n\n</p><p></p><div class=\"verbatim\">\n<pre>07/24/15 17:58:32 ERROR \"unable to restart the ProcD after several tries\" at line 677 in file /builddir/build/BUILD/condor-8.2.8/src/condor_utils/proc_family_proxy.cpp\n</pre></div>\n\n\n<p>The file mentioned in log:\n\n</p><p></p><div class=\"verbatim\">\n<pre>prw------- 1 condor root 0 Jul 24 18:25 /var/lock/condor-ce/procd_pipe.watchdog\n</pre></div>\n\n\n<p>Original ticket: <a class=\"external\" href=\"https://ticket.opensciencegrid.org/26291\">https://ticket.opensciencegrid.org/26291</a></p></blockquote>", "remarks": "<blockquote>\n<em>2015-Aug-18 15:38:13 by emfajard:</em> <br/>\n\nOne more thing the problem seems to go away when:\n<div class=\"verbatim\">\n<pre>JOB_ROUTER.USE_PROCD=false\n</pre></div>\n\n\n<p></p><hr/>\n<em>2015-Aug-25 22:28:43 by bbockelm:</em> <br/>\n\nEdgar -\n\n<p>Can you do a build of the posted branch as a scratch in Koji for Troy?\n\n</p><p></p><hr/>\n<em>2015-Aug-31 16:15:06 by jfrey:</em> <br/>\n\nI've attached an alternative patch for this bug. The fix proposed previously duplicated an existing class (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span>). The new patch also adds missing calls to uninit_user_uids().\n\n<p></p><hr/>\n<em>2015-Sep-01 08:28:59 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>It wasn't really duplication - it was a specific change in semantics.  The new class set the priv state to a given value on exit; the old class did the priv state change and reset it back on exit.\n\n</p><p>Can you modify your patch to use RAII?  I'm uncomfortable manually enumerating all the exit paths.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Sep-08 15:12:44 by jfrey:</em> <br/>\n\nBrian, what do you think of the priv_sentry.patch I just added to this ticket?\n\n<p>It allows the existing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span> object to be used without changing the priv state during construction, and enables uninitializing the user uids (opt-in).\n\n</p><p></p><hr/>\n<em>2015-Sep-08 15:22:37 by bbockelm:</em> <br/>\n\nMuch better!  Looks good to me.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/889/uids.patch\">uids.patch</a>\n4396 bytes added by jfrey on 2015-Aug-31 21:13:36 UTC.\n<br/>\nPatch for privilege leakage in Job Router. Includes new function for initializing user uids.<br/>\n</li><li><a href=\"../files/890/priv_sentry.patch\">priv_sentry.patch</a>\n3952 bytes added by jfrey on 2015-Sep-08 20:32:21 UTC.\n<br/>\nEnable <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span> to optionally undo user id initialization in the priv state code.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-15 16:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b1a6647a171d2a47eeb176f71b78da5cd5493e08\">[45988]</a></span>: Version history for Job Router hook crash bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5224\" onclick=\"get_ticket_and_populate_wrapper('5224'); return false;\" title=\"JobRouter Hook crashes condor_job_router\">#5224</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-09 09:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c14b5384e0062b207dcdd9431fea9581ac72f921\">[45798]</a></span>: Allow <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span> to optionally undo user id initialization. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5224\" onclick=\"get_ticket_and_populate_wrapper('5224'); return false;\" title=\"JobRouter Hook crashes condor_job_router\">#5224</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-03 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/64462cf93b19af21402871e670ed1c6b57fd2823\">[45791]</a></span>: Unset user priv ids after writing job completion visa. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5224\" onclick=\"get_ticket_and_populate_wrapper('5224'); return false;\" title=\"JobRouter Hook crashes condor_job_router\">#5224</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-03 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/32910716d73f3e9d8208ac7e044270037116eae2\">[45790]</a></span>: Fix privilege leakage in the job router hooks. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5224\" onclick=\"get_ticket_and_populate_wrapper('5224'); return false;\" title=\"JobRouter Hook crashes condor_job_router\">#5224</a></span> The hook functions now maintain the existing privilege state when they return, and undo the user id initialization that they set up. Previously, they would change the privilege state to PRIV_USER and leave it that way, causing subsequent code to fail\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-03 16:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e3979165589800f47a7a1cd1694670353a5f3363\">[45789]</a></span>: Add convenience function to initialize user ids from a job ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5224\" onclick=\"get_ticket_and_populate_wrapper('5224'); return false;\" title=\"JobRouter Hook crashes condor_job_router\">#5224</a></span> Unlike the existing set_user_priv_from_ad(), the new function doesn't change the privilege state and doesn't EXCEPT() on failure.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-25 22:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f40c36635c014cd38faa87d37687294bea851bbf\">[45679]</a></span>: Reset priv state when hook calls exit. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5224\" onclick=\"get_ticket_and_populate_wrapper('5224'); return false;\" title=\"JobRouter Hook crashes condor_job_router\">#5224</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Oct-15 16:26", "status": "resolved", "created": "2015-Aug-18 10:27", "fixed_version": "2015-Aug-18 10:27", "broken_version": "v080208", "priority": "3", "subsystem": "", "assigned_to": "jfrey", "derived_from": "", "creator": "treydock", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "efajardo@physics.ucsd.edu, bbockelm@cse.unl.edu", "due_date": ""}