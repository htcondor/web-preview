{"id": 2686, "title": "Ticket #2686: PSS doesn't work reliably", "description": "<blockquote>\nProportional Set Size detection doesn't appear to work reliably.  At Nebraska, it appears to work for only about 40% of the slots.\n\n<p></p><div class=\"verbatim\">\n<pre>root@red-man /etc/puppet/modules/condor/files/config.d&gt; condor_q -pool red-condor.unl.edu -g -const 'ProportionalSetSizeKb is null &amp;&amp; JobStatus == 2' -run | grep slot | wc -l\n1069\nroot@red-man /etc/puppet/modules/condor/files/config.d&gt; condor_q -pool red-condor.unl.edu -g -const 'ProportionalSetSizeKb isnt null &amp;&amp; JobStatus == 2' -run | grep slot | wc -l\n723\n</pre></div>\n\n\n<p>In fact, if I query a specific host, it appears that it only sporadicly works for different slots on a host:\n\n</p><p></p><div class=\"verbatim\">\n<pre>root@red-man /etc/puppet/modules/condor/files/config.d&gt; condor_q -pool red-condor.unl.edu -g -const 'ProportionalSetSizeKb is null &amp;&amp; JobStatus == 2' -run | grep node166.red.hcc.unl.edu\n2016333.0   uscmsPool1026  11/29 12:32   0+08:20:58 slot6@node166.red.hcc.unl.edu\n2049759.0   cmsprio051     12/3  12:24   0+03:26:52 slot4@node166.red.hcc.unl.edu\n2049780.0   cmsprio050     12/3  12:24   0+03:24:43 slot2@node166.red.hcc.unl.edu\n2049786.0   cmsprio050     12/3  12:24   0+03:24:43 slot8@node166.red.hcc.unl.edu\n2050682.0   hcc            12/3  12:53   0+02:49:41 slot7@node166.red.hcc.unl.edu\n2051810.0   cmsprio062     12/3  13:08   0+02:42:47 slot3@node166.red.hcc.unl.edu\nroot@red-man /etc/puppet/modules/condor/files/config.d&gt; condor_q -pool red-condor.unl.edu -g -const 'ProportionalSetSizeKb isnt null &amp;&amp; JobStatus == 2' -run | grep node166.red.hcc.unl.edu\n106558.0   cmsprio049     12/3  12:29   0+03:19:28 slot1@node166.red.hcc.unl.edu\n107463.0   uscmsPool1355  12/3  13:40   0+02:07:51 slot5@node166.red.hcc.unl.edu\n</pre></div>\n\n\n<p>I'm not able to discern any patterns as to why this might be happening.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Dec-06 14:01:18 by danb:</em> <br/>\n\nJust to be clear: it is expected for <code>ProportionalSetSizeKb</code> to be missing for running jobs that have run for less than the shadow update interval (default 15 minutes).  I can query your schedd and confirm that there are many jobs older than this which exhibit the problem.  Strangely, I do not see this problem in CHTC, which is running 7.7.4.  There have been no recent code changes relevant to this, as far as I know.\n\n<p>Do you find any error messages matching 'smaps' or 'Pss' in <code>ProcLog</code> and/or <code>ProcLog.STARTD</code>?  If so, could you please get a copy of /proc/&lt;pid&gt;/smaps for one of the job processes?\n\n</p><p></p><hr/>\n<em>2011-Dec-09 11:26:11 by gthain:</em> <br/>\n\nThere is a bug in the pss code, in that we read the /proc/pid/smaps files in 512 byte chunks, and if the \"Pss:    xxx Kb\" line crosses the boundary, we won't read it.\n\n<p></p><hr/>\n<em>2011-Dec-12 10:36:38 by danb:</em> <br/>\n\nGreg, I don't see the bug you mentioned.  We read <em>lines</em> in 512 bytes chunks.  Am I missing something?\n\n<p></p><hr/>\n<em>2012-Jan-06 19:43:28 by bbockelm:</em> <br/>\n\nDan and I spent some time looking at this.  There weren't any error messages in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProcdLog\" title=\"Procd Log\">ProcdLog</a></span> when the procd was run by hand.\n\n<p></p><hr/>\n<em>2012-Jan-07 11:21:20 by bbockelm:</em> <br/>\n\nSome more mysterious behavior:\n\n<p></p><div class=\"verbatim\">\n<pre>root@red-man ~&gt; condor_q -g -const '(ProportionalSetSizeKb_RAW &gt; 0) &amp;&amp; (ResidentSetSize &gt; 0) &amp;&amp; ProportionalSetSizeKb_RAW &gt; ResidentSetSize' -format '%d ' ClusterId -format '%d ' ProportionalSetSizeKb_RAW -format '%d\\n' ResidentSetSize | wc -l\n846\n</pre></div>\n\n\n<p>This shows that there are 846 jobs where PSS &gt; RSS; by definition, PSS &lt;= RSS.  I did take a look at a few random jobs, and does not appear to be startup effects.\n\n</p><p></p><hr/>\n<em>2012-Jan-07 14:36:58 by bbockelm:</em> <br/>\n\nScratch that last update: it appears some startd's run code that predates <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2632\" onclick=\"get_ticket_and_populate_wrapper('2632'); return false;\" title=\"Condor ignores memory usage by processes that fork without exec\">#2632</a></span>.\n\n<p></p><hr/>\n<em>2014-Jul-28 13:02:03 by bbockelm:</em> <br/>\n\nClosing old ticket.  Reopen as necessary.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/519/procd_print_pss.patch\">procd_print_pss.patch</a>\n727 bytes added by bbockelm on 2012-Jan-07 19:26:53 UTC.\n<br/>\nThe following patch causes the procd_ctl tool to be able to print out the pss value.  Will be essential to debug this.  Can someone apply?<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-01 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/092af509fea55a6524b405ff04da89740a368db8\">[30052]</a></span>: Have procd_ctl print out PSS, if available <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=2686\" onclick=\"get_ticket_and_populate_wrapper('2686'); return false;\" title=\"PSS doesn't work reliably\">#2686</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jul-28 13:02", "status": "abandoned", "created": "2011-Dec-03 15:52", "fixed_version": "2011-Dec-03 15:52", "broken_version": "v070702", "priority": "2", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu,dan@hep.wisc.edu", "due_date": ""}