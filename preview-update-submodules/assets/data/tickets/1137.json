{"id": 1137, "title": "Ticket #1137: timeslice delays too much on average for delays < 0.5s", "description": "<blockquote>\nTimeslice::updateNextStartTime() is responsible for computing the timestamp (in seconds since the epoch) when an event should next happen.  The algorithm in use up to and including version 7.4.1 would simply round off the timestamp to the nearest second.  This is wrong when the desired delay is less than 0.5s.  Sometimes it is too short and sometimes too long, but on average it is too long.\n\n<p>Consider what happens when there is a desired delay of 0s.  Half the time, the timestamp will be rounded down and half the time up.  The net result is an average delay of 0.125s instead of 0s.\n\n</p><p>The best we can do is make the average delay equal to the desired delay.  Solve for the cutoff k that produces the desired average delay:\n\n</p><p></p><div class=\"verbatim\">\n<pre>d = desired delay\nt = fraction of current second that has already passed\nk = cutoff past which t should be rounded up\n\nGiven t, the actual delay is:\n0 &lt;= t &lt; k: 0\nk &lt;= t &lt; 1: 1-t\n\nAvg delay = 0.5*(1-k)(1-k) == d\n\nk = 1-sqrt(2d)\n</pre></div>\n\n\n<p>This error in the calculated timestamp caused a 0s delay to sometimes turn into a non-zero delay, which resulted in the following message appearing in some cases where it should not happen:\n\n</p><p></p><div class=\"verbatim\">\n<pre>Collector &lt;X&gt; is still being avoided if an alternative succeeds.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-25 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d80cbc80d0a0a5a5dbd6085a7367ec7cc9a8648\">[25243]</a></span>: Documented fix for timeslice code to avoid bad collector avoidance messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1137\" onclick=\"get_ticket_and_populate_wrapper('1137'); return false;\" title=\"timeslice delays too much on average for delays &lt; 0.5s\">#1137</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-25 16:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0cea2bf198d30004612111ea6c7e28e39e8a44ca\">[16962]</a></span>: Fixed calculation of next time to run for delays &lt; 0.5s. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1137\" onclick=\"get_ticket_and_populate_wrapper('1137'); return false;\" title=\"timeslice delays too much on average for delays &lt; 0.5s\">#1137</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-25 17:01", "status": "resolved", "created": "2010-Jan-25 16:47", "fixed_version": "2010-Jan-25 16:47", "broken_version": "v070000", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}