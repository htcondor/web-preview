{"id": 2853, "title": "Ticket #2853: Condor binds to wrong network interface", "description": "<blockquote>\nkhahn and gthain observed Condor picking a local (192.168.*) network interface that was down in CHTC.  The interface was virtual(? used for a VM?), and didn't show up in ifconfig unless you passed -a.\n\n<p></p><ol>\n<li>Initial work\n<ul>\n<li>Talk with khahn, get more details, reproduce.\n</li><li>Check out interface selection code. This wouldn't be the first time it's regressed, possibly due to a bad merge.\n</li></ul>\n</li></ol>\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ condor_config_val IP_ADDRESS\n192.168.122.1\n[gthain@submit-1 spool]$ /sbin/ifconfig -a\nbond0     Link encap:Ethernet  HWaddr C8:0A:A9:F1:84:EF\n          inet addr:128.104.100.43  Bcast:128.104.103.255  Mask:255.255.252.0\n          inet6 addr: fe80::ca0a:a9ff:fef1:84ef/64 Scope:Link\n          UP BROADCAST RUNNING MASTER MULTICAST  MTU:1500  Metric:1\n          RX packets:458947522 errors:0 dropped:289065 overruns:0 frame:0\n          TX packets:470890583 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:159018002915 (148.0 GiB)  TX bytes:596433302956 (555.4 GiB)\n\neth0      Link encap:Ethernet  HWaddr C8:0A:A9:F1:84:EF\n          UP BROADCAST RUNNING SLAVE MULTICAST  MTU:1500  Metric:1\n          RX packets:30676211 errors:0 dropped:177 overruns:0 frame:0\n          TX packets:235493983 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000\n          RX bytes:10489038929 (9.7 GiB)  TX bytes:298289534164 (277.8 GiB)\n          Interrupt:82 Memory:ea000000-ea012800\n\neth1      Link encap:Ethernet  HWaddr C8:0A:A9:F1:84:EF\n          UP BROADCAST RUNNING SLAVE MULTICAST  MTU:1500  Metric:1\n          RX packets:428271311 errors:0 dropped:288888 overruns:0 frame:0\n          TX packets:235396600 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000\n          RX bytes:148528963986 (138.3 GiB)  TX bytes:298143768792 (277.6 GiB)\n          Interrupt:90 Memory:ec000000-ec012800\n\nlo        Link encap:Local Loopback\n          inet addr:127.0.0.1  Mask:255.0.0.0\n          inet6 addr: ::1/128 Scope:Host\n          UP LOOPBACK RUNNING  MTU:16436  Metric:1\n          RX packets:209247221 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:209247221 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:30267404789 (28.1 GiB)  TX bytes:30267404789 (28.1 GiB)\n\nsit0      Link encap:IPv6-in-IPv4\n          NOARP  MTU:1480  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)\n\nvirbr0    Link encap:Ethernet  HWaddr 00:00:00:00:00:00\n          inet addr:192.168.122.1  Bcast:192.168.122.255  Mask:255.255.255.0\n          BROADCAST MULTICAST  MTU:1500  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:27 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:0 (0.0 b)  TX bytes:6748 (6.5 KiB)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Mar-07 13:50:23 by adesmet:</em> <br/>\n\nPossibly related issue reported by Matyas on behalf of an OSG user.  They upgraded to 7.6.6, at which point a schedd began advertising 127.0.0.1 as it's IP addresses.  May not be related, especially since the Big Changes to IPv6 were in 7.7, not 7.6.\n\n<p></p><hr/>\n<em>2012-Mar-14 16:56:57 by adesmet:</em> <br/>\n\nCode identifying private IPv4 addresses was backward.  Instead of detecting, for example, 192.168.*.*, it was detecting *.*.168.192.  This appears to be an old bug.  There is a much more carefully debugged object (condor_netaddr) designed specifically exactly this task, so I removed the old, buggy code and replaced it with code using condor_netaddr.  I also added 20 or so tests for the various masks.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-14 20:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/70dbcf0adb5e79a61f3d288932670a354782d99b\">[30917]</a></span>: Re-add IPv4 ip address fixes. Tests no longer broken. Library fixed. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2853\" onclick=\"get_ticket_and_populate_wrapper('2853'); return false;\" title=\"Condor binds to wrong network interface\">#2853</a></span> (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-14 18:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41d6e1b9bf9f98163ffa6354e4effdfe72fd2404\">[30916]</a></span>: Revert \"Fix IPv4 private network tests. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2853\" onclick=\"get_ticket_and_populate_wrapper('2853'); return false;\" title=\"Condor binds to wrong network interface\">#2853</a></span>\" - Breaks some platforms on link This reverts commit 02a71a9536f770c544e0ba4d6ffc091085505d19.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-14 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e63726c5b371deb6e47c2f23d10240f72c9fb1e5\">[30914]</a></span>: Document fix to selecting wrong network interface. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2853\" onclick=\"get_ticket_and_populate_wrapper('2853'); return false;\" title=\"Condor binds to wrong network interface\">#2853</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-14 16:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/02a71a9536f770c544e0ba4d6ffc091085505d19\">[30913]</a></span>: Fix IPv4 private network tests. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2853\" onclick=\"get_ticket_and_populate_wrapper('2853'); return false;\" title=\"Condor binds to wrong network interface\">#2853</a></span> Code wasn't testing for 192.168.*.*, it was testing for *.*.168.192. Also, it was needlessly poking around with the raw bits, when this is exactly what condor_netaddr is for. So I switched to condor_netaddr and as a side effect fixed the problem.  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Mar-15 11:30", "status": "resolved", "created": "2012-Feb-29 17:03", "fixed_version": "2012-Feb-29 17:03", "broken_version": "v070705", "priority": "2", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "#1918", "creator": "gthain", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "khahn@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}