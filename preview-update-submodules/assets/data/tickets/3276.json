{"id": 3276, "title": "Ticket #3276: Improve blahp file handling", "description": "<blockquote>\nWe need to reduce the number of orphaned files the blahp can leave behind.\n\n<p><span class=\"subsection\"></span></p><h3>Work Plan</h3>\n\n<p>We know from user reports that the blahp can leave behind orphaned files\nand directories that are never cleaned up. We looked over the user\nreports and audited the blahp's file usage to identify cases affecting\nthe Condor-CE that we can fix. We identified two cases that required\naddressing. They can be handled with changes primarily to the\ncondor_gridmanager, with minimal changes to the blahp.\n\n</p><p>First case: For most batch systems, the blahp wraps the job with a\nscript that manages the job's execution environment. The script creates\na directory under the user's home directory in which to run the job.\nOnce the job completes, it moves output files out of the directory and\ndeletes it. Under the right circumstances, this directory may not be\nremoved. When the user's home directory is shared (common for PBS, LSF\nand SGE clusters), the gridmanager can check for the existence of this\ndirectory and remove it after job completion. This requires that the\ngridmanager know the name of the directory. Currently, the directory's\nname is choosen at random by the blahp's submit script. We can add an\noptional attribute to the job description given to the blahp that\ndictates the name of the directory.\n\n</p><p>Second case: When a job has an X.509 proxy, the blahp creates a limited\nproxy from the given one, using the same filename with \".lmt\" appended.\nIt then creates a symlink under $(HOME)/.blah_jobproxy_dir/ to the\nlimited proxy. The name of the symlink is based on the blahp's job id.\nFor some batch systems, the status script removes the symlink when returning\na job status of 3 (REMOVED) or 4 (COMPLETED). In many situations, the\nsymlink can get left behind.\nWe can remove the symlink in the gridmanager after the job completes. If\nthe limited proxy resides in the Condor spool directory, the gridmanager\ncan also remove the limited proxy. We can't remove the limited proxy if\nit's outside the spool directory, as it could be shared by multiple\njobs, some of which may still be running.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-03 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b3f249eb0719b7f6b3fb23bb5385e344a51b8e5\">[34517]</a></span>: minor 7.9.3 version history item edit ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-13 16:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8628034ceb3819183d33929a4861628e78fe2318\">[34379]</a></span>: Clear <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GridJobId\" title=\"Grid Job Id\">GridJobId</a></span> after cleaning up after the blahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-13 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a8324f6afad74fdd6040047a9bf5f83065a6361d\">[34378]</a></span>: Fix privilege-state bug when cleaning up after the blahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-07 11:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fc65fbcf114f598f866b876167aa13715c8987a5\">[34328]</a></span>: Disable more blahp-cleanup code on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-06 15:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bbf5a4952f48618c09cb9dba26cbf5ccc55b8b04\">[34320]</a></span>: Disable blahp-cleanup code on Windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span> The code uses unix-specific calls and the blahp doesn't run on Windows.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-06 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6fb1a141e5c89a67bf539cf1701ecd0429585f2\">[34311]</a></span>: Version history for blahp file cleanup by gridmanager. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-06 10:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2b9f0bacf939258e9f81ac0d083e2596f5f4a7d0\">[34310]</a></span>: Gridmanager needs to clean up after the blahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span> The blahp may create and then leave behind an execute directory and files related to the job's proxy. Now the gridmanager will look for these files and remove them.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-06 10:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b2b92e80ec660d4565fe21ff4b93bc4313a8f25\">[34309]</a></span>: Allow job run directory to be dictated to the blahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3276\" onclick=\"get_ticket_and_populate_wrapper('3276'); return false;\" title=\"Improve blahp file handling\">#3276</a></span> To facilitate cleaning up files left behind by the blahp, allow the gridmanager to optionally tell the blahp what name to use for the temporary directory used to exeucte the job.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Dec-06 10:39", "status": "resolved", "created": "2012-Oct-17 14:20", "fixed_version": "2012-Oct-17 14:20", "broken_version": "", "priority": "4", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "#3275", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}