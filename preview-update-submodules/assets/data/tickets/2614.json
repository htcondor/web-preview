{"id": 2614, "title": "Ticket #2614: restart of glidein master causes leaked glexec processes", "description": "<blockquote>\nThe use of a different procd process for the master than in the startd means that if the startd dies without cleaning up its children, the master will fail to clean up jobs that were started via glexec.\n\n<p>We observed this in a case where the master was suspended for a while.  When it was unsuspended, it detected a large clock jump and restarted itself.  It immediately hard-killed the startd (probably because the startd had not been sending keepalives while suspended) and then the master's procd failed to clean up the job processes that had been started via glexec.  The startd had its own procd.\n\n</p><p>The host condor (running as root) did not have any problem cleaning up the processes leaked by the glidein when the glidein finally exited.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Nov-18 18:02:01 by danb:</em> <br/>\n\nThe plot thickens!  When the glidein starts for the first time, the master is starting a procd, which is used by the startd.  (This happens because the use of glexec requires it.)  So at that stage, there is only one procd.  Therefore, the problem of the master not being able to kill jobs started via glexec does not yet apply.  But (at least on my mac) when the master restarts itself, the master and startd each create their own procd.  Therefore, after the first restart, the master can no longer kill processes started by glexec.\n\n<p>Why does the behavior change after the master restarts itself?  For some reason, in the restarted startd, CONDOR_PROCD_ADDRESS_BASE is not set.  I haven't yet understood why.  I have traced the master and determined that it calls setenv(), and getenv() does return the value that it set.  However, when the master's environment is merged into the child's, this environment variable is not copied.\n\n</p><p>Another thing I happened to notice is that the original procd is not reaped.  It hangs around in the zombie state.\n\n</p><p></p><hr/>\n<em>2011-Nov-18 21:19:12 by danb:</em> <br/>\n\nI discovered why the environment behaves strangely after restart of the master.  The problem is caused by the following code in the master:\n\n<p></p><pre>                // Get rid of the CONDOR_INHERIT env variable.  If it is there,\n                // when the master restarts daemon core will think it's parent\n                // is a daemon core process.  but, its parent is gone ( we are doing\n                // an exec, so we disappear), thus we must blank out the\n                // CONDOR_INHERIT env variable.\n        char    tmps[256];\n        sprintf( tmps, \"%s=\", EnvGetName( ENV_INHERIT ) );\n        putenv( tmps );\n</pre>\n\n<p>The problem with that code is that it puts a string from the stack into the environment.  Once we exit from that stack frame, the memory can become corrupted.\n\n</p><p>The reason the Env object does not see some environment variables that getenv() does see is that in <code>MergeFrom( char const * const *stringArray )</code>, it stops on the first invalid environment entry (i.e. an entry missing an assignment), whereas getenv() must keep going.\n\n</p><p></p><hr/>\n<em>2011-Nov-18 21:43:27 by danb:</em> <br/>\n\nI made two patches.  The patch for the master corrupting its environment is for 7.6.5.  The patch for the Env object's treatment of invalid entries is for 7.7.5.\n\n<p></p><hr/>\n<em>2012-Jan-09 12:36:29 by zmiller:</em> <br/>\n\n<strong>REVIEWED</strong> by zmiller, found no problems.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-29 12:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/623ba4ec1b55814cae5dd42f4111a407e2a5efb3\">[28481]</a></span>: Edits to lots of 7.6.5 version history items. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2643\" onclick=\"get_ticket_and_populate_wrapper('2643'); return false;\" title=\"Win32 Condor tries to use user from the submit host on remote host\">#2643</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2644\" onclick=\"get_ticket_and_populate_wrapper('2644'); return false;\" title=\"SetEffectiveOwner fails to detect current owner is effective owner\">#2644</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2387\" onclick=\"get_ticket_and_populate_wrapper('2387'); return false;\" title=\"transfer_input_files doesn't transfer directories on Windows.\">#2387</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2614\" onclick=\"get_ticket_and_populate_wrapper('2614'); return false;\" title=\"restart of glidein master causes leaked glexec processes\">#2614</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2660\" onclick=\"get_ticket_and_populate_wrapper('2660'); return false;\" title=\"% sign in hold message causes crash when writing xml user log\">#2660</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-21 10:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3212c418701962264b9dbf5589fec95436f494c9\">[28368]</a></span>: Cleaned up semantics of Env object. Fixed failing unit test. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2614\" onclick=\"get_ticket_and_populate_wrapper('2614'); return false;\" title=\"restart of glidein master causes leaked glexec processes\">#2614</a></span> Now using Import() in place of MergeFrom() in several places, because the former is intended for the case where one wishes to silently skip over indigestible entries in the environment. However, the semantics of MergeFrom() are now at\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-18 21:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c60fe993e17b66068553c55f9c40f093d851120a\">[28359]</a></span>: Make the Env object behave like getenv() in its treatment of invalid environment entries. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2614\" onclick=\"get_ticket_and_populate_wrapper('2614'); return false;\" title=\"restart of glidein master causes leaked glexec processes\">#2614</a></span> When merging the environment into the Env object, it was aborting on the first invalid entry, whereas getenv() will return the value of environment variables that come after the invalid entry.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-18 21:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f113e521a517f369767eb84a23aaa6f6902403f9\">[28358]</a></span>: Documented fix for master environment corruption on restart. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2614\" onclick=\"get_ticket_and_populate_wrapper('2614'); return false;\" title=\"restart of glidein master causes leaked glexec processes\">#2614</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-18 21:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eaa7c5e7314875ffc8f10efba86ef3d9f0d5fb95\">[28357]</a></span>: Fix a problem causing corruption of master's environment on restart. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2614\" onclick=\"get_ticket_and_populate_wrapper('2614'); return false;\" title=\"restart of glidein master causes leaked glexec processes\">#2614</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jan-30 14:55", "status": "resolved", "created": "2011-Nov-02 17:45", "fixed_version": "2011-Nov-02 17:45", "broken_version": "v070603", "priority": "3", "subsystem": "", "assigned_to": "danb", "derived_from": "#2753", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}