{"id": 5726, "title": "Ticket #5726: Fix HAD/REPLICATION problems with shared port.", "description": "<blockquote>\nSee <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5301\" onclick=\"get_ticket_and_populate_wrapper('5301'); return false;\" title=\"Shared Port and HAD don't work together\">#5301</a></span> for the previous work-arounds.\n\n<p>It appears that the HAD and REPLICATION daemons expect to be born with an active command socket, so it shouldn't be too hard to make them accept shared port connections.  The problem comes with the HAD_LIST and REPLICATION_LIST configuration knobs, which expect to be [hostname|IPv4 literal]:protNo.\n\n</p><p>The least-incorrect solution is probably to have the HAD and REPLICATION daemons rendezvous in the collector(s); then we don't have to worry about configuration at all.  Arguably, the next-best solution would be to accept full Sinfuls, but that has some serious usability drawbacks (since full Sinfuls are tricky to generate except by running the daemon in question, and even then don't compensate for DNS drift the way hostnames do).  The next possibility is to implement the list as full Sinfuls, but carefully craft the documentation so that only something like\n\n</p><p></p><div class=\"verbatim\">\n<pre>&lt;1.2.3.4:5?sock_id=had&gt;\n</pre></div>\n\n\n<p>is necessary.\n\n</p><p>However, it occurred to me, in the spirit of user-friendliness, rather than make the user specify a shared port ID in the config file, we should supply a default identifier.  Then it occurred to me that there's really no reason to run more than one HAD and/or more than REPLICATION daemon behind the same shared port daemon -- that is, if we just had the master (if using shared port) set those two daemon's sock ids to their subsys names, we'd avoid the issue of the user having to specify the shared port ID entirely: the existing [HAD|REPLICATION]_LIST entries carry enough information to connect to the shared port daemon.  On the other hand, they don't say if that daemon is using shared port.\n\n</p><p>ToddT then suggested that we could just assume that they were -- try using shared port and see if it works; if it doesn't, try again without it.  Since daemons just ignore unregistered commands, this should be safe.  (The shared port daemon will forward unknown commands to the collector, but the collector will then ignore the HAD or REPLICATION daemon command sent to it.  This is a little unfortunate, because it clutters up the wrong log, but since shared port will be on by default in 8.6, it still makes sense to try shared port first.)\n\n</p><p>This then raises the question about why we don't name all (except the shadow and starter) shared port daemon sockets after the subsys name, but that's another issue for another time.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-14 15:19:46 by tlmiller:</em> <br/>\n\nJaime points out the CMS is currently using three negotiators, so we can't assume that each shared port daemon has one HAD and one REPLICATION daemon.\n\n<p>However, the master does understand and respect the -sock option in each daemon's ARGS, so if we tell people to use that, we could then have the HAD or REPLICATION daemon use its own shared port ID to append to the _LIST elements.\n\n</p><p>The question then becomes if we try both shared port and non-shared port when we do.  Although it seems fair to assume/require that an explicitly-set port or shared-port name flag is indicative of intention for other daemons in the group, this may run into problems setting defaults.  ToddT and I decided that I'd implement the retry if it didn't take too long to do so (the default, using shared port, we try first, so that the creepy unknown-command messages would more likely show up in the HAD or REPLICATION logs than the collector).\n\n</p><p>Current configuration is highly manual (no defaults at all?), so at least for the first pass, we don't have to do anything clever.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-30 15:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/177a524580a6d8eb89dd7ad26bc85075e05c5f40\">[48715]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5726\" onclick=\"get_ticket_and_populate_wrapper('5726'); return false;\" title=\"Fix HAD/REPLICATION problems with shared port.\">#5726</a></span>) Missed the need for [HAD|REPLICATION].USE_SHARED_PORT = FALSE.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-29 14:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92f35b0015f5c5c8b43a19aa268d8a824e9e6376\">[48700]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5705\" onclick=\"get_ticket_and_populate_wrapper('5705'); return false;\" title=\"Add NumJobCompletions to job ad.\">#5705</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5726\" onclick=\"get_ticket_and_populate_wrapper('5726'); return false;\" title=\"Fix HAD/REPLICATION problems with shared port.\">#5726</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5728\" onclick=\"get_ticket_and_populate_wrapper('5728'); return false;\" title=\"Sinful::addressPointsToMe() can't just compare the primary address.\">#5728</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-16 11:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c0d7aa000dd94ad6b4befe2b258f39ccf38ceeca\">[48571]</a></span>: Squashed commit of the following: commit 1f72850da8c73037f1d7bf47fbb1b1e38bb13d81 Author: Todd L Miller &lt;tlmiller@cs.wisc.edu&gt; Date: Wed Jun 15 10:21:07 2016 -0500\u00a0[...]\n (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-29 14:12", "status": "resolved", "created": "2016-Jun-13 17:12", "fixed_version": "2016-Jun-13 17:12", "broken_version": "", "priority": "4", "subsystem": "Daemons", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}