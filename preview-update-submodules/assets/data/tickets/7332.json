{"id": 7332, "title": "Ticket #7332: GSI bug with newer OpenSSL", "description": "<blockquote>\nA bug in GSI causes client and server to get out-of-sync with newer versions of OpenSSL (first noticed in Ubuntu 18).\n\n<p>A patch has been applied to our Globus external and submitted to the gridcf <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GitHub\" title=\"Git Hub\">GitHub</a></span> project (<a class=\"external\" href=\"https://github.com/gridcf/gct/pull/136\">https://github.com/gridcf/gct/pull/136</a>).\n\n</p><p>It's unknown if this can be worked around at the Condor layer.\n\n</p><p><span class=\"subsection\"></span></p><h3>Original Ticket Description</h3>\n\n<p>The GSI auth tests started failing on Ubuntu 18. Investigate why.\n\n</p><p>To reproduce, create empty directory and place attached Dockerfile in it.  From within that directory:\n</p><div class=\"code\">\n<pre class=\"code\">docker build .\ndocker run -t -i &lt;imagehash&gt; /bin/bash\n\n#inside docker container:\nsu - condor\ncondor_master\nsh run_this\n</pre></div>\n\n\n<p>If you do this on dumbo.chtc.wisc.edu likely everything is cached.  Image id is 0ef6c9db9803</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Dec-16 11:20:49 by tim:</em> <br/>\n\nZach tried this test on the build machine and it worked there in env matching the build. Still investigating\n<hr/>\n<em>2020-Apr-10 07:42:27 by tim:</em> <br/>\n\nBulk change of target version from v080808 to v080809 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-Aug-20 22:38:27 by jfrey:</em> <br/>\n\nThere's a bug in GSI in function gss_init_sec_context(). When the client side finishes the SSL handshake, if there's a payload to be sent to the server, it indicates that the full authentication protocol is complete. The client then skips the post-handshake data exchange, putting the two sides out of sync. In older versions of openssl, the client SSL code appears to wait for a reply from the server before indicating the SSL handshake is done. On Ubuntu 18, the client SSL code indicates the handshake is done while providing a payload to send to the server. Fixing the bug causes the GSI authentication to succeed on Ubuntu 18. But the GSI test still fails on Ubuntu 20, Debian 10, and CentOS 8.\n\n<p>Additionally, there's a bug in the Condor layer when there's a network error when receiving the post-handshake message from the server about whether it's happy about the handshake. This can cause the client to think the server is happy when it is not.\n\n</p><p></p><hr/>\n<em>2020-Oct-19 13:05:59 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: The changes to the Condor code look good.  I did not review the proposed changes to GSI, and am leaving that for their development team.  Resolving.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=7827\" onclick=\"get_ticket_and_populate_wrapper('7827'); return false;\" title=\"Update GSI credentials for GSI test\">#7827</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nUpdate GSI credentials for GSI test</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/1053/Dockerfile\">Dockerfile</a>\n5173 bytes added by zmiller on 2020-Aug-19 20:04:27 UTC.\n<br/>\nSee remarks about for how to use this Dockerfile<br/>\n</li><li><a href=\"../files/1054/gssapi_init.patch\">gssapi_init.patch</a>\n497 bytes added by jfrey on 2020-Aug-21 03:39:34 UTC.\n<br/>\nPatch for GSI bug in gss_init_sec_context()<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Oct-20 21:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d066e6656be88d90a0dac4f3395dadc604e7c688\">[61537]</a></span>: Docs for GSI authentication bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7332\" onclick=\"get_ticket_and_populate_wrapper('7332'); return false;\" title=\"GSI bug with newer OpenSSL\">#7332</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-24 15:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1d7577d43d1ebff79014a90f1861ee214a851bce\">[60521]</a></span>: Fix bug in CEDAR GSI auth where client missed handshake failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7332\" onclick=\"get_ticket_and_populate_wrapper('7332'); return false;\" title=\"GSI bug with newer OpenSSL\">#7332</a></span> After the GSI/SSL handshake, the server sends an integer to the client indicating whether it succeeded, which the client receives into the local variable 'status'. On a communication failure, the client assumes that the value of 'status'\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-24 15:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4c966095d39549af794bcd593ad9c4b38120768c\">[60520]</a></span>: Fix GSI bug that can drop final client data during SSL handshake. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7332\" onclick=\"get_ticket_and_populate_wrapper('7332'); return false;\" title=\"GSI bug with newer OpenSSL\">#7332</a></span> When doing the SSL handshake in gss_init_sec_context(), if globus_i_gsi_gss_handshake() indicates the handshake is complete while there's a final data payload to send, the data is silently dropped. This puts the client and server\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Oct-19 13:06", "status": "resolved", "created": "2019-Oct-21 11:43", "fixed_version": "2019-Oct-21 11:43", "broken_version": "v080806", "priority": "1", "subsystem": "Security", "assigned_to": "jfrey", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "zmiller@cs.wisc.edu, jfrey@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}