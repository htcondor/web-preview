{"id": 2014, "title": "Ticket #2014: Allow PrivSep to work with PID namespaces", "description": "<blockquote>\nWe need to make sure <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span> can work with PID namespaces.\n\n<p>The \"final\" solution to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1959\" onclick=\"get_ticket_and_populate_wrapper('1959'); return false;\" title=\"Implement per-job PID namespaces.\">#1959</a></span> was twofold:\n</p><ol>\n<li>(Most of the code) Move registration of child with ProcD to the parent.\n</li><li>(Simple flag) Ask for a PID namespace when clone'ing\n</li></ol>\n\n<p>Talking with ZKM and Todd, we decided that we wanted to get (1) into testing ASAP (as there is a high likelihood of breakage because we're changing some pretty core control flow of daemon_core).  Next up, we need to add support for <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span>.\n\n</p><p>The basic thought is we will introduce some new communication channel (perhaps a pipe) that is opened between the switchboard and the starter.  The switchboard will clone/exec, but the child will be created with the CLONE_PARENT flag so the user job will become a child of the starter at birth (as opposed to the switchboard, its \"natural\" parent).  Then, the switchboard will communicate back the PID of the child (again, perhaps through the pipe), and Create_Process will tell the starter to watch the \"real child\", not the switchboard.\n\n</p><p>So, the task list is something like this:\n\n</p><p></p><ol>\n<li>Commit <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1959\" onclick=\"get_ticket_and_populate_wrapper('1959'); return false;\" title=\"Implement per-job PID namespaces.\">#1959</a></span> to change the daemon_core control flow.\n</li><li>Teach Create_Process to know about <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span> and pass the switchboard an extra pipe for communication.\n</li><li>Teach the switchboard how to correctly clone a new PID namespace.\n</li></ol>\n\n<p>As part of the last item, we now have a more feature-rich means of communicating with daemon_core from the switchboard: it might be worth it to follow up in another ticket and improve error handling of exec failures.</p></blockquote>", "remarks": "<blockquote>\nNote: made some changes to the ticket, as it mixed cgroups and PID namespaces.\n\n<p>I did some initial investigation into this.  The basic problem with this approach is that daemon_core has no knowledge of <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span>.  This covered by a conditional when launching the process in the starter.\n\n</p><p>This seems wrong.  Why not make <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span> something done by daemon_core?  In such a case, this ticket would be rather straightforward.  Without it, I'd have to sprinkle special <span class=\"wiki\"><a href=\"wiki?p=PrivSep\" title=\"Priv Sep\">PrivSep</a></span> knowledge throughout the system.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "enhance", "last_change": "2011-May-02 18:32", "status": "new", "created": "2011-Mar-30 17:13", "fixed_version": "2011-Mar-30 17:13", "broken_version": "", "priority": "4", "subsystem": "Daemons", "assigned_to": "bbockelm", "derived_from": "#1831", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "zmiller@cs.wisc.edu danb@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}