{"id": 5535, "title": "Ticket #5535: Partitionable slots can sometimes provision too little disk", "description": "<blockquote>\nWhen running on a partitionable slot with a large amount of disk, sometimes the dynamic slot is provisioned with too little disk, so that the new job doesn't match the dynamic slot, even thought it was created just for this job.</blockquote>", "remarks": "<blockquote>\n<em>2016-Feb-25 20:46:02 by tim:</em> <br/>\n\nThis looks to be related to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5398\" onclick=\"get_ticket_and_populate_wrapper('5398'); return false;\" title=\"Cannot create more than 100 dynamic slots because of Disk allocation\">#5398</a></span>. However, there are two statements that used get_total_disk that are updated. Only one statement was changed in this update. Is that correct? Should this be backported to stable?\n\n<p></p><hr/>\n<em>2016-Mar-10 14:20:18 by tannenba:</em> <br/>\n\nSince <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5398\" onclick=\"get_ticket_and_populate_wrapper('5398'); return false;\" title=\"Cannot create more than 100 dynamic slots because of Disk allocation\">#5398</a></span> has now been reverted, it seems like this patch needs to be backported to v8.4.\n\n<p></p><hr/>\n<em>2016-Mar-10 14:21:28 by bbockelm:</em> <br/>\n\nHi,\n\n<p>In CMS, we saw this happening with a variety of disk sizes - including small disks.\n\n</p><p>In fact, one can work around this (I think) by setting DISK to a gigantic value such that 1% of the total is larger than a reasonable allocation request.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2016-Mar-15 16:06:49 by gthain:</em> <br/>\n\nMy understanding is that CMS is seeing a problem where dslots are created correctly from the pslot on first use, but then claim reuse is failing in the startd when a second job tries to reuse the slot.  Claim reuse fails because the dslot's Disk attribute is smaller than the Request_disk in the job ad, even though it matched in the schedd.\n\n<p>This is because the \"Disk\" attribute in the pslot means \"currently free kbytes of disk on the execute partition\", for some value of \"current\".  Unlike the Memory and Cpus attribute, the value of the Disk attribute changes constantly, although the collector's copy of the job ad may not have the most up-to-date version.  The attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalSlotDisk\" title=\"Total Slot Disk\">TotalSlotDisk</a></span> does not change, but it isn't used for anything.\n\n</p><p>The Disk attribute in the dslots and static slot is based on the fraction of the pslot the job initially requested.  So, if whatever the job requested for disk was 10% of the currently available disk in the pslot, the startd remembers that it was 10%, and gives it that fraction.  The buggy thing is that as the free disk in the pslot grows or shrinks, the disk attribute in the dslot is updated to be 10% of the pslot value.  I guess this thinking goes back to static slots, and assuming the execute directory is shared with non-condor uses.\n\n</p><p>Also, although the startd support overriding MEMORY and NUM_CPUS in the config file, it doesn't support a DISK attribute.\n\n</p><p>So, I propose that the Disk attribute for dslots be fixed over their lifetime, and that we add a DISK param, if only for testing and debugging.\n\n</p><p></p><hr/>\n<em>2016-Mar-21 14:30:30 by johnkn:</em> <br/>\n\n<strong>code_review</strong> this change is very subtle. but it looks good to me.  It will round up disk requests from a Kbytes request to .1 % of current disk, thereby allowing up to 500 slots without running out of disk while also guaranteeing that the disk allocation has a slop of about .1% of disk and thus has a bit of room to decrease from the allocated amount without causing the slot activation to fail.\n\n<p></p><hr/>\n<em>2016-Aug-10 13:41:11 by tannenba:</em> <br/>\n\nFor people who are hit by this bug, the best option is to upgrade to HTCondor v8.4.5 or newer.\n\n<p>If you cannot upgrade, one possible immediate work-around would be to alter the <code>WithinResourceLimits</code> expression (which is referenced by the Requirements expression of the slot) in the slot ad so that it only considers CPUs and Memory and ignores disk space. I say \"possible\" because I didn't test it, but I think it will work around the bug. Of course, the down side is you'd better be sure you don't have jobs that exhaust the disk space on these nodes since the startd will no longer examine the job's <code>RequestDisk</code>.\n\n</p><p></p><pre>   WithinResourceLimits = ( ifThenElse(TARGET._condor_RequestCpus =!= \\\nundefined,MY.Cpus &gt; 0 &amp;&amp; TARGET._condor_RequestCpus &lt;= \\\nMY.Cpus,ifThenElse(TARGET.RequestCpus =!= undefined,MY.Cpus &gt; 0 &amp;&amp; \\\nTARGET.RequestCpus &lt;= MY.Cpus,1 &lt;= MY.Cpus)) &amp;&amp; \\\nifThenElse(TARGET._condor_RequestMemory =!= undefined,MY.Memory &gt; 0 &amp;&amp; \\\nTARGET._condor_RequestMemory &lt;= MY.Memory,ifThenElse(TARGET.RequestMemory =!= \\\nundefined,MY.Memory &gt; 0 &amp;&amp; TARGET.RequestMemory &lt;= MY.Memory,false)) )</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-21 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38767a3d051dfd09c5760492d5f8709827db6ba5\">[48065]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5552\" onclick=\"get_ticket_and_populate_wrapper('5552'); return false;\" title=\"Propagate memory and disk usage in Condor-C and Job Router\">#5552</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5535\" onclick=\"get_ticket_and_populate_wrapper('5535'); return false;\" title=\"Partitionable slots can sometimes provision too little disk\">#5535</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5555\" onclick=\"get_ticket_and_populate_wrapper('5555'); return false;\" title=\"Broken LOWPORT/HIGHPORT on Windows.\">#5555</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5504\" onclick=\"get_ticket_and_populate_wrapper('5504'); return false;\" title=\"condor_off -peaceful does not contact all requested machines\">#5504</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-16 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/16fe28e5671f295de637acd0f6424ca091ce8c3a\">[48046]</a></span>: Re-introduce patch to all &gt; 100 disk slots, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5535\" onclick=\"get_ticket_and_populate_wrapper('5535'); return false;\" title=\"Partitionable slots can sometimes provision too little disk\">#5535</a></span> But only 500 slots, not 10,000 slots This reverts commit 78c3b4b7f64de855e8d42c10a698c413936c21e2.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-16 14:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1f9a38484aa9aa42db7e630d6d27af13eefaabbb\">[48045]</a></span>: Add DISK parameter to fix and force free disk advertisment <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5535\" onclick=\"get_ticket_and_populate_wrapper('5535'); return false;\" title=\"Partitionable slots can sometimes provision too little disk\">#5535</a></span> Add new DISK param, free disk space in kbytes. If unset, default to querying system for free disk space in execute directory.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-25 18:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0a62d662f66df0ef766db1a4bdf6e4ff4615a2a9\">[47657]</a></span>: Correctly compute disk fraction for dslots <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5535\" onclick=\"get_ticket_and_populate_wrapper('5535'); return false;\" title=\"Partitionable slots can sometimes provision too little disk\">#5535</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Aug-10 13:41", "status": "resolved", "created": "2016-Feb-25 15:53", "fixed_version": "2016-Feb-25 15:53", "broken_version": "v080403", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "#4490", "creator": "gthain", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu, burt@fnal.gov", "due_date": ""}