{"id": 2779, "title": "Ticket #2779: allow checkpoint before startd auto-restarts due to an updated binary", "description": "<blockquote>\nWe would like to revisit the question of live upgrading of Condor. In particular, the sequence of events that occur when the condor daemons auto-detect a new binaries on disk and auto-retart. Here is a typical sequence of events:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">01/18/12 19:23:34 /usr/sbin/condor_master was modified, restarting /usr/sbin/condor_master.\n01/18/12 19:23:34 Sent SIGTERM to CKPT_SERVER (pid 8168)\n01/18/12 19:23:34 Sent SIGTERM to STARTD (pid 5234)\n01/18/12 19:23:34 DaemonCore: pid 8168 exited with status 0, invoking reaper 1 &lt;Daemons::AllReaper()&gt;\n01/18/12 19:23:34 The CKPT_SERVER (pid 8168) exited with status 0\n01/18/12 19:23:34 DaemonCore: return from reaper for pid 8168\n01/18/12 19:23:34 DaemonCore: pid 5234 exited with status 0, invoking reaper 1 &lt;Daemons::AllReaper()&gt;\n01/18/12 19:23:34 The STARTD (pid 5234) exited with status 0\n01/18/12 19:23:34 All daemons are gone.  Restarting.\n</pre></div>\n\n\n<p>What would it take to add some dependencies in the shutdown process so that in the typical LIGO case the CKPT_SERVER is given time to checkpoint jobs from the STARTD on the same server?</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Jan-24 17:23:07 by bbockelm:</em> <br/>\n\nOh!  Maybe I can hijack this ticket for something our admins complain <strong>bitterly</strong> about.\n\n<p>I should be able to configure the condor startd to \"peacefully restart\" when it auto-restarts.  That is, it should either vacate or drain the running jobs (pros and cons to each approach), then restart.  I.e., something analogous to the difference between a \"fast shutdown\" versus a \"peaceful shutdown\".\n\n</p><p>Our site admins have indicated that a reason they don't update Condor more frequently is because of the lack of a \"peaceful restart\" for upgrades.\n\n</p><p>This ticket references checkpointing explicitly, but I think a solution may be able to cover both use cases.\n\n</p><p></p><hr/>\n<em>2012-Feb-10 14:46:08 by pfc:</em> <br/>\n\nUpdated priority to match Todd's new scheme (1=fire, 2=soon, 3=time permitting, 4=not yet prioritized, 5=wishlist/ideas).\n\n<p></p><hr/>\n<em>2012-Feb-13 11:37:57 by johnkn:</em> <br/>\n\nI propose to solve this by stopping the STARTD first on peaceful stop, then stopping the rest of the daemons.  This should allow job to checkpoint, which solves the specific problem.\n\n<p>I also propose to add a config knob to allow setting the restart mode when\nnew-binaries are detected so that restarting peacefully would be an option.\n\n</p><p>-tj\n\n</p><p></p><hr/>\n<em>2012-Feb-17 11:05:58 by johnkn:</em> <br/>\n\nThe patch <a class=\"external\" href=\"https://github.com/htcondor/htcondor/commit/bbb8ce68f3d2334ff76a115cdf9bf91075598378\">[30633]</a> changes the master so that it restarts in either GRACEFUL or PEACEFUL mode, it will shut down the STARTDs and wait for them to exit before it shuts down any other daemon.\n\n<p>This should give the jobs a chance to checkpoint before any local checkpoint servers are shut down.\n\n</p><p>In order to fix a race condition with this change, it was necessary to change the master to that it looks only with the timestamp of the condor_master binary. Otherwise daemons would shut down in the order that the master noticed the timestamps on their binaries change.\n\n</p><p>This patch also introduces a new config param MASTER_NEW_BINARY_RESTART which can have the value GRACEFUL, PEACEFUL or NEVER (with NONE or NO being accepted as synonyms for NEVER).\n\n</p><p>This patch also fixes as stumble upon bug where condor_off -master -peaceful would tell the master to shutdown peacefully, but the master would not tell it's children to shut down peacefully.\n\n</p><p>It is worth nothing that I noticed another design flaw in the way peaceful shutdown is implemented.  Once a daemon as been told to shut down peacefully, it can no longer be shut down gracefully.  (it can still be shutdown fast).\n\n</p><p></p><hr/>\n<em>2012-Feb-22 16:23:10 by jfrey:</em> <br/>\n\nHere are my comments on <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bbb8ce68f3d2334ff76a115cdf9bf91075598378\">[30633]</a></span>:\n\n<p></p><ul>\n<li>Now, master never restarts a daemon when that daemon's binary changes.\n  It only does so if the master's own binary changes.\n  If that's the desired behavior, we need to clearly document this loss\n  of functionality.\n\n<p></p></li><li>Daemons::CheckForNewExecutable() shouldn't call CancelNewExecTimer().\n  That timer should be canceled or not started in Daemons::StartTimers()\n  and/or Daemons::StartNewExecTimer(). Unfortunately, getting it right\n  is a bit of a mess with where these methods are called.\n  As it is, you can't change MASTER_NEW_BINARY_RESTART from NONE to\n  PEACEFUL/GRACEFUL and have the master start checking again on a\n  reconfig without also changing MASTER_CHECK_NEW_EXEC_INTERVAL.\n\n<p></p></li><li>Daemons::SetAllReaper() parameter fStartdsFirst is always false.\n  Remove the parameter and setting of\n  stop_other_daemons_when_startds_gone.\n\n<p></p></li><li>There is a DC_OFF_PEACEFUL command that the master can send to\n  children instead of DC_SET_PEACEFUL_SHUTDOWN followed by SIGTERM.\n  But the daemon class seems to only want to use real unix signals,\n  and not CEDAR signals. This isn't a request to change the code, just\n  an observation.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-May-02 14:30:41 by tstclair:</em> <br/>\n\n<ul>\n<li>Now, master never restarts a daemon when that daemon's binary changes. It only does so if the master's own binary changes. If that's the desired behavior, we need to clearly document this loss of functionality.\n</li></ul>\n\n<p>Why is this delta a requirement given the ticket (startd constraint).\n\n</p><p></p><hr/>\n<em>2012-May-07 14:16:38 by tstclair:</em> <br/>\n\nIt should be noted that the work-around is to send the -peaceful to the daemon that a user wishes to restart.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-13 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38108299ecf5d38eff8b43dc55982df75898b3f6\">[30891]</a></span>: completed definition of MASTER_NEW_BINARY_RESTART ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2779\" onclick=\"get_ticket_and_populate_wrapper('2779'); return false;\" title=\"allow checkpoint before startd auto-restarts due to an updated binary\">#2779</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-08 12:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05d26ba9fa8fa27f9028103d3fac7280f13442f0\">[30863]</a></span>: Incomplete documentation of new MASTER_NEW_BINARY_RESTART knob. ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2779\" onclick=\"get_ticket_and_populate_wrapper('2779'); return false;\" title=\"allow checkpoint before startd auto-restarts due to an updated binary\">#2779</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-01 15:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b48edb688302c981a148da237c4c0a896c00156e\">[30769]</a></span>: don't kill the newexec timer in CheckForNewExecutable() in the master based on jfrey's review. for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2779\" onclick=\"get_ticket_and_populate_wrapper('2779'); return false;\" title=\"allow checkpoint before startd auto-restarts due to an updated binary\">#2779</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-01 10:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ae2735b5fc126e734c5b613cd9378d2d7dc10ec\">[30746]</a></span>: Fixed 2 separate LaTeX errors for recent commits -- the manual could not even be built with these errors. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2839\" onclick=\"get_ticket_and_populate_wrapper('2839'); return false;\" title=\"Fix copying of scaling factors in classad literals\">#2839</a></span> ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2779\" onclick=\"get_ticket_and_populate_wrapper('2779'); return false;\" title=\"allow checkpoint before startd auto-restarts due to an updated binary\">#2779</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-17 10:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/50486d208c2433dbb32fdac1f007ae722833db19\">[30634]</a></span>: Version history for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2779\" onclick=\"get_ticket_and_populate_wrapper('2779'); return false;\" title=\"allow checkpoint before startd auto-restarts due to an updated binary\">#2779</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-17 09:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bbb8ce68f3d2334ff76a115cdf9bf91075598378\">[30633]</a></span>: Have the master shutdown STARTDs before other daemons on GRACEFUL or PEACEFUL shutdown/restart <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2779\" onclick=\"get_ticket_and_populate_wrapper('2779'); return false;\" title=\"allow checkpoint before startd auto-restarts due to an updated binary\">#2779</a></span> Also add a new config param MASTER_NEW_BINARY_RESTART which can have the value GRACEFUL, PEACEFUL or NEVER. The default value is GRACEFUL. This change necessitates that we no longer check for new binaries\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-May-10 16:56", "status": "defer", "created": "2012-Jan-23 13:34", "fixed_version": "2012-Jan-23 13:34", "broken_version": "", "priority": "5", "subsystem": "Daemons", "assigned_to": "johnkn", "derived_from": "", "creator": "pfc", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "anderson@ligo.caltech.edu, bbockelm@cse.unl.edu tannenba@cs.wisc.edu tstclair@redhat.com matt@cs.wisc.edu,pcouvare@caltech.edu", "due_date": "20120220"}