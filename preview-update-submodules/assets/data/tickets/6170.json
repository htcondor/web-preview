{"id": 6170, "title": "Ticket #6170: DAGMan crashes when parsing DAG with many splices.", "description": "<blockquote>\nDAGMan crashed when parsing a complex DAG that included several \"layers\" of splices, with somewhere around 100 splices total.  I'm not attaching that DAG yet, because it's so complex -- I'm hoping to be able to simplify what it takes to reproduce the problem.\n\n<p>Here's the stack track from dagman.out:\n\n</p><p></p><pre>  Stack dump for process 29754 at timestamp 1488494450 (10 frames)\n  /scratch/wenger/condor_build/git14/release_dir/bin/..\n    /lib/libcondor_utils_8_6_2.so(dprintf_dump_stack+0x12d)[0x7fbb8567269d]\n  /scratch/wenger/condor_build/git14/release_dir/bin/..\n    /lib/libcondor_utils_8_6_2.so(+0x1e0eb2)[0x7fbb85651eb2]\n  /lib64/libpthread.so.0[0x3bfb40f7e0]\n  condor_scheduniv_exec.4226.0(_ZN3Dag22AssumeOwnershipofNodesERK8MyStringP14OwnedMaterials+0x83)[0x41b9c3]\n  condor_scheduniv_exec.4226.0(_ZN3Dag11LiftSplicesE11SpliceLayer+0x158)[0x41c7b8]\n  condor_scheduniv_exec.4226.0(_Z5parseP3DagPKcbb+0x9b7)[0x4318f7]\n  condor_scheduniv_exec.4226.0(_Z9main_initiPPc+0x7f2)[0x42cc52]\n  /scratch/wenger/condor_build/git14/release_dir/bin/..\n    /lib/libcondor_utils_8_6_2.so(_Z7dc_mainiPPc+0x1790)[0x7fbb8575b500]\n  /lib64/libc.so.6(__libc_start_main+0xfd)[0x3bfb01ed5d]\n  condor_scheduniv_exec.4226.0[0x40ec39]\n</pre>\n\n<p>Here's what I've found out so far:  when the nodes are \"lifted\" from one splice (which has something like 87 splices, and no \"regular\" nodes, within it), one sub-splice is not deleted after the lifting process.  That then causes the above segfault when the parent splice is getting lifted to a yet-higher level.\n\n</p><p>I don't know what's unique about the splice that fails -- other, similar, splices within the same overall workflow get parsed correctly.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Mar-03 16:08:07 by wenger:</em> <br/>\n\nHmm -- it's looking like this is a bug in the code that handles interaction of HashTable::remove() and HashTable::iterate().\n\n<p></p><hr/>\n<em>2017-Mar-07 14:58:15 by wenger:</em> <br/>\n\nYes -- the problem is a bug in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> code -- see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span> for details.\n\n<p></p><hr/>\n<em>2017-Mar-08 13:04:46 by wenger:</em> <br/>\n\nNote that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> problem only shows up when multiple splice names hash to index 0 (out of 200).  So whether a given DAG displays this problem depends on the exact names given to the splices.\n\n<p></p><hr/>\n<em>2017-Mar-18 20:30:12 by wenger:</em> <br/>\n\nNote: all commits listed under derived ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span>.\n\n<p></p><hr/>\n<em>2017-Apr-17 17:03:53 by tim:</em> <br/>\n\n<strong>DOC REVIEW:</strong> Looks good</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRemoving items while iterating <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> can fail</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-07 15:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/141b0974aabb970c5131298d065f8ee5014f8f33\">[50281]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6177\" onclick=\"get_ticket_and_populate_wrapper('6177'); return false;\" title=\"Removing items while iterating HashTable can fail\">#6177</a></span>: Committing a fix to the basic problem (also see gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6170\" onclick=\"get_ticket_and_populate_wrapper('6170'); return false;\" title=\"DAGMan crashes when parsing DAG with many splices.\">#6170</a></span>); need to do further checking/testing of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span> code to look for other problems...  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Apr-17 17:03", "status": "resolved", "created": "2017-Mar-03 11:09", "fixed_version": "2017-Mar-03 11:09", "broken_version": "v080601", "priority": "1", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "wenger@cs.wisc.edu, ckoch5@wisc.edu", "due_date": ""}