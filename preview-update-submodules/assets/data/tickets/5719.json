{"id": 5719, "title": "Ticket #5719: Negotiator writes duplicate data to AccountantnewLog, slows negotiatio", "description": "<blockquote>\nLIGO reports that their negotiator runs so slowly at Caltech that it the negotiator ad ages out of the collector unless the Accountantnew.log file is put in /dev/shm.  Also, they have a large number (&gt; 2k) of accounting groups.\n\n<p>Inspection shows the following problems:\n\n</p><p>For users or groups with no current or recent historical usage, and whose HTCondor priority has aged out to the minimum value (0.5), we first calculate a new value &lt; 0.5, write it to the accountant log, then check to see if it is below the threshold, cap it up to the threshold, and write the new value out.  The result of this is that every negotiation cycle, we write two entries to the log file for every idle group or user when we should be writing none.\n\n</p><p>Also, at the end of every negotiation cycle, we write out all the accounting info for every group and user, even when it doesn't change.  As a result, we tend to rotate (compress) the Accountantnew.log file on every cycle, which defeats the purpose of storing it in a transaction log format.  note that the MAX_ACCOUNTANT_DATABASE_SIZE knob doesn't quite do what you'd expect -- it sets the maximum size of the file until it is hit the first time.  After compression, the accountant sets it to 2x the compressed size.\n\n</p><p>So, for this ticket, we will only write to the accountant's transaction log when values actually change, instead of unconditionally.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-10 11:01:12 by tannenba:</em> <br/>\n\nShould this patch go into the v8.4 series?\n\n<p></p><hr/>\n<em>2016-Jun-10 13:54:29 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p> This change looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-13 12:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b81b43265f8523dc85384bd72a0fa7d3e49d542e\">[48539]</a></span>: Document <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5719\" onclick=\"get_ticket_and_populate_wrapper('5719'); return false;\" title=\"Negotiator writes duplicate data to AccountantnewLog, slows negotiatio\">#5719</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-10 10:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d360a10e5d989adbc003f62c2bbbba1ee6a80285\">[48534]</a></span>: Only log accounting data when it changes, not unconditionally <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5719\" onclick=\"get_ticket_and_populate_wrapper('5719'); return false;\" title=\"Negotiator writes duplicate data to AccountantnewLog, slows negotiatio\">#5719</a></span> With this change we should no longer be compressing and rotating the Accountantnew.log file on every negotiation cycle, which can be very slow for sites with large numbers of groups, or large numbers of historical users.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-13 13:20", "status": "defer", "created": "2016-Jun-09 15:24", "fixed_version": "2016-Jun-09 15:24", "broken_version": "v080500", "priority": "5", "subsystem": "DaemonsCM", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}