{"id": 7319, "title": "Ticket #7319: Provide docker images for building HTCondor from source", "description": "<blockquote>\nCompiling HTCondor from source, especially doing so with all the functionality of the HTCondor RPMs/DEBs at htcondor.org, requires a huge pile of dependencies.  Kerberos, Globus, CREAM, Sphinx, Boost, the list goes on and on.\n\n<p>We want to provide, in the HTCondor git repo, Dockerfiles to produce to create images on supported platforms containing all the\ndependencies needed to build from source all the HTCondor packages, tarballs,\nand documentation as released on htcondor.org.\n\n</p><p>The official HTCondor area on Docker Hub will host the images (for both dev and stable branches), and Docker Hub will be configured to automatically rebuild the images whenever updated in the HTCondor git repo.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Oct-11 12:29:46 by karpel:</em> <br/>\n\nI set up build rules for the CentOS7 image on the repo <code>htcondor/build-centos7</code>:\n\n<p>(git branch/tag) -&gt; (docker tag)\n</p><ul>\n<li><code>master</code> branch -&gt; <code>latest</code>\n</li><li><code>stable</code> tag -&gt; <code>stable</code>\n</li><li><code>latest</code> tag -&gt; <code>dev</code>\n</li><li><code>VX_Y_Z</code> tag -&gt; <code>VX_Y_Z</code>\n</li></ul>\n\n<p>As far as I know there's no way to test whether any of these but the master branch one actually work. Will need to check in with this after our next release to see if the rules fired as expected.\n\n</p><p></p><hr/>\n<em>2019-Oct-11 13:14:01 by karpel:</em> <br/>\n\nI think that we should <code>COPY . home/build/CONDOR_SRC</code> (or whatever), so that when you pull the image you get the source for the version its tagged for. If you do a bind mount because you want to work with your local copy it will silently hide the source in the image, so I don't think there's much user impact beyond having to download the repo as part of the image. Thoughts?\n\n<p></p><hr/>\n<em>2019-Oct-12 21:21:32 by karpel:</em> <br/>\n\nI made a branch <code>7319-jtk-revisions</code>, with the following commits (so far):\n\n<p>The first just runs <code>yum clean all</code> inside each <code>RUN</code> (running it outside will actually increase the image size, not decrease it). This is basically a bugfix.\n\n</p><p>The second is more drastic; it copies the source tree into the image. This means that the image build needs to be done from the repository root, like\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">docker build -f build/docker/centos7/Dockerfile .\n</pre></div>\n\n\n<p>For faster image builds, this second commit also adds a <code>.dockerignore</code> at the repository root which excludes everything in <code>.gitignore</code>, as well as a few other directories that shouldn't be needed inside the image. Unfortunately, the build context is still a few hundred MB. It would be around 100 MB if we didn't include the <code>.git</code> directory (without it, you couldn't easily checkout a different version of the repo from inside the image).\n\n</p><p>If we want to keep that commit, it implies that even if you're planning to bind mount a local source tree into the container, you should pull the closest version of the image from Docker Hub and use that, rather than building the image locally (because every time you build locally, you'll have to re-send the build context even if the entire image build is cached, and that can take a long time). Or, at the least, you should build the image once in the morning and re-use it all day. This is possibly a little kooky.\n\n</p><p>I think the main question is: is this container self-contained (har har), or do you always have to bind mount local source/do a clone inside the container?\n\n</p><p></p><hr/>\n<em>2019-Oct-14 10:24:12 by karpel:</em> <br/>\n\nAfter consulting with GregT, I went ahead and pushed these commits to master.\n\n<p></p><hr/>\n<em>2019-Oct-30 18:34:40 by karpel:</em> <br/>\n\nAfter discussion with ToddT, have reversed course: we're no longer going to bundle the source tree into the image. It's only a <code>git clone/checkout</code> away, and we think people should be bind-mounting source into the container anyway.\n\n<p></p><hr/>\n<em>2019-Oct-31 11:23:59 by tannenba:</em> <br/>\n\n^^^ Actually, I said we should not include the src in the container, but the container on startup should look at a well-known mount point (e.g. /condor_src ) and if the src is not there it should automatically fetch the source (of a specified tag) from github.  I do not think the source should have been removed until the functionality to fetch the source has been added.  I want people to be able to build HTCondor with one docker command line...\n\n<p></p><hr/>\n<em>2019-Oct-31 11:25:51 by karpel:</em> <br/>\n\nMmm, yes, should have referenced my notes when writing the comment :)\n\n<p>My mistake on pulling the source too soon - I can change it back if you'd like. I'd argue it's still a one-liner though (you just need to also do a <code>git clone</code> inside the container). I'll work on the automatic entrypoint next week.\n\n</p><p></p><hr/>\n<em>2019-Dec-20 16:36:04 by tannenba:</em> <br/>\n\nResolving as this is now done, but I don't want to document it until the container can be easily used to build RPMs just like our web site (which means waiting until out-of-source RPM builds work in Jan 2020).</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Feb-25 09:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b23f1e42416fd58244f688a5dcaf4da91616934\">[59036]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) add a few more utility tools to the centos build image  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-11 17:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2ee64c3af10b2a28c863bb835ece616030d18fda\">[58430]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) make sure entrypoint is executable by the build user  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-11 16:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b519be4e5b0dd65bd885c1cad13783ff1134ca8a\">[58429]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) change env var name in entrypoint as well  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-11 16:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/49e06901afcb1c25b219f8e0a40b6729912c5a2b\">[58427]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) tweak environment variable names  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-08 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/31ca43c40500c152cb84fce549e370e8dc5610f9\">[58419]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) do a shallow clone in the entrypoint for speed  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-04 12:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/545df5030208524aea8dc4c7e566e38edb647d5f\">[58354]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) add entrypoint for build image that clones our repo if not found; expand build image readme  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-31 19:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5eb872ec0fa6bdd3ff017f681d795d92ceb81718\">[58316]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) install git  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-30 19:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c38b2642dc0270b04d702258f7df1f48acf0a556\">[58301]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) remove latex dependencies, move workdir up one to facilitate out-of-source builds, add tmux and sphinx-autobuild, remove pip-installed htcondor python package, set more detailed ninja build status line  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-30 18:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7b856b1b23092e53694312b1f1623fff796172c7\">[58300]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) don't copy repo into image, stop making sha-tagged images  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-14 10:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4014a3fa8996408c901bc36245ee58f6bc110604\">[58164]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) additionally produce sha-tagged images (may want to revert this if it produces way too many images on Docker Hub)  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-14 10:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/71b36bec550bb4f49a88329f50d84b00a5964b9b\">[58162]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) copy source tree into image; add .dockerignore at root  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-14 10:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/61fe3567f5073361b66a408076f1ed8c9abca042\">[58161]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>) run yum clean inside each RUN instead of outside  (By <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JoshKarpel\" title=\"Josh Karpel\">JoshKarpel</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-11 11:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/43a3e19910da5bcf7cf770de895961b2018b6431\">[58134]</a></span>: Provide docker image to build HTCondor on CentOS 7. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7319\" onclick=\"get_ticket_and_populate_wrapper('7319'); return false;\" title=\"Provide docker images for building HTCondor from source\">#7319</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Dec-20 16:36", "status": "resolved", "created": "2019-Oct-11 11:45", "fixed_version": "2019-Oct-11 11:45", "broken_version": "", "priority": "3", "subsystem": "Packaging", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelman@morgridge.org karpel@wisc.edu", "due_date": ""}