{"id": 3412, "title": "Ticket #3412: periodic_remove makes jobs idle, not removed from queue", "description": "<blockquote>\nWe received a RUST admin ticket saying that <code>periodic_remove</code> does not necessarily remove jobs from the queue when the expression evaluates to <code>True</code>. Instead, it appears that the job is made idle instead of being removed from the queue. The expression used for forcing the removal that prompted this was:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">PeriodicRemove = ( (RemoteWallClockTime &gt; ( 3 * 24 * 60 * 60 + 20 * 60)) || ( ImageSize &gt; JobMemoryLimit) )\n</pre></div>\n\n\n<p>Originally, this used to work, apparently in V7.6.6. The user recently upgraded form V7.8.2 (when <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span> maybe didn't used to work) to V7.8.7 and then nothing worked properly.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-07 14:39:53 by samf:</em> <br/>\n\nI investigated how HTCondor does periodic removals, which is done in <code>condor_utils/user_job_policy.cpp</code>. The code calls\n\n<p></p><div class=\"code\">\n<pre class=\"code\">        /* Should I perform a periodic remove? */\n        if(AnalyzeSinglePeriodicPolicy(ATTR_PERIODIC_REMOVE_CHECK, PARAM_SYSTEM_PERIODIC_REMOVE, REMOVE_FROM_QUEUE, retval)) {\n                return retval;\n        }\n</pre></div>\n\n\n<p>If <code>ATTR_PERIODIC_REMOVE_CHECK</code> evaluates to true, <code>REMOVE_FROM_QUEUE</code> gets assigned to <code>retval</code> which then goes back to the calling function <code>PeriodicExprEval</code> in <code>condor_schedd.V6/schedd.cpp</code>\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">/*\nFor a given job, evaluate any periodic expressions\nand abort, hold, or release the job as necessary.\n*/\n\nstatic int\nPeriodicExprEval( ClassAd *jobad )\n{\n        ...\n        switch(action) {\n                case REMOVE_FROM_QUEUE:\n                        if(status!=REMOVED) {\n                                abortJob( cluster, proc, reason.Value(), true );\n                        }\n                        break;\n        ...\n        }\n        if ( status == COMPLETED || status == REMOVED ) {\n                // Note: should also call DestroyProc on REMOVED, but\n                // that will screw up globus universe jobs until we fix\n                // up confusion w/ MANAGED==True.  The issue is a job may be\n                // removed; if the remove failed, it may be placed on hold\n                // with managed==false.  If it is released again, we want the\n                // gridmanager to go at it again.....\n                // So for now, just call if status==COMPLETED -Todd &lt;tannenba@cs.wisc.edu&gt;\n                if ( status == COMPLETED ) {\n                        DestroyProc(cluster,proc);\n                }\n                return 1;\n        }\n        ...\n}\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Jan-15 17:26:21 by samf:</em> <br/>\n\nI worked on trying to replicate the error using a Personal HTCondor and have not managed to replicate successfully. My HTCondor submit file is:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">#############################################\n##   submit description file for a parallel program\n#############################################\nuniverse = vanilla\nexecutable = /bin/sleep\ngetenv=true\narguments = 60\n#actual_mpi_job arg1 arg2 arg3\n\nshould_transfer_files = yes\nwhen_to_transfer_output = on_exit_or_evict\n\noutput = o\nerror  = e\nlog    = l\n\nperiodic_remove = ((RemoteWallClockTime &gt; 30)|| (ImageSize &gt; JobMemoryLimit) || (ImageSize &gt; 100000))\n\nqueue\n</pre></div>\n\n\n<p>The job queues up, the job executes, and after 30 seconds, the job is removed from the queue, exactly as it should be. I had also set <code>PERIODIC_EXPR_INTERVAL = 5</code> so that I could ensure that the periodic remove expression would be evaluated while the job was still running. I'm trying to get the log files to see what's going on.\n</p><hr/>\n<em>2013-Mar-28 17:16:00 by johnkn:</em> <br/>\n\nBulk change of target version from v070808 to v070809 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2013-Jun-14 14:10:05 by adesmet:</em> <br/>\n\nAbandoning for now; user hasn't responded to queries, couldn't be reproduce here.  Will reopen if it rears its head again.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2013-Jun-14 14:10", "status": "abandoned", "created": "2013-Jan-04 14:40", "fixed_version": "2013-Jan-04 14:40", "broken_version": "v070807", "priority": "3", "subsystem": "", "assigned_to": "adesmet", "derived_from": "", "creator": "samf", "rust": "a24588", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}