{"id": 4448, "title": "Ticket #4448: Improve performance of putClassAd with projection", "description": "<blockquote>\nthe worker function putClassAd is very inefficient in the way it handles projections.  A few minor changes will make this function a lot faster which in turn will reduce the CPU useage of the collector and the schedd when handling typical condor_status and condor_q requests.\n\n<p>The changes are\n\n</p><p></p><ul>\n<li>require that the projection be a list of attributes, not a list of expressions\n\n<p></p></li><li>use classad::References (i.e. std::set) rather than <code>StringList</code> to hold the\nlist of attributes.\n\n<p></p></li><li>expand the list of attributes by looking only at internal references\n\n<p></p></li><li>do the expansion of attributes inside the call to putClassAd\n</li></ul>\n\n<p>These changes together seem to reduce the CPU cost of sending ads from the collector for a typical condor_status query by about half.  the reduction in CPU cost to the schedd for handling condor_q requests should be similar, but no timing numbers are available yet.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-May-06 17:15:08 by johnkn:</em> <br/>\n\nPerformance test of 8.2.8 vs 8.3.6.  both collectors seeded with 11397 Startd ads using condor_advertise.  Collector log shows the time spend responding to condor_status. Note the value for send_time\n\n<p>for 8.2.8\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">05/06/15 17:06:58 Got QUERY_STARTD_ADS\n05/06/15 17:06:58 (Sending 11397 ads in response to query)\n05/06/15 17:06:59 Query info: matched=11397; skipped=0;\n         query_time=0.016000;\n         send_time=0.703000;\n         type=Machine; requirements={true};\n         peer=&lt;128.xxx.xxx.xxx:52865&gt;;\n         projection={Name Machine Opsys Arch State Activity LoadAvg Memory ActvtyTime MyCurrentTime EnteredCurrentActivity}\n</pre></div>\n\n\n<p>for 8.3.6\n</p><div class=\"code\">\n<pre class=\"code\">05/06/15 17:04:03 Got QUERY_STARTD_ADS\n05/06/15 17:04:03 (Sending 11397 ads in response to query)\n05/06/15 17:04:03 Query info: matched=11397; skipped=0;\n         query_time=0.016000;\n         send_time=0.297000;\n         type=Machine; requirements={true};\n         peer=&lt;128.xxx.xxx.xxx:52865&gt;;\n         projection={Name Machine Opsys Arch State Activity LoadAvg Memory ActvtyTime MyCurrentTime EnteredCurrentActivity}\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-07 17:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e02a07ba58fcb843c954c366c10e0b122e42a6e8\">[41110]</a></span>: fix small memory leak in previous commit for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4448\" onclick=\"get_ticket_and_populate_wrapper('4448'); return false;\" title=\"Improve performance of putClassAd with projection\">#4448</a></span>. classad::Remove was used when classad::Delete should have been ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-12 10:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c8ca21fcbd8cac6a7e79e795516d7caa6ac610f\">[40941]</a></span>: add 8.3.0 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4448\" onclick=\"get_ticket_and_populate_wrapper('4448'); return false;\" title=\"Improve performance of putClassAd with projection\">#4448</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-09 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8c00eca79ba27cd8f1b45c2a975d3cbc3960ecdd\">[40583]</a></span>: fix <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4448\" onclick=\"get_ticket_and_populate_wrapper('4448'); return false;\" title=\"Improve performance of putClassAd with projection\">#4448</a></span> to support the negotiator projections where the projection is an expression that must be evaluated against the machine ad. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-08 21:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4f8352cf250215f33ad006e93d5b8deb28b5c6c2\">[40580]</a></span>: remove obsolete putClassAd flavors, update async condor_q response to use new projection style. part of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4448\" onclick=\"get_ticket_and_populate_wrapper('4448'); return false;\" title=\"Improve performance of putClassAd with projection\">#4448</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-08 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/459729aa7beed0078f65544c06eef2914b26a023\">[40573]</a></span>: performance improvments to putClassAd with projection <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4448\" onclick=\"get_ticket_and_populate_wrapper('4448'); return false;\" title=\"Improve performance of putClassAd with projection\">#4448</a></span> - change projection from <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span> to classad::References in putClassAd - move code for expanding the projection from call sites to putClassAd - use more efficient projection expansion - treat input projection as a list of attributes (i.e do\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-May-06 17:15", "status": "resolved", "created": "2014-Jul-07 15:11", "fixed_version": "2014-Jul-07 15:11", "broken_version": "", "priority": "3", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "#4412", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}