{"id": 4437, "title": "Ticket #4437: Shadow does not initialize supplemental groups properly", "description": "<blockquote>\nHi,\n\n<p>User log files are failing to initialize due to the shadow not initializing supplemental groups properly.\n\n</p><p>This error was first observed on version 8.1.4\n</p><div class=\"code\">\n<pre class=\"code\">[nvanlysel@opt-submit discoveryit]$ condor_version\n$CondorVersion: 8.1.4 Feb 25 2014 BuildID: 230990 $\n$CondorPlatform: x86_64_RedHat6 $\n</pre></div>\n\n\n<p>and was also observed on version 8.2.1\n</p><div class=\"code\">\n<pre class=\"code\">[nvanlysel@submit-2 ~]$ condor_version\n$CondorVersion: 8.2.1 Jun 28 2014 BuildID: 256314 $\n$CondorPlatform: x86_64_RedHat5 $\n</pre></div>\n\n\n<p>Here are the groups that I belong to:\n</p><div class=\"code\">\n<pre class=\"code\">[nvanlysel@submit-2 ~]$ id\nuid=20705(nvanlysel) gid=20706(nvanlysel) groups=20705(discoveryit),20706(nvanlysel)\n</pre></div>\n\n\n<p>Here's the directory where I'm submitting jobs from:\n</p><div class=\"code\">\n<pre class=\"code\">[nvanlysel@submit-2 ~]$ pwd\n/test/discoveryit/home/nvanlysel\n</pre></div>\n\n\n<p>Here are the directory permissions:\n</p><div class=\"code\">\n<pre class=\"code\">[nvanlysel@submit-2 ~]$ ls -ld /test\ndrwxr-xr-x 3 root root 4096 Jul  2 13:16 /test\n\n[nvanlysel@submit-2 ~]$ ls -ld /test/discoveryit\ndrwxr-x--- 3 root discoveryit 4096 Jul  2 13:16 /test/discoveryit\n\n[nvanlysel@submit-2 ~]$ ls -ld /test/discoveryit/home\ndrwxr-x--- 3 root discoveryit 4096 Jul  2 13:18 /test/discoveryit/home\n\n[nvanlysel@submit-2 ~]$ ls -ld /test/discoveryit/home/nvanlysel\ndrwx------ 2 nvanlysel nvanlysel 4096 Jul  2 13:26 /test/discoveryit/home/nvanlysel\n</pre></div>\n\n\n<p>All of my jobs go on hold:\n</p><div class=\"code\">\n<pre class=\"code\">[nvanlysel@submit-2 ~]$ condor_q nvanlysel -hold\n\n\n-- Submitter: submit-2.chtc.wisc.edu : &lt;128.104.55.9:9618?sock=28177_89dd_3&gt; : submit-2.chtc.wisc.edu\n ID        OWNER          HELD_SINCE  HOLD_REASON\n256035.0   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_0.log or\n256035.1   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_1.log or\n256035.2   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_2.log or\n256035.3   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_3.log or\n256035.4   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_4.log or\n256035.5   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_5.log or\n256035.6   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_6.log or\n256035.7   nvanlysel       7/2  13:31 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_7.log or\n256035.8   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_8.log or\n256035.9   nvanlysel       7/2  13:29 Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_9.log or\n\n10 jobs; 0 completed, 0 removed, 0 idle, 0 running, 10 held, 0 suspended\n</pre></div>\n\n\n<p>Here's a snippet of an strace of the condor_shadow:\n</p><div class=\"code\">\n<pre class=\"code\">setgroups(0, [])                             = 0\nsetresgid(-1, 20706, -1)                             = 0\nsetresuid(-1, 20705, -1)                             = 0\nopen(\"/test/discoveryit/home/nvanlysel/256035_7.log\", O_WRONLY|O_APPEND) = -1 EACCES (Permission denied)\n</pre></div>\n\n\n<p>Here's a snippet of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShadowLog\" title=\"Shadow Log\">ShadowLog</a></span> (SHADOW_DEBUG = D_PRIV D_FULLDEBUG):\n</p><div class=\"code\">\n<pre class=\"code\">07/02/14 13:31:31 Initializing a VANILLA shadow for job 256035.7\n07/02/14 13:31:31 (256035.7) (4801): PRIV_CONDOR --&gt; PRIV_ROOT at /slots/01/dir_26465/userdir/src/condor_utils/uids.cpp:1135\n07/02/14 13:31:31 (256035.7) (4801): PRIV_ROOT --&gt; PRIV_CONDOR at /slots/01/dir_26465/userdir/src/condor_utils/uids.cpp:1137\n07/02/14 13:31:31 (256035.7) (4801): PRIV_CONDOR --&gt; PRIV_USER at /slots/01/dir_26465/userdir/src/condor_shadow.V6.1/baseshadow.cpp:187\n07/02/14 13:31:31 (256035.7) (4801): UserLog = /test/discoveryit/home/nvanlysel/256035_7.log\n07/02/14 13:31:31 (256035.7) (4801): PRIV_USER --&gt; PRIV_ROOT at /slots/01/dir_26465/userdir/src/condor_utils/uids.cpp:1135\n07/02/14 13:31:31 (256035.7) (4801): PRIV_ROOT --&gt; PRIV_USER at /slots/01/dir_26465/userdir/src/condor_utils/uids.cpp:1137\n07/02/14 13:31:31 (256035.7) (4801): WriteUserLog::initialize: safe_open_wrapper(\"/test/discoveryit/home/nvanlysel/256035_7.log\") failed - errno 13 (Permission denied)\n07/02/14 13:31:31 (256035.7) (4801): WriteUserLog::initialize: failed to open file /test/discoveryit/home/nvanlysel/256035_7.log\n07/02/14 13:31:31 (256035.7) (4801): Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_7.log or\n07/02/14 13:31:31 (256035.7) (4801): setting exit reason on ??? to 112\n07/02/14 13:31:31 (256035.7) (4801): Resource ??? changing state from PRE to FINISHED\n07/02/14 13:31:31 (256035.7) (4801): Job 256035.7 going into Hold state (code 22,0): Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_7.log or\n07/02/14 13:31:31 (256035.7) (4801): RemoteResource::killStarter(): DCStartd object NULL!\n07/02/14 13:31:31 (256035.7) (4801): PRIV_USER --&gt; PRIV_CONDOR at /slots/01/dir_26465/userdir/src/condor_io/condor_auth_fs.cpp:72\n07/02/14 13:31:31 (256035.7) (4801): PRIV_CONDOR --&gt; PRIV_USER at /slots/01/dir_26465/userdir/src/condor_io/condor_auth_fs.cpp:133\n07/02/14 13:31:31 (256035.7) (4801): Updating Job Queue: SetAttribute(BytesRecvd = 0.0)\n07/02/14 13:31:31 (256035.7) (4801): Updating Job Queue: SetAttribute(BytesSent = 0.0)\n07/02/14 13:31:31 (256035.7) (4801): Updating Job Queue: SetAttribute(HoldReason = \"Failed to initialize user log to /test/discoveryit/home/nvanlysel/256035_7.log or \")\n07/02/14 13:31:31 (256035.7) (4801): Updating Job Queue: SetAttribute(HoldReasonCode = 22)\n07/02/14 13:31:31 (256035.7) (4801): Updating Job Queue: SetAttribute(HoldReasonSubCode = 0)\n07/02/14 13:31:31 (256035.7) (4801): PRIV_USER --&gt; PRIV_ROOT at /slots/01/dir_26465/userdir/src/condor_io/shared_port_endpoint.cpp:1294\n07/02/14 13:31:31 (256035.7) (4801): PRIV_ROOT --&gt; PRIV_USER at /slots/01/dir_26465/userdir/src/condor_io/shared_port_endpoint.cpp:1298\n07/02/14 13:31:31 (256035.7) (4801): **** condor_shadow (condor_SHADOW) pid 4801 EXITING WITH STATUS 112\n</pre></div>\n\n\n<p>Any advice here would be greatly appreciated.\n\n</p><p>Thanks, <br/>\n\nNeil Van Lysel <br/>\n\nvan-lyse@cs.wisc.edu</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-15 14:54:53 by jfrey:</em> <br/>\n\nThis is a bug in the shadow where it tries to re-initialize the UID/GID of the job owner while in the user priv-state when opening the user log. This causes the supplemental groups to be unset.\n\n<p></p><hr/>\n<em>2014-Aug-06 17:00:09 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Patch looks good for stable series, resolving.  However, would like to see a follow-up ticket on master branch that adds some EXCEPTS in the priv sep code to prevent this land-mine from being stepped on again from a different call site.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\npriv-state code may unset supplemental groups</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4672\" onclick=\"get_ticket_and_populate_wrapper('4672'); return false;\" title=\"Shadow does not initialize supplemental groups properly, part deux\">#4672</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nShadow does not initialize supplemental groups properly, part deux</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5600\" onclick=\"get_ticket_and_populate_wrapper('5600'); return false;\" title=\"Keep supplemental groups in my_popen()\">#5600</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nKeep supplemental groups in my_popen()</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5603\" onclick=\"get_ticket_and_populate_wrapper('5603'); return false;\" title=\"Set supplemental groups properly when using SOFT_UID_DOMAIN\">#5603</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSet supplemental groups properly when using SOFT_UID_DOMAIN</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-21 11:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f7a59cd56d337d3e8fac10215ee0d7287ed22362\">[40714]</a></span>: formatting edit of 8.2.2 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4437\" onclick=\"get_ticket_and_populate_wrapper('4437'); return false;\" title=\"Shadow does not initialize supplemental groups properly\">#4437</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-15 15:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c58b465a81f069ce8c6301484fff4be695e885dc\">[40659]</a></span>: Shadow does not initialize supplemental groups properly. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4437\" onclick=\"get_ticket_and_populate_wrapper('4437'); return false;\" title=\"Shadow does not initialize supplemental groups properly\">#4437</a></span> When opening the user log, the shadow attempts to re-initialize the user uids while in the user priv-state. This results in none of the user's supplemental groups being set when opening the user log, which could cause the open to fail.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-06 17:00", "status": "resolved", "created": "2014-Jul-02 13:34", "fixed_version": "2014-Jul-02 13:34", "broken_version": "v080104", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "van-lyse", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "van-lyse@cs.wisc.edu, tannenba@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}