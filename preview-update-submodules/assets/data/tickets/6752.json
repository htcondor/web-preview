{"id": 6752, "title": "Ticket #6752: ReadUserLog::readEvent() broken on Windows?", "description": "<blockquote>\nIt appears that <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6736\" onclick=\"get_ticket_and_populate_wrapper('6736'); return false;\" title=\"Regression Tests for Backfill-while-Draining\">#6736</a></span> has revealed a problem with ReadUserLog::readEvent() on Windows: <a class=\"external\" href=\"http://submit-3.batlab.org//nmi-runs/condorauto/2018/09/condorauto_submit-3.batlab.org_1535994374_3367183/userdir/nmi:x86_64_Windows7/job_late_materialize_py-1.out\">occasionally</a> the <a class=\"external\" href=\"http://submit-3.batlab.org/results/task-details.php?platform=nmi:x86_64_Windows8&amp;task=job_late_materialize_py-1&amp;runid=448453\">output</a> seems to indicate that it's returning the same event multiple times.\n\n<p>This doesn't ever seem to happen in the corresponding Perl test of the same functionality (see <a class=\"external\" href=\"http://submit-3.batlab.org//nmi-runs/condorauto/2018/09/condorauto_submit-3.batlab.org_1535993578_3365352/userdir/nmi:x86_64_Windows8/job_late_materialize-1.out\">here</a> and <a class=\"external\" href=\"http://submit-3.batlab.org//nmi-runs/condorauto/2018/09/condorauto_submit-3.batlab.org_1535994374_3367183/userdir/nmi:x86_64_Windows7/job_late_materialize-1.out\">here</a>), but that test uses a log reader written in Perl, not the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadUserLog\" title=\"Read User Log\">ReadUserLog</a></span> class.\n\n</p><p>I also can't help but notice that the lib_eventlog* tests are all disabled on Windows...</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Sep-13 13:26:48 by tlmiller:</em> <br/>\n\nTJ reports: the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadUserLog\" title=\"Read User Log\">ReadUserLog</a></span> use safe_open() and fdopen(), both of which default to text mode on Windows.  This causes ftell() to report characters-read, rather than the byte-offset, which gives us fits.  If <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadUserLog\" title=\"Read User Log\">ReadUserLog</a></span> tolerates carriage returns, the fix should be simple (add 'b' to the fdopen() call and/or '|BINARY' to the safe_fopen() call).\n\n<p>I'll test that fix; if it doesn't work, I may hand this ticket back to TJ for correction as a bug in 8.8.0.\n\n</p><p></p><hr/>\n<em>2018-Sep-13 16:42:12 by tlmiller:</em> <br/>\n\nIt's not <a class=\"external\" href=\"http://submit-3.batlab.org/results/task-details.php?platform=nmi:x86_64_Windows10&amp;task=job_late_materialize_py-1&amp;runid=448914\">looking so good</a>.\n\n<p></p><hr/>\n<em>2018-Sep-14 17:06:23 by tlmiller:</em> <br/>\n\nPassing O_BINARY to the safe_open() broke a bunch:\n\n<p><a class=\"external\" href=\"http://submit-3.batlab.org/results/test-details.php?runid=449149&amp;testids=449161,449162,449163,449169,449170,449174,449175,449176,449178,449180,449183,449192,449196,449200,449201,449204,449207&amp;group=tlmiller:%20workspace:%20Auto-Test%20Suite\">http://submit-3.batlab.org/results/test-details.php?runid=449149&amp;testids=449161,449162,449163,449169,449170,449174,449175,449176,449178,449180,449183,449192,449196,449200,449201,449204,449207&amp;group=tlmiller:%20workspace:%20Auto-Test%20Suite</a>\n\n</p><p></p><hr/>\n<em>2018-Sep-14 17:14:47 by tlmiller:</em> <br/>\n\nFirst pass of review: no events being found?\n\n<p></p><hr/>\n<em>2018-Sep-14 18:05:02 by tlmiller:</em> <br/>\n\nReadUserLog::readEvent() calls\nReadUserLog::readEventOld() calls\n&lt;EventType&gt;::getEvent().\n\n<p>Checking SubmitEvent::readEvent(), we see two errors immediately.  On line 995:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">sscanf( line.Value(), \"Job submitted from host: %s\\n\" )\n</pre></div>\n\n\n<p>will fail with Windows line endings in binary mode, and line 1004 --\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">// Backup to leave event delimiter unread go past \\n too\nfseek( file, -4, SEEK_CUR );\n</pre></div>\n\n\n<p>-- will not rewind past the '\\r' that will at the end of the line.\n\n</p><p>It's not immediately clear if there's a fast fix for issues like these.  (I guess we decided against making the event log /writer/ to use binary mode?)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-23 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a733d4c56f04ab2a20164069d826755cb18b8075\">[55609]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6581\" onclick=\"get_ticket_and_populate_wrapper('6581'); return false;\" title=\"condor_submit should not always read from stdin if no submit file\">#6581</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6752\" onclick=\"get_ticket_and_populate_wrapper('6752'); return false;\" title=\"ReadUserLog::readEvent() broken on Windows?\">#6752</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6784\" onclick=\"get_ticket_and_populate_wrapper('6784'); return false;\" title=\"there should be a knob to set the default for should_transfer_files\">#6784</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6698\" onclick=\"get_ticket_and_populate_wrapper('6698'); return false;\" title=\"Provide the ability to identify black hole slots\">#6698</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6737\" onclick=\"get_ticket_and_populate_wrapper('6737'); return false;\" title=\"Accounting and Defrag adtypes missing from python bindings\">#6737</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6723\" onclick=\"get_ticket_and_populate_wrapper('6723'); return false;\" title=\"Late Materialization jobs handle getenv=true incorrectly\">#6723</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6732\" onclick=\"get_ticket_and_populate_wrapper('6732'); return false;\" title=\"speed up the schedd check for a change in an autoclustered attribute\">#6732</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-23 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5907d43812e4bb565329ba4f2f69722d8ff929c6\">[55610]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6581\" onclick=\"get_ticket_and_populate_wrapper('6581'); return false;\" title=\"condor_submit should not always read from stdin if no submit file\">#6581</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6752\" onclick=\"get_ticket_and_populate_wrapper('6752'); return false;\" title=\"ReadUserLog::readEvent() broken on Windows?\">#6752</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6784\" onclick=\"get_ticket_and_populate_wrapper('6784'); return false;\" title=\"there should be a knob to set the default for should_transfer_files\">#6784</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6698\" onclick=\"get_ticket_and_populate_wrapper('6698'); return false;\" title=\"Provide the ability to identify black hole slots\">#6698</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6737\" onclick=\"get_ticket_and_populate_wrapper('6737'); return false;\" title=\"Accounting and Defrag adtypes missing from python bindings\">#6737</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6723\" onclick=\"get_ticket_and_populate_wrapper('6723'); return false;\" title=\"Late Materialization jobs handle getenv=true incorrectly\">#6723</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6732\" onclick=\"get_ticket_and_populate_wrapper('6732'); return false;\" title=\"speed up the schedd check for a change in an autoclustered attribute\">#6732</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Sep-25 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9d8eac0e867d3e8d4ef54186f29ebfe9243dfbb7\">[55466]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6752\" onclick=\"get_ticket_and_populate_wrapper('6752'); return false;\" title=\"ReadUserLog::readEvent() broken on Windows?\">#6752</a></span> fix eventlog reader repeating events on Windows. This fix involves 1) open the file in binary mode 2) never seek in condor_event readEvent methods 3) have the readEvent methods tell the caller if they consumed the ... at the end of the event. This commit also fixes the unit tests for the event\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Oct-23 11:47", "status": "resolved", "created": "2018-Sep-04 12:19", "fixed_version": "2018-Sep-04 12:19", "broken_version": "v080709", "priority": "2", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}