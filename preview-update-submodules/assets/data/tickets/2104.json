{"id": 2104, "title": "Ticket #2104: condor_master crashed during globus mapping callout", "description": "<blockquote>\nBurt reported a crash of condor_master.  It appears that the globus library is in the act of calling out to some external mapping service.  (This was a glidein, so the precise configuration of the system is unknown at this time.)\n\n<p>The question is whether this is just a broken system configuration or whether it is something that Condor is doing wrong.  It happens that in this case the condor admin did not desire any use of the globus mapping at all.  Providing better ways of configuring the globus mapping will be addressed in other tickets.\n\n</p><p></p><div class=\"verbatim\">\n<pre>Stack dump for process 20155 at timestamp 1303927946 (36 frames)\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(dprintf_dump_stack+0x40)[0x819c18c]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master[0x819c3aa]\n/lib/tls/i686/nosegneg/libpthread.so.0[0xd36c38]\n/lib/tls/i686/nosegneg/libc.so.6(memcpy+0x1c)[0xb0ffbc]\n/usr/lib/libstdc++.so.5(_ZNSs15_M_replace_safeIN9__gnu_cxx17__normal_iteratorIPcSsEEEERSsS3_S3_T_S5_+0x84)[0x6aeb64]\n/usr/lib/libstdc++.so.5(_ZNSs6appendERKSs+0x93)[0x6ac3a3]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZStplIcSt11char_traitsIcESaIcEESbIT_T0_T1_ERKS6_S8_+0x1f)[0x81d1a9b]\n/usr/local/osg-wn-client/prima/lib/liblog4cpp.so.4(_ZN7log4cpp24PropertyConfiguratorImpl11doConfigureERKSs+0xbc)[0x40227f9c]\n/usr/local/osg-wn-client/prima/lib/liblog4cpp.so.4(_ZN7log4cpp20PropertyConfigurator9configureERKSs+0x33)[0x40227a3b]\n/usr/local/osg-wn-client/prima/lib/libsaml.so.4(_ZN4saml18SAMLInternalConfig4initEv+0x39)[0x401b4b11]\n/usr/local/osg-wn-client/prima/lib/libprima_saml_support.so.0(initPrimaSAMLSupport+0x92)[0x4013c896]\n/usr/local/osg-wn-client/prima/lib/libprima_authz_saml_support.so.0(prima_get_saml_answer+0xf1)[0x400dd92b]\n/usr/local/osg-ce/prima/lib/libprima_authz_module_gcc32dbg.so(globus_gridmap_callout+0xced)[0x40006e11]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(globus_callout_call_type+0x2f3)[0x8222e38]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(globus_gss_assist_map_and_authorize+0x1dc)[0x81f1390]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN16Condor_Auth_X50914nameGssToLocalEPKc+0x2a)[0x8123b5e]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN16Condor_Auth_X50923authenticate_client_gssEP11CondorError+0x1f9)[0x8124361]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN16Condor_Auth_X50912authenticateEPKcP11CondorError+0x11e)[0x8123896]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN14Authentication18authenticate_innerEPcPKcP11CondorErrori+0x18a)[0x811760a]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN14Authentication12authenticateEPcPKcP11CondorErrori+0x42)[0x8117456]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN14Authentication12authenticateEPcRP7KeyInfoPKcP11CondorErrori+0x1f)[0x81173b3]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN8ReliSock20perform_authenticateEbRP7KeyInfoPKcP11CondorErroriPPc+0x79)[0x8134785]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN8ReliSock12authenticateERP7KeyInfoPKcP11CondorErroriPPc+0x1f)[0x813485b]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN18SecManStartCommand18authenticate_innerEv+0x3d4)[0x812d764]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN18SecManStartCommand18startCommand_innerEv+0x169)[0x812b6c5]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN18SecManStartCommand12startCommandEv+0x1f)[0x812b473]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN6SecMan12startCommandEiP4SockbP11CondorErroriPFvbS1_S3_PvES4_bPKcS8_+0x79)[0x812b0cd]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN6Daemon12startCommandEiP4SockiP11CondorErrorPFvbS1_S3_PvES4_bPKcPcP6SecManbS8_+0x55)[0x810936d]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN6Daemon12startCommandEiN6Stream11stream_typeEiP11CondorErrorPKcbS5_+0x35)[0x810960d]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN11CCBListener12SendMsgToCCBERN14compat_classad7ClassAdEb+0x138)[0x816faac]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN11CCBListener21RegisterWithCCBServerEb+0x157)[0x816f8af]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN12CCBListeners21RegisterWithCCBServerEb+0x44)[0x81711a4]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(_ZN10DaemonCore8reconfigEv+0x382)[0x80f30d6]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(main+0xaf5)[0x81056f1]\n/lib/tls/i686/nosegneg/libc.so.6(__libc_start_main+0xd3)[0xab8df3]\n/usr/local/osg-ce/OSG.DIRS/wn_tmp/glide_S18089/main/condor/sbin/condor_master(ldexp+0x59)[0x80e2871]\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Apr-27 14:43:36 by bbockelm:</em> <br/>\n\nAt Burt's suggestion (I contributed this patch), I looked into this:\n\n<p></p><ol>\n<li>Globus mapping is done when the connection is established; the condor mapfile is done later.  Based on the results of the mapfile, it determines whether it wants to keep the Globus mapping.\n</li><li>Globus is always initialized, even in cases when it will never be used.\n</li></ol>\n\n<p>Judging from the trace, I think the first item was fatal for glidein.\n\n</p><p></p><hr/>\n<em>2011-Apr-27 15:08:37 by zmiller:</em> <br/>\n\nQuick note:  Observations 1 and 2 are correct.  The code should be refactored so it only calls globus when needed.  At one point in time it was quicker (i.e. a quick hack) to do it the way it is currently implemented.  Would love to see it redone for 7.7.X.\n\n<p></p><hr/>\n<em>2012-Aug-27 13:48:46 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> by zmiller:  brian's attached patch looks good\n\n<p></p><hr/>\n<em>2012-Aug-27 16:41:06 by danb:</em> <br/>\n\nPerhaps I am misreading this patch.  By my reading, it causes the following semantic change: if global_map_file==NULL (i.e. CERTIFICATE_MAPFILE is not defined), then GSI-authenticated users are always mapped to the generic \"gsi@unmapped\" rather than to whatever is in the gridmap file, if anything.\n\n<p></p><hr/>\n<em>2012-Aug-27 16:47:36 by zmiller:</em> <br/>\n\ndan:  good catch.  we definitely want to fall back to using gss_assist_gridmap in the case where there is no CERTIFICATE_MAPFILE defined.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/626/condor_gt2104.patch\">condor_gt2104.patch</a>\n4730 bytes added by bbockelm on 2012-Aug-27 15:58:38 UTC.\n<br/>\nA fix for calling out to Globus unnecessarily.  As an added bonus, I fixed GT2103 here too.<br/>\n</li><li><a href=\"../files/628/condor_gt2104_pt2.patch\">condor_gt2104_pt2.patch</a>\n8233 bytes added by bbockelm on 2012-Aug-29 22:03:25 UTC.\n<br/>\nSecond part of the patch - handles the case where CERTIFICATE_MAPFILE is not defined, as pointed out by danb's review.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-22 11:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6dc31178ec024afc5813c77a2c3e7c0cb80c1b1\">[33726]</a></span>: version history updates <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3039\" onclick=\"get_ticket_and_populate_wrapper('3039'); return false;\" title=\"get file transfer remaps working for directories\">#3039</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3129\" onclick=\"get_ticket_and_populate_wrapper('3129'); return false;\" title=\"Have schedd dynamically spawn local startd\">#3129</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2366\" onclick=\"get_ticket_and_populate_wrapper('2366'); return false;\" title=\"Remove version from OpSys and add OpSysVer and Distro attributes\">#2366</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3220\" onclick=\"get_ticket_and_populate_wrapper('3220'); return false;\" title=\"Allow different submit limits for grid resources\">#3220</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3268\" onclick=\"get_ticket_and_populate_wrapper('3268'); return false;\" title=\"fix security issue\">#3268</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2104\" onclick=\"get_ticket_and_populate_wrapper('2104'); return false;\" title=\"condor_master crashed during globus mapping callout\">#2104</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3161\" onclick=\"get_ticket_and_populate_wrapper('3161'); return false;\" title=\"CS collector on astro crashes with segfault\">#3161</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-05 11:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5dd2d6c73d4b0ce67dd7c55859eccb3c80b0baf1\">[33280]</a></span>: fix build caused by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2104\" onclick=\"get_ticket_and_populate_wrapper('2104'); return false;\" title=\"condor_master crashed during globus mapping callout\">#2104</a></span> where there is no GLOBUS extern. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-04 16:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d731796b9ed2a1f77b8bfb4c59454e43087db4fa\">[33269]</a></span>: Only invoke globus when actually needed <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2104\" onclick=\"get_ticket_and_populate_wrapper('2104'); return false;\" title=\"condor_master crashed during globus mapping callout\">#2104</a></span> Committer: Zach Miller  (By Brian Bockleman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Sep-04 15:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6dc1c311cb2ff768dd2e92c8de8390512d8af9f\">[33260]</a></span>: Revert \"Do not invoke Globus callout unless it is requested. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2104\" onclick=\"get_ticket_and_populate_wrapper('2104'); return false;\" title=\"condor_master crashed during globus mapping callout\">#2104</a></span>\", defferred to 7.8.4 release This reverts commit a7a299853133b86f6317bef8b666c0d5cb751017.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-27 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a7a299853133b86f6317bef8b666c0d5cb751017\">[33184]</a></span>: Do not invoke Globus callout unless it is requested. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2104\" onclick=\"get_ticket_and_populate_wrapper('2104'); return false;\" title=\"condor_master crashed during globus mapping callout\">#2104</a></span> Signed-off-by: Zach Miller &lt;zmiller@cs.wisc.edu&gt; Committer: Zach Miller  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-18 08:39", "status": "resolved", "created": "2011-Apr-27 14:35", "fixed_version": "2011-Apr-27 14:35", "broken_version": "v070506", "priority": "4", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#1834", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu,burt@fnal.gov,sfiligoi@fnal.gov,zmiller@cs.wisc.edu", "due_date": ""}