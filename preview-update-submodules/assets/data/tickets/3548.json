{"id": 3548, "title": "Ticket #3548: chirp write appears to be broken", "description": "<blockquote>\n$ cat filetowrite\n\n<p>abcdefghijklmnopqrstuvwxyz123456789A\n\n</p><p>$ cat /tmp/tmpfiletowrite\n\n</p><p>000000000000000000000000000000000\n\n</p><p>/usr/libexec/condor/condor_chirp write -offset 0 -stride 0  0 /tmp/tmpfiletowrite filetowrite\n\n</p><p>$cat /tmp/tmpfiletowrite\n\n</p><p>abcdefghijklmnopqrstuvwxyz123456789A\n\n</p><p>/usr/libexec/condor/condor_chirp write -offset 2 -stride 0  0 /tmp/tmpfiletowrite filetowrite\n$cat /tmp/tmpfiletowrite\n00abcdefghijklmnopqrstuvwxyz123456789A\n\n</p><p>/usr/libexec/condor/condor_chirp write -offset 2 -stride 3 4  /tmp/tmpfiletowrite filetowrite\n\n</p><p>$cat /tmp/tmpfiletowrite\n\n</p><p>00abc0def0ghi0jkl0mno0pqr0stu0vwx\nyz123456789A\n\n</p><p>which is actually a file with &lt;nul&gt; characters due to the original length of /tmp/tmpfiletowrite\n\n</p><p>00abc0def0ghi0jkl0mno0pqr0stu0vwx\nyz1&lt;nul&gt;234&lt;nul&gt;567&lt;nul&gt;89A&lt;nul&gt;\n\n</p><p>The &lt;nul&gt; characters aren't the problem. In the above examples there is nothing to control the length of the write. Condor_chirp read uses a length param to control this.\n\n</p><p>I propose changing this such that write uses a length param like read. Such that:\n\n</p><p>/usr/libexec/condor/condor_chirp write -offset 0 -stride 0  0 /tmp/tmpfiletowrite filetowrite 10\n\n</p><p>$cat /tmp/tmpfiletowrite\n\n</p><p>abcdefghij00000000000000000000000\n\n</p><p>/usr/libexec/condor/condor_chirp write -offset 2 -stride 0  0 /tmp/tmpfiletowrite filetowrite 10\n\n</p><p>$cat /tmp/tmpfiletowrite\n\n</p><p>00abcdefghij000000000000000000000\n\n</p><p>/usr/libexec/condor/condor_chirp write -offset 2 -stride 3 4  /tmp/tmpfiletowrite filetowrite 10\n\n</p><p>$cat /tmp/tmpfiletowrite\n\n</p><p>00abc0def0ghi0j000000000000000000</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Mar-21 07:46:28 by matt:</em> <br/>\n\nThis is an RFE, it should allow the length argument to be optional for backward compatibility\n\n<p></p><hr/>\n<em>2013-Mar-21 08:12:52 by jrt:</em> <br/>\n\nI'll rework the patch for an optional length field.\n\n<p></p><hr/>\n<em>2013-Mar-21 11:36:34 by jrt:</em> <br/>\n\nWhat this appears to me to be is that chirp_write was never finished code. Chirp_read uses chirp_client_sread, but chirp_write doesn't make use of chirp_client_swrite although swrite is fully implemented (but unused) across IOProxy_handler, NTSenders,and NTReceivers.\n\n<p></p><hr/>\n<em>2013-May-07 15:56:24 by eje:</em> <br/>\n\nTESTING\n\n<p>All the following tests use this input file \"src.txt\":\n</p><div class=\"code\">\n<pre class=\"code\">$ cat src.txt\nabcdefghijklmnopqrstuvwxyz123456789A\n</pre></div>\n\n\n<p>first test is legacy functionality (no length param after source filename), so full input file is assumed:\n</p><div class=\"code\">\n<pre class=\"code\"># script that creates a temporary destination file and writes input file src.txt into it:\n$ cat chirp_gt3548_1.sh\n#!/bin/sh\necho \"000000000000000000000000000000000\" &gt; /tmp/dst.txt\necho \"--- before ---\"\ncat -A /tmp/dst.txt\necho \"--------------\"\n/home/eje/condor/release/libexec/condor_chirp write -offset 0 -stride 0 0 /tmp/dst.txt src.txt\necho \"--- after ----\"\ncat -A /tmp/dst.txt\necho \"--------------\"\n\n# job to invoke the chirp script:\n$ cat gt3548_1.jsub\nexecutable = chirp_gt3548_1.sh\nuniverse = vanilla\nuserlog = gt3548_1.log\noutput = gt3548_1.out\nerror = gt3548_1.err\n+WantIOProxy = true\nqueue 1\n\n# run the job\n$ condor_submit gt3548_1.jsub\n\n# resulting output (notice \"cat -A\" displays '$' for newline)\n$ cat gt3548_1.out\n$ cat gt3548_1.out\n--- before ---\n000000000000000000000000000000000$\n--------------\n--- after ----\nabcdefghijklmnopqrstuvwxyz123456789A$\n--------------\n</pre></div>\n\n\n<p>The 2nd test is a legacy test that uses \"-stride 3 4\", and over-runs original file length:\n</p><div class=\"code\">\n<pre class=\"code\"># chirp with an offset and stride:\n$ cat chirp_gt3548_2.sh\n#!/bin/sh\necho \"000000000000000000000000000000000\" &gt; /tmp/dst.txt\necho \"--- before ---\"\ncat -A /tmp/dst.txt\necho \"--------------\"\n/home/eje/condor/release/libexec/condor_chirp write -offset 2 -stride 3 4 /tmp/dst.txt src.txt\necho \"--- after ----\"\ncat -A /tmp/dst.txt\necho \"--------------\"\n\n# submit file\n$ cat gt3548_2.jsub\nexecutable = chirp_gt3548_2.sh\nuniverse = vanilla\nuserlog = gt3548_2.log\noutput = gt3548_2.out\nerror = gt3548_2.err\n+WantIOProxy = true\nqueue 1\n\n# submit the job\n$ condor_submit gt3548_2.jsub\n\n# here we see overrun leaves null-chars in stride gaps (cat -A displays null chars as '^@'):\n$ cat gt3548_2.out\n--- before ---\n000000000000000000000000000000000$\n--------------\n--- after ----\n00abc0def0ghi0jkl0mno0pqr0stu0vwx$\nyz1^@234^@567^@89A^@$\n--------------\n</pre></div>\n\n\n<p>The 3rd test verifies use of new length parameter to cap the bytes of input that are written:\n</p><div class=\"code\">\n<pre class=\"code\"># script invokes chirp write with offset, stride and a write length (10):\n$ cat chirp_gt3548_3.sh\n#!/bin/sh\necho \"000000000000000000000000000000000\" &gt; /tmp/dst.txt\necho \"--- before ---\"\ncat -A /tmp/dst.txt\necho \"--------------\"\n/home/eje/condor/release/libexec/condor_chirp write -offset 2 -stride 3 4 /tmp/dst.txt src.txt 10\necho \"--- after ----\"\ncat -A /tmp/dst.txt\necho \"--------------\"\n\n# submit file\n$ cat gt3548_3.jsub\nexecutable = chirp_gt3548_3.sh\nuniverse = vanilla\nuserlog = gt3548_3.log\noutput = gt3548_3.out\nerror = gt3548_3.err\n+WantIOProxy = true\nqueue 1\n\n# run the job\n$ condor_submit gt3548_3.jsub\n\n# verify that the write was capped at 10 characters:\n$ cat gt3548_3.out\n--- before ---\n000000000000000000000000000000000$\n--------------\n--- after ----\n00abc0def0ghi0j000000000000000000$\n--------------\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-May-07 16:37:49 by eje:</em> <br/>\n\nNew functionality tests out.  Thanks Jon!</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/708/chirp_write2.patch\">chirp_write2.patch</a>\n4406 bytes added by jrt on 2013-Mar-21 16:16:23 UTC.\n<br/>\nRefactored to use swrite, which was previously unused code and to preserve old behavior when not using length. <br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-28 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7d05fb5d64002469d27f544b7c49005a6c4c1022\">[35895]</a></span>: improve documentation of new chirp write command option ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3548\" onclick=\"get_ticket_and_populate_wrapper('3548'); return false;\" title=\"chirp write appears to be broken\">#3548</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-07 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/448a489110b401e012056ac807b5466ea14c9e44\">[35638]</a></span>: ===VersionHistory=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3548\" onclick=\"get_ticket_and_populate_wrapper('3548'); return false;\" title=\"chirp write appears to be broken\">#3548</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-07 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/98d347ade58d9aa536c3e29b5c89d5abb5c29852\">[35637]</a></span>: Documentation for new length parameter for condor_chirp write <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3548\" onclick=\"get_ticket_and_populate_wrapper('3548'); return false;\" title=\"chirp write appears to be broken\">#3548</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-07 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5a518142a9a8bf0fab1ae533c25289e630bdb967\">[35636]</a></span>: Add a new length parameter to condor_chirp write ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3548\" onclick=\"get_ticket_and_populate_wrapper('3548'); return false;\" title=\"chirp write appears to be broken\">#3548</a></span> Committer: Erik Erlandson  (By Jon Thomas )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Sep-12 11:01", "status": "resolved", "created": "2013-Mar-20 11:12", "fixed_version": "2013-Mar-20 11:12", "broken_version": "v070901", "priority": "3", "subsystem": "Tools", "assigned_to": "eje", "derived_from": "", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "jthomas@redhat.com, matt@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}