{"id": 522, "title": "Ticket #522: condor_chirp fails when querying the value of a non-existing attribute", "description": "<blockquote>\nWhen querying the value of a non-existing attribute the <code>condor_chirp get_job_attr</code> command aborts, returning \"abnormal program termination\" on Windows and a core from SIGABRT on non-Windows.</blockquote>", "remarks": "<blockquote>\n<em>2010-Jul-15 00:05:24 by matt:</em> <br/>\n\nHere's the skinny...\n\n<p>On the shadow side,\n\n</p><p>A get_job_attr for an attribute that does not exist hits pseudo_ops.cpp:pseudo_get_job_attr(name, expr) and returns -1: e = ad-&gt;Lookup(name); if(e) { ... } else { ...; return -1; }\"\n\n</p><p>The -1 gets returned to the \"case CONDOR_get_job_attr\" in NTreceivers.cpp, which happily handles it by encoding a response of \"code(-1); code(0);\" -- the -1 is the return value and 0 is the default errno.\n\n</p><p>On the starter side,\n\n</p><p>The receiver in io_proxy_handler.cpp eventually calls IOProxyHandler::convert to translate the errno (remember it was 0) into a CHIRP_ERROR code to send to condor_chirp. However, errno is not a known code, resulting in CHIRP_ERROR_UNKNOWN and a dprintf of \"Starter ioproxy server got unknown unix errno:0\"\n\n</p><p>On the condor_chirp side,\n\n</p><p>Result of CHIRP_ERROR_UNKNOWN is received, which triggers an unceremonious fprintf to stderr of \"chirp: couldn't get response from server: Success\" followed swiftly by abort(). The \"Success\" is from strerror(errno) and is meaningless.\n\n</p><p>This behavior is definitely broken.\n\n</p><p></p><hr/>\n<em>2010-Jul-15 00:28:05 by matt:</em> <br/>\n\nOptions for resolving this broken behavior -\n\n<p>condor_chirp/PROTOCOL equates get_job_attr with getenv, which returns NULL if the env name isn't present\n\n</p><p></p><ul>\n<li>Stop aborting, return non-zero - however, abort() is a actually triggered by a problem in the protocol\n</li><li>Make unix_errno=0 known to IOProxyHandler::convert - however, requires picking an error code for 0, maybe CHIRP_ERROR_DOESNT_EXIST, changing all chirp client implementations to handle the new code, results in breaking wire protocol between new starter and old chirp clients\n</li><li>Change pseudo_get_job_attr to set errno, maybe to ENOENT - better than converting errno=0 to CHIRP_ERROR_DOESNT_EXIST in IOProxyHandler::convert, but has all the same drawbacks\n</li><li>Change pseudo_get_job_attr to return UNDEFINED - requires no protocol changes and no client changes, aligns well with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> semantics and getenv(\"DOESNT_EXIST\") -&gt; NULL (Lookup(\"DOESNT_EXIST\") -&gt; UNDEFINED)\n</li></ul>\n\n<p></p><hr/>\n<em>2010-Jul-15 00:29:29 by matt:</em> <br/>\n\n<div class=\"verbatim\">\n<pre>diff --git a/src/condor_shadow.V6.1/pseudo_ops.cpp b/src/condor_shadow.V6.1/pseudo_ops.cpp\nindex c71e1c2..c80230f 100644\n--- a/src/condor_shadow.V6.1/pseudo_ops.cpp\n+++ b/src/condor_shadow.V6.1/pseudo_ops.cpp\n@@ -705,8 +705,9 @@ pseudo_get_job_attr( const char *name, MyString &amp;expr )\n                dprintf(D_SYSCALLS,\"pseudo_get_job_attr(%s) = %s\\n\",name,expr.Value());\n                return 0;\n        } else {\n-               dprintf(D_SYSCALLS,\"pseudo_get_job_attr(%s) failed\\n\",name);\n-               return -1;\n+               dprintf(D_SYSCALLS,\"pseudo_get_job_attr(%s) is UNDEFINED\\n\",name);\n+               expr = \"UNDEFINED\";\n+               return 0;\n        }\n }\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-19 15:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38cb017412424f4c3bb51f524766db0fc64c71a1\">[18592]</a></span>: A failed Lookup from get_job_attr should return UNDEFINED instead of an error, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=522\" onclick=\"get_ticket_and_populate_wrapper('522'); return false;\" title=\"condor_chirp fails when querying the value of a non-existing attribute\">#522</a></span>  (By Matthew Farrellee )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jul-19 16:00", "status": "resolved", "created": "2009-May-27 12:02", "fixed_version": "2009-May-27 12:02", "broken_version": "v070000", "priority": "4", "subsystem": "Tools", "assigned_to": "matt", "derived_from": "", "creator": "burnett", "rust": "a19331", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu", "due_date": ""}