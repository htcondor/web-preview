{"id": 7812, "title": "Ticket #7812: Fix test_concurrency_limits.py", "description": "<blockquote>\nThis Ornithological test is currently disabled; fix it and enable it.\n\n<p></p><hr/>\nThe fundamental problem for this test is that there's a race condition in the negotiator's implementation of concurrency limits: it depends on startds reporting their concurrency token usage before the beginning of the next negotiation cycle; this is the reason for the NEGOTIATOR_CYCLE_DELAY knob.  The problem is fundamentally intractable: in a distributed system, we have to have a lease on the token and the lease has to time out to prevent failures from draining all of the tokens out of the system.\n\n<p>To make the test deterministic, we have to either control when the negotiator begins a new negotiation cycle or ensure that there are no more jobs in the queue than the concurrency limit until all of those jobs have started.  It's not clear if we can do the former (does condor_reschedule interrupt NEGOTIATOR_CYCLE_DELAY), but the former should not be too difficult to arrange.\n\n</p><p>So the plan is for a concurrency limit of <em>k</em>, submit <em>k</em> jobs, and wait for <em>k</em> slots to be reported as busy and using the concurrency token in the collector.  Then submit another job and wait to see the beginning and then then end of a negotiation cycles; this should cause the negotiator to log a concurrency limit exceeded event.  To make sure the negotiator can handle job completion and token re-use, put one of the running jobs on hold, and then wait for the new job's slot to be reported as busy in the collector.  Then feed another job in, and wait for a complete new negotiation cycle, which should also cause the negotiator to log a concurrency limit exceeded event.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Sep-10 11:20:35 by tlmiller:</em> <br/>\n\nTest branch merged to master.  I've created new ticket (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7852\" onclick=\"get_ticket_and_populate_wrapper('7852'); return false;\" title=\"Remove old concurrency limit tests.\">#7852</a></span>), targeted for 9.0.0, to remove all of the other concurrency limit tests once we're confident that this one is working in practice.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7852\" onclick=\"get_ticket_and_populate_wrapper('7852'); return false;\" title=\"Remove old concurrency limit tests.\">#7852</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRemove old concurrency limit tests.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-08 12:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d4228d52fd582ba70558ec05df3dbe105aca02b\">[61239]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7812\" onclick=\"get_ticket_and_populate_wrapper('7812'); return false;\" title=\"Fix test_concurrency_limits.py\">#7812</a></span>) Enable the partitionable slot tests.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-07 16:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9332a52fe4f1f0a5c2ad833788d07ce2d806230e\">[61236]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7812\" onclick=\"get_ticket_and_populate_wrapper('7812'); return false;\" title=\"Fix test_concurrency_limits.py\">#7812</a></span>) Fix bug in counting busy slots (not all idle slots get there by changing only their activity from busy).  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-07 12:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/77d33fe32cd712a15ee5ac80e989f15d32f8540a\">[61235]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7812\" onclick=\"get_ticket_and_populate_wrapper('7812'); return false;\" title=\"Fix test_concurrency_limits.py\">#7812</a></span>) Enable the new test.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-06 12:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/61b51211a1f8050ccd7ffda36dd8600b3535158e\">[61233]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7812\" onclick=\"get_ticket_and_populate_wrapper('7812'); return false;\" title=\"Fix test_concurrency_limits.py\">#7812</a></span>) Get the static slot -only version working without races. (Passed 1000 times on my machine.) Needs a lot of clean-up.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Sep-10 11:20", "status": "resolved", "created": "2020-Aug-25 18:52", "fixed_version": "2020-Aug-25 18:52", "broken_version": "", "priority": "3", "subsystem": "Tests", "assigned_to": "tlmiller", "derived_from": "#7811", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}