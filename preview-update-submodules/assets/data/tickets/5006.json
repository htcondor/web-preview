{"id": 5006, "title": "Ticket #5006: Dynamic Concurrency Limits", "description": "<blockquote>\n<span class=\"section\"><h2>Enhancement Request</h2></span>\n\n<p>Currently, the concurrency limits applied to a given job are evaluated before matchmaking starts.  This prevents us from using machine attributes to determine the concurrency limit to apply.\n\n</p><p>For example, we could do a partial evaluation of the concurrency limits in the current place; if that results in a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> value, we apply concurrency limits immediately.  Otherwise, we re-evaluate the attribute in the context of the potential match.\n\n</p><p><span class=\"section\"></span></p><h2>Use Case</h2>\nCMS has a certain class (high-IO jobs) of jobs that can easily overwhelm site storage systems if too many such jobs are run on a single site.  When there are several potential sites to chose from for running the job, we do not know the correct concurrency limit to apply unless we have a startd ad.  I'm thinking our <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ConcurrencyLimit\" title=\"Concurrency Limit\">ConcurrencyLimit</a></span> attribute will look like:\n\n<p></p><div class=\"verbatim\">\n<pre>ConcurrencyLimit = strcat(\"IO.\", target.GLIDEIN_CMSSite)\n</pre></div>\n\n\n<p>Currently, our \"manure spreader\" enforces this limit by limiting the number of high-IO jobs for a given site in the queue.  This is very problematic; if the limit is 100 and there are N manure spreaders, then we have to set the limit to 100/N per schedd.  If we have a non-random distribution of jobs between schedds (and we do), then we typically end up running 100/N high-IO jobs instead of the desired 100.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-May-10 22:16:49 by bbockelm:</em> <br/>\n\nNote - in order for dynamic concurrency limits to work in the presence of p-slots, we'd have to utilize consumption policies.\n\n<p></p><hr/>\n<em>2015-Jun-10 15:46:47 by tannenba:</em> <br/>\n\n<strong>QUICK CODE REVIEW</strong>\n\n<p>Thanks for the patch! I like how the code does exactly what it did before if the concurrency limit is just a string.  Jaime is going to do a more complete code review, but after a quick look-over:\n\n</p><p>1. In method <code>rejectForConcurrencyLimits()</code> this line looks suspicious:\n\n</p><p></p><pre>   if (lastRejectedConcurrencyString ==  limits) {return false;}\n</pre>\n\n<p>Seems at first blush like we want to return <code>true</code> here in order to reject, not <code>false</code>, right?\n\n</p><p>2. Patch should have a regression test; given item 1 above, not sure how much this patch was smoke tested.  A regression test should be pretty simple to do in a personal condor.\n\n</p><p>3. Not excited about the call to <code>EXCEPT</code> if a limit drops below zero.  I know that this patch is not responsible for this issue (i.e. it existed before this patch), but still seems very extreme to shutdown the entire matchmaker -vs- just logging something and refusing the match.\n\n</p><p></p><hr/>\n<em>2015-Jun-15 22:28:47 by bbockelm:</em> <br/>\n\nFor the record, here's the submit file I used to test:\n\n<p></p><div class=\"verbatim\">\n<pre>executable = foo.sh\nlog = test.log\noutput = foo/test.out\nerror = foo/test.err\n+ConcurrencyLimits=OpSys\nqueue 20\n</pre></div>\n\n\n<p>I setup a 6 static slots and set the <code>linux</code> concurrency limit to 3.  I then verified:\n</p><ul>\n<li>From an empty cluster, a single negotiation cycle matched three slots.\n  *: Additional slots in the match list were rejected.  I uncommented the debug statement to make sure the rejection information was being cached.\n</li><li>As claims were released (set <code>CLAIM_WORKLIFE=0</code>), concurrency limits were respected.\n</li></ul>\n\n<p>I'll need help with a regression test here.\n\n</p><p></p><hr/>\n<em>2015-Jun-16 11:10:40 by jfrey:</em> <br/>\n\n<strong>More Code Review</strong>\n\n<p>In addition to the items Todd mentioned before, I have one concern: In matchmakingAlgorithm(), when you try to pull a candidate from a populated <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span>, you return failure (no machines matched) if the top candidate exceeded a concurrency limit. Since different candidates can result in different limits, you need to keep looking at additional candidates. Your concurrency limit check should be moved into the preceding loop that pops candidates and checks for going over the submitter limit.\n\n</p><p></p><hr/>\n<em>2015-Jun-16 12:19:14 by bbockelm:</em> <br/>\n\nGood catch!  Fix pushed.\n\n<p>To validate, I used the same setup as before, but verified via inspecting the debug logs that the match list was utilized for each job (not rebuilt) and each entry inspected, even if there's a rejection.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jun-19 16:20:14 by tannenba:</em> <br/>\n\nMoving this ticket back to docpending status.  We need more than just a version history blurb in the manual for this change.  The section on Concurrency Limits, the condor_submit manpage, the Job Classad attributes section... they should all mention that the concurrency limits attribute in the job ad can either be a string (like it always has been) <em>or</em> a classad expression evaluated in the context of the candidate slot ad that should evaluate to a string.  An example in the Concurrency Limits section of the manual (explaining the motivation/scenario and showing both a sample job submit similar to how this ticket does) would also be desirable.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-08 10:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3416930667ca4c51a76bd9ace779498e3123368c\">[45253]</a></span>: spelling correction within doc <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-07 15:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/68f0c6ea6e5f96905f83a0e39ea086cc11679874\">[45247]</a></span>: Make some tweaks to the docs for dynamic concurrency limits. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-01 11:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1d5dd3bfaf5b700936f2e8cc566472aac44537bc\">[45190]</a></span>: complete documentation on extension to concurrency limits <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-29 12:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6e008cae158874be9c0c817a285d5e40ebcd738d\">[45171]</a></span>: apply concurrency limit based on machine attribute of match <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-25 17:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8073b6018407446cae1269a363cc7ffbfe767309\">[45170]</a></span>: Allow concurrency limits to be set as an expression in the submit file <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span> Added new submit command concurrency_limits_expr, since we can't reliably distinguish between an expression and a string literal without quotes with just the existing concurrency_limits command.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-25 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a121c30959c6aef0e8b185e29c800e6c9d1b62bd\">[45163]</a></span>: partial doc for concurrency limit specifications allowing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> expressions <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-16 16:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1e6098c351c7e34f20c595b9e984d3c4ad656536\">[45072]</a></span>: Version history for dynamic <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ConcurrencyLimits\" title=\"Concurrency Limits\">ConcurrencyLimits</a></span> expression. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-16 15:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ac6fb4a514161631c880dfc3b304217ad9ae500f\">[45070]</a></span>: Pull more from <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span> if rejecting for concurrency limits. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span> Previous change broke submitter limit check when currency limit is static.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-16 12:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5bd98a95e53a6a362853028c25994d0a244c87cf\">[45068]</a></span>: Fix logic error that broke matchlist caching. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-16 12:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6988f8ee00301c211f4f977375a6c19bdf7fcb9a\">[45067]</a></span>: Check full matchlist if rejecting for concurrency limits. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-15 22:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c87782a1959543c7c06344577c8bb32cf398312\">[45058]</a></span>: Fix rejection caching. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span> Verified that rejection caching works when there are additional resources in the matchlist to go through. Changed prior EXCEPT to a simple error.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-28 21:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/25ce0a5372733f1bef3b8bc59818e9f7b2d06b7a\">[44912]</a></span>: Delay evaluation of concurrency limits as necessary. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5006\" onclick=\"get_ticket_and_populate_wrapper('5006'); return false;\" title=\"Dynamic Concurrency Limits\">#5006</a></span> If the concurrency limit is not a string or refers to attributes in the machine ad, we do not check concurrency limits until a candidate machine is available.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Jul-07 15:41", "status": "resolved", "created": "2015-Apr-15 21:06", "fixed_version": "2015-Apr-15 21:06", "broken_version": "", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "smoler", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu tannenba@cs.wisc.edu jfrey@cs.wisc.edu", "due_date": ""}