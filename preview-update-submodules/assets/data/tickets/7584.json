{"id": 7584, "title": "Ticket #7584: libcondor_utils has RPATH set instead of RUNPATH", "description": "<blockquote>\nSome cmake changes made for 8.9.5 (<span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/edd4765cfc622ede8373d70cdd6e23d325bb86ea\">[58207]</a></span>, no associated ticket) accidentally changed the libcondor_utils shared library to have RPATH set instead of RUNPATH. This changes the search path for libraries that are dlopen()d by libcondor_utils. The search path for libraries at process start time is determined by the executable, which still has RUNPATH.\n\n<p>Commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/edd4765cfc622ede8373d70cdd6e23d325bb86ea\">[58207]</a></span> attempted to set linker flag <code>--enable-new-dtags</code> (which sets RUNPATH instead of RPATH) globally, but it only does it for executables, and not for shared libraries. It should set <code>CMAKE_SHARED_LINKER_FLAGS</code> in addition to <code>CMAKE_EXE_LINKER_FLAGS</code>.\n\n</p><p>The old code set the linker flag via <code>target_link_libraries()</code> for libclassad as well as most executables. This method adds the given flags to the link line of the target and all of its dependencies. Thus, libcondor_utils picked it up because it depends on libclassad.\n\n</p><p>This caused a problem for some CMS submit machines, where LD_LIBRARY_PATH is used to point to an alternate version of the OpenSSL libraries from cvmfs for their condor_dagman processes. At startup time, condor_submit (run by dagman) loads libcrypto from cvmfs (LD_LIBRARY_PATH overrides condor_submit's RUNPATH). Later, when it needs to read a GSI proxy, it dlopen()s libssl from /lib64 (using libcondor_util's RPATH, which precedes LD_LIBRARY_PATH). The two libraries are from slightly different versions and the dlopen() fails. This causes condor_submit to fail, as it can't interpret the proxy file.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Apr-07 21:33:18 by jfrey:</em> <br/>\n\nThe change from RUNPATH to RPATH also affects the python bindings libraries. Any dlopen() calls they do will be similarly affected.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-28 11:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d6d1cd66dc9aea720a7d42d653605c8b1d00b948\">[59511]</a></span>: Docs for libcondor_utils RPATH to RUNPATH fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7584\" onclick=\"get_ticket_and_populate_wrapper('7584'); return false;\" title=\"libcondor_utils has RPATH set instead of RUNPATH\">#7584</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-08 09:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a79269c0e1432d6804e05e769246651d6aace272\">[59274]</a></span>: Set RUNPATH for shared libraries in addition to executables. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7584\" onclick=\"get_ticket_and_populate_wrapper('7584'); return false;\" title=\"libcondor_utils has RPATH set instead of RUNPATH\">#7584</a></span> Otherwise, RPATH locations are searched before LD_LIBRARY_PATH locations when libcondor_utils dlopen()s a library (e.g. libssl, gsi).  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Apr-28 11:56", "status": "resolved", "created": "2020-Apr-07 21:06", "fixed_version": "2020-Apr-07 21:06", "broken_version": "v080905", "priority": "3", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}