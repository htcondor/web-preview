{"id": 4777, "title": "Ticket #4777: ClassAd references don't handle nested ads properly", "description": "<blockquote>\nWhen calculating the internal references of a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> expression, attribute references that delve into a nested ad aren't handled properly. Often, the attribute name in the nested ad is listed as if it were in the main ad.\n\n<p>The problems are mainly with GetInternalReferences(), but some of changes will also affect GetExternalReferences(). This ensures the two remain complementary.\n\n</p><p>GetInternalReferences() and GetExternalReferences() create an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EvalState\" title=\"Eval State\">EvalState</a></span> with rootAd set to the immediate parent scope of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> being evaluated. This suggests that references that go into any outer parent scopes should be considered external. We should change the lookup and evaluation code to treat EvalState::rootAd as the root of the tree, even if that ad has a non-NULL parentScope.\n\n</p><p>It will be difficult to support the full-names option of GetInternalReferences() in all cases, particularly when you have references inside nested ads. I propose we eliminate the full-names option and always use short names, and the short names are attributes of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> that GetInternalReferences() was invoked on. For the attribute reference <code>My.UidDomain</code> (assuming <code>UidDomain</code> is in the ad), both <code>My</code> and <code>UidDomain</code> would be included in the internal references. The compat layer can filter out <code>My</code>.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-16 21:40:08 by jfrey:</em> <br/>\n\nExample:\n<div class=\"verbatim\">\n<pre>[\n    Rank = B.F;\n    B = [ F = G; G = 3 ]\n]\n</pre></div>\n\n\n<p>In the ad above, if Rank was scanned for internal references, the resulting list would be B.F, F, G. Now, only B is returned.\n\n</p><p></p><hr/>\n<em>2015-Jan-27 16:22:10 by jfrey:</em> <br/>\n\nThe effect of this bug on users is minimal and hard to characterize. No version history.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4857\" onclick=\"get_ticket_and_populate_wrapper('4857'); return false;\" title=\"Minor fixups of ClassAd reference tracking\">#4857</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMinor fixups of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> reference tracking</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-07 16:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7617fadf651381e3d84186e36b0fd962c53e9c00\">[42129]</a></span>: Fix GetReferences() call in autocluster.cpp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4777\" onclick=\"get_ticket_and_populate_wrapper('4777'); return false;\" title=\"ClassAd references don't handle nested ads properly\">#4777</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-07 15:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/423979da50a3e0f1353921df858d9f303e253f1f\">[42126]</a></span>: Make <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> reference tracing more efficient in compat layer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4777\" onclick=\"get_ticket_and_populate_wrapper('4777'); return false;\" title=\"ClassAd references don't handle nested ads properly\">#4777</a></span> Many callers of ClassAd::GetReferences() only care about one type of reference. Now, we can avoid the unwanted reference tracing.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-16 21:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89d5ebeab915dc11f0e825ecbdbc2a7f5038142c\">[41945]</a></span>: Use new ClassAd::GetInternalReferences() behavior in compat layer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4777\" onclick=\"get_ticket_and_populate_wrapper('4777'); return false;\" title=\"ClassAd references don't handle nested ads properly\">#4777</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-16 21:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7718acbeb81a2ef074d889828e2470470e70e1b8\">[41944]</a></span>: Fix ClassAd::GetInternalReferences() with nested ads. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4777\" onclick=\"get_ticket_and_populate_wrapper('4777'); return false;\" title=\"ClassAd references don't handle nested ads properly\">#4777</a></span> Now, attributes in an enclosing scope are considered external. When attributes in an interior nested ad are referenced, only the name of the attribute in the top level ad being scanned is returned as an internal reference.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jan-30 14:10", "status": "resolved", "created": "2014-Dec-15 17:02", "fixed_version": "2014-Dec-15 17:02", "broken_version": "v080000", "priority": "3", "subsystem": "ClassAd", "assigned_to": "jfrey", "derived_from": "#4759", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}