{"id": 4540, "title": "Ticket #4540: EC2 GAHP crashes if $ENV{USER} not set.", "description": "<blockquote>\n<div class=\"verbatim\">\n<pre>        keyID = getenv( \"USER\" );\n        dprintf( D_FULLDEBUG, \"Using '%s' as access key ID for x.509\\n\", keyID.c_str() );\n</pre></div>\n\n\n<p>Obviously, since it's possible for USER not be in the environment, this will end badly.\n\n</p><p>It's not at clear, however, if we actually need the username.  It seems like it should be ignored (by the service).</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Aug-15 13:19:23 by tlmiller:</em> <br/>\n\nFound this when I went digging:\n\n<p></p><div class=\"verbatim\">\n<pre>Date: Thu, 30 Jun 2011 15:43:45 -0500\nFrom: Ted Hesselroth &lt;tdh@fnal.gov&gt;\nTo: Todd L Miller &lt;tlmiller@cs.wisc.edu&gt;\nCc: Steven Timm &lt;timm@fnal.gov&gt;\nSubject: Re: endpoint for ec2+x509?\n\nI have added your DN.\n\nIt's true that the AWSAccessKeyId is no longer needed. In OpenNebula this\ncorresponds to the username, which is looked from from the DN once the user\nis authenticated.\n</pre></div>\n\n\n<p>I also found a more-recent message from an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenNebula\" title=\"Open Nebula\">OpenNebula</a></span> developer --\n\n</p><p><a class=\"external\" href=\"http://lists.opennebula.org/pipermail/users-opennebula.org/2013-January/021644.html\">http://lists.opennebula.org/pipermail/users-opennebula.org/2013-January/021644.html</a>\n\n</p><p>-- where the recommended testing procedure using curl doesn't include an AWSAccessKeyID parameter.\n\n</p><p></p><hr/>\n<em>2014-Aug-21 09:00:42 by cat:</em> <br/>\n\nNeha Sharma has confirmed that the patch (against 8.0.7) fixed the problem for her. OSG plans to release its build of HTCondor 8.0.7 with the patch added. Please make the fix permanent in HTCondor 8.2 and beyond.\n\n<p></p><hr/>\n<em>2014-Aug-21 11:39:52 by tlmiller:</em> <br/>\n\nTimT, as we discussed, please review the following patch for 8.0.x.\n\n<p></p><div class=\"verbatim\">\n<pre>commit d4c8b53f7920de77ccff56f1d14fc151d2f3c324\nAuthor: Todd L Miller &lt;tlmiller@cs.wisc.edu&gt;\nDate:   Wed Aug 20 14:36:48 2014 -0500\n\n    (#4540)  Fix a crash bug when USER was unset in the environment.\n\ndiff --git a/src/ec2_gahp/amazonCommands.cpp b/src/ec2_gahp/amazonCommands.cpp\nindex ff2dbcf..9d7aae9 100644\n--- a/src/ec2_gahp/amazonCommands.cpp\n+++ b/src/ec2_gahp/amazonCommands.cpp\n@@ -233,10 +233,7 @@ bool AmazonRequest::SendRequest() {\n     // and are (currently) 20 characters long.\n     //\n     std::string keyID;\n-    if( protocol == \"x509\" ) {\n-        keyID = getenv( \"USER\" );\n-        dprintf( D_FULLDEBUG, \"Using '%s' as access key ID for x.509\\n\", keyID.c_str() );\n-    } else {\n+    if( protocol != \"x509\" ) {\n         if( ! readShortFile( this-&gt;accessKeyFile, keyID ) ) {\n             this-&gt;errorCode = \"E_FILE_IO\";\n             this-&gt;errorMessage = \"Unable to read from accesskey file '\" + this-&gt;accessKeyFile + \"'.\";\n@@ -244,8 +241,8 @@ bool AmazonRequest::SendRequest() {\n             return false;\n         }\n         if( keyID[ keyID.length() - 1 ] == '\\n' ) { keyID.erase( keyID.length() - 1 ); }\n+        query_parameters.insert( std::make_pair( \"AWSAccessKeyId\", keyID ) );\n     }\n-    query_parameters.insert( std::make_pair( \"AWSAccessKeyId\", keyID ) );\n\n     //\n     // This implementation computes signature version 2,\n@@ -313,11 +310,11 @@ bool AmazonRequest::SendRequest() {\n     // or SHA1 as the hash algorithm.\"\n     std::string saKey;\n     if( protocol == \"x509\" ) {\n-        // If we we ever support the UploadImage action, we'll need to\n+        // If we ever support the UploadImage action, we'll need to\n         // extract the DN from the user's certificate here.  Otherwise,\n         // since the x.509 implementation ignores the AWSAccessKeyId\n         // and Signature, we can do whatever we want.\n-        saKey = std::string( \"&lt;DN&gt;/CN=UID:\" ) + getenv( \"USER\" );\n+        saKey = std::string( \"not-the-DN\" );\n         dprintf( D_FULLDEBUG, \"Using '%s' as secret key for x.509\\n\", saKey.c_str() );\n     } else {\n         if( ! readShortFile( this-&gt;secretKeyFile, saKey ) ) {\n</pre></div>\n\n\n<p></p><hr/>\n<em>2014-Aug-26 14:04:30 by tim:</em> <br/>\n\nOSG will carry this patch for the 8.0.x series. We will not release another 8.0.x series unless a security issue arises and then the release will only address that security issue and nothing else.\n\n<p>So, please apply this to the V8_2-branch for inclusion in 8.2.3.\n\n</p><p><strong>CODE REVIEW</strong>: Looks good. I approve this change.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Sep-02 16:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0282af61c42e8566de3deb051ef486cfd3b281ce\">[41077]</a></span>: minor edit of 8.2.3 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4540\" onclick=\"get_ticket_and_populate_wrapper('4540'); return false;\" title=\"EC2 GAHP crashes if $ENV{USER} not set.\">#4540</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-29 11:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5be864699780e6d350393ce582eb1e8e01645bca\">[41058]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4486\" onclick=\"get_ticket_and_populate_wrapper('4486'); return false;\" title=\"Calling posix_memalign() prevents standard universe from linking.\">#4486</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4540\" onclick=\"get_ticket_and_populate_wrapper('4540'); return false;\" title=\"EC2 GAHP crashes if $ENV{USER} not set.\">#4540</a></span>.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-26 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dbabc03ff7ffc597eef69fa8d456308fd97b108b\">[41042]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4540\" onclick=\"get_ticket_and_populate_wrapper('4540'); return false;\" title=\"EC2 GAHP crashes if $ENV{USER} not set.\">#4540</a></span>) Fix a crash in the EC2 GAHP if $ENV{USER} isn't set.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-29 11:31", "status": "resolved", "created": "2014-Aug-15 12:59", "fixed_version": "2014-Aug-15 12:59", "broken_version": "v070902", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "neha@fnal.gov, cat@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}