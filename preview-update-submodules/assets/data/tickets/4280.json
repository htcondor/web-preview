{"id": 4280, "title": "Ticket #4280: Slot config needs new features to support async stageout", "description": "<blockquote>\nNew capabilities are needed in the STARTD configuration to support transfer slots for asynchronous configuration\n<ul>\n<li>small resource usage, especially &lt; 1 CPU\n</li><li>designating which transfer slot belongs to which normal (execute) slot\n</li><li>option to have transfer slots not advertised to the collector\n</li><li>ability to configure START, PREEMPT and other expressions separately for each slot type.\n</li></ul>\n\n<p>We will achieve this with new configuration option for <code>SLOT_TYPE_&lt;n&gt;</code>, and several new knobs with a <code>SLOT_TYPE_&lt;n&gt;</code> prefix.\n\n</p><p></p><ul>\n<li><code>SLOT_TYPE_&lt;n&gt; = minimal</code> triggers new behavior in the resource allocator. Assignment of fractional CPU will be allowed, and fractional CPU values will not be accounted for in the determination of whether there are enough CPUs for the requested slots. <code>minimal</code> can be used the same way that <code>auto</code> is, either as the only slot definition, or as just one of a set of resource options for <code>SLOT_TYPE_&lt;n&gt;</code>.  For instance the amount of disk &amp; memory may be explicitly specified while the minimal keyword is used to permit fractional CPU assignment.\n<div class=\"code\">\n<pre class=\"code\">SLOT_TYPE_2 = minimal, memory=100 disk=auto</pre></div>\n\n\n<p></p></li><li><code>SLOT_TYPE_&lt;n&gt;_PAIRED_WITH = SLOT_TYPE_&lt;x&gt;</code> causes each slot of type <code>&lt;n&gt;</code> to be assigned a pair slot of type <code>&lt;x&gt;</code> when the slot is created. This relationship is advertised in all of the slots, type <code>&lt;n&gt;</code> and type <code>&lt;x&gt;</code> in the attribute <code>SlotPairName</code>\n\n<p></p></li><li><code>SLOT_TYPE_&lt;n&gt;_VISIBLE = false</code> tells the STARTD to not advertise slots of type <code>&lt;n&gt;</code> to the Collector. These slots will still be returned to a <code>condor_status -direct</code> query.\n\n<p></p></li><li><code>SLOT_TYPE_&lt;n&gt;_NAME_PREFIX = xfer</code> will create slots of type <code>&lt;n&gt;</code> will names that begin with \"xfer\" instead of the default of \"slot\". This feature is nice to have but not strictly necessary. It may be removed if it turns out that there are parts of HTCondor that depend on the prefix being \"slot\".\n\n<p></p></li><li><code>SLOT_TYPE_&lt;n&gt;_&lt;knob&gt; = &lt;expr&gt;</code> where &lt;knob&gt; is one of the config knobs that control slot matchmaking behavior:\n<div class=\"code\">\n<pre class=\"code\">START, SUSPEND, CONTINUE, PREEMPT, KILL, WANT_SUSPEND, WANT_VACATE, RANK\nWANT_HOLD, WANT_HOLD_REASON, WANT_HOLD_SUBCODE,\nCLAIM_WORKLIFE, MaxJobRetirementTime, MachineMaxVacateTime,\nPERIODIC_CHECKPOINT, SUSPEND_VANILLA, CONTINUE_VANILLA, PREEMPT_VANILLA,\nKILL_VANILLA, WANT_SUSPEND_VANILLA, WANT_VACATE_VANILLA,\nSTART_BACKFILL, EVICT_BACKFILL, ATTR_FETCH_WORK_DELAY,\nSLOT_WEIGHT, SlotWeight, IsOwner, CpuBusy\n</pre></div>\n\n</li></ul>\n\n<p>It is expected that these new features will be used to create transfer slots using a configuration similar to the following.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NUM_SLOTS_TYPE_1 = $(NUM_CPUS)\nNUM_SLOTS_TYPE_2 = $(NUM_SLOTS_TYPE_1)\nSLOT_TYPE_2_PAIRED_WITH = SLOT_TYPE_1\nSLOT_TYPE_2_VISIBLE = false\nSLOT_TYPE_2_NAME_PREFIX = xfer\nSLOT_TYPE_2_START = undefined\nSLOT_TYPE_2 = minimal, memory=100 disk=auto\n</pre></div>\n\n\n<p>Here is a file to use with condor_status -print-format to see slot pairs\n</p><div class=\"code\">\n<pre class=\"code\"># condor_status query for slot pairs, use with condor_status -direct to see hidden pairs.\nSELECT\n   Machine WIDTH AUTO\n   splitslotname(Name)[0] AS SlotName WIDTH -8\n   IfThenElse(SlotPairName isnt undefined,splitslotname(SlotPairName)[0],\"-\") AS Paired\n   Strcat(Arch,\"_\",IfThenElse(OpSys==\"WINDOWS\",OpSysShortName,OpSysAndVer)) AS Platform\n   Cpus AS Cpus PRINTF \"%.3f\"\n   # IfThenElse(GPUs isnt undefined,GPUs,0) AS GPUs PRINTF \"%4d\"\n   Memory WIDTH 6\n   Disk       WIDTH 8\n   EnteredCurrentActivity AS \"  StatusTime\"  PRINTAS ACTIVITY_TIME NOPREFIX\n   Strcat(State,\"/\",Activity) AS Status WIDTH -14 TRUNCATE\n   ifthenelse(JobId isnt undefined, JobId, \"\") AS JobID\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-23 10:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0f3ef6df129cae09b389a0ec65f7a7c54db0c693\">[40021]</a></span>: remove backdoor hack to test claim swapping without a schedd <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-19 17:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f48a895cf118d24ab05467ea677de954e7a8821d\">[39996]</a></span>: strip condor_config (i.e. condor_config.generic) down to bare essentials <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4325\" onclick=\"get_ticket_and_populate_wrapper('4325'); return false;\" title=\"Strip default condor_config file down to the bare essentials.\">#4325</a></span> part of <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span>. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-14 14:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b0abdac63b811e1f80f311c4df27ac33dc65df27\">[39920]</a></span>: Squashed commit of the following: V8_1-async_transfer, which adds overly execute and output transfer. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4291\" onclick=\"get_ticket_and_populate_wrapper('4291'); return false;\" title=\"Overlayed I/O with dedicated transfer slots\">#4291</a></span>\u00a0[...]\n (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-14 11:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e8c5df4946457e46e0361866ca0393b00135e2ab\">[39918]</a></span>: fix slot_type config for cp (there was a cut-n-paste error) <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-11 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/580ae66154d89d3c373133c436a698c8074f8125\">[39905]</a></span>: Abort startd with reasonable error message when PAIRED_WITH and PARTITIONABLE are use together <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4291\" onclick=\"get_ticket_and_populate_wrapper('4291'); return false;\" title=\"Overlayed I/O with dedicated transfer slots\">#4291</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-09 15:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fb338ec65402ac1f6159ffc9aa1a02b7151f23cf\">[39889]</a></span>: rename config ALLOW_SLOT_CLAIM_SWAP to ALLOW_SLOT_PAIRING <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4291\" onclick=\"get_ticket_and_populate_wrapper('4291'); return false;\" title=\"Overlayed I/O with dedicated transfer slots\">#4291</a></span> This change also updates the $EXPERIMENTAL:ASYNC_STAGING knob and fixes a typo in the implemtation of SLOT_TYPE_n_START, etc. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Apr-09 11:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/241c186b86c357904033a770ac5ec9cefc634998\">[39887]</a></span>: Add SLOT_TYPE_n_* overrides for START, PREEMPT, etc <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span> child of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4291\" onclick=\"get_ticket_and_populate_wrapper('4291'); return false;\" title=\"Overlayed I/O with dedicated transfer slots\">#4291</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-31 17:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d81b20c6b84c3bc0c287c6db0a2836ab8c9613a0\">[39810]</a></span>: change config for hiding slots from *_VISIBLE=0 to *_HIDDEN=1 <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span> also rename metaknob for async stageout to $EXPERIMENTAL.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-27 10:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6aa9c608fa06eb672da011771f4016db3fc04404\">[39731]</a></span>: Add SLOT_TYPE_n params to enable creation of transfer slots <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=4280\" onclick=\"get_ticket_and_populate_wrapper('4280'); return false;\" title=\"Slot config needs new features to support async stageout\">#4280</a></span> New startd config in this commit: minimal keyword for SLOT_TYPE_n SLOT_TYPE_n_VISIBLE SLOT_TYPE_n_PAIRED_WITH SLOT_TYPE_n_NAME_PREFIX  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "experimental", "last_change": "2014-May-19 15:41", "status": "docpending", "created": "2014-Mar-27 10:29", "fixed_version": "2014-Mar-27 10:29", "broken_version": "v080100", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "#4291", "creator": "zmiller", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}