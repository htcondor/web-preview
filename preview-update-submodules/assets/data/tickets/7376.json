{"id": 7376, "title": "Ticket #7376: Add support for Kerberos and AFS creds for running job", "description": "<blockquote>\n<strong>NOTE: Documentation work to be done in ticket</strong> <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7646\" onclick=\"get_ticket_and_populate_wrapper('7646'); return false;\" title=\"Update security docs for kerberos, krb5, afs, oauth, credmon, credd\">#7646</a></span>\n\n<p>Make it trivial to turn on support for AFS access out of the box.\n\n</p><p>This work lives on the V8_8-KerbAfs-branch\n\n</p><p>We need to add these scripts to the release:\n</p><ul>\n<li>credmon\n</li><li>credmon support script\n</li><li>credential producer\n</li></ul>\n\n<p>Then we need to make a metaknob that sets everything appropriately:\n</p><div class=\"code\">\n<pre class=\"code\">[$FEATURE.KRBAFS]\ndescription=Enable the daemons and features need to support running jobs with krb tickets and AFS tokens.\ndefault : @end\n        SEC_CREDENTIAL_DIRECTORY_KRB=/var/condor/credentials.d/krb\n        DAEMON_LIST=$(DAEMON_LIST),CREDMON_KRBAFS\n        AUTO_INCLUDE_CREDD_IN_DAEMON_LIST = True\n        SEC_CREDENTIAL_PRODUCER=$(LIBEXEC)/krb_cred_producer\n        USE_KEYRING_SESSIONS=TRUE\n@end\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Nov-26 14:21:02 by zmiller:</em> <br/>\n\nThis is what I sent to IHEP (with a couple changes because I renamed some scripts)\n\n<p></p><div class=\"code\">\n<pre class=\"code\"># CONFIGURATION FOR BOTH SUBMIT AND EXECUTE MACHINES:\n\n# Tell condor where to store the credentials:\n# You will need to create this directory as root and set permissions to 755\nSEC_CREDENTIAL_DIRECTORY = $(LOCAL_DIR)/cred_dir\n\n# Tell HTCondor to use keyrings (for AFS)\nUSE_KEYRING_SESSIONS = TRUE\n\n# Tell HTCondor what machine the credd is on\nCREDD_HOST = &lt;hostname of submit machine&gt;\n\n\n# CONFIGURATION FOR SUBMIT MACHINES ONLY:\n# Tell Condor where the credmon is\nCREDMON = $(SBIN)/credmon_krbafs\n# Add the credd and credmon to the daemon list\nDAEMON_LIST = $(DAEMON_LIST), CREDD, CREDMON\n# Tell credd to act in Kerberos mode\nCREDD_OAUTH_MODE = false\n# This produces the initial kerb ticket for a user\nSEC_CREDENTIAL_PRODUCER = $(LIBEXEC)/krb_cred_producer\n\n# CONFIGURATION FOR EXECUTE MACHINES ONLY:\n# Tell Condor where the credmon is\nCREDMON = $(SBIN)/credmon_krbafs\n# Add the credmon to the daemon list\nDAEMON_LIST = $(DAEMON_LIST), CREDMON\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Dec-19 12:13:08 by zmiller:</em> <br/>\n\nDiscovered today:  The default value for SEC_CREDENTIAL_REFRESH_INTERVAL is -1, which means it is turned off.  When packaging this should be set to some sane value (one hour?).  Simple param table change.\n\n<p></p><hr/>\n<em>2020-Mar-16 12:36:07 by zmiller:</em> <br/>\n\nTJ, please review last three commits (from March 2020) to make sure they are compatible with the new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CredMon\" title=\"Cred Mon\">CredMon</a></span> architecture you committed last week.  Thanks!\n\n<p></p><hr/>\n<em>2020-Mar-18 14:20:53 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> you cannot add SEC_CREDENTIAL_DIRECTORY_KRB into the param table! doing so causes the schedd to block forever on startup unless a credmon is running and creating the CREDMON_COMPLETE file.  I think you should remove that from the param table, and put it into the metaknob.\n\n<p>As for the metaknob, is that intended to take an argument that lets you choose between submit and execute config? what would that look like in use?\n\n</p><p></p><hr/>\n<em>2020-Mar-18 16:27:01 by zmiller:</em> <br/>\n\nOkay, will move the SEC_CREDENTIAL_DIRECTORY_KRB to the metaknob.  Didn't realize just defining it would trigger any behavior but that makes sense.\n\n<p>I need a different DAEMON_LIST for the submit machine and execute machines.  so yes, the idea is that on a submit machine you would add:\n</p><div class=\"code\">\n<pre class=\"code\">use feature:KRBAFS(SUBMIT)\n</pre></div>\n\nand on an execute machine you would add:\n<div class=\"code\">\n<pre class=\"code\">use feature:KRBAFS\n</pre></div>\n\nIf there is a better way to do this, I am all ears.\n\n<p></p><hr/>\n<em>2020-Mar-18 17:19:37 by johnkn:</em> <br/>\n\nto check for a specific arg value in a metaknob do\n<div class=\"snip\">\n<pre class=\"sniplabel\">metaknob fragment</pre>\n<pre class=\"snip\">krbafs_argtest = \"SUBMIT\"==\"$(1)\"\nif $INT(krbafs_argtest)\n   # submit stuff\nelse\n   krbafs_argtest = \"EXECUTE\"==\"$(1)\"\n   if $INT(krbafs_argtest)\n      # execute stuff\n   else\n      error : use POLICY : KRBAFS requires a SUBMIT or EXECUTE argument\n   endif\nendif\n# clear the temp var so it doesn't pollute the config dump\nkrbafs_argtest =\n</pre></div>\n\n\n<p>but you could also do this with token pasting\n</p><div class=\"snip\">\n<pre class=\"sniplabel\">metaknob fragment</pre>\n<pre class=\"snip\">krbafs_submit_daemons = CREDD, CREDMON_KRB\nkrbafs_execute_daemons = CREDMON_KRB\nif ! defined krbafs_$(1)_daemons\n   error : use POLICY : KRBAFS requires a SUBMIT or EXECUTE argument\nelse\n   DAEMON_LIST = $(DAEMON_LIST) $(krbafs_$(1)_daemons)\nendif\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Mar-19 05:35:28 by tannenba:</em> <br/>\n\nInstead of passing an argument to the meta-knob, could the meta-knob simply look to see if <code>DAEMON_LIST</code> includes <code>SCHEDD</code> or not? Do a case insensitive compare of course.\nAlso, if a machine is both an execute node and a submit node, we want the same setup as a submit-only node, right?\n\n<p></p><hr/>\n<em>2020-Mar-19 07:57:15 by zmiller:</em> <br/>\n\nTodd, checking for <code>SCHEDD</code> in the <code>DAEMON_LIST</code> is what I wanted to do originally.  Unfortunately, TJ pointed out the check is not guaranteed to work because it would only check the <code>DAEMON_LIST</code> at that point of parsing the config, not the \"final\" value.  I kind of dislike having the metaknob definition be config order-specific so I opted for making the parameter explicit for now.  The other way to handle this would be by adding code to the master like we do with <code>AUTO_INCLUDE_SHARED_PORT_IN_DAEMON_LIST</code>, but I was also following the general rule to not add more stuff to the master.\n\n<p>If you feel strongly about one approach vs another please let me know... I am happy to implement any of them.\n\n</p><p></p><hr/>\n<em>2020-Mar-19 09:36:54 by johnkn:</em> <br/>\n\nWe should consider metaknob implemetation temporary and plan to change it in the future to do something like AUTO_INCLUDE_SHARED_PORT_IN_DAEMON_LIST so that that master starts the CREDD only when it sees a SCHEDD in the daemon list.\n\n<p></p><hr/>\n<em>2020-Mar-19 10:17:24 by zmiller:</em> <br/>\n\nWell, let's just do it right the first time.  Having not heard any other opinions, I'm working on some code in the master to automatically add the <code>CREDD</code> to the <code>DAEMON_LIST</code> if <code>SEC_CREDENTIAL_PRODUCER</code> is set.  TJ, when I'm done I'll assign to you for review.\n\n<p></p><hr/>\n<em>2020-Mar-20 13:09:16 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> looks good now with <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0806256ef02cd1ec7553096b6a13618393ead0c1\">[59181]</a></span> changes\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-01 16:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f8f93556621461ec8a392704f594d5348497b372\">[59555]</a></span>: Remove troublesome space. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-28 13:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/700c6a298f97114eca91c1054a7c1b1423b84fd5\">[59515]</a></span>: Tell git about the renamed credmon <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-28 12:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c5cd2ce6d1f93f98ca44c2c04f755ff5dd7d206c\">[59513]</a></span>: Another round of updates to the KRB/OAUTH params and metaknobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-13 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b73b43bc73d4ca8310be24fa04dd0d0897628e0a\">[59341]</a></span>: Use the directory that conforms to the OAuth and packaging convention. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-01 09:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4aefa7e5d037854603acd5215850734d04b922d1\">[59222]</a></span>: Actually rename the file itself, not just the config knobs. Derp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-01 08:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d2341fb2c38f2a6e6ba465581ff551e80a146b7b\">[59219]</a></span>: Rename user-visible filenames and config names for consistency and to match upcoming future OAuth commits. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-20 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e0677e18b43f069c4fb62346fe3872f2beb35ea6\">[59182]</a></span>: Clean up debug messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-20 12:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0806256ef02cd1ec7553096b6a13618393ead0c1\">[59181]</a></span>: Redo AUTO_INCLUDE_SCHEDD_IN_DAEMON_LIST to not depend on other settings. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-19 11:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e35667356c598c67a8d807e80c32c822f6e9b58a\">[59179]</a></span>: Fix KRBAFS metaknob to not take a parameter. Logic was added in the master to auto-add the CREDD when needed. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-18 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d950d772d4818745f3bf22eaca2138e324e90c3\">[59175]</a></span>: move SEC_CREDENTIAL_DIRECTORY_KRB out of param table and into the metaknob <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 12:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/17520d677f22d620043c4798da50c0b2d0e6735c\">[59160]</a></span>: Add metaknob for enabling krb/afs support <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-13 13:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/20f3e6c12412ddc68f25e99bea23243eb3df5d50\">[59151]</a></span>: add default credmon_krb entries in param table <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-12 17:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ffeee87d9f90073aacb09c344606f9c5ca0eb71a\">[59148]</a></span>: rename file to make it easier to grep for running condor daemons. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-22 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8c2476cd044d858f8854703d1d3968a8dc4a6efe\">[58539]</a></span>: use default location if KRB5CCNAME is not set. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-19 17:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/11bf1fc0ed5fadded9e65e355c74633aeedc168a\">[58513]</a></span>: added thorough error checking to krb_cre_producer <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-18 14:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/60a5a7727c1e41112fcd619474b8aaa0e07656a0\">[58497]</a></span>: Put AFS support scripts in the appropriate places when building <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-13 17:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1eff9daad24cd1e3cf6c6fd38c794d4d57883067\">[58459]</a></span>: Initial versions of Kerberos and AFS credmons and supporting scripts. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7376\" onclick=\"get_ticket_and_populate_wrapper('7376'); return false;\" title=\"Add support for Kerberos and AFS creds for running job\">#7376</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-May-20 09:29", "status": "resolved", "created": "2019-Nov-13 16:50", "fixed_version": "2019-Nov-13 16:50", "broken_version": "", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "zmiller@cs.wisc.edu, tannenba@cs.wisc.edu, peter.wienemann@uni-bonn.de, freyermuth@physik.uni-bonn.de, johnkn@cs.wisc.edu", "due_date": ""}