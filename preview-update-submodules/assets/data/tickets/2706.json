{"id": 2706, "title": "Ticket #2706: Schedd should kill claim when lease expires", "description": "<blockquote>\nWhen the claim lease between the schedd and startd expires, the startd kills the job and leaves the claimed state. The schedd doesn't do anything. In some cases, the shadow will notice that its connection to the starter has closed and exit with an error code. But if the startd machine drops off the network without a trace, the shadow may not notice the dead connection for 2 hours. To avoid this situation, the schedd should check for expired claim leases and abort the claim (and the shadow) when it sees an expired lease.\n\n<p>Note: Having the schedd detect expired claim leases depends on the new startd-sends-alives protocol. Since this has been the default for a while and we want to remove the old schedd-sends-alives protocol, this dependency shouldn't be a problem.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Dec-13 06:26:38 by matt:</em> <br/>\n\nIs this a bug in the Schedd's handling of STARTD_SENDS_ALIVES=TRUE?\n\n<p>When do you plan to remove STARTD_SENDS_ALIVE=FALSE?\n\n</p><p></p><hr/>\n<em>2011-Dec-13 10:06:10 by jfrey:</em> <br/>\n\nI'd say it's a bug in STARTD_SENDS_ALIVES=TRUE. We want to put the fix into 7.6 if it's simple, which I believe it will be.\n\n<p>As for removing STARTD_SENDS_ALIVES=FALSE, I think we'll need to wait for 7.9. It was only in 7.5.4 that we changed the default from False to True and had the schedd alone decide which value to use.\n\n</p><p></p><hr/>\n<em>2011-Dec-13 12:56:30 by jfrey:</em> <br/>\n\nI've attached a patch that makes the schedd relinquish a claim and kill the shadow if the claim lease expires. It works for claim that are running non-parallel jobs.\n\n<p>The patch also fixes a bug when the schedd has a mixture of startd-sends-alive and schedd-sends-alive jobs.\n\n</p><p></p><hr/>\n<em>2011-Dec-15 14:05:28 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good, just some minor changes -\n</p><ol>\n<li>add comment at inserted time(NULL) to explain it is to deal w/ mixed startd and schedd send alive pools.\n</li><li>get time(NULL) out of the while loop; can just use \"now\"\n</li><li>remove extraneous lease_duration &gt; 0 check in last conditional, it is gratuitous\n</li><li>make sure srec isn't NULL before de-refing it\n</li><li>don't try and send vacate to the startd - the lease expired on that side as well, so it isn't needed, and further more the schedd prolly cannot talk to the startd now anyhow, so it is just a waste of precious bodily fluids... i mean schedd resources...\n</li></ol>\n\n<p></p><hr/>\n<em>2011-Dec-15 15:12:04 by jfrey:</em> <br/>\n\nPatch committed and pushed with Todd's recommended changes.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2736\" onclick=\"get_ticket_and_populate_wrapper('2736'); return false;\" title=\"schedd tries to kill pid 0 and then excepts\">#2736</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nschedd tries to kill pid 0 and then excepts</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/509/lease_expire.patch\">lease_expire.patch</a>\n1635 bytes added by jfrey on 2011-Dec-13 18:54:24 UTC.\n<br/>\nPatch to make schedd a match and shadow when the claim lease expires.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-19 10:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b2f8cd7efd98d81d566517909f5a52a48498ca17\">[28843]</a></span>: minor edit of version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2706\" onclick=\"get_ticket_and_populate_wrapper('2706'); return false;\" title=\"Schedd should kill claim when lease expires\">#2706</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-15 15:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7a3eaf9e87c5ee44ea89138fb4180428eff21265\">[28824]</a></span>: Document schedd kill claims on lease expiration. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2706\" onclick=\"get_ticket_and_populate_wrapper('2706'); return false;\" title=\"Schedd should kill claim when lease expires\">#2706</a></span> ===VersionHistory:Complete===  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-15 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/213c5695027ada2609b7063f46df7d3cea7a1494\">[28823]</a></span>: Schedd now kills claims when the lease expires. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2706\" onclick=\"get_ticket_and_populate_wrapper('2706'); return false;\" title=\"Schedd should kill claim when lease expires\">#2706</a></span> With the newer startd-sends-alives protocol for the claim lease, the schedd knows when the lease has expired, but before now, it didn't do anything. If the execute machine drops off the network, the schedd can end up waiting up to two hours before\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Dec-15 15:12", "status": "resolved", "created": "2011-Dec-12 17:24", "fixed_version": "2011-Dec-12 17:24", "broken_version": "v070600", "priority": "4", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}