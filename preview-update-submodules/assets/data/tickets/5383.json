{"id": 5383, "title": "Ticket #5383: The %cmake macro includes extra undesired CFLAGS for RPM builds", "description": "<blockquote>\nIn HTCondor v8.2, we build all binaries posted on the web by invoking cmake, including the RPM packages.\n\n<p>In HTCondor v8.4, we build the RPM packages using rpmbuild.  However, the %cmake macro in the condor.spec file ends up setting in extra compiler flags (like FORTIFY and/or stack-protector) onto each and every source module; this breaks standard universe and potentially other things (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5382\" onclick=\"get_ticket_and_populate_wrapper('5382'); return false;\" title=\"Restart from checkpoint failing for HTCondor 8.4.1\">#5382</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5240\" onclick=\"get_ticket_and_populate_wrapper('5240'); return false;\" title=\"collector crashes on RHEL7 when more than 1023 fds active\">#5240</a></span>).  In addition, we now have the undesirable situation where the binaries tested in our regression test suite, and the binaries released in the tarball and/or DEB packages, are fundamentally different than the binaries contained in the RPM packages because they are built with different compiler flags.\n\n</p><p>We should modify the condor.spec file so rpmbuild uses the same compiler flags that our regular cmake (tarball) build does.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Nov-10 13:57:22 by tim:</em> <br/>\n\nThe EL 7 RPM packages are built with %cmake macros in HTCondor v8.2.\n\n<p></p><hr/>\n<em>2015-Nov-10 15:06:27 by edquist:</em> <br/>\n\nTim,\n\n<p>I noticed <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fafce528ec5b4d45a97aa44dc293b12db4e7e69\">[46236]</a></span> -- not sure but you might want to check the <code>%cmake</code> expansion for both 32 and 64 bit separately, as for instance, <code>-DLIB_INSTALL_DIR:PATH=/usr/lib64</code> is (presumably) not valid for 32 bit...  Not sure whether any other important settings are different for 32 bit.\n\n</p><p></p><hr/>\n<em>2015-Nov-10 15:24:53 by edquist:</em> <br/>\n\nAlternatively, you might be able to avoid the whole game of reproducing the whole <code>%cmake</code> expansion (minus CFLAGS, etc), which can vary between platforms (el5 vs el6 ..., as well as i386 vs x86_64), by doing something like\n\n<p></p><div class=\"code\">\n<pre class=\"code\">CFLAGS=' '\nCXXFLAGS=' '\n%cmake ...\n</pre></div>\n\n\n<p>That would keep all the <code>-D...</code> flags that <code>%cmake</code> adds, but would not re-define CFLAGS/CXXFLAGS.\n\n</p><p></p><hr/>\n<em>2015-Nov-12 11:47:03 by tim:</em> <br/>\n\nTested std univ in CentOS 6 VM. Smoke tests passed.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-16 17:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/72d57d41fef924d20eb6fcb56eb1480e2cb26f86\">[46268]</a></span>: Add version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5349\" onclick=\"get_ticket_and_populate_wrapper('5349'); return false;\" title='HTCondor RPMs should not \"provide\" .so files in private directories'>#5349</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5382\" onclick=\"get_ticket_and_populate_wrapper('5382'); return false;\" title=\"Restart from checkpoint failing for HTCondor 8.4.1\">#5382</a></span>, <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5383\" onclick=\"get_ticket_and_populate_wrapper('5383'); return false;\" title=\"The %cmake macro includes extra undesired CFLAGS for RPM builds\">#5383</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5384\" onclick=\"get_ticket_and_populate_wrapper('5384'); return false;\" title=\"Passthough NMI Platform string to rpmbuild\">#5384</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5400\" onclick=\"get_ticket_and_populate_wrapper('5400'); return false;\" title=\"Can't install HTCondor from RPM with glite components\">#5400</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-10 16:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a30eb5eacfeffbb1f1362ac33b76465175a16315\">[46241]</a></span>: (<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5383\" onclick=\"get_ticket_and_populate_wrapper('5383'); return false;\" title=\"The %cmake macro includes extra undesired CFLAGS for RPM builds\">#5383</a></span>) Properly specify the architecture  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-10 15:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8bb3ed4292ac782e50b223bf83b2992b65c9ccbd\">[46237]</a></span>: (<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5383\" onclick=\"get_ticket_and_populate_wrapper('5383'); return false;\" title=\"The %cmake macro includes extra undesired CFLAGS for RPM builds\">#5383</a></span>) Account for 32-bit architectures  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-10 14:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fafce528ec5b4d45a97aa44dc293b12db4e7e69\">[46236]</a></span>: (<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5383\" onclick=\"get_ticket_and_populate_wrapper('5383'); return false;\" title=\"The %cmake macro includes extra undesired CFLAGS for RPM builds\">#5383</a></span>) Add back defines from %cmake macro  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-10 11:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/56c4340f22bc998eaf3539bb60c0a690534067a0\">[46234]</a></span>: (<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5383\" onclick=\"get_ticket_and_populate_wrapper('5383'); return false;\" title=\"The %cmake macro includes extra undesired CFLAGS for RPM builds\">#5383</a></span>) Don't use %cmake macro for UW build  (By Tim Theisen )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Nov-16 17:52", "status": "defer", "created": "2015-Nov-10 11:50", "fixed_version": "2015-Nov-10 11:50", "broken_version": "v080400", "priority": "5", "subsystem": "Packaging", "assigned_to": "tim", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "tannenba@cs.wisc.edu tim@cs.wisc.edu tlmiller@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}