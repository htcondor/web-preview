{"id": 1548, "title": "Ticket #1548: make condor_ssh_to_job work with amazon universe", "description": "<blockquote>\nBrian and Derek say it would rank high in the \"awesome\" scale if condor_ssh_to_job worked for amazon jobs.  Currently, the user has to tell condor to write out the ssh key into a file and figure out the magic invocation of ssh to connect to the instance.\n\n<p>Update 2013-05-15: ssh-to-job should work for EC2 jobs.  If we felt like being clever, we could even check the instance's security group(s) for port 22.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Aug-02 09:55:57 by matt:</em> <br/>\n\nThis would be quite cool.\n\n<p>It should be easy enough to crib the public key. An error case to handle is when port 22 is not open on the EC2 instance's security group.\n</p><hr/>\n<em>2013-May-29 11:44:12 by tlmiller:</em> <br/>\n\nGot started on this, and will be working on it, during long test runs for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=3665\" onclick=\"get_ticket_and_populate_wrapper('3665'); return false;\" title=\"Port standard universe to Debian 7.\">#3665</a></span>.\n\n<p></p><hr/>\n<em>2013-Jul-01 17:42:17 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This code looks good.\n\n</p><p></p><hr/>\n<em>2013-Jul-16 14:48:17 by tannenba:</em> <br/>\n\nCommit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7a4db610d239f194ef63fb69bed4b2c80257175d\">[36710]</a></span> added for v080100 needs to be reverted, rewritten, re-reviewed.  There are several problems.\n\n<p></p><ol>\n<li>The commit caused all ssh_to_jobs to fail on a beta site (CHTC) that used <code>$$()</code> expansions in the job ads (via submit_exprs or whatever).  Here is a repro:\n<div class=\"code\">\n<pre class=\"code\">$ condor_submit -i -append 'Environment = foo=$$(foofoo)'\nSubmitting job(s).\n1 job(s) submitted to cluster 29005396.\nCan't get job status\n</pre></div>\n\nThe problem is the code does a read-only <code>ConnectQ()</code> to the schedd to read if the job is an EC2 job or not, but if the job contains <code>$$()</code> expansions, the schedd will try to expand them and also write the expanded results back into the job ad.  Because the connection is read-only and handled by a forked child of the schedd, the forked child fails with an exceptions before sending the job ad back to ssh_to_job.  When this happens, you end up with an error like the following in the schedd log:\n<div class=\"code\">\n<pre class=\"code\">07/15/13 17:20:18 (pid:19397) Got request #10018\n07/15/13 17:20:18 (pid:19397)   cluster_id = 28967246\n07/15/13 17:20:18 (pid:19397)   proc_id = 0\n07/15/13 17:20:18 (pid:7947) Number of Active Workers 1\n07/15/13 17:20:18 (pid:19397) ERROR \"Failed to store\n'MATCH_EXP_JOBGLIDEIN_ResourceName=\"wisc.edu\"' into job ad 28967246.0\" at line\n3665 in file /slots/01/dir_19286/userdir/src/condor_schedd.V6/qmgmt.cpp\n</pre></div>\n\nWe should make qmgmt dollar expansion code smarter to not try and write back the expanded results back into the job ad if the connection is read only, or perhaps use the condor_q util class just like <code>condor_q</code> itself. Another concern is what happens if the job has <code>$$()</code> and the schedd has not yet found a match?\n\n<p></p></li><li>The patch calls <code>GetJobAd()</code>, and yet does not handle the case where a NULL is returned.  A returned NULL could mean it failed to fetch the job ad due to an error, or it could mean the job has left the queue.  Neither case is handled, and instead the pointer returned from <code>GetJobAd()</code> is unconditionally deferenced which will likely cause a segfault.\n\n<p></p></li><li>Resources leaks.  For instance, the patch calls <code>ConnectQ()</code> and may end up returning before calling <code>DisconnectQ()</code>.\n</li></ol>\n\n<p></p><hr/>\n<em>2013-Aug-21 17:15:24 by tlmiller:</em> <br/>\n\nThe new patch (hopefully) corrects all of problems with resource leaks and unchecked return values.\n\n<p>It addresses the $$() expansion problem directly, by altering the schedd so that it doesn't attempt the expansion unless the connection was not read-only.  Since we don't currently record if the connection was read-only -- only if it was authorized, which when using host-based security is __not__ the same thing -- I co-opted the fully-qualified user name record for this purpose, which Zach was OK with.  I didn't want to add a bit to the socket object (which carries this state around) for this purpose, because it doesn't apply to anything except the schedd's queue management commands.\n\n</p><p>(As I understand it: rather than use different CEDAR-level commands with different privilege requirements, the queue management commands all share a single CEDAR-level command and privilege requirement, with further dispatch done in the command handler.  One way to resolve the problem would be to split GetJobAd() into two commands, one READ and one write, where only the latter could do $$ expansions (or, more accurately, force the schedd to record them).)\n\n</p><p></p><hr/>\n<em>2013-Oct-11 17:34:50 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>At first blush, I have several worries about this patch, incl the unintended consequences of co-opting the fully-qualified user name, and the deep-copying code changes.  Will review it more carefully asap, and edit this code review comment w/ specific feedback.  Maybe on closer inspection I will be OK with it :).\n\n</p><p></p><hr/>\n<em>2013-Nov-27 10:31:02 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> by zmiller.  Seems fine.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-24 09:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/053f091d9834e179a4a6eb29fddee44d76c55e89\">[37708]</a></span>: edit documentation of new EC2 grid universe suppport for condor_ssh_to_job and add forgotten version history item. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1548\" onclick=\"get_ticket_and_populate_wrapper('1548'); return false;\" title=\"make condor_ssh_to_job work with amazon universe\">#1548</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-26 14:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/50df6d4e094545d608e9e42c1a1930cbd6ef8f93\">[37354]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1548\" onclick=\"get_ticket_and_populate_wrapper('1548'); return false;\" title=\"make condor_ssh_to_job work with amazon universe\">#1548</a></span>) Fix gross copypasta error.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-21 14:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d7c784b2ecf18fb02782dd8c4afdc7b7fa0f8647\">[37318]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1548\" onclick=\"get_ticket_and_populate_wrapper('1548'); return false;\" title=\"make condor_ssh_to_job work with amazon universe\">#1548</a></span>) Rewrite patch for less failure.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-16 14:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/436c1effd57ae5d3ce6a4db01acadf43df138b9d\">[36920]</a></span>: Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1548\" onclick=\"get_ticket_and_populate_wrapper('1548'); return false;\" title=\"make condor_ssh_to_job work with amazon universe\">#1548</a></span>) Add support for EC2 jobs to condor_ssh_to_job.\" This reverts commit 7a4db610d239f194ef63fb69bed4b2c80257175d.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-28 11:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7a4db610d239f194ef63fb69bed4b2c80257175d\">[36710]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1548\" onclick=\"get_ticket_and_populate_wrapper('1548'); return false;\" title=\"make condor_ssh_to_job work with amazon universe\">#1548</a></span>) Add support for EC2 jobs to condor_ssh_to_job.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Nov-27 10:31", "status": "resolved", "created": "2010-Aug-02 09:53", "fixed_version": "2010-Aug-02 09:53", "broken_version": "v070400", "priority": "3", "subsystem": "Grid", "assigned_to": "zmiller", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "dan@hep.wisc.edu bbockelm@cse.unl.edu tstclair@redhat.com tannenba@cs.wisc.edu tlmiller@cs.wisc.edu", "due_date": ""}