{"id": 4016, "title": "Ticket #4016: Knob to control scratch-directory default permissions", "description": "<blockquote>\nBetween versions 7.8 and 8.0 the default permissions of the starter-created job scratch directory in a regular (non-privsep) setup changed from 0777 &amp; ~umask to 0700 &amp; ~umask.\n\n<p>Some jobs PHENIX cluster relied on there permissions being at least group-readable. The analysis-train software runs as a special user who invokes a custom setuid program to copy-as-user to NFS. This was done to allow quotas to be respected during the stage-out of each user's data (anatrain runs jobs on behalf of a user). The program checks the destination, becomes the user, then begins the copy -- which failed when they could no longer read the file because of the directory permissions.\n\n</p><p>This is easily fixed by the job chown'ing its own scratch dir, however it would be nice to be able to configure this as an admin. This small fix adds a new knob to do just that.\n\n</p><p>The fix doesn't take into account privsep, which creates directories with fixed permissions based on if glexec is in use.\n\n</p><p>See <a class=\"external\" href=\"https://docs.google.com/document/d/1ed5HskBnWOi8JsZTM_5AVsnTVXM7S0AHI_AYvNkX_vE/edit\">Design Document</a> (text version available <a class=\"external\" href=\"http://www4.rcf.bnl.gov/~willsk/execdir-permissions-design-doc.txt\">here</a>).</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2013-Nov-04 08:43:33 by bbockelm:</em> <br/>\n\nHi,\n\n<p>I'd like to see this ticket move forward (perhaps even in the stable series?).\n\n</p><p>One thing that's not handled consistently here - local universe jobs that run from spool which is created with a different umask than jobs run via vanilla universe.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2013-Nov-04 09:29:20 by gthain:</em> <br/>\n\nzmiller:  As our security person, can you take this?\n\n<p></p><hr/>\n<em>2013-Nov-05 14:21:30 by tannenba:</em> <br/>\n\nWill, does it help you if this patch goes into the developer series, or do you only run the stable series?  Normally I'd say this patch should go into the developer series, but I am willing to be flexible based on your input... thanks.\n\n<p></p><hr/>\n<em>2013-Nov-05 14:51:36 by willsk:</em> <br/>\n\nSince I build condor from source and can apply this patch for our build, it doesn't matter when / where it gets merged, so whatever is more appropriate to your process is fine.\n\n<p></p><hr/>\n<em>2013-Nov-08 15:34:57 by zmiller:</em> <br/>\n\n<strong>REVIEW:</strong> I read the design doc and reviewed the attached patch.  I like them and will commit this to the development branch for 8.1.3.\n\n<p></p><hr/>\n<em>2013-Nov-11 10:59:58 by tannenba:</em> <br/>\n\nZach, please move the design doc into the Google Drive folder (approved subfolder) with all the others for long term safe keeping.  Thanks.\n\n<p></p><hr/>\n<em>2013-Nov-11 11:09:23 by tannenba:</em> <br/>\n\nZach, what is your response/thoughts re the local universe question above?  Is this addressed in the design doc?  Whenever possible we want to avoid adding knobs, and if we do add knobs whenever possible we want them to work consistently across different job universes....  As you know, knobs that do X in one universe and Y in a different universe often catches people by surprise (not a good thing!).  Thanks.\n\n<p></p><hr/>\n<em>2013-Nov-11 11:25:35 by zmiller:</em> <br/>\n\nTodd: Agree about it being bad to have different behavior in different universes.  I was planning on investigating the code path for local universe and assuming no gotchas, creating a separate ticket to unify the behavior. (Can be linked from this ticket)\n\n<p></p><hr/>\n<em>2013-Nov-12 11:26:20 by zmiller:</em> <br/>\n\nWill:  Just revisiting this ticket.  I think the permissions are incorrect, and that you actually meant to put this:\n<ul>\n<li>owner == 0700\n</li><li>group == 0750\n</li><li>world == 0755\n</li></ul>\n\n<p>(instead of group WRITEABLE (0770) and world WRITEABLE (0777) which is what was in the patch you submitted.)\n\n</p><p></p><hr/>\n<em>2013-Nov-12 12:55:02 by willsk:</em> <br/>\n\nZach, these permissions are 077* because that's how they were done before (pre-8.0), and since the umask is usually 022 they should come out right.\n\n<p>If you want them explicitly set non-writable I can change the patch (since I really don't know if it is safe to always assume a umask of 022 in the daemons).\n\n</p><p></p><hr/>\n<em>2013-Nov-12 15:46:19 by zmiller:</em> <br/>\n\nI would prefer to see them explicitly set to 0750 and 0755.  I modified the patch you gave me, applied it, tested it, and it works great for both vanilla and local universe.  I'm committing it for 8.1.3.\n\n<p></p><hr/>\n<em>2013-Dec-18 11:25:04 by tannenba:</em> <br/>\n\nSwitched this ticket to docpending, as there is no version history entry in the commit.\n\n<p>Also, there <a class=\"external\" href=\"http://goo.gl/xL8pEk\">have been requests</a> to place this patch into the stable release stream.  Any reason not to do so?</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4208\" onclick=\"get_ticket_and_populate_wrapper('4208'); return false;\" title=\"Backport #4016: Knob to control scratch-directory default permissions\">#4208</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nBackport <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4016\" onclick=\"get_ticket_and_populate_wrapper('4016'); return false;\" title=\"Knob to control scratch-directory default permissions\">#4016</a></span>: Knob to control scratch-directory default permissions</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/807/0001-New-parameter-for-setting-user-execdir-permissions.patch\">0001-New-parameter-for-setting-user-execdir-permissions.patch</a>\n3574 bytes added by willsk on 2013-Oct-28 19:23:43 UTC.\n<br/>\nthe patch<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Mar-16 12:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/20e9ffc6240f14e5203a1b9ec791be1e84e30b88\">[39636]</a></span>: Backport <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4016\" onclick=\"get_ticket_and_populate_wrapper('4016'); return false;\" title=\"Knob to control scratch-directory default permissions\">#4016</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4208\" onclick=\"get_ticket_and_populate_wrapper('4208'); return false;\" title=\"Backport #4016: Knob to control scratch-directory default permissions\">#4208</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-19 10:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b4784903fb5ce14b0ad138f5974dc1d8314c428c\">[39053]</a></span>: add 8.1.3 version history item and edit new knob JOB_EXECDIR_PERMISSIONS definition <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4016\" onclick=\"get_ticket_and_populate_wrapper('4016'); return false;\" title=\"Knob to control scratch-directory default permissions\">#4016</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-12 15:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4c2999835c3b548f8c6f5f09fbc34dcbc6ca5d7d\">[38715]</a></span>: New parameter for setting user execdir permissions <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4016\" onclick=\"get_ticket_and_populate_wrapper('4016'); return false;\" title=\"Knob to control scratch-directory default permissions\">#4016</a></span> User can set JOB_EXECDIR_PERMISSIONS variable to one of: * user (default) * group * world that will make the job's scratch directory have permissions 0700, 0750, or 0755 respectively. \u00a0[...]\n (By William Strecker-Kellogg )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Dec-23 17:12", "status": "resolved", "created": "2013-Oct-28 14:21", "fixed_version": "2013-Oct-28 14:21", "broken_version": "v080000", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "zmiller", "derived_from": "", "creator": "willsk", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "willsk@bnl.gov, tannenba@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": ""}