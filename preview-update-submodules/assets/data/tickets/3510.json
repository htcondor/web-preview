{"id": 3510, "title": "Ticket #3510: synchronized CHILDALIVEs may get dropped by the master", "description": "<blockquote>\nAn incident in the CMS glidein system resulted in the master killing a bunch of collector processes that it incorrectly believed were hung.  No communication errors were logged in the collector or master logs.\n\n<p>Less than an hour before the problem, all daemons were reconfigured.  We believe this caused the CHILDALIVE timers to be closely synchronized, resulting in the master's UDP buffer overflowing and some messages getting dropped.\n\n</p><p>The workaround is to stop using UDP (e.g. use shared_port, which gets rid of UDP as a side-effect) or to make the master less busy by having the master use the procd.\n\n</p><p>One possible improvement to HTCondor would be to avoid synchronizing these timers during reconfig.  This could be achieved by using Reset_Timer_Period() rather than Reset_Timer().  It may also be wise to introduce some random skew when the timers are initially created.\n\n</p><p>Another question: Why do we use UDP at all for this message?</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Feb-22 15:47:58 by bbockelm:</em> <br/>\n\n+1 for introducing random jitter.  I'd even suggest that Condor may want to do that automatically for all clocks.\n\n<p>Isn't there a way to have these items go through a unix socket?\n\n</p><p>Is it possible for the Master to keep track of the number of missed child updates and make this queryable (if you directly contact the Master, like we do with the schedd)?\n\n</p><p></p><hr/>\n<em>2013-Feb-25 08:52:09 by tstclair:</em> <br/>\n\n+1 re no UDP\n\n<p></p><hr/>\n<em>2013-Mar-05 11:23:42 by danb:</em> <br/>\n\nMy thought that Reset_Timer_Period() was a good solution turned out to be too simple.  If we increase the time until the next call to the timer, then our parent may conclude that we are hung.  That is why the current code just blindly sets the timer to fire in 1 second after a reconfig --- to ensure that we inform our parent of the new heartbeat interval before the old one expires.\n\n<p>I have committed a fix for the common case in which the interval does not change during a reconfig.  I think that is good enough for the 7.8 series.\n\n</p><p></p><hr/>\n<em>2013-Mar-05 11:28:14 by johnkn:</em> <br/>\n\nThe patch for 7.8 series looks like it handles the common case and is safe.\n\n<p></p><hr/>\n<em>2013-Mar-05 14:53:53 by danb:</em> <br/>\n\nIn 7.9.5, I made a second patch that adds skew to the child alive timer.  I consider the issue resolved well enough until we see evidence to the contrary.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-21 11:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0186343016dae69e4f8741d0c61746d3bb433cb7\">[35228]</a></span>: Minor edit of 7.8.8 version history item. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3510\" onclick=\"get_ticket_and_populate_wrapper('3510'); return false;\" title=\"synchronized CHILDALIVEs may get dropped by the master\">#3510</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-05 14:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2050929303c1a197b87df2b0f7a968212a0d09e6\">[35070]</a></span>: Document addition of skew to NOT_RESPONDING_TIMEOUT. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3510\" onclick=\"get_ticket_and_populate_wrapper('3510'); return false;\" title=\"synchronized CHILDALIVEs may get dropped by the master\">#3510</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-05 14:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5bee099587e5d2cbef60a003cb32a10058699343\">[35069]</a></span>: Add skew to the child alive timer to reduce chances of synchronization. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3510\" onclick=\"get_ticket_and_populate_wrapper('3510'); return false;\" title=\"synchronized CHILDALIVEs may get dropped by the master\">#3510</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-05 11:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1eb0dd164b84bf1ac8a5ddfca537a5b471388c93\">[35065]</a></span>: Avoid synchronizing child alive timers at reconfig time in common case where timer period did not change. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3510\" onclick=\"get_ticket_and_populate_wrapper('3510'); return false;\" title=\"synchronized CHILDALIVEs may get dropped by the master\">#3510</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Mar-05 14:53", "status": "resolved", "created": "2013-Feb-22 14:34", "fixed_version": "2013-Feb-22 14:34", "broken_version": "v070800", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,tstclair@redhat.com", "due_date": ""}