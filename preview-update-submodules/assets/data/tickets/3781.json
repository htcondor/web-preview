{"id": 3781, "title": "Ticket #3781: VM Universe and KVM totally broken.", "description": "<blockquote>\nThe starter now creates all execute directories ('.../dir_&lt;pid&gt;') with 700 permissions for security reasons.  This makes KVM really unhappy -- it will claim there are permission errors on successfully transferred VM disk images, because it checks traversal without realizing that it'll be running as root and not care.  The error comes when invoking qemu-kvm from the vm-gahp:\n\n<p></p><pre>  qemu-kvm: -drive file=/var/lib/condor/execute/dir_40034/condor_test.qcow2,if=none,id=drive-virtio-disk0,format=qcow2:\n  could not open disk image /var/lib/condor/execute/dir_40034/condor_test.qcow2: Permission denied\n</pre>\n\n<p>The execute directory permission are set (ZKM says) at baseStarter.cpp:1803.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jul-16 08:48:33 by tstclair:</em> <br/>\n\nSo I think we should probably denote exactly where the error is happening.  e.g. \"This makes KVM really unhappy\" is a confusing statement.  If the error inside of the GAHP? is it in some libvirt call?\n\n<p></p><hr/>\n<em>2013-Jul-16 10:30:10 by tlmiller:</em> <br/>\n\nHopefully that answers your question.\n\n<p></p><hr/>\n<em>2013-Jul-23 08:52:30 by tstclair:</em> <br/>\n\nDo we know where this was introduced?  I'm guessing 7.9.?\n\n<p></p><hr/>\n<em>2013-Jul-23 10:45:52 by jfrey:</em> <br/>\n\nThe problem was caused by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3315\" onclick=\"get_ticket_and_populate_wrapper('3315'); return false;\" title=\"tighten the permissions on execute directories\">#3315</a></span>, which changed the permissions of the execute directory from 0755 to 0700. That happened in version 7.9.2.\n\n<p></p><hr/>\n<em>2013-Jul-24 14:28:52 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>This looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-14 10:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0475b94e88249642a120d8ac9c35342a0ff20d14\">[37207]</a></span>: minor 8.0.2 version history item edit ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3781\" onclick=\"get_ticket_and_populate_wrapper('3781'); return false;\" title=\"VM Universe and KVM totally broken.\">#3781</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-30 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dd89482f23193b41906fe8107a129515f7893844\">[37046]</a></span>: Version history for kvm/xen file permission bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3781\" onclick=\"get_ticket_and_populate_wrapper('3781'); return false;\" title=\"VM Universe and KVM totally broken.\">#3781</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-22 17:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2b2f1b8cda89901b2e4e185ab16ffea6ebac8bf7\">[36969]</a></span>: Fix directory permissions for Xen/KVM VM universe jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3781\" onclick=\"get_ticket_and_populate_wrapper('3781'); return false;\" title=\"VM Universe and KVM totally broken.\">#3781</a></span> The vm-gahp issues libvirt commands as root. Libvirt fails if root doesn't have explicit permission to access the disk image files. Therefore, we need to relax the normal execute directory permissions from 700 to 755.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jul-30 14:26", "status": "resolved", "created": "2013-Jul-15 14:35", "fixed_version": "2013-Jul-15 14:35", "broken_version": "v070902", "priority": "4", "subsystem": "VM", "assigned_to": "jfrey", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}