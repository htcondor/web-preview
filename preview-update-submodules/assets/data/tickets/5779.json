{"id": 5779, "title": "Ticket #5779: the MapFile class needs to handle literal keys", "description": "<blockquote>\nin support of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5751\" onclick=\"get_ticket_and_populate_wrapper('5751'); return false;\" title=\"add a userMap function to condor ClassAds\">#5751</a></span>, if the usermap has hundreds or thousands of entries in the mapfile, the current <span class=\"quote\">MapFile</span> class is fairly slow to do lookups in that case.\nThen the mapfile has keys that are essentially literals (i.e. not making using the regex substitution), we can do much better by implementing that as a hash lookup.\n\n<p>So the <span class=\"quote\">MapFile</span> class needs to be able to read input files and treat the second value each row of the file as either a regex or a simple literal key.  It would store regex entries in the same way as before, but consecutive simple literal entries of the same method will be coalesced into a single hashtable.\n\n</p><p>The <span class=\"quote\">MapFile</span> class will take a flag to the function that parses a file that tells it whether this new method of parsing is available.  If it is, and the second value in a row begins and ends with / (i.e. like a perl regex) then it will be treated as a regex entry. otherwise it will be treated as a simple literal entry.\n\n</p><p>Regex entries can have one or more letters following the closing / to indicate regex options. The options are\n\n</p><p></p><ul>\n<li>i case insensitive\n</li><li>U ungreedy\n</li></ul>\n\n<p>Awk style substitutions will be made on the value of the third field when it is returned.  \\0 will be substituted for the entire match, \\1 for the first regex capture group, etc.\n\n</p><p>When the second field is not a regex, only \\0 will be substituted.\n\n</p><p>so for example\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">mapfile fragment</pre>\n<pre class=\"snip\">*   Bob   security,csuser.\\0\n*   Alice security,math\n*   /^todd.*/i htcondor,chtc,csuser.\\0\n*   /(*.).cs/ csuser.\\1\n*   /*./  guest\n</pre></div>\n\n\n<p>If the above map file is used, the following lookups would occur.\n\n</p><p><table border=\"1\" cellspacing=\"0\">\n<tbody><tr>\n<td>\nInput</td>\n<td>\nMap result</td>\n</tr>\n\n<tr>\n<td>\n<hr/>\n</td>\n<td>\n<hr/>\n</td>\n</tr>\n\n<tr>\n<td>\nBob</td>\n<td>\nsecurity,csuser.Bob</td>\n</tr>\n\n<tr>\n<td>\njohn</td>\n<td>\nguest</td>\n</tr>\n\n<tr>\n<td>\nToddL</td>\n<td>\nhtcondor,chtc,csuser.ToddL</td>\n</tr>\n\n<tr>\n<td>\nalice.cs.wisc.edu</td>\n<td>\ncsuser.alice</td>\n</tr>\n</tbody></table></p></blockquote>", "remarks": "<blockquote>\n<em>2016-Sep-08 11:10:14 by johnkn:</em> <br/>\n\nNote, as of this writing, only mapfiles used by the userMap classad function will be parsed in this way, the security mapfiles will still assume that the second field is always a regex, even if there are no enclosing / characters.\n\n<p></p><hr/>\n<em>2016-Sep-27 13:38:25 by tim:</em> <br/>\n\nThis change is not user visible. Documentation will come when future work utilizes this ability.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-08 10:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b47a9898323762549138853436c05f747a1b658a\">[48753]</a></span>: add usage for test_user_mapping, part of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5779\" onclick=\"get_ticket_and_populate_wrapper('5779'); return false;\" title=\"the MapFile class needs to handle literal keys\">#5779</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-07 18:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/069de0a749cd849114e4b67c2988581b686420ac\">[48751]</a></span>: add support for hash lookups to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MapFile\" title=\"Map File\">MapFile</a></span> class, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5779\" onclick=\"get_ticket_and_populate_wrapper('5779'); return false;\" title=\"the MapFile class needs to handle literal keys\">#5779</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Sep-27 13:38", "status": "resolved", "created": "2016-Jul-07 17:30", "fixed_version": "2016-Jul-07 17:30", "broken_version": "", "priority": "4", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "#5751", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}