{"id": 4228, "title": "Ticket #4228: work_fetch_static_slot(pslot) broken", "description": "<blockquote>\nwork fetch almost works on windows. With the starter hook \"TEST_FETCH_HOOK_PREPARE_JOB = xxxxxx/prepare.pl\" turn off it works 2/3 of the time or so. With that hook enabled it mostly fails. Given the following local config settings:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">\tDAEMON_LIST = MASTER,STARTD\n\tNEGOTIATOR_INTERVAL = 5\n\tNUM_CPUS = 2\n\tSLOT1_JOB_HOOK_KEYWORD = TEST_FETCH\n\tSTARTD_JOB_HOOK_KEYWORD = TEST_FETCH\n\tSTARTER_JOB_HOOK_KEYWORD = TEST_FETCH\n\tFetchWorkDelay = 10\n\n# Done appending from 'append_condor_config'\n# Appending from 'append_condor_config_plus'\n# Startd hooks\nTEST_FETCH_HOOK_FETCH_WORK = C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\batch_job_fetch.bat\nTEST_FETCH_HOOK_REPLY_FETCH = C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\batch_reply.bat\nTEST_FETCH_HOOK_EVICT_CLAIM = C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\batch_job_evict.bat\n# Starter hooks\nTEST_FETCH_HOOK_UPDATE_JOB_INFO = C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\batch_update_job_info.bat\nTEST_FETCH_HOOK_JOB_EXIT = C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\batch_job_exit.bat\n</pre></div>\n\n\n<p>where the batch files are needed for windows and simply call the perl scripts:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">perl C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\fetch_job.pl %1\nperl C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\job_evict.pl\nperl C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\job_exit.pl\nperl C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\job_fetch.pl\nperl C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\reply.pl\nperl C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\update_job_info.pl\n</pre></div>\n\n\n<p>Obviously one has to take the fetch work scripts and place them somewhere from\ncondor_tests/x_fetchwork_scripts.tar.gz. and the config file points at them and the batch files point at them. Also note the perl scripts have templates then configured for location of inpu and output locations. All these path are correctly set up by the test. One of these starts the ball rolling in job_fetch.pl which starts the work when a classad correctly set up is droped in the work_dir.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">my $work_dir = \"/cygdrive/c/condor_tests/fetch_work_static_slot.saveme/43568/work\";\nmy $out_dir = \"/cygdrive/c/condor_tests/fetch_work_static_slot.saveme/43568/results\";\nmy @jobs;\n\nif ( ! -d $work_dir )\n{\n  print STDERR \"No more work\\n\";\n  exit;\n}\n\n# Get the list of jobs\n@jobs = `ls $work_dir`;\n...\n</pre></div>\n\n\n<p>The classad generated by the test looks like:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">Cmd = \"C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\workfetch_scripts\\batch_fetch_job.bat\"\nIwd = \".\"\nOut = \"C:\\condor_tests\\fetch_work_static_slot.saveme\\43568\\results\\fetch1\"\nArgs = \"fetch_work_static_slot-1\"\nOwner = \"bt\"\nUser = \"bt@cs.wisc.edu\"\nJobUniverse = 5\nJobLeaseDuration = 500000\nIsFetched = TRUE\n</pre></div>\n\n\n<p>In the failure mode I am seeing with the prepare hook not enabled, you can see the job_fetch fire a bunch and even an accept reply. Yet the fetch_job work is never started. In the result location all one sees is the original classad and the reply where you can see it saw the classad.\n\n</p><p>There are three reference runs of which 31568 and 36956 worked but 43568 failed sitting in ~bt/public/fetch_work_static_slot.saveme which show how it should work and a failure case.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2015-Feb-04 10:13", "status": "new", "created": "2014-Feb-25 10:45", "fixed_version": "2014-Feb-25 10:45", "broken_version": "v080104", "priority": "2", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "bt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bt@cs.wisc.edu", "due_date": ""}