{"id": 7260, "title": "Ticket #7260: LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job", "description": "<blockquote>\nLIGO (and the rest of the world) would really like condor_ssh_to_job to work with glided-in startds.  There are several reasons these don't work today.\n\n<p>This ticket addresses one reason.\n\n</p><p>When the condor_startds spawns sshd, sshd runs as the non-root user of the job.  At sshd startup, it looks at /etc/passwd to determine the shell and login name of the user.  If this doesn't exist, or the shell isn't in /etc/shells, sshd will exit, and condor_ssh_to_job will unceremoniously hang up.\n\n</p><p>To fix this, we will LD_PRELOAD a fake getpwnam library call into sshd that returns a valid shell.\n\n</p><p>If this terrifies and administrator, a knob\n\n</p><p>CONDOR_SSH_TO_JOB_FAKE_PASSWD_ENTRY = false\n\n</p><p>will turn off the behavior.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Sep-16 13:05:39 by bbockelm:</em> <br/>\n\nThis has a ring of \"break security policy first, ask forgiveness later\" -- which makes me fairly nervous.\n\n<p>I assume we want to have this turned off by default and make LIGO explicitly enable this, right?  That way, they are explicitly accepting the risk of violating site security policy...\n\n</p><p></p><hr/>\n<em>2019-Sep-17 07:54:46 by bbockelm:</em> <br/>\n\nIn terms of code review:\n\n<p></p><ul>\n<li>Old-style C dec'l (<code>static dirbuf[512];</code>) causes the dirbuf to\n</li><li>The call to <code>getcwd</code> could fail and there is no error checking for <code>getpwd</code>.  This includes buffer sizing issues -- this will fail if the pathname is 512 characters or longer.\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Sep-17 10:26:55 by bbockelm:</em> <br/>\n\nChatting with Greg on Slack, the current version might run afoul of=seccomp= filtering in some versions of OpenSSH:\n\n<p><a class=\"external\" href=\"https://github.com/openssh/openssh-portable/blob/master/sandbox-seccomp-filter.c\">https://github.com/openssh/openssh-portable/blob/master/sandbox-seccomp-filter.c</a>\n\n</p><p>It appears that the <code>getcwd</code> syscall is not included in the list of permitted syscalls in that particular filter.  Not sure if that is the filter in use by OpenSSH when <code>getpwnam</code> is called, however.  Probably a good idea to avoid it though!\n\n</p><p>Could HTCondor put this information into an env var and allow us to avoid the syscall?</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7408\" onclick=\"get_ticket_and_populate_wrapper('7408'); return false;\" title=\"Place fake getpwnam library in proper place on EL systems\">#7408</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nPlace fake getpwnam library in proper place on EL systems</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-04 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3315f38216b9d4d19a361870fa496fbd9f8ff339\">[58035]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7260\" onclick=\"get_ticket_and_populate_wrapper('7260'); return false;\" title=\"LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job\">#7260</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-01 18:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3485e22e984bf78125e81229fd3f4c0013a4fcbf\">[58000]</a></span>: Fix getpwnam to work in batlab <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7260\" onclick=\"get_ticket_and_populate_wrapper('7260'); return false;\" title=\"LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job\">#7260</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-19 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/13ef08bca3871119931951ee1c1637e97d5f1455\">[57871]</a></span>: Reimplement getpwnam in c++ to avoid compiler warnings <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7260\" onclick=\"get_ticket_and_populate_wrapper('7260'); return false;\" title=\"LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job\">#7260</a></span> Also turn off by default for now  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-14 11:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b87738e15aca7fb69b770d178224c16ef5580c51\">[57839]</a></span>: Add getpwn to rpm packaging <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7260\" onclick=\"get_ticket_and_populate_wrapper('7260'); return false;\" title=\"LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job\">#7260</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-13 14:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/65dc4a669ab38e99410ee1d0be3fec6966b51436\">[57834]</a></span>: Add missing ifdef linux to CMakeLists.txt for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7260\" onclick=\"get_ticket_and_populate_wrapper('7260'); return false;\" title=\"LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job\">#7260</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-13 13:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e7b79c28b1c268c571868ff5a977d5f29a9d0689\">[57832]</a></span>: LD_PRELOAD into sshd fake getpwnam for condor_ssh_to_job <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7260\" onclick=\"get_ticket_and_populate_wrapper('7260'); return false;\" title=\"LD_PRELOAD a fake getpwnam into sshd for condor_ssh_to_job\">#7260</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Oct-04 10:19", "status": "resolved", "created": "2019-Sep-13 13:28", "fixed_version": "2019-Sep-13 13:28", "broken_version": "v080900", "priority": "3", "subsystem": "", "assigned_to": "gthain", "derived_from": "#7232", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "", "due_date": ""}