{"id": 6413, "title": "Ticket #6413: Make HAD replication work with shared port and IPv6", "description": "<blockquote>\nIn HAD, replication of the accounting data is done by one side binding and listening on a new, dynamic IPv4 port, and the other side connecting to it. This breaks with IPv6 and when shared port is needed to navigate through a fire wall. The code should be updated to work in these situations.\n\n<p>When HAD wants to replicate data, the transfer is initiated by the receiving replication daemon. It spawns a transferer process in download mode and gives it the sinful string of the remote replication daemon. The transferer binds and listens on a dynamic IPv4 port, initiates a REPLICATION_TRANSFER_FILE command with the remote (sending) replication daemon, and sends the address of the newly-bound socket as a sinful string. The sending replication daemon spawns its own transferer process in upload mode and gives it the sinful string it just received. The upload transferer connects to the given address and sends the data.\n\n</p><p>I propose we change this setup to work like claim activation when starting a vanilla job. When the download transferer connects to the sending replication daemon, the replication daemon would hand the connection to the upload transferer that it spwans. The two transferers would then talk to each other as before.\n\n</p><p>For backwards compatibility, we would introduce a new command for the new communication pattern. If the replication daemon detects that its peer is too old (or doesn't know its peer's version), it would use the old command.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Nov-01 10:58:03 by jfrey:</em> <br/>\n\nOther than a version history entry, no documentation is required.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-28 23:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/483b47d6a4fde513cb2c0dea51ce1bd8bbe5e0e4\">[52706]</a></span>: Add version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6405\" onclick=\"get_ticket_and_populate_wrapper('6405'); return false;\" title=\"Report grid-type boinc jobs that are IN_PROGRESS as running\">#6405</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6133\" onclick=\"get_ticket_and_populate_wrapper('6133'); return false;\" title=\"Improve syntax of remote_cerequirements\">#6133</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6413\" onclick=\"get_ticket_and_populate_wrapper('6413'); return false;\" title=\"Make HAD replication work with shared port and IPv6\">#6413</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-21 08:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bfe716341ae638a5d41cd2643813788a84fcf39c\">[52396]</a></span>: Minor fixups of HAD code. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6413\" onclick=\"get_ticket_and_populate_wrapper('6413'); return false;\" title=\"Make HAD replication work with shared port and IPv6\">#6413</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-20 20:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d57601cc93fee6532517245976a9beefa92478a2\">[52395]</a></span>: Remove redundant HAD function utilToString(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6413\" onclick=\"get_ticket_and_populate_wrapper('6413'); return false;\" title=\"Make HAD replication work with shared port and IPv6\">#6413</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-20 20:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0f4d47d85ff7e8d50f00d7e39050f7247da1cd0e\">[52394]</a></span>: Fix string manipulation in HAD daemons. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6413\" onclick=\"get_ticket_and_populate_wrapper('6413'); return false;\" title=\"Make HAD replication work with shared port and IPv6\">#6413</a></span> Remove a bunch of odd string handling code.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-20 16:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/69bcd037ef775e636ed3e756fba863f20cf2e995\">[52391]</a></span>: Make HAD replication work with shared port and IPv6. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6413\" onclick=\"get_ticket_and_populate_wrapper('6413'); return false;\" title=\"Make HAD replication work with shared port and IPv6\">#6413</a></span> Add new file replication command where the files are sent over the same connection. With the old command, the downloader bound a random port on IPv4 and sent its address along with the command. The uploader then connected to that dynamic port\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Nov-01 10:58", "status": "resolved", "created": "2017-Sep-19 14:41", "fixed_version": "2017-Sep-19 14:41", "broken_version": "", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "jfrey", "derived_from": "#6412", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}