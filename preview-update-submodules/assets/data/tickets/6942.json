{"id": 6942, "title": "Ticket #6942: Missing CREDMON_COMPLETE blocks schedd when using OAuth tokens mode", "description": "<blockquote>\nIf using OAuth tokens mode (<code>CREDD_OAUTH_MODE</code> at the moment), the Schedd expects to see the file <code>CREDMON_COMPLETE</code> in the <code>SEC_CREDENTIAL_DIRECTORY</code>, and until this file shows up, the Schedd is blocked and squawks the following log message:\n\n<p></p><div class=\"verbatim\">\n<pre>03/05/19 15:04:45 (pid:1249834) CREDMON: FAILURE: credmon never created /var/lib/condor/credentials/CREDMON_COMPLETE after 20 seconds!\n03/05/19 15:04:45 (pid:1249834) SCHEDD: User credentials not up-to-date.  Start-up delayed.  Waiting 10 seconds and trying 52 more times.\n</pre></div>\n\n\n<p>The Schedd even ignores SIGTERM and SIGQUIT when this happens, for example:\n\n</p><p></p><div class=\"verbatim\">\n<pre>03/05/19 15:04:02 Sent SIGQUIT to SCHEDD (pid 1249834)\n03/05/19 15:09:02 Timeout for fast shutdown has expired for SCHEDD.\n03/05/19 15:09:02 Sent SIGKILL to SCHEDD (pid 1249834) and all its children.\n03/05/19 15:09:02 AllReaper unexpectedly called on pid 1249834, status 9.\n03/05/19 15:09:02 The SCHEDD (pid 1249834) died due to signal 9 (Killed)\n</pre></div>\n\n\n<p>To reproduce: Set <code>CREDD_OAUTH_MODE = True</code>, make sure <code>$(condor_config_val SEC_CREDENTIAL_DIRECTORY)/CREDMON_COMPLETE</code> does not exist, and make sure that no credmons are running that could re-create said <code>CREDMON_COMPLETE</code> file. Then try <code>condor_q</code>, <code>condor_off</code>, <code>condor_restart</code>, or anything that requires the Schedd to do something in response.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Mar-06 11:35:28 by jpatton:</em> <br/>\n\nA quick resolution option might be: The schedd guarantees that the credmon is running (either checking that <code>SEC_CREDENTIAL_MONITOR</code> is in <code>DAEMON_LIST</code> or ticket <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=6892\" onclick=\"get_ticket_and_populate_wrapper('6892'); return false;\" title=\"credmon(s) should run under the credd\">#6892</a></span> is resolved so that the credd first guarantees that it is running before running the schedd). While in this blocking state, the schedd should still receive signals from the master so that <code>condor_off</code> and such still allow the schedd process to exit even if it hasn't \"started\".\n\n<p></p><hr/>\n<em>2019-May-08 12:13:35 by zmiller:</em> <br/>\n\nThis ticket was assigned to TJ and he says it probably should have been me, so I took this ticket.\n<hr/>\n<em>2020-Apr-10 07:42:27 by tim:</em> <br/>\n\nBulk change of target version from v080808 to v080809 using ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2020-Oct-12 10:02", "status": "new", "created": "2019-Mar-05 16:35", "fixed_version": "2019-Mar-05 16:35", "broken_version": "v080800", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "zmiller", "derived_from": "#6513", "creator": "jpatton", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "jpatton@cs.wisc.edu,tannenba@cs.wisc.edu,bbockelman@morgridge.org,zmiller@cs.wisc.edu", "due_date": ""}