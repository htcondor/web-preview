{"id": 7368, "title": "Ticket #7368: DAGMan should have option to evict jobs on MaxJobs changes", "description": "<blockquote>\nIn <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7236\" onclick=\"get_ticket_and_populate_wrapper('7236'); return false;\" title=\"Allow  maxjobs per workflow to be changed for running workflows\">#7236</a></span> we added the ability to edit properties of an in-progress DAGMan job, including the maximum number of running jobs (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobs\" title=\"Max Jobs\">MaxJobs</a></span>).\n\n<p>In the current implementation, when a <strong>condor_dagman</strong> job gets edited so the new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobs\" title=\"Max Jobs\">MaxJobs</a></span> is lower than the number of currently running jobs, nothing gets evicted. We just won't submit any more jobs until the number of running jobs falls below the new maximum.\n\n</p><p>Now we want the option for <strong>condor_dagman</strong> to evict jobs whenever we drop <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobs\" title=\"Max Jobs\">MaxJobs</a></span> lower than the currently running number. A few details about this implementation:\n\n</p><p></p><ul>\n<li>Jobs should get evicted in LIFO order (most recently started jobs get killed first).\n</li><li>We'll need a new job attribute to determine whether jobs get evicted on changes. We'll call this <strong>DAGMan_EvictionPolicy</strong> or something similar.\n</li><li>By default, jobs will not get evicted on changes.\n</li></ul>\n\n<p>In addition, we realized the code that checks the job ad for attribute changes does not actually trigger as often as we thought. So a second piece of work is to isolate this code such that we have more control over how often it gets called. This is mostly just a minor refactor so I'm bundling it into this ticket instead of creating a new one.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Jan-08 11:54:18 by coatsworth:</em> <br/>\n\nHi all, I've completed the code to evict user jobs after reducing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobs\" title=\"Max Jobs\">MaxJobs</a></span>. It's pretty simple and straightforward. However there are still two important questions:\n\n<p></p><ol>\n<li>Should this behavior be mandatory, or optional?\n</li><li>If this is optional, how does an administrator opt in?\n</li></ol>\n\n<p>In regards to # 1, although it's much easier to just make this mandatory, I get the feeling that we'll need to make it optional. Any thoughts here?\n\n</p><p>As for how an administrator opts in, there are two ways we could go about it. One is via a configuration knob. The other is by adding a new attribute in the job add that dictates what policy to use after modifying <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobs\" title=\"Max Jobs\">MaxJobs</a></span>. I'd much prefer to use a configuration knob, it's more elegant and clean, but that means the chosen behavior will be the same for all DAGs running on a submit machine. You would not be able to choose the desired behavior on a per-DAG basis. Is that okay?\n\n</p><p></p><hr/>\n<em>2020-Jan-08 22:24:13 by pfc:</em> <br/>\n\nI think a config knob is fine (best in fact).  And it's not hard to adjust on a per-DAG basis via <div class=\"verbatim\">\n<pre>_CONDOR_</pre></div>\n env vars in the DAGMan submit file, which our DAGMan power-users are already comfortable doing...\n\n<p></p><hr/>\n<em>2020-Jan-09 11:00:31 by coatsworth:</em> <br/>\n\nI'm glad you prefer the knob approach, that's what I was hoping to use also. And you're correct that users can opt-in to this behavior by setting <em>CONDOR</em> variables (or using a DAGMan CONFIG file). However, it's worth noting that they have to opt in at the time when they submit their DAGMan job. Once condor_dagman has started running, we can't go back and change this option. Is that okay?\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-Apr-12 14:53:15 by anderson:</em> <br/>\n\nI also am in favor of the configuration knob approach, and have a slight preference for the default to be to automatically honor the specified limit, but allow an admin to opt-out of active enforcement and instead merely stop submitting new jobs until the number of running jobs eventually drops down to the limit.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-22 10:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fe7e963166bcad7610cf82166fa124687e96dceb\">[58871]</a></span>: Added documentation, version history, minor code renaming for clarity (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7368\" onclick=\"get_ticket_and_populate_wrapper('7368'); return false;\" title=\"DAGMan should have option to evict jobs on MaxJobs changes\">#7368</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-15 16:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/093d778ae19368ae005f619758798b10379c594e\">[58862]</a></span>: DAGMan now optionally evicts excess jobs after changing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxJobs\" title=\"Max Jobs\">MaxJobs</a></span> (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7368\" onclick=\"get_ticket_and_populate_wrapper('7368'); return false;\" title=\"DAGMan should have option to evict jobs on MaxJobs changes\">#7368</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-03 11:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e2d45e51ddcbf4c1c81a0b90d4b4b478355698da\">[58804]</a></span>: Refactored DAGMan job ad updates (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7368\" onclick=\"get_ticket_and_populate_wrapper('7368'); return false;\" title=\"DAGMan should have option to evict jobs on MaxJobs changes\">#7368</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Apr-12 14:53", "status": "resolved", "created": "2019-Nov-12 15:51", "fixed_version": "2019-Nov-12 15:51", "broken_version": "v080905", "priority": "3", "subsystem": "Dag", "assigned_to": "coatsworth", "derived_from": "#7236", "creator": "coatsworth", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, gthain@cs.wisc.edu, pcouvare@caltech.edu, anderson@ligo.caltech.edu, tannenba@cs.wisc.edu, bbockelman@morgridge.org", "due_date": ""}