{"id": 5857, "title": "Ticket #5857: condor_q -global does not support IP-based security", "description": "<blockquote>\nA query for all jobs in the queue works fine:\n<div class=\"verbatim\">\n<pre>[pcdev3:~] condor_q -allusers -global\n\n\n-- Schedd: pcdev1.nemo.uwm.edu : &lt;172.20.1.35:9618?...\nOWNER   BATCH_NAME         SUBMITTED   DONE   RUN    IDLE  TOTAL JOB_IDS\njmeidam multidag.dag+16   8/19 15:22      5      4      _     12 37.0 ... 40.0\njmeidam multidag.dag+21   8/19 15:22      5      4      _     12 41.0 ... 44.0\njmeidam multidag.dag+25   8/19 15:23      5      4      _     12 45.0 ... 48.0\njmeidam multidag.dag+49   8/19 15:25      2      4      _      9 53.0 ... 56.0\n\n24 jobs; 0 completed, 0 removed, 0 idle, 24 running, 0 held, 0 suspended\n\n\n-- Schedd: pcdev2.nemo.uwm.edu : &lt;172.20.1.34:9618?...\nOWNER       BATCH_NAME                                         SUBMITTED   DONE   RUN    IDLE  TOTAL JOB_IDS\njacob.lange marginalize_extrinsic_parameters_grid.dag+25682   8/19 17:03     28   1937      6   1040 25683.0 ... 26685.1\n\n1944 jobs; 0 completed, 0 removed, 6 idle, 1938 running, 0 held, 0 suspended\n</pre></div>\n\n\n<p>Whereas a query for only one's one jobs, does not. It seems to me that both should succeed or fail in unison. It appears to be noticing the certificate I have for gsisshd which has three subject alternative names: the DNS entries for publicly-routable IP addresses. But, of course, I steer condor toward my private network with a different DNS name.\n\n</p><p></p><div class=\"verbatim\">\n<pre>[pcdev3:~] condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.35:9618?addrs=172.20.1.35-9618&amp;noUDP&amp;sock=2549_3c9e_3&gt; : pcdev1.nemo.uwm.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:We are trying to connect to a daemon with certificate DN (/DC=org/DC=incommon/C=US/postalCode=53211/ST=Wisconsin/L=Milwaukee/street=1900 E. Kenwood Blvd/O=University of Wisconsin-Milwaukee/OU=Physics/CN=pcdev1.ligo.uwm.edu), but the host name in the certificate does not match any DNS name associated with the host to which we are connecting (host name is 'pcdev1.nemo.uwm.edu', IP is '172.20.1.35', Condor connection address is '&lt;172.20.1.35:9618?addrs=172.20.1.35-9618&amp;noUDP&amp;sock=2549_3c9e_3&gt;').  Check that DNS is correctly configured.  If the certificate is for a DNS alias, configure HOST_ALIAS in the daemon's configuration.  If you wish to use a daemon certificate that does not match the daemon's host name, make GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or disable all host name checks by setting GSI_SKIP_HOST_CHECK=true or by defining GSI_DAEMON_NAME.\n\nAUTHENTICATE:1004:Failed to authenticate using KERBEROS\nAUTHENTICATE:1004:Failed to authenticate using FS\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=26827_fbb2_3&gt; : pcdev2.nemo.uwm.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:We are trying to connect to a daemon with certificate DN (/DC=org/DC=incommon/C=US/postalCode=53211/ST=Wisconsin/L=Milwaukee/street=1900 E. Kenwood Blvd/O=University of Wisconsin-Milwaukee/OU=Physics/CN=pcdev2.ligo.uwm.edu), but the host name in the certificate does not match any DNS name associated with the host to which we are connecting (host name is 'pcdev2.nemo.uwm.edu', IP is '172.20.1.34', Condor connection address is '&lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=26827_fbb2_3&gt;').  Check that DNS is correctly configured.  If the certificate is for a DNS alias, configure HOST_ALIAS in the daemon's configuration.  If you wish to use a daemon certificate that does not match the daemon's host name, make GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or disable all host name checks by setting GSI_SKIP_HOST_CHECK=true or by defining GSI_DAEMON_NAME.\n\nAUTHENTICATE:1004:Failed to authenticate using KERBEROS\nAUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2017-Feb-01 12:56:07 by zmiller:</em> <br/>\n\nAs recently discussed on htcondor-users, the problem here is that condor_q recently switched from using the command QUERY_JOB_ADS to using QUERY_JOB_ADS_WITH_AUTH in order to show the jobs only for the user doing the query.\n\n<p>Of course, if you require AUTH, then there must be some authentication method configured that works across machines which isn't always the case since many sites just submit locally and use FS authentication.\n\n</p><p>The fix is to add to your condor_config:\n</p><div class=\"code\">\n<pre class=\"code\">CONDOR_Q_ONLY_MY_JOBS = False</pre></div>\n\nor to use the -allusers flag to condor_q.\n\n<p></p><hr/>\n<em>2017-Feb-01 13:47:10 by tpdownes:</em> <br/>\n\nCONDOR_Q_ONLY_MY_JOBS is not a feature I wish to disable and I disagree with the characterization that it is a fix.\n\n<p>The thread \"Problems with submit node in version 8.6.0\" mentions the following knobs\n</p><div class=\"verbatim\">\n<pre>SEC_DEFAULT_AUTHENTICATION\nSEC_DEFAULT_NEGOTIATION\n</pre></div>\n\n\n<p>I cannot find the default values for these knobs in the manual and the thread is unclear whether \"OPTIONAL\" or \"NEVER\" is the appropriate workaround.\n\n</p><p></p><hr/>\n<em>2017-Feb-01 13:54:43 by tpdownes:</em> <br/>\n\nIf I have to update my host certificate to include the DNS entry for the private network, I can do that easily enough. It's just never been a part of my condor communication until now.\n\n<p></p><hr/>\n<em>2017-Feb-01 17:00:11 by tpdownes:</em> <br/>\n\nI have updated my certificate to include the private DNS name and condor's implementation of GSI authentication nevertheless does not work.\n\n<p></p><div class=\"verbatim\">\n<pre>[pcdev1:~] condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt; : pcdev2.nemo.uwm.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:We are trying to connect to a daemon with certificate DN (/DC=org/DC=incommon/C=US/postalCode=53211/ST=Wisconsin/L=Milwaukee/street=1900 E. Kenwood Blvd/O=University of Wisconsin-Milwaukee/OU=Physics/CN=pcdev2.ligo.uwm.edu), but the host name in the certificate does not match any DNS name associated with the host to which we are connecting (host name is 'pcdev2.nemo.uwm.edu', IP is '172.20.1.34', Condor connection address is '&lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt;').  Check that DNS is correctly configured.  If the certificate is for a DNS alias, configure HOST_ALIAS in the daemon's configuration.  If you wish to use a daemon certificate that does not match the daemon's host name, make GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or disable all host name checks by setting GSI_SKIP_HOST_CHECK=true or by defining GSI_DAEMON_NAME.\n</pre></div>\n\n\n<p>It seems like you're doing a \"dumb\": comparison of the subject DN rather than reading the subject alternative names.\n\n</p><p>From output of \"openssl x509 -in /etc/grid-security/hostcert.pem -noout -text\"\n</p><div class=\"verbatim\">\n<pre>            X509v3 Subject Alternative Name:\n                DNS:pcdev1.ligo.uwm.edu, DNS:pcdev1.cgca.uwm.edu, DNS:pcdev1.nemo.uwm.edu, DNS:pcdev1.phys.uwm.edu\n</pre></div>\n\n\n<p><a class=\"external\" href=\"https://docs.globus.org/security-bulletins/2015-12-strict-mode/\">https://docs.globus.org/security-bulletins/2015-12-strict-mode/</a>\n\n</p><p></p><hr/>\n<em>2017-Feb-02 09:43:46 by tpdownes:</em> <br/>\n\nEven disabling the comparison doesn't seem to fix the problem.\n<div class=\"verbatim\">\n<pre>root@pcdev1:~# condor_config_val GSI_SKIP_HOST_CHECK\ntrue\nroot@pcdev1:~# condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt; : pcdev2.nemo.uwm.edu\nSECMAN:2007:Failed to received post-auth ClassAd\nAUTHENTICATE:1004:Failed to authenticate using KERBEROS\nAUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n\n\n<p></p><hr/>\n<em>2017-Feb-02 09:46:05 by tpdownes:</em> <br/>\n\nSec. 3.5.25 of the Condor 8.6.0 manual \"Configuration File Entries Relating to Security\" begins with the text \"This section has not yet been written\" for many security-related knobs.\n\n<p></p><hr/>\n<em>2017-Feb-02 10:07:18 by tpdownes:</em> <br/>\n\nAdding the following configuration and rebooting the negotiator/collector\n<div class=\"verbatim\">\n<pre>root@pcdev2:~# condor_config_val HOST_ALIAS\npcdev2.ligo.uwm.edu\n</pre></div>\n\n\n<p>does not change the result\n\n</p><p></p><div class=\"verbatim\">\n<pre>[pcdev1:~] condor_q -global\n\n-- Failed to fetch ads from: &lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt; : pcdev2.nemo.uwm.edu\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:We are trying to connect to a daemon with certificate DN (/DC=org/DC=incommon/C=US/postalCode=53211/ST=Wisconsin/L=Milwaukee/street=1900 E. Kenwood Blvd/O=University of Wisconsin-Milwaukee/OU=Physics/CN=pcdev2.ligo.uwm.edu), but the host name in the certificate does not match any DNS name associated with the host to which we are connecting (host name is 'pcdev2.nemo.uwm.edu', IP is '172.20.1.34', Condor connection address is '&lt;172.20.1.34:9618?addrs=172.20.1.34-9618&amp;noUDP&amp;sock=3068_490e_3&gt;').  Check that DNS is correctly configured.  If the certificate is for a DNS alias, configure HOST_ALIAS in the daemon's configuration.  If you wish to use a daemon certificate that does not match the daemon's host name, make GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or disable all host name checks by setting GSI_SKIP_HOST_CHECK=true or by defining GSI_DAEMON_NAME.\n</pre></div>\n\n\n<p>It should further be noted that the error message is advising the use of GSI_DAEMON_NAME which the manual (even in recent 8.5) advises is retired.\n\n</p><p></p><hr/>\n<em>2017-Feb-02 12:16:07 by tannenba:</em> <br/>\n\nHi Tom,\n\n<p>More coming soon from Zach, but to solve this issue I think we want to effectively set things up so\n\n</p><p></p><pre>   SEC_READ_AUTHENTICATION_METHODS = $(SEC_READ_AUTHENTICATION_METHODS) CLAIMTOBE\n</pre>\n\n<p>and then, if knob CERTIFICATE_MAPFILE is defined, add a line to the map file that has\n\n</p><p></p><pre>   CLAIMTOBE (.*)\n</pre>\n\n<p>So when the schedd wants to show \"condor_q\" (without -allusers), the schedd currently authenticates the remote user so it knows which user to show jobs for.  In the case of IP-based security, none of the default authentication methods (FS, GSI, etc) work over the network without additional setup from the admin.  By appending CLAIMTOBE to the to the READ authentication methods, we essentially tell the schedd to assume the user running \"condor_q\" is the same as whoami reports on the remote machine if the user cannot be authenticated any other way.   Zach needs to add this logic into the code, because we do NOT want to do this if, for instance, the admin explicitly sets up a more restrictive READ policy, but hopefully it gives you the idea for how to work around this right now.  Hopefully Zach can have this added for v8.6.1.\n\n</p><p></p><hr/>\n<em>2017-Feb-02 12:24:57 by tpdownes:</em> <br/>\n\nIt may be lost in the noise, but the way you read certificates and validate their hostnames is, very literally, not what the specification tells you to do. To workaround your choice, you've added a lot of knobs to allow one certificate to stand-in for other hotsnames that aren't in the certificate subject.\n\n<p>GSI_SKIP_HOST_CHECK_CERT_REGEX,GSI_SKIP_HOST_CHECK,HOST_ALIAS\n\n</p><p>But, in 2017, certificates have these features built-in. This is one of the ways that the world of high-availability on the web works - a certificate can represent many FQDNs easily with subject alternative names and wildcards. See, e.g. the cert from www.nytimes.com.\n\n</p><p>Maybe, long ago, you needed these knobs. Now they're very much in the way of security.\n\n</p><p></p><hr/>\n<em>2017-Feb-02 12:41:45 by tannenba:</em> <br/>\n\nImmediately previous comment (related to cleanup cert alternative names) is, IMO, very valid.... but really should be in a separate ticket.\n\n<p>Lets keep this ticket on the topic of how to improve the out-of-box experience, as currently \"condor_q\" fails against a remote schedd but works if you do \"condor_q -allusers\".\n\n</p><p>I suggest all the comments/wisdom related to modernization of how cert alternative names are handled moves to a different ticket.\n\n</p><p></p><hr/>\n<em>2017-Feb-03 11:17:05 by zmiller:</em> <br/>\n\nI created a new ticket <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6125\" onclick=\"get_ticket_and_populate_wrapper('6125'); return false;\" title=\"default condor_q behavior in 8.6.0 has issues (-global)\">#6125</a></span> that address the proposed fix for this problem.  As Todd mentioned above, the workaround for now is to add CLAIMTOBE to your read methods. (And CLIENT methods if needed)\n\n<p></p><hr/>\n<em>2017-Feb-03 12:22:20 by zmiller:</em> <br/>\n\nRegarding the GSI issues, I have created a separate ticket for that issue: <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6127\" onclick=\"get_ticket_and_populate_wrapper('6127'); return false;\" title=\"GSI hostname checks are broken, confusing, do not comply with RFC 2818\">#6127</a></span>\n\n<p></p><hr/>\n<em>2017-Feb-15 16:48:36 by tannenba:</em> <br/>\n\nAs this incident ticket has now been broken down into multiple derived tickets (se below), I am resolving this ticket.  Of course, the derived tickets still point to this ticket so all the remarks/widsom here is preserved.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6125\" onclick=\"get_ticket_and_populate_wrapper('6125'); return false;\" title=\"default condor_q behavior in 8.6.0 has issues (-global)\">#6125</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ndefault condor_q behavior in 8.6.0 has issues (-global)</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=6127\" onclick=\"get_ticket_and_populate_wrapper('6127'); return false;\" title=\"GSI hostname checks are broken, confusing, do not comply with RFC 2818\">#6127</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nGSI hostname checks are broken, confusing, do not comply with RFC 2818</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2017-Feb-15 16:48", "status": "defer", "created": "2016-Aug-19 18:30", "fixed_version": "2016-Aug-19 18:30", "broken_version": "v080506", "priority": "5", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "downes@uwm.edu zmiller@cs.wisc.edu johnkn@cs.wisc.edu tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}