{"id": 7788, "title": "Ticket #7788: possible unnecessary DNS checks causing trouble for HTCondor-CE", "description": "<blockquote>\n(from an email thread)\n<hr/>\nWhen acting as a client of a given CE without a PTR, the client will fail authN:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ condor_ping -name htcondor-ce.isg.siue.edu -pool\nhtcondor-ce.isg.siue.edu:9619 -verbose WRITE\nWRITE failed!\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:Failed to look up server host address for GSI connection to server with IP 146.163.10.129 and DN\n    /DC=org/DC=incommon/C=US/ST=Illinois/L=Carbondale/O=Southern Illinois University/OU=SIUE Information Technology Services/CN=htcondor-ce.isg.siue.edu.\n    Is DNS correctly configured? This server name check can be bypassed by making GSI_SKIP_HOST_CHECK_CERT_REGEX\n    match the DN, or by disabling all hostname checks by setting GSI_SKIP_HOST_CHECK=true or defining GSI_DAEMON_NAME.\nAUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n\n\n<p>Which seems goofy -- should the client care about verifying reverse DNS when I'm giving it the hostname?</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Aug-06 14:12:09 by zmiller:</em> <br/>\n\nProbably it already resolved the host to an IP early on, and then some other layer or code is trying to do the reverse lookup for verification of the hostname in the GSI cert.  That is, the hostname isn't preserved along the way.  Yeah, might be screwy.  But also there are a couple issues to watch out for.\n\n<p>For INCOMING connections (which I know this is not, but bear with me), consider this:\n\n</p><p>I can configure siue.zmiller.com to return IP address 146.163.10.129.  So you can't trust the resulting IP address given only a hostname.\n\n</p><p>If I control the reverse record for IP 66.33.223.207, I could make it say that it is \"htcondor-ce.isg.siue.edu\".  So you can't trust the resulting hostname given only an IP address.\n\n</p><p>For security the correct thing to do is to reverse map the IP that connected to you and then forward resolve it again.\n\t<a class=\"external\" href=\"https://cwe.mitre.org/data/definitions/350.html\">https://cwe.mitre.org/data/definitions/350.html</a>\n\n</p><p>Now, this is the client barfing for an OUTGOING connection, so the reason is probably stupid and is probably the first sentence in this email.\n\n</p><p>If you disable the hostname check, I would guess it skips the reverse lookup, so that might work for you in the short term.  Or maybe the current code does the reverse lookup anyway and then just skips the check, which would be dumb but not at all out of the question.\n\n</p><p></p><hr/>\n<em>2020-Aug-10 13:39:15 by blin:</em> <br/>\n\nAh, I did create a ticket for this issue: <a class=\"external\" href=\"https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=7764,4\">https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=7764,4</a>. I'll close that as a dupe.\n\n<p>Do we lose any other checks by disabling the hostname check? I'd like to know before I tell GlideinWMS factory ops to add this to their configuration.\n\n</p><p></p><hr/>\n<em>2020-Aug-10 15:04:22 by bbockelm:</em> <br/>\n\n&gt; Do we lose any other checks by disabling the hostname check? I'd like to know before I tell GlideinWMS factory ops to add this to their configuration.\n\n<p>Yes: the client will accept any valid certificate instead of making sure the DN / SAN matches expectations.  I.e., you basically disable security.\n\n</p><p></p><hr/>\n<em>2020-Aug-10 15:16:44 by blin:</em> <br/>\n\nAh yeah, then the workaround is a no-go for us.\n\n<p></p><hr/>\n<em>2020-Aug-10 15:38:13 by zmiller:</em> <br/>\n\nSetting <code>\"GSI_SKIP_HOST_CHECK=true\"</code> doesn't completely \"disable security\".  It means the certificate used doesn't need to contain the hostname that matches the DNS hostname that the connection is coming from.  You still need a valid cert, signed by a trusted CA, with a subject name that is present in the mapfile, and that maps to a principal that is in the ALLOW_* list.  If that's not restrictive enough though then as you said that workaround won't work.\n\n<p>The other thing mentioned in the error message is setting GSI_DAEMON_NAME to the full DN.  That check might happen before any of the mapping (that code pre-dates the mapfiles) and so might let you succeed without the reverse DNS records.  Did you try it?  (If trying it out is disruptive, I can look at the code, which I haven't done recently...)\n\n</p><p></p><hr/>\n<em>2020-Aug-10 15:45:07 by blin:</em> <br/>\n\nWould we have to set <code>GSI_DAEMON_NAME</code> on the client side or could we do it server side, i.e. on the CE?\n\n<p></p><hr/>\n<em>2020-Aug-10 15:58:07 by bbockelm:</em> <br/>\n\n&gt; Setting \"GSI_SKIP_HOST_CHECK=true\" doesn't completely \"disable security\"\n\n<p>Ah - that depends on whether you're speaking about the general case or specifically about the OSG HTCondor-CE.\n\n</p><p>OSG accepts Let's Encrypt server certificates so it's fairly trivial to acquire a valid host cert.\n\n</p><p></p><hr/>\n<em>2020-Aug-11 11:24:45 by zmiller:</em> <br/>\n\nBut they don't just accept any Let's Encrypt cert, right?  I assume something does some kind of authorization based on the subject name.  (Which is the host name).\n\n<p>Sure, if I, as an attacker, could steal a host cert issued by Let's Encrypt that you've already authorized, then I can impersonate that host.  Is that the threat you are guarding against?  Or what am I still missing?  Because although a bit tedious to enter in the config file, there might still be a workaround:\n\n</p><p>(I haven't tried this experiment so before anyone does a lot of config work let's just discuss it.)\n\n</p><p>You could have a Let's Encrypt certificate for moria.cs.wisc.edu.  DN is \"/CN=moria.cs.wisc.edu\".  In the certificate mapfile you have an entry:\n</p><div class=\"code\">\n<pre class=\"code\">GSI \"/CN=moria.cs.wisc.edu\" x509_host_moria\n</pre></div>\n\n\n<p>And in the config file you have:\n</p><div class=\"code\">\n<pre class=\"code\">ALLOW_DAEMON = x509_host_moria/128.105.121.1\n</pre></div>\n\n\n<p>This should work even with <code>GSI_SKIP_HOST_CHECK=true</code> and still encforces that the connection originated from moria.  Just instead of doing it in the authentication layer, we're doing it in the authorization layer.\n\n</p><p>Whether or not the circumvents the code that does the reverse-DNS I will leave as an exercise to the administrator... :)\n\n</p><p></p><hr/>\n<em>2020-Aug-12 22:26:52 by bbockelm:</em> <br/>\n\n&gt; But they don't just accept any Let's Encrypt cert, right? I assume something does some kind of authorization based on the subject name. (Which is the host name).\n\n<p>No, the clients currently depend on forward-resolution for that... there's no authoritative list that we can depend on.\n\n</p><p></p><hr/>\n<em>2020-Aug-19 15:08:52 by bbockelm:</em> <br/>\n\nTodd and I just had a realization:\n\n<p></p><ul>\n<li>I had assumed there was something broken in the client itself where the alias is dropping from the sinful string.\n</li><li>However, Todd pointed out that there may be a misconfiguration in the schedd and the alias isn't going into the sinful string itself in the collector ad.\n</li></ul>\n\n<p>@ZKM or blin: Can you please provide a full sinful (contents of the <code>MyAddress</code> attribute) from your example case?\n\n</p><p></p><hr/>\n<em>2020-Aug-19 15:19:16 by tannenba:</em> <br/>\n\nThe problem was going to CE at siue.edu, and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span> to that daemon does NOT include an <em>alias</em> field - behold:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">\u03bb condor_status -pool collector.opensciencegrid.org:9619 -schedd -af name myaddress | grep siue\nhtcondor-ce.isg.siue.edu &lt;146.163.10.129:9619?addrs=146.163.10.129-9619&amp;noUDP&amp;sock=660459_b768_40&gt;\n</pre></div>\n\n\n<p>Note that of all the reporting OSG CEs, 32 do have an <em>alias</em> field, and 112 do not.\n\n</p><p></p><hr/>\n<em>2020-Aug-19 16:14:57 by blin:</em> <br/>\n\nInteresting! What kind of configuration do we need to have in place to make sure that the schedd name is included in its sinful?\n\n<p></p><hr/>\n<em>2020-Aug-19 17:51:37 by tannenba:</em> <br/>\n\nPerhaps an immediate workaround to this issue in v8.8 HTCondor is to have CE's set configuration knob HOST_ALIAS to a value that matches their certificate?\n\n<p>Also including Todd Miller on this ticket, since after reading <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=7150\" onclick=\"get_ticket_and_populate_wrapper('7150'); return false;\" title=\"Sinful alias and daemon name inconsistencies\">#7150</a></span>, it is clear he has debugged these issues before in-depth and has a good understanding of this code...\n\n</p><p></p><hr/>\n<em>2020-Aug-21 10:02:32 by tannenba:</em> <br/>\n\nDid anyone check if simply setting the following config in a v8.8 HTCondor-CE fixes the problem?\n\n<p></p><pre>   HOST_ALIAS = $(FULL_HOSTNAME)\n</pre>\n\n<p>?  If it does, can we resolve this ticket?\n\n</p><p>Note that the above setting for HOST_ALIAS is the default as of HTCondor v8.9.2 (see <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7030\" onclick=\"get_ticket_and_populate_wrapper('7030'); return false;\" title=\"SSL host verification\">#7030</a></span>)\n\n</p><p></p><hr/>\n<em>2020-Aug-21 12:17:34 by blin:</em> <br/>\n\nI downgraded a test CE to 8.8.9 and setting <code>HOST_ALIAS</code> updates the schedd sinful as expected:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">[root@fermicloud068 ~]# systemctl restart condor-ce\n[root@fermicloud068 ~]# condor_ce_config_val host_alias\nNot defined: HOST_ALIAS\n[root@fermicloud068 ~]# condor_ce_status -schedd -af myaddress\n&lt;131.225.155.18:9619?addrs=131.225.155.18-9619&amp;noUDP&amp;sock=122439_bf3c_3&gt;\n[root@fermicloud068 ~]# vi /etc/condor-ce/config.d/99-local.conf\n[root@fermicloud068 ~]# systemctl restart condor-ce\n[root@fermicloud068 ~]# condor_ce_config_val host_alias\nfermicloud068.fnal.gov\n[root@fermicloud068 ~]# condor_ce_status -schedd -af myaddress\n&lt;131.225.155.18:9619?addrs=131.225.155.18-9619&amp;alias=fermicloud068.fnal.gov&amp;noUDP&amp;sock=122662_0543_3&gt;\n</pre></div>\n\n\n<p>I'm working on standing up an 8.8 CE without a PTR to see if this works to resolve the GSI auth issues.\n\n</p><p></p><hr/>\n<em>2020-Aug-21 15:04:48 by blin:</em> <br/>\n\nNo joy:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ condor_config_val -name gittrac7788.opensciencegrid.org -pool gittrac7788.opensciencegrid.org:9619 HOST_ALIAS\ngittrac7788.opensciencegrid.org\n$ condor_status -schedd -pool $ce:9619 -af myaddress condorversion\n&lt;192.170.236.229:9619?addrs=192.170.236.229-9619&amp;alias=gittrac7788.opensciencegrid.org&amp;noUDP&amp;sock=657_39cf_3&gt; $CondorVersion: 8.8.10 Aug 12 2020 PackageID: 8.8.10-1.3 $\n$ condor_ping -name $ce -pool $ce:9619 -verbose WRITE\nWRITE failed!\nAUTHENTICATE:1003:Failed to authenticate with any method\nAUTHENTICATE:1004:Failed to authenticate using GSI\nGSI:5008:Failed to look up server host address for GSI connection to server with IP 192.170.236.229 and DN /CN=gittrac7788.opensciencegrid.org.  Is DNS correctly configured?  This server name check can be bypassed by making GSI_SKIP_HOST_CHECK_CERT_REGEX match the DN, or by disabling all hostname checks by setting GSI_SKIP_HOST_CHECK=true or defining GSI_DAEMON_NAME.\nAUTHENTICATE:1004:Failed to authenticate using FS\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Aug-21 16:50:14 by bbockelm:</em> <br/>\n\nOh geez...\n\n<p>That would have worked but the code currently bails if there's no PTR record at all!\n\n</p><p>A few lines after where you hit the error we override the hostname with the alias.\n\n</p><p>(FWIW - the background is in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1605\" onclick=\"get_ticket_and_populate_wrapper('1605'); return false;\" title=\"support host certificate DNS name validation\">#1605</a></span>)\n\n</p><p></p><hr/>\n<em>2020-Aug-27 11:55:58 by blin:</em> <br/>\n\nToddM's patch appears to work! With a client previously on 8.9.8 from the OSG repos, <code>condor_ping</code> failed but after upgrading the client to Todd's build <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b89c8b1bf74329d497bfc336eb2e99345f69183\">[1]</a></span>, yielded success:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ ce=gittrac7788.opensciencegrid.org\n$ _condor_TOOL_DEBUG=\"D_SECURITY:2\" condor_ping -name $ce -pool $ce:9619 -verbose WRITE\nRemote Version:              $CondorVersion: 8.8.10 Aug 12 2020 PackageID: 8.8.10-1.3 $\nLocal  Version:              $CondorVersion: 8.9.9 Aug 26 2020 BuildID: 515894 PackageID: 8.9.9-0.515894 PRE-RELEASE-UWCS $\nSession ID:                  gittrac7788:733:1598547190:10180\nInstruction:                 WRITE\nCommand:                     60021\nEncryption:                  none\nIntegrity:                   MD5\nAuthenticated using:         GSI\nAll authentication methods:  FS,GSI\nRemote Mapping:              submituser@users.htcondor.org\nAuthorized:                  TRUE\n</pre></div>\n\n\n<p>Since this requires updates for clients, we'll also want this backported into the stable series.\n\n</p><p><span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9b89c8b1bf74329d497bfc336eb2e99345f69183\">[1]</a></span>\n\n</p><p></p><div class=\"verbatim\">\n<pre>condor-8.9.9-0.515894.el7.x86_64\ncondor-bosco-8.9.9-0.515894.el7.x86_64\ncondor-classads-8.9.9-0.515894.el7.x86_64\ncondor-debuginfo-8.9.9-0.515894.el7.x86_64\ncondor-external-libs-8.9.9-0.515894.el7.x86_64\ncondor-procd-8.9.9-0.515894.el7.x86_64\npython2-condor-8.9.9-0.515894.el7.x86_64\npython3-condor-8.9.9-0.515894.el7.x86_64\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Aug-27 12:09:17 by zmiller:</em> <br/>\n\nThis was in the GSI code.  Do we have a similar issue for SSL?\n\n<p>Glad it is working for now.  I'm not going to spend the time on it right now but isn't there still some questionable behavior to be understood and/or cleaned up?  In particular, if I pass <code>\"hostname.foo.com\"</code> to condor_status, shouldn't that exact string from the command line be used in the GSI hostname check?\n\n</p><p></p><hr/>\n<em>2020-Aug-27 13:19:58 by tlmiller:</em> <br/>\n\nProbably.  It's also not clear what the side-effects of the patch (preferring the host alias to its PTR record) are.  BrianB also found an attack.  At this point, I think it's up to people who know what's going to finish this fix (and/or decide that the patch is OK and write up another ticket for follow-up issues).\n\n<p></p><hr/>\n<em>2020-Sep-21 13:01:41 by tlmiller:</em> <br/>\n\nBrianL requested that this patch be merged.  If BrianB hasn't already, he'll have to write up a ticket for whatever issue(s) he may have found\n\n<p></p><hr/>\n<em>2020-Sep-21 13:07:42 by tlmiller:</em> <br/>\n\nBackporting to the stable series, as requested...\n\n<p></p><hr/>\n<em>2020-Sep-21 13:22:41 by tlmiller:</em> <br/>\n\nZach, in the code review, please think about what side-effects might arise from moving the alias check to before the reverse look-up; I can't think of any, but that probably just means I missed something.\n\n<p></p><hr/>\n<em>2020-Oct-06 13:28:34 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good for both 8.9 and 8.8.  To answer my own question from August 27:  I looked at the SSL code and it's different enough this same fix can't be made there (there no <code>HOST_ALIAS</code> for one).  Resolving this ticket.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-21 13:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/292b5641b916ceeb0b1f52245bbce343e2b49a37\">[61320]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7788\" onclick=\"get_ticket_and_populate_wrapper('7788'); return false;\" title=\"possible unnecessary DNS checks causing trouble for HTCondor-CE\">#7788</a></span>) Release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-21 13:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/34a9ce8072a15c688e0c190f6b052b60656a0a9c\">[61319]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7788\" onclick=\"get_ticket_and_populate_wrapper('7788'); return false;\" title=\"possible unnecessary DNS checks causing trouble for HTCondor-CE\">#7788</a></span>) Try to enable the HOST_ALIAS work-around.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-26 11:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d69ee19fce32239443e1caf3aa625b7a96b02121\">[60554]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7788\" onclick=\"get_ticket_and_populate_wrapper('7788'); return false;\" title=\"possible unnecessary DNS checks causing trouble for HTCondor-CE\">#7788</a></span>) Try to enable the HOST_ALIAS work-around.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Oct-06 13:29", "status": "resolved", "created": "2020-Aug-06 14:11", "fixed_version": "2020-Aug-06 14:11", "broken_version": "", "priority": "1", "subsystem": "Security", "assigned_to": "tlmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu, bbockelman@morgridge.org, zmiller@cs.wisc.edu, tlmiller@cs.wisc.edu", "due_date": ""}