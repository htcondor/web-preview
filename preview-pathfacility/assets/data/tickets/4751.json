{"id": 4751, "title": "Ticket #4751: Detect authorization denied errors", "description": "<blockquote>\nEveryone freakin' hates this sort of issue when you screw up authorization:\n\n<p>$ condor_ce_q -pool ce1.accre.vanderbilt.edu -name ce1.accre.vanderbilt.edu\n\n</p><p>-- Failed to fetch ads from: &lt;129.59.197.223:9620?sock=33630_8b33_4&gt; : ce1.accre.vanderbilt.edu\n\n</p><p>(to replicate, set ALLOW_READ=noone@nowhere and reconfig)\n\n</p><p>It's impossible to distinguish a network / unknown error from an authorization error.  I know that many folks have lost hours and hours chasing network issues that were actually security issues in the end.\n\n</p><p>I think we can detect this situation, however.  The security post-auth ad includes the list of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ValidCommands\" title=\"Valid Commands\">ValidCommands</a></span> (a string list of integers).  If we are trying to execute command int X and it's not in this list, we should at least hint to the sysadmin that the problem is security.\n\n</p><p>Brian</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-04 11:17:38 by bbockelm:</em> <br/>\n\nIs this just a crazy idea?  I know there may be some intricate issues here - but it seems like if we see a CEDAR error while executing a command not in the valid commands, we can <strong>at least</strong> put a hint into the error message.\n\n<p></p><hr/>\n<em>2015-Mar-11 14:57:21 by tannenba:</em> <br/>\n\nBump.... Zach, your comments?\n\n<p></p><hr/>\n<em>2015-Mar-11 16:34:26 by zmiller:</em> <br/>\n\nIt's actually easier to detect than what Brian is suggesting...  there is no <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> returned when authorization fails, so there is no <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ValidCommands\" title=\"Valid Commands\">ValidCommands</a></span> to examine.  However, it's a fairly safe assumption that if the connection was closed after succesfully authenticating but before receiving the auth_info classad, that the server hung up on us because we were denied.  In fact, the start command code already detects when this happens, and pushes an extremely unhelpful (to everyone but me :) message onto the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ErrStack\" title=\"Err Stack\">ErrStack</a></span>.\n\n<p>Two things need to happen:\n</p><ol>\n<li>Change the startCommand code to put a more friendly error message onto the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ErrStack\" title=\"Err Stack\">ErrStack</a></span>\n</li><li>Find the call sites for startCommand in the various tools and make sure that if it fails, it dumps the errStack to stderr.  Right now, this is not happening, so the error isn't fully propagated to the user.\n</li></ol>\n\n<p>This is fairly trivial, and Todd says I can spend a couple hours on it, which should be enough.\n\n</p><p></p><hr/>\n<em>2015-Apr-08 15:19:00 by bbockelm:</em> <br/>\n\nPer the OSG / HTCondor call today, goal is to commit to gittrac by April 10.\n\n<p>This ticket basically has boiled down to making sure all the tools push this to the errstack.\n\n</p><p>Question from BrianB - what about python bindings?\n\n</p><p></p><hr/>\n<em>2015-Apr-22 15:14:12 by bbockelm:</em> <br/>\n\nPer OSG / HTCondor call:  zmiller thinks this will take another week.\n\n<p></p><hr/>\n<em>2015-May-06 15:14:08 by bbockelm:</em> <br/>\n\nAny updates on this?  Target delivery date was 1 week ago.\n\n<p></p><hr/>\n<em>2015-May-06 16:29:36 by zmiller:</em> <br/>\n\nYes, it is done and working.  I'm just testing extra thoroughly (different combinations of Auth/Crypto enabled) because the change was quite large.  It'll all be committed before the code freeze friday.\n\n<p></p><hr/>\n<em>2015-Jun-11 15:27:45 by tannenba:</em> <br/>\n\nFYI, here is an example of how things now look when a tool has an authorization failure:\n\n<p></p><pre>   % condor_off\n   ERROR\n   SECMAN:2010:Received \"DENIED\" from server for user zmiller@cs.wisc.edu using method FS.\n   Can't send Kill-All-Daemons command to local master\n</pre>\n\n<p>and then condor_off exits with a non-zero (failure) value.\n\n</p><p></p><hr/>\n<em>2015-Jun-11 15:28:18 by tannenba:</em> <br/>\n\nSuggested version history blurb -\n\n<p>\"Tools now detect and report authorization failures.  Previously, an HTCondor tool would either incorrectly report an authorization failure as a network failure, or simply not report a failure at all.  Now, an authorization denial results in a helpful error message printed to stderr and the tool's exit code will indicate a failure.\"</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-12 12:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/61f0219b03817fced29dc7cd68d6582cbf9d628c\">[45038]</a></span>: rewrite 8.3.6 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4751\" onclick=\"get_ticket_and_populate_wrapper('4751'); return false;\" title=\"Detect authorization denied errors\">#4751</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-11 11:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f2435e6c056bf4e267a711deed6910d0a63b17ef\">[45029]</a></span>: add 8.3.6 version history item for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4751\" onclick=\"get_ticket_and_populate_wrapper('4751'); return false;\" title=\"Detect authorization denied errors\">#4751</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-13 09:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1b4a659b316e915cb3c337b642a08f9d92f334e5\">[44843]</a></span>: Change daemoncore to detect authorization failures before sending response ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4751\" onclick=\"get_ticket_and_populate_wrapper('4751'); return false;\" title=\"Detect authorization denied errors\">#4751</a></span>  (By Zach Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jun-14 19:59", "status": "resolved", "created": "2014-Dec-03 15:39", "fixed_version": "2014-Dec-03 15:39", "broken_version": "", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "#4882", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu, marian.zvada@cern.ch, blin@cs.wisc.edu", "due_date": "20150410"}