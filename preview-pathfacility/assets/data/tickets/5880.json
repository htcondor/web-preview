{"id": 5880, "title": "Ticket #5880: Full SPOOL filesystem on schedd", "description": "<blockquote>\nOn Tuesday, August 30th 2016 the 215GB filesystem where SPOOL lives filled up due to a large quantity of self-checkpointing jobs submitted by a user;  See <a class=\"external\" href=\"https://crt.cs.wisc.edu/rt/Ticket/Display.html?id=49566\">Ticket #49566: jobs in CHTC on hold, temporarily</a>.  Unfortunately the job queue log was being kept in the same filesystem, so the schedd shut itself down.  From the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span>:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">08/30/16 02:01:31 (pid:742183) ERROR \"Failed to write real job queue log: fflush failed (errno 28); no local backup available.\" at line 553 in file /slots/02/dir_1789184/userdir/.tmpJTHhOd/BUILD/condor-8.5.6/src/condor_utils/log_transaction.cpp\n08/30/16 02:01:31 (pid:742183) Cron: Killing all jobs\n08/30/16 02:01:31 (pid:742183) CronJobList: Deleting all jobs\n08/30/16 02:01:31 (pid:742183) Cron: Killing all jobs\n08/30/16 02:01:31 (pid:742183) CronJobList: Deleting all jobs\n08/30/16 02:01:31 (pid:742183) Canceling request for claim slot4@ale-31.cs.wisc.edu &lt;128.105.202.41:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#144388&amp;addrs=128.105.202.41-9618&amp;noUDP&amp;sock=2710_6172_3&gt; for dapper 25428274.0\n08/30/16 02:01:31 (pid:742183) Failed to send REQUEST_CLAIM to startd slot4@ale-31.cs.wisc.edu &lt;128.105.202.41:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#144388&amp;addrs=128.105.202.41-9618&amp;noUDP&amp;sock=2710_6172_3&gt; for dapper: SECMAN:2003:TCP connection to st\nartd slot4@ale-31.cs.wisc.edu &lt;128.105.202.41:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#144388&amp;addrs=128.105.202.41-9618&amp;noUDP&amp;sock=2710_6172_3&gt; for dapper failed.|CEDAR:6007:operation was canceled\n08/30/16 02:01:31 (pid:742183) Canceling request for claim slot8@ale-05.cs.wisc.edu &lt;128.105.202.15:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#141960&amp;addrs=128.105.202.15-9618&amp;noUDP&amp;sock=5017_d2bb_3&gt; for dapper 25428272.0\n08/30/16 02:01:31 (pid:742183) Failed to send REQUEST_CLAIM to startd slot8@ale-05.cs.wisc.edu &lt;128.105.202.15:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#141960&amp;addrs=128.105.202.15-9618&amp;noUDP&amp;sock=5017_d2bb_3&gt; for dapper: SECMAN:2003:TCP connection to st\nartd slot8@ale-05.cs.wisc.edu &lt;128.105.202.15:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#141960&amp;addrs=128.105.202.15-9618&amp;noUDP&amp;sock=5017_d2bb_3&gt; for dapper failed.|CEDAR:6007:operation was canceled\n...\n08/30/16 02:01:37 (pid:742183) Canceling request for claim slot5@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper 25428300.0\n08/30/16 02:01:37 (pid:742183) Failed to send REQUEST_CLAIM to startd slot5@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper: SECMAN:2003:TCP connection to startd slot5@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper failed.|CEDAR:6007:operation was canceled\n08/30/16 02:01:59 (pid:2877061) Setting maximum file descriptors to 102400.\n08/30/16 02:01:59 (pid:2877061) ******************************************************\n08/30/16 02:01:59 (pid:2877061) ** condor_schedd (CONDOR_SCHEDD) STARTING UP\n08/30/16 02:01:59 (pid:2877061) ** /usr/sbin/condor_schedd\n08/30/16 02:01:59 (pid:2877061) ** SubsystemInfo: name=SCHEDD type=SCHEDD(5) class=DAEMON(1)\n08/30/16 02:01:59 (pid:2877061) ** Configuration: subsystem:SCHEDD local:&lt;NONE&gt; class:DAEMON\n08/30/16 02:01:59 (pid:2877061) ** $CondorVersion: 8.5.6 Jul 15 2016 BuildID: 375046 $\n08/30/16 02:01:59 (pid:2877061) ** $CondorPlatform: x86_64_RedHat6 $\n08/30/16 02:01:59 (pid:2877061) ** PID = 2877061\n08/30/16 02:01:59 (pid:2877061) ** Log last touched 8/30 02:01:37\n08/30/16 02:01:59 (pid:2877061) ******************************************************\n...\n08/30/16 02:01:37 (pid:742183) Failed to send REQUEST_CLAIM to startd slot3@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper: SECMAN:2003:TCP connection to st\nartd slot3@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper failed.|CEDAR:6007:operation was canceled\n08/30/16 02:01:37 (pid:742183) Canceling request for claim slot5@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper 25428300.0\n08/30/16 02:01:37 (pid:742183) Failed to send REQUEST_CLAIM to startd slot5@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper: SECMAN:2003:TCP connection to st\nartd slot5@ale-14.cs.wisc.edu &lt;128.105.202.24:9618?CCBID=128.105.19.35:9618%3faddrs%3d128.105.19.35-9618#142026&amp;addrs=128.105.202.24-9618&amp;noUDP&amp;sock=2931_002c_3&gt; for dapper failed.|CEDAR:6007:operation was canceled\n08/30/16 02:01:59 (pid:2877061) Setting maximum file descriptors to 102400.\n08/30/16 02:01:59 (pid:2877061) ******************************************************\n08/30/16 02:01:59 (pid:2877061) ** condor_schedd (CONDOR_SCHEDD) STARTING UP\n08/30/16 02:01:59 (pid:2877061) ** /usr/sbin/condor_schedd\n08/30/16 02:01:59 (pid:2877061) ** SubsystemInfo: name=SCHEDD type=SCHEDD(5) class=DAEMON(1)\n08/30/16 02:01:59 (pid:2877061) ** Configuration: subsystem:SCHEDD local:&lt;NONE&gt; class:DAEMON\n08/30/16 02:01:59 (pid:2877061) ** $CondorVersion: 8.5.6 Jul 15 2016 BuildID: 375046 $\n08/30/16 02:01:59 (pid:2877061) ** $CondorPlatform: x86_64_RedHat6 $\n08/30/16 02:01:59 (pid:2877061) ** PID = 2877061\n08/30/16 02:01:59 (pid:2877061) ** Log last touched 8/30 02:01:37\n08/30/16 02:01:59 (pid:2877061) ******************************************************\n08/30/16 02:01:59 (pid:2877061) Using config source: /etc/condor/condor_config\n08/30/16 02:01:59 (pid:2877061) Using local config sources:\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/ephemeral/dns_domain_name.conf\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/condor_config.hosts\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/condor_config.global\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/condor_config.policy\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/condor_config.x86_64_SL6\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/condor_config.security\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/dns_domains/chtc.wisc.edu.local\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/hosts/submit-5.chtc.wisc.edu.local\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/include/schedd.conf\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/include/facility_wid.conf\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/include/owned_by_chtc.conf\n08/30/16 02:01:59 (pid:2877061)    /etc/condor/condor_config.flightworthy_testing\n08/30/16 02:01:59 (pid:2877061) config Macros = 229, Sorted = 229, StringBytes = 53403, TablesBytes = 8388\n08/30/16 02:01:59 (pid:2877061) CLASSAD_CACHING is ENABLED\n08/30/16 02:01:59 (pid:2877061) Daemon Log is logging: D_ALWAYS D_ERROR\n08/30/16 02:01:59 (pid:2877061) SharedPortEndpoint: waiting for connections to named socket 742155_ff92_39\n08/30/16 02:01:59 (pid:2877061) DaemonCore: command socket at &lt;128.104.101.92:9618?addrs=128.104.101.92-9618+[2607-f388-107c-501-a036-9fff-fe3c-caa8]-9618&amp;noUDP&amp;sock=742155_ff92_39&gt;\n08/30/16 02:01:59 (pid:2877061) DaemonCore: private command socket at &lt;128.104.101.92:9618?addrs=128.104.101.92-9618+[2607-f388-107c-501-a036-9fff-fe3c-caa8]-9618&amp;noUDP&amp;sock=742155_ff92_39&gt;\n08/30/16 02:01:59 (pid:2877061) History file rotation is enabled.\n08/30/16 02:01:59 (pid:2877061)   Maximum history file size is: 500000000 bytes\n08/30/16 02:01:59 (pid:2877061)   Number of rotated history files is: 2\n08/30/16 02:01:59 (pid:2877061) Logging per-job history files to: /var/lib/gratia/data\n08/30/16 02:04:39 (pid:2877061) WARNING: Encountered corrupt log record 25045924 (byte offset 1092485119)\n08/30/16 02:04:39 (pid:2877061)     104\n08/30/16 02:04:39 (pid:2877061) Lines following corrupt log record 25045924 (up to 3):\n08/30/16 02:04:39 (pid:2877061) ClassAdLog /var/lib/condor/execute/spool/job_queue.log has the following issues: Detected unterminated log entry\n\n08/30/16 02:04:39 (pid:2877061) About to rotate ClassAd log /var/lib/condor/execute/spool/job_queue.log\n08/30/16 02:04:50 (pid:2877061) About to rotate ClassAd log /var/lib/condor/execute/spool/job_queue.log\n...\n08/30/16 03:53:05 (pid:2877061) ERROR \"Failed to write real job queue log: fflush failed (errno 28); no local backup available.\" at line 553 in file /slots/02/dir_1789184/userdir/.tmpJTHhOd/BUILD/condor-8.5.6/src/condor_utils/log_transaction.cpp\n08/30/16 03:53:05 (pid:2877061) Cron: Killing all jobs\n08/30/16 03:53:05 (pid:2877061) CronJobList: Deleting all jobs\n08/30/16 03:53:05 (pid:2877061) Cron: Killing all jobs\n08/30/16 03:53:05 (pid:2877061) CronJobList: Deleting all jobs\n08/30/16 03:53:07 (pid:2877061) Failed to finish switching shadow 3030933 to new job 25446703.0\n08/30/16 03:53:23 (pid:3031070) Setting maximum file descriptors to 102400.\n08/30/16 03:53:23 (pid:3031070) ******************************************************\n08/30/16 03:53:23 (pid:3031070) ** condor_schedd (CONDOR_SCHEDD) STARTING UP\n08/30/16 03:53:23 (pid:3031070) ** /usr/sbin/condor_schedd\n08/30/16 03:53:23 (pid:3031070) ** SubsystemInfo: name=SCHEDD type=SCHEDD(5) class=DAEMON(1)\n08/30/16 03:53:23 (pid:3031070) ** Configuration: subsystem:SCHEDD local:&lt;NONE&gt; class:DAEMON\n08/30/16 03:53:23 (pid:3031070) ** $CondorVersion: 8.5.6 Jul 15 2016 BuildID: 375046 $\n08/30/16 03:53:23 (pid:3031070) ** $CondorPlatform: x86_64_RedHat6 $\n08/30/16 03:53:23 (pid:3031070) ** PID = 3031070\n08/30/16 03:53:23 (pid:3031070) ** Log last touched 8/30 03:53:07\n08/30/16 03:53:23 (pid:3031070) ******************************************************\n08/30/16 03:53:23 (pid:3031070) Using config source: /etc/condor/condor_config\n08/30/16 03:53:23 (pid:3031070) Using local config sources:\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/ephemeral/dns_domain_name.conf\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/condor_config.hosts\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/condor_config.global\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/condor_config.policy\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/condor_config.x86_64_SL6\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/condor_config.security\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/dns_domains/chtc.wisc.edu.local\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/hosts/submit-5.chtc.wisc.edu.local\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/include/schedd.conf\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/include/facility_wid.conf\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/include/owned_by_chtc.conf\n08/30/16 03:53:23 (pid:3031070)    /etc/condor/condor_config.flightworthy_testing\n08/30/16 03:53:23 (pid:3031070) config Macros = 229, Sorted = 229, StringBytes = 53403, TablesBytes = 8388\n08/30/16 03:53:23 (pid:3031070) CLASSAD_CACHING is ENABLED\n08/30/16 03:53:23 (pid:3031070) Daemon Log is logging: D_ALWAYS D_ERROR\n08/30/16 03:53:23 (pid:3031070) SharedPortEndpoint: waiting for connections to named socket 742155_ff92_40\n08/30/16 03:53:23 (pid:3031070) DaemonCore: command socket at &lt;128.104.101.92:9618?addrs=128.104.101.92-9618+[2607-f388-107c-501-a036-9fff-fe3c-caa8]-9618&amp;noUDP&amp;sock=742155_ff92_40&gt;\n08/30/16 03:53:23 (pid:3031070) DaemonCore: private command socket at &lt;128.104.101.92:9618?addrs=128.104.101.92-9618+[2607-f388-107c-501-a036-9fff-fe3c-caa8]-9618&amp;noUDP&amp;sock=742155_ff92_40&gt;\n08/30/16 03:53:23 (pid:3031070) History file rotation is enabled.\n08/30/16 03:53:23 (pid:3031070)   Maximum history file size is: 500000000 bytes\n08/30/16 03:53:23 (pid:3031070)   Number of rotated history files is: 2\n08/30/16 03:53:23 (pid:3031070) Logging per-job history files to: /var/lib/gratia/data\n08/30/16 03:54:13 (pid:3031070) WARNING: Encountered corrupt log record 8129586 (byte offset 360808444)\n08/30/16 03:54:13 (pid:3031070)     103   UNDEFINED\n08/30/16 03:54:13 (pid:3031070) Lines following corrupt log record 8129586 (up to 3):\n08/30/16 03:54:13 (pid:3031070) ClassAdLog /var/lib/condor/execute/spool/job_queue.log has the following issues: Detected unterminated log entry\n\n08/30/16 03:54:13 (pid:3031070) About to rotate ClassAd log /var/lib/condor/execute/spool/job_queue.log\n08/30/16 03:54:23 (pid:3031070) About to rotate ClassAd log /var/lib/condor/execute/spool/job_queue.log\n</pre></div>\n\n\n<p>The condor_master tried to start the condor_schedd several more times with the same result.\n\n</p><p>I contacted Christina and notified her that the SPOOL filesystem had filled up.  After looking around a bit we discovered that the culprit was a single user's job that had a multitude of output files that had a maximum size of about 50MB.\n\n</p><p>Christina suggested that we backup and remove the directory representing the files of the user's largest cluster to get the condor_schedd back online.  I tar'ed the directory to another server, removed the directory in SPOOL, and started the condor_schedd.  It came back up just fine.\n\n</p><p>Christina put the user's jobs on hold and contacted him;  He removed his jobs from the queue not long after.  The SPOOL filesystem currently has 206GB of space available.\n\n</p><p>The user seemed to think that the backed-up data was not particularly useful (after the fact) and only asked for a small sample of what was backed up.\n\n</p><p>This has started a conversation on what HTCondor should do, if anything, to keep this from happening.\n\n</p><p>Note that the condor_schedd's shutdown was due to the job queue log being on the same filesystem as the rest of the SPOOL when the filesystem filled up.  In the future infrastructure plans on putting the job queue long on it's own filesystem on a solid state drive.  Theoretically, this would keep the condor_schedd from crashing in such a situation.\n\n</p><p>I learned today from Todd Tannenbaum that there's a \"<a class=\"external\" href=\"https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=4292\">SpoolOnEvict</a>\" knob in the submit file that, if set to false, will keep job output from being written to the spool on eviction (it instead gets written to the directory the job was submitted from, I think?).  Due to an error in the documentation code this knob is not currently documented.  I'm not sure how the engagement team feels about this, but it's there.\n\n</p><p>The SPOOLed output files are owned by the unix account of the submitting user.  Using GNU/Linux quotas in SPOOL filesystem may be an option.  However, I don't trust GNU/Linux filesystem quotas (I've seen them become inaccurate a few times), and Todd and I agree that a user hitting their SPOOL quota may lead to strange and unforeseen consequences.  I'm not crazy about this idea.\n\n</p><p>Since the job queue log goes in the SPOOL directory by default, perhaps HTCondor should have some logic for refusing to SPOOL output files after a certain threshold is reached?\n\n</p><p>-Moate</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Aug-31 15:03:26 by tlmiller:</em> <br/>\n\nFWIW, I would guess that <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SpoolOnEvict\" title=\"Spool On Evict\">SpoolOnEvict</a></span> transfers to wherever the user specified the output files should go.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2016-Aug-31 15:03", "status": "new", "created": "2016-Aug-31 14:46", "fixed_version": "2016-Aug-31 14:46", "broken_version": "v080506", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "moate", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "egrasmick@wisc.edu, ckoch5@wisc.edu, lmichael@wisc.edu, tlmiller@cs.wisc.edu", "due_date": ""}