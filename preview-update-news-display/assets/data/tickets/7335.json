{"id": 7335, "title": "Ticket #7335: Turning off shared port crashes condor_master", "description": "<blockquote>\ncondor_reconfig to add a second startd configuration and change USE_SHARED_PORT from True to False resulted in a core dump of condor_master in 1 out 3 systems (will try another 95 systems tomorrow). Note, the details and motivation for this configuration change are discussed in ticket 7254.\n\n<p>If this is just a one-time transition glitch, then the Priority of this ticket can drop from 1 to 3. And when the long-term solution discussed in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7254\" onclick=\"get_ticket_and_populate_wrapper('7254'); return false;\" title=\"Create plan for low-latency LIGO bayestar schedule\">#7254</a></span> is implemented to obviate the need for a second starts then this can drop to priority 4 (or lower).\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">[root@node2063 condor]# less /var/log/condor/MasterLog\n...\n10/21/19 16:55:24 Turning off shared port endpoint because USE_SHARED_PORT=false\n10/21/19 16:55:24 Daemoncore: Listening at &lt;0.0.0.0:34543&gt; on TCP (ReliSock) and UDP (SafeSock).\n10/21/19 16:55:24 DaemonCore: command socket at &lt;10.14.9.63:34543?addrs=10.14.9.63-34543&gt;\n10/21/19 16:55:24 DaemonCore: private command socket at &lt;10.14.9.63:34543?addrs=10.14.9.63-34543&gt;\n10/21/19 16:55:24 Sent SIGTERM to SHARED_PORT (pid 13789)\n10/21/19 16:55:24 Declaring that EMFOLLOW_STARTD, since it shares /usr/sbin/condor_startd with STARTD, is also a DaemonCore daemon.\n10/21/19 16:55:24 Reconfiguring all managed daemons.\n10/21/19 16:55:24 Sent SIGHUP to CKPT_SERVER (pid 15205)\n10/21/19 16:55:24 Sent SIGHUP to STARTD (pid 15162)\n10/21/19 16:55:24 Started DaemonCore process \"/usr/sbin/condor_startd\", pid and pgroup = 70026\n10/21/19 16:55:24 The SHARED_PORT (pid 13789) exited with status 0\n10/21/19 16:55:26 Handling daemon-specific command for \"EMFOLLOW_STARTD\"\n10/21/19 16:55:34 Setting ready state 'Ready' for STARTD\n10/21/19 16:56:33 SharedPortEndpoint: failed to touch 0&lt;8E&gt;&lt;E4&gt;^A: No such file or directory\n10/21/19 16:56:33 SharedPortEndpoint: attempting to recreate vanished socket!\n10/21/19 16:56:33 Cancel_Socket: called on non-registered socket!\nCaught signal 11: si_code=1, si_pid=1, si_uid=0, si_addr=0x1\nStack dump for process 10527 at timestamp 1571702193 (18 frames)\n/usr/lib64/libcondor_utils_8_8_5.so(dprintf_dump_stack+0x24)[0x7f83da83aca4]\n/usr/lib64/libcondor_utils_8_8_5.so(_Z17unix_sig_coredumpiP9siginfo_tPv+0x69)[0x7f83da9d44d9]\n/usr/lib64/libpthread.so.0(+0xf630)[0x7f83d8f0a630]\n/usr/lib64/libc.so.6(_IO_vfprintf+0x4a79)[0x7f83d8b7a069]\n/usr/lib64/libc.so.6(__vsnprintf_chk+0x95)[0x7f83d8c42db5]\n/usr/lib64/libcondor_utils_8_8_5.so(vprintf_length+0x3f)[0x7f83da8cb25f]\n/usr/lib64/libcondor_utils_8_8_5.so(vsprintf_realloc+0x4c)[0x7f83da8cb35c]\n/usr/lib64/libcondor_utils_8_8_5.so(_condor_dprintf_va+0x25c)[0x7f83da83a5ec]\n/usr/lib64/libcondor_utils_8_8_5.so(__wrap_dprintf+0x8c)[0x7f83da8c426c]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN10DaemonCore13Cancel_SocketEP6StreamPv+0xbf)[0x7f83da9ae26f]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN18SharedPortEndpoint12StopListenerEv+0x2f)[0x7f83da964a8f]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN18SharedPortEndpoint11SocketCheckEv+0xe4)[0x7f83da965734]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN12TimerManager7TimeoutEPiPd+0x280)[0x7f83da9d24e0]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN10DaemonCore6DriverEv+0x9ce)[0x7f83da9b4a2e]\n/usr/lib64/libcondor_utils_8_8_5.so(_Z7dc_mainiPPc+0x13a9)[0x7f83da9d7c59]\n/usr/sbin/condor_master(main+0x8b)[0x40a81b]\n/usr/lib64/libc.so.6(__libc_start_main+0xf5)[0x7f83d8b4f545]\n/usr/sbin/condor_master[0x40a98f]\n</pre></div>\n\n\n<p></p><div class=\"code\">\n<pre class=\"code\">[root@node2063 condor]# file core.10527\ncore.10527: ELF 64-bit LSB core file x86-64, version 1 (SYSV), SVR4-style, from '/usr/sbin/condor_master -f', real uid: 0, effective uid: 0, real gid: 0, effective gid: 0, execfn: '/usr/sbin/condor_master', platform: 'x86_64'\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Oct-26 14:30:27 by anderson:</em> <br/>\n\nHere are a few more condor_master segfaults,\n\n<p>Node 2062,\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">10/22/19 11:11:16 SharedPortEndpoint: failed to touch &lt;F0&gt;eB^B: No such file or directory\n10/22/19 11:11:16 SharedPortEndpoint: attempting to recreate vanished socket!\n10/22/19 11:11:16 Cancel_Socket: called on non-registered socket!\nCaught signal 11: si_code=2, si_pid=37895568, si_uid=0, si_addr=0x2423D90\nStack dump for process 10331 at timestamp 1571767876 (4 frames)\n/usr/lib64/libcondor_utils_8_8_5.so(dprintf_dump_stack+0x24)[0x7f5f877feca4]\n/usr/lib64/libcondor_utils_8_8_5.so(_Z17unix_sig_coredumpiP9siginfo_tPv+0x69)[0x7f5f879984d9]\n/usr/lib64/libpthread.so.0(+0xf630)[0x7f5f85ece630]\n[0x2423d90]\n10/22/19 11:12:38 ******************************************************\n10/22/19 11:12:38 ** condor_master (CONDOR_MASTER) STARTING UP\n</pre></div>\n\n\n<p>Where gdb reports,\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">(gdb) where\n#0  0x00007f5f85b27647 in kill () at ../sysdeps/unix/syscall-template.S:81\n#1  0x00007f5f87998594 in unix_sig_coredump (signum=11, s_info=&lt;optimized out&gt;)\n    at /usr/src/debug/condor-8.8.5/src/condor_daemon_core.V6/daemon_core_main.cpp:769\n#2  &lt;signal handler called&gt;\n#3  0x0000000002423d90 in ?? ()\n#4  0x00007f5f8791007a in Stream::peer_description (this=this@entry=0x2426640)\n    at /usr/src/debug/condor-8.8.5/src/condor_io/stream.cpp:1800\n#5  0x00007f5f87972258 in DaemonCore::Cancel_Socket (this=0x2403d50,\n    insock=insock@entry=0x2426640, prev_entry=prev_entry@entry=0x0)\n    at /usr/src/debug/condor-8.8.5/src/condor_daemon_core.V6/daemon_core.cpp:1868\n#6  0x00007f5f87928a8f in SharedPortEndpoint::StopListener (this=this@entry=0x24265c0)\n    at /usr/src/debug/condor-8.8.5/src/condor_io/shared_port_endpoint.cpp:240\n#7  0x00007f5f87929734 in SharedPortEndpoint::SocketCheck (this=0x24265c0)\n    at /usr/src/debug/condor-8.8.5/src/condor_io/shared_port_endpoint.cpp:770\n#8  0x00007f5f879964e0 in TimerManager::Timeout (this=0x2427f50,\n    pNumFired=pNumFired@entry=0x7fffb943b21c, pruntime=pruntime@entry=0x7fffb943b238)\n    at /usr/src/debug/condor-8.8.5/src/condor_daemon_core.V6/timer_manager.cpp:470\n#9  0x00007f5f87978a2e in DaemonCore::Driver (this=0x2403d50)\n    at /usr/src/debug/condor-8.8.5/src/condor_daemon_core.V6/daemon_core.cpp:3464\n#10 0x00007f5f8799bc59 in dc_main (argc=1, argc@entry=2, argv=0x7fffb943bb80,\n    argv@entry=0x7fffb943bb78)\n    at /usr/src/debug/condor-8.8.5/src/condor_daemon_core.V6/daemon_core_main.cpp:2823\n#11 0x000000000040a81b in main (argc=2, argv=0x7fffb943bb78)\n    at /usr/src/debug/condor-8.8.5/src/condor_master.V6/master.cpp:1853\n</pre></div>\n\n\n<p>And node2065,\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">10/21/19 17:44:47 Started DaemonCore process \"/usr/sbin/condor_startd\", pid and pgroup = 133937\n10/21/19 17:44:58 Setting ready state 'Ready' for STARTD\nCaught signal 11: si_code=128, si_pid=0, si_uid=0, si_addr=0x0\nStack dump for process 10410 at timestamp 1571732336 (16 frames)\n/usr/lib64/libcondor_utils_8_8_5.so(dprintf_dump_stack+0x24)[0x7fb36ad61ca4]\n/usr/lib64/libcondor_utils_8_8_5.so(_Z17unix_sig_coredumpiP9siginfo_tPv+0x69)[0x7fb36aefb4d9]\n/usr/lib64/libpthread.so.0(+0xf630)[0x7fb369431630]\n/usr/lib64/libc.so.6(_IO_vfprintf+0x4a79)[0x7fb3690a1069]\n/usr/lib64/libc.so.6(__vsnprintf_chk+0x95)[0x7fb369169db5]\n/usr/lib64/libcondor_utils_8_8_5.so(vprintf_length+0x3f)[0x7fb36adf225f]\n/usr/lib64/libcondor_utils_8_8_5.so(vsprintf_realloc+0x4c)[0x7fb36adf235c]\n/usr/lib64/libcondor_utils_8_8_5.so(_condor_dprintf_va+0x25c)[0x7fb36ad615ec]\n/usr/lib64/libcondor_utils_8_8_5.so(__wrap_dprintf+0x8c)[0x7fb36adeb26c]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN18SharedPortEndpoint11SocketCheckEv+0xc2)[0x7fb36ae8c712]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN12TimerManager7TimeoutEPiPd+0x280)[0x7fb36aef94e0]\n/usr/lib64/libcondor_utils_8_8_5.so(_ZN10DaemonCore6DriverEv+0x9ce)[0x7fb36aedba2e]\n/usr/lib64/libcondor_utils_8_8_5.so(_Z7dc_mainiPPc+0x13a9)[0x7fb36aefec59]\n/usr/sbin/condor_master(main+0x8b)[0x40a81b]\n/usr/lib64/libc.so.6(__libc_start_main+0xf5)[0x7fb369076545]\n/usr/sbin/condor_master[0x40a98f]\n10/22/19 01:19:59 ******************************************************\n10/22/19 01:19:59 ** condor_master (CONDOR_MASTER) STARTING UP\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Oct-29 16:33:32 by gthain:</em> <br/>\n\nNote that all the above stack traces should be cured by this patch.\n\n<p></p><hr/>\n<em>2019-Oct-30 10:19:08 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-05 09:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/50304004e33d2575c09cd6e3ee6accd1f58cb05f\">[58366]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7335\" onclick=\"get_ticket_and_populate_wrapper('7335'); return false;\" title=\"Turning off shared port crashes condor_master\">#7335</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-30 10:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c261c9b851f1900bb79c9dc096ca451c7fc4bdf3\">[58295]</a></span>: Disable timer when shared port is reconfiged off to avoid master crash <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7335\" onclick=\"get_ticket_and_populate_wrapper('7335'); return false;\" title=\"Turning off shared port crashes condor_master\">#7335</a></span> Committer: Tim Theisen  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-23 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ff9162a8d3ac35cfc489d9fe3e43c535b0d4c40f\">[58248]</a></span>: Disable timer when shared port is reconfiged off to avoid master crash <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7335\" onclick=\"get_ticket_and_populate_wrapper('7335'); return false;\" title=\"Turning off shared port crashes condor_master\">#7335</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Nov-05 09:55", "status": "resolved", "created": "2019-Oct-21 19:28", "fixed_version": "2019-Oct-21 19:28", "broken_version": "v080805", "priority": "1", "subsystem": "DaemonMaster", "assigned_to": "tim", "derived_from": "#7254", "creator": "anderson", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "", "due_date": ""}