{"id": 4089, "title": "Ticket #4089: errno trashed by threading code for some IO operations", "description": "<blockquote>\nBlocking I/O operations in condor_read(), condor_write(), and Selector are surrounded by thread calls that allow other threads to run while the I/O blocks. After the operation completes, errno (or WSAGetLastError() on win32) is checked on failure. However, stop_thread_safe() makes calls that can overwrite that error code. The callers need to save errno/WSAGetLastError() before calling stop_thread_safe().</blockquote>", "remarks": "<blockquote>\n<em>2013-Nov-22 13:16:20 by tannenba:</em> <br/>\n\nAre you sure this code is needed?\n\n<p>My aging memory seems to recall that on with glibc, when using pthreads, <a class=\"external\" href=\"http://www.ibm.com/developerworks/aix/library/au-errnovariable/\">errno is stored in thread local storage automagically</a>.  And on Windows, <a class=\"external\" href=\"http://www.gamedev.net/topic/92012-wsagetlasterror-and-threaded-clients/\">WSAGetLastError info is also stored in thread local storage</a> iirc.\n\n</p><p>I guess I never knew anything about MacOS...\n\n</p><p></p><hr/>\n<em>2013-Nov-22 13:24:45 by tannenba:</em> <br/>\n\nOh, maybe you are saying that system calls inside of stop_thread_safe() can trash the errno sitting in TLS?\n\n<p>Maybe it would be better to protect errno inside of stop_thread_safe()...\n\n</p><p></p><hr/>\n<em>2013-Dec-06 13:35:25 by jfrey:</em> <br/>\n\nI don't think it matters much whether errno is saved inside or outside of stop_thread_safe(). I did it outside because in the future, there could be callers that don't care about errno.\n\n<p></p><hr/>\n<em>2013-Dec-09 15:10:25 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong> Approved.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-20 15:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54ce23cb3b248219937584393f0efe1307868154\">[38779]</a></span>: error trashed by threading code for some IO operations. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4089\" onclick=\"get_ticket_and_populate_wrapper('4089'); return false;\" title=\"errno trashed by threading code for some IO operations\">#4089</a></span> Save errno (or WSAGetLastError() on win32) before calls to stop_thread_safe() if we're interested in the value. stop_thread_safe() makes calls (like dprintf()) that may overwrite the error value.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Dec-09 15:10", "status": "resolved", "created": "2013-Nov-20 15:35", "fixed_version": "2013-Nov-20 15:35", "broken_version": "v080000", "priority": "3", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "#17", "creator": "jfrey", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "jfrey@cs.wisc.edu", "due_date": ""}