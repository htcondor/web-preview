{"id": 5828, "title": "Ticket #5828: Initial Singularity support", "description": "<blockquote>\nCMS / OSG / WLCG is starting to look seriously at singularity (<a class=\"external\" href=\"http://singularity.lbl.gov\">http://singularity.lbl.gov</a>).\n\n<p>It is indeed Yet Another Approach to containers, but has several features that make it heavily oriented toward batch systems.\n\n</p><p>Instead of a separate daemon, it is a single setuid executable.  Its images (can be a raw disk image or loopback device) are meant to be read-only with a few scratch directories.  The focus is on providing alternate OS environments for batch system users - hence there's no treatment / isolation of networking and does not try to own the cgroups for the job.\n\n</p><p>It is also not quite as heavy hammer as glexec - for example, if you use singularity to contain a payload job, you do not need to change UIDs.  This resolves an immense number of problems that we see in glexec from surprising batch systems with processes inside a job that are not the same UID as the job itself.\n\n</p><p>Here is a summary of the changes:\n</p><ul>\n<li><code>condor_startd</code> detects the presence of singularity and tests to see if it is functional, then the machine ad advertises HasSingularity=True if it is found, along with version info. (just like Docker, Java, etc)\n</li><li>Setting <code>SINGULARITY_JOB = true</code> forces the job to be run inside singularity. Evaluated in the context of the job (TARGET) and machine (MY) ad.\n</li><li><code>SINGULARITY_IMAGE_EXPR</code> specifies the image.  Evaluated in the context of the job (TARGET) and machine (MY) ad.\n</li><li><code>SINGULARITY</code> overrides the default path to the <code>singularity</code> binary.\n</li><li><code>MOUNT_UNDER_SCRATCH</code> is respected.\n</li><li>Currently, specifying both USE_PID_NAMESPACES=True and SINGULARITY_JOB evaluating to True is not supported and will result in failure to start jobs. Need some improvement here?\n</li><li>HTCondor automatically bind mounts the <code>$_CONDOR_SCRATCH_DIR</code> and IWD.\n</li></ul>\n\n<p>(additionally, singularity options can be set in <code>/etc/singularity/singularity.conf</code>).\n\n</p><p>On modern platforms (Ubuntu and Fedoras - almost anything past RHEL7), Singularity can run <strong>without</strong> the setuid bit.  As part of the support detection, we ought to automatically switch to the non-setuid version if we detect it is working.  In such a future, if HTCondor had reasonably good <code>singularity</code> support, we can start to discuss dropping the <code>glexec</code> code.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Aug-29 10:14:51 by bbockelm:</em> <br/>\n\nNote that to use the branch, one needs the current <code>HEAD</code> of singularity's <code>master</code> branch as we rely on features not yet in a release.\n\n<p>I currently estimate that the next <code>singularity</code> release will come out in October 2017.\n\n</p><p></p><hr/>\n<em>2016-Nov-10 08:17:59 by tannenba:</em> <br/>\n\nMerged into V8_5_8-branch\n\n<p>Thanks for the patch!  Updated some notes above.\n\n</p><p></p><hr/>\n<em>2016-Nov-10 09:53:55 by wenger:</em> <br/>\n\nBrian, could you attach an example config and submit file to this ticket?  That would help a lot in writing the documentation.\n\n<p></p><hr/>\n<em>2016-Nov-10 10:16:46 by tim:</em> <br/>\n\nI think that this work is preliminary.\n\n<p>Here are the plans from Brian Bockelman's email on October 29th:\n</p><div class=\"verbatim\">\n<pre>- Merge the existing branch into 8.5.8.  Document just the raw variables.\n  - hence, the \"raw\" integration is available in 8.6.0.\n  - this allows integrators and glideinWMS to add support in 2017 instead of 2018.\n- Add first class condor_submit support in the 8.7.x series.\n  - Expect that users really start to pick this up in 8.8.x.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2016-Nov-11 15:20:02 by bbockelm:</em> <br/>\n\nHere's an example config file:\n<div class=\"verbatim\">\n<pre># Only set if Singularity is not in $PATH.\n#SINGULARITY = /opt/singularity/bin/singularity\n# Forces _all_ jobs to run inside singularity.\nSINGULARITY_JOB = true\n# Forces all jobs to use the CernVM-based image.\nSINGULARITY_IMAGE_EXPR = \"/cvmfs/cernvm-prod.cern.ch/cvm3\"\n# Maps $_CONDOR_SCRATCH_DIR on the host to /srv inside the image.\nSINGULARITY_TARGET_DIR = /srv\n# Writable scratch directories inside the image.  Auto-deleted after the job exits.\nMOUNT_UNDER_SCRATCH = /tmp, /var/tmp\n</pre></div>\n\n\n<p>This provides the user with no opportunity to select a specific image.  Here's an example configuration file to allow the user to specify an image path:\n</p><div class=\"verbatim\">\n<pre>SINGULARITY_JOB = !isUndefined(TARGET.SingularityImage)\nSINGULARITY_IMAGE_EXPR = TARGET.SingularityImage\n</pre></div>\n\n\n<p>Then, users could add the following to their submit file:\n</p><div class=\"verbatim\">\n<pre>+SingularityImage = \"/cvmfs/cernvm-prod.cern.ch/cvm3\"\n</pre></div>\n\n(note the quoting)\n\n<p>Finally, let's pick an image based on the OS - not the filename:\n</p><div class=\"verbatim\">\n<pre>SINGULARITY_JOB = (TARGET.DESIRED_OS isnt MY.OpSysAndVer) &amp;&amp; ((TARGET.DESIRED_OS is \"CentOS6\") || (TARGET.DESIRED_OS is \"CentOS7\"))\nSINGULARITY_IMAGE_EXPR = (TARGET.DESIRED_OS is \"CentOS6\") ? \"/cvmfs/cernvm-prod.cern.ch/cvm3\" : \"/cvmfs/cms.cern.ch/rootfs/x86_64/centos7/latest\"\n</pre></div>\n\n\n<p>Then, the user adds to their submit file:\n</p><div class=\"verbatim\">\n<pre>+DESIRED_OS=\"CentOS6\"\n</pre></div>\n\n\n<p>That would cause the job to run on the native host for CentOS6 hosts and inside a CentOS6 container on CentOS7 hosts.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-09 14:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dc1c9bc85998a50c3a74806787475cadc95de035\">[49780]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span>: Added Singularity-related configuration knobs and machine <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> attributes to the docs.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-07 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd75cd4480c38ba862506b87042b4ec086206af4\">[49753]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span>: Added some very simple Singularity documentation -- still needs lots of improvements.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-30 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/387849a9e8ee4eb2c8e9c1e1cb6005383450fe34\">[49691]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span>: Added version history item; still need actual documentation!  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-10 08:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d456048e55b0174809de7a7943cc90ef660868d0\">[49568]</a></span>: Fixups to Singularity support code for non-Linux platoforms. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-23 20:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9405db1e8a7c05bab37e8039af52298f6b13924\">[49287]</a></span>: Update branch for final singularity release. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-23 20:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6e419d64c8a8534a650532a05363f80a853d4347\">[49286]</a></span>: Add support for singularity containers. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span> This adds support for invoking singularity-based containers. Particularly, - condor_starter detects the presence of singularity and advertises accordingly - Setting SINGULARITY_JOB = true forces the job to be run inside singularity - Evaluated in the context\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-29 09:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7b57bff092f99604da7ad5c86ac4483bba90b71e\">[49092]</a></span>: Add support for singularity containers. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5828\" onclick=\"get_ticket_and_populate_wrapper('5828'); return false;\" title=\"Initial Singularity support\">#5828</a></span> This adds support for invoking singularity-based containers. Particularly, - condor_starter detects the presence of singularity and advertises accordingly - Setting SINGULARITY_JOB = true forces the job to be run inside singularity - Evaluated in the context\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Dec-14 09:28", "status": "resolved", "created": "2016-Aug-05 09:18", "fixed_version": "2016-Aug-05 09:18", "broken_version": "", "priority": "4", "subsystem": "DaemonsExecNode", "assigned_to": "wenger", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}