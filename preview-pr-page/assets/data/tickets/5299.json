{"id": 5299, "title": "Ticket #5299: Schedd doesn't correctly write nodes.log file for local universe jobs", "description": "<blockquote>\nIf you have a DAG like this:\n\n<p></p><pre>  JOB A local.sub\n</pre>\n\n<p>and then a local.sub file like this:\n\n</p><p></p><pre>  executable = /bin/sleep\n  arguments=10\n  universe = local\n  queue\n</pre>\n\n<p>only the submit even for the node A job is written into the DAGMan nodes.log file, which causes DAGMan to wait forever for the node A job.  (Note that if you define a log file in local.sub, even if that log file is /dev/null, things work correctly.)</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Oct-08 13:11:56 by wenger:</em> <br/>\n\nThis supposedly worked in 8.2.4.\n\n<p></p><hr/>\n<em>2015-Oct-18 21:36:48 by wenger:</em> <br/>\n\nCreated V8_4-gittrac_5299-branch for this.\n\n<p></p><hr/>\n<em>2015-Oct-22 13:29:06 by wenger:</em> <br/>\n\nHmm -- somehow the change that fixes things for local universe breaks things for vanilla universe.  I'm not sure yet what is going on...\n\n<p></p><hr/>\n<em>2016-Mar-11 18:13:23 by wenger:</em> <br/>\n\nLooks like something in 8.3.1 broke this.  (It fails in 8.3.1, and succeeds on the head of the 8.2 branch.  So it's either something between 8.2.10 and 8.3.0, or, more likely, between 8.3.0 and 8.3.1.)  I'll try 8.3.0 soon to double-check.\n\n<p></p><hr/>\n<em>2016-Mar-14 10:21:55 by wenger:</em> <br/>\n\nAh, I was wrong -- this fails for 8.3.0 also.  So something between 8.2 and 8.3.0 is what broke it...\n\n<p></p><hr/>\n<em>2016-Mar-14 11:07:58 by wenger:</em> <br/>\n\nHmm -- this: <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4283\" onclick=\"get_ticket_and_populate_wrapper('4283'); return false;\" title=\"Improve synchronization of the job log.\">#4283</a></span>: Improve synchronization of the job log looks a little suspicious to me -- that's a change in 8.3.0.  Have to check it out...\n\n<p></p><hr/>\n<em>2016-Mar-14 11:55:48 by wenger:</em> <br/>\n\nLooks like the terminated event is written in LocalUserLog::logTerminate() when things work right...\n\n<p></p><hr/>\n<em>2016-Mar-16 09:15:41 by wenger:</em> <br/>\n\nOkay, I was looking at the 8.2.10 code and wondering how it worked, but now I have the answer -- the 8.2.10 condor_dagman specified 'log = xxx' for the workflow log file (which was probably an error), but in 8.3.0 it specifies 'dagman_log = xxx'.\n\n<p></p><hr/>\n<em>2016-Mar-16 09:59:57 by wenger:</em> <br/>\n\nOkay, the change in commit 46072 makes things work for local universe, but then vanilla universe (see job_dagman_basic, for example), fails with this error:\n\n<p></p><pre>  021 (310.000.-01) 03/16 09:56:33 Error from starter on\n    &lt;128.105.14.228:57106?addrs=128.105.14.228-57106&gt;:\n    in LocalUserLog::logTerminate() ERROR: ClassAd does not define ExitBySignal!\n  ...\n  007 (310.000.000) 03/16 09:56:33 Shadow exception!\n        Error from slot1@manta.cs.wisc.edu: in LocalUserLog::logTerminate()\n        ERROR: ClassAd does not define ExitBySignal!\n        0  -  Run Bytes Sent By Job\n        0  -  Run Bytes Received By Job\n</pre>\n\n<p></p><hr/>\n<em>2016-Mar-21 13:38:37 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good.\n\n</p><p></p><hr/>\n<em>2016-Apr-04 09:45:17 by wenger:</em> <br/>\n\nPut this ticket back into review state and assigned it to Zach, since I re-implemented the fix, and I want to get the new fix reviewed.\n\n<p></p><hr/>\n<em>2016-Apr-18 14:51:26 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looked at the new commits.  All good.\n\n<p></p><hr/>\n<em>2016-Apr-18 15:33:49 by wenger:</em> <br/>\n\nOkay, merged the updated fix to V8_4-branch; I'm going to resolve this ticket.\n\n<p></p><hr/>\n<em>2016-Apr-18 15:34:53 by wenger:</em> <br/>\n\nOh, yeah -- there's already a version history item for the original fix; the update isn't really user-visible, so no new version history item...</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/927/gt5299_diff\">gt5299_diff</a>\n354518 bytes added by wenger on 2016-Mar-14 15:47:06 UTC.\n<br/>\nThis is a diff between V8_2_10 and V8_3_0 -- something in there presumably caused the problem...<br/>\n</li><li><a href=\"../files/928/gt5299-final-diff\">gt5299-final-diff</a>\n4071 bytes added by wenger on 2016-Mar-17 20:37:29 UTC.\n<br/>\nThis is a diff of everything on the branch...<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-28 11:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/21b895a8c8fc5a7ee180b8c3dc0b0dd75ed20417\">[48124]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Made the comments a little more explanatory.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-25 12:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/86e9e920b3aa6d4e923153347a7fb31f2cf400e8\">[48116]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Re-implemented the basic fix in a much cleaner way.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-17 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/559aadc74138ea4a77e9bb0f9f12b63ee4104b82\">[48055]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Fixed up version history for 8.4.5.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-17 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4c80f4f8a3eca35cf151837af871a2f25e8ced28\">[48052]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Final cleanup.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-16 16:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/842630c072b8210e82efe9ce644edd324a5148de\">[48042]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Removed a lot of the diagnostic code.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-16 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4eb5ded9df0793f1e0e539a6551ec2b8d4c9449e\">[48040]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Implemented a fix that seems to work (needs check for std universe), but it's pretty ugly; commit includes a bunch of diagnostic code.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-13 12:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/654686fd806bc9647160da2a30de3279a533528c\">[46256]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>, <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=5350\" onclick=\"get_ticket_and_populate_wrapper('5350'); return false;\" title=\"Combination of node retries with parallel jobs can goof up DAGMan\">#5350</a></span>: Documented these in the 8.4.2 version history. Also fixed some unrelated typos in the version history.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-22 11:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2734c0f305d5165ffbd997fad765a504becfae3c\">[46073]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Committing temporary comments about things I may want to fix...  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-22 11:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c74554076483902bd150e611c12674c6fcc6576b\">[46072]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Actually fixed this -- we just don't bail out of the starter log initialization code so quickly. (But some other tests -- e.g., job_dagman_basic and job_dagman_vars -- are failing now, even if I take out the change. I think something is goofed up with my configuration, but I want to verify\u00a0[...]\n (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-21 08:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eb56ada87e5f568fad43bebe27d6ede0b480f32c\">[46058]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=5299\" onclick=\"get_ticket_and_populate_wrapper('5299'); return false;\" title=\"Schedd doesn't correctly write nodes.log file for local universe jobs\">#5299</a></span>: Changed the job_dagman_local test to reproduce this bug (added a node job that does not specify a log file).  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Apr-18 15:35", "status": "defer", "created": "2015-Oct-08 11:13", "fixed_version": "2015-Oct-08 11:13", "broken_version": "v080307", "priority": "5", "subsystem": "DaemonsSubmitNode", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "wenger@cs.wisc.edu, zmiller@cs.wisc.edu, gthain@cs.wisc.edu, tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}