{"id": 2966, "title": "Ticket #2966: Test combination of PRE_SKIP and recovery", "description": "<blockquote>\n<div class=\"code\">\n<pre class=\"code\">Nathan,\n\nDo we have a test that checks the combination of PRE_SKIP and recovery\nmode?  I'm wondering how/if that would work -- if a PRE_SKIP happens,\ndo we write any event for that node?  If we don't, recovery *won't*\nwork...\n\nKent\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Feb-19 22:14:43 by nwp:</em> <br/>\n\nPushed onto <code>V7_9-gittrac_2966-branch</code>\n\n<p></p><hr/>\n<em>2013-Mar-01 18:26:40 by wenger:</em> <br/>\n\nI committed a few minor cleanups to the code and the test.\n\n<p>I have a few questions/concerns about this, though (not about the actual test, but the way PRE_SKIP is implemented):\n\n</p><p></p><ul>\n<li>In Dag::LogEventNodeLookup(), we should probably make sure the PRE_SKIP event has log notes -- if it somehow doesn't, we'll segfault.\n\n<p></p></li><li>For PRE_SKIP, we change the status of the node in Dag::PreScriptReaper(); I think it would make more sense to follow what we do for POST scripts, and just write the event in the reaper code, and then actually change the node status, etc., when we read the event.  That way the code path in recovery mode would be much closer to the code path in \"normal\" mode.\n\n<p></p></li><li>Since we have the PRE_SKIP event, why do we need to generate dummy submit events, etc., for the node job?  Couldn't we just set the node's status to DONE when we get the PRE_SKIP event?\n\n<p></p></li><li>At the end of the dagman.out file, we get this warning: \"Warning: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadMultipleUserLogs\" title=\"Read Multiple User Logs\">ReadMultipleUserLogs</a></span> destructor called, but still monitoring 1 log(s)!\"  This would seem to indicate that we're not unmonitoring some log file when we should.\n</li></ul>\n\n<p></p><hr/>\n<em>2013-Mar-04 16:45:22 by nwp:</em> <br/>\n\nIn the event-reading code in <code>condor_event.cpp</code>, we make sure that the PRESKIP event has a DAG Node; otherwise we return failure.  I added an additional check in DAGMan proper to handle this.\n\n<p>Setting the Node Status to DONE is much cleaner than all the crazy business I was trying to do.  This is now implemented.\n\n</p><p>Finally, after we read the PRESKIP event, we then unmonitor the logreader.  This takes care of the \"...but still monitoring 1 log...\" message.\n\n</p><p></p><hr/>\n<em>2013-Mar-04 19:14:37 by wenger:</em> <br/>\n\nWhen I run the job_dagman_recovery_preskip.run test with the latest version, I fail an assertion:\n\n<p></p><pre>  ERROR \"Assertion ERROR on (isNoop == node-&gt;GetNoop())\" at line 1325 in file\n  /scratch/wenger/condor_build/git5/CONDOR_SRC/src/condor_dagman/dag.cpp\n</pre>\n\n<p>Also, I think the test script should delete the lock file (job_dagman_recovery_preskip.dag.lock) if it exists, just in case we have one hanging around for some reason.\n\n</p><p></p><hr/>\n<em>2013-Mar-04 22:17:53 by nwp:</em> <br/>\n\nI think I took care of this last one: <a class=\"external\" href=\"http://submit-2.batlab.org/results/run-details.php?runid=105796\">NMI Run 105796</a>  I will push after everything is green.\n\n<p></p><hr/>\n<em>2013-Mar-05 07:11:08 by nwp:</em> <br/>\n\npushed, because tests are green.\n\n<p></p><hr/>\n<em>2013-Mar-05 17:35:07 by wenger:</em> <br/>\n\nI committed a few more cleanups -- assuming the tests are green, you can go ahead and merge this to the trunk...\n\n<p></p><hr/>\n<em>2013-Mar-06 11:08:52 by nwp:</em> <br/>\n\nRebased and pushed onto master</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-06 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/488228b2da943ea673a2e8885769b0d8f6000bb3\">[35078]</a></span>: Recover from PRE_SKIP <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2966\" onclick=\"get_ticket_and_populate_wrapper('2966'); return false;\" title=\"Test combination of PRE_SKIP and recovery\">#2966</a></span> This is for recovery in DAGman. If we need to enter recovery mode, then we need to have the events in the DAG so that recovery can proceed.\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-06 10:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ad919ef9acd4fdaf64c1e1680e9cb8b62fb26eec\">[35079]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2966\" onclick=\"get_ticket_and_populate_wrapper('2966'); return false;\" title=\"Test combination of PRE_SKIP and recovery\">#2966</a></span>: made a few cleanups to the PRE_SKIP code and the corresponding test. Committer: Nathan W. Panike  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Aug-07 11:53", "status": "resolved", "created": "2012-May-02 14:14", "fixed_version": "2012-May-02 14:14", "broken_version": "", "priority": "3", "subsystem": "Dag", "assigned_to": "nwp", "derived_from": "#2122", "creator": "nwp", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu", "due_date": ""}