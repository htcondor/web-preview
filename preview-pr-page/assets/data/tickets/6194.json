{"id": 6194, "title": "Ticket #6194: Add signal handler to openmpiscript", "description": "<blockquote>\nPer feedback from H. van Pee via condor-users and personal email. Make sure <code>#!</code> line points (portably) to bash so that shells that do not use bash by default are not confused. Add signal handling as <code>condor_rm</code> may leave hung processes.\n\n<p>Suggested code improvement (H. van Pee):\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#begin signal handler part of openmpiscript from htcondor 8.4.1:\n#!/bin/bash\n# comments\nMY_MPIRUN_PID=0\nfunction mpi_clean_up {\n\n        # Perform program exit housekeeping\necho \"openmpiscript \" $MY_MPIRUN_PID\nif [ \"$MY_MPIRUN_PID\" -ne \"0\" ]; then\n        echo \"The PID is not zero, I will TERM mpirun\"\n        kill -SIGTERM $MY_MPIRUN_PID\n        sleep 60\n        sshd_cleanup\n        rm -f machines\nfi\nexit\n}\ntrap mpi_clean_up SIGTERM\n\n\n# original code until mpirun\n\n\n## run the actual mpijob\nif `ompi_info --param all all | grep orte_rsh_agent 1&gt;/dev/null 2&gt;&amp;1`\nthen\nmpirun -v --prefix $MPDIR --mca orte_rsh_agent $CONDOR_SSH -n\n$_CONDOR_NPROCS -hostfile machines $EXECUTABLE $@ &amp;\nelse\n########## For mpi versions 1.1 &amp; 1.2 use the line below\nmpirun -v --mca plm_rsh_agent $CONDOR_SSH -n $_CONDOR_NPROCS -hostfile\nmachines $EXECUTABLE $@ &amp;\nfi\nMY_MPIRUN_PID=$!\nwait $MY_MPIRUN_PID\n\nsshd_cleanup\nrm -f machines\n\nexit $?\n\n#end begin signal handler part of openmpiscript from htcondor 8.4.1\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2017-Apr-04 13:10:14 by jpatton:</em> <br/>\n\nHandler added in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55261e11fa2d9806b1c6617103a6cb4251d05408\">[50380]</a></span>. Some differences between the suggested code is that the cleanup function was added later in the script (but before it could be called) so that it comes after the parameters that a user might want to change.\n\n<p>Additionally, a suggestion has been made to add explicit killing of sshd in sshd_cleanup. The mpi proxies have been reported to continue executing on nodes after a condor_rm is issued.\n\n</p><p></p><hr/>\n<em>2017-Apr-14 14:44:57 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good.\n\n</p><p></p><hr/>\n<em>2017-Apr-20 14:21:39 by tim:</em> <br/>\n\n<strong>DOC REVIEW:</strong> version history needs to be in the 8.6 version history on the 8.6.2 branch</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-20 14:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/883a8fb817138af0a14e290a082f5e97fcc4a6bd\">[50522]</a></span>: Removing version history from 8.7.x (should be in 8.6.x) <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6194\" onclick=\"get_ticket_and_populate_wrapper('6194'); return false;\" title=\"Add signal handler to openmpiscript\">#6194</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-20 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e7d5b2e6d1b5bc991a000a849f4d2329798ad2eb\">[50521]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6194\" onclick=\"get_ticket_and_populate_wrapper('6194'); return false;\" title=\"Add signal handler to openmpiscript\">#6194</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Apr-20 13:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0b4e0cd80a68e276b431ba7ce037f61e9c53bb6a\">[50519]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6194\" onclick=\"get_ticket_and_populate_wrapper('6194'); return false;\" title=\"Add signal handler to openmpiscript\">#6194</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-30 15:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55261e11fa2d9806b1c6617103a6cb4251d05408\">[50380]</a></span>: Add signal handling to openmpiscript <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6194\" onclick=\"get_ticket_and_populate_wrapper('6194'); return false;\" title=\"Add signal handler to openmpiscript\">#6194</a></span> Also: Use bash explicitly (for now), use modern $(..) notation instead of backticks.  (By Jason Patton )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Apr-20 15:12", "status": "resolved", "created": "2017-Mar-16 10:37", "fixed_version": "2017-Mar-16 10:37", "broken_version": "v080601", "priority": "2", "subsystem": "Parallel", "assigned_to": "jpatton", "derived_from": "#6024", "creator": "jpatton", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20170331"}