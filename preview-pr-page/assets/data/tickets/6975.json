{"id": 6975, "title": "Ticket #6975: Collector segfaults in cedar authorization checking limited password2", "description": "<blockquote>\naa522f618ebe3c7328071c2f100228164b6b1fb8 <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6947\" onclick=\"get_ticket_and_populate_wrapper('6947'); return false;\" title=\"Extend PASSWORD auth to support multiple and derived secrets\">#6947</a></span> introduced collector segfault\nwhen checking daemon commands without a previous policy.</blockquote>", "remarks": "<blockquote>\n<em>2019-Apr-02 13:35:22 by tlmiller:</em> <br/>\n\nI don't know what's up with m_policy, but it seems prudent to make sure that this is just Bockelman missing an acceptable case and not an indication of a more serious problem.\n\n<p></p><hr/>\n<em>2019-Apr-05 17:02:08 by tlmiller:</em> <br/>\n\nBockelman says, \"Probably just didn\u2019t read the code carefully enough to realize that m_policy could be unset.  Nothing too deep.\"\n\n<p>Nonetheless, GregT and I would like to dig a little deeper and make sure, for instance, that the code ever executes.\n\n</p><p>(GregT reports this happens every time when starting a personal condor as root.  I should try to reproduce.)\n\n</p><p></p><hr/>\n<em>2019-Apr-08 12:24:50 by tlmiller:</em> <br/>\n\nIs it OK for m_policy to be NULL at the patched location?  (Maybe it always had been, but isn't if TOKEN auth is used?)\n\n<p></p><hr/>\n<em>2019-Apr-08 12:40:32 by tlmiller:</em> <br/>\n\nnotes:\n\n<p>The check is in DaemonCommandProtocol::VerifyCommand(), which is always? called after DCP::AuthenticateFinish(), which has a pair of unchecked writes to m_policy.\n\n</p><p>m_policy is set in DCP::ReadCommand(), which happends before DCP::VerifyCommand:\n</p><ul>\n<li>if creating a new session, by ReconcileSecurityPolicyAds(), which will fail if m_policy is NULL;\n</li><li>if using a cached session, AND that session has a policy, by copying it from the cached session.  Code immediately following checks to is m_policy is set, suggesting that it's OK for a cached session not to have a policy.  (?!)\n</li></ul>\n\n<p>The other way to get to DCP::VerifyCommand() is if the command being issued is \"old-style\", meaning issued without DC_AUTHENTICATE.  (See line 1035 of daemon_command.cpp.)  I don't know if the \"old-style\" is still in general use any more.\n\n</p><p>DCP::Authenticate() also assumes that m_policy exists (but it is initialized to NULL).\n\n</p><p></p><hr/>\n<em>2019-May-20 13:48:11 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-02 03:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c2027f9c6c7966ecae15b7cd2980d3c2e0db4341\">[56483]</a></span>: Fix collector segfault <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6975\" onclick=\"get_ticket_and_populate_wrapper('6975'); return false;\" title=\"Collector segfaults in cedar authorization checking limited password2\">#6975</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-May-20 13:49", "status": "resolved", "created": "2019-Apr-02 01:58", "fixed_version": "2019-Apr-02 01:58", "broken_version": "v080902", "priority": "1", "subsystem": "DaemonsCM", "assigned_to": "gthain", "derived_from": "#6947", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, gthain@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": "2019-04-12"}