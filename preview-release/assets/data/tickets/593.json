{"id": 593, "title": "Ticket #593: Negotiator ASSERT: resource_hash.insert fails.", "description": "<blockquote>\n<a class=\"external\" href=\"http://sourceforge.net/mailarchive/forum.php?thread_name=CE25ADD5-068D-486A-A492-DFE0A1CF422E%40crystal.harvard.edu&amp;forum_name=osgmm-discuss\">User report from this public mailing list post</a>\n<div class=\"code\">\n<pre class=\"code\">6/22 14:41:25 ---------- Started Negotiation Cycle ----------\n6/22 14:41:25 Phase 1:  Obtaining ads from collector ...\n6/22 14:41:25   Getting all public ads ...\n6/22 14:41:25   Sorting 175 ads ...\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25 Can't evaluate STARTD_AD_REEVAL_EXPR target.UpdateSequenceNumber &gt; my.UpdateSequenceNumber as a bool, treating as TRUE\n6/22 14:41:25   Getting startd private ads ...\n6/22 14:41:25 Got ads: 175 public and 123 private\n6/22 14:41:25 Public ads include 6 submitter, 137 startd\n6/22 14:41:25 Phase 2:  Performing accounting ...\n6/22 14:41:25 ERROR \"Assertion ERROR on (resource_hash.insert( ResourceName, ResourceAd ) == 0)\" at line 785 in file Accountant.cpp\n</pre></div>\n\n\n<p>resource_hash is a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HashTable\" title=\"Hash Table\">HashTable</a></span>.  The only reason it can fail is because <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResourceName\" title=\"Resource Name\">ResourceName</a></span> is already present in resource_hash.  The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResourceName\" title=\"Resource Name\">ResourceName</a></span> is formed by the Name and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartdIpAddr\" title=\"Startd Ip Addr\">StartdIpAddr</a></span> found in the resource ad.  (Accountant.cpp:1010ish Accountant::GetResourceName).\n\n</p><p>Even if the bug proves to the in what the collector sends to the negotiator, is crashing really the correct response?  At the very least shouldn't we emit something helpful like, \"The collector appears to be malfunctioning?\"\n\n</p><p>If you provide a solution, please reply to <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2009-June/msg00082.shtml\">this condor-users email</a>, as let adesmet know so he can reply to <a class=\"external\" href=\"http://sourceforge.net/mailarchive/forum.php?thread_name=CE25ADD5-068D-486A-A492-DFE0A1CF422E%40crystal.harvard.edu&amp;forum_name=osgmm-discuss\">this OSGMM-discuss email</a>.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Jun-22 16:03:13 by adesmet:</em> <br/>\n\nI asked the original reported to send along a \"condor_status -l\" if he sees this again.  That should clear up if the negotiator is incorrectly holding duplicate ads.\n\n<p></p><hr/>\n<em>2009-Jun-22 16:14:39 by matt:</em> <br/>\n\nIt seems somewhat strange that there are 137 startd ads and 123 private.\n\n<p></p><hr/>\n<em>2009-Jun-23 17:19:48 by adesmet:</em> <br/>\n\nMany (all?) of the Machine ads are being condor_advertised (possibly SOAPed?) into the collector by an external system.  This might explain the private/startd discrepency; I'm not sure such ads end up with a private parter.\n\n<p>The user has reproduced the bug.  He got me the condor_status -l while it was crashing.  The truncated output is attached.  Observe that the ads have the same 'Name = \"BNL_ATLAS_1\"'.  I don't believe the collector should have allowed that in the first place, and I believe it will give the negotiator indigestion.\n\n</p><p></p><hr/>\n<em>2009-Jun-23 17:25:11 by adesmet:</em> <br/>\n\nThe two ads excerpted in the attachment are almost identical.  Most of the changes are minor numbers that one would expect to change from update to update.  However, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartdIpAddr\" title=\"Startd Ip Addr\">StartdIpAddr</a></span> is different.\n\n<p></p><hr/>\n<em>2009-Jun-24 07:13:14 by matt:</em> <br/>\n\nSee condor_collector.V6/hashkey.cpp::makeStartdAdHashKey for how the Collector hashes these ads.\n\n<p>You'll notice that the hashkey for a Startd is actually a pair ([Name|Machine[:SlotId]], <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartdIpAddr\" title=\"Startd Ip Addr\">StartdIpAddr</a></span>), the ads attached have the same Name and different <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartdIpAddr\" title=\"Startd Ip Addr\">StartdIpAddr</a></span>. So they don't hash to the same thing.\n\n</p><p>It is possible the Negotiator doesn't follow the same rules when constructing its hash and gets a collision.\n\n</p><p></p><hr/>\n<em>2009-Jun-24 17:30:17 by adesmet:</em> <br/>\n\nReproduced using attached ads simply condor_advertised into the collector.\n\n<p></p><hr/>\n<em>2009-Jun-24 17:44:41 by adesmet:</em> <br/>\n\nCheck before closing ticket: Current investigation suggests there is a glitch somewhere between the collector and negotiator where the StartdIPAddr gets mangled.  <em>Why doesn't this hose the collector when a startd restarts on a different port while the old ad is still present?</em>\n\n<p>Update: all is probably well.  I believe the bug only occurs if WantAdReevaluate==TRUE in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MachineAd\" title=\"Machine Ad\">MachineAd</a></span>.\n\n</p><p></p><hr/>\n<em>2009-Jun-24 18:08:12 by adesmet:</em> <br/>\n\nBug:\n\n<p>If the job says WantAdReevalute=true, the negotiator checks the stashedAds list for a previous copy and decides if it should use the stashed copy or the new copy.  However, it only distinguishes ads based on the Name.  So if two ads have the same Name, one will get stomped over.  The most obvious fix is to add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartdIpAddr\" title=\"Startd Ip Addr\">StartdIpAddr</a></span> to key used by stashedAds.  All relevant calls to stashedAds appear to be in Matchmaker::obtainAdsFromCollector in matchmaker.cpp.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/60/condor_status.txt\">condor_status.txt</a>\n12614 bytes added by adesmet on 2009-Jun-23 22:21:59 UTC.\n<br/>\nOutput of condor_status.  Shows a number of entries with identical Names.<br/>\n</li><li><a href=\"../files/61/condor_status-l-truncated.txt\">condor_status-l-truncated.txt</a>\n14065 bytes added by adesmet on 2009-Jun-23 22:22:55 UTC.\n<br/>\nFirst two Machine <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> out of condor_status -l. The two ads have identical Names.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jul-02 12:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/00a4b5602e771e82310c45a1cd71616a94f6306c\">[24866]</a></span>: Document fix to negotiator <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=593\" onclick=\"get_ticket_and_populate_wrapper('593'); return false;\" title=\"Negotiator ASSERT: resource_hash.insert fails.\">#593</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jul-02 11:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/702cc4b186ce87259632cc2b4e8c6c49722c164e\">[15004]</a></span>: Correctly hash machine ads on Name and StartdIPAddr <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=593\" onclick=\"get_ticket_and_populate_wrapper('593'); return false;\" title=\"Negotiator ASSERT: resource_hash.insert fails.\">#593</a></span> Correctly hash machine ads on Name and StartdIPAddr, just like the collector. Failing to do so meant that we would be handed two otherwise distinct ads from the collector, then proceed to erroneously consider them one, eventually blowing an ASSERT.\u00a0[...]\n (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-17 17:34", "status": "resolved", "created": "2009-Jun-22 15:20", "fixed_version": "2009-Jun-22 15:20", "broken_version": "v070201", "priority": "2", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu", "due_date": ""}