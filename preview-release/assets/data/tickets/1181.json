{"id": 1181, "title": "Ticket #1181: 32-bit procapi (procd) fails to see some processes on 64-bit systems", "description": "<blockquote>\nWhen condor is compiled 32-bit, procapi cannot see entries in /proc when those entries happen to have inodes that do not fit in the 32-bit ino_t.  This is because readdir() skips over such entries.\n\n<p>We found two possible workarounds.  One is to use readdir64().  The other is to use glob(), which probably internally uses readdir64().  The former seems the better choice, since it is a smaller code change and more explicitly addresses the problem.\n\n</p><p>The environment in which we happened to notice this had /proc/sys/kernel/pid_max set to a big number (4 million) rather than the default 32768.  This led us to believe that the problem had something to do with large PID values.  However, we do not know of any reason why small PIDs would be protected from having 64-bit ino values.\n\n</p><p>The failure mode we observed is that if the procd does not see its own parent PID, then it exits immediately with the message \"ERROR: master has exited\".  This caused condor to accept jobs but to fail when trying to launch the starter.\n\n</p><p>The environment where this problem was observed: SL5.3 x86_64 system with kernel 2.6.18-164.9.1.el5.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-09 09:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7206856b488f1d7c9ad6aab1e74bf46e8af8162c\">[17136]</a></span>: Fixed AIX compilation problem with rewinddir(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-08 16:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4a5c551a998a694a01ebf70e13a930972d59c188\">[17126]</a></span>: Made directory object use readdir64() as well. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span> Refactored recent patch to procapi to use same solution in directory object.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-08 12:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7e706835d4112b9a79b808428f222adc28f17c11\">[17122]</a></span>: Fix 64-bit directory-reading calls on AIX. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span> The calls to open and read a directory in 64 bits on AIX are slightly different than on other platforms. Committer: Dan Bradley  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-06 21:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8bef022bc866d966232c456100337526a76d0bff\">[17118]</a></span>: Fix for AIX and HPUX readdir64() compilation problem. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-06 10:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5ddb0f29054221d320b944667fb811f896107184\">[17113]</a></span>: Fix 64-bit directory-reading calls on AIX. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span> The calls to open and read a directory in 64 bits on AIX are slightly different than on other platforms.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-05 18:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2983ee1777bb0c6b3caba1fbfa7b47319ed3575d\">[25252]</a></span>: Documented fix for 32-bit procapi not seeing some processes in 64-bit environments. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-05 17:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2c1250b5a9871da8e4d804860abe84ac5bfa6f97\">[17109]</a></span>: Fixed problem with 32-bit procapi not seeing some processes on 64-bit systems. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1181\" onclick=\"get_ticket_and_populate_wrapper('1181'); return false;\" title=\"32-bit procapi (procd) fails to see some processes on 64-bit systems\">#1181</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Feb-06 20:17", "status": "resolved", "created": "2010-Feb-04 13:02", "fixed_version": "2010-Feb-04 13:02", "broken_version": "v070400", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "sfiligoi@fnal.gov,dan@hep.wisc.edu", "due_date": ""}