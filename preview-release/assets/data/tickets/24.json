{"id": 24, "title": "Ticket #24: Port Condor to Debian 5.0 (Lenny)", "description": "<blockquote>\nLIGO has made a formal request for Condor to be fully ported to the Debian 5.0 (Lenny) distribution of Linux to be ready to test by March 2009.\n\n<p>Usable machines in NMI:\n<table border=\"1\" cellspacing=\"0\">\n<tbody><tr>\n<td>\nx86_debian_5.0</td>\n<td>\nnmi-0199</td>\n<td>\nx86</td>\n</tr>\n\n<tr>\n<td>\nx86_64_debian_5.0</td>\n<td>\nnmi-0200</td>\n<td>\nx86_64</td>\n</tr>\n</tbody></table></p></blockquote>", "remarks": "<blockquote>\n<em>2009-Jan-26 11:09:36 by psilord:</em> <br/>\n\nSent list to nmi-support about packages I need installed on the machines.\nSpecifically:\n\n<p></p><ul>\n<li>gdb\n</li><li>tcsh\n</li><li>strace\n</li><li>flex\n</li><li>yacc/bison\n</li><li>autoconf &gt;= version 2.59\n</li><li>m4 &amp; aclocal (if not included with autoconf)\n</li><li>ncurses\n</li><li>git\n</li></ul>\n\n<p>I'll probably need more once I get the above and get into the mess of the port.\n\n</p><p></p><hr/>\n<em>2009-Jan-26 11:29:16 by psilord:</em> <br/>\n\nStalled waiting for NMI to install packages on the machine per nmi-support number 4715.\n\n<p></p><hr/>\n<em>2009-Jan-27 16:42:23 by psilord:</em> <br/>\n\nUnstalled because the requested stuff got added. Tomorrow, I'll continue my work.\n\n<p></p><hr/>\n<em>2009-Jan-28 14:13:14 by psilord:</em> <br/>\n\nInstalled git in my debian 5 home directory, needed to add to Makefile for git 1.0.6.4:\n<ul>\n<li>NO_OPENSSL = 1\n</li><li>NO_CURL = 1\n</li><li>NO_TCLTK = 1\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Jan-28 15:32:06 by psilord:</em> <br/>\n\nSet up my initial environment and starting to build Condor. However, it turns out I need ncurses installed on the machine, so this is stalled until NMI installs it.\n\n<p></p><hr/>\n<em>2009-Jan-28 15:50:55 by psilord:</em> <br/>\n\nStalled for a bit, but then unstalled as NMI did what I asked. Moved the priority up to 1 since it needs to be done in March 2009.\n\n<p></p><hr/>\n<em>2009-Jan-29 09:54:15 by psilord:</em> <br/>\n\nnew classads doesn't compile, fixing.\n\n<p></p><hr/>\n<em>2009-Jan-29 10:17:07 by matt:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">diff -rupN classads-1.0rc3-original/classad/common.h classads-1.0rc3/classad/com\nmon.h\n--- classads-1.0rc3-original/classad/common.h   2008-02-09 09:25:39.000000000 -0\n600\n+++ classads-1.0rc3/classad/common.h   2008-02-09 09:25:26.000000000 -0600\n@@ -51,6 +51,7 @@\n\n #endif /* WIN32 */\n\n+#include &lt;string.h&gt;\n #include &lt;stdio.h&gt;\n #include &lt;stdlib.h&gt;\n #include &lt;time.h&gt;\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Jan-29 11:02:05 by psilord:</em> <br/>\n\nHacked a solution to new classads, getting jamie to fix blahp.\n\n<p></p><hr/>\n<em>2009-Jan-29 14:12:24 by psilord:</em> <br/>\n\nJamie says blahp is to hard to fix quickly, so I've removed it with --without-blahp on the configure line.\n\n<p>Currently, I've compiled a clipped port of Condor for Debian 5.0 and am running the test suite through it and running the low level tests by hand.\n\n</p><p></p><hr/>\n<em>2009-Jan-30 15:32:21 by psilord:</em> <br/>\n\nNick updated the classad external with the correct patch and I've disabled the blahp from being compiled for debian 5.0 so that's good, bu I have some failed tests in the clipped port, so that's bad, and I can't easily tell if my Condor installation is broken or the tests are broken, and that's worse.\n\n<p></p><hr/>\n<em>2009-Jan-30 16:34:13 by psilord:</em> <br/>\n\nChecked in the port to V7_2-branch after \"enough\" of the tests had passed. I want to see it run in NMI to see what's really going on.\n\n<p></p><hr/>\n<em>2009-Feb-03 21:09:12 by psilord:</em> <br/>\n\nFound an interesting bug in derived ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=183\" onclick=\"get_ticket_and_populate_wrapper('183'); return false;\" title=\"on linux an abort in glibc causes infinite loop with google coredumper\">#183</a></span>.\n\n<p></p><hr/>\n<em>2009-Feb-09 15:13:00 by psilord:</em> <br/>\n\nNeed dpkg-source installed on these machines to build a copy of glibc 2.7-18, which appears to be the current glibc revision found today for Lenny. I asked NMI to do it.\n\n<p></p><hr/>\n<em>2009-Feb-09 16:17:58 by psilord:</em> <br/>\n\nThe tools are installed.\n\n<p>I need them to get the patched glibc 2.7-18 (as of today) source so I can incorporate it into Condor's externals.\n\n</p><p>Another way to do this is:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">&gt; apt-get source glibc\n&gt; cd glibc-2.7\n&gt; dpkg-buildpackage -rfakeroot -b\n</pre></div>\n\n\n<p>To get the patched source specifically, one can also do this:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">'get the glibc .dsc .orig-tar.gz and .diff.gz files'\n&gt; dpkg-source -x glibc_2.7-18.dsc\n</pre></div>\n\n\n<p>Then build the source the same way as above.\n\n</p><p></p><hr/>\n<em>2009-Feb-09 16:48:42 by psilord:</em> <br/>\n\nThe diff.gz file is a set of patches, and that is placed into the glibc-2.7 directory, dpkg-build-package actually applies the patches to the tree. Notice the distinction.\n\n<p></p><hr/>\n<em>2009-Feb-18 14:42:51 by psilord:</em> <br/>\n\nOk, it is pretty ugly to getting a patched glibc extracted out of the debian system.\n\n<p>Basically, on deb 5.0 x86 you:\n</p><div class=\"code\">\n<pre class=\"code\"># This is for tcsh\napt-get source glibc\ncd glibc-2.7\n(dpkg-buildpackage -rfakeroot -b) |&amp; tee /tmp/build.out # wait for completion\ncd build-tree/glibc-2.7 # This is the patched source\nrm -rf .pc # get rid of quilt's patch cache which tar doesn't like\nrm -rf debian\ncp -Rp ../../debian . # This uses the headers on the machine you build\ncd ..\nhead i386-686/config.log # save the configure line\ncd ..\nmv glibc-2.7 glibc-2.7-18 # name it what we need it to be\ntar zcf glibc-2.7-18.tar.gz glibc-2.7-18\nmv glibc-2.7-18 glibc-2.7\n\n# Now, when editing the build-glibc-* file for the externals, dig through\n# /tmp/build.out and get out the full configure line and make arguments.\n# Compare and contrast with the configure line from config.log and pick the\n# right stuff. Then add the additional command line arguments in our build\n# script as delineated by a previous glibc build.\n</pre></div>\n\n\n<p>And on deb 5 x86_64, you:\n</p><div class=\"code\">\n<pre class=\"code\"># This is for tcsh\napt-get source glibc\ncd glibc-2.7\n(dpkg-buildpackage -rfakeroot -b) |&amp; tee /tmp/build.out # wait for completion\ncd build-tree/glibc-2.7 # This is the patched source\nrm -rf .pc # get rid of quilt's patch cache which tar doesn't like\nrm -rf debian\ncp -Rp ../../debian . # This uses the headers on the machine you build\ncd ..\nhead amd64-libc/config.log # save the configure line\ncd ..\nmv glibc-2.7 glibc-2.7-18 # name it what we need it to be\ntar zcf glibc-2.7-18.tar.gz glibc-2.7-18\nmv glibc-2.7-18 glibc-2.7\n\n# Now, when editing the build-glibc-* file for the externals, dig through\n# /tmp/build.out and get out the full configure line and make arguments.\n# Compare and contrast with the configure line from config.log and pick the\n# right stuff. Then add the additional command line arguments in our build\n# script as delineated by a previous glibc build.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Feb-18 16:11:24 by psilord:</em> <br/>\n\nOk, I've wedged in a glibc 2.7-18 external that seems to be what I need.\n\n<p>Now I'm porting actual Condor stduniv source code and seeing what crops up....\n\n</p><p></p><hr/>\n<em>2009-Feb-19 16:36:34 by psilord:</em> <br/>\n\nIt franks.\n\n<p>But it doesn't work.\n\n</p><p>From Hell's heart, I stat() at thee!\n\n</p><p></p><hr/>\n<em>2009-Mar-02 10:17:47 by psilord:</em> <br/>\n\nStalled since I'm working on DMTCP from 03/02/2009 to 03/06/2009.\n\n<p></p><hr/>\n<em>2009-Mar-09 16:03:23 by psilord:</em> <br/>\n\nBack from DMTCP.\n\n<p>Hrm, it seems the jmp buf stack pointer is a bit wrecked causing stack detection to fail during a checkpoint.\n\n</p><p>I wonder if this has anything to do with it:\n\n</p><p><a class=\"external\" href=\"http://udrepper.livejournal.com/13393.html\">http://udrepper.livejournal.com/13393.html</a>\n\n</p><p></p><hr/>\n<em>2009-Mar-09 16:24:51 by psilord:</em> <br/>\n\nglibc-2.7/sysdeps/unix/sysv/linux/i386/sysdep.h\n\n<p>has the pointer mangling crap in it. It looks like debian tried to disable it or may have provided a flag to do so. Checking.\n\n</p><p></p><hr/>\n<em>2009-Mar-12 10:51:05 by psilord:</em> <br/>\n\nAfter messing about online and reading the\n<a class=\"external\" href=\"http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html\">GCC Inline Tutorial</a>. I've constructed this patch, which should encrypt/decrypt the pointers I need out of the jmp buf:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">/* 24 is the magic number which represents the offset to the pointer_guard\nvariable in a tcbhead_t structure. This location contains the encryption\nvalue which is used to encrypt runtime pointers in glibc such as the\nstack location in the jump buf structure. The address to the start of\nthe tcbhead structure is stored in the %gs register.\n*/\n\n#if defined(GLIBC27)\n# ifdef __ASSEMBLER__\n#  define PTR_ENCRYPT(reg)  \\\n                xorl %gs:24, reg;   \\\n                roll $9, reg\n#  define PTR_DECRYPT(reg)  \\\n                rorl $9, reg;       \\\n                xorl %gs:24, reg\n# else\n#  define PTR_ENCRYPT(ptr)  \\\n                asm (\"xorl %%gs:24, %0\\n\"   \\\n                     \"roll $9, %0\"          \\\n                     : \"=r\" (ptr)           \\\n                     : \"0\" (ptr))\n#  define PTR_DECRYPT(ptr)  \\\n                asm (\"rorl $9, %0\\n\"    \\\n                     \"xorl %%gs:24, %0\" \\\n                     : \"=r\" (ptr)       \\\n                     : \"0\" (ptr))\n# endif\n#else\n\n# ifdef __ASSEMBLER__\n#  define PTR_ENCRYPT(x)\n#  define PTR_DECRYPT(x)\n# else\n#  define PTR_ENCRYPT(x) x\n#  define PTR_DECRYPT(x) x\n# endif\n#endif\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Mar-23 11:14:11 by psilord:</em> <br/>\n\nSo, it all passes the test suites, so I'm going to rebase to the head of 7.2 and deal with the whole externals moving to a web server thing....\n\n<p></p><hr/>\n<em>2009-Mar-30 10:42:34 by psilord:</em> <br/>\n\nWhen run through NMI, found a few snafus which I fixed up. I've shoved it in for one more run today. But I think the x86 deb5 port is ready.\n\n<p></p><hr/>\n<em>2009-Apr-01 14:58:50 by psilord:</em> <br/>\n\nI've committed the x86 deb 5 stduniv port.\n\n<p>Currently, I'm fighting with extracting the patched glibc on the x86_64 machine. It seems the directions I wrote were subtly wrong, so I have to re-engineer them. I've made good progress though and I think I almost have it.\n\n</p><p>I just can't use the x86 glibc I got before because there are much different patch sets between the two architectures, among other major differences.\n\n</p><p></p><hr/>\n<em>2009-Apr-02 13:33:57 by psilord:</em> <br/>\n\nHrm, in the x86_64 port, the assembly I wrote seems to have some issues in compilation. I'll need to fix that.\n\n<p></p><hr/>\n<em>2009-Apr-02 13:34:40 by psilord:</em> <br/>\n\nStalled due to drive failure on nmi-0200 (the only machine I have on which I may\nperform the deb 5.0 x86_64 port). I did not lose anything, but I have to wait until it is up and functioning again.\n\n<p></p><hr/>\n<em>2009-Apr-03 14:13:08 by psilord:</em> <br/>\n\nUnstalled since deb 5 x86_64 came back online.\n\n<p></p><hr/>\n<em>2009-Apr-09 10:41:25 by psilord:</em> <br/>\n\nSo, I've hacked the code I needed, and x86_64 deb 5 stduniv passes the test suite, and passes NMI.\n\n<p></p><hr/>\n<em>2009-Apr-09 11:43:15 by psilord:</em> <br/>\n\nI had previously checked in the x86 deb5 port of condor, but failed to mention the ticket number in the commit messages. Sorry.\n\n<p>As of this remark, both x86 and x86_64 deb 5 stduniv are implemented on the\nV7_2-deb5-branch and merged into V7_2-branch. Both pass the test suites and have\npassed NMI as well.\n\n</p><p></p><hr/>\n<em>2009-Apr-09 13:12:57 by psilord:</em> <br/>\n\nI've merged the branch into V7_2-branch and shoved it through to the master.\n\n<p>I can't document it until tomorrow, due to some manual work that must happen\noutside of the scope of this ticket, but once I do, this ticket should be resolved.\n\n</p><p></p><hr/>\n<em>2009-Apr-10 18:14:32 by psilord:</em> <br/>\n\nI have documented this feature in the manual.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=183\" onclick=\"get_ticket_and_populate_wrapper('183'); return false;\" title=\"on linux an abort in glibc causes infinite loop with google coredumper\">#183</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\non linux an abort in glibc causes infinite loop with google coredumper</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Apr-09 11:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2957ea4b7cbbdfa3985a820e5f80b96beb2e0889\">[14444]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05f349fb833dd610e9a305cef7620c9e2aa44355\">[14348]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/36d5207f5c4bd962e68c4606357400844d77c049\">[14400]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bc3aea223fc024f97b05df1f5520fe79c571a3c5\">[14435]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ddf3e5c339bf4cb86f807e2518216365776d2f83\">[14442]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/11ca54f9aaa12e0afc6b66fc928e5fb976ea989f\">[14443]</a></span>, Merge branch 'V7_2-deb5-branch' into V7_2-branch This implements x86_64 stduniv checkpointing on the deb 5.0 branch for <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=24\" onclick=\"get_ticket_and_populate_wrapper('24'); return false;\" title=\"Port Condor to Debian 5.0 (Lenny)\">#24</a></span>.  (By Peter Keller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Jul-26 13:04", "status": "abandoned", "created": "2009-Jan-15 14:33", "fixed_version": "2009-Jan-15 14:33", "broken_version": "", "priority": "5", "subsystem": "Port", "assigned_to": "psilord", "derived_from": "", "creator": "psilord", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}