{"id": 5106, "title": "Ticket #5106: Linux scalability config changes", "description": "<blockquote>\n<ol>\n<li>review old wisdom at <a class=\"external\" href=\"https://web.archive.org/web/20111107111628/http://www.cs.wisc.edu/condor/condorg/linux_scalability.html\">our old web page</a> and wiki page <span class=\"wiki\"><a href=\"wiki?p=LinuxTuning\" title=\"Linux Tuning\">LinuxTuning</a></span>\n</li><li>Global file descriptors (/proc/sys/fs/file-max)\n</li><li>Per process file descriptors (ulimit -n)\n</li><li>Max PID (/proc/sys/kernel/pid_max)\n</li><li>Increase number of ephemeral ports available by default. (/proc/sys/net/ipv4local_ip_port_range)\n</li><li>Increase default maximum length of the TCP listen queue (somaxconn) - it defaults to 128, this is not enough, lets make it 1024.\n</li><li>On central manager (for collector), net.core.rmem_max = 10000000 (via sysctl) (ToddT)</li></ol>\n</blockquote>", "remarks": "<blockquote>\nCurrent thinking is:\n\n<p></p><ol>\n<li>Review old wisdom.\n</li><li>Write script including old and current Linux-specific kernel-level wisdom.\n</li><li>Maybe add a knob to the master which will call this script (once on startup?), that's off by default.\n</li><li>If so, have the script call script.local to avoid horrible packaging/versioning problems.\n</li></ol>\n\n<p></p><hr/>\n<em>2015-Jun-22 10:47:23 by tlmiller:</em> <br/>\n\nReview old wisdom; found nothing to add to this ticket.\n\n<p></p><hr/>\n<em>2015-Jun-24 10:25:42 by tlmiller:</em> <br/>\n\nWe're adding the master code for this to 8.3.7 behind a disabled-by-default knob.  We will enable that knob on CHTC and write verify that it works, then commit the script and turn the knob on by default for 8.3.8 (as well as adding the script to the source repository and making sure that it's packaged properly).\n\n<p></p><hr/>\n<em>2015-Jun-24 10:36:35 by tlmiller:</em> <br/>\n\nAs a result, we won't be documenting this code until 8.3.8.\n\n<p></p><hr/>\n<em>2015-Aug-26 12:35:33 by tannenba:</em> <br/>\n\nAs this code runs as root, I want a code review by the security czar.  At first blush, I don't understand why the implementation does not use <code>my_popen()</code> or <code>my_spawn()</code> family of functions from the util lib.  We want to limit the number of code paths that spawn a new process (especially as root), so I would like to explicitly know as part of the code review if there was some reason our existing methods to spawn processes were eschewed.\n\n<p></p><hr/>\n<em>2017-Jun-26 14:45:49 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>:\n\n<p>Yes, this is old and has been part of the release for quite a while.  Before signing off though, I would like to know the answer to ToddT's question about using my_popen.  Is it just for the 20 second timeout?\n\n</p><p>Second, was it a purposeful decision to continue starting up HTCondor and running un-tuned, even if the tuning script fails, as opposed to aborting the startup?\n\n</p><p></p><hr/>\n<em>2017-Jun-28 13:52:43 by tlmiller:</em> <br/>\n\nThe fork() portion of the code does a few things:\n\n<p>(a) run as root\n(b) redirect standard out and error into a file\n(c) wait no more than twenty seconds for the script to run\n(d) determine if the script exited successfully\n(e) kill the script if it's been more than twenty seconds or if the waitpid() failed\n\n</p><p>The my_spawn*() functions specifically forbid (a).  The my_popen() functions don't natively allow (b).  This could have been worked around, but given that (c) and (e) also weren't possible until eighteen months after this code went in (74c7c7bf0ca9d0274953e9c749a86c28c6009ac6), it seemed pointless to do so.\n\n</p><p>I don't recall if the decision not to abort if the kernel tuning script failed was purposeful or not, but it seems reasonable.\n\n</p><p></p><hr/>\n<em>2018-Mar-01 14:25:31 by tlmiller:</em> <br/>\n\nWith no further commentary, marking resolved.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5126\" onclick=\"get_ticket_and_populate_wrapper('5126'); return false;\" title=\"Linux Kernel Tuning Script\">#5126</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nLinux Kernel Tuning Script</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-26 11:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/79545817d2999ea93979353fae4eef5a03bccd36\">[45692]</a></span>: edit 8.3.8 version history item and new knob defns <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5106\" onclick=\"get_ticket_and_populate_wrapper('5106'); return false;\" title=\"Linux scalability config changes\">#5106</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5126\" onclick=\"get_ticket_and_populate_wrapper('5126'); return false;\" title=\"Linux Kernel Tuning Script\">#5126</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-26 11:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d3bb7b8e356512db3497e2c84f218e2334a958be\">[45685]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5106\" onclick=\"get_ticket_and_populate_wrapper('5106'); return false;\" title=\"Linux scalability config changes\">#5106</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5126\" onclick=\"get_ticket_and_populate_wrapper('5126'); return false;\" title=\"Linux Kernel Tuning Script\">#5126</a></span>) Version history and documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-30 13:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6c3abbda8b95c61fc468fa8f38d540b185241a0\">[45186]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5106\" onclick=\"get_ticket_and_populate_wrapper('5106'); return false;\" title=\"Linux scalability config changes\">#5106</a></span>) Make sure it's safe to call dprintf() and exit() in case of errors in the kernel tuning script code.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-24 10:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0629f2a35690d39ffa81675c3d80b361ab9dba98\">[45136]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5106\" onclick=\"get_ticket_and_populate_wrapper('5106'); return false;\" title=\"Linux scalability config changes\">#5106</a></span>) Add ENABLE_KERNEL_TUNING, KERNEL_TUNING_LOG, and LINUX_KERNEL_TUNING_SCRIPT config knobs.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Mar-01 14:25", "status": "resolved", "created": "2015-Jun-18 16:45", "fixed_version": "2015-Jun-18 16:45", "broken_version": "", "priority": "4", "subsystem": "DaemonMaster", "assigned_to": "tlmiller", "derived_from": "#4988", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu, tim@cs.wisc.edu", "due_date": ""}