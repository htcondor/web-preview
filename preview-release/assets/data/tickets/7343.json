{"id": 7343, "title": "Ticket #7343: Provide live-updating equivalent of condor_q: condor_watch_q", "description": "<blockquote>\nCHTC users are perpetually told to not run <code>condor_q</code> repeatedly, and also not to run it in any kind of automated loop. This is to prevent them from DOSing the schedd. Since we keep having to say it, this is clearly something people want.\n\n<p>We should make a new tool using the Python bindings (and distributed as part of them) that reads event logs to reproduce the \"job status\" part of <code>condor_q</code>, but with live updates. It will not do everything that <code>condor_q</code> does, but it will do the thing that people who want to <code>watch condor_q</code> want: to know how their jobs are doing, live.\n\n</p><p></p><hr/>\nKnown issues at time of merge:\n\n<p></p><ul>\n<li>Does not work well on DAGs. The best set of options at the moment is <code>condor_watch_q -f dagfile.dag.nodes.log -groupby log</code>, but the output is not very useful. <code>condor_watch_q</code> will need to learn more about DAGMan. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7800\" onclick=\"get_ticket_and_populate_wrapper('7800'); return false;\" title=\"condor_watch_q should be able to track DAGs\">#7800</a></span>\n</li><li>Does not work well for late materialization. <code>condor_watch_q</code> will need to look at the cluster ad for additional information.\n</li><li>We can't capture batch names for clusters that have entirely left the queue, which may lead to unexpected grouping/naming of rows. Perhaps we could look in the history?\n</li><li>The active job ids table column will not display what is expected when grouping by batch name and two clusters end up in the same row.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Feb-28 13:07:03 by karpel:</em> <br/>\n\nDevelopment has been happening externally at <a class=\"external\" href=\"https://github.com/JoshKarpel/condor_watch_q\">https://github.com/JoshKarpel/condor_watch_q</a> for easy testing.\n\n<p></p><hr/>\n<em>2020-Jun-09 11:00:54 by karpel:</em> <br/>\n\nI've pushed up the version from <a class=\"external\" href=\"https://github.com/JoshKarpel/condor_watch_q/blob/3fc1952cbc47891ee74b55a15d18dea9e757c901/condor_watch_q.py\">https://github.com/JoshKarpel/condor_watch_q/blob/3fc1952cbc47891ee74b55a15d18dea9e757c901/condor_watch_q.py</a> to branch V8_9-gt7343-branch, with a first pass on a man page, version history, and packaging.\n\n<p>Sending off to ToddM for code/docs review, but TimT should also take a look for packaging review.\n\n</p><p></p><hr/>\n<em>2020-Jun-09 11:20:55 by tlmiller:</em> <br/>\n\n<strong>Doc Review</strong>\n\n<p>It's traditional for man pages to include the options and arguments in the SYNOPSIS section (unless the options list is impractically long or uninteresting).  This is a particularly glaring omission because of the second paragraph of the EXAMPLES mentions 'any ... option' and the man page doesn't actually list any of them.\n\n</p><p>The syntax and contents for the arguments to <strong>-exit</strong>, and the fact that it can be supplied multiple times, should be added to the man page the (missing) OPTIONS section, which should appear after the EXAMPLES.\n\n</p><p></p><hr/>\n<em>2020-Jun-09 11:49:04 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>It's OK -- not good, but OK -- for a tool to be Linux-specific, but <code>get_linux_console_width()</code> seems gratuitously so.  The function probably works on Mac/BSD (check), but there's no equivalent Windows function, and there should be.\n\n</p><p>You can also look into using the environment variables (LINES and COLUMNS, IIRC), which may also get set on Windows.\n\n</p><p>You mentioned in conversation that color doesn't work on Windows and should be automagically disabled there; the documentation for the color switch should mention this.\n\n</p><p>I had a lot of trouble with <code>abbreviate_path()</code>; it could use a one-liner giving an example of the transform it desires and maybe rename path_to_here as path_so_far.\n\n</p><p></p><hr/>\n<em>2020-Jun-11 09:40:43 by karpel:</em> <br/>\n\nBack to ToddM for a second round of review...\n\n<p></p><ul>\n<li>Greatly expanded the man page\n</li><li>Hacked some nonsense into get_terminal_size to handle Windows; not happy with it, but the internet says it will work.\n</li><li>On Windows, use colorama (<a class=\"external\" href=\"https://pypi.org/project/colorama/\">https://pypi.org/project/colorama/</a>) if possible, otherwise disable color.\n</li><li>Did a pass on internal documentation, tried to highlight some of the trickier code with comments.\n</li></ul>\n\n<p></p><hr/>\n<em>2020-Jun-11 13:21:44 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The code changes look good to me.  A minor feature request: in the hopes that I could check the Windows terminal size and color code without spinning up a personal condor, I tried running `condor_watch_q` without one, and got the following instead of something like \"I couldn't find the schedd,\" which made me sad:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">tlmiller@azaphrael:~/Work/alt.condor/test$ ../source/src/condor_scripts/condor_watch_q\nTraceback (most recent call last):\n  File \"../source/src/condor_scripts/condor_watch_q\", line 1261, in &lt;module&gt;\n    cli()\n  File \"../source/src/condor_scripts/condor_watch_q\", line 386, in cli\n    abbreviate_path_components=args.abbreviate,\n  File \"../source/src/condor_scripts/condor_watch_q\", line 445, in watch_q\n    users, cluster_ids, event_logs, batches, collector=collector, schedd=schedd\n  File \"../source/src/condor_scripts/condor_watch_q\", line 659, in find_job_event_logs\n    ads = get_schedd(collector=collector, schedd=schedd).query(\n  File \"../source/src/condor_scripts/condor_watch_q\", line 702, in get_schedd\n    schedd = htcondor.Schedd()\n  File \"/space/tlmiller/alt.condor/install/lib/python/htcondor/_lock.py\", line 75, in wrapper\n    rv = func(*args, **kwargs)\nRuntimeError: Unable to locate local daemon\n</pre></div>\n\n\n<p>The release note says that \"several known issues are summarized in the ticket.\"  I don't actually see that in the (this) ticket?\n\n</p><p>I can confirm that the terminal size detection and color code work on Windows 10.  As I suspected, the yellow is almost unreadable to me (I typically use black-on-white terminals).  It might help to use a character that takes up more space.\n\n</p><p>However, I was very confused by the default behavior of condor_watch_q when I was testing it: my test sleep jobs all write to the same logfile and have for months now, so it would go from \"no jobs in the queeu, go away\" to displaying information about a bunch of jobs that weren't in the queue.  I don't know if there's anything sane you can do about this, except perhaps change the default sort order to move batches with jobs in the queue to the top.  (I was going to suggest sorting by most recent update to the job status, but you'd have to do that only once, when condor_watch_q started up, or else things would move around, which would probably be annoying... maybe allow the user to opt-in to that behavior?  I could see it being handy in some cases.)\n\n</p><p></p><hr/>\n<em>2020-Jun-11 14:40:47 by karpel:</em> <br/>\n\nTimT, could you do a packaging review? I copy-pasted a little from <code>classad_eval</code> in <a class=\"external\" href=\"https://github.com/htcondor/htcondor/commit/40299be032dc7618c01a3a357e4b3bce4e1d307f\">[59824]</a>, but I probably missed some fiddly details.\n\n<p></p><hr/>\n<em>2020-Jun-11 16:23:47 by tim:</em> <br/>\n\nPackaging looks good.\n\n<p></p><hr/>\n<em>2020-Jun-12 09:16:39 by karpel:</em> <br/>\n\nMerged to master in <a class=\"external\" href=\"https://github.com/htcondor/htcondor/commit/d378e048e6b835c1e80e5e85aae968d631e34ab0\">[59851]</a></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7800\" onclick=\"get_ticket_and_populate_wrapper('7800'); return false;\" title=\"condor_watch_q should be able to track DAGs\">#7800</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncondor_watch_q should be able to track DAGs</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-15 09:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c13900f93a22d1e634d33bac3a4fa2c156af7884\">[59873]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) add indicator of how to quit condor_watch_q when no exit conditions are specified Co-authored-by: Eric Lin &lt;zlin245@wisc.edu&gt;  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/094189996003f7c9409da3980d96d036786e21d9\">[59844]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) tidy up condor_watch_q errors and warnings  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 09:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fd619026a26d8ee2994c6fbbc7b59a8bbedfa8b0\">[59841]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) internal documentation pass on condor_watch_q  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 09:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7ab5e4bbc3b88511b079eceaddada77fb659b130\">[59840]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) try to use colorama for color on Windows, otherwise disable color on windows  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-11 08:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bf8926e0873741ea7f35aea4f7268b9cec7d875b\">[59839]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) hack get_terminal_size for Windows compat on Python 2  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 22:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/793fe660becc9dc84da861061c5ea7669ffe1dbb\">[59833]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) fix typo  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 15:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9ebcc257cf5ee2ecb4242e2d8e462125f2aa8447\">[59831]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) add implementation notes for abbreviate_path  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 15:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3ba9b298bd8296c64afb2d12a4b69b0580426951\">[59830]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) improve condor_watch_q man page based on doc review; keep implementation in sync  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 10:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b4c0a8cb11901f35e1eb745ccd78d1d4bccfe56a\">[59826]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) add condor_watch_q man page  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 10:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fc0b2440367da03d9af2d1ea0c32fa21d96cdb84\">[59825]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) version history for condor_watch_q  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/40299be032dc7618c01a3a357e4b3bce4e1d307f\">[59824]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) crude pass on condor_watch_q packaging (copy-paste from classad_eval)  (By Josh Karpel )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-09 10:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd289941b23de78a693c47d286b31a66471c80c4\">[59823]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7343\" onclick=\"get_ticket_and_populate_wrapper('7343'); return false;\" title=\"Provide live-updating equivalent of condor_q: condor_watch_q\">#7343</a></span>) add condor_watch_q from <a class=\"external\" href=\"https://github.com/JoshKarpel/condor_watch_q/blob/3fc1952cbc47891ee74b55a15d18dea9e757c901/condor_watch_q.py\">https://github.com/JoshKarpel/condor_watch_q/blob/3fc1952cbc47891ee74b55a15d18dea9e757c901/condor_watch_q.py</a> Co-authored-by: Eric Lin &lt;zlin245@wisc.edu &gt; Co-authored-by: Katherine Fu &lt;jfu57@wisc.edu&gt; Co-authored-by: Brian Bockelman &lt;bbockelman@morgridge.org&gt;  (By Josh Karpel )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Aug-17 13:30", "status": "resolved", "created": "2019-Oct-25 08:35", "fixed_version": "2019-Oct-25 08:35", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "karpel", "derived_from": "", "creator": "karpel", "rust": "", "customer_group": "other", "visibility": "public", "notify": "karpel@wisc.edu jpatton@cs.wisc.edu johnkn@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}