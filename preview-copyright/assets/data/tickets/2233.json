{"id": 2233, "title": "Ticket #2233: shadow crashes on user log init failure", "description": "<blockquote>\nHow to reproduce:\n\n<p>Submit a job and set the userlog read-only.\n\n</p><p>In 7.6.0, the shadow did not segfault when it failed to open the user log for writing.  In 7.6.1, it does.\n\n</p><p>The problem is that the shadow tries to call <code>updateJobInQueue()</code> before <code>job_updater</code> has been initialized.\n\n</p><p>Here is what the shadow log shows in 7.6.1:\n\n</p><p></p><div class=\"verbatim\">\n<pre>06/13/11 16:00:38 Initializing a VANILLA shadow for job 2.0\n06/13/11 16:00:38 (2.0) (22181): WriteUserLog::initialize: safe_open_wrapper(\"/scratch/dan/condor-7.6.1-x86_rhap_5-unstripped/ulog\") failed - errno 13 (Permission denied)\n06/13/11 16:00:38 (2.0) (22181): WriteUserLog::initialize: failed to open file\n06/13/11 16:00:38 (2.0) (22181): Failed to initialize user log to /scratch/dan/condor-7.6.1-x86_rhap_5-unstripped/ulog\n06/13/11 16:00:38 (2.0) (22181): Job 2.0 going into Hold state (code 22,0): Failed to initialize user log to /scratch/dan/condor-7.6.1-x86_rhap_5-unstripped/ulog\n06/13/11 16:00:38 (2.0) (22181): RemoteResource::killStarter(): DCStartd object NULL!\nStack dump for process 22181 at timestamp 1307998838 (13 frames)\ncondor_shadow(dprintf_dump_stack+0x4a)[0x81cfbfa]\ncondor_shadow[0x81e9246]\n[0xffffe500]\ncondor_shadow(_ZN10BaseShadow16updateJobInQueueE8update_t+0xb2)[0x81055b2]\ncondor_shadow(_ZN10BaseShadow7holdJobEPKcii+0x12b)[0x810840b]\ncondor_shadow(_ZN10BaseShadow11initUserLogEv+0x131)[0x81086a1]\ncondor_shadow(_ZN10BaseShadow8baseInitEPN14compat_classad7ClassAdEPKcS4_+0x2f9)[0x8108c29]\ncondor_shadow(_ZN9UniShadow4initEPN14compat_classad7ClassAdEPKcS4_+0x41)[0x8101541]\ncondor_shadow(_Z10initShadowPN14compat_classad7ClassAdE+0xd0)[0x80f4e20]\ncondor_shadow(_Z11startShadowPN14compat_classad7ClassAdE+0x68)[0x80f4f78]\ncondor_shadow(main+0x1162)[0x811be72]\n/lib/libc.so.6(__libc_start_main+0xdc)[0xf7c9be9c]\ncondor_shadow(realloc+0xa5)[0x80f4621]\n</pre></div>\n\n\n<p>Here is what the shadow log shows in 7.6.0:\n\n</p><p></p><div class=\"verbatim\">\n<pre>06/13/11 16:07:34 Initializing a VANILLA shadow for job 1.0\n06/13/11 16:07:34 (1.0) (22495): WriteUserLog::initialize: safe_open_wrapper(\"/scratch/dan/condor-7.6.0-x86_rhap_5-stripped/ulog\") failed - errno 13 (Permission denied)\n06/13/11 16:07:34 (1.0) (22495): WriteUserLog::initialize: failed to open file\n06/13/11 16:07:34 (1.0) (22495): ERROR \"Failed to initialize user log to /scratch/dan/condor-7.6.0-x86_rhap_5-stripped/ulog\" at line 777 in file /home/condor/execute/dir_3425/userdir/src/condor_shadow.V6.1/baseshadow.cpp\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Jun-14 08:08:14 by tannenba:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Thanks for fixing, patch looks good. Only detailed feedback is I'd suggest is:\n</p><ol>\n<li>a comment before the initial call to initUserLog() saying it must happen after <code>job_updater</code> is initialized\n</li><li>placing an <code>ASSERT(job_updater)</code> at the start of initUserLog() - this way if someone messes this up again (i.e. me!) the shadow will assert in the common case instead of just asserting when there is a problem initializing the user log.</li></ol>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-08 16:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c79cca83bc4c3cc8b98573c8cea91a5a74d378c\">[26660]</a></span>: Minor tweaks in response to code review of bug fix for shadow crashing on user-log init failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2233\" onclick=\"get_ticket_and_populate_wrapper('2233'); return false;\" title=\"shadow crashes on user log init failure\">#2233</a></span> ===NoVersionHistory===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-14 07:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/be133c276d798372b19fcd0054cdc102ce02ff52\">[22170]</a></span>: Fixed shadow crash on user log init failure. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2233\" onclick=\"get_ticket_and_populate_wrapper('2233'); return false;\" title=\"shadow crashes on user log init failure\">#2233</a></span> ===VersionHistory=== Fixed a problem introduced in 7.6.1 that caused condor_shadow to crash without successfully putting the job on hold when the user log could not be opened for writing.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Aug-08 16:12", "status": "resolved", "created": "2011-Jun-13 16:16", "fixed_version": "2011-Jun-13 16:16", "broken_version": "v070601", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "#1963", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu,tannenba@cs.wisc.edu, matt@cs.wisc.edu, tstclair@redhat.com", "due_date": "20110812"}