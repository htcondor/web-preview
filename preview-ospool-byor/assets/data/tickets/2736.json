{"id": 2736, "title": "Ticket #2736: schedd tries to kill pid 0 and then excepts", "description": "<blockquote>\nIgor upgraded from 7.6.4 to 7.6.5 and within a few minutes, the schedd crashed with the following message:\n\n<p></p><div class=\"verbatim\">\n<pre>12/30/11 15:09:49 (pid:16798) Match record (glidein_16149@cmsrm-wn089.roma1.infn.it &lt;141.108.36.47:58527?CCBID=169.228.130.23:9677#8728&amp;noUDP&gt; for uscms2783, 366716.79) deleted\n12/30/11 15:09:49 (pid:16798) ERROR \"Send_Signal: sent unsafe pid (0)\" at line 5492 in file /home/condor/execute/dir_10444/userdir/src/condor_daemon_core.V6/daemon_core.cpp\n</pre></div>\n\n\n<p>Looking at code changes in the schedd in 7.6.5, I am betting that the problem is caused by <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2706\" onclick=\"get_ticket_and_populate_wrapper('2706'); return false;\" title=\"Schedd should kill claim when lease expires\">#2706</a></span>, because that code adds a new call to <code>Send_Signal()</code> in the schedd.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Jan-03 16:31:35 by jfrey:</em> <br/>\n\nIt would be easy to add a guard on the new Send_Signal() call to ensure the pid is &gt; 0. But I'd like to understand why the pid is 0. I've looked over the code and the pid should be valid any time that code fires.\n\n<p></p><hr/>\n<em>2012-Jan-04 16:31:57 by jfrey:</em> <br/>\n\nI understand what's happening now. There's a window of time when a shadow_rec exists before the shadow process is spawned. During that time, the pid field of the shadow_rec is 0 and the status field of the match_rec is M_ACTIVE.\n\n<p></p><hr/>\n<em>2012-Jan-04 19:20:36 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Patch attached below looks good, please commit.  Thanks!</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/514/alive.patch\">alive.patch</a>\n903 bytes added by jfrey on 2012-Jan-04 22:33:22 UTC.\n<br/>\nPatch to prevent lease expiration code from trying to send a signal to pid 0.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-17 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bc416f2b32efbf80dd9e0142099f10ae0e82db7d\">[29125]</a></span>: Minor 7.6.6 version history item edits for <span class=\"ticket\"><a class=\"defer\" href=\"/wiki-archive/tickets/?ticket=2738\" onclick=\"get_ticket_and_populate_wrapper('2738'); return false;\" title=\"condor_ckpt_server is crashing\">#2738</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2736\" onclick=\"get_ticket_and_populate_wrapper('2736'); return false;\" title=\"schedd tries to kill pid 0 and then excepts\">#2736</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2133\" onclick=\"get_ticket_and_populate_wrapper('2133'); return false;\" title=\"[Debian] Modify init script to handle /var/run as tmpfs\">#2133</a></span>.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-05 10:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b78447c28c3959f4d9a0668f777ddd46f2eee4e5\">[28989]</a></span>: Don't send signals to pid 0 when claim lease expires. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2736\" onclick=\"get_ticket_and_populate_wrapper('2736'); return false;\" title=\"schedd tries to kill pid 0 and then excepts\">#2736</a></span> It's possible to have a shadow_rec for a claim but no shadow process. During this time, the pid field of the shadow_rec is 0. When the claim lease has expired, we don't want to send a signal when the pid is 0, as this causes the schedd to EXCEPT.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jan-25 11:39", "status": "resolved", "created": "2011-Dec-30 17:21", "fixed_version": "2011-Dec-30 17:21", "broken_version": "v070605", "priority": "1", "subsystem": "", "assigned_to": "jfrey", "derived_from": "#2706", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,burt@fnal.gov,tannenba@cs.wisc.edu,gthain@cs.wisc.edu,jfrey@cs.wisc.edu", "due_date": ""}