{"id": 904, "title": "Ticket #904: Complete crondor script infrastructure", "description": "<blockquote>\nSee subject</blockquote>", "remarks": "<blockquote>\n<em>2009-Nov-04 09:48:07 by nleroy:</em> <br/>\n\nAlong with Ken, I've been pondering how to switch the special users we use to\nthe crondor system.\n\n<p>I'll define the special users as:\n\n</p><p></p><ul>\n<li>condor\n</li><li>cndrutil\n</li><li>cndr-cvs\n</li><li>cndr-rst  (does this user get used anymore?  What was it for?  At least, I\ndon't see any crontab entries that aren't empty for this user)\n</li></ul>\n\n<p>Now, the plan:\n\n</p><p></p><ol>\n<li>Create a new (small) workspace:\n/p/condor/workspaces/crondor\n\n<p></p><ol>\n<li>The whole tree should be under CVS\n</li></ol>\n\n<p></p></li><li>Create subdirectories under there for each machine that uses them:\n/p/condor/workspaces/{tonic,chopin,astro,nation,phoenix,...}\n\n<p></p></li><li>The submit files for each of the \"tasks\" should live here, with some\nrequirements:\n\n<p></p><ol>\n<li>ALL crondor jobs shall have the following attributes:\n<div class=\"verbatim\">\n<pre>  Universe = local\n  CrondorRealUserName = &lt;name&gt;\n  CrondorRealUserContact = &lt;email@cs.wisc.edu&gt;\n  CrondorJobDescription = &lt;text&gt;\n  CrondorJobName = &lt;job name&gt;\n  CrondorJobVersion = &lt;version number&gt;, free form\n</pre></div>\n\n\n<p></p></li><li>If specified, LOG, OUTPUT and ERROR shall go to /scratch/crondor/jobname.\n(log,out,err)\n\n<p></p></li><li>It's possible (maybe likely) that I'll write some kind of draconian script\nto condor_rm your jobs if they don't do the above (it'd do some other things,\ntoo, see below)\n\n<p></p></li><li>I'd probably write a simple \"watcher\" script that runs periodically and\ndoes the following:\n\n<p></p><ul>\n<li>Looks at the submit in the relevant directory\n</li><li>Looks at the current crondor jobs queued\n</li><li>if &lt;job name&gt; isn't queued, queue the job\n</li><li>if &lt;job name&gt; no longer has a submit file, condor_rm it\n</li><li>if &lt;job name&gt;/&lt;version number&gt; don't match:\n<div class=\"verbatim\">\n<pre>condor_rm &lt;jobid&gt;\ncondor_submit &lt;submit file&gt;\n</pre></div>\n\n</li><li>if any of the above attributes is missing or bad in a running job:\n<div class=\"verbatim\">\n<pre>condor_rm &lt;jobid&gt;\n</pre></div>\n\n</li><li>if any of the above attributes is missing or bad in a submit file:\n    (ignore it)\n</li></ul>\n</li></ol>\n</li></ol>\n\n<p></p><hr/>\n<em>2009-Nov-04 09:49:11 by nleroy:</em> <br/>\n\nemail from Zach:\ni'll throw out three options:\n\n<p></p><ol>\n<li>runs under crondor.  i dislike this since if something is wrong with\ncrondor it's possible the crondor watcher script won't run.\n\n<p></p></li><li>runs under cron.  i dislike this because miron dislikes this.\n\n<p></p></li><li>is a long running script that runs under the master.  the script just\nsleeps most of the time and periodically polls or does whatever it has to\ndo.  the nice thing is, if the script dies, the master restarts it with\nexponential backoff.\n</li></ol>\n\n<p>given the nature of the problem, i'd probably go with 3.\n\n</p><p></p><hr/>\n<em>2009-Nov-04 09:55:26 by nleroy:</em> <br/>\n\n<div class=\"verbatim\">\n<pre>Nick LeRoy wrote:\n&gt; All,\n&gt;\n&gt; Along with Ken, I've been pondering how to switch the special users we use to\n&gt; the crondor system.\n&gt;\n&gt; I'll define the special users as:\n&gt;\n&gt;   - condor\n&gt;   - cndrutil\n&gt;   - cndr-cvs\n&gt;   - cndr-rst  (does this user get used anymore?  What was it for?  At least, &gt; I don't see any crontab entries that aren't empty for this user)\n</pre></div>\n\n\n<p>I think we should think about if it is reasonable to consolidate this\ndown to one special user.\n\n</p><p></p><div class=\"verbatim\">\n<pre>&gt; Now, the plan:\n&gt;\n&gt; 1. Create a new (small) workspace:\n&gt; /p/condor/workspaces/crondor\n</pre></div>\n\n\n<p>Why in workspaces?  /p/condor/home/crondor seems better.\n\n</p><p>&gt; 1a. The whole tree should be under CVS\n\n</p><p>Couldn't hurt...\n\n</p><p></p><div class=\"verbatim\">\n<pre>&gt; 2. Create subdirectories under there for each machine that uses them:\n&gt; /p/condor/workspaces/{tonic,chopin,astro,nation,phoenix,...}\n</pre></div>\n\n\n<p>Gotcha....  good housekeeping...\n\n</p><p>&gt; 3. The submit files for each of the \"tasks\" should live here,\n\n</p><p>Gotcha....  good housekeeping...  not only the submit file, but I would\nlike to see a copy of the script the submit file will execute here as\nwell, also under CVS/git.\n\n</p><p></p><div class=\"verbatim\">\n<pre>&gt; with some\n&gt; requirements:\n&gt;\n&gt; 3a. ALL crondor jobs shall have the following attributes:\n&gt;   Universe = local\n&gt;   CrondorRealUserName = &lt;name&gt;\n&gt;   CrondorRealUserContact = &lt;email@cs.wisc.edu&gt;\n&gt;   CrondorJobDescription = &lt;text&gt;\n&gt;   CrondorJobName = &lt;job name&gt;\n&gt;   CrondorJobVersion = &lt;version number&gt;, free form\n</pre></div>\n\n\n<p>Why?\n\n</p><p></p><div class=\"verbatim\">\n<pre>&gt; 3b. If specified, LOG, OUTPUT and ERROR shall go\n&gt; to /scratch/crondor/jobname. (log,out,err)\n&gt;\n&gt; 3b. It's possible (maybe likely) that I'll write some kind of draconian script\n&gt; to condor_rm your jobs if they don't do the above (it'd do some other things,\n&gt; too, see below)\n&gt;\n&gt; 3c. I'd probably write a simple \"watcher\" script that runs periodically and\n&gt; does the following:\n&gt;\n&gt;   - Looks at the submit in the relevant directory\n&gt;   - Looks at the current crondor jobs queued\n&gt;   - if &lt;job name&gt; isn't queued, queue the job\n&gt;   - if &lt;job name&gt; no longer has a submit file, condor_rm it\n&gt;   - if &lt;job name&gt;/&lt;version number&gt; don't match:\n&gt;     condor_rm &lt;jobid&gt;\n&gt;     condor_submit &lt;submit file&gt;\n&gt;   - if any of the above attributes is missing or bad in a running job:\n&gt;     condor_rm &lt;jobid&gt;\n&gt;   - if any of the above attributes is missing or bad in a submit file:\n&gt;     (ignore it)\n</pre></div>\n\n\n<p>Do we need all this?  And yet another script?\n\n</p><p>Alternate proposal:\n\n</p><p>We create the Condor \"cron\" pool.  It consists of a master and schedd\nrunning on every CSL machine which has a magic cndrutil account.  All of\nthese Condor services run as real-uid cndrutil, and report to collector\nrunning on a machine we give an alias of condor-cron.  The Condor\nservices are setup w/ kerberos authentication.  The condor_config lives\nin conveniently in shared file space /p/condor/home/crondor, and\nALLOW_WRITE settings control who can be trusted to submit cron jobs that\ncan run w/ the cndrutil token.  The condor_config will also specify a\ndefault universe of local (DEFAULT_UNIVERSE=LOCAL) and a default\ninitialdir of /scratch/crondor/jobid.\n\n</p><p>You need a crondor job?\n</p><ol>\n<li>Write/edit a submit file\n</li><li>put it in /p/condor/home/crondor/machine-name and cvs commit for\ngood archeology hygene if it is important to the project,\n</li><li>login to machine-name, and submit it.\n</li></ol>\n\n<p>You want to see all crondor jobs, who submitted them, and where they\nwill run?  \"condor_q -pool condor-cron -global\"\n\n</p><p>You want to see all machines where you could run a cron job?\n\"condor_status -pool condor-cron\".\n\n</p><p>No scripts to write/maintain.  Secure.\n\n</p><p>Thoughts?\n\n</p><p>Todd\n\n</p><p></p><hr/>\n<em>2009-Nov-04 09:56:22 by nleroy:</em> <br/>\n\nemail from Alan <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DeSmet\" title=\"De Smet\">DeSmet</a></span>:\n<div class=\"verbatim\">\n<pre>Todd Tannenbaum &lt;tannenba@cs.wisc.edu&gt; wrote:\n&gt; &gt;3a. ALL crondor jobs shall have the following attributes:\n&gt; &gt; \u00a0Universe = local\n&gt; &gt; \u00a0CrondorRealUserName = &lt;name&gt;\n&gt; &gt; \u00a0CrondorRealUserContact = &lt;email@cs.wisc.edu&gt;\n&gt; &gt; \u00a0CrondorJobDescription = &lt;text&gt;\n&gt; &gt; \u00a0CrondorJobName = &lt;job name&gt;\n&gt; &gt; \u00a0CrondorJobVersion = &lt;version number&gt;, free form\n&gt;\n&gt; Why?\n</pre></div>\n\n\n<p>Many of these seem useful because they let someone investigating\na crondor job quickly determine its purpose and owner. &amp;#160;This is\neasier that trying to associate the job with a particular submit\nfile, especially when someone may have broken the rules and\nsubmitted a job without putting the submit file in\n/p/condor/whatever/crondor/. &amp;#160;(That case is also why I imagine\nthe original proposal ruthlessly rms jobs that don't comply.\nSmack offenders early, so it's not three years later and no one\nknows where a given job came from.)\n\n</p><p>&gt; Do we need all this? &amp;#160;And yet another script?\n\n</p><p>The original proposal does sound like overkill. &amp;#160;However. &amp;#160;I\ndon't trust Crondor yet. &amp;#160;Yes, I get that that's the entire\npoint. &amp;#160;But if stuff stops running, we overlook it, and the\nresult looks bad for Condor, we're going to get chewed out\nanyway.\n\n</p><p>Perhaps instead we could have a script that doesn't actively try\nto fix things, but tries to detect bad things (jobs missing being\nthe big one, but jobs not running and malformed jobs would be\nnice as well) and complains about them.\n\n</p><p></p><hr/>\n<em>2009-Nov-04 09:57:39 by nleroy:</em> <br/>\n\nemails by Pete and Nick:\n\n<p></p><div class=\"verbatim\">\n<pre>On Friday 20 February 2009, Peter Keller wrote:\n&gt; On Fri, Feb 20, 2009 at 01:37:22PM -0600, Alan De Smet wrote:\n&gt; &gt; Todd Tannenbaum &lt;tannenba@cs.wisc.edu&gt; wrote:\n&gt; &gt; &gt; &gt;3a. ALL crondor jobs shall have the following attributes:\n&gt; &gt; &gt; &gt; \u00a0Universe = local\n&gt; &gt; &gt; &gt; \u00a0CrondorRealUserName = &lt;name&gt;\n&gt; &gt; &gt; &gt; \u00a0CrondorRealUserContact = &lt;email@cs.wisc.edu&gt;\n&gt; &gt; &gt; &gt; \u00a0CrondorJobDescription = &lt;text&gt;\n&gt; &gt; &gt; &gt; \u00a0CrondorJobName = &lt;job name&gt;\n&gt; &gt; &gt; &gt; \u00a0CrondorJobVersion = &lt;version number&gt;, free form\n&gt; &gt; &gt;\n&gt; &gt; &gt; Why?\n&gt; &gt;\n&gt; &gt; Many of these seem useful because they let someone investigating\n&gt; &gt; a crondor job quickly determine its purpose and owner.\n&gt;\n&gt; I agree with Alan about this topic, but I'm somewhat more interested in\n&gt; how to enforce this schema.\n&gt;\n&gt; It'd be nice if a condor administrator could specify a kind of template ad\n&gt; (sorta like XLST) by which a job ad must *match* in order to be considered\n&gt; allowed into the system.\n&gt;\n&gt; Other places this would help would be if an administrator requires users\n&gt; to put +foobar into their job ad because it signifies something about\n&gt; the job or them. I see that all the time in Condor yet there is really\n&gt; no way to enforce it in Condor.\n</pre></div>\n\n\n<p>I've decided to hack together this script over the weekend (did a little bit\nlast night)... &amp;#160;I'm the one who's inevitably going to be watching over 'em\nall, and it'll be my headaches that I'll be hoping to prevent. &amp;#160;That, and I\nlike hacking python. &amp;#160;;)\n\n</p><p>-Nick</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "todo", "last_change": "2010-Jan-31 13:22", "status": "new", "created": "2009-Nov-04 09:41", "fixed_version": "2009-Nov-04 09:41", "broken_version": "", "priority": "3", "subsystem": "Unknown", "assigned_to": "nleroy", "derived_from": "#225", "creator": "nleroy", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}