{"id": 2802, "title": "Ticket #2802: schedd not always reusing claims when it should", "description": "<blockquote>\nFound a bug in the schedd that causes it to release claims when it still has jobs it could run on those claims. The problem arises when a job no longer matches a slot <em>after</em> it completes - this is not all that uncommon using our defaults w/ dynamic slots.\n\n<p>The story is:\n\n</p><p></p><ol>\n<li>a job id x completes.\n</li><li>schedd goes through priorec array to try and find another job that matches the claimed resource.  UNFORTUNATELY, it may happen that\n  (a) the priorec has yet been rebuilt (i.e. using a cached priorec array), and\n  (b) the job classad for complete job id x has not yet been destroyed, as it is waiting to be destroyed in the enqueueFinishedJob queue\n</li><li>as a result of a and b, findrunnable job will try to match <strong>the very job that just completed</strong> with the now idle claim\n</li><li>the job that just completed may no longer match with the claimed startd ad, especially in the case of submitting jobs w/ the defaults and using dynamic slots. For instance, machine.Memory &lt; jobad.ImageSize, because <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ImageSize\" title=\"Image Size\">ImageSize</a></span> in the completed job is now bigger than when the resource was initially claimed (because now that the job is completed, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ImageSize\" title=\"Image Size\">ImageSize</a></span> now reflects the real size seen by the starter and not just the size of the executable on disk).\n</li><li>findrunnable job now marks the entire autocluster as not matching this claim\n</li><li>the claim is relinquished when Todd's test really expected it should be  reused :(</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Feb-01 11:01:32 by tannenba:</em> <br/>\n\nPushed patch <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/552bd067a2d00cbd305f163db1d84ee770c398f3\">[30063]</a></span> that fixes the problem by changing the order of our checks in\nschedd FindRunnableJob().  Previously, this method first tested that the job and machine ad still matched, then tested that the job is still runnable. I reversed the order - first test that the job is still runnable, then test that it matches.  This prevents FindRunnableJob() from considering a job that just completed (step 3 above), which is what got us into trouble in the first place.\n\n<p></p><hr/>\n<em>2012-Feb-01 13:09:05 by matt:</em> <br/>\n\nThis is unlikely to impact anyone who is using <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestMemory\" title=\"Request Memory\">RequestMemory</a></span>. The default when not is very small, almost guaranteed to be overrun and trip this issue.\n\n<p></p><hr/>\n<em>2012-Feb-03 15:45:53 by tstclair:</em> <br/>\n\nSo in testing this at length, I've found there appears to be numerous times where we release a claim that could have been matched.  I'm still tracing the logic to identify the cases.\n\n<p>I found that we <strong>never</strong> re-use a claim until it times out.  I'm reopening as a result.\n\n</p><p></p><hr/>\n<em>2012-Feb-06 14:41:45 by tstclair:</em> <br/>\n\nI'll reopen if once I can find a consistent repro method, moving on for now.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-27 10:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f95a9635ec445ed2b6318a904254d29f4e0a5676\">[31007]</a></span>: complete version history edit. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2802\" onclick=\"get_ticket_and_populate_wrapper('2802'); return false;\" title=\"schedd not always reusing claims when it should\">#2802</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-26 15:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/383805989a33ed8da064cadc9c6758c061c10bf5\">[31004]</a></span>: partial edit of version history item. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2802\" onclick=\"get_ticket_and_populate_wrapper('2802'); return false;\" title=\"schedd not always reusing claims when it should\">#2802</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-05 21:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/343af6d8edbc909e932b86515101fec42b2ea037\">[30818]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2802\" onclick=\"get_ticket_and_populate_wrapper('2802'); return false;\" title=\"schedd not always reusing claims when it should\">#2802</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-01 10:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/552bd067a2d00cbd305f163db1d84ee770c398f3\">[30063]</a></span>: fixed bug where schedd not always reusing claims when it should. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2802\" onclick=\"get_ticket_and_populate_wrapper('2802'); return false;\" title=\"schedd not always reusing claims when it should\">#2802</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Mar-05 21:34", "status": "resolved", "created": "2012-Feb-01 10:31", "fixed_version": "2012-Feb-01 10:31", "broken_version": "v070600", "priority": "4", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}