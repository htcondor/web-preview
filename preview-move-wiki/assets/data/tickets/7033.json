{"id": 7033, "title": "Ticket #7033: Job lease not updated in shadow", "description": "<blockquote>\nA code change in 8.7.4 accidentally removed the shadow's updating of the timestamp on when it last heard from the starter. Thus, when a disconnect happens, the shadow acts as if it last heard from the starter when the job began execution.</blockquote>", "remarks": "<blockquote>\n<em>2019-May-15 11:23:00 by jfrey:</em> <br/>\n\nThis bug does not affect reconnecting after a restart of the schedd. This is because the schedd updates <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobLeaseRenewal\" title=\"Last Job Lease Renewal\">LastJobLeaseRenewal</a></span> for all running jobs periodically (every 5 minutes). The bug only affects a shadow that experiences a closing of its network connection to the starter.\n\n<p></p><hr/>\n<em>2019-May-15 14:11:49 by jfrey:</em> <br/>\n\nThe whole job lease machinery of the schedd and shadow should be revisited. Both the schedd and the shadow are updating <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobLeaseRenewal\" title=\"Last Job Lease Renewal\">LastJobLeaseRenewal</a></span>. Since the shadow's updates are delayed, the value in the job ad can jump backwards to any earlier time.\n\n<p>Also, the schedd sets this attribute to the current time for every single running job. This is basically an \"I was alive at time X\" marker. It should be able to store this timestamp once persistently. This also applies to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WallClockCheckpoint\" title=\"Wall Clock Checkpoint\">WallClockCheckpoint</a></span> attribute.\n\n</p><p>We should consider removing all of the machinery for supporting the older job lease protocols, like the schedd sending alive messages and the startd sending alive messages while the starter is alive.\n\n</p><p></p><hr/>\n<em>2019-May-15 15:49:51 by jfrey:</em> <br/>\n\nAnother update: This bug will affect reconnecting after a schedd restart, but only for some of the shadows. When the shadow wants to set <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobLeaseRenewal\" title=\"Last Job Lease Renewal\">LastJobLeaseRenewal</a></span> to the current time because it heard from the starter, it instead re-sets the existing value (from an unuqdated last_job_lease_renewal variable). <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> marks the attribute as dirty, even though the value is unchanged. On the next periodic push of changed attributes to the schedd (every 15 minutes by default), the old value for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobLeaseRenewal\" title=\"Last Job Lease Renewal\">LastJobLeaseRenewal</a></span> is included. If this periodic push occurs between the schedd's last update of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobLeaseRenewal\" title=\"Last Job Lease Renewal\">LastJobLeaseRenewal</a></span> and its restart, then the job will be affected by this bug.\n\n<p></p><hr/>\n<em>2019-May-15 16:00:13 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  All is good.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7053\" onclick=\"get_ticket_and_populate_wrapper('7053'); return false;\" title=\"Schedd restart counts appear wrong in recent CHTC report\">#7053</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSchedd restart counts appear wrong in recent CHTC report</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-15 15:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56894\">[56894]</a></span>: Update version info for shadow reconnect bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7033\" onclick=\"get_ticket_and_populate_wrapper('7033'); return false;\" title=\"Job lease not updated in shadow\">#7033</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-15 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56890\">[56890]</a></span>: Docs for shadow not reconnecting bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7033\" onclick=\"get_ticket_and_populate_wrapper('7033'); return false;\" title=\"Job lease not updated in shadow\">#7033</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-03 09:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56749\">[56749]</a></span>: Update last_job_lease_renewal when we hear from the starter. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7033\" onclick=\"get_ticket_and_populate_wrapper('7033'); return false;\" title=\"Job lease not updated in shadow\">#7033</a></span> Updating the timestamp was accidentally lost in a previous commit.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-May-15 16:02", "status": "resolved", "created": "2019-May-02 15:54", "fixed_version": "2019-May-02 15:54", "broken_version": "v080704", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "a97444", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}