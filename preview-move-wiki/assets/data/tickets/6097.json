{"id": 6097, "title": "Ticket #6097: Incorrect SubmitterLimit for Group Accounting with Partionable Slots", "description": "<blockquote>\nWe're using partitionable slots with Hierarchical Group Accounting with a Linux CM and Windows Scheduler and Execute Nodes.\n\n<p>We have found that with our configuration the Negotiator will only match batches with number of jobs &gt; the minimum number of pslots (reflected in minSlotWeight in the negotiator log).   We have tested on versions 8.4.0 and 8.4.10.\n\n</p><p>This appears to be an interaction with NUM_CPUS in the pslot and number of procs in a cluster (changing NUM_CPUS on the exec nodes changes the Queue size that shows the bug).   I am attaching a copy of our current configs (with the domain and machine names obscured).\n\n</p><p>For example, our current configuration creates 1 partionable slot with NUM_CPUS=280 per execute host.  With that config this submit file:\n</p><div class=\"code\">\n<pre class=\"code\">    Universe = vanilla\n    requirements = TARGET.OpSys == \"WINDOWS\"\n    executable = C:\\windows\\system32\\ping.exe\n    arguments = 127.0.0.1 -n 180\n    should_transfer_files = yes\n    transfer_executable = false\n\n    accounting_group = groupb.regression\n    +Owner = \"watrousb\"\n    +NTDomain=\"foo_domain\"\n    RunAsOwner=True\n    Log = $(clusterid).$(procid).log\n\n    Queue\n</pre></div>\n\n\n<p>Results in a single idle job stuck in the queue.\n\n</p><p>Simply changing \"Queue\" to \"Queue 278\" or higher results in a job that runs to completion.\n\n</p><p>Condor_q shows that the job matches all slots (and all slots are unclaimed and idle):\n\n</p><p><strong>condor_q -better 2044.000</strong>\n</p><div class=\"code\">\n<pre class=\"code\">     2044.000:  Run analysis summary.  Of 2 machines,\n           0 are rejected by your job's requirements\n           0 reject your job because of their own requirements\n           0 match and are already running your jobs\n           0 match but are serving other users\n           0 are available to run your job\n             No successful match recorded.\n             Last failed match: Thu Jan 19 15:58:21 2017\n\n             Reason for last match failure: submitter limit exceeded\n\n     The Requirements expression for your job is:\n\n         ( TARGET.OpSys == \"WINDOWS\" ) &amp;&amp; ( TARGET.Arch == \"X86_64\" ) &amp;&amp;\n         ( TARGET.Disk &gt;= RequestDisk ) &amp;&amp; ( TARGET.Memory &gt;= RequestMemory ) &amp;&amp;\n         ( TARGET.HasFileTransfer ) &amp;&amp; ( TARGET.HasWindowsRunAsOwner &amp;&amp;\n           ( TARGET.LocalCredd is \"dev-credd.foo_domain.com\" ) )\n\n     Your job defines the following attributes:\n\n         DiskUsage = 20\n         ImageSize = 20\n         RequestDisk = 20\n         RequestMemory = 1\n\n     The Requirements expression for your job reduces to these conditions:\n\n              Slots\n     Step    Matched  Condition\n     -----  --------  ---------\n     [0]           2  TARGET.OpSys == \"WINDOWS\"\n     [1]           2  TARGET.Arch == \"X86_64\"\n     [3]           2  TARGET.Disk &gt;= RequestDisk\n     [5]           2  TARGET.Memory &gt;= RequestMemory\n     [7]           2  TARGET.HasFileTransfer\n     [9]           2  TARGET.HasWindowsRunAsOwner\n     [10]          2  TARGET.LocalCredd is \"dev-credd.foo_domain.com\"\n\n     Suggestions:\n\n         Condition                         Machines Matched    Suggestion\n         ---------                         ----------------    ----------\n     1   ( TARGET.OpSys == \"WINDOWS\" )     2\n     2   ( TARGET.Arch == \"X86_64\" )       2\n     3   ( TARGET.Disk &gt;= 20 )             2\n     4   ( TARGET.Memory &gt;= ifthenelse(MemoryUsage isnt undefined,MemoryUsage,1) )\n                                           2\n     5   ( TARGET.HasFileTransfer )        2\n     6   ( TARGET.HasWindowsRunAsOwner &amp;&amp; ( TARGET.LocalCredd is \"dev-credd.foo_domain.com\" ) )\n</pre></div>\n\n\n<p>Here is a sample of the Negotiator log for 3 different Queue counts [1, 277, 278]:\n(Notice that only Queue 278 results in a match (278 or higher works).)\n\n</p><p><strong>Queue 1</strong>\n</p><div class=\"code\">\n<pre class=\"code\">     01/19/17 16:24:07 Phase 4.1:  Negotiating with schedds ...\n     01/19/17 16:24:07     numSlots = 2 (after trimming=2)\n     01/19/17 16:24:07     slotWeightTotal = 1.000000\n     01/19/17 16:24:07     minSlotWeight = 280.000000\n     01/19/17 16:24:07     pieLeft = 1.000\n     01/19/17 16:24:07     NormalFactor = 1.000000\n     01/19/17 16:24:07     MaxPrioValue = 500.000000\n     01/19/17 16:24:07     NumSubmitterAds = 1\n     01/19/17 16:24:07   Negotiating with gaa.regression.watrousb@foo_domain at &lt;10.31.18.48:53084?addrs=10.31.18.48-53084&gt;\n     01/19/17 16:24:07 0 seconds so far for this submitter\n     01/19/17 16:24:07 0 seconds so far for this schedd\n     01/19/17 16:24:07    maxAllowed= 1   groupQuota= 1   groupusage=  0\n     01/19/17 16:24:07   Calculating submitter limit with the following parameters\n     01/19/17 16:24:07     SubmitterPrio       = 500.000000\n     01/19/17 16:24:07     SubmitterPrioFactor = 1000.000000\n     01/19/17 16:24:07     submitterShare      = 1.000000\n     01/19/17 16:24:07     submitterAbsShare   = 1.000000\n     01/19/17 16:24:07     submitterLimit    = 1.000000\n     01/19/17 16:24:07     submitterUsage    = 0.000000\n     01/19/17 16:24:07 Socket to gaa.regression.watrousb@foo_domain (&lt;10.31.18.48:53084?addrs=10.31.18.48-53084&gt;) already in cache, reusing\n     01/19/17 16:24:07     Sending SEND_RESOURCE_REQUEST_LIST/20/eom\n     01/19/17 16:24:07     Getting reply from schedd ...\n     01/19/17 16:24:07     Got JOB_INFO command; getting classad/eom\n     01/19/17 16:24:07     Getting reply from schedd ...\n     01/19/17 16:24:07     Got NO_MORE_JOBS;  schedd has no more requests\n     01/19/17 16:24:07     Request 02050.00000:  (request count 1 of 1)\n     01/19/17 16:24:07 matchmakingAlgorithm: limit 1.000000 used 0.000000 pieLeft 1.000000\n     01/19/17 16:24:07     Sending SEND_RESOURCE_REQUEST_LIST/20/eom\n     01/19/17 16:24:07     Getting reply from schedd ...\n     01/19/17 16:24:07     Got NO_MORE_JOBS;  schedd has no more requests\n     01/19/17 16:24:07   This submitter hit its submitterLimit.\n     01/19/17 16:24:07  resources used scheddUsed= 0.000000\n     01/19/17 16:24:07  negotiateWithGroup resources used scheddAds length 1\n</pre></div>\n\n\n<p><strong>Queue 277</strong>\n</p><div class=\"code\">\n<pre class=\"code\">     01/19/17 16:28:40 Phase 4.1:  Negotiating with schedds ...\n     01/19/17 16:28:40     numSlots = 2 (after trimming=2)\n     01/19/17 16:28:40     slotWeightTotal = 277.000000\n     01/19/17 16:28:40     minSlotWeight = 280.000000\n     01/19/17 16:28:40     pieLeft = 277.000\n     01/19/17 16:28:40     NormalFactor = 1.000000\n     01/19/17 16:28:40     MaxPrioValue = 500.000000\n     01/19/17 16:28:40     NumSubmitterAds = 1\n     01/19/17 16:28:40   Negotiating with gaa.regression.watrousb@foo_domain at &lt;10.31.18.48:53084?addrs=10.31.18.48-53084&gt;\n     01/19/17 16:28:40 0 seconds so far for this submitter\n     01/19/17 16:28:40 0 seconds so far for this schedd\n     01/19/17 16:28:40    maxAllowed= 277   groupQuota= 277   groupusage=  0\n     01/19/17 16:28:40   Calculating submitter limit with the following parameters\n     01/19/17 16:28:40     SubmitterPrio       = 500.000000\n     01/19/17 16:28:40     SubmitterPrioFactor = 1000.000000\n     01/19/17 16:28:40     submitterShare      = 1.000000\n     01/19/17 16:28:40     submitterAbsShare   = 1.000000\n     01/19/17 16:28:40     submitterLimit    = 277.000000\n     01/19/17 16:28:40     submitterUsage    = 0.000000\n     01/19/17 16:28:40 Socket to gaa.regression.watrousb@foo_domain (&lt;10.31.18.48:53084?addrs=10.31.18.48-53084&gt;) already in cache, reusing\n     01/19/17 16:28:40     Sending SEND_RESOURCE_REQUEST_LIST/20/eom\n     01/19/17 16:28:40     Getting reply from schedd ...\n     01/19/17 16:28:40     Got JOB_INFO command; getting classad/eom\n     01/19/17 16:28:40     Getting reply from schedd ...\n     01/19/17 16:28:40     Got NO_MORE_JOBS;  schedd has no more requests\n     01/19/17 16:28:40     Request 02053.00000:  (request count 1 of 277)\n     01/19/17 16:28:40 matchmakingAlgorithm: limit 277.000000 used 0.000000 pieLeft 277.000000\n     01/19/17 16:28:40     Sending SEND_RESOURCE_REQUEST_LIST/20/eom\n     01/19/17 16:28:40     Getting reply from schedd ...\n     01/19/17 16:28:40     Got NO_MORE_JOBS;  schedd has no more requests\n     01/19/17 16:28:40   This submitter hit its submitterLimit.\n     01/19/17 16:28:40  resources used scheddUsed= 0.000000\n     01/19/17 16:28:40  negotiateWithGroup resources used scheddAds length 1\n</pre></div>\n\n\n<p><strong>Queue 278</strong>\n</p><div class=\"code\">\n<pre class=\"code\">     01/19/17 16:54:35 Phase 4.1:  Negotiating with schedds ...\n     01/19/17 16:54:35     numSlots = 2 (after trimming=2)\n     01/19/17 16:54:35     slotWeightTotal = 278.000000\n     01/19/17 16:54:35     minSlotWeight = 280.000000\n     01/19/17 16:54:35     pieLeft = 278.000\n     01/19/17 16:54:35     NormalFactor = 1.000000\n     01/19/17 16:54:35     MaxPrioValue = 500.000000\n     01/19/17 16:54:35     NumSubmitterAds = 1\n     01/19/17 16:54:35   Negotiating with gaa.regression.watrousb@foo_domain at &lt;10.31.18.48:53084?addrs=10.31.18.48-53084&gt;\n     01/19/17 16:54:35 0 seconds so far for this submitter\n     01/19/17 16:54:35 0 seconds so far for this schedd\n     01/19/17 16:54:35    maxAllowed= 278   groupQuota= 278   groupusage=  0\n     01/19/17 16:54:35   Calculating submitter limit with the following parameters\n     01/19/17 16:54:35     SubmitterPrio       = 500.000000\n     01/19/17 16:54:35     SubmitterPrioFactor = 1000.000000\n     01/19/17 16:54:35     submitterShare      = 1.000000\n     01/19/17 16:54:35     submitterAbsShare   = 1.000000\n     01/19/17 16:54:35     submitterLimit    = 278.000000\n     01/19/17 16:54:35     submitterUsage    = 0.000000\n     01/19/17 16:54:35 Socket to gaa.regression.watrousb@foo_domain (&lt;10.31.18.48:53084?addrs=10.31.18.48-53084&gt;) already in cache, reusing\n     01/19/17 16:54:35     Sending SEND_RESOURCE_REQUEST_LIST/20/eom\n     01/19/17 16:54:35     Getting reply from schedd ...\n     01/19/17 16:54:35     Got JOB_INFO command; getting classad/eom\n     01/19/17 16:54:35     Getting reply from schedd ...\n     01/19/17 16:54:35     Got NO_MORE_JOBS;  schedd has no more requests\n     01/19/17 16:54:35     Request 02054.00000:  (request count 1 of 278)\n     01/19/17 16:54:35 matchmakingAlgorithm: limit 278.000000 used 0.000000 pieLeft 278.000000\n     01/19/17 16:54:35       Sending PERMISSION, claim id, startdAd to schedd\n     01/19/17 16:54:35       Notifying the accountant\n     01/19/17 16:54:35       Successfully matched with slot1@ST0PGRID39.foo_domaincapital.com\n     01/19/17 16:54:35 Match completed, match cost= 280\n     01/19/17 16:54:35     Reached submitter resource limit: 280.000000 ... stopping\n     01/19/17 16:54:35   This submitter hit its submitterLimit.\n     01/19/17 16:54:35  resources used scheddUsed= 280.000000\n     01/19/17 16:54:35 Group gaa.regression is using its quota 278 - halting negotiation\n     01/19/17 16:54:35  negotiateWithGroup resources used scheddAds length 1</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2017-Jan-20 15:07:27 by bwatrous:</em> <br/>\n\nBy the way, setting <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestCpus\" title=\"Request Cpus\">RequestCpus</a></span> high enough per Job works as well as increasing the Job count.   (In the example, Queue 1 with RequestCpus=280 would cause the Job to run as well.)\n\n<p></p><hr/>\n<em>2017-Jan-20 16:24:12 by gthain:</em> <br/>\n\nIs\n\n<p>CONSUMPTION_POLICY = true\n\n</p><p>set on the exec node as well?\n\n</p><p></p><hr/>\n<em>2017-Jan-23 09:27:57 by bwatrous:</em> <br/>\n\nGood question - i accidentally trimmed that setting out when minimizing my configuration, so CONSUMPTION_POLICY and SLOT_TYPE_1_CONSUMPTION_POLICY were both undefined.\n\n<p>I tried re-testing with explicitly set to both TRUE and FALSE:\nPS C:\\Users\\watrousb&gt; condor_config_val -dump | findstr CONSUMPTION_POLICY\nCONSUMPTION_POLICY = TRUE\nSLOT_TYPE_1_CONSUMPTION_POLICY = TRUE\n\n</p><p>I got the same result with both settings.\n\n</p><p></p><hr/>\n<em>2017-Jan-23 10:30:47 by gthain:</em> <br/>\n\nI'm having a hard time reproducing this problem here.  Can you turn on D_JOB and D_MACHINE in the negotiator, and send me the corresponding <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NegotiatorLog\" title=\"Negotiator Log\">NegotiatorLog</a></span>?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/981/groupQuotaWithPslots.zip\">groupQuotaWithPslots.zip</a>\n3366 bytes added by bwatrous on 2017-Jan-19 22:12:58 UTC.\n<br/>\nCM, Schedd and Exec condor configs <br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "", "type": "incident", "last_change": "2017-Jan-23 10:30", "status": "active", "created": "2017-Jan-19 16:09", "fixed_version": "2017-Jan-19 16:09", "broken_version": "v080410", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "gthain", "derived_from": "", "creator": "bwatrous", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bwatrous@cyclecomputing.com, tannenba@cs.wisc.edu", "due_date": ""}