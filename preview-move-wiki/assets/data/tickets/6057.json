{"id": 6057, "title": "Ticket #6057: startd cron does not update startd policy ad", "description": "<blockquote>\nGideon Juve wrote:\n\n<p></p><div class=\"verbatim\">\n<pre>I am having an issue where my startds reject valid claims, and I believe it\nis due to a bug somewhere in the startd.\n\nMy startds are configured with one slot that is not partitionable.\n\nEach startd also runs a startd cron job that determines the value of the\nSTART expression that looks something like this:\n\nSTARTD_CRON_JOBLIST = $(STARTD_CRON_JOBLIST) POLICY\nSTARTD_CRON_POLICY_MODE = Periodic\nSTARTD_CRON_POLICY_RECONFIG_RERUN = True\nSTARTD_CRON_POLICY_PERIOD = 15m\nSTARTD_CRON_POLICY_EXECUTABLE = get_policy_from_service\n\nIncluding:\n\nSTARTD_CRON_AUTOPUBLISH = Always\n\nAnd the START expression is set like this:\n\nSTART = Policy\n\nAnd the value of Policy is updated by the cron job.\n\nWhen the policy needs to change, I reconfig the machine to get it to pull\ndown its new policy from a central service.\n\nOccasionally, the policy change will cause the START expression to evaluate\nto TRUE when it was previously FALSE. When that happens, the collector\n(almost) immediately gets a new ad for the machine and it gets matched with\na job. However, the startd rejects the claim for the remainder of\nUPDATE_INTERVAL (set to 300 seconds) until the startd reevaluates and\nrepublishes its ad again. In the rejection message in the log it prints the\nprevious machine ad (not the one that it just sent to the collector).\n\nThis leads me to believe that there is some internal state that is not\ngetting updated when the cron job causes a new ad to be published.\nEventually that state is updated the next time the startd publishes its ad.\n\nThis is using 8.4.2 on Ubuntu 16.04.\n</pre></div>\n\n\n<p>Preliminary investigation reveals the following problem: the startd cron job calls <code>ResMgr::update_all()</code> when <code>STARTD_CRON_AUTOPUBLISH</code> is set.  <code>ResMgr::update_all()</code> ends up calling <code>Resource::publish_for_update()</code>, which calls <code>Resource::publish()</code> with the mask <code>A_ALL_PUB</code>, which calls <code>RsMgr::adlist_publish()</code> with the same mask.  However\n<code>ResMgr::adlist_publish()</code> publishes ads (including the cron job ad) if and only if the mask has the public and update bits sets, and <code>A_ALL_PUB</code> does not set the update bit.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Dec-19 16:17:42 by tlmiller:</em> <br/>\n\nIt remains to be seen if this causes the reported problem, which on the surface appears to be the opposite issue.\n\n<p></p><hr/>\n<em>2016-Dec-20 14:47:56 by tlmiller:</em> <br/>\n\nTurns out that A_ALL_PUB <em>does</em> include A_UPDATE -- just indirectly.\n\n<p>The actual problem is that <code>update_all()</code> doesn't actually update everything.  There's a completely different code path to actually update the ads the startd actually uses to evaluate policy expressions.  Patch demonstrated locally, in testing.\n\n</p><p></p><hr/>\n<em>2016-Dec-21 14:13:10 by tlmiller:</em> <br/>\n\nBuild IDs 391631 (8.4) and 391513 (master) were the tests.\n\n<p></p><hr/>\n<em>2017-Jan-11 13:48:30 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong>: looks good. as we discussed.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-21 14:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49860\">[49860]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6057\" onclick=\"get_ticket_and_populate_wrapper('6057'); return false;\" title=\"startd cron does not update startd policy ad\">#6057</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-21 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49858\">[49858]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6057\" onclick=\"get_ticket_and_populate_wrapper('6057'); return false;\" title=\"startd cron does not update startd policy ad\">#6057</a></span>) Force an update to each internal/policy slot ad after each cron job.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-11 13:49", "status": "resolved", "created": "2016-Dec-19 16:16", "fixed_version": "2016-Dec-19 16:16", "broken_version": "v080402", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "", "creator": "tlmiller", "rust": "a31217", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, Gideon.Juve@spacex.com", "due_date": ""}