{"id": 6786, "title": "Ticket #6786: notification on Error poorly documented", "description": "<blockquote>\nPage 909 of the HTCondor 8.7.9 manual states\n\n<p></p><div class=\"verbatim\">\n<pre>If defined by Error, the owner will only be notified if the job terminates abnormally, (as defined by JobSuccessExitCode,\nif defined) or if the job is placed on hold because of a failure, and not by user request\n</pre></div>\n\n\n<p>This differs from from the HTCondor 8.6.12 manual by the inclusion of the text surrounding <code>JobSuccessExitCode</code>. The meaning of <code>JobSuccessExitCode</code> is not defined anywhere in the manual and is undefined for all jobs in my 8.7.9 queue and <code>condor_history</code>. Even when one uses the submit command <code>success_exit_code</code> it remains undefined.\n\n</p><p>So, I think it's safe to say that there's a documentation bug here.\n\n</p><p>But, it does more or less behave as we want it to. For HTCondor 8.7.9, the behavior of <code>Error</code> includes when jobs exit by a code other than 0 or by the explicit value set by <code>success_exit_code</code>. What is less clear (from the text above) is whether it will continue the behavior of notification on abnormal termination (e.g. a segfault).\n\n</p><p>I'd much prefer to see text that was clearer (\"this looks like a job for bulleted lists!\") and relies only on classads / commands that exist. For example:\n\n</p><p></p><div class=\"verbatim\">\n<pre>If *set to* Error, the owner *will be notified* if the job terminates abnormally  (e.g. segfault), or if the job exits with a code other than that set by success_exit_code (default value of 0), or if the job is placed on hold by HTCondor due to a failure / cgroups limit rather than through use of the command condor_hold.\n</pre></div>\n\n\n<p>Obviously the documentation should reflect your intent and the actual behavior. So, please fix as you see fit.\n\n</p><p>Thanks!</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Oct-01 14:40:39 by tlmiller:</em> <br/>\n\nLooking at the submit code:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">#define SUBMIT_KEY_SuccessExitCode \"success_exit_code\"\n....\n#define ATTR_JOB_SUCCESS_EXIT_CODE \"JobSuccessExitCode\"\n....\nAssignJobVal(ATTR_JOB_SUCCESS_EXIT_CODE, success_code);\n</pre></div>\n\n\n<p>and at the email code:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">Email::shouldSend( ClassAd* ad, int exit_reason, bool is_error ) {\n....\nad-&gt;LookupInteger( ATTR_JOB_NOTIFICATION, notification );\nswitch( notification ) {\n....\n        case NOTIFY_ERROR:\n....\n            ad-&gt;LookupInteger( ATTR_ON_EXIT_CODE, exitCode );\n            ad-&gt;LookupInteger( ATTR_JOB_SUCCESS_EXIT_CODE, successExitCode );\n            if( exitCode != successExitCode ) {\n                return true;\n            }\n</pre></div>\n\n\n<p>as of the 8.7.10 branch, and it looks like this should all work, and indeed a quick test with a sleep job shows 'JobSuccessExitCode' showing up in both condor_q and condor_history.\n\n</p><p>The code from <code>shouldSend()</code> dates back to 8.7.7, and the code for success_exit_code to at least as far back as 8.5.8 (?!), so I'm not sure why you're not seeing anything.\n\n</p><p></p><hr/>\n<em>2018-Oct-01 14:50:41 by tlmiller:</em> <br/>\n\nBased on a review of the code, the documentation should read something like the following:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">Owners of HTCondor jobs are notified by e-mail when certain events occur.\nIf \\SubmitCmd{notification} is \\Arg{Always}...\nIf \\SubmitCmd{notification} is \\Arg{Complete}...\n....\nIf \\SubmitCmd{notification} is \\Arg{Error}, the owner will be notified if:\n* the job dumped core;\n* the job exited by a signal;\n* the job went on hold (but not if: the user requested it, the job was submitted on hold, or the job was held by its own policy expressions);\n* or the job terminated with an unexpected exit code (0, unless set otherwise by \\SubmitCmd{success_exit_code} or the job ad attribute \\Attr{JobSuccessExitCode}).\n</pre></div>\n\n\n<p></p><hr/>\n<em>2018-Oct-01 14:55:02 by tlmiller:</em> <br/>\n\nThis text needs to be corrected in both <code>man-pages/submitcmds.tex</code> and <code>admin-man/configure.tex</code> (where the inline copy should probably be replaced with the appropriate reference).\n\n<p>We also need to add <code>JobSuccessExitCode</code> to <code>misc/jobad.tex</code>.\n\n</p><p></p><hr/>\n<em>2018-Oct-01 15:05:12 by gthain:</em> <br/>\n\nnote that if you set\n\n<p>success_exit_code = 0\n\n</p><p>We don't set <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobSuccessExitCode\" title=\"Job Success Exit Code\">JobSuccessExitCode</a></span>.  I would classify that as a bug.\n\n</p><p></p><hr/>\n<em>2018-Oct-02 11:45:34 by tpdownes:</em> <br/>\n\nYes, that's it Greg. I started testing this a bit more and couldn't figure out what I must have done wrong!\n\n<p></p><hr/>\n<em>2018-Oct-02 12:01:59 by tpdownes:</em> <br/>\n\nJust for coolness factor, job transforms are great when you are in a mixed 8.6/8.7 environment:\n\n<p></p><div class=\"verbatim\">\n<pre>So, it would be good if you could do this so that folks can get \u201cnotification = error\u201d behavior that they expect. Reed isn\u2019t the first one to be confused.\nJOB_TRANSFORM_NAMES = $(JOB_TRANSFORM_NAMES) HackErrorNotifications\nJOB_TRANSFORM_HackErrorNotifications @=end\n[\nRequirements = JobNotification == 3;\nset_JobNotification = IfThenElse(ExitCode isnt undefined &amp;&amp; ExitCode=!=0, 2,3);\n]\n@end\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-30 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55667\">[55667]</a></span>: Prepare for build. Also, docs for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6725\" onclick=\"get_ticket_and_populate_wrapper('6725'); return false;\" title=\"starter crash when deleting docker images\">#6725</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6755\" onclick=\"get_ticket_and_populate_wrapper('6755'); return false;\" title=\"condor_tail -stderr always results in an error\">#6755</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6710\" onclick=\"get_ticket_and_populate_wrapper('6710'); return false;\" title=\"Make condor_submit -i work with docker jobs\">#6710</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6750\" onclick=\"get_ticket_and_populate_wrapper('6750'); return false;\" title=\"A single cpu job may never match a pslot\">#6750</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6731\" onclick=\"get_ticket_and_populate_wrapper('6731'); return false;\" title=\"Allow admin to add additional singularity command line args\">#6731</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6757\" onclick=\"get_ticket_and_populate_wrapper('6757'); return false;\" title=\"Accounting ads cannot be forwarded by the gangliad\">#6757</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6758\" onclick=\"get_ticket_and_populate_wrapper('6758'); return false;\" title=\"Add DaemonLastReconfigTime attribute to condor daemons\">#6758</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6714\" onclick=\"get_ticket_and_populate_wrapper('6714'); return false;\" title=\"When surplus and pslots enabled, if demand &lt; pslot size, no jobs match\">#6714</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6711\" onclick=\"get_ticket_and_populate_wrapper('6711'); return false;\" title=\"condor_ssh_to_job -X tries to use ipv6 localhost even when disabled\">#6711</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6786\" onclick=\"get_ticket_and_populate_wrapper('6786'); return false;\" title=\"notification on Error poorly documented\">#6786</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6797\" onclick=\"get_ticket_and_populate_wrapper('6797'); return false;\" title=\"ec2 configuration file in tarball config directory\">#6797</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6709\" onclick=\"get_ticket_and_populate_wrapper('6709'); return false;\" title=\"Improved default configuration for packaged builds\">#6709</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-01 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55514\">[55514]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6786\" onclick=\"get_ticket_and_populate_wrapper('6786'); return false;\" title=\"notification on Error poorly documented\">#6786</a></span>) Set the success_exit_code when requested  (By Tim Theisen )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Oct-30 16:37", "status": "resolved", "created": "2018-Oct-01 12:06", "fixed_version": "2018-Oct-01 12:06", "broken_version": "v080709", "priority": "2", "subsystem": "", "assigned_to": "tim", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "downes@uwm.edu,pcouvare@caltech.edu", "due_date": ""}