{"id": 3616, "title": "Ticket #3616: schedd fails to restart after writing unparseable values into log", "description": "<blockquote>\nThe classad log code can write unparseable values into the log file (e.g. job_queue.log), and as a result of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3069\" onclick=\"get_ticket_and_populate_wrapper('3069'); return false;\" title=\"RFE: config setting to enable/disable strict classad log exprs\">#3069</a></span> it could EXCEPT on restart when it replays the log and hits the invalid line.\n\n<p>The most common way to trigger this landmine is perform a condor_qedit using a illegal classad value such as <code>$$$</code> (no quotation marks), or even spaces.  If you then try to restart the schedd before the schedd rotates the log (which is currently only every 24 hours by default), the schedd will EXCEPT on restart.\n\n</p><p>The fix should not be at the level of the schedd, but at the level of the classad log code -- note that this is where the bug resides, and that the classad log code is used by more than just the schedd (e.g. it is also used by the accountant inside the negotiator, by the collector for offline and absent ads, ...). Before writing an attribute value to the log (aka job_queue.log), make certain the value can be parsed. Because parsing is relatively expensive, this should be done efficiently by parsing only once when the log event is created. The resulting parse tree could then be stored in ram and reused when the log is played. If the value fails to parse, the value will be changed to UNDEFINED.\n\n</p><p>As an aside, it would be nice if \"condor_qedit\" validated the attribute value and gave an immediate error back to the user.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Nov-21 15:45:30 by tannenba:</em> <br/>\n\n<strong>TESTING</strong>\n\n<p>First, in order to demonstrate the problem, here is output using unmodified schedd and qedit :\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\spool&gt;condor_qedit 7.0 testattr \"###BAD***\"\nSet attribute \"testattr\".\n\nC:\\condor\\spool&gt;grep testattr job_queue.log\n103 7.0 testattr ###BAD***\n</pre></div>\n\n\n<p>To demonstrate that the schedd will refuse to write bad values into the log (it converts bad values to <code>UNDEFINED</code>) regardless of the client used, here is output using a schedd modified by <span class=\"chng\"><a href=\"chngview?cn=38806\">[38806]</a></span>, but still used an unmodified qedit:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\spool&gt;condor_qedit 7.0 badattr \"###BAD***\"\nSet attribute \"badattr\".\n\nC:\\condor\\spool&gt;condor_qedit 7.0 badattr1 \"  \"\nSet attribute \"badattr1\".\n\nC:\\condor\\spool&gt;grep badattr job_queue.log\n103 7.0 badattr UNDEFINED\n103 7.0 badattr1 UNDEFINED\n</pre></div>\n\n\n<p>Finally, here is test including the changes to qedit, demonstrating that qedit now catches these problems and reports error messages back to the user:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\spool&gt;condor_qedit 7.0 \"###foo\" \"bar\"\nUpdate aborted, illegal attribute-name specified for attribute \"###foo\".\nTransaction failed.  No attributes were set.\n\nC:\\condor\\spool&gt;condor_qedit 7.0 badattr1 \"  \"\nUpdate aborted, illegal attribute-value specified for attribute \"badattr1\".\nTransaction failed.  No attributes were set.\n\nC:\\condor\\spool&gt;condor_qedit 7.0 testattr1 \"good\" testattr2 \"###bad\"\nSet attribute \"testattr1\".\nUpdate aborted, illegal attribute-value specified for attribute \"testattr2\".\nTransaction failed.  No attributes were set.\n\nC:\\condor\\spool&gt;grep testattr \\condor\\spool\\job_queue.log\n\nC:\\condor\\spool&gt;condor_qedit 7.0 testattr1 \"good\"\nSet attribute \"testattr1\".\n\nC:\\condor\\spool&gt;grep testattr \\condor\\spool\\job_queue.log\n103 7.0 testattr1 good\n</pre></div>\n\n\n<p></p><hr/>\n<em>2014-Feb-13 16:39:18 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> by zmiller:  All looks well and good.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-27 09:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38870\">[38870]</a></span>: Add note to condor_qedit man page about checking syntax of attribute names/values <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3616\" onclick=\"get_ticket_and_populate_wrapper('3616'); return false;\" title=\"schedd fails to restart after writing unparseable values into log\">#3616</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-21 15:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38809\">[38809]</a></span>: Version history entry re hardening of classad log and qedit. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3616\" onclick=\"get_ticket_and_populate_wrapper('3616'); return false;\" title=\"schedd fails to restart after writing unparseable values into log\">#3616</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-21 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38807\">[38807]</a></span>: Enhance condor_qedit to check validity of attr names and values. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3616\" onclick=\"get_ticket_and_populate_wrapper('3616'); return false;\" title=\"schedd fails to restart after writing unparseable values into log\">#3616</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-21 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=38806\">[38806]</a></span>: Do not write unparseable values into classad collection logs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3616\" onclick=\"get_ticket_and_populate_wrapper('3616'); return false;\" title=\"schedd fails to restart after writing unparseable values into log\">#3616</a></span> Before writing an attribute value to the log (aka job_queue.log), make certain the value can be parsed. This is done efficiently because the parsing is only done once when the log event is created. The parse tree is then stored in ram\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-13 16:39", "status": "resolved", "created": "2013-May-13 08:46", "fixed_version": "2013-May-13 08:46", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu", "due_date": ""}