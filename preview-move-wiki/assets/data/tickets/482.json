{"id": 482, "title": "Ticket #482: Thread Local storage breaks cross tests from 32b rhel 3->64 bit rhel3", "description": "<blockquote>\nWhen thread support was merged, the cross test failed from 32 bit rhel 3 to 64 bit rhel3.  All other combinations seem to work.  The tests fail early, in remote_pre, because condor_config_val (and all the tools) core dump on startup when trying to initialize dprintf.\n\n<p>Running condor_config_val under gdb shows the following:\n</p><div class=\"code\">\n<pre class=\"code\">Program received signal SIGSEGV, Segmentation fault.\n_condor_dprintf_va (flags=4096, fmt=0x82c3ba0 \"config: using subsystem '%s', local '%s'\\n\",args=0xffff96a8 \"\\200u7\\b\\231;,\\b\\bu7\\bN\\032@\ufffd\\002@\\\"\\016\\b\\bu7\\b\\bu7\\b\\034\\026 @\\bu7\\b\\bu7\\b\ufffd@\ufffd\\a@\\\"\\016\\bps7\\b\\bu7\\b&gt;I\\a@\ufffd\\001@\ufffd020\\002\")\n\n    at dprintf.c:201\n\n201                     CurrentTid = 0;\n\nand gdb seems confused about TLS:\n(gdb) p CurrentTid\nCannot find thread-local variables on this target\n</pre></div>\n\n\n<p>I've disabled this cross test for the moment, when this test is resolved\nthe 32 bit rhel3 -&gt; 64 bit rhel3 test should be re-enabled.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-May-15 06:32:01 by tannenba:</em> <br/>\n\nIt seems more serious than just x86_64_rhas.  We observed very strange behavior (gdb crashing, master just stopping) on SL4.6.  For v7.3.1, going to disable linking in of pthreads/TLS all together, and then get rid of TLS for 7.3.2.\n\n<p></p><hr/>\n<em>2009-May-15 09:25:29 by gthain:</em> <br/>\n\nWe need to read the drepper white paper at <a class=\"external\" href=\"http://people.redhat.com/drepper/tls.pdf\">http://people.redhat.com/drepper/tls.pdf</a>\n\n<p>Note that C98 adds support for the __thread storage specifier, perhaps that would be a better implementation?\n\n</p><p>There's gcc options that might help:\n</p><div class=\"code\">\n<pre class=\"code\">-mtls-direct-seg-refs\n-mno-tls-direct-seg-refs\n    Controls whether TLS variables may be accessed with offsets from the TLS segment register (%gs for 32-bit, %fs for 64-bit), or whether the thread base pointer must be added. Whether or not this is legal depends on the operating system, and whether it maps the segment to cover the entire TLS area.\n\n    For systems that use GNU libc, the default is on.\n\n\n-ftls-model=model\n    Alter the thread-local storage model to be used (see Thread-Local). The model argument should be one of global-dynamic, local-dynamic, initial-exec or local-exec.\n\n    The default without -fpic is initial-exec; with -fpic the default is global-dynamic.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Aug-17 08:34:06 by tannenba:</em> <br/>\n\nRe the remark above - good thinking, and looks promising, but I have to say having been burned on TLS once I am shy to try another iteration of it again.\n\n<p></p><hr/>\n<em>2009-Aug-17 08:41:01 by tannenba:</em> <br/>\n\nSo one of the more subtle and annoying aspects of getting rid of the thread local storage is dealing w/ the recursive nature of dprintf().  dprintfs() happens all over Condor, including in the hashtable template etc.  And yet dprintf() wants to display the tid.  So we are left with some choices:\n<ol>\n<li>Deal w/ the recursive nature of the above by being able to detect a re-entrancy into dprintf and making it a no-op, or\n</li><li>Use pthread keys to give us the same mechanism as TLS, and stash the tid in the key.</li></ol>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/73/diff\">diff</a>\n57479 bytes added by gthain on 2009-Aug-13 16:57:20 UTC.\n<br/>\nThis is a patch which removes the needs for TLS, by passing the datapointer as an argument.  compiles everywhere, but fails tests on windows<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-26 20:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d5a23f9394d55cdf81d947e22b801086b735bfee\">[15516]</a></span>: No need for VOMS to explicitly link w/ pthreads now that threading in Condor has been merged into the code (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-24 09:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5ba6162e1823d8032e87cf9495ea9946a95a8eb3\">[15466]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/66a8130e19147ef01a5e5e7830c98808821fb452\">[15382]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/15165670ba94ea74802585afed8f5419d3ffab8c\">[15383]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/56b941aa673ac87be01012cbbc3ee2d91a55bcb5\">[15397]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f2e90fba1b9e45a0d759683d5f8240480899a077\">[15432]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/04f1cb7ff9af82af6f4776dd8bd330a7bed1d03d\">[15433]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/12a922910527cb74cacc1794184650dcd38f835c\">[15434]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b45be0434acc0ed2b75cbb44b7b955e64902dec\">[15435]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4117befc073ffc7bf1075ee3ccbb4bc945695e6\">[15440]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4ab2e2fcb8f222597718613f1a8f4d52deee606\">[15441]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38ea5c09b1d87938244daec83978c3c38069a95b\">[15457]</a></span>, Merge branch 'V7_3-Threads-2-branch' into V7_3_2-branch. This merges in code changes to remove Thread Local Storage code from the thread support, and re-enable linking of pthreads on Linux. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-23 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38ea5c09b1d87938244daec83978c3c38069a95b\">[15457]</a></span>: Fix syntax typo in condor_constants.h (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4ab2e2fcb8f222597718613f1a8f4d52deee606\">[15441]</a></span>: Fix build on Win32 after a bunch of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorThread\" title=\"Condor Thread\">CondorThread</a></span> changes. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 16:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4117befc073ffc7bf1075ee3ccbb4bc945695e6\">[15440]</a></span>: Purge checks for thread local storage, and link in pthreads on Linux. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 12:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b45be0434acc0ed2b75cbb44b7b955e64902dec\">[15435]</a></span>: Get rid of Thread Local Storage for daemonCore's Get/SetDataPtr methods. Instead of relying upon TLS to handle get/set dataptr methods, daemonCore now registers a thread switch callback with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorThreads\" title=\"Condor Threads\">CondorThreads</a></span> and stashes/restores the dataptr data in CondorThread's thread context. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 12:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/04f1cb7ff9af82af6f4776dd8bd330a7bed1d03d\">[15433]</a></span>: Fixed some bugs involving <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorThreads\" title=\"Condor Threads\">CondorThreads</a></span> missing thread status changes. This is important to get right to purge TLS, since our mechanism that issues a callback to daemonCore whenever a context switch occurs relies upon having method set_status() always do the correct thing. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-21 12:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f2e90fba1b9e45a0d759683d5f8240480899a077\">[15432]</a></span>: Make certain user thread data is deallocated when thread goes away. <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorThreads\" title=\"Condor Threads\">CondorThreads</a></span> invokes delete on the user thread pointer (that is passed to the thread context switch callback) when the thread goes away, but C++ cannot invoke a destructor on a void*. So we now assume that the user thread data class\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-19 07:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/56b941aa673ac87be01012cbbc3ee2d91a55bcb5\">[15397]</a></span>: Added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorThreads\" title=\"Condor Threads\">CondorThreads</a></span> method to register a callback on a context switch. The idea is <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> can use this callback to swap back in thread local data and/or reset process-wide state such as uid/gids. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-17 15:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/15165670ba94ea74802585afed8f5419d3ffab8c\">[15383]</a></span>: No longer use thread local storage (TLS) for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTid\" title=\"Current Tid\">CurrentTid</a></span> in dprintf. Instead relying on a TLS variable, dprintf now calls a new method CondorThreads::get_tid(), which quickly returns the tid by leveraging pthreads keys and thus avoids the locking and recursion issues of calling CondorThreads::get_handle()-&gt;get_tid().\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-15 06:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3a7db44c3ed0715824a52973abf04269b9971f5c\">[14693]</a></span>: Disable linking in pthreads and using TLS for now on all Unixes (gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>).  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-13 12:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fe407a2771adce4ca230952a6f9044bcf41a1c1a\">[14675]</a></span>: Remove x86 rhel 3 -&gt; x86_64 rhel 3 cross test as per <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=482\" onclick=\"get_ticket_and_populate_wrapper('482'); return false;\" title=\"Thread Local storage breaks cross tests from 32b rhel 3-&gt;64 bit rhel3\">#482</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 13:40", "status": "resolved", "created": "2009-May-13 11:59", "fixed_version": "2009-May-13 11:59", "broken_version": "v070300", "priority": "2", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "#17", "creator": "tannenba", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}