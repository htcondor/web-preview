{"id": 2809, "title": "Ticket #2809: Rogue condor_shadows after condor_rm -forcex", "description": "<blockquote>\nFrom the thread \"[CondorLIGO] LIGO: condor_status out of sync\".\n\n<p></p><pre>  $CondorVersion: 7.6.6 Jan 17 2012 BuildID: 401976 $\n  $CondorPlatform: x86_64_rhap_6.1-updated $\n</pre>\n\n<p>150 jobs were running under a DAG.  The DAG was condor_rmed.  Many (all?) of the jobs lingered in X.  The user eventually noticed this after an unknown delay and ran <code>condor_rm -forcex</code> on them.  The jobs left the queue, but the condor_shadows lingered.  The corresponding condor_starters are believed gone.  The condor_schedd no longer reported the jobs in condor_q, but the command <code>\"condor_status -submitters -total | grep USERNAME\"</code> includes the rogue shadows in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunningJobs\" title=\"Running Jobs\">RunningJobs</a></span> total.\n\n</p><p>Currently gathering more information.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Feb-09 22:51:09 by pfc:</em> <br/>\n\nThis may be related to <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=556\" onclick=\"get_ticket_and_populate_wrapper('556'); return false;\" title=\"MAX_JOBS_RUNNING inconsistent with queue after condor_rm -force\">#556</a></span>.\n\n<p></p><hr/>\n<em>2012-Feb-10 14:30:50 by pfc:</em> <br/>\n\nUpdated priority to match Todd's new scheme (1=fire, 2=soon, 3=time permitting, 4=not yet prioritized, 5=wishlist/ideas).\n\n<p></p><hr/>\n<em>2012-Feb-10 16:34:01 by adesmet:</em> <br/>\n\nAfter some discussion, here are the problems and our current plan:\n\n<p>PROBLEM: Jobs hang out in X far too long.\n\n</p><p>SOLUTION: As of 7.6.6, Condor will kill shadows when the lease expires.  This should cause the job to leave the queue.  We hope this will resolve most, if not all, of the jobs hanging around in X.\n\n</p><p>PROBLEM: condor_rm -forcex doesn't necessarily remove the job from the queue.\n\n</p><p>SOLUTION: We will change -forcex to be more aggressive.  -forcex should mean, \"I don't care about this job in any way, tear it out of the queue by any means necessary.\" The shadow will be promptly killed and the job yanked from the queue.  Some final cleanup may not happen.\n\n</p><p>PROBLEM: Jobs hang out in X.\n\n</p><p>SOLUTION: There isn't a clear cause for the problem. Multiple different problems may lead to this.  Some are out of our control (e.g. a process stuck in uninterruptable sleep).  Others may be bugs in Condor.  So despite all of the above, we ask that any jobs that end up in X still be investigated and reported to us so we can identify the biggest problems and improve our handling.\n\n</p><p></p><hr/>\n<em>2012-Feb-20 13:01:54 by adesmet:</em> <br/>\n\n\"We will change -forcex to be more aggressive\" - Goal: 2012-02-25\n\n<p></p><hr/>\n<em>2012-Feb-27 14:37:03 by adesmet:</em> <br/>\n\nSeeking reviewer for the code.\n\n<p></p><hr/>\n<em>2012-Mar-12 13:59:07 by adesmet:</em> <br/>\n\nClosed <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=556\" onclick=\"get_ticket_and_populate_wrapper('556'); return false;\" title=\"MAX_JOBS_RUNNING inconsistent with queue after condor_rm -force\">#556</a></span>: MAX_JOBS_RUNNING inconsistent with queue after condor_rm -force as a duplicate. It was associated with condor-admin 19245.\n\n<p></p><hr/>\n<em>2012-Mar-21 15:48:50 by jfrey:</em> <br/>\n\n<strong>CODE REVIEW</strong> The changes in actOnJobMyselfHandler() to aggressively kill a shadow on an rm -forcex look good.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-13 14:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30893\">[30893]</a></span>: minor edit to version history item, ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2809\" onclick=\"get_ticket_and_populate_wrapper('2809'); return false;\" title=\"Rogue condor_shadows after condor_rm -forcex\">#2809</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-27 12:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30711\">[30711]</a></span>: Fix crash if shadow already gone when condor_rm -forcex. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2809\" onclick=\"get_ticket_and_populate_wrapper('2809'); return false;\" title=\"Rogue condor_shadows after condor_rm -forcex\">#2809</a></span> Bug introduced in <span class=\"chng\"><a href=\"chngview?cn=30696\">[30696]</a></span>, never shipped, no documentation necessary.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-23 18:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30697\">[30697]</a></span>: Document work on <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2809\" onclick=\"get_ticket_and_populate_wrapper('2809'); return false;\" title=\"Rogue condor_shadows after condor_rm -forcex\">#2809</a></span> - aggressively kill shadows when condor_rm -forcex  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-23 18:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30696\">[30696]</a></span>: When condor_rm -forcex ing, kill shadow with extreme prejudice. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2809\" onclick=\"get_ticket_and_populate_wrapper('2809'); return false;\" title=\"Rogue condor_shadows after condor_rm -forcex\">#2809</a></span> Goal: Ensure jobs don't linger in X even past a -forcex (and counting as a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunningJob\" title=\"Running Job\">RunningJob</a></span>!) in the event of the shadow blocking indefinitely on something. The shadow blocking indefinitely is a seperate issue.  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Apr-09 15:43", "status": "defer", "created": "2012-Feb-07 13:51", "fixed_version": "2012-Feb-07 13:51", "broken_version": "v070606", "priority": "5", "subsystem": "", "assigned_to": "adesmet", "derived_from": "", "creator": "adesmet", "rust": "a23110", "customer_group": "ligo", "visibility": "public", "notify": "tstclair@redhat.com,pcouvare@caltech.edu", "due_date": ""}