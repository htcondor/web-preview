{"id": 2695, "title": "Ticket #2695: 90 minute timeout in CCB listener", "description": "<blockquote>\nThe following was observed, and leads one to the suspicion that <code>CCBListener::ReadMsgFromCCB()</code> might have blocked for 90 minutes.  In all my testing with a debugger, the socket timeout is set to CCB_TIMEOUT (300) when this function is called, so I cannot explain how the read could have blocked for 90 minutes.  The error reported by recv() is ETIMEDOUT.  This seems rather unexpected for a non-blocking read.\n\n<p></p><div class=\"verbatim\">\n<pre>11/23/11 16:47:10 (pid:16038) ******************************************************\n11/23/11 16:47:10 (pid:16038) ** condor_starter (CONDOR_STARTER) STARTING UP\n11/23/11 16:47:10 (pid:16038) ** /state/partition1/glide_v13834/main/condor/sbin/condor_starter\n11/23/11 16:47:10 (pid:16038) ** SubsystemInfo: name=STARTER type=STARTER(8) class=DAEMON(1)\n11/23/11 16:47:10 (pid:16038) ** Configuration: subsystem:STARTER local:&lt;NONE&gt; class:DAEMON\n11/23/11 16:47:10 (pid:16038) ** $CondorVersion: 7.6.2 Jul 15 2011 BuildID: 351672 $\n11/23/11 16:47:10 (pid:16038) ** $CondorPlatform: x86_rhap_5 $\n11/23/11 16:47:10 (pid:16038) ** PID = 16038\n11/23/11 16:47:10 (pid:16038) ** Log last touched 11/23 16:46:58\n11/23/11 16:47:10 (pid:16038) ******************************************************\n11/23/11 16:47:10 (pid:16038) Using config source: /state/partition1/glide_v13834/condor_config\n11/23/11 16:47:10 (pid:16038) DaemonCore: command socket at &lt;10.6.2.198:37091?noUDP&gt;\n11/23/11 16:47:10 (pid:16038) DaemonCore: private command socket at &lt;10.6.2.198:37091&gt;\n11/23/11 16:47:10 (pid:16038) Setting maximum accepts per cycle 4.\n11/23/11 16:47:11 (pid:16038) ZKM: Parsing map file.\n11/23/11 16:47:11 (pid:16038) ZKM: 1: attempting to map '/DC=org/DC=doegrids/OU=Services/CN=glidein/glidein.chtc.wisc.edu'\n11/23/11 16:47:11 (pid:16038) ZKM: 2: mapret: 0 included_voms: 0 canonical_user: collector1\n11/23/11 16:47:11 (pid:16038) ZKM: successful mapping to collector1\n11/23/11 16:47:11 (pid:16038) CCBListener: registered with CCB server glidein.chtc.wisc.edu:9661 as ccbid 128.104.59.136:9661#218828\n11/23/11 16:47:11 (pid:16038) Done setting resource limits\n11/23/11 16:47:11 (pid:16038) Communicating with shadow &lt;144.92.167.254:9617?sock=13254_6454_3354&gt;\n11/23/11 16:47:11 (pid:16038) Submitting machine is \"minnow.bmrb.wisc.edu\"\n11/23/11 16:47:11 (pid:16038) setting the orig job name in starter\n11/23/11 16:47:11 (pid:16038) setting the orig job iwd in starter\n11/23/11 16:47:11 (pid:16038) ZKM: 1: attempting to map '/DC=org/DC=doegrids/OU=Services/CN=pilot/glidein.chtc.wisc.edu'\n11/23/11 16:47:11 (pid:16038) ZKM: 2: mapret: 0 included_voms: 0 canonical_user: condor\n11/23/11 16:47:11 (pid:16038) ZKM: successful mapping to condor\n11/23/11 19:16:38 (pid:16038) condor_read() failed: recv() returned -1, errno =\n 110 Connection timed out, reading 21 bytes from collector glidein.chtc.wisc.edu:9661.\n11/23/11 19:16:38 (pid:16038) IO: Failed to read packet header\n11/23/11 19:16:38 (pid:16038) CCBListener: failed to receive message from CCB\n server glidein.chtc.wisc.edu:9661\n11/23/11 19:16:38 (pid:16038) CCBListener: connection to CCB server glidein.chtc.wisc.edu:9661 failed; will try to reconnect in 60 seconds.\n11/23/11 19:16:38 (pid:16038) condor_write(): Socket closed when trying to write 4096 bytes to daemon at &lt;10.6.2.198:37645&gt;, fd is 8\n11/23/11 19:16:38 (pid:16038) Buf::write(): condor_write() failed\n11/23/11 19:16:38 (pid:16038) failure sending data (5130 bytes) over sock\n11/23/11 19:16:38 (pid:16038) relisock_gsi_put (write to socket) failure\n11/23/11 19:16:38 (pid:16038) Condor GSI authentication failure\n    globus_gss_assist token :-1: write failure: Operation not permitted\n\n11/23/11 19:16:38 (pid:16038) condor_write(): Socket closed when trying to write 13 bytes to daemon at &lt;10.6.2.198:37645&gt;, fd is 8\n11/23/11 19:16:38 (pid:16038) Buf::write(): condor_write() failed\n11/23/11 19:16:38 (pid:16038) condor_write(): Socket closed when trying to write 13 bytes to daemon at &lt;10.6.2.198:37645&gt;, fd is 8\n11/23/11 19:16:38 (pid:16038) Buf::write(): condor_write() failed\n11/23/11 19:16:38 (pid:16038) AUTHENTICATE: handshake failed!\n11/23/11 19:16:38 (pid:16038) SECMAN: required authentication with daemon at\n &lt;10.6.2.198:37645&gt; failed, so aborting command DC_CHILDALIVE.\n11/23/11 19:16:38 (pid:16038) ChildAliveMsg: failed to send DC_CHILDALIVE to\n parent daemon at &lt;10.6.2.198:37645&gt; (try 1 of 3): AUTHENTICATE:1002:Failure\n performing handshake|AUTHENTICATE:1004:Failed to authenticate using\n GSI|GSI:5004:Failed to authenticate.  Globus is reporting error (34144256:0)\n11/23/11 19:16:39 (pid:29835) JavaDetect: failure status 2048 when executing\n /usr/bin/java -classpath /state/partition1/glide_v13834/main/condor/lib:/state\n/partition1/glide_v13834/main/condor/lib/scimark2lib.jar:. CondorJavaInfo old 2\n11/23/11 19:16:50 (pid:29854) Setting maximum accepts per cycle 4.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Dec-06 17:40:08 by danb:</em> <br/>\n\nI am adding more details in the logging when ETIMEDOUT happens.  This will tell us what the timeout was set to in condor_read(), and it will tell us how long condor_read() actually took.\n\n<p>I am also explicitly setting the socket timeout in <code>CCBListener::ReadMsgFromCCB()</code>, even though it should already be set when the connection was first made.\n\n</p><p></p><hr/>\n<em>2012-Dec-17 12:13:37 by tannenba:</em> <br/>\n\n<strong>CODE REIVEW</strong>  - patch looks fine.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-06 17:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28643\">[28643]</a></span>: Make conversion to signed int explicit in my previous patch. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2695\" onclick=\"get_ticket_and_populate_wrapper('2695'); return false;\" title=\"90 minute timeout in CCB listener\">#2695</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-06 17:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28642\">[28642]</a></span>: Documented attempted fix for ETIMEDOUT in CCBListener. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2695\" onclick=\"get_ticket_and_populate_wrapper('2695'); return false;\" title=\"90 minute timeout in CCB listener\">#2695</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-06 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28641\">[28641]</a></span>: Attempt to debug and/or partiall solve ETIMEDOUT in ccb listener. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2695\" onclick=\"get_ticket_and_populate_wrapper('2695'); return false;\" title=\"90 minute timeout in CCB listener\">#2695</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-04 11:51", "status": "resolved", "created": "2011-Dec-06 17:36", "fixed_version": "2011-Dec-06 17:36", "broken_version": "v070602", "priority": "4", "subsystem": "", "assigned_to": "tannenba", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,burt@fnal.gov", "due_date": ""}