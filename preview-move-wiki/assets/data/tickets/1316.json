{"id": 1316, "title": "Ticket #1316: Dyanamic Slot INVALIDATE_STARTD_ADS causes collector pegging", "description": "<blockquote>\nDynamic slots will send an INVALIDATE_STARTD_ADS to the collector when they complete a job in order to free up the slot.  The problem is that the collector does an O(n) match on the slot query ad.  When dynamic slots are coming and going in a large pool with thousands of nodes this can be a serious issue and peg the collector.</blockquote>", "remarks": "<blockquote>\n<em>2010-Mar-30 15:51:03 by danb:</em> <br/>\n\nI took a look at the patch.  Comments:\n\n<p>The call to sscanf should specify maximum field widths for the output buffers.\n\n</p><p>The sscanf pattern that is specified for <code>MyAddress</code> will match up to the ':' in the address and then fail to match after that.  The part before the colon happens to be all that is required in the hash key.  The fact that there is dangling stuff in the query string that is ignored means that in the future if any queries are sent that contain more clauses, those clauses would be ignored.  I think we should require an exact match of the query string to the expected format--no trailing junk allowed.\n\n</p><p>The final problem is caused by a somewhat ugly hack in condor.  (Even worse, I am the poor soul who pressed the buttons to commit the patch.)  When ads are sent to the collector, the value of <code>MyAddress</code> may be rewritten.  The IP address is replaced by the IP address of the socket that is being used to talk to the collector.  The intention is to make condor advertise the IP address that is most likely to be accessible to others in the pool.  When flocking to multiple collectors, it may even choose a different IP address to advertise when talking to the different collectors.\n\n</p><p>How does that cause a problem for this patch?  You are sending the address as part of the query.  This will not automatically be rewritten.  If you put the address in an attribute named <code>MyAddress</code>, then it would be rewritten.  I haven't looked in detail at how the query classad is used, but it is possible that you could put the address in <code>MyAddress</code> and refer to it as <code>MyAddress</code> in your query.  If that works, then you could do the same sort of thing for Name.  Then verifying that the query matches the expected one would be a simple string compare--no pattern matching required.\n\n</p><p></p><hr/>\n<em>2010-Mar-30 16:33:46 by tstclair:</em> <br/>\n\nI agree with the recommendation, and I was planning on it too ;-).  That is interesting to note that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span> field changes on subsequent sends , so all the more reason to make the change.  (that is going in the mental rolodex)\n\n<p></p><hr/>\n<em>2010-Mar-31 11:13:30 by danb:</em> <br/>\n\nI like the new patch!  One nitpick: you unwittingly followed the example in Resource::final_update() of how to insert stuff into an ad by using ClassAd::Insert().  That's the old way from days of yore when string constants usually probably never contained special characters that needed to be escaped, and (though clearly not a problem in your code) static buffers were usually probably always big enough for whatever expression was being put in them.\n\n<p>It is better to use ClassAd::Assign() or ClassAd::AssignExpr().  Example:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">       line.sprintf( \"( TARGET.%s == \\\"%s\\\" )\", ATTR_NAME, r_name );\n       invalidate_ad.AssignExpr( ATTR_REQUIREMENTS, line.Value() );\n\n       invalidate_ad.Assign( ATTR_NAME, r_name );\n\n       invalidate_ad.Assign( ATTR_MY_ADDRESS, daemonCore-&gt;publicNetworkIpAddr());\n</pre></div>\n\n\n<p>Of course, the above code is still not quite correct because it doesn't worry about escaping r_name in the requirements expression.  I bet it just happens that quotes are forbidden in the name, so there probably isn't an actual problem.  But nevertheless, it is nice to have the correctness of code easily verifiable.  I'll leave it up to you to decide whether it is worth it in this case.  One way to do it is this:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">MyString escaped_name;\nClassAd::EscapeStringValue( r_name, escaped_name );\nline.sprintf( \"( TARGET.%s == \\\"%s\\\" )\", ATTR_NAME, escaped_name.Value() );\n</pre></div>\n\n\n<p>You would <em>not</em> pass escaped_name as the 2nd argument to Assign(), because Assign() does the escaping for you.\n\n</p><p></p><hr/>\n<em>2010-Apr-01 08:09:18 by tstclair:</em> <br/>\n\nDan - could you please ref the ticket #'s for the afore mentioned <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span> translation.\n\n<p></p><hr/>\n<em>2010-Apr-01 09:31:21 by danb:</em> <br/>\n\nThe <code>MyAddress</code> rewriting predates gittrack by a few years.  See usage of the function <code>ConvertDefaultIPToSocketIP()</code> in the source code.\n\n<p></p><hr/>\n<em>2010-Sep-07 12:41:44 by danb:</em> <br/>\n\nIt turns out that it is problematic to have a Name attribute in the invalidation query ad and to refer to Name without specifying TARGET scope in the query requirements.  This causes the query to match all ads!  If the invalidation query were to ever make its way to a 7.4 collector or to a collector that doesn't have an ad with a matching hash key, then the query is evaluated and all machine ads get invalidated.\n\n<p>I've opened a new ticket (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1644\" onclick=\"get_ticket_and_populate_wrapper('1644'); return false;\" title=\"machine invalidation ads match ads from all machines\">#1644</a></span>) for this issue.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1342\" onclick=\"get_ticket_and_populate_wrapper('1342'); return false;\" title=\"Update INVALIDATE_*_ADS to pass Name and MyAddress for O(1) invalidate\">#1342</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nUpdate INVALIDATE_*_ADS to pass Name and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyAddress\" title=\"My Address\">MyAddress</a></span> for O(1) invalidate</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1644\" onclick=\"get_ticket_and_populate_wrapper('1644'); return false;\" title=\"machine invalidation ads match ads from all machines\">#1644</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nmachine invalidation ads match ads from all machines</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/152/Ticket1316-v2.patch\">Ticket1316-v2.patch</a>\n4386 bytes added by tstclair on 2010-Mar-31 15:43:22 UTC.\n<br/>\nactual patch file.. doh<br/>\n</li><li><a href=\"../files/155/1316_leak.patch\">1316_leak.patch</a>\n865 bytes added by tstclair on 2010-Apr-14 22:05:59 UTC.\n<br/>\nmemory leak found. <br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-14 17:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f0be0693c7bae8a4aa370412b0c4cc53d6d15e0d\">[17866]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1316\" onclick=\"get_ticket_and_populate_wrapper('1316'); return false;\" title=\"Dyanamic Slot INVALIDATE_STARTD_ADS causes collector pegging\">#1316</a></span>: Update due to a leak found in the O(1) removal on INVALIDATE_STARTD  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-31 13:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/575f15cb7a552a3c299e139ef7e24275a04badac\">[17773]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1316\" onclick=\"get_ticket_and_populate_wrapper('1316'); return false;\" title=\"Dyanamic Slot INVALIDATE_STARTD_ADS causes collector pegging\">#1316</a></span>: Update the startd INVALIDATE_STARTD_ADS query and update collector to try to create a hashkey with the data.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">1999-Aug-19 17:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/52e622f7b3eb3c4006096440280ccf039f93b261\">[23076]</a></span>: Added blurbs for the condor_status and condor_install fixes (condor-admin <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1315\" onclick=\"get_ticket_and_populate_wrapper('1315'); return false;\" title=\"RFE: Provide a maximum cluster id value, useful in controlled envs\">#1315</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1316\" onclick=\"get_ticket_and_populate_wrapper('1316'); return false;\" title=\"Dyanamic Slot INVALIDATE_STARTD_ADS causes collector pegging\">#1316</a></span>).  (By wright )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Sep-07 13:04", "status": "resolved", "created": "2010-Mar-30 13:06", "fixed_version": "2010-Mar-30 13:06", "broken_version": "v070400", "priority": "2", "subsystem": "Daemons", "assigned_to": "tstclair", "derived_from": "", "creator": "tstclair", "rust": "", "customer_group": "users", "visibility": "public", "notify": "matt@cs.wisc.edu, dan@hep.wisc.edu, tstclair@redhat.com", "due_date": ""}