{"id": 1853, "title": "Ticket #1853: questionable code in event writing", "description": "<blockquote>\nI'm looking at the event writing code because of some weird problems Bill ran into (events getting overwritten).\n\n<p>Anyhow, I noticed at least a couple of things that seem questionable and should at least be checked into:\n\n</p><p>1) It seems like most of the time we are opening the log file in append mode; but we are also calling fseek on it, and according to at least some stuff on the web, doing fseek on a file opened in append mode is an undefined operation.\n\n</p><p>2) If fseek fails (in WriteUserLog::doWriteEvent) we print an error message, but we still go ahead and write the event.  It seems like an fseek error should abort writing of the event...</p></blockquote>", "remarks": "<blockquote>\nWe saw this behavior just now in Condor 7.8 (7.8.2 specifically) at Fermilab. We are using CERN's EOS filesystem (<a class=\"external\" href=\"http://eos.cern.ch/\">http://eos.cern.ch/</a>), which is mostly POSIX compliant but doesn't support fseek.\n\n<p>When the fseek failed, an error message was printed -- but then the starter lost contact with the shadow. Unfortunately the claim wasn't relinquished.  There's also a strange message in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> on <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetOwner\" title=\"Set Owner\">SetOwner</a></span> (the job owner is not bhawna but a different user):\n\n</p><p>Sched Log:\n</p><div class=\"verbatim\">\n<pre>03/18/13 18:38:32 (pid:9292) match (slot6@cmswn1787.fnal.gov &lt;131.225.206.160:34502&gt; for kdilsiz) switching to job 86692.0\n03/18/13 18:38:32 (pid:9292) Shadow pid 7246 switching to job 86692.0.\n03/18/13 18:38:32 (pid:9292) Starting add_shadow_birthdate(86692.0)\n03/19/13 04:03:13 (pid:9292) OwnerCheck(bhawna) failed in SetAttribute for job 86692.0\n</pre></div>\n\n\n<p>Shadow Log:\n</p><div class=\"verbatim\">\n<pre>03/18/13 18:38:32 (86405.0) (7246): Switching to new job 86692.0\n03/18/13 18:38:32 (?.?) (7246): Initializing a VANILLA shadow for job 86692.0\n03/18/13 18:38:44 (86692.0) (7246): Request to run on slot6@cmswn1787.fnal.gov &lt;131.225.206.160:34502&gt; was ACCEPTED\n03/18/13 19:03:55 (86692.0) (7246): WriteUserLog fseek(SEEK_END) failed in WriteUserLog::doWriteEvent - errno 107 (Transport endpoint is not connected)\n</pre></div>\n\nStarter Log:\n<div class=\"verbatim\">\n<pre>03/18/13 18:38:49 Create_Process succeeded, pid=20050\n03/18/13 18:44:59 condor_read(): timeout reading 5 bytes from &lt;131.225.190.80:33734&gt;.\n03/18/13 18:44:59 IO: Failed to read packet header\n03/18/13 18:54:55 Process exited, pid=20050, status=0\n03/18/13 18:59:55 condor_read(): timeout reading 5 bytes from &lt;131.225.190.80:33734&gt;.\n03/18/13 18:59:55 IO: Failed to read packet header\n03/18/13 19:05:15 condor_read(): timeout reading 5 bytes from daemon at &lt;131.225.190.80:47258&gt;.\n03/18/13 19:05:15 IO: Failed to read packet header\n03/18/13 19:05:15 Failed to receive GoAhead message from 131.225.190.80.\n03/18/13 19:05:15 File transfer failed, forcing disconnect.\n03/18/13 19:05:15 Returning from CStarter::JobReaper()\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Mar-21 10:49:08 by danb:</em> <br/>\n\nRegarding the strange <code>SetOwner</code> message, is FS authentication being used between the shadow and schedd?  Is EOS being used for /tmp?\n\n<p>Looking at the code, it appears that the fseek failure could not be responsible for the breakdown in communication between the shadow and starter.  The error is logged, but it is not treated as fatal.\n\n</p><p>Is there anything else in the <code>ShadowLog</code> that could explain what went wrong?\n\n</p><p></p><hr/>\n<em>2013-Mar-21 10:51:40 by burt:</em> <br/>\n\nFS shouldn't be used for auth and EOS isn't used for /tmp.\nI'll reproduce this next week with all the debugging turned up and see if we can pinpoint this.\n\n<p></p><hr/>\n<em>2019-Aug-13 09:46:13 by jfrey:</em> <br/>\n\nfseek() is no longer used in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2019-Aug-13 09:46", "status": "abandoned", "created": "2011-Jan-13 11:38", "fixed_version": "2011-Jan-13 11:38", "broken_version": "v070505", "priority": "5", "subsystem": "Libs", "assigned_to": "", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "wenger@cs.wisc.edu, gthain@cs.wisc.edu, burt@fnal.gov, dan@hep.wisc.edu", "due_date": ""}