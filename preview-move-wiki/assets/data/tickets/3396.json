{"id": 3396, "title": "Ticket #3396: Classads dirtyAttrList  not copied by copy ctor", "description": "<blockquote>\nThe new classad copy constructor unconditionally turns on the dirty attr tracking flag, regards of the setting in either the source or destination ad.  It also doesn't copy the dirtyAttrList itself.  The copy ctor should make a copy of the state of the from ad by reproducing both the flag and the array.  This will allow us to turn off dirty Attr tracking for the many daemons which don't need it, a performance improvement of up to 25% in classad parsing.</blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-04 12:07:53 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>Remove EnableDirtyTracking() in all constructors for\n  compat_classad::ClassAd. Currently, you've only changed the default\n  constructor.\n\n<p></p></li><li>The handling of dirty tracking in ClassAd::CopyFrom() is better, but\n  still odd. It should either clone the entire dirty state of the source\n  ad or not copy any dirty state from the source ad.\n\n<p></p></li><li>Add to end of <code>RoutedJob::SetDestJobAd()</code>:\n<div class=\"code\">\n<pre class=\"code\">    dest_ad.EnableDirtyTracking()\n</pre></div>\n\n\n<p></p></li><li>In <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span>, the ads have dirty tracking enabled, but the\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LogSetAttribute\" title=\"Log Set Attribute\">LogSetAttribute</a></span> log record explicitly sets the dirty state of every\nmodified attribute, setting it to false in the vast majority of cases.\nWe can get some additional performance benefits by disabling dirty\ntracking in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span> and letting <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAdLog\" title=\"Class Ad Log\">ClassAdLog</a></span> explicitly manage the\ndirty state when desired.\n</li></ul>\n\n<p></p><hr/>\n<em>2013-Jan-07 10:03:05 by jfrey:</em> <br/>\n\nIgnore my comment about the dirty attribute list in ClassAd::CopyFrom(). I see that you are copying the dirty list from the source ad. We should think about just replacing the destination ad's dirty list with a copy of the source ad's list, rather than adding to it.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-15 11:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34644\">[34644]</a></span>: Additional fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3396\" onclick=\"get_ticket_and_populate_wrapper('3396'); return false;\" title=\"Classads dirtyAttrList  not copied by copy ctor\">#3396</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-07 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34541\">[34541]</a></span>: Revert \"Additional fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3396\" onclick=\"get_ticket_and_populate_wrapper('3396'); return false;\" title=\"Classads dirtyAttrList  not copied by copy ctor\">#3396</a></span>\" This reverts commit 79f82b346711659bc4189b58a0b5b901a7364a95.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-07 12:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34535\">[34535]</a></span>: Additional fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3396\" onclick=\"get_ticket_and_populate_wrapper('3396'); return false;\" title=\"Classads dirtyAttrList  not copied by copy ctor\">#3396</a></span> Note that function \"const\"ness is part of the signature, so after making ClassAd::IsAttributeDirty() const, we need to add a non-const wrapper for backward compatbility.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-28 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34493\">[34493]</a></span>: Turn off classad dirty tracking by default <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3396\" onclick=\"get_ticket_and_populate_wrapper('3396'); return false;\" title=\"Classads dirtyAttrList  not copied by copy ctor\">#3396</a></span> This improves classad parsing speed by about 15%  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-04 12:04", "status": "resolved", "created": "2012-Dec-21 15:35", "fixed_version": "2012-Dec-21 15:35", "broken_version": "v070800", "priority": "4", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}