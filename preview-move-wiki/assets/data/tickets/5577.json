{"id": 5577, "title": "Ticket #5577: RunningJobs and FlockedJobs in submitter ads are messed up", "description": "<blockquote>\nThe Running/FlockedJobs attributes in the submitter ads in v8.5.3 running now in CHTC seem to be messed up.\nCheck out the below - I picked one user at random (jlange3) that is running jobs in CHTC and flocking\nto DoIT. He is submitting just from one submit host (submit-4). He only has vanilla jobs. Most of his claims\nhave been active for hours.\n\n<p>His CHTC submitter ad claims he is running 1325 jobs in CHTC, but he is really only running 196.\nHis CHTC submitter ad claims he is running 575 jobs via flocking, but he is really running 1600 jobs at DoIT.\n\n</p><p>Seems like how it assigns between <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunningJobs\" title=\"Running Jobs\">RunningJobs</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FlockedJobs\" title=\"Flocked Jobs\">FlockedJobs</a></span> is completely borked. Then looking\nat his submitter ad in the DoIT pool, the numbers appear swapped.\n\n</p><p>FWIW, condor_q agrees with the numbers that condor_status is reporting, and doing a\ncondor_status -direct for the submitter ad doesn't change anything.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">tannenba@cm ~]$ condor_status -pool cm.chtc.wisc.edu -submit -cons 'name==\"jlange3@chtc.wisc.edu\"' -af:l RunningJobs FlockedJobs JobsRunning\nRunningJobs = 1325 FlockedJobs = 575 JobsRunning = 1902\n\n[tannenba@cm ~]$ condor_status -pool condor1.doit.wisc.edu -submit -cons 'name==\"jlange3@chtc.wisc.edu\"' -af:l RunningJobs FlockedJobs JobsRunning\nRunningJobs = 189 FlockedJobs = 1711 JobsRunning = 0\n\n[tannenba@cm ~]$ condor_status -pool cm.chtc.wisc.edu -cons 'remoteuser=?=\"jlange3@chtc.wisc.edu\"' -af true | wc -l\n196\n\n[tannenba@cm ~]$ condor_status -pool condor1.doit.wisc.edu -cons 'remoteuser=?=\"jlange3@chtc.wisc.edu\"' -af true | wc -l\n1600\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Mar-23 15:55:49 by tannenba:</em> <br/>\n\nPerhaps unrelated, but of note: submit-4 has configured a non-default value of 10 for <code>FLOCK_INCREMENT</code> knob\n\n<p></p><hr/>\n<em>2016-Mar-23 16:54:36 by tannenba:</em> <br/>\n\nClue!!! Looks like many jobs do not have attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemotePool\" title=\"Remote Pool\">RemotePool</a></span> defined, and this attribute is used when the schedd restarts in order to fill in the \"pool\" field of the match record, which in turn is used for the counts in the submitter ad.\n\n<p>So if we can figure out how flocked jobs ended up with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemotePool\" title=\"Remote Pool\">RemotePool</a></span> undefined, we can solve the problem.\n\n</p><p></p><hr/>\n<em>2016-Mar-24 15:12:18 by jfrey:</em> <br/>\n\nThe problem is that the pool name is being lost when doing claim-partitionable-leftovers. In <code>Scheduler::claimedStartd()</code>, when a <code>ScheddNegotiate</code> object is made to claim the leftovers ad, a NULL is always given for the pool name.\n\n<p></p><hr/>\n<em>2016-Mar-24 15:44:58 by tannenba:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Patch looks good, resolving.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-24 15:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48106\">[48106]</a></span>: Docs for claim-partitionable-leftovers with flocking bug. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5577\" onclick=\"get_ticket_and_populate_wrapper('5577'); return false;\" title=\"RunningJobs and FlockedJobs in submitter ads are messed up\">#5577</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Mar-24 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48105\">[48105]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemotePool\" title=\"Remote Pool\">RemotePool</a></span> not set when claiming partitionable leftovers. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5577\" onclick=\"get_ticket_and_populate_wrapper('5577'); return false;\" title=\"RunningJobs and FlockedJobs in submitter ads are messed up\">#5577</a></span> When claiming partitionable leftovers, we need to propagate the negotiator pool name, if any, to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddNegotiate\" title=\"Schedd Negotiate\">ScheddNegotiate</a></span> object that we create to initiate the next claim request. Otherwise, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemotePool\" title=\"Remote Pool\">RemotePool</a></span> doesn't get set in the job ad and the schedd\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "incident", "last_change": "2016-Mar-24 15:45", "status": "resolved", "created": "2016-Mar-23 15:54", "fixed_version": "2016-Mar-23 15:54", "broken_version": "v070705", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#2790", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": ""}