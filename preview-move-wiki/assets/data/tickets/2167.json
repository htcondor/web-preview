{"id": 2167, "title": "Ticket #2167: Propagate DAG node priorities down to job priorities", "description": "<blockquote>\nThis resulted from today's meeting with the Spalding lab people.\n\n<p>Anyhow, they basically want node priorities to propagate down through sub-DAGs, and then to the actual Condor priorities of the node jobs within the sub-DAGs.  Since you can specify node priorities in each DAG, there would have to be some kind of concatenation of priorities at each level, and then DAGMan would eventually pass the result when it submitted a job.  Also, the user would be able to set priorities for the top-level DAGs (maybe we'd need a new condor_submit_dag command-line flag for this, because we don't want to encourage people to edit the .condor.sub files).  A DAG would get its priority from its Condor priority, so that way priorities could get propagated down through sub-DAGs.\n\n</p><p>So, for example, if a top-level DAG itself had a priority of 5, and then it had a subdag external node with a priority of 3, and that sub-DAG had a node with a priority of 6, the job might end up getting submitted with a priority of 50306.  (Obviously, this would only work right for a certain range of priority values; and we'd have to think about how to handle negative priorities, since they are allowed.)  Hmm -- and we'd have to really think about this, because in that example, \"deeper\" nodes with have better priorities, which might not be what we want...\n\n</p><p>There should probably be a flag to turn this on or off -- the implication if it's on is that DAGMan would override any Condor priorities set in node job submit files.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-May-17 17:35:06 by wenger:</em> <br/>\n\nMaybe make node priorities floats instead of ints.\n\n<p></p><hr/>\n<em>2011-May-18 12:52:10 by nwp:</em> <br/>\n\nIs <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1992\" onclick=\"get_ticket_and_populate_wrapper('1992'); return false;\" title=\"Implement First Come, First Served for dagman jobs\">#1992</a></span> relevant for this ticket?\n\n<p></p><hr/>\n<em>2011-May-18 13:44:52 by wenger:</em> <br/>\n\nHmm -- I didn't even know about <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1992\" onclick=\"get_ticket_and_populate_wrapper('1992'); return false;\" title=\"Implement First Come, First Served for dagman jobs\">#1992</a></span>.  If anything, I think it makes what we want to do more complicated, because which priority do we set?  I wish they'd have given a more detailed scenario of how this is supposed to be used -- I'm not totally sure what it gains us over just having one priority value.\n\n<p></p><hr/>\n<em>2011-Jun-15 10:56:41 by nwp:</em> <br/>\n\nMy plan now is to sum the priorities of the dag harmonically from the\nroot to a node, then multiply the user priority by that sum to give a priority for that job.  Then insert the priority in the node job file.  Negative priorities will be set to 1 for the first round, until we see what is the correct thing to do.  Another idea is to sum exponentially.  Here I mean\n\n<p>Harmonic sum: </p><div class=\"restricted\">s<sup>-1</sup>=x<sub>1</sub><sup>-1</sup>+...+x<sub>n</sub><sup>-1</sup></div>\n\n<p>Exponential sum: </p><div class=\"restricted\">2<sup>-s</sup>=2<sup>-x<sub>1</sub></sup>+...\n2<sup>-x<sub>n</sub></sup></div>\n\n<p>The point here is to preserve order.\n\n</p><p></p><hr/>\n<em>2011-Jun-15 12:53:41 by psilord:</em> <br/>\n\nHow do you handle diamond-style dag structures with your priority propagation math?\n\n<p>Suppose you have a user priority and job priorities and this dag:\n</p><div class=\"verbatim\">\n<pre>a -&gt; b, c\nb -&gt; d -&gt; e -&gt; f\nc, f -&gt; g\n</pre></div>\n\n\n<p>What's the priority of g?\n\n</p><p></p><hr/>\n<em>2011-Jun-15 13:10:25 by nwp:</em> <br/>\n\nGood question. I am thinking I will initially take max_prio(S), where S is the set of parent dag nodes.\n\n<p></p><hr/>\n<em>2011-Jun-15 16:17:34 by psilord:</em> <br/>\n\nThere are different choices for the mixing of the contributions of the priorities from parental paths: max, min, average, statistical variance, choose one only, and [infinite set of functions]....\n\n<p>Why are any of them better than any other? In practice, which one would be what the user wants to do?\n\n</p><p>I could see something like a priority of a node dominating all nodes below it.\nA high priority node would contaminate the future nodes with the same priority.\nThis is your max_prio(S) solution.\n\n</p><p>It seems to makes sense, but I could see other functions that would be just as useful, like take the priority of the first parental node after being lexographically sorted.\n\n</p><p>Is it possible for the user to supply a function which acts as a selector for\nan arbitrary number of contributing priorities and have it default to max() unless otherwise specified? My intuition tell me no, since Condor isn't that\nflexible in this context.... but if you could do it cheaply in your time, that\nmight be the way to go.\n\n</p><p></p><hr/>\n<em>2011-Jun-15 16:19:36 by psilord:</em> <br/>\n\nAlso, see my remark on ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1482\" onclick=\"get_ticket_and_populate_wrapper('1482'); return false;\" title=\"Allow a cleanup/final DAG node that is always run\">#1482</a></span> about priority calculations between jobs.\nThat can represent a DAG as well.\n\n<p></p><hr/>\n<em>2011-Jun-15 16:23:06 by psilord:</em> <br/>\n\nHrm, wrong ticket, lemme find the right one...\n\n<p></p><hr/>\n<em>2011-Jun-15 16:27:24 by psilord:</em> <br/>\n\nAh ok, here it is: <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1992\" onclick=\"get_ticket_and_populate_wrapper('1992'); return false;\" title=\"Implement First Come, First Served for dagman jobs\">#1992</a></span>.\n\n<p>This is related in that if my solution had been implemented, it wold allow any\nset of jobs to have the priorities of an arbitrary DAG ordering. It might not\nbe directly applicable here, but it would be good to have in your mind.\n\n</p><p></p><hr/>\n<em>2011-Jun-30 09:31:21 by nwp:</em> <br/>\n\nCurrently, we want to avoid starving high-priority children that have low-priority parents, so the priorities get copied up, to the parents. But then\nif a user declares a toplevel low priority DAG node, the priority gets overwritten. If you have a library of DAGs, you may want the toplevel priority to take precedence.  Of course then a solution is to have a policy that a library DAG node can only have a priority in a certain range, say, (0,100), and the toplevel DAG node policy would then be to have priority in the range of, say, (101,200).  (Currently here means the patch as it is on 30 June 2011).\n\n<p></p><hr/>\n<em>2011-Jun-30 12:53:14 by nwp:</em> <br/>\n\nOK, here is a use case where I am not sure what to do:\n\n<p>A-&gt;B, C-&gt;D.  Here A is high priority, B is low. C is low, D is high.\n\n</p><p>This dag gets submitted. A runs first, finishes, and then B starts. C runs, and starts up D.  Does D then preempt B?  My intuition is that the sequence A,C,D,B is\nbetter.\n\n</p><p></p><hr/>\n<em>2011-Sep-14 15:13:46 by psilord:</em> <br/>\n\nOk I reviewed it. Looks good.\n\n<p></p><hr/>\n<em>2011-Sep-14 15:26:05 by nwp:</em> <br/>\n\nMerged to master at 2853cb6.  Documentation is already finished, so skipping docpending state.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/383/2167-patch\">2167-patch</a>\n8222 bytes added by nwp on 2011-Jun-21 18:36:10 UTC.\n<br/>\nPatch for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>.  This is simple---no heavy Math here.  The idea is that we want to keep parent nodes from starving child nodes or needlessly delaying them, so we propogate the child priorities up its parents' nodes, and then run the DAG with these priorities set.  We also have added arguments to condor_submit_dag to set priorities from the command line (still need to add config option).  I want to get this out and have some other eyeballs see it and minds decide if it is sane.<br/>\n</li><li><a href=\"../files/391/2167-patch-2\">2167-patch-2</a>\n12396 bytes added by nwp on 2011-Jul-02 02:16:47 UTC.\n<br/>\nI think this is a better patch for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>.  We do not now propogate the child priorities toward the parents, and do not do an inefficient recursion.  Now the DAG priorities are copied faithfully to the condor jobs, and to the subdags.  <br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Oct-06 10:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27664\">[27664]</a></span>: edit of prose describing DAGMan node priority and its propagation ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-14 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27209\">[27209]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=26860\">[26860]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26861\">[26861]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26862\">[26862]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26863\">[26863]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26864\">[26864]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26865\">[26865]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=26866\">[26866]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=27108\">[27108]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=27162\">[27162]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=27168\">[27168]</a></span>, Merge branch 'V7_7-propogate_dag_node_priorities_down_to_job_priorities-branch'\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 16:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27168\">[27168]</a></span>: Address the implications of the priority scheme ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span> Also, the last commit does not compile, as I did not remove an argument from a call site.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-12 14:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27162\">[27162]</a></span>: Write a comment to explain the priority scheme ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span> Also, remove an unused argument.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-06 22:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27108\">[27108]</a></span>: Comment on new members in DAG structures for priorities ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26866\">[26866]</a></span>: Document how priorities are propogated to DAGman nodes ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span> ===VersionHistory===  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26863\">[26863]</a></span>: Get the default priority in condor_dagman ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26864\">[26864]</a></span>: Retrieve the default priority from the command line or configuration ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26865\">[26865]</a></span>: Add tests for propogation of priorities ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26860\">[26860]</a></span>: Add priority field to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SubmitDagDeepOptions\" title=\"Submit Dag Deep Options\">SubmitDagDeepOptions</a></span> structure ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span> This new priority field is for communicating between condor_submit_dag and condor_dagman.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26861\">[26861]</a></span>: Add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FixPriority\" title=\"Fix Priority\">FixPriority</a></span> method to Job class in DAGman ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-18 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26862\">[26862]</a></span>: Iterate over the nodes of a DAG to set the priorities ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2167\" onclick=\"get_ticket_and_populate_wrapper('2167'); return false;\" title=\"Propagate DAG node priorities down to job priorities\">#2167</a></span>  (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Sep-14 15:27", "status": "resolved", "created": "2011-May-17 17:18", "fixed_version": "2011-May-17 17:18", "broken_version": "v070600", "priority": "3", "subsystem": "Dag", "assigned_to": "nwp", "derived_from": "#804", "creator": "wenger", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "wenger@cs.wisc.edu, psilord@cs.wisc.edu, matt@cs.wisc.edu, tstclair@redhat.com", "due_date": "20110812"}