{"id": 5885, "title": "Ticket #5885: enable the schedd to perform job classad transforms upon submission", "description": "<blockquote>\n[ Note: this ticket hopefully replaces <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=4804\" onclick=\"get_ticket_and_populate_wrapper('4804'); return false;\" title=\"Managed condor_submit transforms\">#4804</a></span> and satisfies <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=5613\" onclick=\"get_ticket_and_populate_wrapper('5613'); return false;\" title=\"how best to transform job classad prior to submission\">#5613</a></span> ]\n\n<p>We want the schedd to be able to transform an incoming job classad upon submission.  Transformations can be configured via either job_router style route classads, or via the tranform scripting language created for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5805\" onclick=\"get_ticket_and_populate_wrapper('5805'); return false;\" title=\"Create a tool to do generic classad transforms and pretty printing\">#5805</a></span>.\n\n</p><p>The schedd will attempt to apply all job transforms specified by new knob <code>JOB_TRANSFORM_NAMES</code> in order.  A job transform should be skipped if a) the transform specified in the config file is not a syntactically valid classad, or b) a <em>requirements</em> expression in the transform ad evaluates to false.  Transforms are applied to each newly submitted job in a transaction <em>before</em> the transaction is committed and also <em>before</em> SUBMIT_REQUIREMENTS are checked.  Thus, a transform can edit values for either protected or immutable attributes, but an attempt to edit a protected attribute (such as <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProcId\" title=\"Proc Id\">ProcId</a></span> or Owner) will cause the transform to fail thereby aborting the entire transaction.\n\n</p><p>See the Remark below for examples and a simple smoke-test.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Sep-28 13:13:41 by wenger:</em> <br/>\n\nLIGO is very interested in this -- get them pre-release 8.5.8 documentation if documentation isn't complete for the 8.5.7 release.\n\n<p></p><hr/>\n<em>2016-Sep-28 17:12:53 by wenger:</em> <br/>\n\nCommitted some improvements to the documentation to get them into 8.5.7, but I'm not resolving the ticket yet because I want to do a little more checking.  I'll either resolve the ticket with the manual as-is, or commit some additional fixes for 8.5.8.\n\n<p></p><hr/>\n<em>2016-Sep-29 11:26:21 by wenger:</em> <br/>\n\nToddT suggestions for improvements to documentation (created <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5937\" onclick=\"get_ticket_and_populate_wrapper('5937'); return false;\" title=\"Improve schedd job ClassAds transformation documentation\">#5937</a></span> for this):\n\n<p></p><ul>\n<li>Copy syntax from job router section instead of linking to that.\n</li><li>Have more references to other parts of the manual (e.g., config knobs).\n</li><li>Make sure cases are consistent (to not generate multiple index entries) (e.g., job_route_name?)\n</li><li>Add more high-level discussion of why you'd want to do job transforms (e.g., not done by condor_submit, so they work the same if user submits via Python bindings, user can't bypass them).  (Contrast with submit_attrs.)\n</li><li>Re-do examples -- have a very simple initial example (like just adding a department attribute).  Todd doesn't like including Docker in the examples, but does like the way the Docker example changes the requirements with copy_Requirements and set_Requirements.\n</li><li>Put group name in immutable attributes so user can't change it, and to hammer home the point that transforms are applied BEFORE the transaction is committed and thus also BEFORE SUBMIT_REQUIREMENTS are evaluated.\n</li><li>Add map file to user group example (in comments?).\n</li><li>Submit requirements example should require a group.\n</li><li>Maybe put complex examples in recipes section of Wiki.\n</li><li>Make a link <strong>to</strong> this from the accounting groups section.\n</li></ul>\n\n<p></p><hr/>\n<em>2016-Oct-04 14:38:29 by tannenba:</em> <br/>\n\nHere is a simple and fast smoke-test for job transform functionality; this could be the basis for a simple regression test.\n\n<p>First append the following to condor_config and do a condor_reconfig :\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">JOB_TRANSFORM_NAMES = BAD ILLEGAL ALWAYS NEVER ALWAYS_NEWSCRIPT\nJOB_TRANSFORM_BAD @=end\n[\n  set_NeverThere3 = \"Please work!\";\n  12foo = asd\"as\";\n  ugh = 7 %$ 8;\n]\n@end\nJOB_TRANSFORM_ILLEGAL @=end\n[\n  requirements = illegal =?= true;\n  set_ProcId = 999;\n]\n@end\nJOB_TRANSFORM_ALWAYS @=end\n[\n  requirements = True;\n  set_AlwaysThere = \"Please work!\";\n  delete_NeverThere2 = true;\n  eval_set_OnlyProcZero = ProcId == 0 ? \"Please work - proc zero\" : \"Please work - proc non-zero\"\n]\n@end\nJOB_TRANSFORM_NEVER @=end\n[\n  requirements = False;\n  set_NeverThere1 = \"Please work!\";\n]\n@end\nJOB_TRANSFORM_ALWAYS_NEWSCRIPT @=end\n  SET AlwaysThereNew = \"Please work!\"\n  DELETE NeverThereNew\n@end\n</pre></div>\n\n\n<p>Next, create file <code>test.sub</code> that contains the following job description:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">executable = test.sub\nhold = true\n+NeverThere2 = \"Please work!\"\n+illegal = $(ILLEGAL:false)\nqueue 2\n</pre></div>\n\n\n<p>Finally, submit as shown below to an empty job queue, and confirm the output is exactly as shown below (i.e. the same output from the grep command, appearing in the same order) :\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\test&gt;condor_submit illegal=true test.sub\nSubmitting job(s)..\nERROR: Failed to commit job submission into the queue.\nERROR: Failed to apply a required job transform.\n\n\nC:\\condor\\test&gt;condor_submit test.sub\nSubmitting job(s)..\n2 job(s) submitted to cluster 280.\n\nC:\\condor\\test&gt;condor_q -l | grep Please\nAlwaysThere = \"Please work!\"\nAlwaysThereNew = \"Please work!\"\nOnlyProcZero = \"Please work - proc zero\"\nAlwaysThere = \"Please work!\"\nAlwaysThereNew = \"Please work!\"\nOnlyProcZero = \"Please work - proc non-zero\"\n\nC:\\condor\\test&gt;\n</pre></div>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5937\" onclick=\"get_ticket_and_populate_wrapper('5937'); return false;\" title=\"Improve schedd job ClassAds transformation documentation\">#5937</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove schedd job <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> transformation documentation</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5959\" onclick=\"get_ticket_and_populate_wrapper('5959'); return false;\" title=\"Test for config JOB_TRANSFORM_&lt;NAMES&gt;\">#5959</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nTest for config JOB_TRANSFORM_&lt;NAMES&gt;</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5970\" onclick=\"get_ticket_and_populate_wrapper('5970'); return false;\" title=\"Job transform: error message always report last item in transform list\">#5970</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nJob transform: error message always report last item in transform list</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5980\" onclick=\"get_ticket_and_populate_wrapper('5980'); return false;\" title=\"job transform requirements don't work if TARGET is used\">#5980</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\njob transform requirements don't work if TARGET is used</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-28 17:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a0a03b40749683d3dca300145e5696e77c1bef13\">[49332]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span>: Cleaned up the documentation of schedd job <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> transforms.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-28 15:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c2bb5da1a5ab4f02bed593fcd7518e948489124e\">[49329]</a></span>: documentation for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-07 17:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ae1bc9e538ae5d8df4123826417dee774695454a\">[49139]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span>. Use case insensitive keywords for classad syntax submit tranforms  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-07 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4802da168783d9c29e944509f40fb823e715ce79\">[49134]</a></span>: fix minor problems with previous commit for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-07 11:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3bdb37a83dbfe7337a7be4064d01a755262e78e5\">[49129]</a></span>: Add support for native submit transform languange to <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-06 15:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0eee6c4e99c7cf91ebe2dd07f11aaa1642d7431e\">[49117]</a></span>: Initial implementation of schedd knob JOB_TRANSFORM_NAMES. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span> This allows the schedd to transform an incoming job classad upon submission. Transformations can be configured via either job_router style classads, or via the new tranform scripting language.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-06 15:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8ede138383fcf47d7e066da01beee128e272a570\">[49116]</a></span>: Add method in xform_utils to return full rule as a string. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span> This will return the full rule, incl NAME and REQs, with no comments, and delimited any way desired.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-06 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3ceaa1bfac8c7f8e439c8acca9625ad89c733bd2\">[49115]</a></span>: Fix bug in xform_utils where Requirements was ignored. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span> When importing a job_router style classad, the Requirements line was ignored.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Oct-04 15:00", "status": "resolved", "created": "2016-Sep-06 14:39", "fixed_version": "2016-Sep-06 14:39", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "wenger", "derived_from": "#4882", "creator": "tannenba", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu tannenba@cs.wisc.edu iain.steers@cern.ch", "due_date": ""}