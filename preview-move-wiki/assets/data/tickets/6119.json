{"id": 6119, "title": "Ticket #6119: Incorrect usage of Get_Pipe_FD", "description": "<blockquote>\nIn <code>condor_gridmanager/gahp-client.cpp</code>, around line 924:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">m_gahp_real_readfd = daemonCore-&gt;Get_Pipe_FD( m_gahp_readfd, &amp;m_gahp_real_readfd );\nm_gahp_real_errorfd = daemonCore-&gt;Get_Pipe_FD( m_gahp_errorfd, &amp;m_gahp_real_errorfd );\n</pre></div>\n\n\n<p>The return from Get_Pipe_FD() is typed as int, but is actually used a boolean (returning TRUE or FALSE).  The most-noticeable effect of this is to cause gahp clients started by command-line tools to hang, because the subsequent poll() never fires.  We can also expect a subtle effect having to do with how much time the gahp client spends blocked in i/o vs waiting in poll(), or something like that?\n\n</p><p>Anyway, it's also done wrong in CCB -- the return value is checked against -1, which can't happen -- and used once without being checked in <code>vanilla_proc.cpp</code>.\n\n</p><p>Provisionally assigning to Jaime because I'll be busy in another branch for a while.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Feb-01 15:50:50 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>We should be consistent about how we handle this function.  An explicit check for a FALSE returns seems like it should be sufficient -- the current implementation of <code>pipeHandleTableLookup()</code> returns FALSE if the fd would be set to -1 -- but I guess it won't hurt to check the explicitly.\n\n</p><p>Jaime suggested ASSERT()ing that Get_Pipe_FD() returned TRUE in the gahp-client (because the grid manager is designed to cleanly recover from that).\n\n</p><p>The changed code in vanilla_proc.cpp should cause an interesting explosion if the lookup fails.  It'd be clearer as an ASSERT.  (The starter won't come back cleanly, but it's unclear what to do if the lookup fails.)\n\n</p><p></p><hr/>\n<em>2017-Feb-15 15:34:44 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good.\n\n</p><p></p><hr/>\n<em>2017-Feb-28 10:02:28 by jfrey:</em> <br/>\n\nNo version history, as the only user-visible effect is in the annex, which is still in development.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-01 16:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50099\">[50099]</a></span>: Check for Get_Pipe_FD() returning failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6119\" onclick=\"get_ticket_and_populate_wrapper('6119'); return false;\" title=\"Incorrect usage of Get_Pipe_FD\">#6119</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-01 13:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50091\">[50091]</a></span>: Fix incorrect usage of Get_Pipe_FD(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6119\" onclick=\"get_ticket_and_populate_wrapper('6119'); return false;\" title=\"Incorrect usage of Get_Pipe_FD\">#6119</a></span> The return value is TRUE/FALSE, never -1 or the fd value.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Feb-28 11:09", "status": "resolved", "created": "2017-Feb-01 11:59", "fixed_version": "2017-Feb-01 11:59", "broken_version": "v080404", "priority": "4", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "#5442", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}