{"id": 3563, "title": "Ticket #3563: Schedd commands to audit", "description": "<blockquote>\nWe want the audit log for HTCondor-CE to include entries for all commands to the schedd coming from users. For all of these commands, we will record basic security information (source IP address, authenticated identity, HTCondor identity, command name). This information will be written by <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> before the command callout to the schedd code. For most commands, we will record additional information specific to that command. For example, the ids of any submitted jobs. This information will be written from the relevant schedd functions.\n\n<p>This ticket will track what commands should be logged at all and what command-specific information should be included. Some commands are received from both users and trusted daemons. When these commands are received from a trusted daemon, then no logging is required.\n\n</p><p>You can write to the audit log by calling <code>audit_log()</code>. It works like dprintf(), but the first argument is a ReliSock* instead of a debug category.\n\n</p><p><span class=\"subsection\"></span></p><h3>The Commands</h3>\n\n<p>Here are all of the READ, WRITE and DAEMON level commands registered by the schedd, ignoring commands registered in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> for all daemons. These are the commands we may want to log.\n\n</p><p>When we say that the expected client is the \"job owner\", this could be a user running a command-line tool, the condor_c-gahp, or the Job Router. In any of these cases, the client will authenticate as the job owner, not as a Condor daemon.\n\n</p><p><span class=\"subsubsection\"></span></p><h4>DAEMON Level Commands</h4>\n\n<p>DAEMON and WRITE levels are mostly synonymous. Many configurations may allow users to issue DAEMON level commands\n\n</p><p></p><ul>\n<li>GIVE_MATCHES\n<ul>\n<li>Expected clients: shadow\n</li><li>Don't log\n</li></ul>\n</li></ul>\n\n<p><span class=\"subsubsection\"></span></p><h4>WRITE Level Commands</h4>\n\n<p>WRITE level commands are the ones we're most interested in, as they modify state.\n\n</p><p></p><ul>\n<li>TRANSFER_QUEUE_REQUEST\n<ul>\n<li>Expected clients: shadow\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>RESCHEDULE\n<ul>\n<li>Expected clients: job owner, site admin\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>ACT_ON_JOBS\n<ul>\n<li>Expected clients: job owner, site admin\n</li><li>Log\n</li><li>Extra information: command (rm, rm -rf, hold, release, vacate, vacate fast, suspend, continue), job id list or constraint\n</li></ul>\n\n<p></p></li><li>SPOOL_JOB_FILES\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job ids, job proxy info (if transferred)\n</li></ul>\n\n<p></p></li><li>SPOOL_JOB_FILES_WITH_PERMS\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job ids, job proxy info (if transferred)\n</li></ul>\n\n<p></p></li><li>TRANSFER_DATA\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job ids\n</li></ul>\n\n<p></p></li><li>TRANSFER_DATA_WITH_PERMS\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job ids\n</li></ul>\n\n<p></p></li><li>UPDATE_GSI_CRED\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job id, job proxy info\n</li></ul>\n\n<p></p></li><li>DELEGATE_GSI_CRED_SCHEDD\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job id, job proxy info\n</li></ul>\n\n<p></p></li><li>REQUEST_SANDBOX_LOCATION\n<ul>\n<li>Expected clients: job owner\n</li><li>Don't log\n</li><li>Extra information: job id\n</li></ul>\n\n<p></p></li><li>RECYCLE_SHADOW\n<ul>\n<li>Expected clients: shadow\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>ATTEMPT_ACCESS\n<ul>\n<li>Expected clients: job owner\n</li><li>Don't log\n</li><li>Extra information: read/write, file path\n</li></ul>\n\n<p></p></li><li>STORE_CRED\n<ul>\n<li>Expected clients: job owner\n</li><li>Windows only\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>QMGMT_WRITE_CMD\n<ul>\n<li>Expected clients: job owner, shadow, gridmanager, site admin\n</li><li>Log\n</li><li>Extra information:\n<ul>\n<li>CONDOR_NewCluster: Clusterids of submitted jobs\n</li><li>CONDOR_SetAttribute*: job id, attribute name, and attribute value for changes to existing jobs\n</li></ul>\n</li></ul>\n\n<p></p></li><li>GET_MYPROXY_PASSWORD\n<ul>\n<li>Expected clients: gridmanager\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>GET_JOB_CONNECT_INFO\n<ul>\n<li>Expected clients: job owner\n</li><li>Log\n</li><li>Extra information: job id\n</li></ul>\n\n<p></p></li><li>CLEAR_DIRTY_JOB_ATTRS\n<ul>\n<li>Expected clients: shadow, gridmanager\n</li><li>Don't log\n</li></ul>\n</li></ul>\n\n<p><span class=\"subsubsection\"></span></p><h4>READ Level Commands</h4>\n\n<p>For the most part, READ level commands are not interesting, but some may be of concern.\n\n</p><p></p><ul>\n<li>RELEASE_CLAIM\n<ul>\n<li>Expected clients: startd\n</li><li>Valid claimid must be presented\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>ALIVE\n<ul>\n<li>Expected clients: startd\n</li><li>Valid claimid must be presented\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>QUERY_SCHEDD_ADS\n<ul>\n<li>Expected clients: job owner, site admin\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>QUERY_SUBMITTOR_ADS\n<ul>\n<li>Expected clients: job owner, site admin\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>QMGMT_READ_CMD\n<ul>\n<li>Expected clients: job owner, site admin\n</li><li>Don't log\n</li></ul>\n\n<p></p></li><li>DUMP_STATE\n<ul>\n<li>Expected clients: site admin\n</li><li>Tool condor_squawk only on Windows\n</li><li>Don't log</li></ul>\n</li></ul>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=6310\" onclick=\"get_ticket_and_populate_wrapper('6310'); return false;\" title=\"Some audit-related messages missing from normal schedd log\">#6310</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSome audit-related messages missing from normal schedd log</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-24 13:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbb00367f07808e9c8181d194a87d426cbfe6e2a\">[35538]</a></span>: Simplify #ifdef in AuditLogJobProxy() when we don't have Globus. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-24 10:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/57641e0f43b8690b4f1cb901247fcbe007284079\">[35532]</a></span>: Improve audit message when authentication or authorization fails. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-24 09:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a767986c0016942ac4d9e45a97b602d3ebed35f3\">[35531]</a></span>: Fix previous memory leak fix in audit log for actOnJobs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-23 13:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5c1106794d1376ab38e60fce75a4e38c0c7f0364\">[35509]</a></span>: Avoid expensive work for auditing if it's not enabled. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-23 11:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5ed54248832bc904f0b94b4272f06182e41c7b23\">[35508]</a></span>: Fix memory leak in audit log for actOnJobs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-22 13:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/622a7bcaea9033987bb33baddb79b65a779a7760\">[35486]</a></span>: Some tweaks to audit log messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-22 08:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fd467827b4c5dbdce3636a7dcc7fa75612834e3e\">[35477]</a></span>: Fix build of Aviary due to changeover to dPrintAd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-22 08:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4f25ce70a7bed7a01b51be29dd901e8a8c284299\">[46476]</a></span>: Fix build of Aviary due to changeover to dPrintAd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-22 08:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6dcf3a11c3b5722bf1eb893525e172efd6cca2a4\">[35476]</a></span>: Fix build of QMF due to changeover to dPrintAd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-19 16:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ab6995d31fdece71be071974a3862274ae1a7c52\">[35471]</a></span>: Schedd now registers audit callback function with daemon-core. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-19 16:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/433231e2cccea522054b2949b09f19e92f0fa755\">[35470]</a></span>: Clean up schedd's audit log callback function. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-16 17:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3d5339f2837257496ccd1ad9c98f4f4c385dd280\">[35431]</a></span>: Add some command string entries needed for the audit log. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-16 17:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dae023e88ffcee0660b012e11a980a7a6dd65e4d\">[35430]</a></span>: Tweak some of the audit log messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-11 17:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1800e3d240c687f04cbc59ddbac4cb81557be14e\">[35386]</a></span>: Describe job proxies received by the schedd in the audit log. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-11 16:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8fd787d721b604183766c45490c33a47ea9740e9\">[35384]</a></span>: Ensure we return NULL on failure in x509_proxy_read(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-11 14:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/847b6f6ae63dde5582e11ac01dc591c6e64f284d\">[35382]</a></span>: Add proxy querying functions that are more efficient. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span> With our existing convenience functions for examining a proxy, you have to re-read the proxy file for each piece of information (subject, email, expiration, voms attrs, etc). We're adding some additional functions to let us read the proxy file\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-11 14:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cb491526fd2717e374da71919aae5a511768c96\">[35381]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>. Changing how much gets printed with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetAttribute\" title=\"Set Attribute\">SetAttribute</a></span>. If the user is not an HTCondor daemon or if the attribute should be printed anyway (e.g. with condor_chirp), that's when the audit log gets information.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-11 12:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e1c710b667b1ed3f9ab69e37d8482d0feebb6c1a\">[35377]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>. Adding dprintf more statements with D_AUDIT for audit_log. Somehow, some of them were removed when I sqaushed some commits.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-10 16:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1dd735dab4afedd34fc351c54ed4696a9edee50f\">[35372]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>. Adding dprintf statements with D_AUDIT for audit_log. Still lacking proxy info and possible log dprintfs.  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-04 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6f49621084e8f371cfdbd38a728bd69cb22ce808\">[35334]</a></span>: Add audit_log() calls for GET_JOB_CONNECT_INFO. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3563\" onclick=\"get_ticket_and_populate_wrapper('3563'); return false;\" title=\"Schedd commands to audit\">#3563</a></span>  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-May-07 15:18", "status": "resolved", "created": "2013-Apr-03 16:19", "fixed_version": "2013-Apr-03 16:19", "broken_version": "", "priority": "3", "subsystem": "Daemons", "assigned_to": "samf", "derived_from": "#3493", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "samf@cs.wisc.edu", "due_date": "2013-04-09"}