{"id": 5021, "title": "Ticket #5021: Missing RPM dependencies in condor-static-shadow", "description": "<blockquote>\nThe <code>condor-static-shadow</code> package currently ships the 32-bit shadow on all platforms (on purpose - the whole point of the package is to have the smallest possible footprint).\n\n<p>However, because we currently <code>dlopen</code> libvomsapi, the RPM auto-dependency detection doesn't pick up the 32-bit VOMS as a dependency.  For the main package, <code>libvomsapi</code> is brought in directly as some daemons link directly.\n\n</p><p>This makes for a broken out-of-the-box experience.\n\n</p><p>CC'ing Jaime on this ticket in case he can think of other <code>dlopened</code> libraries that should be explicitly included.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Apr-27 08:20:19 by bbockelm:</em> <br/>\n\nActually, there's a few other curiosities:\n<ul>\n<li>8.3.4 and before both provided and required the various globus libraries.  The 'provided' part caused serious heartache at sites because it doesn't actually place the embedded Globus libraries in the linker's search path.\n</li><li>8.3.5 no longer 'provides' the globus libraries, but still requires them.  That means installing this on RHEL will pull in system globus, no?\n</li><li>The new <code>condor-static-shadow</code> package can't really be used \"UW-style\"; the libraries it needs are in the 32-bit <code>condor</code> RPM.  You need to split out the libs (and make it multiarch); in the meantime, CMS will just install the system RPMs such as VOMS.\n</li></ul>\n\n<p></p><hr/>\n<em>2015-Apr-27 10:32:42 by jfrey:</em> <br/>\n\nThe Globus and VOMS libraries are still provided, but are now in a separate condor-externals package. They're required only if you want to do GSI authentication. So maybe the 32-bit condor-externals package should be required by the condor-all package, but probably not by the condor-static-shadow directly.\n\n<p>The other libraries that could be dlopen'd by the static shadow are those for Kerberos.\n\n</p><p></p><hr/>\n<em>2015-Apr-27 14:58:39 by bbockelm:</em> <br/>\n\nHm - another curiosity; within <code>condor-externals</code>:\n\n<p></p><div class=\"verbatim\">\n<pre>/usr/libexec/condor/glite/share/doc/glite-ce-blahp-@PVER@/LICENSE\n</pre></div>\n\n\n<p>I'm guessing a variable didn't get expanded?\n\n</p><p>Given how the RPM world usually take an expansive view of dependencies, we should probably add an explicit dependency on libvomsapi.  Just like with the main <code>condor</code> package, we can let the yum depsolver pick whether to take it from the system or the UW repos.\n\n</p><p></p><hr/>\n<em>2015-Apr-29 09:00:38 by bbockelm:</em> <br/>\n\nHi,\n\n<p>You can't install condor-externals.i686 side-by-side with condor-externals.x86_64 because there are conflicting files (binaries in <code>/usr/libexec/condor/glite/bin</code>; shell scripts are OK as long as the md5sum is the same for both 64-bit and 32-bit versions).\n\n</p><p>Further, <code>condor-externals</code> has a dependency on <code>condor</code>; definitely can't have both the 32-bit and 64-bit version of the condor binaries on a single host!\n\n</p><p>Can someone else reproduce?  Unfortunately, I think this really makes <code>condor-shadow-static</code> difficult to use in this release.\n\n</p><p>Finally - while we're fixing packaging - if <code>condor-shadow-static</code> is installed, can we drop a file in <code>/etc/condor/config.d</code> to set:\n\n</p><p>SHADOW=$(SBIN)/condor_shadow_s\n\n</p><p>?\n\n</p><p>Thanks,\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Apr-29 10:13:02 by tim:</em> <br/>\n\nWe are running the 32-bit static shadow in CHTC. So, the VOMS and globus libraries are optional. If you want to use those, you would have to load the 32-bit externals. However, as you have noticed there are conflicts and dependencies that need to be addressed for this to work.\n\n<p>So, I think that we need to be able to load the 32-bit externals alongside the 64-bit externals. I also think that the static shadow should not require the externals, since it work when you don't need those optional features it works just fine.\n\n</p><p>Would it be worthwhile to run the 64-bit static shadow?\n\n</p><p></p><hr/>\n<em>2015-May-13 15:27:51 by edquist:</em> <br/>\n\nI just had a thought about <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e44128a5d18a51af0940987d4a42a6db360051bd\">[44839]</a></span> --\n\n<p>I get the problem with the <code>static-shadow</code>, that requiring the main condor package effectively makes it impossible to install the 32bit one with the 64bit condor,\n\n</p><p>BUT, without it, is there anything that keeps versions (NVRs, if not Arches) in sync?  I think the answer might be No, but correct me if I'm wrong.  Same issue/question for <code>external-libs</code>, which doesn't appear to be required by name (or NVR) by any other sub-packages.\n\n</p><p>It might work to install the first time around but I think afterwards it might be possible to <code>yum update condor</code> and then the versions of <code>static-shadow</code> and <code>external-libs</code> get out of sync (ie, not get upgraded along with the rest of condor).\n\n</p><p>That is, of course, the other reason to have a <code>Requires: %{name} = %{version}-%{release}</code> -- if not because it's required by the sub-package, then at least to keep the versions in sync.\n\n</p><p>... Can we whip something up, possibly with a virtual Provides, that we can use to keep the versions in sync without necessarily requiring the main <code>condor</code> package of the same arch?\n\n</p><p></p><hr/>\n<em>2015-May-13 16:05:06 by bbockelm:</em> <br/>\n\nWhat about having:\n\n<p></p><div class=\"verbatim\">\n<pre>Requires: %{name} = %{version}\n</pre></div>\n\n\n<p>in the <code>condor-static-shadow</code> package?  That will keep the major version in sync without requiring the same arch.\n\n</p><p></p><hr/>\n<em>2015-May-14 09:59:13 by tim:</em> <br/>\n\nThat is what we had in the first place. But in CHTC, Moate was having problems downgrading with yum when this dependency on the parent was in place. So, let's give what we have not a try.\n\n<p></p><hr/>\n<em>2015-May-14 12:48:35 by edquist:</em> <br/>\n\nHi Tim,\n\n<p>From what I see in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e44128a5d18a51af0940987d4a42a6db360051bd\">[44839]</a></span>, it used to be:\n\n</p><p><code>Requires: %{name} = %version-%release</code>\n\n</p><p>But Brian is suggesting dropping the %release part:\n\n</p><p><code>Requires: %{name} = %{version}</code>\n\n</p><p>Which of the two was causing problems in CHTC?\n\n</p><p></p><hr/>\n<em>2015-May-15 18:40:23 by edquist:</em> <br/>\n\nActually... After thinking about this a little more,\n\n<p><code>Requires: %name = %version-%release</code>\n\n</p><p>shouldn't require the same arch (I did some tests that agree), and further, I suspect the downgrade problems seen in CHTC will happen regardless of mixed-arch setups -- you need to make sure to 'yum downgrade' all the condor packages (that depend on each other) at the same time by listing them all on the command line together, otherwise the downgrade will fail...\n\n</p><p>So my guess is the <code>Requires: %name = %version-%release</code> can stay for the <code>static-shadow</code> without causing trouble ... The real issue was just with the dependencies for <code>externals</code> (or now <code>external-libs</code>), right?</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-05 16:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6aa7e4dce5b754756f0925139a1fb29a41d4dee5\">[44995]</a></span>: 8.3.6 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5021\" onclick=\"get_ticket_and_populate_wrapper('5021'); return false;\" title=\"Missing RPM dependencies in condor-static-shadow\">#5021</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-05 13:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/66826da58a362cff6bd9f7d8ad4caf54a502405f\">[44991]</a></span>: Version history items for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3718\" onclick=\"get_ticket_and_populate_wrapper('3718'); return false;\" title=\"Detect invalid interpreter in script\">#3718</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5021\" onclick=\"get_ticket_and_populate_wrapper('5021'); return false;\" title=\"Missing RPM dependencies in condor-static-shadow\">#5021</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5035\" onclick=\"get_ticket_and_populate_wrapper('5035'); return false;\" title=\"Incorporate OSG changes\">#5035</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-12 16:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a29c1f64a935b618219645f30d709982f67e27ac\">[44840]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5021\" onclick=\"get_ticket_and_populate_wrapper('5021'); return false;\" title=\"Missing RPM dependencies in condor-static-shadow\">#5021</a></span>) Add external-libs to all meta-package  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-12 16:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e44128a5d18a51af0940987d4a42a6db360051bd\">[44839]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5021\" onclick=\"get_ticket_and_populate_wrapper('5021'); return false;\" title=\"Missing RPM dependencies in condor-static-shadow\">#5021</a></span>) static-shadow and external-libs should not depend on parent  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-08 13:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/983e16b54187fcfef718df23282923382d4461bc\">[44807]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5021\" onclick=\"get_ticket_and_populate_wrapper('5021'); return false;\" title=\"Missing RPM dependencies in condor-static-shadow\">#5021</a></span>) Put external shared libraries in own RPM.  (By Tim Theisen )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jun-05 13:24", "status": "resolved", "created": "2015-Apr-24 07:55", "fixed_version": "2015-Apr-24 07:55", "broken_version": "v080305", "priority": "2", "subsystem": "Packaging", "assigned_to": "tim", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "jfrey@cs.wisc.edu, tannenba@cs.wisc.edu, bbockelm@cse.unl.edu, edquist@cs.wisc.edu", "due_date": ""}