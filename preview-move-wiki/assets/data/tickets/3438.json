{"id": 3438, "title": "Ticket #3438: EC2: Be paranoid about executing and logging TerminateInstances().", "description": "<blockquote>\nTony Tiradani has seen <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> acknowledge a TerminateInstances() command, but (because of network problems) subsequently fail to terminate the instance.  HTCondor needs to do three things to minimize the damage from this failure case:\n\n<p>(1) Issue an explicit TerminateInstances() command for each job before it leaves the queue.  Because TerminateInstances() is idempotent, this will not have any ill effect.\n\n</p><p>(2) Log, in the job ad, when it sent TerminateInstances() and what response it received and when.\n\n</p><p>(3) Record, in the job ad, the reason for the job leaving the queue.\n\n</p><p>We may already implement part or all of (3) in the form of EC2StatusReasonCode, but we may also want to update the job's exit code from it.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jun-06 16:16:33 by tlmiller:</em> <br/>\n\nIt may also be useful, if we know the instance ID (or spot request ID) of a job when it enters the HOLD state, to terminate the job.  I would expect this condition to be rare and the TerminateInstances() call to usually fail, but it could be a nice backstop.  (This may require editing other states to not remove this information before transferring to GM_HOLD, and editing GM_HOLD to remove it once it calls TerminateInstances().)\n\n<p></p><hr/>\n<em>2013-Jul-08 14:53:14 by tlmiller:</em> <br/>\n\nWhen asked his thoughts on adding a check-and-retry loop to instance termination (that is, GM_CANCEL):\n\n<p>(02:50:23 PM) Tony Tiradani: honestly, I'd like to see both.  The logging would be very helpful when arguing with the openstack admins.  according to them, openstack is never wrong.  The loop would actually attempt to clean up after openstack fails\n\n</p><p>(02:51:18 PM) Tony Tiradani: But I think in terms of priority, the loop would be better to have since we (Burt and/or myself) will have to patch <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> and submit it to the project if we want things to work correctly\n\n</p><p></p><hr/>\n<em>2013-Sep-03 11:11:50 by tlmiller:</em> <br/>\n\nDesign document:\n\n<p><a class=\"external\" href=\"https://docs.google.com/a/wisc.edu/document/d/1Xz9OjJP_m5eNThBt15-8aaTSOwelI5nNg7ligqQwxoM\">https://docs.google.com/a/wisc.edu/document/d/1Xz9OjJP_m5eNThBt15-8aaTSOwelI5nNg7ligqQwxoM</a>\n\n</p><p></p><hr/>\n<em>2013-Sep-17 16:38:29 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\nThis code looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-08 09:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37799\">[37799]</a></span>: edit and add to documentation for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3438\" onclick=\"get_ticket_and_populate_wrapper('3438'); return false;\" title=\"EC2: Be paranoid about executing and logging TerminateInstances().\">#3438</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-07 10:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37785\">[37785]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3438\" onclick=\"get_ticket_and_populate_wrapper('3438'); return false;\" title=\"EC2: Be paranoid about executing and logging TerminateInstances().\">#3438</a></span>) When holding a job after a failed cancel, say so in the job ad, too.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-30 11:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37730\">[37730]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3438\" onclick=\"get_ticket_and_populate_wrapper('3438'); return false;\" title=\"EC2: Be paranoid about executing and logging TerminateInstances().\">#3438</a></span>) Document change.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-03 11:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37441\">[37441]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3438\" onclick=\"get_ticket_and_populate_wrapper('3438'); return false;\" title=\"EC2: Be paranoid about executing and logging TerminateInstances().\">#3438</a></span>) Verify that cancelled jobs actually terminate; retry if they don't.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Sep-30 11:22", "status": "resolved", "created": "2013-Jan-11 16:30", "fixed_version": "2013-Jan-11 16:30", "broken_version": "", "priority": "3", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "tiradani@fnal.gov", "due_date": ""}