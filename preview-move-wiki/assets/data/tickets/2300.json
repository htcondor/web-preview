{"id": 2300, "title": "Ticket #2300: Cluster id rollover and schedd restart cause \"ERROR JOB QUEUE DAMAGED\"", "description": "<blockquote>\nWhen cluster id rolls over and schedd restarts, it can\nhave the following message in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> and schedd cannot be started:\n\n<p></p><div class=\"verbatim\">\n<pre>06/30/11 18:42:43 (pid:24166) ERROR \"JOB QUEUE DAMAGED; header ad\nNEXT_CLUSTER_NUM invalid\" at line 932 in file qmgmt.cpp\n</pre></div>\n\n\n<p></p><div class=\"verbatim\">\n<pre>Steps to Reproduce:\n1. set \"SCHEDD_CLUSTER_MAXIMUM_VALUE=9\"\n2. condor_submit 9 jobs that are not runnable by any systems, so that they can\nstay in the queue.\n3. Use condor_rm to remove job 1, 2 and 3\n4. Use condor_submit to submit a new job, which will have roll-over and become\njob 1. The NextClusterNum in job_queue.log will be 2.\n5. Use condor_rm to remove job 9\n6. Wait until job log rotate. (that the removed job 9, 2, 3 will be\ndisappeared in the new job_queue.log) (use QUEUE_CLEAN_INTERVAL = 60)\n7. Restart condor.\n</pre></div>\n\n\n<p>In <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InitJobQueue\" title=\"Init Job Queue\">InitJobQueue</a></span> (qmgmt.cpp), It will calculate the highest cluster_num and then it will hit this checking because stored_cluster_num is 2 because of the roll-over.\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">        if ( next_cluster_num &gt; stored_cluster_num ) {\n            // Oh no!  Somehow the header ad in the queue says to reuse cluster\nnums!\n            EXCEPT(\"JOB QUEUE DAMAGED; header ad NEXT_CLUSTER_NUM invalid\");\n        }\n</pre></div>\n\n\n<p>Actual results:\nIt will show 'ERROR \"JOB QUEUE DAMAGED; header ad NEXT_CLUSTER_NUM invalid\" at\nline 932 in file qmgmt.cpp'\n\n</p><p>Expected results:\nIt will start normally and it can use the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NextClusterNum\" title=\"Next Cluster Num\">NextClusterNum</a></span> specified.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Aug-04 14:35:36 by gthain:</em> <br/>\n\nWhat's the use case for the maximum cluster value?\n\n<p></p><hr/>\n<em>2011-Aug-04 15:06:07 by eje:</em> <br/>\n\nAs I understand it, the use case is customers who want to guarantee that their cluster ids stay &lt;= some maximum size because their in-house data warehousing/analysis tools do not work properly on larger cluster numbers.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/412/gt2300-max-cluster-error.patch\">gt2300-max-cluster-error.patch</a>\n826 bytes added by eje on 2011-Jul-13 19:34:13 UTC.\n<br/>\nPatch disables consistency check on cluster id when SCHEDD_CLUSTER_MAXIMUM_VALUE is configured, since wrapped cluster ids are a valid state in this case.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-13 14:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c8b05d334ec10da229994420cc72bf2aeb4d2906\">[22449]</a></span>: ===VersionHistory=== Disabled scheduler exception on check for wrapped cluster ids when SCHEDD_CLUSTER_MAXIMUM_VALUE is set, since in that case wrapped ids are a valid state. ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2300\" onclick=\"get_ticket_and_populate_wrapper('2300'); return false;\" title='Cluster id rollover and schedd restart cause \"ERROR JOB QUEUE DAMAGED\"'>#2300</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Aug-04 15:06", "status": "resolved", "created": "2011-Jul-13 14:31", "fixed_version": "2011-Jul-13 14:31", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, eje@cs.wisc.edu, gthain@cs.wisc.edu, jthomas@redhat.com", "due_date": ""}