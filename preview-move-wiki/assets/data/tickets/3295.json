{"id": 3295, "title": "Ticket #3295: condor_glexec_run executes target user's .bashrc", "description": "<blockquote>\nWhen condor invokes condor_glexec_run to launch a job under glexec, the target user's ~/.bashrc is executed if /bin/sh is a symlink to /bin/bash.  Depending on what happens in .bashrc, this can cause a failure to launch the job.  By some miracle, Brian Bockelman managed to debug one such case, which is how we found out about this problem.\n\n<p>Why does bash source ~/.bashrc, even though it is being used in non-interactive mode?  It turns out that this happens, because bash wrongly guesses that it is the top level shell under rshd.  The following bash code is responsible\n\n</p><p></p><pre>       /* If we were run by sshd or we think we were run by rshd, execute\n      ~/.bashrc if we are a top-level shell. */\n       if ((run_by_ssh || isnetconn (fileno (stdin))) &amp;&amp; shell_level &lt; 2)\n</pre>\n\n<p>Since SHLVL is cleared by glexec and stdin is a socket, the above code causes ~/.bashrc to be executed.\n\n</p><p>If we were invoking /bin/sh rather than /bin/bash, it would not read ~/.bashrc (even if /bin/sh is a symlink to /bin/bash).  So why are we invoking /bin/bash rather than /bin/sh?  The reason is that older versions of glexec refused to run symlinks.  Modern versions allow execution of symlinks by default but can be configured not to with prohibit_exec_via_symlink = yes.\n\n</p><p>Here are two possible solutions:\n\n</p><p>1. Run /bin/sh directly, and require that sites use a compatible glexec.\n\n</p><p>2. Hide the invocation of /bin/sh from glexec:\n    glexec /usr/bin/env /bin/sh -c ...\n\n</p><p>This should work with all versions and configurations of glexec (assuming /usr/bin/env is not a symlink itself).\n\n</p><p>Igor prefers option 1.</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2012-Dec-19 09:30:47 by johnkn:</em> <br/>\n\nBulk change of target version from v070807 to v070808 using ./ticket-target-mover.\n<hr/>\n<em>2013-Mar-28 17:16:00 by johnkn:</em> <br/>\n\nBulk change of target version from v070808 to v070809 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2014-Jul-28 13:02:33 by bbockelm:</em> <br/>\n\nIs this ticket still relevant?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2014-Jul-28 13:02", "status": "new", "created": "2012-Oct-26 12:24", "fixed_version": "2012-Oct-26 12:24", "broken_version": "v070103", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,dan@hep.wisc.edu,zmiller@cs.wisc.edu,bbockelm@cse.unl.edu", "due_date": ""}