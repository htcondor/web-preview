{"id": 3287, "title": "Ticket #3287: Invalid submissions to EC2 can't be removed.", "description": "<blockquote>\nIf you submit an invalid EC2 job -- for instance, one with a bogus AMI ID -- the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunInstances\" title=\"Run Instances\">RunInstances</a></span> command will fail and the job will go on hold (with a useful error message -- I know, I'm doing it wrong).  However, condor_rm'ing the held job will cause the gridmanager to go into recovery mode and wrongly call <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunInstances\" title=\"Run Instances\">RunInstances</a></span> again.  (This isn't as insane as it sounds -- because of the idempotent <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClientToken\" title=\"Client Token\">ClientToken</a></span>, Amazon will ensure that we only start the one instance.)  Of course, doing so puts the job back on hold.\n\n<p>The grid manager needs to check before entering recovery if the job is held, and if so, ignore it.  If the job is in the removed state, it needs to make sure it's finished cleaning up after it; this may require additional machinery.  (We can't just call <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunInstances\" title=\"Run Instances\">RunInstances</a></span> to convert the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClientToken\" title=\"Client Token\">ClientToken</a></span> into an instance ID because we don't want to start an instance if we haven't already.)\n\n</p><p>Discovered by Anthony Tiradani.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Oct-23 16:05:22 by tstclair:</em> <br/>\n\nVersion needed here, because I fixed a very similar issue to this months ago.\n\n<p></p><hr/>\n<em>2012-Oct-23 17:14:00 by tlmiller:</em> <br/>\n\nI don't know how far back the problem goes (which is why I left the corresponding field blank), but it looks like (based on code inspection) that it exists in the present master branch.  It certainly exists (I have experimentally verified it) on my branch for the spot request implementation, which isn't all that old.\n\n<p>I took a quick look back to July and didn't see anything in the git logs from you that looked likely.  Could you send me (the hash of) your fix?  Thanks.\n\n</p><p></p><hr/>\n<em>2012-Nov-29 15:02:42 by tlmiller:</em> <br/>\n\nIn fact, anything that causes the call to ec2_vm_start() to fail will cause the job to become held, rather than removed (particularly including authentication failures).\n\n<p></p><hr/>\n<em>2012-Dec-17 18:54:06 by tlmiller:</em> <br/>\n\nWe could correct this problem by either not putting the job on hold when the call to RunInstances() fails, or by not making the call to RunInstances() at all.  The former requires a great deal of knowledge, which may change from service to service, about the failure modes of RunInstances(), because we <em>must</em> put the job on hold unless we're certain that the error could not result in a running instance whose ID we do not know.  The latter seems simpler: during recovery, if we have a client token but an instance ID, and we're removing the job, go to a special state where we check to see if any instance has that client token.  If it does, we go back GM_START_VM (as if we hadn't checked if we removing the job at all); if it does not, we go to GM_DELETE (since we know we have nothing to cancel, we should just get rid of the job).\n\n<p>This, however, leaves jobs with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AuthFailures\" title=\"Auth Failures\">AuthFailures</a></span> (see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2274\" onclick=\"get_ticket_and_populate_wrapper('2274'); return false;\" title=\"Put job on hold for credential error (AuthFailure)\">#2274</a></span>) unable to be removed from the queue, because the call to DescribeInstances() in the new state above (GM_SEEK_INSTANCE_ID) will fail. Shoul the GM_SEEK_INSTANCE_ID delete the job instead of putting it on hold for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AuthFailures\" title=\"Auth Failures\">AuthFailures</a></span>?  Maybe if-and-only-if the job's hold reason (hopefully uncleared by being removed) is also an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AuthFailure\" title=\"Auth Failure\">AuthFailure</a></span>?\n\n</p><p></p><hr/>\n<em>2012-Dec-18 11:41:30 by tlmiller:</em> <br/>\n\nChanged 'broken version' to 7.9.2, presuming 7.8.2 to be a typo.  (No diffs exist in condor_gridmanager/ or ec2_gahp/ between 7.8.1 and 7.8.2.)\n\n<p></p><hr/>\n<em>2013-Jan-10 14:11:43 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>In the new GM_SEEK_INSTANCE_ID state, instead of going to GM_START_VM,\nwhy not call SetInstanceId() and goto GM_SAVE_INSTANCE_ID? Then you have\nfewer unnecessary EC2 commands where something weird can happen.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-15 11:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34648\">[34648]</a></span>: minor edits to 3 7.9.3 version history items ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3287\" onclick=\"get_ticket_and_populate_wrapper('3287'); return false;\" title=\"Invalid submissions to EC2 can't be removed.\">#3287</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3387\" onclick=\"get_ticket_and_populate_wrapper('3387'); return false;\" title=\"Can't remove EC2 jobs with invalid authentication.\">#3387</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3369\" onclick=\"get_ticket_and_populate_wrapper('3369'); return false;\" title=\"glexec fails in 7.9.2\">#3369</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-14 16:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34637\">[34637]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3287\" onclick=\"get_ticket_and_populate_wrapper('3287'); return false;\" title=\"Invalid submissions to EC2 can't be removed.\">#3287</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3387\" onclick=\"get_ticket_and_populate_wrapper('3387'); return false;\" title=\"Can't remove EC2 jobs with invalid authentication.\">#3387</a></span>) Version history entries.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-14 16:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34636\">[34636]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3287\" onclick=\"get_ticket_and_populate_wrapper('3287'); return false;\" title=\"Invalid submissions to EC2 can't be removed.\">#3287</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3387\" onclick=\"get_ticket_and_populate_wrapper('3387'); return false;\" title=\"Can't remove EC2 jobs with invalid authentication.\">#3387</a></span>) Add version history items.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-14 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34634\">[34634]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3287\" onclick=\"get_ticket_and_populate_wrapper('3287'); return false;\" title=\"Invalid submissions to EC2 can't be removed.\">#3287</a></span>) Avoid an extra EC2 API call by duplicating some code.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-18 11:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34425\">[34425]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3287\" onclick=\"get_ticket_and_populate_wrapper('3287'); return false;\" title=\"Invalid submissions to EC2 can't be removed.\">#3287</a></span>) Allow the user to remove jobs which specify invalid instances.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jan-14 16:43", "status": "resolved", "created": "2012-Oct-23 14:01", "fixed_version": "2012-Oct-23 14:01", "broken_version": "v070902", "priority": "2", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "s8199", "customer_group": "fermi", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}