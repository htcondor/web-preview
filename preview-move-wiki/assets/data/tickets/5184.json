{"id": 5184, "title": "Ticket #5184: CLASSAD_USER_PYTHON_MODULES crashes for UW builds", "description": "<blockquote>\nFor UW builds, the following segfaults starting in 8.3.5:\n\n<p></p><div class=\"verbatim\">\n<pre>_condor_CLASSAD_USER_PYTHON_MODULES=foo /usr/bin/condor_q\n</pre></div>\n\n\n<p>After some detective work, it is due to the how libstdc++ implements std::string.  There's a special static symbol, empty_rep_storage, which represents the empty string (the most common libstdc++'s implement string as copy-on-write).  When a string destructor is called, there is special logic - if (this == &amp;empty_rep_storage), then the underlying storage is not destroyed.\n\n</p><p>In the above segfault of condor_q, the setting of CLASSAD_USER_PYTHON_MODULES causes a dlopen of libclassad_python_user.so with RTLD_DEEPBIND.  Objects in that library initialized to the empty string utilize empty_rep_storage from <em>libstdc++</em>.  Outside that library, empty_rep_storage is provided from the data segment of the executable itself.  Hence, the conditional (this == &amp;empty_rep_storage) is false and the code calls free() on a statically-allocated array outside the heap (segfaulting the program).  Because we have two memory addresses for empty_rep_storage, we have violated C++'s One Definition Rule.\n\n</p><p>It's an obscure issue - to trigger it, we needed to have empty_rep_storage in the binary, in libstdc++, and a library dynamically-loaded with RTLD_DEEPBIND.  We can't remove empty_rep_storage from libstdc++; RTLD_DEEPBIND is needed due to <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4998\" onclick=\"get_ticket_and_populate_wrapper('4998'); return false;\" title=\"condor_shadow segfaults on exit\">#4998</a></span>.\n\n</p><p>It turns out that empty_rep_storage is <em>not</em> in the binary for PROPER builds, however.  This is because PROPER builds use '-fPIC', which is required for \"code that is suitable for dynamic linking\" - our use case!\n\n</p><p>If we are going to keep the CLASSAD_USER_LIBS mechanism (and hence CLASSAD_USER_PYTHON_MODULES), we'll have to add -fPIC to the UW build.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-26 17:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d463a32ed3bfb402fe0b9e7cd00eb98e465a2ecd\">[45713]</a></span>: edit 8.3.8 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5184\" onclick=\"get_ticket_and_populate_wrapper('5184'); return false;\" title=\"CLASSAD_USER_PYTHON_MODULES crashes for UW builds\">#5184</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-26 11:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/796a6d6a401fb3dba24d90da07a5adf2641a0d95\">[45691]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5184\" onclick=\"get_ticket_and_populate_wrapper('5184'); return false;\" title=\"CLASSAD_USER_PYTHON_MODULES crashes for UW builds\">#5184</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-30 13:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6bd211e21e0d4588dfe356a7fb9e1e4df9e831aa\">[45442]</a></span>: Enable -fPIC for all builds. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5184\" onclick=\"get_ticket_and_populate_wrapper('5184'); return false;\" title=\"CLASSAD_USER_PYTHON_MODULES crashes for UW builds\">#5184</a></span> -fPIC is needed for libraries to be dynamically loaded <strong>or if the executable is going to perform dynamic loading</strong>. The classad mechanism for loading user-defined functions indeed performs dynamic loading, meaning we'll have to use -fPIC for basically all of HTCondor\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Nov-12 15:04", "status": "resolved", "created": "2015-Jul-30 13:44", "fixed_version": "2015-Jul-30 13:44", "broken_version": "", "priority": "2", "subsystem": "ClassAd", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}