{"id": 7605, "title": "Ticket #7605: condor_gpu_discovery crashes on PowerPC", "description": "<blockquote>\nI just built 8.8.8-1 for PowerPC\n(rhel7).  It works okay, but dumps core with gpu-detection.\n\n<p>After some debugging, if found an error in 'condor_gpu_discovery.cpp'\n(stack i.s.o. heap allocation).  Please find the diff below.\nOn x86_64 apparently this is not triggered (although I did see the\noccasional coredump of this exec)\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">--- condor_gpu_discovery.cpp.old        2020-04-17 11:30:42.037789221 +0200\n+++ condor_gpu_discovery.cpp.new        2020-04-17 11:31:32.593811467 +0200\n@@ -541,9 +541,11 @@\n                print_error(MODE_DIAGNOSTIC_MSG, \"# cuDeviceTotalMem(%d) returns %d, value = %llu\\n\", devID, er, (unsigned long long)mem);\n        }\n\n-               char name[256];\n-               memset(name, 0, sizeof(name));\n-               cuDeviceGetName(name, sizeof(name), dev);\n+               // Alloc on heap, not stack, as it is passed out of this function\n+               char *name;\n+               name = (char*)malloc (256);\n+               cuDeviceGetName(name, 256, dev);\n+\n                p-&gt;name = name;\n                if (cuDeviceGetUuid) cuDeviceGetUuid(p-&gt;uuid, dev);\n                if (cuDeviceGetPCIBusId) cuDeviceGetPCIBusId(p-&gt;pciId, sizeof(p-&gt;pciId), dev);\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Apr-17 09:26:58 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: LGTM\n\n<p></p><hr/>\n<em>2020-Apr-17 10:31:23 by tim:</em> <br/>\n\nIt turns out that it copies into a std::string. So, that's not the problem. My bad.\n\n<p></p><hr/>\n<em>2020-Apr-17 11:12:58 by tim:</em> <br/>\n\nBert will try out our patch on Monday:\n\"At first sight, it looks ok to me.  I'll try it Monday morning and\nreport\nback.\n\n<p>Incidentally, the very same error is in condor_gpu_utilization.cpp\n(with the same fix).\n\n</p><p>To be continued ...\"\n\n</p><p></p><hr/>\n<em>2020-Apr-18 11:03:23 by tim:</em> <br/>\n\nBert reports that the updates work fine.\n\n<p></p><hr/>\n<em>2020-Apr-18 11:04:47 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks much better.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-21 16:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6ab0a2a755d25cbc69a3da9a59cc59bf670b4e8\">[59441]</a></span>: Fix broken macos build due to missing include file. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-21 12:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aaa85b7edad7854308d925d88a799982217e2bfa\">[59431]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7553\" onclick=\"get_ticket_and_populate_wrapper('7553'); return false;\" title=\"Collector can hang when a port scanner probes it\">#7553</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7521\" onclick=\"get_ticket_and_populate_wrapper('7521'); return false;\" title=\"p-slot child rollup should contain evaluated d-slot values\">#7521</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7542\" onclick=\"get_ticket_and_populate_wrapper('7542'); return false;\" title=\"SLOT_TYPE_N configuration works START, not for RANK, etc\">#7542</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7360\" onclick=\"get_ticket_and_populate_wrapper('7360'); return false;\" title=\"macro default does not allow - character and workaround is broken\">#7360</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7591\" onclick=\"get_ticket_and_populate_wrapper('7591'); return false;\" title=\"preempting claim in a GPU slot attempts to add another GPU and fails\">#7591</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7479\" onclick=\"get_ticket_and_populate_wrapper('7479'); return false;\" title=\"MAX_PROCD_LOG does not honor units suffix\">#7479</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-17 11:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7ffb0ebc9039acd96d42a0d0477be74597eb6603\">[59392]</a></span>: possible fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>, condor GPU utilization crashes on PowerPC  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-17 10:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1ed55706d6405a1f0a5abe8de866f2ca943110c9\">[59389]</a></span>: possible fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>, condor GPU discovery crashes on PowerPC  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-17 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/627199ee2821159f54ac81f43dd0dc9c5d7d8df4\">[59388]</a></span>: Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>) Allocate GPU device name on heap\" This reverts commit d2bc94a52187d402cd6ab9a65ce0bbff4d3a42ad.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-17 09:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d2bc94a52187d402cd6ab9a65ce0bbff4d3a42ad\">[59385]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>) Allocate GPU device name on heap Signed-off-by: Tim Theisen &lt;tim@cs.wisc.edu&gt; Committer: Tim Theisen  (By Bert <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DeKnuydt\" title=\"De Knuydt\">DeKnuydt</a></span> )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Apr-21 12:11", "status": "resolved", "created": "2020-Apr-17 08:59", "fixed_version": "2020-Apr-17 08:59", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "users", "visibility": "public", "notify": "Bert.DeKnuydt@esat.kuleuven.be", "due_date": ""}