{"id": 7799, "title": "Ticket #7799: Remove intentional delays in daemon startup", "description": "<blockquote>\nSeveral of the daemons have intentional delays of a second or longer at startup. These are unnecessary and can be removed.\n\n<p>When the master starts the shared port and collector daemons, it delays starting other daemons until these ones create their address files. It polls the status of the files at 1-second intervals, but the files are typically present after less than a tenth of a second. We can't schedule daemoncore timers a sub-second resolution, but the handler can sleep for 100 milliseconds when the file isn't present yet. This should be ok, as the master isn't doing anything else in these cases.\n\n</p><p>When the schedd starts up, it creates a Timeslice object to handle calling of the <code>Scheduler::timeout()</code> daemoncore timer. It sets a minimum interval (default 5 seconds) but not an initial interval. Thus, the first call to <code>timeout()</code> does't happen for 5 seconds. This delays <code>count_jobs()</code>, which sends ads to the collector, among other things.\n\n</p><p>When the startd starts up, it creates all of its <code>Resource</code> objects and their associated machine ads. It then delays 3 seconds before sending ads to the collector \"to allow the startd's state to quiesce\". This principally means ensuring attributes that are advertised cross-slot are accurate. After recent changes by TJ, this should not be necessary. The delay can be reduced to 0 seconds (though still in a separate daemoncore timer).</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Sep-01 14:42:36 by jfrey:</em> <br/>\n\nImproving the master's startup time tickles a bug related to one observed in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7502\" onclick=\"get_ticket_and_populate_wrapper('7502'); return false;\" title=\"Avoid blocking i/o in shared port daemon\">#7502</a></span>. When the shared port daemon sends its first child-alive message to the master, the master sees no data on the passed socket. When the shared port daemon forwards a connection for the collector's child-alive, the master reads the data from the passed socket just fine. The failure to read data for the shared port's child-alive appears to be tied to the master sleeping and not immediately responding to the connection from the shared port daemon. Reverting the master's behavior on macOS mostly fixes the problem, but the underlying cause should still be investigated.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7866\" onclick=\"get_ticket_and_populate_wrapper('7866'); return false;\" title=\"Shared port socket-passing oddities on Mac OS X\">#7866</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nShared port socket-passing oddities on Mac OS X</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-28 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61355\">[61355]</a></span>: Docs for improved daemon startup time. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7799\" onclick=\"get_ticket_and_populate_wrapper('7799'); return false;\" title=\"Remove intentional delays in daemon startup\">#7799</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-01 15:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61184\">[61184]</a></span>: Disable master fast startup on macOS. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7799\" onclick=\"get_ticket_and_populate_wrapper('7799'); return false;\" title=\"Remove intentional delays in daemon startup\">#7799</a></span> Having the master sleep for 100ms between checks for a daemon's address file is causing the shared port dameon's child-alive message to be lost on macOS. So restore the old, slower code there until we figure out what's going wrong.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-17 13:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60472\">[60472]</a></span>: Improve startd startup time. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7799\" onclick=\"get_ticket_and_populate_wrapper('7799'); return false;\" title=\"Remove intentional delays in daemon startup\">#7799</a></span> After recent improvements in cross-slot advertisement, we don't need to wait before sending the intial udpates to the collector.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-17 12:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60471\">[60471]</a></span>: Improve master startup time. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7799\" onclick=\"get_ticket_and_populate_wrapper('7799'); return false;\" title=\"Remove intentional delays in daemon startup\">#7799</a></span> When waiting for a daemon's address file to appear before starting other daemons, check every 100ms instead of once a second.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-17 11:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60470\">[60470]</a></span>: Improve schedd startup time. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7799\" onclick=\"get_ticket_and_populate_wrapper('7799'); return false;\" title=\"Remove intentional delays in daemon startup\">#7799</a></span> Allow Scheduler::timeout()'s initial run to happen immediately, instead of after the minimum interval (default 5 seconds).  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Sep-28 16:00", "status": "resolved", "created": "2020-Aug-17 11:43", "fixed_version": "2020-Aug-17 11:43", "broken_version": "", "priority": "3", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}