{"id": 2705, "title": "Ticket #2705: condor_schedd misreports submitter ads for running jobs on restart", "description": "<blockquote>\n<div class=\"verbatim\">\n<pre>Description of problem:\nSo a relatively subtle fairshare issue has been affecting us due to our schedd\nstability issues lately.  This is what I believe to be going on:\n\n* Jobs for a particular AccountingGroup are running in a condor_schedd.\n* The submitter add for the jobs reports running &amp; idle jobs with Name equal to\nthe AccountingGroup, and there's another submitter ad with the Name equal the\nUser attribute of the jobs but 0 for running/idle/held.\n* The schedd dies and is restarted\n* The running jobs are reported in a submitter ad with Name equal to User, not\nName equal to AccountingGroup.  The submitter ad with Name equal to\nAccountingGroup shows idle jobs but 0 running jobs.\n* During the negotiation cycle the negotiator sees 0 running jobs for the group\nand allocates slots for additional jobs.  When it connects to the schedd it\nsees a larger number of jobs running than shares were initialized for, decided\nthe group has received enough allocation, and doesn't dispatch any more jobs to\nit.  A \"trapped\" AccountingGroup can often receive no other jobs until existing\nrunning jobs finish.\n\nThe misreporting submitter ad is a fairly severe bug due to the fairshare\nmiscaluation and how new job dispatching is blocked until job completion.  Can\nyou kindly repro this and look at providing us a patch?\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\nRoot cause is that the schedd does not properly restore accounting group info on restart.\n\n<p>REPRO/TEST:\n\n</p><p>Using the following config:\n</p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nNEGOTIATOR_USE_SLOT_WEIGHTS = FALSE\nNEGOTIATOR_INTERVAL = 30\n\nSCHEDD_INTERVAL\t= 15\n\nCLAIM_WORKLIFE = 0\n\nNUM_CPUS = 10\n\n# turn off round robin and multiple allocation rounds\nHFS_ROUND_ROBIN_RATE = 100000000\nHFS_MAX_ALLOCATION_ROUNDS = 1\n\nGROUP_NAMES = a, b\n\nGROUP_QUOTA_a = 5\nGROUP_QUOTA_b = 5\n\nGROUP_ACCEPT_SURPLUS = FALSE\nGROUP_AUTOREGROUP = FALSE\n</pre></div>\n\n\n<p>Submit the following job (you may wish to replace 'eje' with your username)\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 6000\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.eje\"\nqueue 5\n</pre></div>\n\n\n<p>After the jobs negotiate, you should see submitter 'a.eje' with 5 jobs running:\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_status -submitter\nName                 Machine      Running IdleJobs HeldJobs\n\na.eje@localdomain    localhost.         5        0        0\n                           RunningJobs           IdleJobs           HeldJobs\n\n   a.eje@localdomain                 5                  0                  0\n\n               Total                 5                  0                  0\n</pre></div>\n\n\n<p>Now restart the schedd:\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_restart -schedd</pre></div>\n\n\n<p>Before the fix: After schedd restarts, you will see that the jobs have been improperly re-constituted with submitter 'eje' instead of 'a.eje':\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_status -submitter\n\nName                 Machine      Running IdleJobs HeldJobs\n\na.eje@localdomain    localhost.         0        0        0\neje@localdomain      localhost.         5        0        0\n                           RunningJobs           IdleJobs           HeldJobs\n\n   a.eje@localdomain                 0                  0                  0\n     eje@localdomain                 5                  0                  0\n\n               Total                 5                  0                  0\n</pre></div>\n\n\n<p>After the fix: if you repeat the repro steps above, you should see that after the schedd is restarted, the jobs are correctly reconstituted with 'a.eje' for the submitter name:\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_status -submitter\n\nName                 Machine      Running IdleJobs HeldJobs\n\na.eje@localdomain    localhost.         5        0        0\n                           RunningJobs           IdleJobs           HeldJobs\n\n   a.eje@localdomain                 5                  0                  0\n\n               Total                 5                  0                  0\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/507/gt2705-schedd-acct-group.patch\">gt2705-schedd-acct-group.patch</a>\n1195 bytes added by eje on 2011-Dec-12 21:31:45 UTC.\n<br/>\nfrom Jon Thomas - patch to correctly update owner when accounting group is set on job ad<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-13 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a886da87023f6f2a40e9a605ca4d42399cbc3066\">[28745]</a></span>: correct and edit 7.6.5 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2705\" onclick=\"get_ticket_and_populate_wrapper('2705'); return false;\" title=\"condor_schedd misreports submitter ads for running jobs on restart\">#2705</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-13 12:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dbeabda98bd6137ac5016cc9b7cb212ea2617486\">[28737]</a></span>: ===VersionHistory:Complete=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2705\" onclick=\"get_ticket_and_populate_wrapper('2705'); return false;\" title=\"condor_schedd misreports submitter ads for running jobs on restart\">#2705</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-13 11:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/20630d9a95334120b33da934ec9595306240b1a3\">[28736]</a></span>: Fix logic in schedd restart to properly restore accounting group ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2705\" onclick=\"get_ticket_and_populate_wrapper('2705'); return false;\" title=\"condor_schedd misreports submitter ads for running jobs on restart\">#2705</a></span> Committer: Erik Erlandson  (By Jon Thomas )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Dec-13 12:05", "status": "resolved", "created": "2011-Dec-12 15:07", "fixed_version": "2011-Dec-12 15:07", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, tstclair@redhat.com, gthain@cs.wisc.edu, jthomas@redhat.com, dan@hep.wisc.edu", "due_date": ""}