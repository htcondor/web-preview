{"id": 3200, "title": "Ticket #3200: condor_submit -spool can return failure and still leave jobs submitted", "description": "<blockquote>\n<strong>Problem</strong>\nWhen doing a condor_submit with the -spool option, condor_submit first submits all the jobs on hold in one transaction, and then it starts a second transaction to transmit the input files.  If there is an error sending the input files, condor_submit will exit with a nonzero exit status (this is good), BUT a pile of jobs will be left behind in the queue still sitting on hold (this is bad).  If condor_submit returns failure, the job queue should be left in a state as if nothing happened - aka the entire submission should be rolled back.\n\n<p><strong>Suggested Fix</strong>\nThe schedd already knows if the transmission of input files succeeds or fails. If the staging of the input files failed, schedd in method <code>Scheduler::spoolJobFilesReaper()</code> should remove all the jobs involved (this same method is already releasing all the involved jobs from hold if the transfer succeeds).  In addition, in the rare event that condor_submit dies right after submitting the jobs but before it starts transferring the input files, the schedd should periodically remove (garbage collect) jobs that are in hold state due to file transfer for a long period of time, or for a short period of time if there are no file worker threads active (i.e. <code>spoolJobFileWorkers</code> hash table is empty). To keep Condor-C happy, in <code>Scheduler::spoolJobFiles()</code>, alongside the code where we look at ATTR_STAGE_IN_FINISH to be certain we do not allow stagein to happen more than once, we should also confirm that the job is in held state for stagein reasons - this will keep Condor-C from attempting to restage files to a job in X state after the changes suggested above are implemented.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Oct-02 16:19:57 by nwp:</em> <br/>\n\nPushing change outlined above onto <code>V7_8-gittrac_3200-branch</code> and assigning to Jaime for review.\n\n<p></p><hr/>\n<em>2012-Oct-22 14:17:18 by nwp:</em> <br/>\n\nTests are green now.  Needs to be reviewed.\n<hr/>\n<em>2012-Oct-25 17:52:16 by johnkn:</em> <br/>\n\nBulk change of target version from v070806 to v070807 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2012-Oct-26 11:48:59 by jfrey:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Commit <span class=\"chng\"><a href=\"chngview?cn=33735\">[33735]</a></span> looks good.\nThe only quibble I have is that the calls to BeginTransaction() and CommitTransaction() in Scheduler::spoolJobFilesReaper() could be removed by passing <code>true</code> as the fourth argument to abortJob().\n\n</p><p></p><hr/>\n<em>2012-Oct-26 13:54:25 by nwp:</em> <br/>\n\nAddressed Jaime's \"quibble\" above. Then rebased on <code>V7_8-branch</code> and pushed, adding version history.  I missed the window for 7.8.6, so this is going in 7.8.7.  Added version history stuff for 7.8.7, since it does not seem to be in there yet.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-29 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33926\">[33926]</a></span>: edit of version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3200\" onclick=\"get_ticket_and_populate_wrapper('3200'); return false;\" title=\"condor_submit -spool can return failure and still leave jobs submitted\">#3200</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-26 13:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33770\">[33770]</a></span>: Don't leave jobs in hold when condor_submit dies <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3200\" onclick=\"get_ticket_and_populate_wrapper('3200'); return false;\" title=\"condor_submit -spool can return failure and still leave jobs submitted\">#3200</a></span> When doing a condor_submit with the -spool option, condor_submit first submits all the jobs on hold in one transaction, and then it starts a second transaction to transmit the input files. If there is an error sending the input files, condor_submit\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Oct-26 13:54", "status": "resolved", "created": "2012-Aug-16 18:27", "fixed_version": "2012-Aug-16 18:27", "broken_version": "v070600", "priority": "3", "subsystem": "Daemons", "assigned_to": "nwp", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu jfrey@cs.wisc.edu tstclair@redhat.com", "due_date": ""}