{"id": 618, "title": "Ticket #618: VM Universe support for helper scripts to generate libvirt XML", "description": "<blockquote>\nThis patch adds support for helper scripts to generate XML configurations for libvirt in the VM Universe.  It includes an example condor_config for using such scripts, and a simple example script that reproduces the existing behavior of the VM universe.</blockquote>", "remarks": "<blockquote>\n<em>2009-Jul-15 20:39:32 by bkreuter:</em> <br/>\n\nUploaded new patch based on Matt's comments.\n\n<p></p><hr/>\n<em>2009-Aug-03 12:32:00 by jfrey:</em> <br/>\n\nGeneral:\n<ul>\n<li>Why not use the code that already exists for calling out to a script to\nwrite the VM's control file (config param USE_SCRIPT_TO_CREATE_CONFIG)?\n</li><li>Why add a condor_config.vm_xml_helper file?\n</li><li>Config file parameter names should be in all-caps (XML_COMMAND,\n  XML_COMMAND_DEBUG)\n</li><li>Need better names for XML_COMMAND and XML_COMMAND_DEBUG config params.\n</li></ul>\n\n<p>vmgahp.cpp: VMGahp:executeStart():\n\n</p><p></p><ul>\n<li>If XML_COMMAND is set, then a <span class=\"quote\">VirshType</span> is always created. This\n  parameter should be ignored if the VM type isn't virsh-based.\n</li></ul>\n\n<p>vmgahp_common.cpp: systemCommand():\n\n</p><p></p><ul>\n<li>Don't change execvp() to execv(). The VMware code needs it to find perl.\n</li><li>Do stdout and stderr need to be available separately? This introduces\n  new deadlocking possibilities.\n</li><li>All callers of systemCommand() used to have stderr merged with stdout.\n  Now they lose stderr. If a caller wants stderr, the behavior is\n  different between unix and windows. On unix, it's separate from\n  stdout. On windows, it's merged with stdout, but the caller must\n  provide a dummy <span class=\"quote\">StringList</span> for stderr that's always empty.\n</li></ul>\n\n<p>xen_type.cpp: VirshType::CreateVirshConfigFile():\n\n</p><p></p><ul>\n<li>Why is XML_COMMAND_DEBUG necessary? Can't the helper script write its\n  debug information to its stdout or stderr? Will the file be appended\n  to or overwritten each time the script is run?\n</li><li>Why is the script's stderr logged, but not its stdout?\n</li><li>You should call error_strings.rewind() before trying to loop over\n  error_strings' entries.\n</li><li>You log the contents of error_strings twice in a row.\n</li><li>Was there a reason you used a socket in systemCommand() instead of a\n  pair of pipes? With pipes, you wouldn't have the problem of being\n  unable to close stdin and stdout separately.\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Aug-10 22:52:41 by bkreuter:</em> <br/>\n\nThe exist code will not pass classad attributes that do not have the JobVM or VMPARAM prefix.  I did not want to break compatibility with existing scripts by changing this behavior.\n\n<p>The condor_config.vm_xml_helper was created as part of an example of how to use this feature; it has two functional lines, and several lines of comments.\n\n</p><p>I changed the names of the two parameters; it is now LIBVIRT_XML_SCRIPT and LIBVIRT_XML_SCRIPT_DEBUG.  The second parameter is needed to allow extra debugging information; this was the simplest way to signal to a script that extra debugging information should be provided.  How this file is opened -- whether it is overwritten or appended -- is at the discretion of the script writer.\n\n</p><p>I updated systemCommand so that there is a final parameter, which allows callers to merge stderr and stdout.  It does not appear that any current code in the vmgahp directory does so, but it is now possible nonetheless.  The behavior on Windows and Unix will be the same now when the outputs are supposed to be merged.\n\n</p><p>The purpose of separating stdout and stderr was to allow the XML generator scripts to write the XML to their stdout; stderr can then be used for warnings instead of just errors.  The stderr is not actually logged twice; it is logged once, but a second copy of the logging code was included for the case when the execution failed.\n\n</p><p>The rest of your comments should be corrected in this new patch.\n\n</p><p></p><hr/>\n<em>2009-Aug-13 11:35:34 by jfrey:</em> <br/>\n\nComments on the latest patch...\n\n<p>src/condor_examples/Imakefile:\n</p><ul>\n<li>Why is the make target for condor_limits_wrapper.sh removed? I have no\nidea what it does and it isn't referenced anywhere else in the code, but\nit doesn't appear to be related.\n</li></ul>\n\n<p>src/condor_examples/condor_config.generic:\n</p><ul>\n<li>Remove changed value of STARTER_DEBUG. I see the new config code\n(<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=123\" onclick=\"get_ticket_and_populate_wrapper('123'); return false;\" title=\"Grand unified param() system: Phase 1\">#123</a></span>) lists D_NODATE as the new default value, but that setting doesn't\nexist. I'll talk to Pete about that.\n</li></ul>\n\n<p>src/condor_examples/condor_config.vm_xml_helper:\n</p><ul>\n<li>This file should be removed and\nthe sample usage of LIBVIRT_XML_SCRIPT and LIBVIRT_XML_SCRIPT_DEBUG\nplaced in condor_config.generic, but commented out. There's no reason to\nhave a separate file, whose other contents have already diverged from\ncondor_config.generic.\n</li></ul>\n\n<p>src/condor_examples/generic_xml.yacc,\nsrc/condor_examples/generic_xml.yy,\nsrc/condor_examples/mkqcow.sh:\n</p><ul>\n<li>What do these do? They don't appear to be used by anything else in the\ncode.\n</li></ul>\n\n<p>vmgahp_common.cpp: systemCommand():\n</p><ul>\n<li>The parent process's handling of stdin_pipes and stdout_pipes is\nreversed.\n</li><li>childerr is never closed.\n</li><li>The patch still changes the default handling of stderr from being\nmerged with stdout to being discarded. This will cause most errors\nmessages to be lost, whereas currently they are logged.\n</li></ul>\n\n<p>xen_type.cpp: VirshType::CreateVirshConfigFile():\n</p><ul>\n<li>With systemCommand() using pipes, the blank line after the classad\nshouldn't be necessary, and the interface is a little cleaner without\nit.\n</li><li>When calling simple_helper.awk, you pass a filename on the\ncommand-line that the script writes the XML file into. After the script\nfinishes, you then overwrite that file with the script's stdout, which\nit appears would be empty. One error print line in the script is missing\na redirect.\n\n<p></p></li><li>Here's an alternative to LIBVIRT_XML_SCRIPT_DEBUG which I think is more flexible: The script writes\nthe XML to it stdout, which the gahp then writes to the desired file.\nThe command-line arguments to the script are set by a config knob\nLIBVIRT_XML_SCRIPT_ARGS. The filename for the XML file doesn't have to\nbe passed to the script, since the gahp writes the file. Then, all\narguments to the script are at the discretion of the script's writer,\nwho can set them as desired via the new config knob.\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Aug-13 13:09:29 by bkreuter:</em> <br/>\n\nSome of the issues your brought up were a result of me creating the patch against the wrong commit; I have fixed that.  The yacc script is just another example of a script that could be used with this new feature; I can remove it if you do not want to merge it in.  I uploaded a new patch addressing the other concerns.\n\n<p></p><hr/>\n<em>2009-Aug-13 14:22:07 by jfrey:</em> <br/>\n\nComments on patch.4. I missed a couple of these on the previous round.\n\n<p>src/condor_examples/Imakefile:\n</p><ul>\n<li>Remove condor_config.vm_xml_helper from FILES list.\n</li></ul>\n\n<p>src/condor_vm-gahp/simple_helper.awk:\n</p><ul>\n<li>Change script name to include 'libvirt'.\n</li></ul>\n\n<p>src/condor_vm-gahp/vmgahp.cpp:\n</p><ul>\n<li>param(\"xml_command\") should be param(\"LIBVIRT_XML_SCRIPT\")\n</li></ul>\n\n<p>src/condor_vm-gahp/vmgahp_common.cpp:\n</p><ul>\n<li>stdin_pipes and stdout_pipes are reversed in fdopen() calls.\n</li><li>Use args.AppendArgsV1RawOrV2Quoted() instead of args.AppendArg() for\nLIBVIRT_XML_SCRIPT_ARGS. That allows multiple arguments to be given.\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Aug-13 14:31:03 by jfrey:</em> <br/>\n\nOne more comment on patch.4: CreateVirshConfigFile() is no longer sticking an extra newline after the classad in the script's stdin, but the awk script still has a comment about expecting a blank line. I don't know awk well enough to tell if the script needs the blank line.\n\n<p></p><hr/>\n<em>2009-Aug-13 15:08:50 by bkreuter:</em> <br/>\n\nUploaded a new patch.\n\n<p></p><hr/>\n<em>2009-Aug-13 15:49:57 by jfrey:</em> <br/>\n\nComments on patch.5 (almost there!):\n\n<p></p><ul>\n<li>Patch isn't made against current master branch.\n</li></ul>\n\n<p>src/condor_vm-gahp/Imakefile:\n</p><ul>\n<li>Change name of awk script in all_target().\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Aug-13 16:35:35 by bkreuter:</em> <br/>\n\nThis should do it.\n\n<p></p><hr/>\n<em>2009-Aug-13 16:59:44 by jfrey:</em> <br/>\n\npatch.6 doesn't include the awk script.\n\n<p></p><hr/>\n<em>2009-Aug-13 17:08:10 by bkreuter:</em> <br/>\n\nThanks for catching that.\n\n<p></p><hr/>\n<em>2009-Aug-14 09:46:11 by jfrey:</em> <br/>\n\nPatch.7 is missing generic_xml.yacc, generic_xml.yy, and mkqcow.sh, as was patch.6 it turns out.\n\n<p></p><hr/>\n<em>2009-Aug-14 10:02:43 by bkreuter:</em> <br/>\n\nOk, now everything should be good.\n\n<p></p><hr/>\n<em>2009-Aug-14 10:27:00 by jfrey:</em> <br/>\n\nIn patch.8, src/condor_examples/Imakefile is missing the make target for lex.yy.c.\n\n<p></p><hr/>\n<em>2009-Aug-14 10:36:14 by bkreuter:</em> <br/>\n\nFixed.\n\n<p></p><hr/>\n<em>2009-Aug-14 11:00:00 by jfrey:</em> <br/>\n\nIt looks like you hand-edited the patch to add the Imakefile target, but forgot to update the line numbers. With a little tweak, I applied the last patch and pushed it.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/64/xmlparam.patch\">xmlparam.patch</a>\n111028 bytes added by bkreuter on 2009-Jul-07 21:47:16 UTC.\n<br/>\nThe patch.<br/>\n</li><li><a href=\"../files/68/xmlparam.patch\">xmlparam.patch</a>\n114792 bytes added by bkreuter on 2009-Jul-16 01:40:03 UTC.\n</li><li><a href=\"../files/72/xmlparam.patch.3\">xmlparam.patch.3</a>\n134497 bytes added by bkreuter on 2009-Aug-11 03:53:31 UTC.\n</li><li><a href=\"../files/74/xmlparam.patch.4\">xmlparam.patch.4</a>\n31820 bytes added by bkreuter on 2009-Aug-13 18:10:31 UTC.\n</li><li><a href=\"../files/76/xmlparam.patch.5\">xmlparam.patch.5</a>\n31668 bytes added by bkreuter on 2009-Aug-13 20:09:35 UTC.\n</li><li><a href=\"../files/77/xmlparam.patch.6\">xmlparam.patch.6</a>\n13870 bytes added by bkreuter on 2009-Aug-13 21:36:21 UTC.\n</li><li><a href=\"../files/78/xmlparam.patch.7\">xmlparam.patch.7</a>\n16019 bytes added by bkreuter on 2009-Aug-13 22:07:56 UTC.\n</li><li><a href=\"../files/79/xmlparam.patch.8\">xmlparam.patch.8</a>\n31152 bytes added by bkreuter on 2009-Aug-14 15:02:01 UTC.\n</li><li><a href=\"../files/80/xmlparam.patch.9\">xmlparam.patch.9</a>\n31190 bytes added by bkreuter on 2009-Aug-14 15:36:56 UTC.\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Sep-11 06:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/79ff2551a5bd30d748151d737e1395501d37bb5d\">[15662]</a></span>: libvirt_simple_script.awk goes in libexec, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=618\" onclick=\"get_ticket_and_populate_wrapper('618'); return false;\" title=\"VM Universe support for helper scripts to generate libvirt XML\">#618</a></span>  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-27 17:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3036938a3e35174da49571a5114e57d55e8ffad5\">[15553]</a></span>: libvirt_simple_script.awk goes in libexec, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=618\" onclick=\"get_ticket_and_populate_wrapper('618'); return false;\" title=\"VM Universe support for helper scripts to generate libvirt XML\">#618</a></span>  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-14 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4789e64237fb132ec2f5029826ff5813f9da4530\">[15349]</a></span>: Fix windows build for recent vm unvierse commit (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=618\" onclick=\"get_ticket_and_populate_wrapper('618'); return false;\" title=\"VM Universe support for helper scripts to generate libvirt XML\">#618</a></span>)  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-14 14:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3f990f1f528c8e6af091c2ec317ae0fb4cbe9ac6\">[15348]</a></span>: Missed some files in previous commit of libvirt XML helper scripts (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=618\" onclick=\"get_ticket_and_populate_wrapper('618'); return false;\" title=\"VM Universe support for helper scripts to generate libvirt XML\">#618</a></span>) Committer: Jaime Frey  (By Benjamin Kreuter )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Aug-14 10:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f45fe3f92acb579c1040be1e77117770abbb5cbd\">[15340]</a></span>: Support helper scripts to generate libvirt XML in VM universe (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=618\" onclick=\"get_ticket_and_populate_wrapper('618'); return false;\" title=\"VM Universe support for helper scripts to generate libvirt XML\">#618</a></span>) Committer: Jaime Frey  (By Benjamin Kreuter )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2009-Dec-04 16:47", "status": "resolved", "created": "2009-Jul-07 16:46", "fixed_version": "2009-Jul-07 16:46", "broken_version": "v070300", "priority": "4", "subsystem": "VM", "assigned_to": "bkreuter", "derived_from": "", "creator": "bkreuter", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bkreuter@redhat.com, matt@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}