{"id": 4829, "title": "Ticket #4829: ENABLE_IPV6 only works in top-level condor_config", "description": "<blockquote>\nGSI auth fails unless ENABLE_IPV6 is set in the global condor_config.\n\n<p>This is because GSI auth relies on verification of forward-resolution; forward resolution relies on ipv6_getaddrinfo, which calls get_default_hint().\n\n</p><p>get_default_hint invokes _condor_is_ipv6_mode; this function caches the param value on the first call (which is invoked after the global condor_config but before the rest of configuration has been done).  So, unless ENABLE_IPV6 is set globally, get_default_hint forces the use of IPv4 addresses in ipv6_getaddrinfo.\n\n</p><p>Accordingly, GSI clients will reject GSI servers.  There are probably other users of forward resolution that are expecting it to work.\n\n</p><p>I see no reason to cache the value of the param_boolean call; if the lookup was done from the config system each time, this would work.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jan-14 10:27:47 by tlmiller:</em> <br/>\n\nThat I recall, all sorts of other random stuff will break horribly if ENABLE_IPVx isn't in the base config file; I'm not sure why that's not documented.\n\n<p>That said, this does seem like a harmless fix.  I'm not sure what the caching was intended to accomplish.\n\n</p><p></p><hr/>\n<em>2015-Jan-14 12:53:50 by bbockelm:</em> <br/>\n\nI think, as part of the work for 8.3.2, the dependency on the cached value was reduced to <strong>only</strong> get_default_hint() for getaddrinfo().  Hostname determination (which is really what caused things to go wonky) manually overrides the hint to use AF_UNSPEC.\n\n<p>Since resolution of $HOSTNAME no longer depends on ENABLE_IPV6 like it did pre-8.3.2, I see no reason for the caching.\n\n</p><p></p><hr/>\n<em>2015-Jan-14 19:28:17 by bbockelm:</em> <br/>\n\nDoh!  Sorry about that build failure; that's what I get when I \"tidy up\" after testing.\n\n<p></p><hr/>\n<em>2015-Jan-20 16:21:26 by adesmet:</em> <br/>\n\nI believe the primary danger is that HOSTNAME, FULL_HOSTNAME, or IP_ADDRESS would change halfway through parsing the configuration file, causing no end of grief.\n\n<p>I coulda sworn that HOSTNAME and FULL_HOSTNAME could change, although a quick review of the code suggests it's not possible. Should be re-investigated.\n\n</p><p>IP_ADDRESS can't change, but only because it's hard coded to only return the IPv4 address.  I'm going to smack a comment in there to warn anyone considering fiddling with it that it's sitting on a landmine.\n\n</p><p></p><hr/>\n<em>2015-Jan-23 11:37:35 by bbockelm:</em> <br/>\n\nHi Alan,\n\n<p>If I recall correctly, the work done for 8.3.2 (don't recall the exact ticket) prevents the hostname from changing based on whether V6 or V4 is enabled.\n\n</p><p>Is it possible to make IP_ADDRESS deprecated or emit a warning if used?  In a world where there may be  a half-dozen addresses for a given host, it seems like there's little chance someone is using it correctly anyway...\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jan-23 14:25:57 by adesmet:</em> <br/>\n\nStatus: Alan is going to do a few tests to see if he can replicate the \"$(HOSTNAME) changes halfway through parsing the config files\" bug. If not, we're golden and just need a version history entry noting that the restriction (which was never documented in the manual, as best I can tell) was lifted.\n\n<p>Proposed text:\n</p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nENABLE_IPV4 or ENABLE_IPV6 may now be safely set in any configuration file. Previously setting them in any file other than the primary configuration file could lead to unpredictable behavior.\n</td></tr></tbody></table></div>\n\n\n<p></p><hr/>\n<em>2015-Feb-03 11:53:02 by adesmet:</em> <br/>\n\n(This ticket replaces <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=3277\" onclick=\"get_ticket_and_populate_wrapper('3277'); return false;\" title=\"ENABLE_IPV6 must be set in the main config file\">#3277</a></span>: ENABLE_IPV6 must be set in the main config file)</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Feb-19 10:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41f60f8eaad3013eb0ab7a8007764b5a2530c501\">[43413]</a></span>: add 8.3.3 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4829\" onclick=\"get_ticket_and_populate_wrapper('4829'); return false;\" title=\"ENABLE_IPV6 only works in top-level condor_config\">#4829</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-20 16:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/88f1c0a6b581dfbc373b8f153edaef0075907da4\">[42291]</a></span>: Add warning about IPv6ifying my_ip_string <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4829\" onclick=\"get_ticket_and_populate_wrapper('4829'); return false;\" title=\"ENABLE_IPV6 only works in top-level condor_config\">#4829</a></span> This function is called while the configuration files are being read. If this function returns different answers at different times, bad things could happen.  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-14 16:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b36bee215059d2bb1d856fccc7322be0881bb755\">[42219]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4829\" onclick=\"get_ticket_and_populate_wrapper('4829'); return false;\" title=\"ENABLE_IPV6 only works in top-level condor_config\">#4829</a></span>) Correct obvious build failures.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-14 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/795237486d7dc6082399c1cde5b8d3b24738b7ff\">[42211]</a></span>: Do not cache IPV6 status. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4829\" onclick=\"get_ticket_and_populate_wrapper('4829'); return false;\" title=\"ENABLE_IPV6 only works in top-level condor_config\">#4829</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Nov-12 14:57", "status": "resolved", "created": "2015-Jan-13 21:48", "fixed_version": "2015-Jan-13 21:48", "broken_version": "v080302", "priority": "2", "subsystem": "Daemons", "assigned_to": "adesmet", "derived_from": "#4492", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}