{"id": 3476, "title": "Ticket #3476: CCB reconnect can fail due to race conditition", "description": "<blockquote>\nThe following race condition causes CCB reconnection to fail, making the daemon unreachable via CCB until it is restarted.\n\n<p></p><ol>\n<li>Reverse connection is requested.  Expecting callback when non-blocking connect to target daemon finishes ...\n</li><li>The connection to the CCB server fails.  Reconnection is scheduled.  Waiting for timer callback ...\n</li><li>Callback for 2.  CCB reconnect is initiated.  Expecting callback when non-blocking connect to CCB server finishes ...\n</li><li>Callback for 1.  Reverse connect to target daemon has finished (or failed).  Incorrectly, attempt to send report to CCB server on socket that is not yet connected.  This fails and triggers a second reconnect attempt without correctly cleaning up the in-progress reconnect attempt.  An invalid state is entered.  The daemon waits forever for the reconnect callback to 3, but the operation has been canceled, and no callback will ever happen.\n</li></ol>\n\n<p>The minimum time between 2 and 3 is one minute, and 4 must come after 3 but before the callback to 3 for the race to cause incorrect behavior.  This makes the race fairly unlikely.  However, in the cases we have observed, the network problem that causes 2 also delays 4, creating the conditions for the problem to strike.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Feb-14 16:16:13 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>From my limited understanding of the CCB code, this change looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-01 13:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35040\">[35040]</a></span>: minor edit of 7.8.8 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3476\" onclick=\"get_ticket_and_populate_wrapper('3476'); return false;\" title=\"CCB reconnect can fail due to race conditition\">#3476</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-03 14:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34828\">[34828]</a></span>: Fixed race condition that can result in CCB reconnection failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3476\" onclick=\"get_ticket_and_populate_wrapper('3476'); return false;\" title=\"CCB reconnect can fail due to race conditition\">#3476</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-04 14:42", "status": "resolved", "created": "2013-Feb-03 14:10", "fixed_version": "2013-Feb-03 14:10", "broken_version": "v070300", "priority": "2", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "dan@hep.wisc.edu,jfrey@cs.wisc.edu", "due_date": ""}