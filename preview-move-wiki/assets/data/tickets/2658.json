{"id": 2658, "title": "Ticket #2658: privsep + gid tracking + fork does not work", "description": "<blockquote>\nThe implementation of privsep gid tracking is broken when USE_CLONE_TO_CREATE_PROCESSES is not true in the starter.  This problem is especially relevant in 7.6.4, because <span class=\"chng\"><a href=\"chngview?cn=27874\">[27874]</a></span> forces use of fork() instead of clone() in all but the schedd.\n\n<p>The problem is that in the child branch of clone/fork, the tracking gid is recorded in a data structure belonging to the parent process.  The parent then sends this gid over a pipe to the privsep switchboard.  When using clone(), this happens to work, because the child and parent share the same memory.  When using fork(), the parent's variable holding the tracking gid remains uninitialized, so it writes a garbage value to the switchboard.\n\n</p><p>Depending on shared memory between the parent and child is not a good design.  We suspect that this was not done intentionally.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Nov-23 13:45:44 by danb:</em> <br/>\n\nThe user-visible symptom of this problem is that jobs fail to start.  They appear as running briefly and then return to the idle state.  The starter log contains the following error message:\n\n<p></p><pre>   privsep_get_switchboard_response: error received: error switching to uid 201, tracking gid 11060: code -13 the tracking group was not safe\n</pre>\n\n<p>Another type of problem that is possible is that a valid gid happens to appear in the garbage value.  Then the job will be started with a different tracking gid than the one expected by the procd.  In this case, I believe everything would appear to work, but it might be possible for some job processes to not be properly tracked/killed.\n\n</p><p></p><hr/>\n<em>2011-Nov-23 15:54:36 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Patch looks good (+10 points for using full_read()!), however, in the current patch the code EXCEPTS if it fails to read the tracking gid from the pipe if the tracking gid was expected. I think instead of EXCEPTing, Create_Process should fail the same way as if we read an errno (e.g. do a waitpid() to prevent a zombie, return failure). Also, a comment that currently only the starter expects a tracking gid at this point in the code would be helpful.\n\n</p><p>Also in v7.7.x we should ideally do something in the event of an uninitialized tracking gid (e.g. tracking gid of zero).  However, in v7.6.x (stable), the complications of dealing w/ a tracking gid of zero is likely not worth the risk... a tracking gid of zero should almost assuredly end up with the switchboard not accepting it.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/498/tracking_gid_patch.txt\">tracking_gid_patch.txt</a>\n9619 bytes added by danb on 2011-Nov-23 04:22:58 UTC.\n<br/>\nThis patch propagates the tracking gid from the child to the parent over the same pipe used to propagate exec errors.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-29 15:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28485\">[28485]</a></span>: edit of defn of USE_CLONE_TO_CREATE_PROCESSES ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-29 12:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28481\">[28481]</a></span>: Edits to lots of 7.6.5 version history items. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2643\" onclick=\"get_ticket_and_populate_wrapper('2643'); return false;\" title=\"Win32 Condor tries to use user from the submit host on remote host\">#2643</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2644\" onclick=\"get_ticket_and_populate_wrapper('2644'); return false;\" title=\"SetEffectiveOwner fails to detect current owner is effective owner\">#2644</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2387\" onclick=\"get_ticket_and_populate_wrapper('2387'); return false;\" title=\"transfer_input_files doesn't transfer directories on Windows.\">#2387</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2614\" onclick=\"get_ticket_and_populate_wrapper('2614'); return false;\" title=\"restart of glidein master causes leaked glexec processes\">#2614</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2660\" onclick=\"get_ticket_and_populate_wrapper('2660'); return false;\" title=\"% sign in hold message causes crash when writing xml user log\">#2660</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-25 10:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28447\">[28447]</a></span>: Fixed a bug in my previous commit that added assertions on tracking_gid != 0. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-25 10:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28446\">[28446]</a></span>: Assert that supplemental tracking gid is not group 0. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-25 10:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28443\">[28443]</a></span>: Add missing ifdef from previous commit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span> Committer: Dan Bradley  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-23 19:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28442\">[28442]</a></span>: Add missing ifdef from previous commit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-23 17:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28435\">[28435]</a></span>: Documented fix for gid tracking with privsep. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span> ===VersionHistory:Complete===  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-23 17:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28434\">[28434]</a></span>: Fixed problem when using gid tracking and privsep and forking. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2658\" onclick=\"get_ticket_and_populate_wrapper('2658'); return false;\" title=\"privsep + gid tracking + fork does not work\">#2658</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-25 10:51", "status": "resolved", "created": "2011-Nov-22 21:30", "fixed_version": "2011-Nov-22 21:30", "broken_version": "v070604", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu,dan@hep.wisc.edu,gthain@cs.wisc.edu,tstclair@redhat.com,matt@cs.wisc.edu", "due_date": ""}