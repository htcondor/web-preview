{"id": 6971, "title": "Ticket #6971: Add timeouts to curl plugin", "description": "<blockquote>\nWhile debugging some squid issues with Moate, we realized that the <code>curl_plugin</code> basically has no timeouts.\n\n<p>Basically, a particular CHTC-run squid had an issue where the server would allow clients to establish a TCP connection - but then one of the three worker processes would instantly lose track of the request.  That means a request could be made from the <code>curl_plugin</code> but no response would be sent - ever!\n\n</p><p>There are two timeouts we should be setting:\n\n</p><p></p><ul>\n<li><a class=\"external\" href=\"https://curl.haxx.se/libcurl/c/CURLOPT_CONNECTTIMEOUT.html\">Connection timeout</a>: amount of time we're willing to wait for a TCP connection to be established.  Useful when a firewall is silently dropping packets.  Note this isn't the case described above.\n</li><li>Minimum speed timeout: useful to ensure the transfer is making forward progress.\n</li></ul>\n\n<p>(There is also an <a class=\"external\" href=\"https://curl.haxx.se/libcurl/c/CURLOPT_TIMEOUT.html\">overall request timeout</a> - but if the response size can vary from 1KB to 1GB, it's not clear what the value should be!)\n\n</p><p>The speed timeout has two settings: <a class=\"external\" href=\"https://curl.haxx.se/libcurl/c/CURLOPT_LOW_SPEED_TIME.html\">sampling interval</a> and the <a class=\"external\" href=\"https://curl.haxx.se/libcurl/c/CURLOPT_LOW_SPEED_LIMIT.html\">minimum average speed</a>.  If the average transfer speed falls below the minimum over the course of a sample interval, then the transfer is killed.\n\n</p><p>For example, if the minimum average speed is set to 1KB/s and the sampling interval is set to 10 seconds, curl will kill the transfer if it does not receive at least 10KB over the course of 10 seconds.\n\n</p><p>There is an infinite amount of tuning that can be done to pick out the values for the minimum speed timeout.  I propose we don't spend too much time here and set something very minimal, like 1KB/s and 30 seconds.  It would solve the problem at hand (zero bytes are sent out over the course of hours) but not the case where the file transfer is so slow to be unusable.\n\n</p><p>Given that any default is likely wrong, we should additionally allow the user to override the values via an undocumented <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> setting.  This would allow us to tune at CHTC without iterating over multiple versions of the code.  <em>If</em> we decide this could be safely set by any user, we can document it.\n\n</p><p>When the timeout occurs, we should consider it a transient error (as it was in this case -- squid was actually only a blackhole for approximately 1/3 of the transfers).</p></blockquote>", "remarks": "<blockquote>\n<em>2019-May-06 12:29:40 by coatsworth:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p><em>multifile_curl_plugin.cpp:</em>\n\n</p><p></p><ul>\n<li>The call to <code>ParseAds()</code> should not happen in the constructor, just in case something goes wrong. We should explicitly call this somewhere else, probably in <code>InitializeCurl()</code> or even the <code>main()</code> function.\n</li><li>Lines 718 and 727: use <code>safe_fopen_wrapper()</code> instead of <code>fopen()</code>.\n</li><li>The <code>ParseAds()</code> function makes me queasy for a bunch of reasons:\n<ul>\n<li>No comments and confusing logic flow. Why do you bail out of the function if <code>ad</code> is unset but not if <code>ad2</code> is unset?\n</li><li>Why are you dynamically allocating the classad::ClassAd objects? This seems prone to leaks and doesn't offer any obvious advantages.\n</li><li>Similarly, shouldn't <code>job_ad</code> and <code>machine_ad</code> just be non-pointer std::string objects?\n</li><li><code>ad</code> and <code>ad2</code> should have more descriptive variable names.\n</li></ul>\n</li></ul>\n\n<p><em>file_transfer.cpp</em>\n\n</p><p></p><ul>\n<li>Line 4816: This <code>dprintf</code> statement should happen inside each of the preceding if-statements (where we know the strings are non-empty), not outside.\n</li><li>Line 4923: same as above\n</li></ul>\n\n<p><em>file_transfer.h</em>\n\n</p><p></p><ul>\n<li>Why does <code>setRuntimeAds()</code> have const std::string &amp; input parameters, instead of just basic std::string objects?</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6985\" onclick=\"get_ticket_and_populate_wrapper('6985'); return false;\" title=\"multifile curl plugin never retries\">#6985</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nmultifile curl plugin never retries</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7079\" onclick=\"get_ticket_and_populate_wrapper('7079'); return false;\" title=\"Address code review: Add timeouts to curl plugin\">#7079</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAddress code review: Add timeouts to curl plugin</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jan-02 14:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/69b677ac551002b8cb9ec1e57aab9a55fa7c2af9\">[58799]</a></span>: Fix warnings in file_transfer.cpp <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-12 09:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3984c32134588614ead8d9b8acaecc33ed9a651f\">[58795]</a></span>: Address code review for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7079\" onclick=\"get_ticket_and_populate_wrapper('7079'); return false;\" title=\"Address code review: Add timeouts to curl plugin\">#7079</a></span>. This does a few things: - Simplify the implementation of `ParseAds`. Objects live on the stack; we use smart pointers to manage lifetimes; safe_fopen variants are used. More commentary is added about the function's purpose in the header. - `ParseAds` is invoked next\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-31 11:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ba71a5095e9642b41872ce2cf11b422e442893e1\">[57022]</a></span>: Add version history for curl transfer timeouts. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-10 16:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a5cd6d43b22c85313c7808ce5025d53b611549ec\">[56857]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37bfb796fab21784cd9c901612e23f38fbd539c8\">[56855]</a></span>, Merged curl_plugin timeouts (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-10 15:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/156d95930e60ef583ea14e2ca6cd755a15604c56\">[56856]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/951b611abd153c6744780bd0af0b89f65c48210c\">[56496]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9b36ddbb49eeff555777658148b9d8881841a08\">[56497]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/51bcb2c2cb2fa274b284d46d668e5ce4cb617f3f\">[56550]</a></span>, Merging curl_plugin timeouts (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-09 20:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/51bcb2c2cb2fa274b284d46d668e5ce4cb617f3f\">[56550]</a></span>: Use the error code, not retry number. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span> The curl plugin appears to have a frustrating bug that, when it checks the exit code for a failure that should be retried, it doesn't actually check the exit code - rather, it checks the retry number!\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-03 10:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9b36ddbb49eeff555777658148b9d8881841a08\">[56497]</a></span>: Pass the job / machine ad locations to the xfer plugin. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span> This allows transfer plugins to make decisions based on the contents of the job.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-03 10:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/951b611abd153c6744780bd0af0b89f65c48210c\">[56496]</a></span>: Add low-speed timeouts to the curl plugin. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6971\" onclick=\"get_ticket_and_populate_wrapper('6971'); return false;\" title=\"Add timeouts to curl plugin\">#6971</a></span> With this, curl will timeout if the transfer is going too slow (default is &lt;1KB/s for over 30 seconds). The default is meant to catch truly dead hosts, not provide a minimum performance.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-May-31 13:05", "status": "resolved", "created": "2019-Mar-29 14:06", "fixed_version": "2019-Mar-29 14:06", "broken_version": "", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "bbockelman@morgridge.org, coatsworth@cs.wisc.edu", "due_date": ""}