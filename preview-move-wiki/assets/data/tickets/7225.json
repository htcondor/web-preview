{"id": 7225, "title": "Ticket #7225: Allow ADVERTISE_* level authz to register with CCB, maybe others.", "description": "<blockquote>\nCurrently the ability to register with CCB is a \"DAEMON\" level operation.  When using the new token-based auth, it is possible a startd may not have a full DAEMON-level but perhaps only an ADVERTISE_STARTD-level token.\n\n<p>It seems these should be sufficient to register with CCB in order to report to the collector.  While changing this, consder whether any other levels (ADMINISTRATOR, NEGOTIATOR, CONFIG, WRITE) should be included as well.  I think thge general ide is that daemoncore commands that \"connect to other daemons from behind a firewall\" should be able to register with CCB.\n\n</p><p>Milestone 1: Update this ticket with exact list of proposed changes to be made.\n\n</p><p>Milestone 2: Update CCB registration code accordingly.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Sep-26 09:56:25 by bbockelm:</em> <br/>\n\nGiven that we are within 24 hours of the code freeze - and there are multiple projects beginning to hit this issue - I propose we do the minimal.  Here's a corresponding branch:\n\n<p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/74\">https://github.com/htcondor/htcondor/pull/74</a>\n\n</p><p></p><hr/>\n<em>2019-Sep-30 04:33:17 by bbockelm:</em> <br/>\n\nPer discussion over email with Zach, I will be merging the PR and he will do a more thorough review.\n\n<p>Results from hand-running ctest looks pretty good; there are build failures on Travis, but they are due to other breakage on master that predates the code branch.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-01 07:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58319\">[58319]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>) Security logic fixup  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-30 10:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58292\">[58292]</a></span>: Version history for <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7281\" onclick=\"get_ticket_and_populate_wrapper('7281'); return false;\" title=\"Exchange a SCITOKEN for a TOKEN\">#7281</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7100\" onclick=\"get_ticket_and_populate_wrapper('7100'); return false;\" title=\"Per-submitter Flocking\">#7100</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-29 15:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57960\">[57960]</a></span>: Commands at level ALLOW should use DAEMON policy. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span> Specifically, commands that do further permission checks in the authorization handler shouldn't use what's expected to be a more restrictive set of authentication methods.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-29 15:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57959\">[57959]</a></span>: Fixup: another bounding set check for authz. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-27 21:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57958\">[57958]</a></span>: Fix application of bounding set in authz checks. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-27 21:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57957\">[57957]</a></span>: Switch CCB_REGISTER to use alt. perm model. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-27 21:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57956\">[57956]</a></span>: Add alternate permission levels to DC. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span> This provides a mechanism to register a single command at several different permissions. The DC policy (e.g., which auth method to utilize) is taken from the primary permission level.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-27 21:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57955\">[57955]</a></span>: Fixup: Incorrect paren in Verify usage. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-26 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57954\">[57954]</a></span>: Accept multiple permission levels for CCB registration. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span> Any of these permissions should be acceptable for advertising to the CCB: - `DAEMON` - `ADVERTISE_SCHEDD` - `ADVERTISE_MASTER` - `ADVERTISE_STARTD`  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-26 09:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57952\">[57952]</a></span>: Allow caller to control the verbosity of `Verify`. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7225\" onclick=\"get_ticket_and_populate_wrapper('7225'); return false;\" title=\"Allow ADVERTISE_* level authz to register with CCB, maybe others.\">#7225</a></span> With this, the caller of `DaemonCore::Verify` can turn down the default verbosity; this is useful when there are several alternates that need to be tested -- or the permission denied is non-fatal.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Oct-30 10:09", "status": "resolved", "created": "2019-Aug-30 11:16", "fixed_version": "2019-Aug-30 11:16", "broken_version": "v080903", "priority": "2", "subsystem": "CCB", "assigned_to": "bbockelm", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "bbockelman@morgridge.org; tannenba@cs.wisc.edu; zmiller@cs.wisc.edu", "due_date": ""}