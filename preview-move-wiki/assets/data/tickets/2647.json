{"id": 2647, "title": "Ticket #2647: Schedd's job evaluation timer can become unregistered", "description": "<blockquote>\nIn the schedd, it's possible for the daemon-core timer for Scheduler::timeout() to become unregistered. If this happens, the schedd will no longer examine the job queue for idle jobs or send its ads to the collector. Once the schedd enters this state, only a reconfig or restart can revive it.\n\n<p>We have observed occasional instances of this happening in Metronome, in the form of a personal schedd that has one dagman job that remains idle forever. We've identified one codepath that can lead to this situation, and possibilities for other codepaths.\n\n</p><p>The simplest solution is to never cancel the timer and also keep it as a periodic timer</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Nov-21 16:21:35 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong> of timer patch attached to this ticket.\n\n<p>Looks good, except change the code fragment in <code>RegisterTimers()</code> from\n\n</p><p></p><pre>  if (timeoutid &lt; 0) {\n    timeoutid = daemonCore-&gt;Register_Timer(10,\n    (TimerHandlercpp)&amp;Scheduler::timeout,\"timeout\",this);\n  }\n</pre>\n\n<p>to be instead\n\n</p><p></p><pre>  if (timeoutid &lt; 0) {\n    timeoutid = daemonCore-&gt;Register_Timer(10, 10,\n    (TimerHandlercpp)&amp;Scheduler::timeout,\"timeout\",this);\n  }\n</pre>\n\n<p>Note the difference is the second version registers the timer as periodic, as a defensive measure against the timer not being reset (which is after all, part of the goal of the patch in the first place).\n\n</p><p></p><hr/>\n<em>2011-Nov-21 17:34:25 by jfrey:</em> <br/>\n\nI've incorporated your comments into my patch.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/496/schedd_timer.patch\">schedd_timer.patch</a>\n1252 bytes added by jfrey on 2011-Nov-17 19:47:08 UTC.\n<br/>\nPatch to ensure schedd's Scheduler::timeout() timer is always registered.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Nov-21 17:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28388\">[28388]</a></span>: Schedd's job evaluation timer can become unregistered. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2647\" onclick=\"get_ticket_and_populate_wrapper('2647'); return false;\" title=\"Schedd's job evaluation timer can become unregistered\">#2647</a></span> A reconfig delivered at the wrong moment can cause the schedd's Scheduler::timeout() timer not be re-registered. This leads to the schedd never starting idle jobs or sending ads to the collector. Only a reconfig or restart can restore normal\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-21 17:34", "status": "resolved", "created": "2011-Nov-17 13:44", "fixed_version": "2011-Nov-17 13:44", "broken_version": "v070600", "priority": "2", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tstclair@redhat.com", "due_date": ""}