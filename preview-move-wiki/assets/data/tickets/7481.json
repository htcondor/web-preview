{"id": 7481, "title": "Ticket #7481: condor_off -startd -peaceful continues to run new jobs", "description": "<blockquote>\ncondor_off -startd -peaceful continues to run new jobs, and a subsequent -graceful is ignored.\n\n<p>My expectation is that \"condor_off -startd -peaceful\" should prevent any new jobs from starting and request running jobs to checkpoint, but not kill any that ignored that request. And that a subsequent \"condor_off -startd -graceful\" would re-request checkpoints but then after some minutes kill jobs that ignored that request.\n\n</p><p>Note, I forgot about -force-graceful, which did set a timer and forcefully kill jobs. However, please remind me why that option is needed? In particular, why doesn't -graceful imply -force-graceful if -peaceful has already been requested?</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Jan-21 09:51:29 by tim:</em> <br/>\n\nStuart Anderson reports:\n\n<p></p><div class=\"verbatim\">\n<pre>[root at cascade1 ~]# cat /etc/redhat-release\nScientific Linux release 7.7 (Nitrogen)\n\n[root at cascade1 ~]# uname -a\nLinux cascade1 3.10.0-1062.7.1.el7.x86_64 #1 SMP Thu Dec 5 14:45:00 CST 2019 x86_64 x86_64 x86_64 GNU/Linux\n\n[root at cascade1 ~]# condor_version\n$CondorVersion: 8.8.7 Dec 24 2019 BuildID: 493225 PackageID: 8.8.7-1 $\n$CondorPlatform: x86_64_RedHat7 $\n\nAn initial \"condor-off -startd -peaceful\" issued yesterday was registered,\n\n==&gt; MasterLog &lt;==\n12/29/19 20:35:51 Handling daemon-specific command for \"STARTD\"\n12/29/19 20:35:51 Sent SIGTERM to STARTD (pid 5576)\n\n==&gt; StartLog &lt;==\n12/29/19 20:35:51 Got SIGTERM. Performing graceful shutdown.\n12/29/19 20:35:51 shutdown graceful\n12/29/19 20:35:51 Cron: Killing all jobs\n12/29/19 20:35:51 Killing job CPUINFO\n12/29/19 20:35:51 Killing job FACTER\n12/29/19 20:35:51 Killing job GPUs_MONITOR\n12/29/19 20:35:51 Cron: Killing all jobs\n12/29/19 20:35:51 Killing job kflops\n12/29/19 20:35:51 Killing job mips\n12/29/19 20:35:51 slot1_4: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_8: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_7: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_1: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_2: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_10: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_11: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_5: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_6: Changing activity: Busy -&gt; Retiring\n12/29/19 20:35:51 slot1_3: Changing activity: Busy -&gt; Retiring\n12/29/19 20:36:55 slot1_4: Called deactivate_claim_forcibly()\n12/29/19 20:36:55 slot1_4: Changing state and activity: Claimed/Retiring -&gt; Preempting/Vacating\n12/29/19 20:36:55 Starter pid 195847 exited with status 0\n12/29/19 20:36:55 slot1_4: State change: starter exited\n12/29/19 20:36:55 slot1_4: State change: No preempting claim, returning to owner\n12/29/19 20:36:55 slot1_4: Changing state and activity: Preempting/Vacating -&gt; Owner/Idle\n\nHowever, jobs continue to be started today,\n\n==&gt; StarterLog.slot1_2 &lt;==\n12/30/19 08:04:35 (pid:119569) unhandled job exit: pid=249666, status=19712\n12/30/19 09:05:43 (pid:119569) Process exited, pid=254532, status=77\n12/30/19 09:05:45 (pid:119569) Current mount, /, is shared.\n12/30/19 09:05:45 (pid:119569) Current mount, /var, is shared.\n12/30/19 09:05:45 (pid:119569) Current mount, /, is shared.\n12/30/19 09:05:45 (pid:119569) IWD: /local/condor/execute/dir_119569\n12/30/19 09:05:45 (pid:119569) Output file: streaming to remote file /home/geraint.pratten/O3/S190814bv/C01/IMRPhenomPv2/mcmc/outdir/log/lalinference-72832235-0-.out\n12/30/19 09:05:45 (pid:119569) Error file: streaming to remote file /home/geraint.pratten/O3/S190814bv/C01/IMRPhenomPv2/mcmc/outdir/log/lalinference-72832235-0-.err\n12/30/19 09:05:45 (pid:119569) Renice expr \"0\" evaluated to 0\n12/30/19 09:05:45 (pid:119569) Running job as user geraint.pratten\n12/30/19 09:05:45 (pid:119569) Using wrapper /etc/condor/modules/user-job-wrapper to exec /home/charlie.hoy/.conda/envs/lalinference-1.11.5-py36-co1-pe/bin/lalinference_mpi_wrapper --checkpoint-exit-code 77 --fref 20 --approx IMRPhenomPv2pseudoFourPN --amporder 0 --neff 1000 --nlive 512 --tolerance 0.1 --ntemps 10 --resume --adapt-temps --progress --spcal-nodes 10 --enable-spline-calibration --H1-spcal-envelope /home/charlie.hoy/projects/O3/S190814bv/C01/calibration_envelopes/2019-11-01_O3_LHO_GPSTime_1249847856_C01_RelativeResponseUncertainty_FinalResults.txt --L1-spcal-envelope /home/charlie.hoy/projects/O3/S190814bv/C01/calibration_envelopes/2019-11-01_O3_LLO_GPSTime_1249851456_C01_RelativeResponseUncertainty_FinalResults.txt --V1-spcal-envelope /home/cbc/pe/O3/calibrationenvelopes/Virgo/V_earlyO3_calibrationUncertaintyEnvelope_magnitude5percent_phase2degrees10microseconds.txt --distance-max 1000 --q-min 0.02 --srate 2048.0 --seglen 16.0 --comp-min 1.0 --comp-max 60.0 --H1-psd /home/charlie.hoy/projects/O3/S190814bv/C01/psds/H1/C01_H1_16_S190814bv/trigtime_1249852257.009999990_0.0_0.0_0/post/clean/glitch_median_PSD_forLI_H1.dat --L1-psd /home/charlie.hoy/projects/O3/S190814bv/C01/psds/L1/C01_L1_16_S190814bv/trigtime_1249852257.009999990_0.0_0.0_0/post/clean/glitch_median_PSD_forLI_L1.dat --V1-psd /home/charlie.hoy/projects/O3/S190814bv/C01/psds/V1/C01_V1_16_S190814bv/trigtime_1249852257.009999990_0.0_0.0_0/post/clean/glitch_median_PSD_forLI_V1.dat --mpirun /ldcg/intel/2018u3/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin/mpirun --np 10 --executable /home/charlie.hoy/.conda/envs/lalinference-1.11.5-py36-co1-pe/bin/lalinference_mcmc --trigtime 1249852257.0133343 --randomseed 2070164300 --trigger-snr 22.15068163076504 --outfile ./lalinferencemcmc-347292-H1L1V1-1249852257.0133343-39.hdf5 --H1-cache ./H-H1_HOFT_C01_CACHE-1249851715-561.lcf --H1-channel H1:DCS-CALIB_STRAIN_CLEAN_C01 --H1-flow 20.0 --H1-fhigh 972.8 --H1-timeslide 0 --L1-cache ./L-L1_HOFT_C01_CACHE-1249851715-561.lcf --L1-channel L1:DCS-CALIB_STRAIN_CLEAN_C01 --L1-flow 30.0 --L1-fhigh 972.8 --L1-timeslide 0 --V1-cache ./V-V1Online_CACHE-1249851715-561.lcf --V1-channel V1:Hrec_hoft_16384Hz --V1-flow 20.0 --V1-fhigh 972.8 --V1-timeslide 0 --psdstart 1249851731.0133343 --psdlength 496.0 --dont-dump-extras --ifo H1 --ifo L1 --ifo V1\n12/30/19 09:05:45 (pid:119569) Create_Process succeeded, pid=259435\n12/30/19 09:05:45 (pid:119569) Limiting (soft) memory usage to 0 bytes\n12/30/19 09:05:45 (pid:119569) Limiting memsw usage to 9223372036854775807 bytes\n12/30/19 09:05:45 (pid:119569) Limiting (soft) memory usage to 42010148864 bytes\n12/30/19 09:05:45 (pid:119569) Limiting (hard) memory usage to 381477457920 bytes\n12/30/19 09:05:45 (pid:119569) Limiting memsw usage to 381477462016 bytes\n12/30/19 09:05:45 (pid:119569) unhandled job exit: pid=254532, status=19712\n12/30/19 10:06:55 (pid:119569) Process exited, pid=259435, status=77\n\nAnd now that I am ready to give up on peaceful, a subsequent \"condor-off -startd -graceful\" is ineffective. It is received by Master, but nothing is recorded by the startd, which continues to process jobs,\n\n==&gt; MasterLog &lt;==\n12/30/19 10:24:19 Handling daemon-specific command for \"STARTD\"\n12/30/19 10:24:19 Sent SIGTERM to STARTD (pid 5576)\n\n==&gt; StartLog &lt;==\n\n12/27/19 10:23:48 slot1_7: Changing state and activity: Claimed/Busy -&gt; Preempting/Vacating\n12/27/19 10:23:48 Starter pid 509 exited with status 0\n12/27/19 10:23:48 slot1_7: State change: starter exited\n12/27/19 10:23:48 slot1_7: State change: No preempting claim, returning to owner\n12/27/19 10:23:48 slot1_7: Changing state and activity: Preempting/Vacating -&gt; Owner/Idle\n12/27/19 10:23:48 slot1_7: State change: IS_OWNER is false\n12/27/19 10:23:48 slot1_7: Changing state: Owner -&gt; Unclaimed\n12/27/19 10:23:48 slot1_7: Changing state: Unclaimed -&gt; Delete\n12/27/19 10:23:48 slot1_7: Resource no longer needed, deleting\n12/27/19 10:24:35 Unable to calculate keyboard/mouse idle time due to them both being USB or not present, assuming infini\nte idle time for these devices.\n12/27/19 10:27:57 slot1_4: New machine resource of type -1 allocated\n12/27/19 10:27:57 Setting up slot pairings\n12/27/19 10:27:57 slot1_4: Error evaluating machine rank expression: RequestGpus &gt; 0\n12/27/19 10:27:57 slot1_4: Setting RANK to 0.0\n12/27/19 10:27:57 slot1_4: Request accepted.\n12/27/19 10:27:57 slot1_4: Remote owner is chiwai.chan at ligo\n\n\nI then remembered the -force-graceful option. However, I can't remember why when graceful-after-peacful was first supported why another condor_off argument was needed at all--why not have have -graceful simply do the \"right thing\"?\n\n\n[root at condor ~]# condor_off -force-graceful -startd cascade1\nSent \"Set-Force-Shutdown\" command to startd cascade1.ldas.cit\nSent \"Kill-Daemon\" command for \"startd\" to master cascade1.ldas.cit\n\n==&gt; MasterLog &lt;==\n12/30/19 10:46:31 Handling daemon-specific command for \"STARTD\"\n12/30/19 10:54:19 Timeout for graceful shutdown has expired for STARTD.\n12/30/19 10:54:19 Sent SIGQUIT to STARTD (pid 5576)\n12/30/19 10:54:24 DefaultReaper unexpectedly called on pid 5576, status 0.\n12/30/19 10:54:24 The STARTD (pid 5576) exited with status 0\n\n\n==&gt; StartLog &lt;==\n12/30/19 10:54:19 Got SIGQUIT.  Performing fast shutdown.\n12/30/19 10:54:19 shutdown fast\n...\n12/30/19 10:54:24 All resources are free, exiting.\n12/30/19 10:54:24 **** condor_startd (condor_STARTD) pid 5576 EXITING WITH STATUS 0\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Jan-21 09:53:05 by tim:</em> <br/>\n\nAlternately, you could use condor_drain with a command-line option to determine what the machine does after drained. Tell it to stay in drained state after fully drained. ToddT prefers this because: 1) fast and easy, obvious when command has succeeded; 2) you can cancel condor_drain, which you cannot do with condor_off -peaceful\n\n<p></p><hr/>\n<em>2020-Jan-21 09:53:40 by tim:</em> <br/>\n\nStuart agrees to stop running condor_off -peaceful and switch to condor_drain</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "incident", "last_change": "2020-Jan-21 09:55", "status": "new", "created": "2020-Jan-21 09:49", "fixed_version": "2020-Jan-21 09:49", "broken_version": "v080807", "priority": "4", "subsystem": "", "assigned_to": "", "derived_from": "", "creator": "tim", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "sba@caltech.edu", "due_date": ""}