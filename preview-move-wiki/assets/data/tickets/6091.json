{"id": 6091, "title": "Ticket #6091: DAGMan cannot submit jobs with AFS / Kerberos support enabled", "description": "<blockquote>\nWith HTCondor configured to use the AFS / Kerberos support added in v8.5 for CERN: when DAGMan invokes condor_submit to submit jobs in a workflow, it invokes SEC_CREDENTIAL_PRODUCER, which then fails do to lack of tickets.\n\n<p>The root of the problem is the condor_starter sets up the environment correctly with <code>KRB5CCNAME</code> and friends, but with scheduler universe there is no starter, and thus the SEC_CREDENTIAL_PRODUCER callout fails.\n\n</p><p>The patch presented in this ticket avoids the problem by simply telling any condor_submits that occur as part of a scheduler universe job to <em>not</em> run the SEC_CREDENTIAL_PRODUCER in the first place if the scheduler universe job classad has attribute <code>SendCredential</code> equal to True. The thinking here is if <code>SendCredential</code> is True in the scheduler universe job classad, then a credential for that user was already stored on submit machine when the scheduler universe job was submitted (i.e. when the user ran condor_submit_dag), and thus having DAGMan attempt to produce a store a credential at every condor_submit is an unnecessary waste of time/resources. The implementation has such scheduler universe jobs run with an environment variable setting SEC_CREDENTIAL_PRODUCER to \"CREDENTIAL_ALREADY_STORED\", which tells the condor_submit to NOT invoke the credential producer but to act as if it did (i.e. still set <code>SendCredential</code> to True in the job).</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Jan-18 11:39:39 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-18 10:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/68af0b741f8e96ccf97b9897584ea34362a3682b\">[50005]</a></span>: Fix compilation error in previous commit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6091\" onclick=\"get_ticket_and_populate_wrapper('6091'); return false;\" title=\"DAGMan cannot submit jobs with AFS / Kerberos support enabled\">#6091</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-18 07:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8603cf46ec65008569e9b943d8b810a2d3f1208a\">[50003]</a></span>: condor_submits under DAGMan should bypass SEC_CREDENTIAL_PRODUCER. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6091\" onclick=\"get_ticket_and_populate_wrapper('6091'); return false;\" title=\"DAGMan cannot submit jobs with AFS / Kerberos support enabled\">#6091</a></span> If the scheduler universe job ad has ATTR_JOB_SEND_CREDENTIAL=True, then we assume a credential for this user has been stored in the credd when the scheduler universe job was submitted.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-18 07:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9413db35efea6193faecdb75b1a7560b6d9c9370\">[50002]</a></span>: Implement CREDENTIAL_ALREADY_STORED option to SEC_CREDENTIAL_PRODUCER. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6091\" onclick=\"get_ticket_and_populate_wrapper('6091'); return false;\" title=\"DAGMan cannot submit jobs with AFS / Kerberos support enabled\">#6091</a></span> If SEC_CREDENTIAL_PRODUCER is set to magic value CREDENTIAL_ALREADY_STORED, this means that condor_submit should NOT bother spending time to send the credential to the credd (because it is already there), but it SHOULD do all\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-24 16:03", "status": "resolved", "created": "2017-Jan-18 07:05", "fixed_version": "2017-Jan-18 07:05", "broken_version": "v080507", "priority": "2", "subsystem": "Security", "assigned_to": "tannenba", "derived_from": "#5272", "creator": "tannenba", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "ben.dylan.jones@cern.ch, florentia.protopsalti@cern.ch, tannenba@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}