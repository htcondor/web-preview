{"id": 6972, "title": "Ticket #6972: Add x509 proxy support with late materialized jobs", "description": "<blockquote>\nLate materialization doesn't work with jobs requiring x509 proxies at present.\n\n<p>Some details:\nAccording to the logs, the factory fails with:\nReason = \"failed to create <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> for Job 1532.0 : Submit:-1:unable to read proxy file.\n\n</p><p>Changing proxy permissions to 666 bypasses that issue, but all x509 related classads that are automatically filled on the client-side are not created (x509UserProxyFirstFQAN, x509userproxysubject, etc) and defining them by hand via e.g.: +x509userproxysubject doesn't work.\n\n</p><p>According to TJ, the code that fills these classads in the Schedd is skipped for late materialization at the moment.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Mar-29 20:23:30 by bbockelm:</em> <br/>\n\nKeny, what happens when you fill in <code>+x509userproxysubject</code> by hand?\n\n<p></p><hr/>\n<em>2019-Mar-29 22:41:20 by khurtado:</em> <br/>\n\nHi Brian,\n\n<p>Attempts to set +x509userproxysubject by hand are ignored, as opposed to random variables. In other words, +A = value set the classad as expected, but requests for appending +x509userproxysubject (or any of+x509UserProxyEmail, +x509UserProxyFirstFQAN, +x509UserProxyVOName, +x509UserProxyFQAN ) are simply ignored.\n\n</p><p>Considering a minimal modification to the string like +x509userproxysubject2 does work, I assume there is some sort of protection mechanism in condor against those classads, (probably due to the issues allowing setting or editing x509userproxysubject would imply in terms of security while mapping grid jobs to users based on the subject?)\n\n</p><p></p><hr/>\n<em>2019-Apr-01 09:59:16 by johnkn:</em> <br/>\n\n<code>x509userproxysubject</code> is a secure attribute and cannot be set by the job. Only the Schedd can set it. The Schedd does not do this for late materialization jobs at present.\n\n<p>The current code in the Schedd skips setting the proxy subject, and other proxy attributes when there is no external socket during commit, and it will not set these attributes into the cluster classad.  Late materialization has no external connection when materializing the proc ads - so the x509 proxy code in the Schedd gets skipped.\n\n</p><p></p><hr/>\n<em>2019-Apr-04 04:52:15 by bbockelm:</em> <br/>\n\nWe control the schedd configuration, correct?  We should be able to set:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">SYSTEM_SECURE_JOB_ATTRS=\n</pre></div>\n\n\n<p>and continue the testing.\n\n</p><p></p><hr/>\n<em>2019-Apr-04 08:45:03 by khurtado:</em> <br/>\n\nHi Brian,\n\n<p>Thanks! I didn't know that knob. So, if I set:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">use_x509userproxy = False\nSYSTEM_SECURE_JOB_ATTRS =\n</pre></div>\n\n\n<p>in the schedd and pass the proxy with:\n</p><div class=\"code\">\n<pre class=\"code\">+x509userproxy = /tmp/x509up_u...\n</pre></div>\n\ninstead of\n<div class=\"code\">\n<pre class=\"code\">x509userproxy = /tmp/x509up_u...\n</pre></div>\n\n\n<p>so that the factory doesn't attempt to read the proxy file but just passes the classad (plus all the other x509 classads (+x509userproxysubject, +x509UserProxyVOName, +x509UserProxyFirstFQAN, etc)), then things work fine even without doing chmod 666 or 644 to the proxy anymore.\n\n</p><p>I will go with that workaround until the relevant changes are eventually implemented in condor. Thanks for the help!\n\n</p><p></p><hr/>\n<em>2019-Apr-12 13:43:06 by jfrey:</em> <br/>\n\nI've pushed code to fix this in 8.9.\n\n<p></p><hr/>\n<em>2019-Apr-14 13:52:07 by khurtado:</em> <br/>\n\nAwesome! Thanks! Just to have an idea of when this will be included in a dev release, will this be eventually on v8.9.1 or v8.9.2?\n\n<p></p><hr/>\n<em>2019-Apr-15 11:47:56 by jfrey:</em> <br/>\n\nThe changes will be in v8.9.2.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-16 07:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56898\">[56898]</a></span>: Docs for job materialization with x509 proxies. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6972\" onclick=\"get_ticket_and_populate_wrapper('6972'); return false;\" title=\"Add x509 proxy support with late materialized jobs\">#6972</a></span> Committer: Tim Theisen  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-15 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56892\">[56892]</a></span>: Docs for job materialization with x509 proxies. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6972\" onclick=\"get_ticket_and_populate_wrapper('6972'); return false;\" title=\"Add x509 proxy support with late materialized jobs\">#6972</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-09 12:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56828\">[56828]</a></span>: Move Q_SOCK NULL check closer to usage of Q_SOCK. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6972\" onclick=\"get_ticket_and_populate_wrapper('6972'); return false;\" title=\"Add x509 proxy support with late materialized jobs\">#6972</a></span> We want the outer block to run for late materialization.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-12 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56608\">[56608]</a></span>: Disable proxy checking in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SubmitHash\" title=\"Submit Hash\">SubmitHash</a></span> during late materialization. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6972\" onclick=\"get_ticket_and_populate_wrapper('6972'); return false;\" title=\"Add x509 proxy support with late materialized jobs\">#6972</a></span> The check wasn't being done as the correct owner, and the schedd doesn't otherwise care about expired job credentials.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-12 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56607\">[56607]</a></span>: Fix setting of x509 job attributes for late materialization. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6972\" onclick=\"get_ticket_and_populate_wrapper('6972'); return false;\" title=\"Add x509 proxy support with late materialized jobs\">#6972</a></span> Secure x509 job attributes are now set in the cluster ad. If a proc ad has a different proxy file, then the attributes are updated there. Updating in the proc ad happens during late materialization as well as at initial submit time.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-12 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56606\">[56606]</a></span>: Add GetAttributeString() variant that uses std::string. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6972\" onclick=\"get_ticket_and_populate_wrapper('6972'); return false;\" title=\"Add x509 proxy support with late materialized jobs\">#6972</a></span>  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-May-15 14:34", "status": "resolved", "created": "2019-Mar-29 14:23", "fixed_version": "2019-Mar-29 14:23", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#6166", "creator": "khurtado", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "khurtado@nd.edu", "due_date": ""}