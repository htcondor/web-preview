{"id": 1019, "title": "Ticket #1019: ssl and voms interaction breaks some uses of GSI authentication", "description": "<blockquote>\njaime has been working on this and discovered much evilness in VOMS and how we link it.  i'll let him comment on that.</blockquote>", "remarks": "<blockquote>\n<em>2009-Dec-02 23:38:43 by jfrey:</em> <br/>\n\nAs noted in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=992\" onclick=\"get_ticket_and_populate_wrapper('992'); return false;\" title=\"problems with GSI in 7.4.0\">#992</a></span>, a patch I made to VOMS to delay a static initializer until the first use of VOMS (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span>) caused GSI authentication to fail after the first authentication attempt. Tracking and down fixing the problem has been a string of problems that is hopefully at an end now.\n\n<p>The static initializer  modified in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span> (<code>Initializer::Initializer()</code> in <code>src/api/ccapi/voms_api.cc</code>) makes a number of changes in openssl, including registering several proxy-related OIDs and registering callbacks for thread-locking. All of this code is omitted if the macro NOGLOBUS is defined. Thus, the code is only meant to be included in the flavor of VOMS that assumes no GSI libraries will be present (GSI makes same equivalent calls into openssl).\n\n</p><p>In Condor, we were using the no-GSI flavor of VOMS (called <code>nog</code>). The VOMS and GSI initializing calls into openssl seemed to stepping on each other if the VOMS ones occurred second. The best solution was to switch VOMS flavors to the appropriate GSI one and thus eliminate the VOMS calls into openssl. But the openssl initializing code in VOMS was still being called. I then found that in the version of VOMS we were using (1.8.9, roughly), NOGLOBUS was defined at the top of <code>voms_api.cc</code>, so the initializing code was called in all flavors.\n\n</p><p>I noticed that the in version of VOMS used in the VDT (1.8.8_2), the openssl initializing calls are absent from the GSI flavors of the library. I found the source and confirmed that <code>voms_api.cc</code> had no definition of NOGLOBUS. Instead, NOGLOBUS is defined on the compile line when building just the <code>nog</code> flavor.\n\n</p><p>I tried building Condor against version 1.8.8_2 of VOMS and ran into conflicting symbols. VOMS includes a copy of the oldgaa library from GSI, with slightly modified behavior but the same function names. When dynamically linking VOMS and GSI, the linker can apparently sort things out. But static linking fails miserably. Due to formatting differences between the two versions of oldgaa, it's difficult to determine how they differ in functionality. So rather than change VOMS to use the GSI version of oldgaa, I renamed all of the functions in the VOMS version, so that both versions could coexist.\n\n</p><p>During testing, Zach and I discovered that the two oldgaas differ in how they treat Email/emailAddress fields in an X509 DN string. The GSI version will convert 'Email' to 'emailAddress', while the VOMS version won't.\n\n</p><p>After a few other minor changes, VOMS 1.8.8_2 appears to work when linked with Condor.\n\n</p><p></p><hr/>\n<em>2009-Dec-03 15:00:18 by jfrey:</em> <br/>\n\nI just pushed a commit to V7_4-branch for 7.4.1 with the following changes:\n<ul>\n<li>Switch the VOMS external to 1.8.8_2 (used by the VDT)\n</li><li>Use the appropriate Globus flavor of the VOMS library, rather than the <code>nog</code> flavor.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Dec-03 14:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a7740a14ba8923db1d25e46b1ec13c5be3ac3523\">[16480]</a></span>: Change VOMS external to version 1.8.8_2. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1019\" onclick=\"get_ticket_and_populate_wrapper('1019'); return false;\" title=\"ssl and voms interaction breaks some uses of GSI authentication\">#1019</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=992\" onclick=\"get_ticket_and_populate_wrapper('992'); return false;\" title=\"problems with GSI in 7.4.0\">#992</a></span> This is the version used by the VDT. This version doesn't have the memory bloat that <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span> attempted to fix. It also doesn't have the GSI authentication problem introduced by <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=786\" onclick=\"get_ticket_and_populate_wrapper('786'); return false;\" title=\"VOMS static initializer allocates memory even when VOMS not used\">#786</a></span>, which is detailed in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=992\" onclick=\"get_ticket_and_populate_wrapper('992'); return false;\" title=\"problems with GSI in 7.4.0\">#992</a></span>.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-17 13:40", "status": "resolved", "created": "2009-Dec-02 17:36", "fixed_version": "2009-Dec-02 17:36", "broken_version": "v070400", "priority": "2", "subsystem": "Security", "assigned_to": "jfrey", "derived_from": "#992", "creator": "jfrey", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "zmiller@cs.wisc.edu,dan@hep.wisc.edu,tannenba@cs.wisc.edu", "due_date": ""}