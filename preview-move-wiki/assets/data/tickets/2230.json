{"id": 2230, "title": "Ticket #2230: negotiating groups with no submitters", "description": "<blockquote>\nArtifact of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2054\" onclick=\"get_ticket_and_populate_wrapper('2054'); return false;\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2194\" onclick=\"get_ticket_and_populate_wrapper('2194'); return false;\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span> when using round robin that leads to entering negotiateWithGroup with no submitters attached to the group.\n\n<p></p><div class=\"verbatim\">\n<pre>06/07/11 21:20:38 Group &lt;removed&gt; - BEGIN NEGOTIATION\n06/07/11 21:20:38 Phase 3:  Sorting submitter ads by priority ...\n06/07/11 21:20:38 Phase 4.1:  Negotiating with schedds ...\n06/07/11 21:20:38     numSlots = 365\n06/07/11 21:20:38     slotWeightTotal = 365.000000\n06/07/11 21:20:38     pieLeft = 0.000\n06/07/11 21:20:38     NormalFactor = 0.000000\n06/07/11 21:20:38     MaxPrioValue = 0.000000\n06/07/11 21:20:38     NumSubmitterAds = 0\n06/07/11 21:20:38  resources used by  are 0.000000\n06/07/11 21:20:38  resources used scheddused 0.000000 groupUsed 0.000000\n06/07/11 21:20:38  negotiateWithGroup resources used scheddAds length 0\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Jun-15 17:52:55 by eje:</em> <br/>\n\nNote -- I don't think this is related to <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2054\" onclick=\"get_ticket_and_populate_wrapper('2054'); return false;\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span> (which does not remove submitters, only halts negotiation).\n\n<p>It appears to happen due to an interaction of (1) the fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2194\" onclick=\"get_ticket_and_populate_wrapper('2194'); return false;\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span>, (2) round-robin, and (3) update latency for submitter ads on the collector (another argument for grabbing submitters directly from schedds).\n\n</p><p>For simplicity, assume a single group \"a\" and a single submitter \"a.u1\", and RR rate = 1.\n\n</p><p>The repro scenario is:  \"a.u1\" has &gt;= 2 jobs that are running.  Then, all its jobs complete: the accountant gets updated, but the collector does not.  It enters negotiation.   The negotiator grabs (running+idle) from the collector, sees this value is &gt; 0 (in fact, &gt;=2), so it allocates some quota for \"a\".  But the usage comes from accountant, which is zero (why? because its values are more current than the collector!), so it concludes it needs to negotiate.  It then goes into 1st RR iteration, but discovers \"a.u1\" has no idle jobs, so it removes \"a.u1\".   This leaves group \"a\" with no submitters, but now it's got more RR iterations.  And on all subsequent RR iterations, it's entering negotiateWithGroup with zero submitters for \"a\".\n\n</p><p></p><hr/>\n<em>2011-Jun-15 18:06:07 by eje:</em> <br/>\n\nTest/Repro:\n\n<p>Using configuration:\n</p><div class=\"code\">\n<pre class=\"code\">CLAIM_WORKLIFE = 0\nNEGOTIATOR_CONSIDER_PREEMPTION = FALSE\nNEGOTIATOR_DEBUG = D_FULLDEBUG\n\nNEGOTIATOR_INTERVAL = 30\nSCHEDD_INTERVAL = 15\n\nNUM_CPUS = 10\n\nGROUP_NAMES = a, b\nGROUP_QUOTA_a = 5\nGROUP_QUOTA_b = 5\n\nGROUP_QUOTA_ROUND_ROBIN_RATE = 1\n</pre></div>\n\n\n<p>Spool up the test pool, and then follow along on negotiator log:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e 'RR iter' -e 'skipping, no sub' -e 'Filtering.*no idle jobs'\n</pre></div>\n\n\n<p>Submit this job:\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 20\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.u1\"\nqueue 2\n</pre></div>\n\n\n<p>After the fix, you should first see it go through 2 RR iterations.  Then, after the job completes, you see \"a.u1\" removed on first RR iteration, followed by it skipping the subsequent iteration.  Note, it may occasionally get correct up-to-date values from the collector, in which case the fix will not execute, so if you do not see the behavior after job completes, try again.\n</p><div class=\"code\">\n<pre class=\"code\">[root@rorschach log]$ tail -f NegotiatorLog | grep -e 'RR iter' -e 'skipping, no sub' -e 'Filtering.*no idle jobs'\n# First negotiation (two RR iterations)\n06/15/11 15:24:58 group quotas: entering RR iteration n= 1\n06/15/11 15:24:59 group quotas: entering RR iteration n= 2\n# ...\n# After job completes, you see this:\n06/15/11 15:25:29 group quotas: entering RR iteration n= 1\n06/15/11 15:25:29 Filtering submitter a.u1@localdomain with no idle jobs\n06/15/11 15:25:29 group quotas: entering RR iteration n= 2\n06/15/11 15:25:29 Group a - skipping, no submitters (usage=0)\n</pre></div>\n\n\n<p>Before the fix, you should see two RR iterations on job completion (no skipping message) (unless the collector got lucky and had up-to-date values)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/371/nosubmitads.patch\">nosubmitads.patch</a>\n1434 bytes added by jrt on 2011-Jun-13 18:53:13 UTC.\n<br/>\npatch to skip when no submitters<br/>\n</li><li><a href=\"../files/377/gt2230_no_submit_ads.patch2\">gt2230_no_submit_ads.patch2</a>\n897 bytes added by eje on 2011-Jun-15 23:18:46 UTC.\n<br/>\nTweaked patch to apply clean upstream.\n<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-28 09:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4a3266bcbae1e3980fc0f41044c8cf25ae72f93\">[22305]</a></span>: === GT <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2230\" onclick=\"get_ticket_and_populate_wrapper('2230'); return false;\" title=\"negotiating groups with no submitters\">#2230</a></span> === Patch created by jrt cleaned by eje Fix: negotiating groups with no submitters Artifact of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2054\" onclick=\"get_ticket_and_populate_wrapper('2054'); return false;\" title='hfs looping on \"group quota exceeded\"'>#2054</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2194\" onclick=\"get_ticket_and_populate_wrapper('2194'); return false;\" title='Filter \"no idle jobs\" submitters prior to phase 4.1'>#2194</a></span> when using round robin that leads to entering negotiateWithGroup with no submitters attached to the group.  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jul-19 13:48", "status": "resolved", "created": "2011-Jun-13 13:52", "fixed_version": "2011-Jun-13 13:52", "broken_version": "v070600", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "#2194", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com, eje@redhat.com", "due_date": ""}