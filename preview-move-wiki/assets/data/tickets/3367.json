{"id": 3367, "title": "Ticket #3367: Condor thinks VMs in OpenStack's \"SHUTOFF\" state are running", "description": "<blockquote>\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> has VM states in addition to the Amazon EC2 states.  One of them is a \"SHUTOFF\" state.  The VMs are still in the system and can be restarted, but they are not running.  Condor thinks VMs in this state are running when in reality they are not (condor_q reports them running).\n\n<p>Per Jaime:\nShould be easy to fix. The tricky part is what should Condor do?\nTwo options spring to mind:\n\n</p><p>1) Consider the job complete, destroy the instance, and let the job leave the queue.\n\n</p><p>2) Mark the job as Idle with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GridJobStatus\" title=\"Grid Job Status\">GridJobStatus</a></span> set to SHUTOFF and let the user set <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRemove\" title=\"Periodic Remove\">PeriodicRemove</a></span> to destroy the instance if they want to.\n\n</p><p>For my use case in glideinWMS I'd choose 1), however, I could see where 2) would be preferable.</p></blockquote>", "remarks": "<blockquote>\nAfter discussion on 2013-01-11 (between JaimeF, TonyT, ToddT, and ToddM), we will immediately implement option (1), above, perhaps to be followed by representing a job in the SHUTOFF states with the Condor 'suspended' state, provided we can rejigger condor_resume to the do the right thing.\n\n<p></p><hr/>\n<em>2013-Jan-15 15:40:17 by tlmiller:</em> <br/>\n\nInterestingly enough, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> uses the same <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InstanceStateType\" title=\"Instance State Type\">InstanceStateType</a></span> code (number), 48, for 'shutoff' that Amazon uses for 'terminated'.  This will probably not end up mattering...\n\n<p></p><hr/>\n<em>2013-Jan-16 13:38:05 by tlmiller:</em> <br/>\n\nTested by setting EC2_VM_STATE_SHUTOFF to 'running'.  The state transitions happened properly, and the job status looks OK in condor_history.\n\n<p></p><hr/>\n<em>2013-Jan-16 13:51:01 by tlmiller:</em> <br/>\n\nI've asked Tony Tiradani if he can help test this patch.  I have access to an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> Essex service (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FutureGrid\" title=\"Future Grid\">FutureGrid</a></span>), but I don't know how to generate SHUTOFF instances.\n\n<p></p><hr/>\n<em>2013-Jan-30 16:05:44 by tlmiller:</em> <br/>\n\nTony writes (2012-01-30):\n\n<p>&gt; I can confirm that the shutoff state is handled correctly.  The shutoff state\n&gt; was detected and the EC2_VM_STOP command was sent.  (See the log snippet\n&gt; below.)  I confirmed with the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OpenStack\" title=\"Open Stack\">OpenStack</a></span> admins that the VM was terminated.\n\n</p><p></p><hr/>\n<em>2013-Jan-30 16:07:35 by tlmiller:</em> <br/>\n\nChanging state to 'stalled' until we decide if we want to mark 'SHUTOFF' jobs as suspended, instead.  Maybe that should be moved to another ticket and this one resolved, instead?\n\n<p></p><hr/>\n<em>2013-Feb-20 16:15:13 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>This code looks good.</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3471\" onclick=\"get_ticket_and_populate_wrapper('3471'); return false;\" title=\"[EC2] Handle OpenStack's SHUTOFF state by suspending the job.\">#3471</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n[EC2] Handle OpenStack's SHUTOFF state by suspending the job.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-19 11:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd287c10d7bae293c0ea2b9974cae0da04cce474\">[34966]</a></span>: edit 7.9.4 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3367\" onclick=\"get_ticket_and_populate_wrapper('3367'); return false;\" title=\"Condor thinks VMs in OpenStack's &quot;SHUTOFF&quot; state are running\">#3367</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-11 12:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/256c893dfef6e135f885e9d5105a17bcc7f550ad\">[34888]</a></span>: fix commit that broke the build of the manual ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3367\" onclick=\"get_ticket_and_populate_wrapper('3367'); return false;\" title=\"Condor thinks VMs in OpenStack's &quot;SHUTOFF&quot; state are running\">#3367</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-06 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ab84ef31c1c8a12501546a8f5da1d4e09ffdabef\">[34868]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3477\" onclick=\"get_ticket_and_populate_wrapper('3477'); return false;\" title=\"Keypairs of EC2 jobs may not be cleaned up.\">#3477</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3436\" onclick=\"get_ticket_and_populate_wrapper('3436'); return false;\" title=\"Batch status update requests for EC2 resources.\">#3436</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3367\" onclick=\"get_ticket_and_populate_wrapper('3367'); return false;\" title=\"Condor thinks VMs in OpenStack's &quot;SHUTOFF&quot; state are running\">#3367</a></span>) Document bug fixes and feature.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-16 13:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dc8acfb4b751baecd4aa7bab5c9a521e1f7d703f\">[34660]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3367\" onclick=\"get_ticket_and_populate_wrapper('3367'); return false;\" title=\"Condor thinks VMs in OpenStack's &quot;SHUTOFF&quot; state are running\">#3367</a></span>) Consider SHUTOFF jobs complete, terminate them, and let the job exit the queue.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Feb-21 13:03", "status": "resolved", "created": "2012-Dec-07 16:56", "fixed_version": "2012-Dec-07 16:56", "broken_version": "v070807", "priority": "1", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tiradani", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tiradani@fnal.gov", "due_date": "2013-02-01"}