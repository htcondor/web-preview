{"id": 6383, "title": "Ticket #6383: starter sticks in Preempting/Vacating with JOB_EXIT_HOOK and condor_rm", "description": "<blockquote>\nWhen an admin defines a JOB_EXIT_CODE in the starter, and a running job is condor_rm'd, the hook runs, but the starter stays running for up to 20 minutes, and the startd sticks in the Preempting/Vacating state.\n\n<p>In a normal job exit situation, the job exits, and the starter waits for a SIGQUIT from the startd.  In a condor_rm situation, the starter itself exits.  However with a JOB_EXIT_HOOK, the starter doesn't exit, and instead calls the job exit hook.  When the shadow deactivates the claim, the startd sends a second SIGTERM signal, which is ignored, as the first one was the trigger for the condor_rm.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Aug-23 15:20:55 by willsk:</em> <br/>\n\nFWIW, this appears to be reproducible in 8.4.x as well\n\n<p></p><hr/>\n<em>2017-Aug-23 15:28:43 by gthain:</em> <br/>\n\nFWIW, it has been in the code since the beginning of job hooks, as far as I can tell.\n\n<p></p><hr/>\n<em>2017-Sep-06 16:38:45 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Code patch looks good, putting ticket into docpending state as a version history entry is needed.\n\n</p><p></p><hr/>\n<em>2019-May-30 09:29:05 by jfrey:</em> <br/>\n\nThis bug fix introduced a new bug, also reported by Will Strecker-Kellogg (at HTCondor Week 2019). The starter now always exits after the JOB_EXIT hook is invoked. When the job exits normally and there's a shadow (i.e. not work fetch or local universe), the starter is expected to wait to be told to go away. If the shadow notices its connection to the starter close before it tells the start to deactivate the claim, it goes into reconnect mode. Its attempt to locate the starter fails and the job is requeued.\n\n<p>This new bug should not be a concern in versions 8.8.x and beyond, as the starter now always exits after a normal job termination (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6597\" onclick=\"get_ticket_and_populate_wrapper('6597'); return false;\" title=\"Slots can become stuck in Claimed/Busy forever after a job completes\">#6597</a></span>).</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-06 16:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52274\">[52274]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6383\" onclick=\"get_ticket_and_populate_wrapper('6383'); return false;\" title=\"starter sticks in Preempting/Vacating with JOB_EXIT_HOOK and condor_rm\">#6383</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-23 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52167\">[52167]</a></span>: Ensure the starter always exits after any JOB_EXIT_HOOK exits on condor_rm <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6383\" onclick=\"get_ticket_and_populate_wrapper('6383'); return false;\" title=\"starter sticks in Preempting/Vacating with JOB_EXIT_HOOK and condor_rm\">#6383</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-May-30 09:29", "status": "resolved", "created": "2017-Aug-23 15:19", "fixed_version": "2017-Aug-23 15:19", "broken_version": "v080600", "priority": "1", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "willsk@bnl.gov", "due_date": ""}