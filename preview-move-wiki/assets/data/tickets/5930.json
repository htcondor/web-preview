{"id": 5930, "title": "Ticket #5930: updateGSICred is blocking", "description": "<blockquote>\nWe noticed that a CERN HTCondor-CE was getting sluggish under heavy load.\n\n<p>It turns out that one of the remote schedds had decided to do a proxy re-delegation on thousands of jobs.  Proxy delegation is currently a blocking (and CPU-intensive!) activity; this meant the schedd was relatively unresponsive as it had to do round trips with the remote host.  The unresponsive schedd further meant the job router slowed down, periodically causing the job router to be restarted by the master.  The restarted job router than had even more work to send to the schedd, etc.\n\n</p><p>What saved our bacon in this case is the remote schedd was at least on the same continent.\n\n</p><p>Looking at the code: the call stack for proxy delegation (starting at <code>Schedd:updateGSICred</code>) is not particularly deep.  Further, there's only one round-trip: the schedd sends out a request, then waits for a response.  Finally, there's not a ton of state associated with updates.  It should be possible to make <code>updateGSICred</code> non-blocking.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Oct-04 07:08:13 by iain.steers:</em> <br/>\n\nCan we make sure this one of the three tickets (5930/1/2) makes 8.5.8?\n\n<p>We're seeing quite a bad impact on one of our CEs.\n\n</p><p></p><hr/>\n<em>2016-Oct-11 15:04:20 by jfrey:</em> <br/>\n\nDid you determine how much of the slow down was due to network latency vs CPU time generating the new key pairs? This patch doesn't help with the latter.\n\n<p></p><hr/>\n<em>2016-Oct-11 15:05:31 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>UpdateGSICredContinuation::m_job_owner can be leaked in most situations. I'll commit a fix.\n\n</p><p>Otherwise, this code looks ok.\n\n</p><p></p><hr/>\n<em>2016-Nov-04 19:03:28 by iain.steers:</em> <br/>\n\nBump to check status.\n\n<p>Will this be included in 8.5.8?\n\n</p><p></p><hr/>\n<em>2016-Nov-07 08:19:46 by jfrey:</em> <br/>\n\nYes, this will be in 8.5.8. You can check the 'Fixed Version' field of the ticket to see what release it will appear in.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-23 12:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49634\">[49634]</a></span>: Docs for updateGSICred() nonblocking in the schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5930\" onclick=\"get_ticket_and_populate_wrapper('5930'); return false;\" title=\"updateGSICred is blocking\">#5930</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-19 14:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49448\">[49448]</a></span>: Fix windows build for non-blocking updateGSICred(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5930\" onclick=\"get_ticket_and_populate_wrapper('5930'); return false;\" title=\"updateGSICred is blocking\">#5930</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-19 11:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49447\">[49447]</a></span>: Fix build errors on platforms without GSI. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5930\" onclick=\"get_ticket_and_populate_wrapper('5930'); return false;\" title=\"updateGSICred is blocking\">#5930</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-11 15:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49404\">[49404]</a></span>: Fix memory leak in UpdateGSICredContinuation. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5930\" onclick=\"get_ticket_and_populate_wrapper('5930'); return false;\" title=\"updateGSICred is blocking\">#5930</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Sep-30 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49359\">[49359]</a></span>: Make updateGSICred non-blocking in the schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5930\" onclick=\"get_ticket_and_populate_wrapper('5930'); return false;\" title=\"updateGSICred is blocking\">#5930</a></span> A large number of remote clients pushing new GSI proxies can result in a large amount of blocking - and an unresponsive schedd. Particularly, blocking on updateGSICred can cause other components that are sensitive to latency (such as the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobRouter\" title=\"Job Router\">JobRouter</a></span>)\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Nov-23 12:36", "status": "resolved", "created": "2016-Sep-29 12:53", "fixed_version": "2016-Sep-29 12:53", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "bbockelm@cse.unl.edu iain.steers@cern.ch", "due_date": ""}