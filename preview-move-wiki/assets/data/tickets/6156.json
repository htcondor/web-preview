{"id": 6156, "title": "Ticket #6156: Suppress DAGMan message about shared port", "description": "<blockquote>\nSeveral LIGO users have noted that DAGMan startup contains a scary-looking message about shared port being unavailable, for example:\n\n<p></p><pre>   02/15/17 07:45:14 SharedPortEndpoint: failed to open ./shared_port_ad: No such file or directory\n   02/15/17 07:45:14 SharedPortEndpoint: did not successfully find SharedPortServer address. Will retry in 60s.\n</pre>\n\n<p>This seems harmless.  It's due to the new <code>USE_SHARED_PORT</code> default and DAGMan not being able to use shared port.\n\n</p><p>Should be a one-line change to disable this setting for tools and condor_dagman; can it make it in time for 8.6.1?</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Feb-20 16:17:52 by tannenba:</em> <br/>\n\nAt first blush, I think it would be fine to add to the param table\n\n<p></p><pre>   DAGMAN.USE_SHARED_PORT=False\n</pre>\n\n<p>but I am not so sure we can simply set <code>USE_SHARED_PORT=False</code> for Tools.  Imagine running a tool like ssh_to_job or condor_fetchlog that needs to contact an execute machine behind a firewall via CCB; in this case, the reversed CCB connection may need to arrive via shared_port and the tool will need to know this.\n\n</p><p></p><hr/>\n<em>2017-Feb-20 16:23:55 by tannenba:</em> <br/>\n\nRandom thought -- does DAGMan need a command port at all on LINUX platforms?  If each running DAGMan uses a command port, that is unfortunate since there are only so many ports available.  Of course, on Windows, I think a command port is required since that is how DAGMan receives signals from the schedd....\n\n<p></p><hr/>\n<em>2017-Feb-20 16:47:43 by tlmiller:</em> <br/>\n\nDAGMan is started with <code>-p 0</code>, which the code says and Jaime empirically confirmed prevents the creation of a command socket.  However -- presumably to enable shared pot with CCB -- daemon core unconditionally initializes shared port in reconfig(), which is typically called during start-up.\n\n<p>Our brief testing and looking at the error message make us wonder if there's (also) a problem with DAGMan changing the LOG directory or something (why is the shared port endpoint looking in '.' for the shared_port_ad?), but it's probably the case -- we'd have to check the initializer code -- that just turning off shared port for dagman would work fine.\n\n</p><p>We should ask Kent if we want to continue/finish our investigation.\n\n</p><p></p><hr/>\n<em>2017-Feb-21 15:01:19 by jfrey:</em> <br/>\n\nIf you pass -port 0 on the command line, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> doesn't create a TCP/UDP command port. But it does try to create a shared port command port. This is a bug.\n\n<p>For DAGMan, the attempt to create a shared port command port is messed up by the \"-l .\" command line argument, which overrides the value of the LOG parameter. Thus, it can't find the shared_port_ad file and creates a daemon_sock directory under its current working directory.\n\n</p><p>If I create symlinks for shared_port_ad and daemon_sock in the current working directory to point to the real locations, then I can send commands to DAGMan by using an appropriate sinful string.\n\n</p><p>We can set DAGMAN_USE_SHARED_PORT=False in the param table to avoid these problems. I propose a more thorough fix whereby <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> doesn't create a shared port endpoint if -port 0 is passed on the command line (i.e. don't create a command port).\n\n</p><p></p><hr/>\n<em>2017-Feb-21 16:04:17 by wenger:</em> <br/>\n\nAnother alternative would be to have condor_submit_dag set _CONDOR_DAGMAN_USE_SHARED_PORT=0 in the environment in the .condor.sub file.\n\n<p>Either way, I guess I figure we should put in a simple fix for 8.6.1 to make sure this is fixed ASAP.\n\n</p><p></p><hr/>\n<em>2017-Feb-21 16:16:33 by wenger:</em> <br/>\n\nOkay, just talked to Jaime about this, and I'm going to add DAGMAN_USE_SHARED_PORT = false to the param table, and do a build/test to make sure that doesn't goof anything up.\n\n<p></p><hr/>\n<em>2017-Feb-23 09:55:18 by wenger:</em> <br/>\n\nHere's the diff:\n\n<p></p><pre>  manta(663)% git diff\n  diff --git a/src/condor_utils/param_info.in b/src/condor_utils/param_info.in\n  index 5a88b91..5b93435 100644\n  --- a/src/condor_utils/param_info.in\n  +++ b/src/condor_utils/param_info.in\n  @@ -741,6 +741,14 @@ customization=expert\n   tags=dagman,dagman_main\n   restart=never\n</pre>\n\n<p></p><pre>  +# Fixes gittrac #6156.\n  +[DAGMAN_USE_SHARED_PORT]\n  +default=false\n  +type=bool\n  +customization=never\n  +tags=dagman,dagman_main\n  +restart=never\n  +\n   [CKPT_SERVER_DIR]\n   default=\n   type=string\n  manta(664)%\n</pre>\n\n<p>I'm going to assign this to Jaime for review...\n\n</p><p></p><hr/>\n<em>2017-Feb-27 14:26:58 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/982/no_cmd_port.patch\">no_cmd_port.patch</a>\n2430 bytes added by jfrey on 2017-Feb-21 21:43:07 UTC.\n<br/>\nPatch to remember -port command line argument<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-23 17:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dcb71cc0552e836b38ad7adb6eaeffaa31c0c831\">[50195]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=6156\" onclick=\"get_ticket_and_populate_wrapper('6156'); return false;\" title=\"Suppress DAGMan message about shared port\">#6156</a></span>: Added version history and DAGMAN_USE_SHARED_PORT documentation; added note to param table.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-23 11:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/27b6bf51b113fd5dcc66d6d9700bd4e84b0033c1\">[50193]</a></span>: Don't use shared port in DAGMan. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=6156\" onclick=\"get_ticket_and_populate_wrapper('6156'); return false;\" title=\"Suppress DAGMan message about shared port\">#6156</a></span> DAGMan doesn't need to use shared port, and it's failure to initialize an endpoint results in scary-lookin messages in the daemon log.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-23 11:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e73f4736316f14eb513f5708f5bce0b0855d6795\">[50192]</a></span>: Don't make a shared port endpoint if no command port is requested. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=6156\" onclick=\"get_ticket_and_populate_wrapper('6156'); return false;\" title=\"Suppress DAGMan message about shared port\">#6156</a></span> Remeber the value of the -port command line argument in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span>. We need this for two purposes: * Don't create a shared port endpoint if the command port is disabled via -port 0. * If shared port is disabled while the daemon\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Feb-28 20:12", "status": "defer", "created": "2017-Feb-19 21:20", "fixed_version": "2017-Feb-19 21:20", "broken_version": "", "priority": "5", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "tlmiller@cs.wisc.edu tannenba@cs.wisc.edu jfrey@cs.wisc.edu wenger@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}