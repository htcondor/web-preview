{"id": 5158, "title": "Ticket #5158: Shadow launch queue woes.", "description": "<blockquote>\nWe've noticed the schedd has poor behavior when there is a long shadow launch queue.  We found some CMS schedds with 5k shadows waiting to launch in the schedd.\n\n<p>I think we should:\n</p><ol>\n<li>Not negotiate when there's more than 100 shadows left to launch.  For now, in CMS land, we've added (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalRunningJobs\" title=\"Total Running Jobs\">TotalRunningJobs</a></span> &gt; ShadowsRunning+500) to CURB_MATCHMAKING.\n</li><li>Advertise the number of unlaunched shadows in the schedd ad.\n</li><li>Consider allowing multiple shadow launches per duty-cycle (for busy schedds).  Similar to what we did for DCMessage, we should allow ourselves X milliseconds of shadow launching per duty-cycle (or JOB_START_COUNT, whichever hits first).\n</li><li>Oh - and the obvious one.  Have the schedd release claims if the # of pending shadows is over a certain limit.</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Aug-04 13:00:53 by tlmiller:</em> <br/>\n\nRegarding point 2: the schedd maintains a queue (called <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunnableJobQueue\" title=\"Runnable Job Queue\">RunnableJobQueue</a></span>) of jobs for which it must start a process but hasn't.  This queue includes all jobs requiring a shadow (vanilla, docker, vm, java, and standard universes), and all scheduler and local universe jobs.  This queue can become lengthy if the schedd or its host are overloaded, or if JOB_START_COUNT / JOB_START_DELAY are set too low for the workload.\n\n<p>Because each entry in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunnableJobQueue\" title=\"Runnable Job Queue\">RunnableJobQueue</a></span> delays each subsequent entry, we feel that advertising the size of this queue better-answers Brian's request for a count of pending shadows.  (It also makes it a one-line patch.)\n\n</p><p>Based on the names of the above config knobs, and its plain-English reading, ToddT proposes <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobStartsDelayed\" title=\"Num Job Starts Delayed\">NumJobStartsDelayed</a></span> as the name for this attribute, which is way better than my brain-dead default (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RunnableJobs\" title=\"Runnable Jobs\">RunnableJobs</a></span>).\n\n</p><p>Regarding point 1: when point 2 is implemented, point 1 could be supported via the policy expression CURB_MATCHMAKING.  The new subticket (<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5192\" onclick=\"get_ticket_and_populate_wrapper('5192'); return false;\" title=\"Sane defaults for CURB_MATCHMAKING\">#5192</a></span>) records our intention to figure out what a sane default for CURB_MATCHMAKING would be, as this seems a little cleaner than adding another knob to support point 1.\n\n</p><p>JaimeF, ToddT, and ToddM agree that points 3 and 4 should be punted to 8.5.x.  (This implies creating at least one new subticket.)\n\n</p><p>JaimeF and ToddM further propose, to help address point 4, to investigate advertising the number of startds that the schedd is currently in the process of claiming.  This attribute could also be used in CURB_MATCHMAKING to help limit the number of startds idled by this schedd's overload.\n\n</p><p></p><hr/>\n<em>2015-Aug-05 17:13:25 by tlmiller:</em> <br/>\n\nChanging target to v080308 after creating subtickets for the 8.5.x requests.  We should be able to get advertising <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobStartsDelayed\" title=\"Num Job Starts Delayed\">NumJobStartsDelayed</a></span> and whatever we call the other one (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PendingStartdClaims\" title=\"Pending Startd Claims\">PendingStartdClaims</a></span>?) in.\n\n<p></p><hr/>\n<em>2015-Aug-06 15:33:57 by tlmiller:</em> <br/>\n\nProposed: set the attribute \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumPendingClaims\" title=\"Num Pending Claims\">NumPendingClaims</a></span>\", the sum of the schedd variables startdContactQueue.Length() and num_pending_startd_contacts.  The former queue gains entries only in scheduler_handleMatch() and claimLocalStartd(); the latter tracks the number of startds-to-contact pulled out of the queue and contacted, but from whom we haven't heard back yet.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5192\" onclick=\"get_ticket_and_populate_wrapper('5192'); return false;\" title=\"Sane defaults for CURB_MATCHMAKING\">#5192</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSane defaults for CURB_MATCHMAKING</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5202\" onclick=\"get_ticket_and_populate_wrapper('5202'); return false;\" title=\"Consider allowing multiple shadow launches per duty-cycle.\">#5202</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nConsider allowing multiple shadow launches per duty-cycle.</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5203\" onclick=\"get_ticket_and_populate_wrapper('5203'); return false;\" title=\"Release claims if the # of pending shadows is too large.\">#5203</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRelease claims if the # of pending shadows is too large.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-25 12:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45666\">[45666]</a></span>: minor edit of 8.3.8 documentation of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5158\" onclick=\"get_ticket_and_populate_wrapper('5158'); return false;\" title=\"Shadow launch queue woes.\">#5158</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-24 16:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45662\">[45662]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5158\" onclick=\"get_ticket_and_populate_wrapper('5158'); return false;\" title=\"Shadow launch queue woes.\">#5158</a></span>) Version history, document new schedd ad attributes.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-06 15:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45500\">[45500]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5158\" onclick=\"get_ticket_and_populate_wrapper('5158'); return false;\" title=\"Shadow launch queue woes.\">#5158</a></span>) Advertise <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobStartsDelayed\" title=\"Num Job Starts Delayed\">NumJobStartsDelayed</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumPendingClaims\" title=\"Num Pending Claims\">NumPendingClaims</a></span>.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-06 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45498\">[45498]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5158\" onclick=\"get_ticket_and_populate_wrapper('5158'); return false;\" title=\"Shadow launch queue woes.\">#5158</a></span>) Advertise <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobStartsDelayed\" title=\"Num Job Starts Delayed\">NumJobStartsDelayed</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumPendingClaims\" title=\"Num Pending Claims\">NumPendingClaims</a></span>.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Aug-24 16:01", "status": "resolved", "created": "2015-Jul-16 12:01", "fixed_version": "2015-Jul-16 12:01", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "tlmiller", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tannenba@cs.wisc.edu, bbockelm@cse.unl.edu", "due_date": ""}