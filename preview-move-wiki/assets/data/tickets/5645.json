{"id": 5645, "title": "Ticket #5645: Schedd EXCEPTs on job proxy update", "description": "<blockquote>\nIn 8.5.0, we made the permissions on jobs' directories under spool more restrictive by default (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4896\" onclick=\"get_ticket_and_populate_wrapper('4896'); return false;\" title=\"Make spool permissions more restrictive\">#4896</a></span>). This broke the code in the schedd that accepts an updated proxy from a client. If the job's spool directory is chown'd between condor and the job owner (no longer done by default), the schedd needs to know which priv state to be in to write the proxy file. It does this by stat'ing the proxy file and looking at the ownership. With the restricted directory permissions, this will fail if the stat is done as the wrong user. The schedd doesn't notice the failure and EXCEPTs when it tries to use an uninitialized uid.\n\n<p>To fix, the schedd can stat the job's spool directory instead of the proxy file. Both should have the same ownership, and we know at this point in the code that the proxy file is in the spool directory.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Apr-22 13:43:47 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: All good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-26 20:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2ea58a6c8f4e1c42bc60d93c42f4ba7fe142a7ab\">[48305]</a></span>: Docs for schedd EXCEPT on job proxy update bugfix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5645\" onclick=\"get_ticket_and_populate_wrapper('5645'); return false;\" title=\"Schedd EXCEPTs on job proxy update\">#5645</a></span> Committer: Tim Theisen  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-26 20:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/303c0c2a45526c8c86761de40f572765d55794c4\">[48304]</a></span>: Fix proxy ownership check with restricted spool permissions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5645\" onclick=\"get_ticket_and_populate_wrapper('5645'); return false;\" title=\"Schedd EXCEPTs on job proxy update\">#5645</a></span> When writing an updated proxy file into the job's spool directory, the schedd's privilege state must match the ownership of the file. The schedd can't stat the file directly for its ownership, since the directory's permissions may forbid\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-21 13:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6a6711d22939d5437a8590c2a14f955f46ecd43\">[48268]</a></span>: Docs for schedd EXCEPT on job proxy update bugfix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5645\" onclick=\"get_ticket_and_populate_wrapper('5645'); return false;\" title=\"Schedd EXCEPTs on job proxy update\">#5645</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Apr-21 13:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/23b47a080567eca21a484a89c63c2bc0b9ec0434\">[48267]</a></span>: Fix proxy ownership check with restricted spool permissions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5645\" onclick=\"get_ticket_and_populate_wrapper('5645'); return false;\" title=\"Schedd EXCEPTs on job proxy update\">#5645</a></span> When writing an updated proxy file into the job's spool directory, the schedd's privilege state must match the ownership of the file. The schedd can't stat the file directly for its ownership, since the directory's permissions may forbid\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Apr-22 13:44", "status": "resolved", "created": "2016-Apr-21 11:24", "fixed_version": "2016-Apr-21 11:24", "broken_version": "v080500", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4896", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}