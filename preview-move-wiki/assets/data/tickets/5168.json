{"id": 5168, "title": "Ticket #5168: Increase rate of schedd job completion", "description": "<blockquote>\nWe have some schedds where the average job finish rate is greater than the duty cycle rate.  This results in an accumulation of jobs in 'C' state - more than 100k in one case.\n\n<p>As there are lots of unnecessary ads in the queue, queue scanning and hash table operations take longer - resulting in a longer duty cycle and more jobs in queue.\n\n</p><p>We should expose a knob to manage the number of completions done per duty cycle</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-28 08:02:55 by bbockelm:</em> <br/>\n\nJust to follow up -\n\n<p>This has been a complete lifesaver within CMS.  We found that our schedds could sustain a higher rate of \"real job completion\" (i.e., shadow finished the job) than they could sustain removing the proc from the queue.\n\n</p><p>We observed multiple cases over the past two weeks that were only solvable by this patch (or by having an operator log in and setting MAX_JOBS_RUNNING=0 and waiting until the issue has resolved).  On nodes with the patch applied, this issue has not returned.\n\n</p><p>I see no reason why someone would want to tune this knob; hence, I am not creating a param table entry.\n\n</p><p>Jaime, can you review?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jul-28 09:30:02 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>I'm hesitant to increase the default count-per-interval setting of job_is_finished_queue to 8 without additional changes. Several jobs that have spool directories with a large number of files could block the schedd for a prolonged period. I'd like to see the addition of a time-based limit or make spool directory cleanup less of a synchronous operation.\n\n</p><p></p><hr/>\n<em>2015-Jul-28 14:03:08 by bbockelm:</em> <br/>\n\nWhat about just waiting to merge until after <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5152\" onclick=\"get_ticket_and_populate_wrapper('5152'); return false;\" title=\"Perform spool removal out-of-process\">#5152</a></span>?\n\n<p></p><hr/>\n<em>2015-Jul-28 16:08:28 by jfrey:</em> <br/>\n\nThat depends on how <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5152\" onclick=\"get_ticket_and_populate_wrapper('5152'); return false;\" title=\"Perform spool removal out-of-process\">#5152</a></span> is implemented. If the schedd doesn't block waiting for the spool directory removal to finish, then sure.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-26 21:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45717\">[45717]</a></span>: fix typo in defn of new knob JOB_IS_FINISHED_COUNT <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5168\" onclick=\"get_ticket_and_populate_wrapper('5168'); return false;\" title=\"Increase rate of schedd job completion\">#5168</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-25 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45670\">[45670]</a></span>: Docs for new config knob JOB_IS_FINISHED_COUNT. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5168\" onclick=\"get_ticket_and_populate_wrapper('5168'); return false;\" title=\"Increase rate of schedd job completion\">#5168</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45468\">[45468]</a></span>: Reduce default for JOB_IS_FINISHED_COUNT to 1. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5168\" onclick=\"get_ticket_and_populate_wrapper('5168'); return false;\" title=\"Increase rate of schedd job completion\">#5168</a></span> This operation can be pretty heavy-weight if spooled jobs have a large number of files.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-21 12:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45372\">[45372]</a></span>: Expose a developer-only knob for managing job completion rate. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5168\" onclick=\"get_ticket_and_populate_wrapper('5168'); return false;\" title=\"Increase rate of schedd job completion\">#5168</a></span> This adds a new knob, JOB_IS_FINISHED_COUNT, which controls the number of finished jobs taken care of per DC. Not added to param table as it is expected to be developer-only.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Aug-25 14:40", "status": "resolved", "created": "2015-Jul-21 12:07", "fixed_version": "2015-Jul-21 12:07", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}