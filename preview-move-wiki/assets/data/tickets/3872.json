{"id": 3872, "title": "Ticket #3872: USE_PID_NAMESPACES cripples condor_ssh_to_job", "description": "<blockquote>\nIn email, gthain wrote:\n\n<p>\"<em>Unfortunately, it looks like the ssh_to_job runs in a separate pid namespace, which makes it not very useful... as pid namespaces nest, seems like the correct solution for us is to not just create a pid namespace for the job, but also for the starter, and run the sshd in the namespace of the starter.</em>\"</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Aug-26 13:28:12 by tannenba:</em> <br/>\n\nSo one idea on how to fix this is to take advantage of the nesting property of namespaces, so perhaps the startd starts the starter in a namespace, and then the starter starts in another nested space... but, is this going to cause problems for the procd? If the starter uses a procd started by the master or startd, the two will be using different pids to refer to the same process. We don't want to have a procd per starter, as this defeats the whole idea of having one procd for scalability reasons.  Perhaps if using cgroups + pid namespaces, a procd is no longer needed? (although all the cgroup implementation lives in the procd, yes?)\n\n<p>Another idea is having a new process join an existing namespace was recently added in the 3.8 linux kernel. The problem with going this route is it could be years until this kernel is in common production.\n\n</p><p></p><hr/>\n<em>2013-Aug-26 13:52:47 by bbockelm:</em> <br/>\n\nFrom discussion on IRC -\n\n<p>There's another issue with PID namespaces as it stands -- most user jobs are not ready to be PID 1.  There's a non-POSIX 'gotcha' for PID 1 in Linux; signals without signal handlers are ignored (only SIGKILL and SIGSTOP behave correctly).  From \"man 2 kill\":\n\n</p><p>NOTES\n       The only signals that can be sent to process ID 1, the init process, are those for which init has explicitly installed signal handlers.  This is done to assure the system is not brought down accidentally.\n\n</p><p>Useful for init -- not particularly useful for a job!\n\n</p><p>Gregggg proposed to have the condor_starter be PID 1 in the namespace.  In this case, we can install the appropriate signal handlers in the condor_starter to alleviate this problem and fix ssh_to_job at the same time.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2013-Aug-26 15:04:24 by bbockelm:</em> <br/>\n\nFurther thoughts -- no good solution though --\n\n<p>We could have a \"REGISTER_SELF\" command (assuming the forked starter does the registration; otherwise, maybe REGISTER_CHILD for Create_Process) with the procd which, using SCM_CREDENTIALS, would allow the procd to have an unambiguous view of which process should be registered; then, either:\n</p><ul>\n<li>Whenever DC interacts with the procd, it needs to translate this via lookup table, or\n</li><li>Whenever the procd receives a command from that process, it needs to map the response appropriately.\n</li></ul>\n\n<p>I <strong>think</strong> the first option would be the correct one if this approach is taken.  Not 100% sure this is the correct approach to take though.\n\n</p><p></p><hr/>\n<em>2013-Sep-06 16:11:36 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Changing this ticket back to active until the following issues are fixed:\n\n</p><p></p><ol>\n<li>Why was a stable series ticket resolved without first going into code review status?\n\n<p></p></li><li>Why was an entire copy of a .cpp file committed into the repo as .cpp.orig?  Was this on purpose?? (I doubt it)\n\n<p></p></li><li>The ticket pontificates a bunch of ways to fix this long term w/ pros/cons. Then there is a patch pushed into the code and the ticket resolved. Would be nice if either the ticket or commit message stated somewhere what the patch actually did (i.e. what solution was implemented??).  My guess is it simply makes sshd run in the global namespace instead of the job namespace, but I had to infer that by looking at the code.\n\n<p></p></li><li>There is no documentation changes.  We need a version history commit, and we perhaps need a small paragraph in the section of the manual that discusses pid names spaces about the impact of using pid namespaces + ssh to job together?\n</li></ol>\n\n<p></p><hr/>\n<em>2013-Sep-09 08:08:01 by gthain:</em> <br/>\n\nThis commit just implements the simple fix of not running the sshd in a private pid namespace, it uses the global pid (and filesystem) namespace.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-18 16:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/707637361a8503f93d367a47dad7183556d3f988\">[37656]</a></span>: edit of 8.0.3 version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3872\" onclick=\"get_ticket_and_populate_wrapper('3872'); return false;\" title=\"USE_PID_NAMESPACES cripples condor_ssh_to_job\">#3872</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-09 08:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9729a04d5447f0b02eaa00ba6ef0d48ddbf12401\">[37520]</a></span>: Document <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3872\" onclick=\"get_ticket_and_populate_wrapper('3872'); return false;\" title=\"USE_PID_NAMESPACES cripples condor_ssh_to_job\">#3872</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-06 14:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db5919a1f44dfe0b36eaaaeec5138b9a6b216554\">[37499]</a></span>: Remove accidentally added file in <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3872\" onclick=\"get_ticket_and_populate_wrapper('3872'); return false;\" title=\"USE_PID_NAMESPACES cripples condor_ssh_to_job\">#3872</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-06 14:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c4761e55ee1a2d97a533a4f1942a65439ce48b65\">[37498]</a></span>: Allow condor_ssh_to_job to see the job when USE_PID_NAMESPACES is true <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3872\" onclick=\"get_ticket_and_populate_wrapper('3872'); return false;\" title=\"USE_PID_NAMESPACES cripples condor_ssh_to_job\">#3872</a></span> This is the quick fix for stable. Perhaps in devel we should move the startd into the pid namespace.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Sep-09 14:15", "status": "defer", "created": "2013-Aug-26 12:06", "fixed_version": "2013-Aug-26 12:06", "broken_version": "v080002", "priority": "5", "subsystem": "DaemonsExecNode", "assigned_to": "tannenba", "derived_from": "", "creator": "pfc", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pfcouvar@syr.edu, anderson@ligo.caltech.edu, tannenba@cs.wisc.edu, bbockelm@cse.unl.edu, gthain@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}