{"id": 934, "title": "Ticket #934: POST scripts in DagMan not compatible with having the EventLog enabled", "description": "<blockquote>\nDAGMan runs in user space.  When it calls the log writing code to write an event for a POST script completing, the log writing code tries to write to the <span class=\"quote\">EventLog</span> if it is enabled.  Since the <span class=\"quote\">EventLog</span> is owned by the condor system, the DAGMan process does not have permission and this will always fail.\n\n<p>The unfortunate result is a problem of cascading failures.\n\n</p><p>1) if the <span class=\"quote\">EventLog</span> cannot be written to, the <span class=\"quote\">UserLog</span> is not written to either.  this must be fixed.  recommendation:  don't write PRE/POST events to the <span class=\"quote\">EventLog</span>\n\n</p><p>2) if DAGMan cannot write a POST event, it does not abort or retry, and essentially stalls while waiting for the (never-written) event to show up in the <span class=\"quote\">UserLog</span>.  recommendation: retry X times, then abort.\n\n</p><p>to reproduce:\n\n</p><p>1) enable the <span class=\"quote\">EventLog</span> for any given schedd\n\n</p><p>2) run a DAG that has a POST script</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Nov-12 14:04:12 by nleroy:</em> <br/>\n\nI propose the following:\n\n<p></p><ol>\n<li>Short Term:\n\n<p></p><ol>\n<li>Update <span class=\"quote\">DAGMan</span> to use <span class=\"quote\">WriteUserLog's ::setWriteGlobalLog() method</span>, passing false -- this will prevent writing of the global event log.\n</li></ol>\n\n<p></p></li><li>Long Term:\n\n<p></p><ol>\n<li>We've discussed creating a condor_logd, and I think that we should migrate all writes to the <span class=\"quote\">EventLog</span> to use this daemon (along with all daemon logs}\n</li></ol>\n</li></ol>\n\n<p><em>2009-Nov-12 14:16:03 by wenger:</em> <br/>\n\nHmm -- I'm just thinking that we should turn on the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> in one of the DAGMan tests.  And really, to make the test duplicate this problem, EVENT_LOG should point to something that DAGMan can't write to.  Since the tests run in a personal Condor, I guess that means the schedd couldn't write to it, either.  Which brings up another question:  what happens if EVENT_LOG points to a path that the daemons can't write to?  Is the answer documented anywhere?  There doesn't seem like there's much documentation about <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> in general.\n\n</p><p><em>2009-Nov-12 15:40:21 by wenger:</em> <br/>\n\nI'm in the process of fixing this on the DAGMan end.  Just a note, though, that I still get this warning if EVENT_LOG is set, but I turn off writing to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLogConstructor\" title=\"Write User Log Constructor\">WriteUserLogConstructor</a></span>:\n11/12 15:32:33 Warning: Failed to open event rotation lock file /foobar/barfoo/EventLog.lock: 2 (No such file or directory)\n\n</p><p><em>2009-Nov-12 16:24:55 by wenger:</em> <br/>\n\nI've fixed the two main issues (disabling global logging in DAGMan and exiting if logging the POST script terminated event fails) for 7.4.1.  (I haven't yet implemented retries of logging the event.)  I've merged the fix to 7.5, and pushed all of the changes.  I've also figured out how to make a test for this problem, so I'm going to do that in 7.5.\n\n</p><p></p><hr/>\n<em>2009-Nov-13 10:46:52 by matt:</em> <br/>\n\nDon't these changes mean that DAGMan no longer supports the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> feature? If I wanted to have a single location to look for events written by DAGMan I could DAGMAN.EVENT_LOG=..., but no longer. Wouldn't a solution to this be specifying SCHEDD.EVENT_LOG instead of a general EVENT_LOG. Possible, but less attractive, would be to specify a default DAGMAN.EVENT_LOG=UNDEFINED.\n\n<p><em>2009-Nov-13 10:52:03 by wenger:</em> <br/>\n\nWell, if you specified DAGMAN.EVENT_LOG = &lt;something&gt;, the only events you'd ever get in that log would be POST script terminated events, so I'm not sure how useful that would be.  I think the only way you'd really get something useful would be if the \"main\" event log file was writeable by anyone who might run a DAGMan -- then you'd get all of the relevant events.  (One note on this -- I have kind of a low-priority task for DAGMan to dump more-or-less a subset of the dagman.out output to a separate file, which would contain sort of a minimum set of info to tell what state your jobs are in.  So if you wanted something like a global event log for a DAG, that might be somewhat of a solution.  The other thing is that now, if you don't specify log files for any of your node jobs, all events will get logged to a single default log file.)  I agree that the current setup is not ideal, but unless we do something like the logging daemon proposed above, I'm not sure how we can really handle things \"right\".\n\n</p><p></p><hr/>\n<em>2009-Nov-13 11:15:28 by zmiller:</em> <br/>\n\nsome more notes:\n\n<p>if you were running a personal condor, where the eventlog was owned by the same user as the dagman process, PRE/POST events would have been written to the eventlog.  after this change, they are not.\n\n</p><p>if you were not running a personal condor, the ability to write PRE/POST events to the eventlog never existed.  so, at least the eventlog is consistent between personal/non-personal condor now in that PRE/POST events never get written.\n\n</p><p>have we ever considered making PRE/POST scripts into local universe jobs?  then they would be first-class entities and get logged properly in the event log in both cases.\n\n</p><p><em>2009-Nov-13 17:02:58 by wenger:</em> <br/>\n\nOkay, there's now a test for this in 7.5/master, and the bug is documented in the 7.4.0 version history and the fix is in the 7.4.1 version history.\n\n</p><p>As far as making PRE/POST scripts into local universe jobs, I kind of like the idea on first blush, but we'd need to do some thinking to make sure it didn't cause problems.  It would help to solve some other issues, though, like the request to be able to get PRE/POST script output...\n\n</p><p></p><hr/>\n<em>2009-Nov-17 11:39:57 by wenger:</em> <br/>\n\nThe main problems with this ticket have been fixed, so I'm going to close the ticket.  I've created separate new tickets dealing with the un-fixed aspects of this ticket: <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=963\" onclick=\"get_ticket_and_populate_wrapper('963'); return false;\" title=\"Have a Condor event logging daemon that does all log file writing\">#963</a></span> (log writing daemon); <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=964\" onclick=\"get_ticket_and_populate_wrapper('964'); return false;\" title=\"POST script terminated events not written to EventLog\">#964</a></span> (POST script terminated events not written to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span>); and <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=964\" onclick=\"get_ticket_and_populate_wrapper('964'); return false;\" title=\"POST script terminated events not written to EventLog\">#964</a></span> (re-try failed writes of POST script terminated events).</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=964\" onclick=\"get_ticket_and_populate_wrapper('964'); return false;\" title=\"POST script terminated events not written to EventLog\">#964</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nPOST script terminated events not written to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span></td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=965\" onclick=\"get_ticket_and_populate_wrapper('965'); return false;\" title=\"Re-try if write of POST script terminated event fails\">#965</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRe-try if write of POST script terminated event fails</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25140\">[25140]</a></span>: Documented the gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=934\" onclick=\"get_ticket_and_populate_wrapper('934'); return false;\" title=\"POST scripts in DagMan not compatible with having the EventLog enabled\">#934</a></span> bug in the 7.4.0 version history.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 16:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25130\">[25130]</a></span>: Documented the gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=934\" onclick=\"get_ticket_and_populate_wrapper('934'); return false;\" title=\"POST scripts in DagMan not compatible with having the EventLog enabled\">#934</a></span> fix in the 7.4.1 version history.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16319\">[16319]</a></span>: Added test for gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=934\" onclick=\"get_ticket_and_populate_wrapper('934'); return false;\" title=\"POST scripts in DagMan not compatible with having the EventLog enabled\">#934</a></span> fix (job_dagman_event_log -- sets up an unwriteable EVENT_LOG path for DAGMan, make sures a DAG with POST scripts still works).  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-12 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16312\">[16312]</a></span>: Fixed the main issues in gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=934\" onclick=\"get_ticket_and_populate_wrapper('934'); return false;\" title=\"POST scripts in DagMan not compatible with having the EventLog enabled\">#934</a></span>: * When DAGMan writes a POST script terminated event, it disables logging to the global log (<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span>). * If DAGMan is unable to write the POST script terminated event, it dumps a rescue DAG and exits (rather than hanging). (I have not yet implemented re-tries for\u00a0[...]\n (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-12 15:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16302\">[16302]</a></span>: As part of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=934\" onclick=\"get_ticket_and_populate_wrapper('934'); return false;\" title=\"POST scripts in DagMan not compatible with having the EventLog enabled\">#934</a></span>: Renamed the global log enable/disable methods  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 13:41", "status": "resolved", "created": "2009-Nov-11 17:15", "fixed_version": "2009-Nov-11 17:15", "broken_version": "v070400", "priority": "2", "subsystem": "Dag", "assigned_to": "nleroy", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "zmiller@cs.wisc.edu, wenger@cs.wisc.edu, matt@cs.wisc.edu", "due_date": ""}