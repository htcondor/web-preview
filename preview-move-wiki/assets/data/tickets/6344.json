{"id": 6344, "title": "Ticket #6344: Cross-protocol CCB should not cause schedd or shadow to EXCEPT", "description": "<blockquote>\nYutaro Iiyama (among others) reported a problem where an IPv4-only schedd would crash when matched with a startd which was only advertising IPv6.  The problem was that the IPv4-only schedd was contacting the CCB over IPv4, which correctly causes CCB to tell the startd to call back over IPv4.  Since the startd was not actually IPv6-only, it was able to do so.  Everything actually worked until we attempted to assign the newly-accept()d (reverse) connection's socket to the (unopened) outbound socket object, which EXCEPT()d because the outbound connection was to an IPv6 startd, but the reverse connection was IPv4.\n\n<p>After speaking with ToddT, we agreed that this fix has two pieces: (1), prevent the schedd from EXCEPT()ing in this situation and (2) add a protocol-matching hack into the negotiator, which is now ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6351\" onclick=\"get_ticket_and_populate_wrapper('6351'); return false;\" title=\"Negotiator should not match protocol-incompatible schedds and startds.\">#6351</a></span>.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Jul-17 15:46:44 by johnkn:</em> <br/>\n\n<strong>INCOMPETENT_CODE_REVIEW</strong> It appears that shared port on windows will still have the problem of assign socket with a valid who is called with a non-matching protocol.  Also on shared port, it appears that the removal of the check for non-matching protocol will happen for more than just CCB.\n\n<p>The rest is all ADA to me.\n\n</p><p></p><hr/>\n<em>2017-Jul-19 11:10:39 by tlmiller:</em> <br/>\n\nAdded what should fix the problem for Windows, but don't have time right at the moment to test on a Windows machine (the repro I have at the moment requires three machines and I don't know that there's a Windows machine I can break in the same network).\n\n<p>Otherwise, assuming approval from another reviewer, I'm going to say that skipping the protocol checks for other assignments won't be problem, since this check has been in place for quite some time and this is the first we've heard of it causing problems; or, it'll be OK to make a new ticket for the next release about only doing this for CCB (if we can).\n\n</p><p></p><hr/>\n<em>2017-Jul-31 16:30:53 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  There are a lot of edge cases here, but I think we're strictly better for 8.6</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6351\" onclick=\"get_ticket_and_populate_wrapper('6351'); return false;\" title=\"Negotiator should not match protocol-incompatible schedds and startds.\">#6351</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nNegotiator should not match protocol-incompatible schedds and startds.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-31 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/33d4d51300cc9a81c4c5d66f923d8368a58db9b6\">[51971]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6344\" onclick=\"get_ticket_and_populate_wrapper('6344'); return false;\" title=\"Cross-protocol CCB should not cause schedd or shadow to EXCEPT\">#6344</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6324\" onclick=\"get_ticket_and_populate_wrapper('6324'); return false;\" title=\"Execute directory cannot be an ImDisk ramdrive on Windows\">#6324</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6308\" onclick=\"get_ticket_and_populate_wrapper('6308'); return false;\" title=\"parallel universe doesn't support partitionable slots well\">#6308</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6343\" onclick=\"get_ticket_and_populate_wrapper('6343'); return false;\" title=\"Collector Python plugin has undefined symbols\">#6343</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-19 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4c97c4251969a99ca419b2ba0d3d13ad00aeaa8a\">[51890]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6344\" onclick=\"get_ticket_and_populate_wrapper('6344'); return false;\" title=\"Cross-protocol CCB should not cause schedd or shadow to EXCEPT\">#6344</a></span>) Fix bad fix to bad debug message.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-19 11:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a4116840a33f2cb2c27f38bcabeb215bcc467cc7\">[51888]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6344\" onclick=\"get_ticket_and_populate_wrapper('6344'); return false;\" title=\"Cross-protocol CCB should not cause schedd or shadow to EXCEPT\">#6344</a></span>) This should avoid the socket-handoff assert blowing on Windows.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-12 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d49c64692ebb5e8a161ec8cd661b83c6492e7549\">[51882]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6344\" onclick=\"get_ticket_and_populate_wrapper('6344'); return false;\" title=\"Cross-protocol CCB should not cause schedd or shadow to EXCEPT\">#6344</a></span>) Don't EXCEPT when CCB callbacks aren't the right protocol.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jul-31 16:36", "status": "resolved", "created": "2017-Jul-12 14:07", "fixed_version": "2017-Jul-12 14:07", "broken_version": "", "priority": "2", "subsystem": "CCB", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}