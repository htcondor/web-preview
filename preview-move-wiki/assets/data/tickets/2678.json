{"id": 2678, "title": "Ticket #2678: RFE: expose accounting group negotiation-ordering to configuration", "description": "<blockquote>\nMotivation is twofold:\n\n<p>1) Customers have been requesting a return to legacy behavior of \"none\" group such that it negotiates last (instead of its current behavior of being ordered in with other groups by starvation)\n\n</p><p>2) There have been some other requests that indicate a desire to explicitly control the negotiation order of accounting groups in customer-dependent ways\n\n</p><p>The proposed solution to both of these cases is to expose an accounting group ordering expression to configuration that would return some floating point number that would be used for acct groups.\n\n</p><p>Supporting this feature would require the creation of a classad for each accounting group, populated with some attributes that could be used for expressions.  Some obvious candidates would be:\n\n</p><p></p><ul>\n<li>Name # acct group name\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StarvationRatio\" title=\"Starvation Ratio\">StarvationRatio</a></span> # current starvation ratio\n</li><li>Quota # assigned slot quota\n</li><li>Allocated # actual slots allocated (not to be confused with quota)\n</li><li>Usage # current group usage\n</li><li>Priority # group's priority\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PriorityFactor\" title=\"Priority Factor\">PriorityFactor</a></span> # group's priority factor\n</li></ul>\n\n<p>One possible config scheme would be to work analogously to the other group\nquota settings, so there would be a default sort expression:\n\n</p><p># none goes last, otherwise default sort by quota-denominated starvation\n</p><div class=\"verbatim\">\n<pre>GROUP_QUOTA_SORT_EXPR = ifThenElse(Name=?=\"&lt;none&gt;\", 1e100, Usage/Quota)</pre></div>\n\n\n<p>And then optional group-specific ones:\n</p><div class=\"verbatim\">\n<pre># Group a always goes first\nGROUP_QUOTA_SORT_EXPR_a = -10\n# group b always goes 2nd\nGROUP_QUOTA_SORT_EXPR_b = -9\n</pre></div>\n\n\n<p>Or you could explicitly order all of them:\n</p><div class=\"verbatim\">\n<pre># Group a always goes first\nGROUP_QUOTA_SORT_EXPR_a = 1\n# group b always goes 2nd\nGROUP_QUOTA_SORT_EXPR_b = 2\n# ...\nGROUP_QUOTA_SORT_EXPR_z = 26\n\n# anybody else goes at the end, sorted by acct group prio\nGROUP_QUOTA_SORT_EXPR = 27 + Priority\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Dec-01 13:42:36 by eje:</em> <br/>\n\nOr, maybe:\n<div class=\"verbatim\">\n<pre>GROUP_SORT_EXPR\nGROUP_SORT_EXPR_&lt;groupname&gt;\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Dec-07 16:55:57 by eje:</em> <br/>\n\nAttached patch that exposes a new config param: GROUP_SORT_EXPR, which can be set to a classad expression that involves any of:\n\n<p></p><ul>\n<li>\"Name\" - accounting group name\n</li><li>\"Quota\" - the slot quota assigned during this neg cycle\n</li><li>\"Requested\" - the number of slots being requested by the submitters in the group\n</li><li>\"Allocated\" - the number of slots allocated by the HGQ algorithms\n</li><li>\"Usage\" - the slots currently in use by this accounting group\n</li><li>\"Priority\" - the accounting group's priority\n</li><li>\"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PriorityFactor\" title=\"Priority Factor\">PriorityFactor</a></span>\" - the group's priority factor\n</li></ul>\n\n<p>The expression must evaluate to a numeric value, or it will be defaulted to FLT_MAX with a warning message in the negotiator log.\n\n</p><p>GROUP_SORT_EXPR defaults to backward-compatible starvation-ratio sorting expression: 'ifThenElse(Allocated&gt;0.0,Usage/Allocated,3.40282e+38)'\n\n</p><p>(note, it was decided to defer on providing group-specific expressions of the form GROUP_SORT_EXPR_&lt;groupname&gt;, pending feedback from customers)\n\n</p><p></p><hr/>\n<em>2011-Dec-07 17:07:46 by eje:</em> <br/>\n\nTESTING:\n\n<p>Using the following configuration:\n</p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nNEGOTIATOR_USE_SLOT_WEIGHTS = FALSE\nNEGOTIATOR_INTERVAL = 30\n\nSCHEDD_INTERVAL\t= 15\n\nCLAIM_WORKLIFE = 0\n\nNUM_CPUS = 10\n\n# turn off round robin and multiple allocation rounds\nHFS_ROUND_ROBIN_RATE = 100000000\nHFS_MAX_ALLOCATION_ROUNDS = 1\n\nGROUP_NAMES = a, b\n\nGROUP_QUOTA_a = 5\nGROUP_QUOTA_b = 5\n\nGROUP_AUTOREGROUP = TRUE\n\n# sorts \"b\" before \"a\":\nGROUP_SORT_EXPR = ifThenElse(Name=?=\"a\", 2, ifThenElse(Name=?=\"b\", 1, 3.40282e+38))\n\n# this should trigger warnings and default to FLT_MAX:\n#GROUP_SORT_EXPR = 2+\"a\"\n</pre></div>\n\n\n<p>Bring up the negotiator with the above configuration, and then observe the ordering behavior for group negotiation:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e WARNING -e sortkey\n12/07/11 14:44:43 Group b - sortkey= 1\n12/07/11 14:44:43 Group a - sortkey= 2\n12/07/11 14:44:43 Group &lt;none&gt; - sortkey= 3.40282e+38\n</pre></div>\n\n\n<p>Next, enable GROUP_SORT_EXPR = 2+\"a\", which defaults with warnings:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e WARNING -e sortkey\n12/07/11 14:39:41 WARNING: sort expression \"2+\"a\"\" failed to evaluate to floating point for group &lt;none&gt; - defaulting to 3.40282e+38\n12/07/11 14:39:41 WARNING: sort expression \"2+\"a\"\" failed to evaluate to floating point for group a - defaulting to 3.40282e+38\n12/07/11 14:39:41 WARNING: sort expression \"2+\"a\"\" failed to evaluate to floating point for group b - defaulting to 3.40282e+38\n12/07/11 14:39:41 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 14:39:41 Group a - sortkey= 3.40282e+38\n12/07/11 14:39:41 Group b - sortkey= 3.40282e+38\n</pre></div>\n\n\n<p>Disable the settings for GROUP_SORT_EXPR, and let it take on its default \"starvation-order\" expr.  Submit the following file:\n</p><div class=\"code\">\n<pre class=\"code\">cmd = /bin/sleep\nargs = 60\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.user\"\nqueue 5\n+AccountingGroup=\"b.user\"\nqueue 10\n</pre></div>\n\n\n<p>You should see something similar to the following sequence, where prior to submission, all values are FLT_MAX, then \"a\" and \"b\" have zero starvation-ratio, as their allocation is nonzero but no jobs are yet running.  Then their starvation ratios will become 1, as all allocation is filled.  Then \"a\" will empty as its jobs complete first, then finally all ratios will return to FLT_MAX:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e WARNING -e sortkey\n12/07/11 15:33:31 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:33:31 Group a - sortkey= 3.40282e+38\n12/07/11 15:33:31 Group b - sortkey= 3.40282e+38\n12/07/11 15:33:51 Group a - sortkey= 0\n12/07/11 15:33:52 Group b - sortkey= 0\n12/07/11 15:33:52 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:34:23 Group a - sortkey= 1\n12/07/11 15:34:23 Group b - sortkey= 1\n12/07/11 15:34:23 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:34:53 Group a - sortkey= 1\n12/07/11 15:34:53 Group b - sortkey= 1\n12/07/11 15:34:53 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:35:23 Group b - sortkey= 0\n12/07/11 15:35:24 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:35:24 Group a - sortkey= 3.40282e+38\n12/07/11 15:35:54 Group b - sortkey= 1\n12/07/11 15:35:54 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:35:54 Group a - sortkey= 3.40282e+38\n12/07/11 15:36:24 Group b - sortkey= 1\n12/07/11 15:36:24 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:36:24 Group a - sortkey= 3.40282e+38\n12/07/11 15:36:55 Group &lt;none&gt; - sortkey= 3.40282e+38\n12/07/11 15:36:55 Group a - sortkey= 3.40282e+38\n12/07/11 15:36:55 Group b - sortkey= 3.40282e+38\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Dec-16 18:11:58 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Thanks for the patch!!!  Nice job.\n\n</p><p>Just a few items:\n\n</p><p></p><ol>\n<li>Fix the memory leak on this line:\n   <code>string group_sort_expr = param(\"GROUP_SORT_EXPR\");</code>\n   --- you prolly wanna use param(string value,const char*name) instead.\n</li><li>Use EvalFloat() instead of LookupFloat() on this line:\n   <code>if (!ad-&gt;LookupFloat(ATTR_SORT_EXPR, v)) {</code>\n   --- although lookup is currently implemented in terms of eval, it may not stay that way forever.\n</li><li>Lets try and make the attribute names come close to matching up the attribute names used by the PREEMPTION_REQUIREMENTS expr. So instead of ATTR_NAME for the attribute name describing the group, use ATTR_ACCOUNTING_GROUP.  Instead of \"Allocated\", use \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GroupResourcesInUse\" title=\"Group Resources In Use\">GroupResourcesInUse</a></span>\", etc.\n</li></ol>\n\n<p>Some questions:\n\n</p><p>Not sure I understand fully the difference between Allocated and Usage. Will Allocated &gt; Usage always be true?  I.e. Usage is what the account says, and Allocated is what the accountant says plus what we hope will be true after this negotiation cycle?\n\n</p><p>Was this tested using dynamic group quotas?\n\n</p><p>Does the value of the \"Quota\" attribute move around if the user is using static quotas?\n\n</p><p>If I set\n\n</p><p></p><pre>    group_quota_a = 5\n    group_quota_b = 10\n    GROUP_SORT_EXPR = ifThenElse(Name=?=\"&lt;none&gt;\", 1e100, Usage/Quota)\n</pre>\n\n<p>then is it true that the none group will get 0 machines until group a has 5 and group b has 10?\n\n</p><p></p><hr/>\n<em>2011-Dec-19 09:16:53 by eje:</em> <br/>\n\nThanks for the feedback!\n\n<p>Regarding (3), I can use the styles of attribute names from the PREEMPTION_REQUIREMENTS, although it seemed a bit redundant since in the context of this feature since by definition all attributes pertain to groups for GROUP_SORT_EXPR (e.g. why make the user say <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GroupResourcesInUse\" title=\"Group Resources In Use\">GroupResourcesInUse</a></span> when they can just say Usage, etc).\n\n</p><p>The difference between Allocated and Usage:  Usage is just the resources currently used by all submitters in the group.   \"Allocated\" is how many resources that were just allocated by the HGQ algorithms.\n\n</p><p>Some definitions (to be included in doc):\n\n</p><p>\"Quota\" is the resource quota assigned by HGQ, always in units of slots (possibly weighted, etc):   If it's a static quota, it will (normally) be exactly the static quota from the config file (unless the static quotas are greater than available resources, in which case they are normalized with a warning) If it was a dynamic quota, \"Quota\" will be the (dynamic quota) * (available resources).\n\n</p><p>\"Requested\" is basically (running+idle) jobs - that is, how many jobs would this group run if it could.\n\n</p><p>\"Allocated\" is how many resources (in units of slots) were the given to the group by the HGQ algorithm.   Allocated can be &gt; Quota, if the group received some surplus.   It can be &lt; Quota, if Requested &lt; Quota.  Note, this is why I defined the starvation-ratio as Usage/Allocated, instead of Usage/Quota.\n\n</p><p>Testing w/ dynamic quotas is more or less moot, since the Quota the sorting algorithm cares about is whatever comes out of HGQ.  The HGQ treatment of static/dynamic quotas has been tested elsewhere (but should eventually get into regression suite)\n\n</p><p>Regarding \"GROUP_SORT_EXPR = ifThenElse(Name=?=\"&lt;none&gt;\", 1e100, Usage/Quota)\", that sort-expr will make sure that \"&lt;none&gt;\" negotiates last.  So, groups \"a\" and \"b\" will get get first shot at negotiation.  Technically, that does not <strong>absolutely guarantee</strong> they get what they want, but if they don't get it, it will be because of a failure to match slots, etc, not because somebody in \"none\" got there first.\n\n</p><p></p><hr/>\n<em>2011-Dec-20 15:47:05 by johnkn:</em> <br/>\n\nThe sense of this seems backwards to me.  Where smaller numbers are used to give groups HIGHER priority.\n\n<p>It would be more consistent with the the rest of condor for this to be a RANK expression for the groups.  With the current behavior resolving to something like.\n\n</p><p></p><div class=\"verbatim\">\n<pre>GROUP_RANK_EXPR = \u200bifThenElse(Group=?=\"&lt;none&gt;\",\u200b 0,\u200b \u200bifThenElse(Allocated \u200b&gt; \u200b0,\u200b Quota/Allocated,\u200b Quota*2)\u200b)\u200b\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Dec-22 15:28:49 by eje:</em> <br/>\n\nRegarding the proposal for using the name 'GROUP_RANK_EXPR': the group negotiation order is most similar to the submitter negotiation order, which is governed by priority that is sorted from smallest to largest value.  Possibly it could be called GROUP_PRIO_EXPR, although the sorting expression given doesn't need to have anything to do with priority as the Accountant defines it.\n\n<p></p><hr/>\n<em>2011-Dec-27 14:48:29 by johnkn:</em> <br/>\n\nAfter some discussion Todd and TJ strongly feel that the default value for 7.7.x should be\n\n<p></p><pre>   SORT_EXPR = \"Usage/(Quota+1)\"\n</pre>\n\n<p>And we also wonder whether any current user of 7.6.x actually depends on the algorithm that treats all groups as having equal sort order (at the end)until they get their first allocation;  And then sorts groups that have resources before groups that don't.</p></blockquote>", "derived_tickets": "", "attachments": "<blockquote>\n<ul>\n<li><a href=\"attach_get/504/gt2678-group-sort-expr.patch\">gt2678-group-sort-expr.patch</a>\n7935 bytes added by eje on 2011-Dec-07 22:48:35 UTC.\n<br/>\nPatch against V7_6-branch.  Exposes accounting group sorting to new config var GROUP_SORT_EXPR, which can be set to a classad expression (numeric) involving accounting group attributes: \"Name\", \"Quota\", \"Requested\", \"Allocated\", \"Usage\", \"Priority\", \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PriorityFactor\" title=\"Priority Factor\">PriorityFactor</a></span>\"<br/>\n</li></ul>\n</blockquote>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-20 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28865\">[28865]</a></span>: Comment out unusable documentation for last-minute 7.6.5 addition <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2678\" onclick=\"get_ticket_and_populate_wrapper('2678'); return false;\" title=\"RFE: expose accounting group negotiation-ordering to configuration\">#2678</a></span>, and reword version item to go with <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2679\" onclick=\"get_ticket_and_populate_wrapper('2679'); return false;\" title=\"RFE: Alter semantic of GROUP_AUTOREGROUP to replicate legacy behavior\">#2679</a></span>.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-19 17:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28859\">[28859]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=28858\">[28858]</a></span>, merge uw/V7_7_4-branch ===GT=== <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2678\" onclick=\"get_ticket_and_populate_wrapper('2678'); return false;\" title=\"RFE: expose accounting group negotiation-ordering to configuration\">#2678</a></span> <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2679\" onclick=\"get_ticket_and_populate_wrapper('2679'); return false;\" title=\"RFE: Alter semantic of GROUP_AUTOREGROUP to replicate legacy behavior\">#2679</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-19 16:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28853\">[28853]</a></span>: ===VersionHistory:Complete=== ===GT=== <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2678\" onclick=\"get_ticket_and_populate_wrapper('2678'); return false;\" title=\"RFE: expose accounting group negotiation-ordering to configuration\">#2678</a></span> and ===GT=== <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2679\" onclick=\"get_ticket_and_populate_wrapper('2679'); return false;\" title=\"RFE: Alter semantic of GROUP_AUTOREGROUP to replicate legacy behavior\">#2679</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-19 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28851\">[28851]</a></span>: Documentation for GROUP_SORT_EXPR ===GT=== <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2678\" onclick=\"get_ticket_and_populate_wrapper('2678'); return false;\" title=\"RFE: expose accounting group negotiation-ordering to configuration\">#2678</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-19 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28850\">[28850]</a></span>: Exposed accounting group sorting for negotiation order to configuration ===GT:Fixed=== <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2678\" onclick=\"get_ticket_and_populate_wrapper('2678'); return false;\" title=\"RFE: expose accounting group negotiation-ordering to configuration\">#2678</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Oct-18 07:08", "status": "pending", "created": "2011-Dec-01 13:37", "fixed_version": "2011-Dec-01 13:37", "broken_version": "", "priority": "3", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, tannenba@cs.wisc.edu,dan@hep.wisc.edu, tstclair@redhat.com, jthomas@redhat.com", "due_date": ""}