{"id": 3428, "title": "Ticket #3428: Create unit tests for ring_buffer code used by daemon statistics", "description": "<blockquote>\nAs we have had some problems with the statistics ring_buffer&lt;&gt; code, we are adding a unit regression test for this code in this ticket.\n\n<p>Our initial runs of the unit test revealed a bug in ring_buffer&lt;&gt; code that is not currently being using in HTCondor, thus we will also fix the bug in ring_buffer&lt;&gt; here as part of this ticket in the developer series (since it is not a user visible bug) so that we can at least start out with all the unit tests passing.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Jan-10 09:48:04 by eje:</em> <br/>\n\nLocalized one problem here:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">         // if there is an existing buffer copy items from it to the new buffer\n         int cCopy = 0;\n         if (pbuf) {\n            cCopy = cItems;\n            for (int ix = 0; ix &gt; 0 - cCopy; --ix)\n               p[(ix+cCopy)%cSize] = (*this)[ix];\n            delete[] pbuf;\n         }\n\n         pbuf    = p;\n         cAlloc  = cNew;\n         cMax    = cSize;\n         ixHead  = cCopy;  // &lt;- these keep old cItems value, logic error for size reduction\n         cItems  = cCopy;\n\n</pre></div>\n\n\n<p>Not sure if it's limited to that.   I'm planning to introduce unit testing for ring_buffer&lt;&gt; as part of fix to help verify.\n\n</p><p></p><hr/>\n<em>2013-Jan-13 14:33:01 by eje:</em> <br/>\n\nFix on branch:  V7_9-gt3428-ring-buffer-logic\n\n<p>This branch consists of two commits: the first is the actual changes to generic_stats.h and the 2nd commit is the addition of unit testing.  Unit testing is a separate commit because it is written using boost.test, which is not available prior to 7.9.  The fixes to generic_stats.h may optionally be back-ported using cherry-pick to 7.8, without the unit testing.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-18 11:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3ec00d2b941ef72991bd5f1e55be1d26a539704b\">[34714]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> Fix *nix builds  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-17 17:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c1b7e9261ac260a319b5ea93b02034c56a4d467e\">[34712]</a></span>: fix generic_stats ring_buffer to pass unit tests. data sometimes being lost on a resize of the buffer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-17 14:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/97e97888ed71dcaebfbae719e6e18b91c824c2fb\">[34711]</a></span>: Unit testing for ring_buffer&lt;&gt; ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> Committer: John (TJ) Knoeller  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-15 09:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9df78d820762d5f1fff8d6a4177fdea9a6f758f\">[34639]</a></span>: fix statistics ring buffer so that it no longer aborts after a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SetSize\" title=\"Set Size\">SetSize</a></span> operation that reduces the size. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3443\" onclick=\"get_ticket_and_populate_wrapper('3443'); return false;\" title=\"daemon abort after changing STATISTICS_WINDOW_SECONDS, reconfig\">#3443</a></span>. This should fix the ring buffer problem in mentioned in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span> also. parent ticket <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=2197\" onclick=\"get_ticket_and_populate_wrapper('2197'); return false;\" title=\"General statistics architecture for Condor\">#2197</a></span> ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-13 14:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/361000ccbe70a78b58584e70c388ef4700c72134\">[34626]</a></span>: Unit testing for ring_buffer&lt;&gt; ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-13 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1c784a2e1329836587d50e60d90bec81bba5cc61\">[34625]</a></span>: Fix some logic errors in ring_buffer&lt;&gt; ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3428\" onclick=\"get_ticket_and_populate_wrapper('3428'); return false;\" title=\"Create unit tests for ring_buffer code used by daemon statistics\">#3428</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Feb-18 12:07", "status": "resolved", "created": "2013-Jan-10 09:45", "fixed_version": "2013-Jan-10 09:45", "broken_version": "v070800", "priority": "2", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "#2197", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com, eje@cs.wisc.edu, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}