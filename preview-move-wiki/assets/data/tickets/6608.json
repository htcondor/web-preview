{"id": 6608, "title": "Ticket #6608: Malformed XferStatsLog records - multiple job ids in same record", "description": "<blockquote>\nUsers have <a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2018-March/msg00061.shtml\">reported malformed XferStatsLog records</a>.  Specifically, there are multiple job ids in same record ?!?  Behold this line from a CHTC submit server:\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \n   03/15/18 14:24:00 (D_STATS) (55363701.8437) (2405608): (peer stats from starter): 03/15/18 14:24:01 (D_STATS) (55372299.226) (2382515): (peer stats from starter): File Transfer Upload: JobId: 55372299.226 files: 2 bytes: 86403 seconds: 2658.14 dest: 128.xxx.xxx.xxx rto: 201000 ato: 40000 snd_mss: 1448 rcv_mss: 536 unacked: 0 sacked: 0 lost: 0 retrans: 0 fackets: 0 pmtu: 1500 rcv_ssthresh: 29200 rtt: 226 snd_ssthresh: 20 snd_cwnd: 21 advmss: 1448 reordering: 3 rcv_rtt: 0 rcv_space: 29200 total_retrans: 0\n</td></tr></tbody></table></div>\n\n\n<p>It almost looks as if records are being overlapped, but this should not be happening assuming the condor_shadow is writing this status line in one call to dprintf ever since ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1707\" onclick=\"get_ticket_and_populate_wrapper('1707'); return false;\" title=\"improve scalability of shadow logging\">#1707</a></span>.  Recall <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1707\" onclick=\"get_ticket_and_populate_wrapper('1707'); return false;\" title=\"improve scalability of shadow logging\">#1707</a></span> changed things so log messages are written with one call to write(), which POSIX claims will be atomic on files opened with O_APPEND.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-15 15:52:23 by johnkn:</em> <br/>\n\nthis code:\n<div class=\"snip\">\n<pre class=\"sniplabel\">jic_shadow.cpp </pre>\n<pre class=\"snip\">const char *stats = m_ft_info.tcp_stats.c_str();\nstd::string full_stats = \"(peer stats from starter): \";\nfull_stats += stats;\n\nASSERT( !shadowDisconnected() );\n\nif (shadow_version &amp;&amp; shadow_version-&gt;built_since_version(8, 5, 8)) {\n\tREMOTE_CONDOR_dprintf_stats(full_stats.c_str());\n}\n</pre></div>\n\n\n<p>Will end up printing a line with no \\n if tcp_stats is empty, which it will be if there was were no files to transfer.\n\n</p><p></p><hr/>\n<em>2018-Mar-15 17:31:11 by tannenba:</em> <br/>\n\nConflicts merging this v8.6 patch over to the master.  I resolved them in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d54488643d49575733c301e121f0f6d42b055845\">[54529]</a></span>, but Greg please make sure I did it correctly.\n\n<p></p><hr/>\n<em>2018-May-02 11:33:41 by jpatton:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-04 13:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/489c2e924921939021ce65fbae4f6dad0de1721f\">[54848]</a></span>: Revert \"Documnet <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6608\" onclick=\"get_ticket_and_populate_wrapper('6608'); return false;\" title=\"Malformed XferStatsLog records - multiple job ids in same record\">#6608</a></span>\" This reverts commit 59a354b794ee51cb22c4f8c786667fee51bea88b.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Apr-17 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1891e35e314e9ee44517c6a5f568b68ae120a4c0\">[54744]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6608\" onclick=\"get_ticket_and_populate_wrapper('6608'); return false;\" title=\"Malformed XferStatsLog records - multiple job ids in same record\">#6608</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-15 17:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d54488643d49575733c301e121f0f6d42b055845\">[54529]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d1626fd98b8c364b8668c2a8c1ae73343a721d7\">[52958]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/54c26fff30110ea02169685355cc238e916e2160\">[52961]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/44a5364a6eff4905cb93bf534343a5afa68d2997\">[52964]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/caa01539d0c373f26cec76e0a888b58afdf33cb2\">[52967]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6da37e0e8fde0e0cf2d9e127d993736fef2033b0\">[52968]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f4f8b2278edb2d5ed6ed9b789021933818efebd8\">[52969]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1cc52f056a31bcc38ec89cc064159d82e121c717\">[52984]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37e74a9faf60771c81baaa4046cf19fafb89ad31\">[52985]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/91d330886d4943fff8498fc545b8347653026f22\">[52986]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2047dfc7bf23df77b70817bb740910d3eaa6f19e\">[52987]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/636d6cc1e0acabf03c21a95261e5c02957cd3891\">[52988]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d0489ddec3a27d59ff6990ac7f1f8645e3ac1c56\">[52989]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a7e526f60d5281b26b3551637fa26ea39d0a4de\">[52990]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/92b90db80c9760a8a44ce39762ce266cf81e0168\">[52992]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0a755c930128e74b72de20c5b7016be286fc0bd3\">[52995]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a810412e6de5b0028cdfe667860669b2bca9960\">[52996]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d2526225e37234a6f91a0ddc24e91405fd4035c1\">[52997]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/02955fe54da1fdff82a4ffc644aedba18a4c750e\">[52999]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a845db6768a46bb8ca9781ced02a30574a63e5a6\">[53000]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/37cdd039fd4a73d9b354fc6328e6125cd015789a\">[53018]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/22f073a5ce0eee973a01fc097bcb9875e11d8222\">[53019]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/29c3ac80eb6af63a60ff8209e61c45570e9197fe\">[53021]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/453989bd3a5e1c64936e4afefacf20e76a9aa249\">[53023]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9d2686e2f682473903a9735c34dcc3e950e8d68b\">[53025]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6fa4b723b23031b7ed54b6024c414478f757116\">[53027]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/be79550121fb630f237926dce64cc762c517d990\">[53046]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db9b5e1fa42589d34536953035a1a84a0e1153f8\">[53047]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4dfc3e01a7a71299332e44c4f223d9d481e34939\">[53079]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a836895a4d6e230e7759ce456e4d17cc85c19c42\">[53083]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/685d125f1b0bfc699aa886dd1cbacf7ba330ba41\">[53099]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/be7bf8482f085b0780971363c8dde1de783d87f6\">[53100]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b8d1060aa95b9589237a8ae1a96f6ec2597df52\">[53109]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c0ec1c213ee7f03f64ba3046533f67da3863bf74\">[53111]</a></span>,\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-15 16:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/94aeb34c1eeee2ef07ad7258ef045cb207491fc9\">[54525]</a></span>: Fix bug in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=XferStatsLog\" title=\"Xfer Stats Log\">XferStatsLog</a></span> that would interleave output messages <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6608\" onclick=\"get_ticket_and_populate_wrapper('6608'); return false;\" title=\"Malformed XferStatsLog records - multiple job ids in same record\">#6608</a></span> Only happens when there are no files to transfer in either direction.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-May-02 11:34", "status": "resolved", "created": "2018-Mar-15 14:36", "fixed_version": "2018-Mar-15 14:36", "broken_version": "v080600", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "gthain", "derived_from": "#5917", "creator": "tannenba", "rust": "", "customer_group": "users", "visibility": "public", "notify": "georgpap@isi.edu, tannenba@cs.wisc.edu, jpatton@cs.wisc.edu", "due_date": ""}