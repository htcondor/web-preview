{"id": 7484, "title": "Ticket #7484: oauth credentials are swept too quickly", "description": "<blockquote>\nWhen a user has no jobs in the queue, the schedd may write a &lt;username&gt;.mark file in the <code>SEC_CREDENTIAL_DIRECTORY</code>, which tells the credd (I think?) that all of the user's tokens should be deleted. This causes a race between when a user obtains tokens and when the user submits a job that uses said tokens. If the schedd notices too quickly, writes the mark file, and the files are swept, the user is again prompted to obtain tokens.\n\n<p>Writing the mark file is fine, but I propose that we leave it up the credmon to decide when to sweep tokens. The credmon has a better idea of the expiration date of the tokens and can make intelligent cleanup decisions depending upon the mtimes of the mark file, the refresh and access token files, and the tokens' expirations.</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-Jun-05 20:21:43 by bbockelm:</em> <br/>\n\nJust to note - this has bit CMS's attempts to use HTCondor to manage WLCG tokens.  Please bump in priority.\n\n<p></p><hr/>\n<em>2020-Jun-29 10:48:46 by zmiller:</em> <br/>\n\nI changed the code (to be released in 8.9.8) to look at config <code>SEC_CREDENTIAL_SWEEP_DELAY</code> and wait until the <code>.mark</code> file is at least that many seconds old before sweeping.\n\n<p>This of course stops HTCondor from deleting the creds out from under you, but there is still the open question:  Should the <code>CREDD</code> or the <code>CREDMON</code> be responsible for deleting these?  The answer shouldn't be \"neither\" but I guess it could be \"both\", which I think is what we have now.\n\n</p><p></p><hr/>\n<em>2020-Jun-29 11:09:10 by tannenba:</em> <br/>\n\nWhen is all the credmon / credd OAUTh stuff going to get documented?  We need a ticket for this if we don't have one already. It is strange to have a version history entry about a new knob that does not appear anywhere in the documentation.\n\n<p></p><hr/>\n<em>2020-Jun-29 11:13:37 by zmiller:</em> <br/>\n\nDoc ticket for all this is <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7646\" onclick=\"get_ticket_and_populate_wrapper('7646'); return false;\" title=\"Update security docs for kerberos, krb5, afs, oauth, credmon, credd\">#7646</a></span></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-31 10:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60289\">[60289]</a></span>: Add version history for SEC_CREDENTIAL_SWEEP_INTERVAL <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7484\" onclick=\"get_ticket_and_populate_wrapper('7484'); return false;\" title=\"oauth credentials are swept too quickly\">#7484</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-10 00:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60111\">[60111]</a></span>: Add SEC_CREDENTIAL_SWEEP_INTERVAL to param table and chill it out from 30 to 300. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7484\" onclick=\"get_ticket_and_populate_wrapper('7484'); return false;\" title=\"oauth credentials are swept too quickly\">#7484</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-10 00:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60110\">[60110]</a></span>: Clean up debug messages. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7484\" onclick=\"get_ticket_and_populate_wrapper('7484'); return false;\" title=\"oauth credentials are swept too quickly\">#7484</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-25 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59991\">[59991]</a></span>: Version history for SEC_CREDENTIAL_SWEEP_DELAY. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7484\" onclick=\"get_ticket_and_populate_wrapper('7484'); return false;\" title=\"oauth credentials are swept too quickly\">#7484</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-25 10:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59986\">[59986]</a></span>: Add SEC_CREDENTIAL_SWEEP_DELAY so credentials aren't swept too quickly. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7484\" onclick=\"get_ticket_and_populate_wrapper('7484'); return false;\" title=\"oauth credentials are swept too quickly\">#7484</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Jul-31 10:48", "status": "resolved", "created": "2020-Jan-22 14:23", "fixed_version": "2020-Jan-22 14:23", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "zmiller", "derived_from": "#6513", "creator": "jpatton", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "jpatton@cs.wisc.edu, zmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}