{"id": 892, "title": "Ticket #892: add support for a shared TCP listener port", "description": "<blockquote>\nCurrently, each daemon has it's own TCP listener for its command socket.  On a high-scale submit node, this adds up to a lot of ports, which caps scalability at around 23k running jobs.  If you want to poke holes in a firewall for these ports, a large range must be opened, and there is not a very strong assurance that it is condor that is using these ports, since it dynamically opens and closes command sockets as daemons come and go, potentially leaving ports open to other processes that were not intended to be open through the firewall.\n\n<p>The solution that I'm working on is to have an optional service that allows all the condor daemons on a machine to share the same TCP listener.  Connections are accepted by the shared port service and the file descriptor is passed to the requested target daemon.  It's pretty simple and doesn't require fundamental changes to Condor's networking or security layers.  In unix, this passing of the file descriptor happens over a named socket.  I believe windows has its own mechanism (see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=991\" onclick=\"get_ticket_and_populate_wrapper('991'); return false;\" title=\"Make condor_shared_port work on windows\">#991</a></span>).\n\n</p><p>There will be a protocol change, so daemons using the shared port service will not be reachable by older versions of condor.  The protocol change is to send the id of the requested daemon immediately after connecting to the shared port.  The id is the name of the shared socket, which is advertised, like CCB contact information, in the url-encoded key=value parameters in the contact string.\n\n</p><p>The shared port service does not accept arbitrary paths to named sockets, because this might be a security problem.  It only accepts base-names and it prepends the path to the daemon socket directory.  This implies that only daemons with the ability to create named sockets in that directory will be able to accept connections through the shared port service.  I'm currently planning on making this directory writable only by condor, so this will not allow daemons running in PRIV_USER_FINAL to accept connections through the shared port service unless the admin changes the permissions on this directory.  I'm not aware of a case where this is a concern.</p></blockquote>", "remarks": "<blockquote>\nI have completed support for sharing a port between condor daemons on all of our unix platforms except for HPUX.  This is going into 7.5.0.  Standard universe daemons do not use the shared port.\n\n<p>The code compiles on HPUX but fails at runtime in sendmsg() with \"Bad file number\".</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-23 09:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25147\">[25147]</a></span>: Documented how to have collector use a shared port. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-23 09:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16439\">[16439]</a></span>: The collector/CCB can use a shared port now too. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span> To use it, one must specify a static socket name for the collector.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-17 22:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16369\">[16369]</a></span>: Fixed handling of shared port and private network address. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-15 07:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16325\">[16325]</a></span>: Improved handling of shared plus non-shared port (useful for SOAP). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-15 07:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16326\">[16326]</a></span>: condor_shared_port now works on solaris and AIX too. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span> HPUX11 is now the only unix platform I can't get to work; it compiles but fails to pass fds at runtime.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-14 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25123\">[25123]</a></span>: condor_shared_port now works on all unix systems except for HPUX. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 22:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25122\">[25122]</a></span>: Improved documentation of condor_shared_port. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 21:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25121\">[25121]</a></span>: More improvements to shared port docs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 12:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16318\">[16318]</a></span>: Improved error message when maximum named socket path length is exceeded. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-13 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25120\">[25120]</a></span>: Improved shared port documentation. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-12 18:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25119\">[25119]</a></span>: Documented USE_SHARED_PORT. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-12 15:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16308\">[16308]</a></span>: Added USE_SHARED_PORT. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-12 15:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16309\">[16309]</a></span>: Added smoke test for shared port. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=892\" onclick=\"get_ticket_and_populate_wrapper('892'); return false;\" title=\"add support for a shared TCP listener port\">#892</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Jan-31 13:41", "status": "resolved", "created": "2009-Nov-02 09:45", "fixed_version": "2009-Nov-02 09:45", "broken_version": "v070500", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}