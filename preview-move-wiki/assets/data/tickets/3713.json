{"id": 3713, "title": "Ticket #3713: condor_status -submitters doubles running job count", "description": "<blockquote>\nEmail from LIGO:\n\n<p>Since upgrading to Condor 8.0, we're seeing a discrepancy in the\nnumber of running jobs reported by condor_status.  Specifically,\ninvoking condor_status with -submitters as an option reports twice\nthe actual number of running jobs.  The trigger seems to be the\n-submitters option, as condor_status by itself works fine:\n\n</p><p></p><pre>      [root@ldas-grid ~]# condor_q | tail -1\n      3114 jobs; 0 completed, 0 removed, 1604 idle, 1510\n      running, 0 held, 0 suspended\n      [root@ldas-grid ~]# condor_status -total -pool gridmon\n                           Total Owner Claimed Unclaimed ...\n</pre>\n\n<p></p><pre>              X86_64/LINUX  1496     0    1496         0 ...\n</pre>\n\n<p></p><pre>                     Total  1496     0    1496         0 ...\n</pre>\n\n<p></p><pre>      [root@ldas-grid ~]# condor_status -total -pool gridmon\n      -submitters\n                             RunningJobs           IdleJobs           HeldJobs\n</pre>\n\n<p></p><pre>      jveitch@ldas.ligo-wa   2126                  937                  0\n      nchriste@ldas.ligo-w    104                   48                  0\n      pbaker@ldas.ligo-wa.    762                  619                  0\n</pre>\n\n<p></p><pre>                     Total   2992                 1604                  0\n</pre>\n\n<p>Judging from the vulture plots showing more running jobs than\navailable slots (e.g.\n<a class=\"external\" href=\"https://ldas-gridmon.ligo.caltech.edu/vulture/\">https://ldas-gridmon.ligo.caltech.edu/vulture/</a>), this problem is not\nlimited to LHO.  Is there a suggested workaround?</p></blockquote>", "remarks": "<blockquote>\n<strong>Reproduced by adesmet in 8.1.0 Jun 25 2013 BuildID: UW_development PRE-RELEASE-UWCS</strong>  Set up a personal HTCondor on a machine with 2 cores. Submitted 4 sleep jobs.  2 started.  Then...\n<div class=\"code\">\n<pre class=\"code\">% condor_version\n$CondorVersion: 8.1.0 Jun 25 2013 BuildID: UW_development PRE-RELEASE-UWCS $\n$CondorPlatform: X86_64-RedHat_6.4 $\n% condor_q -global\n\n\n-- Schedd: puffin.cs.wisc.edu : &lt;128.105.14.138:58399&gt;\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n   5.0   adesmet         6/25 16:35   0+00:15:32 R  0   4.2  sleep 3600\n   6.0   adesmet         6/25 16:35   0+00:15:32 R  0   4.2  sleep 3600\n   7.0   adesmet         6/25 16:35   0+00:00:00 I  0   0.0  sleep 3600\n   8.0   adesmet         6/25 16:35   0+00:00:00 I  0   0.0  sleep 3600\n% condor_status\nName               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime\n\nslot1@puffin.cs.wi LINUX      X86_64 Claimed   Busy      0.140 1851  0+00:14:09\nslot2@puffin.cs.wi LINUX      X86_64 Claimed   Busy      0.000 1851  0+00:14:10\n                     Total Owner Claimed Unclaimed Matched Preempting Backfill\n\n        X86_64/LINUX     2     0       2         0       0          0        0\n\n               Total     2     0       2         0       0          0        0\n% condor_status -submitters\nName                         Machine            RunningJobs IdleJobs HeldJobs\n\nadesmet@cs.wisc.edu          puffin.cs.wisc.edu           4        2        0\n                           RunningJobs           IdleJobs           HeldJobs\n\n adesmet@cs.wisc.edu                 4                  2                  0\n\n               Total                 4                  2                  0\n\n</pre></div>\n\n\n<p>Then reproduced with just 2 jobs in the queue (showing that the 2 idle jobs aren't the problem).\n\n</p><p>The output from -long makes it clear that the problem really is in the ad, not in condor_status:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">% condor_status -submitters -l\nIdleJobs = 0\n[snip]\nRunningJobs = 4\n[snip]\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Jun-26 17:17:17 by adesmet:</em> <br/>\n\nBug probably found.\n\n<p><a class=\"file\" href=\"rlog?f=src/condor_schedd.V6/schedd.cpp\">/src/condor_schedd.V6/schedd.cpp</a> around line 1118:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">if (rec-&gt;shadowRec &amp;&amp; !rec-&gt;pool) {\n\t\t// Sum up the # of cpus claimed by this user and advertise it as\n\t\t// WeightedJobsRunning.  Technically, should look at SlotWeight\n\t\t// but the IdleJobRunning only know about request_cpus, etc.\n\t\t// and hard-codes cpus as the weight, so we do the same here.\n\t\t// This is needed as the HGQ code in the negotitator needs to\n\t\t// know weighted demand to dole out surplus properly.\n\tint request_cpus = 1;\n\t++Owners[OwnerNum].JobsRunning;\n\tif (rec-&gt;my_match_ad) {\n\t\tif(0 == rec-&gt;my_match_ad-&gt;LookupInteger(ATTR_CPUS, request_cpus)) {\n\t\t\trequest_cpus = 1;\n\t\t}\n\t}\n\tOwners[OwnerNum].WeightedJobsRunning += request_cpus;\n\tOwners[OwnerNum].JobsRunning++;\n} else {                // in remote pool, so add to Flocked count\n</pre></div>\n\n\n<p>Notice that Owners[OwnerNum].JobsRunning is incremented twice inside that block.\n\n</p><p>Once upon a time the body of this block was a simple\n</p><div class=\"code\">\n<pre class=\"code\">Owners[OwnerNum].JobsRunning++;\n</pre></div>\n\nand nothing else.\n\n<p>Git attributes the duplicate lines to:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">0d408d87    (Nathan W. Panike   2013-01-15 15:47:26 -0600   1118)           ++Owners[OwnerNum].JobsRunning;\n</pre></div>\n\n<div class=\"code\">\n<pre class=\"code\">f1616f08    (Nathan W. Panike   2013-04-15 14:43:23 -0500   1125)           Owners[OwnerNum].JobsRunning++;\n</pre></div>\n\n\n<p>The individual commits look harmless enough.  But one of the commits is (partially) a revert, and later the two commits were merged.  I'm tracking down the point where it all went to crap, but my guess is that in the merge git forgot that they were the same line and kept both.\n\n</p><p></p><hr/>\n<em>2013-Jun-26 17:28:27 by adesmet:</em> <br/>\n\n0d408d87\n- Swaps from post-increment to pre-increment. Harmless style change.\n\n<p>f1616f08\n- Child of 0d408d87\n- REVERTS 0d408d87\n\n</p><p>0955ffd2\n- Merges f1616f08 and some work counting weighted running jobs\n- THE DUPLICATE APPEARS\n\n</p><p></p><hr/>\n<em>2013-Jun-27 15:23:05 by adesmet:</em> <br/>\n\nFix committed; we just don't doubly increment the counter.\n\n<p></p><hr/>\n<em>2013-Jun-27 16:02:05 by adesmet:</em> <br/>\n\nAssigned to TJ for review.\n\n<p></p><hr/>\n<em>2013-Oct-07 09:44:23 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong> It is correct.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-11 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36863\">[36863]</a></span>: minor edit of version history item ===GT=== <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3713\" onclick=\"get_ticket_and_populate_wrapper('3713'); return false;\" title=\"condor_status -submitters doubles running job count\">#3713</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-27 16:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36703\">[36703]</a></span>: Document fix fo wrong running job counts <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3713\" onclick=\"get_ticket_and_populate_wrapper('3713'); return false;\" title=\"condor_status -submitters doubles running job count\">#3713</a></span>  (By Alan De Smet )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-27 15:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=36701\">[36701]</a></span>: Stop double-counting running jobs. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=3713\" onclick=\"get_ticket_and_populate_wrapper('3713'); return false;\" title=\"condor_status -submitters doubles running job count\">#3713</a></span> Caused by a merge; we ended up with two lines, each incrementing the count of running jobs. I removed one.  (By Alan De Smet )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Oct-07 09:44", "status": "defer", "created": "2013-Jun-19 15:48", "fixed_version": "2013-Jun-19 15:48", "broken_version": "v080000", "priority": "5", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "wenger@cs.wisc.edu, anderson@ligo.caltech.edu,pcouvare@caltech.edu", "due_date": ""}