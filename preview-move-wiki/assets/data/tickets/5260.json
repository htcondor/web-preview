{"id": 5260, "title": "Ticket #5260: MAX_JOBS_PER_OWNER blows an assert", "description": "<blockquote>\nJaime found a landmine using SOAP.  In some cases, Q_SOCK-&gt;getOwner() may legitimately NULL.  In particular:\n\n<p></p><ul>\n<li>When QUEUE_ALL_USERS_TRUSTED = True (only when submitting via SOAP?)\n</li><li>When doing a secure submission via SOAP?\n</li></ul>\n\n<p>Additionally, if the user is a queue super-user, they can set the owner attribute to whatever they like.\n\n</p><p>I argue the following: if a queue super-user wants to submit too many jobs, we should let them.  (Not sure how to check for this condition in the code.)  Likewise, QUEUE_ALL_USER_TRUSTED effectively makes all users queue super-users in this respect (you're allowed to lie in the owner attribute), so we should ignore job count limits in this case as well.\n\n</p><p>However, in neither case should we blow the assert (which of course shuts down the schedd).\n\n</p><p>It remains to determine what happens with respect to authenticated SOAP.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Sep-15 11:29:21 by tlmiller:</em> <br/>\n\nFor 8.4.1, we need at least the minimal don't-assert fix, even if we have to end up skipping the check.\n\n<p></p><hr/>\n<em>2015-Sep-17 13:39:20 by tlmiller:</em> <br/>\n\nMinimal fix pushed (was tested as run ID 341954).  Still need to look into authenticated SOAP, which may manifest as a subticket.\n\n<p></p><hr/>\n<em>2015-Sep-17 13:48:21 by jfrey:</em> <br/>\n\nTo get unauthenticated SOAP submissions to work, I also had to make the call to scheduler.incrementRecentlyAdded() in CommitTransaction() conditional.\n\n<p></p><hr/>\n<em>2015-Sep-17 15:24:19 by tlmiller:</em> <br/>\n\nOK, that should be better.\n\n<p></p><hr/>\n<em>2015-Sep-17 15:34:55 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>These changes look good.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5267\" onclick=\"get_ticket_and_populate_wrapper('5267'); return false;\" title=\"Interaction of MAX_JOBS_PER_OWNER and authenticated SOAP?\">#5267</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nInteraction of MAX_JOBS_PER_OWNER and authenticated SOAP?</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-21 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cfe3c8366dfd278e0f0b5ee915fa2098b1927bf3\">[45871]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5260\" onclick=\"get_ticket_and_populate_wrapper('5260'); return false;\" title=\"MAX_JOBS_PER_OWNER blows an assert\">#5260</a></span>) Version history.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-17 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/84c9251e6abbd062a109591eba8b37d9349bb571\">[45858]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5260\" onclick=\"get_ticket_and_populate_wrapper('5260'); return false;\" title=\"MAX_JOBS_PER_OWNER blows an assert\">#5260</a></span>) Fix the other place where assume QSOCK always has an owner. Actually unbreaks SOAP.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-17 13:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b6a9e16739783375aefdb2b5213d82a3ade3dc1\">[45856]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5260\" onclick=\"get_ticket_and_populate_wrapper('5260'); return false;\" title=\"MAX_JOBS_PER_OWNER blows an assert\">#5260</a></span>) Log, rather than assert(), when Q_SOCK-&gt;getOwner() is NULL. This makes SOAP less unhappy.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Sep-21 14:37", "status": "resolved", "created": "2015-Sep-14 16:23", "fixed_version": "2015-Sep-14 16:23", "broken_version": "", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}