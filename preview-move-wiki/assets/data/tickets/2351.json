{"id": 2351, "title": "Ticket #2351: Ensure CREAM lease exists before submitting job in gridmanager", "description": "<blockquote>\nWhen submitting a CREAM job, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamJob\" title=\"Cream Job\">CreamJob</a></span> object in the gridmanager will skip checking the value/validity of the CREAM lease (maintained in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> object) if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamLeaseId\" title=\"Cream Lease Id\">CreamLeaseId</a></span> is set in the job ad. This can lead to the submission failing because the lease isn't registered on the server.\n\n<p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamJob\" title=\"Cream Job\">CreamJob</a></span> object should always check with the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> about the value of the lease id and its status before attempting to submit. When information about a previous submit attempt is scrubbed from the job ad in GM_CLEAR_REQUEST, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamLeaseId\" title=\"Cream Lease Id\">CreamLeaseId</a></span> should be removed.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Aug-15 13:32:17 by tannenba:</em> <br/>\n\nIIRC, part of this is to deal w/ leveraging the capability of CREAM to share one lease across multiple jobs....\n\n<p></p><hr/>\n<em>2011-Aug-22 14:30:16 by jfrey:</em> <br/>\n\nIt appears the bug in this ticket can't occur as described. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamLeaseId\" title=\"Cream Lease Id\">CreamLeaseId</a></span> attribute is never set, so it can never be used in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamJob\" title=\"Cream Job\">CreamJob</a></span> constructor to set leaseId and bypass asking the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> for the id of the lease. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2271\" onclick=\"get_ticket_and_populate_wrapper('2271'); return false;\" title=\"CREAM user mapping incorrect in gridmanager\">#2271</a></span> may be causing the behavior observed with this ticket. I'm waiting on Rod Walker to try out the fix for that ticket.\n\n<p></p><hr/>\n<em>2011-Oct-18 16:47:40 by jfrey:</em> <br/>\n\nI found a race condition in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> that would explain this behavior. <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> won't hand a lease id to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamJobs\" title=\"Cream Jobs\">CreamJobs</a></span> via getLeaseId() until m_sharedLeaseExpiration is set to non-zero. But in UpdateLeases(), m_sharedLeaseExpiration is set to the calculated lease value, then control is returned to daemonCore to let the value be saved in the schedd, then  <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> talks to the server to register it. While <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> is waiting for the value to be saved in the schedd, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamJob\" title=\"Cream Job\">CreamJob</a></span> objects may try to submit if daemonCore timers fire at the right time. A new guard variable needs to be added to getLeaseId() so that the lease id is returned only after the initial registration of the lease with the server is complete.\n\n<p></p><hr/>\n<em>2011-Oct-19 14:14:51 by jfrey:</em> <br/>\n\nI've sent a patched gridmanager to Rod Walker for testing.\n\n<p></p><hr/>\n<em>2011-Dec-01 15:37:47 by jfrey:</em> <br/>\n\nThis bug can also be triggered by the gridmanager retaining <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> objects for several minutes after they have no associated jobs (controlled by GRIDMANAGER_EMPTY_RESOURCE_DELAY). During that time, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> object won't extend the job lease, as it has no jobs to base the length on.\n\n<p>I saw a case with glideinwms where a problem job would become held immediately after it was released, which occurred once a minute due to the job policy expressions. This prevented the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> object from ever being deleted. But each time it checked on job leases, it had no jobs and so never extended the lease, which eventually expired. After that, any new jobs would fail on submission because the lease was invalid. Setting GRIDMANAGER_EMPTY_RESOURCE_DELAY=5 broke the loop, as the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CreamResource\" title=\"Cream Resource\">CreamResource</a></span> object was deleted before the next time the problem job was released.\n\n</p><p></p><hr/>\n<em>2011-Dec-05 14:01:32 by jfrey:</em> <br/>\n\nI've pushed a patch to V7_6-branch and posted a pre-release binary for Rod Walker, Xin Zhao and Igor Sfiligoi to try: <a class=\"external\" href=\"ftp://ftp.cs.wisc.edu/condor/temporary/forrod/2011-12-01/condor_gridmanager\">ftp://ftp.cs.wisc.edu/condor/temporary/forrod/2011-12-01/condor_gridmanager</a>\n\n<p></p><hr/>\n<em>2012-Jan-06 14:32:34 by jfrey:</em> <br/>\n\nRod Walker reports that lease problems have not reoccurred since installing the patched binary.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3054\" onclick=\"get_ticket_and_populate_wrapper('3054'); return false;\" title=\"First batch of Cream jobs never submitted to Cream server\">#3054</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFirst batch of Cream jobs never submitted to Cream server</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/480/cream-lease.patch\">cream-lease.patch</a>\n538 bytes added by jfrey on 2011-Oct-19 19:14:19 UTC.\n<br/>\nPatch to remove race condition between job submission and lease setting for cream.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-06 14:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=29018\">[29018]</a></span>: Add CREAM lease fixes to version history. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2351\" onclick=\"get_ticket_and_populate_wrapper('2351'); return false;\" title=\"Ensure CREAM lease exists before submitting job in gridmanager\">#2351</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2455\" onclick=\"get_ticket_and_populate_wrapper('2455'); return false;\" title=\"CREAM leases set in the past\">#2455</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Dec-01 15:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28533\">[28533]</a></span>: Ensure cream lease is set before job submission. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2351\" onclick=\"get_ticket_and_populate_wrapper('2351'); return false;\" title=\"Ensure CREAM lease exists before submitting job in gridmanager\">#2351</a></span> First, ensure that job submission can't proceed until the lease has been established with the cream server. Before there was a race condition.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jan-06 14:32", "status": "resolved", "created": "2011-Aug-03 16:23", "fixed_version": "2011-Aug-03 16:23", "broken_version": "v070600", "priority": "2", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": "20110817"}