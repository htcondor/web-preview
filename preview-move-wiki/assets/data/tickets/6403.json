{"id": 6403, "title": "Ticket #6403: Rehaul of the openmpiscript and related scripts", "description": "<blockquote>\nA number of issues have been brought up with using the openmpiscript to run Open MPI jobs in the parallel universe:\n\n<p>1. Environment variables are not passed to the user's executable. When condor_ssh connects to a slot's sshd and sets up the worker process to run the executable, few-to-no environment variables are passed. This can be a problem for, e.g., OpenMP-OpenMPI hybrid jobs that need OMP_NUM_THREADS defined. We should probably pass as many vars as possible?\n\n</p><p>2. The number of CPUs is not included in the contact file. mpirun and/or the user's executable could make use of that information.\n\n</p><p>3. Using the proc number may not be the best way of distinguishing condor slot ids to \"trick\" mpirun in to sending a unique SSH command to every slot.\n\n</p><p>4. There may be better ways of finding open ports for the SSHDs to run on.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-05 15:16:52 by jpatton:</em> <br/>\n\n<span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b21825501a7e5b74a518a69b5fde08aa890d0d9\">[52496]</a></span> and <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1f573b86aa5d4f1fd2582f0a7af1d3be5d6fa4c\">[52497]</a></span> address (1) and (2) above directly, and (4) indirectly.\n\n<p>1. The big change in this version of openmpiscript is the use of two new helper scripts, get_orted_cmd.sh and orted_launcher.sh, to remove the need of using ssh and sshds to set up the execute nodes. The former script gets the orted command that would normally be sent via ssh to the execute node and chirps it the spool directory. The latter script fetches the command from spool and runs it <strong>directly under the starter</strong> rather than under a sshd. Thus the environment is preserved for the user's executable.\n\n</p><p>2. request_cpus is now handled in the hostfile where appropriate (i.e. when <strong>not</strong> using OpenMP to do threading). If the use of OpenMP is desired, there's a boolean option in openmpiscript. Also, options are set to no longer allow Open MPI to bind to cores; no binding is permitted (so long as the relevant MCA variable is not changed in the script). This does mean a small performance reduction in the best case (no accidental oversubscription of the first n cores) but prevents huge performance problems in the worse case (oversubscription...).\n\n</p><p>4. No longer need ports to run sshd. Ports are still needed for communication between the orted processes.\n\n</p><p>As for (3), by prevent binding to cpu cores, I believe the user's problem that brought (3) to light is solved. We still use \"fake\" hostnames based on the node id number, but the correct number of slots are accounted for now in the hostfile.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6556\" onclick=\"get_ticket_and_populate_wrapper('6556'); return false;\" title=\"Update openmpiscript to work with shared filesystem\">#6556</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nUpdate openmpiscript to work with shared filesystem</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-26 16:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e23ad0fb9b0ab97d8ff9c7b17a7324c46501d57a\">[52680]</a></span>: Version history for <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6403\" onclick=\"get_ticket_and_populate_wrapper('6403'); return false;\" title=\"Rehaul of the openmpiscript and related scripts\">#6403</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-26 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a8df4e21df63997d3ce4146a615d7baecaa2c2b0\">[52679]</a></span>: (<span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6403\" onclick=\"get_ticket_and_populate_wrapper('6403'); return false;\" title=\"Rehaul of the openmpiscript and related scripts\">#6403</a></span>) Install orted support scripts  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-05 15:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1f573b86aa5d4f1fd2582f0a7af1d3be5d6fa4c\">[52497]</a></span>: Actually add the helper scripts to the commit <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6403\" onclick=\"get_ticket_and_populate_wrapper('6403'); return false;\" title=\"Rehaul of the openmpiscript and related scripts\">#6403</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-05 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b21825501a7e5b74a518a69b5fde08aa890d0d9\">[52496]</a></span>: Remove sshd dependency, run ompi jobs directly under starter <span class=\"ticket\"><a class=\"review\" href=\"/tickets?ticket=6403\" onclick=\"get_ticket_and_populate_wrapper('6403'); return false;\" title=\"Rehaul of the openmpiscript and related scripts\">#6403</a></span> Using condor_chirp, we can get the command to run ompi jobs directly under the starter by redirecting mpirun's ssh commands into files in spool, then fetch those files on each execute node and run the commands. This is accomplished using\u00a0[...]\n (By Jason Patton )</td></tr>\n</tbody></table>", "type": "todo", "last_change": "2017-Oct-05 15:22", "status": "review", "created": "2017-Sep-12 10:42", "fixed_version": "2017-Sep-12 10:42", "broken_version": "v080605", "priority": "2", "subsystem": "Parallel", "assigned_to": "gthain", "derived_from": "", "creator": "jpatton", "rust": "", "customer_group": "other", "visibility": "public", "notify": "gthain@cs.wisc.edu,jpatton@cs.wisc.edu", "due_date": ""}