{"id": 1931, "title": "Ticket #1931: Improve cream_gahp command batching", "description": "<blockquote>\nThe cream_gahp will batch many commands from the gridmanager that act on a single job into a single CREAM API command that acts on a list of jobs. This batching of commands improves efficiency. This work was done in ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=938\" onclick=\"get_ticket_and_populate_wrapper('938'); return false;\" title=\"Cream Gahp should batch requests\">#938</a></span>.\n\n<p>Some further efficiency improvements  can be achieved as follows:\n</p><ul>\n<li>Batch STATUS commands that act on a single job\n</li><li>Batch REGISTER commands\n</li><li>Improve error handling  for batched commands</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Feb-25 13:55:48 by jfrey:</em> <br/>\n\nIn initial testing of batched REGISTER commands, attempts to batch 500 commands into one CREAM called failed with this error:\n<div class=\"code\">\n<pre class=\"code\">EOF detected during communication. Probably service closed connection or SOCKET TIMEOUT occurred.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Feb-28 18:13:06 by jfrey:</em> <br/>\n\nPushed commit to V7_5_6-branch for 7.5.6. Register commands are not batched, but the code is in place for doing so. Status commands are batched and errors are handled correctly.\n\n<p></p><hr/>\n<em>2011-Mar-30 16:35:44 by jfrey:</em> <br/>\n\nPushed commit to V7_6-branch for 7.6.0. REGISTER commands are now batched in groups of 10. This led to a noticeable increase in communication failures, which I fixed by doing retries of the commands properly (was broken before).</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-30 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1fc36303a469660ee586195e5bd252d03fbdb10d\">[25976]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1931\" onclick=\"get_ticket_and_populate_wrapper('1931'); return false;\" title=\"Improve cream_gahp command batching\">#1931</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1985\" onclick=\"get_ticket_and_populate_wrapper('1985'); return false;\" title=\"condor_submit -remote &lt;fails&gt;\">#1985</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2001\" onclick=\"get_ticket_and_populate_wrapper('2001'); return false;\" title=\"vm_gahp leaks fd on script callout\">#2001</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-30 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0e0166ce69f858c7770fabf25cec17dbf726fa6b\">[21203]</a></span>: Retry CREAM REGISTER commands that fail due to network. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1931\" onclick=\"get_ticket_and_populate_wrapper('1931'); return false;\" title=\"Improve cream_gahp command batching\">#1931</a></span> This should have been part of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=955\" onclick=\"get_ticket_and_populate_wrapper('955'); return false;\" title=\"Improve handling of timeout errors for cream jobs\">#955</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1936\" onclick=\"get_ticket_and_populate_wrapper('1936'); return false;\" title=\"Improve handling of network errors for Cream jobs\">#1936</a></span>, but the limit on submit attempts foiled the retries. Batching REGISTER commands makes this failure case frequently enough that we noticed it.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-30 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e9bc9d18596c7421ebe6404546e782608b843afc\">[21202]</a></span>: Batch CREAM REGISTER commands. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1931\" onclick=\"get_ticket_and_populate_wrapper('1931'); return false;\" title=\"Improve cream_gahp command batching\">#1931</a></span> In the cream_gahp, REGISTER commands are now batched in groups of 10. Unrestricted batching led to too many failures. This level of batching doubles submission throughput.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Feb-28 17:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4152d249d7b5cf84494c502ce2605522622e3ece\">[20794]</a></span>: Improve command batching in cream gahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1931\" onclick=\"get_ticket_and_populate_wrapper('1931'); return false;\" title=\"Improve cream_gahp command batching\">#1931</a></span> * Error handling is now correct. If Cream returns a mix of successes and failures for specific jobs, the gahp no longer returns errors for jobs where the command was successful. * Status commands for individual jobs are now batched. * Register commands can\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Mar-30 16:35", "status": "resolved", "created": "2011-Feb-24 22:26", "fixed_version": "2011-Feb-24 22:26", "broken_version": "v070501", "priority": "2", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "#938", "creator": "jfrey", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "", "due_date": "20110331"}