{"id": 1375, "title": "Ticket #1375: reuse shadow processes", "description": "<blockquote>\nWhen operating at high frequency, the schedd spends something like 1/3 of its time creating shadows.  There is additional overhead managing security sessions for the new processes, receiving an initial heartbeat message, and so on.  There is additional overhead to the rest of the system as each new shadow parses the configuration file and initializes <code>DaemonCore</code>.\n\n<p>If the shadow processes were reused for running multiple jobs this overhead would be reduced.  In some tests I have done, this allows the schedd to run jobs at roughly twice the rate.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Apr-23 17:44:36 by danb:</em> <br/>\n\nAdded SHADOW_WORKLIFE, which is the time in seconds after which the shadow will not try to fetch additional jobs.  The default 0 gives the previous behavior of running one job per shadow.\n\n<p></p><hr/>\n<em>2010-May-03 11:45:13 by tstclair:</em> <br/>\n\nDuring the end of the run we see a huge spike in errors on the startd's, when running 60 second sleep jobs.  They characteristically look like the following:\n\n<p><strong>startd:</strong>\n\n</p><p>04/29 23:11:09 attempt to connect to &lt;172.17.1.7:36996&gt; failed: Connection refused (connect errno = 111).\n\n</p><p>04/29 23:11:09 DC_AUTHENTICATE: attempt to open invalid session pman07:10361:1272596978:551, failing.\n\n</p><p>04/29 23:11:09 Failed to send DC_INVALIDATE_KEY to daemon at &lt;172.17.1.7:36996&gt;: SECMAN:2003:TCP connection to daemon at &lt;172.17.1.7:36996&gt; failed.\n\n</p><p>04/29 23:11:09 attempt to connect to &lt;172.17.1.7:42975&gt; failed: Connection refused (connect errno = 111).\n\n</p><p>04/29 23:11:09 DC_AUTHENTICATE: attempt to open invalid session pman07:10361:1272596983:552, failing.\n\n</p><p>04/29 23:11:09 Failed to send DC_INVALIDATE_KEY to daemon at &lt;172.17.1.7:42975&gt;: SECMAN:2003:TCP connection to daemon at &lt;172.17.1.7:42975&gt; failed.\n\n</p><p>&lt;repeat N-slots&gt;\n\n</p><p>However we <strong>do not</strong> see this when running 4 minute sleep jobs, and we did not see this prior to the patch.\n\n</p><p></p><hr/>\n<em>2010-May-04 11:00:23 by danb:</em> <br/>\n\nRegarding the 'invalid session' errors in the startd logs: can you confirm that these invalid session requests are originated by the starters?  When the startd tries to send a message to the daemon that generated the request, it fails to connect to the daemon's address with a message like this:\n\n<p></p><div class=\"verbatim\">\n<pre>04/29 22:17:35 Failed to send DC_INVALIDATE_KEY to daemon at &lt;172.17.1.7:41113&gt;: SECMAN:2003:TCP connection to daemon at &lt;172.17.1.7:41113&gt; failed.\n</pre></div>\n\n\n<p>Does the IP:port number mentioned in this message match up with the starter address?  The starter's address should be logged in the starter log with a message similar to this:\n\n</p><p></p><div class=\"verbatim\">\n<pre>04/29 22:09:32 DaemonCore: Command Socket at &lt;172.17.1.7:40700&gt;\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-May-04 11:17:04 by tstclair:</em> <br/>\n\nYes it matches with the starter address.\n\n<p>We also recently found that if we disable MAX_ACCEPT across the pool you eliminate this issue, so it may not be directly related with this patch.  I still find it to be unusual.\n\n</p><p>We are in the process of setting it only on the schedd to see what affects it has.  I will keep you posted.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1500\" onclick=\"get_ticket_and_populate_wrapper('1500'); return false;\" title=\"Shadow exception when shadow is recyled for use with another job\">#1500</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nShadow exception when shadow is recyled for use with another job</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-May-17 09:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a264e4d53817f3198b6a4302fdcede67dd455d07\">[25488]</a></span>: Documented SHADOW_WORKLIFE. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-May-17 09:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c3b08c3bc2a527aadbb340578a7d7077fef82770\">[18016]</a></span>: Changed default SHADOW_WORKLIFE to one hour. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-May-03 15:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4811118b1e48d73c67d1ecf5045e07cc94b9cbd7\">[17934]</a></span>: Do not pass standard universe jobs to new shadow when recycling shadow. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-28 09:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e9b59ce4a19511a7fce0451f7bda16560732c4b3\">[17924]</a></span>: Fixed problem in SHADOW_WORKLIFE patch that was causing windows build failure. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-26 16:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d81c78c9cdf78e0d31a38b19b94d780e6fc1664f\">[17919]</a></span>: Fixed bug in authentication code path for SHADOW_WORKLIFE. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span> When backported to 7.4 code, the RECYCLE_SHADOW command was not forcing authentication at the security negotiation layer, which exposed a bug in the way authentication was being handled in the RECYCLE_SHADOW command protocol.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-26 12:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aad22c8790c7908dfb4d741497b62cf3d239d154\">[17914]</a></span>: Unset reconnect mode when recycling the shadow. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span> Previously, if the shadow was launched in reconnect mode for the initial job, it would remain in reconnect mode for all subsequent jobs, which is not what was intended.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-26 12:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f19ed9976ebc16a5a1a2de8dd12f0abfcd83a365\">[17913]</a></span>: Added authorization check to RecycleShadow(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span> Previously, it just required DAEMON access. Now it does a job ownership check in addition, like all other queue modifying commands.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-26 10:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2aba976648badbf47bba8694e74af2ebb7b658f4\">[17910]</a></span>: Fixed a bug in SHADOW_WORKLIFE patch. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span> The schedd crashed when running scheduler universe jobs.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Apr-23 16:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a4aefcf0a513096cf168e210b337156e42fbf24e\">[17909]</a></span>: Added SHADOW_WORKLIFE. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1375\" onclick=\"get_ticket_and_populate_wrapper('1375'); return false;\" title=\"reuse shadow processes\">#1375</a></span> Shadows can request a new job rather than exiting after only one job. The default of 0 gives the previous behavior of only running one job per shadow.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-May-04 11:17", "status": "resolved", "created": "2010-Apr-23 16:29", "fixed_version": "2010-Apr-23 16:29", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "other", "visibility": "public", "notify": "dan@hep.wisc.edu, tstclair@redhat.com", "due_date": ""}