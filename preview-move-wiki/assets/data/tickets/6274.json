{"id": 6274, "title": "Ticket #6274: DAGMan doesn't work right with late materialization", "description": "<blockquote>\nDAGMan currently doesn't work right if one of its node jobs uses late materialization.  To test this out, I set SCHEDD_ALLOW_LATE_MATERIALIZE and SUBMIT_FACTORY_JOBS_BY_DEFAULT to true, and made a submit file that does 'queue 10' with max_materialize set to 2.  What happens is that DAGMan sees the submit events for the first two procs in the cluster, and as soon as they are finished it thinks the node job is complete, even though the later procs are still in the queue.</blockquote>", "remarks": "<blockquote>\n<em>2017-May-22 13:26:15 by wenger:</em> <br/>\n\nIn my test, condor_submit outputs this:\n\n<p></p><pre>  10 job(s) submitted to cluster 4955.\n</pre>\n\n<p>which DAGMan could use to figure out how many procs it should look for.\n\n</p><p>However, that output is not available in recovery mode, so I'm thinking that for this to work right in DAGMan we need to have a \"cluster submit\" event and a \"cluster terminated\" event.\n\n</p><p></p><hr/>\n<em>2017-May-23 17:33:34 by wenger:</em> <br/>\n\nAs per today's discussion with Miron:  proposal is to add a flag to submit events saying whether the submit event is the last one for a cluster.  DAGMan could then look for that flag so it can figure out how many jobs there are in the cluster, and thereby, when the cluster is finished.\n\n<p></p><hr/>\n<em>2017-Oct-25 16:40:20 by tim:</em> <br/>\n\n<strong>Doc review:</strong> OK</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6292\" onclick=\"get_ticket_and_populate_wrapper('6292'); return false;\" title=\"Document that DAGMan doesn't work with late materialization\">#6292</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDocument that DAGMan doesn't work with late materialization</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6946\" onclick=\"get_ticket_and_populate_wrapper('6946'); return false;\" title=\"DAGMan fails when retrying jobs using late materialization\">#6946</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDAGMan fails when retrying jobs using late materialization</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7180\" onclick=\"get_ticket_and_populate_wrapper('7180'); return false;\" title=\"Refactor DAGMan so definition of a cluster is consistent\">#7180</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRefactor DAGMan so definition of a cluster is consistent</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-20 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54541\">[54541]</a></span>: Fixed race in DAGMan late materialization test (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-16 18:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52584\">[52584]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=52582\">[52582]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=52583\">[52583]</a></span>, Merging documentation added (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-16 18:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52583\">[52583]</a></span>: Fixed typo (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-16 18:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52582\">[52582]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-05 14:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52508\">[52508]</a></span>: Removed forgottend debug code (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-05 12:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52507\">[52507]</a></span>: Cleaned up test, now .run file generates dag files (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-04 17:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52486\">[52486]</a></span>: Fixed Windows tests (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-03 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52471\">[52471]</a></span>: Removed test code that erased .dag file in Windows (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-03 11:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52470\">[52470]</a></span>: Debugging Windows test failures (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-02 12:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52469\">[52469]</a></span>: Added new test to CMakeLists (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Oct-02 11:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52468\">[52468]</a></span>: Added basic test (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-29 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52452\">[52452]</a></span>: Fixed aborted bug under Windows (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-28 16:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52445\">[52445]</a></span>: Added final factory checks on _queuedNodeJobProcs (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-28 13:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52443\">[52443]</a></span>: Fixed bug where _numSubmittedProcs not getting reset on node restart (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-27 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52442\">[52442]</a></span>: Fixed compiler warnings (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-27 14:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52441\">[52441]</a></span>: Fixed another race on _numJobsSubmitted (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-22 17:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52418\">[52418]</a></span>: More cleanup, added _numSubmittedProcs to Dag logic (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-22 14:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52414\">[52414]</a></span>: Removed debug statements, cleaned up code (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-22 10:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52411\">[52411]</a></span>: Fixed race condition on handling submit event, still debugging and testing (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-14 15:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52353\">[52353]</a></span>: Fixed DAGMan recovery mode with late materialization (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-11 10:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52301\">[52301]</a></span>: Added forgotten files (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-08 13:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52295\">[52295]</a></span>: Basic working DAGMan support for late materialization. Needs more testing. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-07 14:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52288\">[52288]</a></span>: Basic implementation of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FactorySubmit\" title=\"Factory Submit\">FactorySubmit</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FactoryRemove\" title=\"Factory Remove\">FactoryRemove</a></span> log events (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>), (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6456\" onclick=\"get_ticket_and_populate_wrapper('6456'); return false;\" title=\"Add job factory submit and remove log events\">#6456</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-05 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52254\">[52254]</a></span>: Added Cluster Submit + Removed events, removed debug code (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>) (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6456\" onclick=\"get_ticket_and_populate_wrapper('6456'); return false;\" title=\"Add job factory submit and remove log events\">#6456</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-23 14:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52156\">[52156]</a></span>: Added some debug output (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6274\" onclick=\"get_ticket_and_populate_wrapper('6274'); return false;\" title=\"DAGMan doesn't work right with late materialization\">#6274</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Oct-25 16:40", "status": "resolved", "created": "2017-May-22 13:18", "fixed_version": "2017-May-22 13:18", "broken_version": "v080702", "priority": "3", "subsystem": "Dag", "assigned_to": "coatsworth", "derived_from": "", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu, coatsworth@cs.wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}