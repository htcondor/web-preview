{"id": 4163, "title": "Ticket #4163: Schedd crashes when using PeriodicRemove for parallel jobs", "description": "<blockquote>\nIf you submit a parallel job with a periodic remove expression this crashes the scheduler when it tries to remove the job. I experienced this problem in the following scenario:\n\n<p>I'm submitting jobs via -remote to a remote dedicated scheduler. The job itself copies the result data to a central place on a file server and, thus, I don't need to transfer any data back using condor_transfer_data. Therefore, I want the scheduler to remove the job automatically and defined a \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRemove\" title=\"Periodic Remove\">PeriodicRemove</a></span>\" expression in my submit script. If I do this for a parallel job the scheduler crashes when removing the job. Looking at the code I found the problematic part. It seems that during the remove operation of a job cluster the schedd tries to access data structures which have been deleted before. I don't understand the code completely but as I only submit jobs which have a single job per cluster the attached patch helped me to solve the issue for my version of condor. It will be problematic probably if you have multiple clusters in a job, so someone with a better understanding of the code should have a look...</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Feb-05 15:56:29 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>With this change, most of the logic in DestroyProc() is only performed for one proc in the cluster.\nThis includes the following:\n</p><ul>\n<li>Setting <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CompletionDate\" title=\"Completion Date\">CompletionDate</a></span> in the job ad\n</li><li>Checking <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeaveJobInQueue\" title=\"Leave Job In Queue\">LeaveJobInQueue</a></span> (though probably don't want to leave only some of the procs in the queue)\n</li><li>Writing to the history file\n</li><li>Writing the per-job history file\n</li></ul>\n\n<p>I presume in the common case that DestroyProc() is called on proc_id 0. But can be cases where it's called on another proc_id in the cluster first. In some places, DestroyProc() will be called on jobs in hashtable order as part of WalkJobQueue().\n\n</p><p></p><hr/>\n<em>2014-Feb-10 13:26:01 by gthain:</em> <br/>\n\nNote that the above are all for parallel jobs with multiple procs, which are conceptually one job, so we want one history file entry, and one Completion time for them.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/816/parallel_remove.patch\">parallel_remove.patch</a>\n2141 bytes added by f.wolfheimer on 2014-Jan-17 10:05:37 UTC.\n<br/>\nThe patch which fixes the problem. Probably problematic if more than one cluster per job!?<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-27 16:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c49fb41e3993f730d0717a7c31b2effb90ddf50\">[39249]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4163\" onclick=\"get_ticket_and_populate_wrapper('4163'); return false;\" title=\"Schedd crashes when using PeriodicRemove for parallel jobs\">#4163</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-27 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fbfd9e5f88da9adadf95ccae51280c22a4434a97\">[39247]</a></span>: Fix parallel universe schedd crash <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4163\" onclick=\"get_ticket_and_populate_wrapper('4163'); return false;\" title=\"Schedd crashes when using PeriodicRemove for parallel jobs\">#4163</a></span> Problem was a re-entrant walking of the job queue. Only triggered when periodic expression tried to remove a parallel universe job.  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-10 13:26", "status": "resolved", "created": "2014-Jan-17 04:04", "fixed_version": "2014-Jan-17 04:04", "broken_version": "v080005", "priority": "2", "subsystem": "Parallel", "assigned_to": "gthain", "derived_from": "", "creator": "f.wolfheimer", "rust": "", "customer_group": "users", "visibility": "public", "notify": "felix.wolfheimer@cst.com tannenba@cs.wisc.edu", "due_date": ""}