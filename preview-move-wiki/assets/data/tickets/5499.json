{"id": 5499, "title": "Ticket #5499: shadow can hang while rotating log when max log > 1", "description": "<blockquote>\nVia rust, we have a report that a shadow was seen spinning in cleanUpOldLogFiles and other shadows locked waiting for it to release the rotation lock.\n\n<p>The customer used a debugger to determine that the problem is that the current directory is not the condor log directory, and that the <code>rotate_file(oldname,newname)</code> call in cleanUpOldLogFiles was being passed a simple filename as oldname, and a fully qualified filename as newname.\n\n</p><p>This is equivalent to calling <code>rotate_file(pwd+oldname,newname)</code>, which is not what this code is supposed to do, but which would work if the pwd is the log directory.  If it isn't, then the while loop in cleanUpOldLogFiles will never exit, and that shadow will never give up the rotation lock.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Feb-01 15:23:54 by johnkn:</em> <br/>\n\nAdding a quick fix for 8.4.4 that will prevent the deadlock, but will result in excess shadow logs never being deleted.\n\n<p></p><hr/>\n<em>2016-Feb-01 17:51:13 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: The actual fix looks good! In the defensive coding, adding \"Something is very wrong\" to the log message does not add any information and implies that the problem is worse than it is.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-01 17:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a6dcac754f86cb91aee07f97a32be9be830d8fac\">[47536]</a></span>: Minor version history edit for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5499\" onclick=\"get_ticket_and_populate_wrapper('5499'); return false;\" title=\"shadow can hang while rotating log when max log &gt; 1\">#5499</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-01 16:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b3df09d1bed8ec16506b326d612caa179583729e\">[47535]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5499\" onclick=\"get_ticket_and_populate_wrapper('5499'); return false;\" title=\"shadow can hang while rotating log when max log &gt; 1\">#5499</a></span>, shadow fails to clean up old shadow logs and eventually hangs when MAX_NUM_SHADOW_LOG &gt; 1 ===VersionHistory:Complete===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-01 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3db0e25d39317d039da948326baab13eae405d20\">[47532]</a></span>: incomplete fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5499\" onclick=\"get_ticket_and_populate_wrapper('5499'); return false;\" title=\"shadow can hang while rotating log when max log &gt; 1\">#5499</a></span>. this fix will insure that cleanUpOldLogFiles will always exit eventually. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Feb-05 11:36", "status": "resolved", "created": "2016-Feb-01 15:23", "fixed_version": "2016-Feb-01 15:23", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "s8597", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}