{"id": 528, "title": "Ticket #528: BNL schedd periodic expression eval excessively infrequent", "description": "<blockquote>\nThe ATLAS group at BNL submit large numbers of Panda pilot jobs with the following job policy:\n<div class=\"code\">\n<pre class=\"code\">LeaveJobInQueue = JobStatus == 4\nPeriodicRemove = (JobStatus == 4 &amp;&amp; (CurrentTime - EnteredCurrentStatus) &gt; 300)\n</pre></div>\n\n\n<p>They report that occasionally, large numbers of jobs in Completed state pile up despite this policy. When I looked at the latest pileup today, they had 29000 jobs in the queue, with roughly 28000 that should have been removed by the <span class=\"quote\">PeriodicRemove</span> expression. Some of the jobs had been in Completed state for over 12 hours.\n\n</p><p>I suspect the Timeslice code is causing the time between periodic expression evaluations to grow excessively when the number of jobs in the queue becomes large.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-May-27 16:49:41 by jfrey:</em> <br/>\n\nAs a workaround, I've asked BNL if they can remove the <span class=\"quote\">LeaveJobInQueue</span> expression from their jobs.\n\n<p></p><hr/>\n<em>2009-May-27 16:56:03 by jfrey:</em> <br/>\n\nI looked at some BNL logs from yesterday, where the periodic expression evaluation took at least 6.5 minutes to run. The logs rolled, so I don't know when it started. At the default PERIODIC_EXPR_TIMESLICE setting of 0.01, that means the expressions won't be re-evaluated for 650 minutes (11 hours).\n\n<p></p><hr/>\n<em>2009-May-27 20:17:13 by xzhao:</em> <br/>\n\nI asked Torre, and he agrees to remove these policies from the ATLAS panda pilot condor-g submit file.\n\n<p>Xin\n\n</p><p></p><hr/>\n<em>2009-May-27 21:18:47 by jfrey:</em> <br/>\n\nOne reason the evaluation of the periodic expressions took so long at BNL was that <span class=\"quote\">PeriodicRemove</span> evaluated to true for many of the jobs. The subsequent removal of the jobs counts as part of the time to evaluate the expressions.\n\n<p></p><hr/>\n<em>2009-May-29 02:06:47 by danb:</em> <br/>\n\nWe definitely need to add an upper bound to the periodic expression timeslice interval to prevent insane things like this.  I'll do that.\n\n<p></p><hr/>\n<em>2009-May-29 07:51:52 by tannenba:</em> <br/>\n\nExcellent, thanks Dan.  Patch committed into the master, gonna resolve this ticket.  Note to Jaime - BNL won't get this until we merge the BNL branch back to the master..</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-29 02:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5dcca0a95fb36c22528d940cb39f86554d35b5bc\">[14789]</a></span>: Added MAX_PERIODIC_EXPR_INTERVAL, with default 1200 seconds. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=528\" onclick=\"get_ticket_and_populate_wrapper('528'); return false;\" title=\"BNL schedd periodic expression eval excessively infrequent\">#528</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Jan-31 08:36", "status": "resolved", "created": "2009-May-27 16:16", "fixed_version": "2009-May-27 16:16", "broken_version": "v070300", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "matt@cs.wisc.edu", "due_date": ""}