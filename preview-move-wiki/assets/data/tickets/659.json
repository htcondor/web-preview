{"id": 659, "title": "Ticket #659: Add a log reader file descriptor throttle to DAGMan", "description": "<blockquote>\nNote: I was manually running a large DAG test with a 20,000 x 5 node DAG, and this failed because of running out of file descriptors when it went into recovery mode.\n\n<p>What I have in mind is that there would be some way to tell the lazy log file code to only have n file descriptors open at any given time, and it would open and close files as necessary to maintain that.  One simple (but non-optimal) way to reduce the FD use in a DAG with lots of parallel nodes would be to just open and close each log file each time we look at it.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Aug-10 13:35:32 by matt:</em> <br/>\n\nIt's better to have a limit. Open and close on each event/read is a performance killer. It is currently making the EVENT_LOG quite slow.\n\n<p>Can the immediate problem of the large dag test be changed to use fewer log files?\n\n</p><p></p><hr/>\n<em>2009-Aug-10 13:59:57 by wenger:</em> <br/>\n\nThe problem is not really that I got the large DAG test to fail -- the\nproblem is that a real user might conceivable generate a DAG that would\nrequire a similar number of log files to be read.\n\n<p>I don't think this is real urgent, because we're at least no worse off with the new \"lazy log file\" code than with the old code.  But if a user has a very \"wide\" DAG, it's still possible for DAGMan to really have a lot of log files open at the same time.\n\n</p><p></p><hr/>\n<em>2010-Oct-14 11:28:51 by wenger:</em> <br/>\n\nI've marked this ticket as active, and assigned it to Pete, because Filip Krikava is working on this, and Pete is the one who's working most closely with him.\n<hr/>\n<em>2011-Jan-27 14:21:33 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n<hr/>\n<em>2011-Feb-01 14:49:30 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2011-Mar-30 11:00:47 by psilord:</em> <br/>\n\nWe have Filip's final patch, but Kent, Cathrin, and I haven't had time to tweak it the final ways it needs tweaking and put it into the codebase. So this ticket is stalled until we can get together and do it.\n\n<p></p><hr/>\n<em>2011-Apr-11 13:58:19 by psilord:</em> <br/>\n\nKent and I agreed last week sometime that this finally needs to go into the master. Kent is trying to put the patch into the sources and check out how well it works.\n\n<p></p><hr/>\n<em>2011-Apr-11 14:26:25 by nwp:</em> <br/>\n\nOK, then I will put it into master, after I get it to compile.\n\n<p></p><hr/>\n<em>2011-Apr-11 14:33:17 by wenger:</em> <br/>\n\nWell, I think this should go onto its own branch.  We'll have a ton of testing to do after it compiles to make sure it actually works right.\n\n<p></p><hr/>\n<em>2011-Apr-11 14:48:51 by tannenba:</em> <br/>\n\nReminder - please plan on creating a child ticket that discusses how to regression test this work. Thanks!\n\n<p></p><hr/>\n<em>2011-Apr-11 15:03:10 by nwp:</em> <br/>\n\nThis has been pushed to the git repository on the branch\n\n<p>V7_7-add_dagman_fd_throttle-branch\n\n</p><p></p><hr/>\n<em>2011-Apr-13 09:05:30 by nwp:</em> <br/>\n\nIt seems like Kent has some ideas to test the patch; should I reassign the ticket back to Kent or should we meet and hash out what needs to be done?\n\n<p></p><hr/>\n<em>2011-Apr-13 11:44:31 by wenger:</em> <br/>\n\nI'll assign this to myself because I'm currently running the existing tests against it.  Several have failed so far -- I'll post a list once I'm done.\n\n<p></p><hr/>\n<em>2011-Apr-13 15:18:47 by wenger:</em> <br/>\n\nI just manually ran the existing tests with the FD throttle code, and the following tests failed:\n\n<p></p><pre>  job_dagman_jobstate_log\n  job_dagman_noop_node\n  job_dagman_prepost\n  job_dagman_rescue-A\n  job_dagman_rescue_recov\n  job_dagman_splice-P.run\n  job_dagman_subdag_in_splice-A\n</pre>\n\n<p>So we have some work to do...\n\n</p><p></p><hr/>\n<em>2011-Apr-14 11:05:30 by wenger:</em> <br/>\n\nAll of the failed tests except the splice-P test are getting the same error:\n\n<p></p><pre>  04/14/11 10:30:20 Currently monitoring 1 Condor log file(s)\n  04/14/11 10:30:20 lock_file returning ERROR, errno=9 (Bad file descriptor)\n  04/14/11 10:30:20 FileLock::obtain(1) failed - errno 9 (Bad file descriptor)\n  04/14/11 10:30:20 ERROR \"Assertion ERROR on (m_lock-&gt;isLocked())\" at line 1353 in file /scratch.1/wenger/condor_build/condor_git6/CONDOR_SRC/src/condor_utils/read_user_log.cpp\n</pre>\n\n<p></p><hr/>\n<em>2011-Apr-14 13:15:51 by wenger:</em> <br/>\n\nHmm, I'm digging around in the log file code right now, and given what I'm seeing we'll need to specifically test this on Windows, and with old-style file locking, because there are different code paths for those cases.  (Once we actually get it working in the \"normal\" case...)\n\n<p></p><hr/>\n<em>2011-Apr-14 14:54:06 by wenger:</em> <br/>\n\nOkay, the failures of the existing tests seem to be a conflict between the FD throttling code and the \"new\" file locking code.  (If I set ENABLE_USERLOG_LOCKING to false, the tests succeed.)\n\n<p></p><hr/>\n<em>2011-Apr-15 11:15:16 by wenger:</em> <br/>\n\nNathan re-did the patch yesterday and fixed some problems with how it was applied.  I pulled the update, but it still fails with the same problem.\n\n<p></p><hr/>\n<em>2011-Aug-26 12:34:18 by smoler:</em> <br/>\n\nThere's no fixed version field for this ticket, and no changes since April.  There is, however, a commented-out 7.7.1 version history item that refers to this ticket. Karen is moving the still-commented-out item to 7.7.2, and hopes that y'all will update this ticket.\n\n<p></p><hr/>\n<em>2011-Aug-26 12:39:09 by wenger:</em> <br/>\n\nHmm, at this point I'd say you might as well just remove that version history item.\n\n<p></p><hr/>\n<em>2012-Jan-14 08:35:30 by nwp:</em> <br/>\n\nBrian Bockelman wants to use inotify to make handling log files more scalable.  I am adding him to the notify list on this ticket.\n\n<p></p><hr/>\n<em>2012-Jan-31 11:42:16 by wenger:</em> <br/>\n\nAlso see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2759\" onclick=\"get_ticket_and_populate_wrapper('2759'); return false;\" title=\"Multi-log reading code is very inefficient on very wide DAGs\">#2759</a></span>.  At this point I think we probably want to go with something inotify-based rather than trying to merge (or re-implement) Filip's code.\n\n<p></p><hr/>\n<em>2012-Jan-31 12:07:06 by bbockelm:</em> <br/>\n\nYou can see how we handle it here:\n\n<p><a class=\"external\" href=\"https://github.com/mattf/condor_job_queue_publisher\">https://github.com/mattf/condor_job_queue_publisher</a>\n\n</p><p>The basic idea is to use inotify as a \"hint\" that data is available, and drastically reduce the polling interval.  In the end, you still must poll the files because inotify is not infallible.  It's just pretty dang good.\n\n</p><p>In terms of the number of file descriptors, inotify is going to use one file descriptor per instance, but you have to manage something else called \"watch descriptors\".  These still are going to take up memory (kernel and application side), but aren't counted against your fd limit.\n\n</p><p>Unfortunately, I can't offer any insights into the equivalent entities in Windows.\n\n</p><p></p><hr/>\n<em>2012-Jan-31 12:11:18 by nwp:</em> <br/>\n\nI am pretty sure you mean to \"increase\" the polling interval, so as to \"decrease\" the frequency of polling.\n\n<p></p><hr/>\n<em>2012-May-22 14:29:52 by pfc:</em> <br/>\n\nI am told this is to be addressed by <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2807\" onclick=\"get_ticket_and_populate_wrapper('2807'); return false;\" title=\"Have DAGMan use a single node job user log file\">#2807</a></span>.\n\n<p></p><hr/>\n<em>2012-Sep-04 14:57:46 by nwp:</em> <br/>\n\nThis ticket ticket is dead.  We worked around it in <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2807\" onclick=\"get_ticket_and_populate_wrapper('2807'); return false;\" title=\"Have DAGMan use a single node job user log file\">#2807</a></span>, which was merged into 7.9.0.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2053\" onclick=\"get_ticket_and_populate_wrapper('2053'); return false;\" title=\"Regression test ticket for dagman fd throttle\">#2053</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRegression test ticket for dagman fd throttle</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2759\" onclick=\"get_ticket_and_populate_wrapper('2759'); return false;\" title=\"Multi-log reading code is very inefficient on very wide DAGs\">#2759</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMulti-log reading code is very inefficient on very wide DAGs</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/316/condor_fdt_251110.patch\">condor_fdt_251110.patch</a>\n21360 bytes added by wenger on 2011-Apr-11 17:38:47 UTC.\n<br/>\nThis is the final patch from Filip.<br/>\n</li><li><a href=\"../files/317/condor_fdt_251110_part.patch\">condor_fdt_251110_part.patch</a>\n7999 bytes added by wenger on 2011-Apr-11 17:39:30 UTC.\n<br/>\nI'm not sure what \"part\" means in this patch -- Filip also sent it in the \"final FD patch\" email.<br/>\n</li><li><a href=\"../files/318/659-patch-updated\">659-patch-updated</a>\n20150 bytes added by nwp on 2011-Apr-11 18:38:10 UTC.\n<br/>\nI got the attached patch to apply cleanly to git master at 361ef39 (current master as of 10 April 2011).  I can push it up to the git repo if wanted.  Note that the condor_fdt_251110_part.patch is apparently already included in condor_fdt_251110.patch as <code>patch</code> complained about \"Reversed (or previously applied) patch detected!\"<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-02 22:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=31907\">[31907]</a></span>: Use new macro capability in DAGman DAGman now requests the schedd and shadow to write each event to the default log, i.e., &lt;DAG file&gt;.nodes.log, along with whatever log is specified by the user.\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-21 13:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26098\">[26098]</a></span>: Add version history about Dagman file descriptor throttling The ticket is <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=659\" onclick=\"get_ticket_and_populate_wrapper('659'); return false;\" title=\"Add a log reader file descriptor throttle to DAGMan\">#659</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-14 16:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21407\">[21407]</a></span>: The previous commit does not compile The ticket is <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=659\" onclick=\"get_ticket_and_populate_wrapper('659'); return false;\" title=\"Add a log reader file descriptor throttle to DAGMan\">#659</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-14 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21403\">[21403]</a></span>: Include some \"missing\" patches The ticket is <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=659\" onclick=\"get_ticket_and_populate_wrapper('659'); return false;\" title=\"Add a log reader file descriptor throttle to DAGMan\">#659</a></span> Somehow I lost these patches when I merged before. I probably was not careful when I merged the first time.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-14 14:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21399\">[21399]</a></span>: This is the best guess as to where Filip patched the code The paths in his patch were to condor_utils, whereas the ones below are to condor_c++_util. The ticket is <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=659\" onclick=\"get_ticket_and_populate_wrapper('659'); return false;\" title=\"Add a log reader file descriptor throttle to DAGMan\">#659</a></span> Filip's patch applied cleanly other than the above.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-11 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21327\">[21327]</a></span>: Add a log reader file descriptor throttle A patch from Filip Krikava to address the issue. The ticket is <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=659\" onclick=\"get_ticket_and_populate_wrapper('659'); return false;\" title=\"Add a log reader file descriptor throttle to DAGMan\">#659</a></span> Committer: Nathan W. Panike  (By Filip Krikava )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Sep-04 14:58", "status": "defer", "created": "2009-Aug-10 12:53", "fixed_version": "2009-Aug-10 12:53", "broken_version": "v070302", "priority": "5", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "wenger@cs.wisc.edu,tannenba@cs.wisc.edu,bbockelm@cse.unl.edu,pcouvare@caltech.edu", "due_date": ""}