{"id": 7651, "title": "Ticket #7651: OFFLINE_MACHINE_RESOURCE_<tag> should work on reconfig for d-slots", "description": "<blockquote>\nthe configuration <code>OFFLINE_MACHINE_RESOURCE_&lt;tag&gt;</code> is currently only read on startup of the Startd.   It would be more useful if it was also read on reconfig.\n\n<p>This will require some special case code in the Startd because we <strong>cant</strong> reassign resources on reconfig, so the code will have to pick up the offline knob, and then Adjust the <code>Offline&lt;Tag&gt;</code> attribute in the p-slot and all unclaimed slots.  It will then have to pay attention to the <code>Offline&lt;Tag&gt;</code> attribute when moving GPUs between d-slot and p-slot, and when reporting the number of resources through the <code>&lt;Tag&gt;</code> attribute and <code>Total&lt;Tag&gt;</code> attribute.\n\n</p><p>this will have the effect of making it a restart pref for partitionable slots, and allow Static slots the opportunity to choose to not match jobs if their GPUs go offline.\n\n</p><p>Resources that are marked offline at startup will still require a restart to put them online, because the offline resources will not be assigned to any slot.\n\n</p><p>Resources that are marked offline after the Startd has assigned resources, will be added to the offline list, but will not removed from any of the slot resource assignments.  Thus resources that are marked offline at runtime, can be put back online at runtime as well, with the original slot resource assignments preserved.\n\n</p><p><span class=\"subsubsection\"></span></p><h4>GPUs example</h4>\n\n<p>In the following example, GPU device indices are used to make the example easier to read, but If you use offline resources, and particularly if you use <strong>nvidia-smi</strong> to drain GPUs, you should add the <strong>-short-uuid</strong> or <strong>-uuid</strong> option to <code>GPU_DISCOVERY_EXTRA</code> in your configuration so that GPUS have stable identifiers such as <code>GPU-af3457b1</code> instead of <code>CUDA1</code>.\n\n</p><p>The following config </p><div class=\"snip\">\n<pre class=\"sniplabel\">config fragment</pre>\n<pre class=\"snip\">MACHINE_RESOURCE_GPUs=CUDA0, CUDA1, CUDA2\nOFFLINE_MACHINE_RESOURCE_GPUS=CUDA1</pre></div>\n\nCould result in the following slot attributes\n<div class=\"verbatim\">\n<pre>Name = \"slot1@bob\"\nGPUs = 1\nTotalGPUs = 2\nAssignedGPUs = \"CUDA0, CUDA2\"\nOfflineGPUs = \"CUDA1\"\n\nName \"slot1_1@bob\"\nGPUs = 1\nTotalGPUs = 2\nAssignedGPUs = \"CUDA0\"\nOfflineGPUS = \"CUDA1\"\n</pre></div>\n\n\n<p>If you then change the config to this </p><div class=\"snip\">\n<pre class=\"sniplabel\">config fragment</pre>\n<pre class=\"snip\">MACHINE_RESOURCE_GPUs=CUDA0, CUDA1, CUDA2\nOFFLINE_MACHINE_RESOURCE_GPUS=CUDA0</pre></div>\n\nAnd reconfig but <strong>not</strong> restart,  the slot attributes should change to this until the job in the d-slot completes\n\n<p></p><div class=\"verbatim\">\n<pre>Name = \"slot1@bob\"\nGPUs = 1\nTotalGPUs = 1\nAssignedGPUs = \"CUDA0, CUDA2\"\nOfflineGPUs = \"CUDA0,CUDA1\"\n\nName \"slot1_1@bob\"\nGPUs = 0\nTotalGPUs = 1\nAssignedGPUs = \"CUDA0\"\nOfflineGPUS = \"CUDA0,CUDA1\"\n</pre></div>\n\n\n<p>Since <code>CUDA1</code> was offline at startup, it remains offline.  Also the count of GPUs in the d-slot is now 0. Because of this, when the current job completes, the d-slot will no longer match a GPU requesting job, and will likely be deleted.  Any new d-slot will be assigned <code>CUDA2</code> since that is the only non-offline GPU assigned to the p-slot.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-01 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60042\">[60042]</a></span>: docs and version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7696\" onclick=\"get_ticket_and_populate_wrapper('7696'); return false;\" title=\"GPU discovery should report stable GPU ids\">#7696</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7651\" onclick=\"get_ticket_and_populate_wrapper('7651'); return false;\" title=\"OFFLINE_MACHINE_RESOURCE_&lt;tag&gt; should work on reconfig for d-slots\">#7651</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-03 14:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59784\">[59784]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7651\" onclick=\"get_ticket_and_populate_wrapper('7651'); return false;\" title=\"OFFLINE_MACHINE_RESOURCE_&lt;tag&gt; should work on reconfig for d-slots\">#7651</a></span>. OFFLINE_MACHINE_RESOURCE_&lt;tag&gt; is now read on reconfig, allowing a resource (like GPUs) to be taken offline without restarting the Startd. Slot resource assigments will not be affected until restart. but new jobs will not match to slots with offline resources. ===VersionHistory:Pending===\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Jul-01 14:49", "status": "resolved", "created": "2020-May-21 10:33", "fixed_version": "2020-May-21 10:33", "broken_version": "", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "users", "visibility": "public", "notify": "", "due_date": ""}