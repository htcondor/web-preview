{"id": 4522, "title": "Ticket #4522: priv-state code may unset supplemental groups", "description": "<blockquote>\nThe priv-state code has some strange behavior.  If call sites are not very careful, the supplemental groups may become unset.  For instance, this could happen if the user uid/gid is reinitialized when already in user priv-state.  This land-mine was stepped on in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4437\" onclick=\"get_ticket_and_populate_wrapper('4437'); return false;\" title=\"Shadow does not initialize supplemental groups properly\">#4437</a></span>.  In <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4437\" onclick=\"get_ticket_and_populate_wrapper('4437'); return false;\" title=\"Shadow does not initialize supplemental groups properly\">#4437</a></span>, we just did a minimal fix of the call-site in the shadow since it was in the stable series.  With this ticket, we want a solution in the developer series that prevents a future developer from stepping on the same land mine: either the priv-sep code should deal with this sequence of invocations correctly, or if this is overly difficult to fix, at least it should assert/execept with a clear error message and comments in the code.  But what is not acceptable is just leaving the code in a state whereby user priv info may be silently dropped like we observed in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4437\" onclick=\"get_ticket_and_populate_wrapper('4437'); return false;\" title=\"Shadow does not initialize supplemental groups properly\">#4437</a></span>.</blockquote>", "remarks": "<blockquote>\n<em>2014-Aug-07 11:48:36 by tannenba:</em> <br/>\n\nAssigned to Jaime since he is very familiar with this part of the code, as he just finished debugging it all to fix <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4437\" onclick=\"get_ticket_and_populate_wrapper('4437'); return false;\" title=\"Shadow does not initialize supplemental groups properly\">#4437</a></span>.  Hoping he can insert a few EXCEPTs in now while the code is fresh in his mind.  Then Zach should code review.\n\n<p></p><hr/>\n<em>2014-Aug-07 16:46:17 by jfrey:</em> <br/>\n\nAnother bad sequence in the priv-state code is trying to switch to user privilege before initializing which account that use. In that case, you end up as root.\n\n<p></p><hr/>\n<em>2015-Oct-23 11:19:35 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good, ship it!\n\n<p></p><hr/>\n<em>2015-Nov-20 10:28:15 by bbockelm:</em> <br/>\n\n<strong>GOOGLE BAIT</strong>:\n\n<p>For folks happening upon this ticket via Google, NOTE it was committed in 8.4.1 and reverted in 8.4.2.\n\n</p><p>The history and metadata of this ticket make it difficult to follow this fact.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5467\" onclick=\"get_ticket_and_populate_wrapper('5467'); return false;\" title=\"Prevent bad privilege state change sequences\">#5467</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nPrevent bad privilege state change sequences</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-05 16:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46209\">[46209]</a></span>: Update version history for schedd EXCEPT problem. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-05 12:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46203\">[46203]</a></span>: Revert \"Add guards to prevent bad user priv state call sequences. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>\" This reverts commit f144c412e957bb14754d0abf311540d53e8fddf9.  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-04 23:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46200\">[46200]</a></span>: Revert \"Docs for priv-state code bullet-proofing. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>\" This reverts commit afb88954289e0192afc8d3cbc5caa83903f22b1a. Conflicts: doc/version-history/8-4.history.tex  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-04 23:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46199\">[46199]</a></span>: Revert \"Guard against bad user priv calls only if we can switch uids. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>\" This reverts commit 7c98bdbfd3c70ef8567215f89cc097bad219b514.  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Nov-04 23:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46198\">[46198]</a></span>: Revert \"Add guards to prevent bad user priv state call sequences. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>\" This reverts commit f144c412e957bb14754d0abf311540d53e8fddf9.  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-23 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=46086\">[46086]</a></span>: Docs for priv-state code bullet-proofing. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-03 22:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45792\">[45792]</a></span>: Guard against bad user priv calls only if we can switch uids. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span> Switching to user priv without setting the user id is only an issue if the process can actually switch uids (i.e. it's root). This guard was triggering in the starter when not run as root.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Sep-03 13:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45786\">[45786]</a></span>: Add guards to prevent bad user priv state call sequences. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4522\" onclick=\"get_ticket_and_populate_wrapper('4522'); return false;\" title=\"priv-state code may unset supplemental groups\">#4522</a></span> Don't allow user priv ids to be modified while in user priv state. Don't allow switching to user priv state if user ids aren't set.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Nov-20 10:28", "status": "resolved", "created": "2014-Aug-07 11:47", "fixed_version": "2014-Aug-07 11:47", "broken_version": "v080000", "priority": "2", "subsystem": "Security", "assigned_to": "jfrey", "derived_from": "#4437", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}