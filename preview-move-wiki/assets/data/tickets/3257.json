{"id": 3257, "title": "Ticket #3257: Implement USE_GLOBAL_JOB_PRIOS mechanism in the negotiator", "description": "<blockquote>\nAs a development milestone in support of honoring job priorities across multiple schedds,\nmodify the Negotiator to support the <code>USE_GLOBAL_JOB_PRIOS</code> config knob.\n\n<p>See the parent ticket for the design document and further details.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Oct-16 11:18:54 by tannenba:</em> <br/>\n\n<span class=\"subsection\"><h3>Testing </h3></span>\n\n<p><span class=\"subsubsection\"></span></p><h4>Setup of test environment</h4>\nSetup a personal Condor pool, making certain the config is using global job prios, and take the schedd out of the daemon list:\n<div class=\"code\">\n<pre class=\"code\">daemon_list = master, collector, startd, negotiator\nuse_global_job_prios = true\n</pre></div>\n\nNext we want the pool to have two schedds, schedd1 and schedd2. To accomplish this, each schedd could have its own copy of the condor_config with customized values for <code>SCHEDD_NAME</code>, <code>LOCAL_DIR</code>, and if testing on Windows we also need to edit <code>PROCD_ADDRESS</code>.  So the condor_config.schedd1 would have\n<div class=\"code\">\n<pre class=\"code\">SCHEDD_NAME = schedd1\nLOCAL_DIR = c:\\wherever\\localdirs\\schedd1\nPROCD_ADDRESS = \\\\.\\pipe\\condor_procd_pipe\n</pre></div>\n\nand the condor_config.schedd2 would have\n<div class=\"code\">\n<pre class=\"code\">SCHEDD_NAME = schedd2\nLOCAL_DIR = c:\\wherever\\localdirs\\schedd2\nPROCD_ADDRESS = \\\\.\\pipe\\condor_procd_pipe2\n</pre></div>\n\nIn the <code>LOCAL_DIR</code> paths specified, create the expected sub-directories like so:\n<div class=\"code\">\n<pre class=\"code\">cd c:\\wherever\\localdirs\\schedd1\nmkdir log spool execute\ncd c:\\wherever\\localdirs\\schedd1\nmkdir log spool execute\n</pre></div>\n\nFire up the daemons and confirm the pool sees the two schedds named schedd1 and schedd2 as expected\n<div class=\"code\">\n<pre class=\"code\">C:\\home\\tannenba&gt;set CONDOR_CONFIG=c:\\wherever\\condor_config\nC:\\home\\tannenba&gt;condor_master\nC:\\home\\tannenba&gt;set CONDOR_CONFIG=c:\\wherever\\condor_config.schedd1\nC:\\home\\tannenba&gt;condor_schedd\nC:\\home\\tannenba&gt;set CONDOR_CONFIG=c:\\wherever\\condor_config.schedd2\nC:\\home\\tannenba&gt;condor_schedd\nC:\\home\\tannenba&gt;condor_status -any\n\nMyType               TargetType           Name\n\nMachine              Job                  ToddsThinkpad\nDaemonMaster         None                 ToddsThinkpad\nNegotiator           None                 ToddsThinkpad\nScheduler            None                 schedd1@ToddsThinkpad\nScheduler            None                 schedd2@ToddsThinkpad\nCollector            None                 tannenba test pool@ToddsThinkp\n</pre></div>\n\n\n<p><span class=\"subsubsection\"></span></p><h4>Basic Test</h4>\nTurn off the negotiator, since we don't want a negotiation cycle to happen until we have submitted all our jobs to all schedds. Create two job submit files that have job priorities that overlap each other, and submit one to schedd1 and the other to schedd2. Then turn the negotiator back on.\n<div class=\"code\">\n<pre class=\"code\">C:\\home\\tannenba\\condor\\build_79\\test&gt;type test1.sub\nexecutable = c:\\utils\\date.exe\ninitialdir = c:\\temp\npriority = 100\nqueue 1\npriority = 50\nqueue 3\npriority = -5\nqueue 2\n\nC:\\home\\tannenba\\condor\\build_79\\test&gt;type test2.sub\nexecutable = c:\\utils\\date.exe\ninitialdir = c:\\temp\npriority = 90\nqueue 1\npriority = 92\nqueue 1\npriority = 52\nqueue 3\npriority = -5\nqueue 2\n\nC:\\home\\tannenba\\condor\\build_79\\test&gt;condor_off -negotiator\nSent \"Kill-Daemon\" command for \"negotiator\" to local master\n\nC:\\home\\tannenba\\condor\\build_79\\test&gt;condor_submit -n schedd1@ToddsThinkpad test1.sub\nSubmitting job(s)\n......\n6 job(s) submitted to cluster 7.\n\nC:\\home\\tannenba\\condor\\build_79\\test&gt;condor_submit -n schedd2@ToddsThinkpad test2.sub\nSubmitting job(s)\n.......\n7 job(s) submitted to cluster 3.\n\nC:\\home\\tannenba\\condor\\build_79\\test&gt;condor_q -global\n\n\n-- Schedd: schedd2@ToddsThinkpad : &lt;127.0.0.1:50212&gt;\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n   3.0   tannenba       10/16 10:54   0+00:00:00 I  90  0.0  date.exe\n   3.1   tannenba       10/16 10:54   0+00:00:00 I  92  0.0  date.exe\n   3.2   tannenba       10/16 10:54   0+00:00:00 I  52  0.0  date.exe\n   3.3   tannenba       10/16 10:54   0+00:00:00 I  52  0.0  date.exe\n   3.4   tannenba       10/16 10:54   0+00:00:00 I  52  0.0  date.exe\n   3.5   tannenba       10/16 10:54   0+00:00:00 I  -5  0.0  date.exe\n   3.6   tannenba       10/16 10:54   0+00:00:00 I  -5  0.0  date.exe\n\n7 jobs; 0 completed, 0 removed, 7 idle, 0 running, 0 held, 0 suspended\n\n\n-- Schedd: schedd1@ToddsThinkpad : &lt;127.0.0.1:50201&gt;\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n   7.0   tannenba       10/16 10:53   0+00:00:00 I  100 0.0  date.exe\n   7.1   tannenba       10/16 10:53   0+00:00:00 I  50  0.0  date.exe\n   7.2   tannenba       10/16 10:53   0+00:00:00 I  50  0.0  date.exe\n   7.3   tannenba       10/16 10:53   0+00:00:00 I  50  0.0  date.exe\n   7.4   tannenba       10/16 10:53   0+00:00:00 I  -5  0.0  date.exe\n   7.5   tannenba       10/16 10:53   0+00:00:00 I  -5  0.0  date.exe\n\n6 jobs; 0 completed, 0 removed, 6 idle, 0 running, 0 held, 0 suspended\n\nC:\\home\\tannenba\\condor\\build_79\\test&gt;condor_on -negotiator\nSent \"Spawn-Daemon\" command for \"negotiator\" to local master\n\n</pre></div>\n\n\n<p>After one negotiation cycle, confirm that the negotiator contacted the two different schedds in the proper global job prio order and properly limiting the job priority range. Also confirm that the schedd sent only job requests in the requested priority range, sorted in job prio order (compare the output below with the condor_q -global output above).  Note the schedd will not send two jobs with the same prio since the negotiator added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobPrio\" title=\"Job Prio\">JobPrio</a></span> as a significant attribute.\n</p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\log&gt;grep -e \"Negotiating\\|USE_GLOBAL_JOB\\|Request\" NegotiatorLog | grep -v schedds\n10/16/12 10:55:51   Negotiating with tannenba@ToddsThinkpad at &lt;127.0.0.1:50201&gt;\n10/16/12 10:55:51     USE_GLOBAL_JOB_PRIOS limit to jobprios between 100 and 100\n10/16/12 10:55:51     Request 00007.00000:\n10/16/12 10:55:51   Negotiating with tannenba@ToddsThinkpad at &lt;127.0.0.1:50212&gt;\n10/16/12 10:55:51     USE_GLOBAL_JOB_PRIOS limit to jobprios between 52 and 92\n10/16/12 10:55:51     Request 00003.00001:\n10/16/12 10:55:51     Request 00003.00000:\n10/16/12 10:55:51     Request 00003.00002:\n10/16/12 10:55:51   Negotiating with tannenba@ToddsThinkpad at &lt;127.0.0.1:50201&gt;\n10/16/12 10:55:51     USE_GLOBAL_JOB_PRIOS limit to jobprios between -5 and 50\n10/16/12 10:55:51     Request 00007.00001:\n10/16/12 10:55:51     Request 00007.00004:\n10/16/12 10:55:51   Negotiating with tannenba@ToddsThinkpad at &lt;127.0.0.1:50212&gt;\n10/16/12 10:55:51     USE_GLOBAL_JOB_PRIOS limit to jobprios between -5 and -5\n10/16/12 10:55:51     Request 00003.00005:\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Oct-17 15:50:26 by tstclair:</em> <br/>\n\nQuick 1st blush in looking through this:\n\n<p>1. Use of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span> was to be deprecated.\n2. We totally need tests for this, I don't see any, yet it's in the review state.\n... I'll still dig.\n\n</p><p></p><hr/>\n<em>2012-Oct-17 17:24:28 by tannenba:</em> <br/>\n\nLooking at my test results above, and given that the schedd will reuse a claim from a different autocluster, I have come to the conclusion that it is stupid for the Negotiator to add jobprio to the list of significant attributes (as specified in the design doc).  All this does is waste time during the negotiation cycle. In the above test, the schedd sends job 3.1, 3.0, 3.2... if jobprio was not significant, it could have just sent 3.1 and been done.\n\n<p>Longer term, maybe we want the match record in the schedd to have a constraint, e.g.\n\n</p><p></p><pre>    owner==X &amp;&amp; jobprio &gt;= Y and jobprio &lt;= Z\n</pre>\n\n<p>but that is beyond the scope here.\n\n</p><p>EDIT: went ahead and pushed <span class=\"chng\"><a href=\"chngview?cn=33694\">[33694]</a></span> to fix this\n</p><hr/>\n<em>2012-Dec-11 16:39:58 by johnkn:</em> <br/>\n\nBulk change of target version from v070902 to v070903 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-19 11:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33707\">[33707]</a></span>: Change consolidate_globaljobprio_submitter_ads to have fewer assumptions about its inputs, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3257\" onclick=\"get_ticket_and_populate_wrapper('3257'); return false;\" title=\"Implement USE_GLOBAL_JOB_PRIOS mechanism in the negotiator\">#3257</a></span> Part of the USE_GLOBAL_JOB_PRIOS code. compiler warnings led us to take another look at this function, and it made many assumptions about the order of submitter ads in its input stream. these assumptions\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-17 17:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33694\">[33694]</a></span>: Do not automatically add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobPrio\" title=\"Job Prio\">JobPrio</a></span> to significant attributes with global jobprios. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3257\" onclick=\"get_ticket_and_populate_wrapper('3257'); return false;\" title=\"Implement USE_GLOBAL_JOB_PRIOS mechanism in the negotiator\">#3257</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3218\" onclick=\"get_ticket_and_populate_wrapper('3218'); return false;\" title=\"Support JobPrio scope across multiple schedulers\">#3218</a></span> Upon more reflection, adding <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobPrio\" title=\"Job Prio\">JobPrio</a></span> to the significant attributes here just increases negotiation time, even with USE_GLOBAL_JOB_PRIOS.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-15 13:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33672\">[33672]</a></span>: Fix compiler warnings re unused variable. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3257\" onclick=\"get_ticket_and_populate_wrapper('3257'); return false;\" title=\"Implement USE_GLOBAL_JOB_PRIOS mechanism in the negotiator\">#3257</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3218\" onclick=\"get_ticket_and_populate_wrapper('3218'); return false;\" title=\"Support JobPrio scope across multiple schedulers\">#3218</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-15 12:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33671\">[33671]</a></span>: Implement USE_GLOBAL_JOB_PRIOS mechanism in the negotiator. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3257\" onclick=\"get_ticket_and_populate_wrapper('3257'); return false;\" title=\"Implement USE_GLOBAL_JOB_PRIOS mechanism in the negotiator\">#3257</a></span> Negotiation protocol extended so negotiator can request only jobs from user X with job priorities between Y and Z based on job priority array attribute visible in the submitter ad; wire compatibility is ensured by just adding new attributes\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Jan-07 12:31", "status": "resolved", "created": "2012-Oct-05 14:03", "fixed_version": "2012-Oct-05 14:03", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "#3218", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "eje@cs.wisc.edu, tstclair@redhat.com, matt@cs.wisc.edu, dan@hep.wisc.edu, bbockelm@cse.unl.edu, sfiligoi@fnal.gov, tannenba@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": "20121010"}