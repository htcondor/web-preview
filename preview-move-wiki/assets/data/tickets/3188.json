{"id": 3188, "title": "Ticket #3188: Extract information from userlog with condor_history", "description": "<blockquote>\nCMS needs a way to efficiently monitor the status of the jobs they submit to Condor.\n\n<p>They have a system in place that calls condor_q on a frequent basis + condor_history when the job finishes.\n\n</p><p>While this works, it puts a very high load on the system.\n\n</p><p>So, the proposal is to have them parse the userlog, instead.\n\n</p><p>However, they want to preserve the condor_q interface, in order to minimize code changes in their stack.\n\n</p><p></p><div class=\"strike\">\n<strike>\nThe proposal is to extend condor_q to be able to parse the userlog.\n\nThe proposed syntax is\n{code}condor_q -userlog &lt;fname&gt; ...{endcode}\n</strike></div>\n\n\n<p>condor_history extended to be able to parse the userlog instead of the history file.  syntax is\n</p><div class=\"code\">\n<pre class=\"code\">condor_history -userlog &lt;fname&gt; ...</pre></div>\n\n\n<p>i.e. mimicking the existing -jobads syntax.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Aug-09 16:00:31 by sfiligoi:</em> <br/>\n\nI will have a pre-release for CMS use soon; we really need it ASAP.\n\n<p>Please comment ASAP is the proposed command line syntax is (not) acceptable, since changing that after CMS starts to use it would be a significant hassle.\n\n</p><p></p><hr/>\n<em>2012-Aug-11 05:59:36 by matt:</em> <br/>\n\nIgor, what information are they after (what queries are run, what are the call semantics)? It may be a better change to modify condor_wait.\n\n<p></p><hr/>\n<em>2012-Aug-11 12:04:57 by sfiligoi:</em> <br/>\n\nI need the attributes of the job.\nIn all states, not just when they are completed.\n\n<p>It is used for providing monitoring info to users.\n\n</p><p>Typical (simplified) use would be:\n</p><div class=\"code\">\n<pre class=\"code\">codor_q -userlog a.log -xml -format '%i.' ClusterId -format '%i ' ProcId -format '%i ' JobStatus -format '%s\\n' JOB_Gatekeeper\n</pre></div>\n\ni.e. where are/were my jobs running?\n\n<p>Plus, we have a working system that uses condor_q,\nand would like to preserve it with minimal changes.\n\n</p><p>PS: Each userlog contains pretty much only the information we need.\n\n</p><p>In practice:\n</p><div class=\"code\">\n<pre class=\"code\">-userlog /basepath/datasetXYZ/condor.log\n</pre></div>\n\n\n<p>replaces the current\n</p><div class=\"code\">\n<pre class=\"code\">-constraint 'Dataset==\"datasetXYZ\"'\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Aug-13 09:13:21 by tstclair:</em> <br/>\n\nIt seem much more like you want feed forward information, for something like this why not hook into the plugin facility, and you could tailor that way.  Any time you hit condor_q (doesn't matter what) you impact performance directly, but in the plugin you could feed forward to some central loc to access this information, much akin to cumin.\n\n<p></p><hr/>\n<em>2012-Aug-13 10:53:25 by sfiligoi:</em> <br/>\n\nThat's certainly an option, but it is an orthogonal one, in my opinion.\n\n<p>Forwarding the info to a (remote) database just moves the problem from the schedd to the database itself. Sure, it may be more scalable, but it  is still a single/central service.<br/>\n\nMoreover, it is yet another service to run... not really thrilled at the idea.<br/>\n\nOthers may of course like it.\n\n</p><p>On the other hand, the userlog is already there... <br/>\n\nso I am proposing a tool to parse it to get the final classad out; and condor_q seems the best place for it.\n\n</p><p></p><hr/>\n<em>2012-Aug-14 05:54:09 by matt:</em> <br/>\n\nIgor, what is consuming this information?\n\n<p>-jobads and -machineads are arguably hacks (currently labeled \"for debugging\") that should be on a condor_analyze tool.\n\n</p><p>condor_q may already have some of the code needed for this, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AttrListPrintMask\" title=\"Attr List Print Mask\">AttrListPrintMask</a></span> &amp; others, but it is not the best tool to implement this feature. Instead the code should be reusable, as in fact <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AttrListPrintMask\" title=\"Attr List Print Mask\">AttrListPrintMask</a></span> is.\n\n</p><p>Another new tool, maybe condor_parse_and_format, should appear to handle this feature request. The condor_q tool should remain an interface to the condor_schedd. The new tool could consume non-xml userlogs, xml userlogs, history files, PER_JOB_HISTORY_DIRs, non-xml EVENT_LOGs and xml EVENT_LOGs. Maybe if you even have privileges it could read the job_queue.log directly.\n\n</p><p></p><hr/>\n<em>2012-Aug-14 09:42:08 by sfiligoi:</em> <br/>\n\nThe information is consumed indirectly by users; we have essentially a wrapper that calls condor_q, extracts the needed information, formats it and shows it to the users.\n\n<p>I don't care if it is called condor_q or something else; condor_q just seemed the natural place.<br/>\n\nIf you guys can agree on a new name FAST, I can move the code there; I just need something done within a week or so.<br/>\n\nBut the command lines arguments and the output should remain similar.\n\n</p><p>As for what kind of files condor_q can read, we pretty much cover all the formats right now, since it uses the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadUserLog\" title=\"Read User Log\">ReadUserLog</a></span> class.\n\n</p><p>As for where it is implemented, I would be happy to move it into the shared library, if this is something people are interested in.<br/>\n\nWas just trying to minimize changes to the share pieces.\n\n</p><p></p><hr/>\n<em>2012-Aug-15 07:22:01 by matt:</em> <br/>\n\nAny reasonable name will work. I just suggest not condor_q -- not combining this with the existing condor_q tool.\n\n<p>Also, the patch looks like it replicates a lot of logic around event types and is specific to the information you are after. It will be difficult to keep the logic up to date with changes elsewhere in the code base. For instance, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobStarts\" title=\"Num Job Starts\">NumJobStarts</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EnteredCurrentStatus\" title=\"Entered Current Status\">EnteredCurrentStatus</a></span>, Last*, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyType\" title=\"My Type\">MyType</a></span>, and NODE_*, EXECUTABLE_ERROR, POST_SCRIPT_TERMINATED.\n\n</p><p>What about putting this new tool in src/condor_contrib while supporting functionality can be developed to make it simpler to maintain and more general purpose?\n\n</p><p>One thing that could be done to assist is allowing for ad diffs to be output into events. Right now specific attributes can be output, but not to all event types. There is also an internal dirty list maintained on jobs that could be exposed to the user log writer.\n\n</p><p></p><hr/>\n<em>2012-Aug-30 17:25:32 by sfiligoi:</em> <br/>\n\nWhile for CMS automated purposes\ncondor_history\nwill work just as fine,\nI think it is a disservice to the Condor community to not implement it in condor_q (also).\n\n<p>When analysing a log containing not-yet-finished jobs,\ncondor_history does not really provide any useful info (without using -format or similar),\nwhile condor_q does.\n</p><hr/>\n<em>2012-Oct-22 14:59:59 by zmiller:</em> <br/>\n\nBulk change of target version from v070901 to v070902 using ./ticket-target-mover.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/619/condor_q.patch\">condor_q.patch</a>\n20256 bytes added by sfiligoi on 2012-Aug-10 20:09:04 UTC.\n<br/>\nThe -userlog option has been implemented for vanilla universe jobs, with the exception of propagating network statistics.\n\n<p>Jobs from other universes may not work properly, since not all the user lo events are handled.\n\n</p><p>The above patch is based on master starting from commit 65cac1a2cf44f609ce15ea23104e85167a8e7e74\n.\n<br/>\n</p></li><li><a href=\"../files/620/queue.cpp.patch.v78\">queue.cpp.patch.v78</a>\n799 bytes added by sfiligoi on 2012-Aug-10 23:57:12 UTC.\n<br/>\nIf you were ever interested in backporting it to V7_8-branch, you will need this patch (in addition to the previous one) to deal with the lack of a long version of ClassAd::InsertAttr.\n<br/>\n</li><li><a href=\"../files/621/queue.cpp.patch.master\">queue.cpp.patch.master</a>\n5376 bytes added by sfiligoi on 2012-Aug-11 00:03:14 UTC.\n<br/>\nA fix for the master branch; I had only tested it by backporting to v7_8 before.\n\n<p>The problem was the change in the ClassAd::Insert interface; now it get the 2nd parameter as a reverence, not as a value (even though it is a pointer).\n\n</p><p>So this does not work anymore:\n</p><div class=\"code\">\n<pre class=\"code\">jobClassAd-&gt;Insert(\"LastJobStatus\",jobClassAd-&gt;Remove(\"JobStatus\"));\n</pre></div>\n\nso I had to replace it with:\n<div class=\"code\">\n<pre class=\"code\">{\n  ExprTree *oldstatus=jobClassAd-&gt;Remove(\"JobStatus\");\n  jobClassAd-&gt;Insert(\"LastJobStatus\",oldstatus);\n}\n</pre></div>\n\n<br/>\n</li><li><a href=\"../files/623/queue.cpp.fix_reason_not_null.patch\">queue.cpp.fix_reason_not_null.patch</a>\n2975 bytes added by sfiligoi on 2012-Aug-13 05:57:06 UTC.\n<br/>\nI had wrongfully assumed that all classes would always return a reason, if they had the get method; this can lead to code dumps.\n\n<p>This patch fixes it, but doing the proper checks.\n<br/>\n</p></li><li><a href=\"../files/630/history_dash_userlog.783.patch\">history_dash_userlog.783.patch</a>\n27276 bytes added by johnkn on 2012-Aug-30 21:40:48 UTC.\n<br/>\nPatch for 7_8_3-branch  a99f8f5de98764c1808613 that adds -userlog argument to condor_history. this patch will conflict with the commits for this ticket already added to the master branch and should not be merged forward.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-15 13:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34133\">[34133]</a></span>: Edits for 7.9.1 -userlog command line option to condor_history and condor_q ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3188\" onclick=\"get_ticket_and_populate_wrapper('3188'); return false;\" title=\"Extract information from userlog with condor_history\">#3188</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-22 10:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33714\">[33714]</a></span>: Documentation for condor_q -userlog and condor_history -userlog <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3188\" onclick=\"get_ticket_and_populate_wrapper('3188'); return false;\" title=\"Extract information from userlog with condor_history\">#3188</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-19 15:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33710\">[33710]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3188\" onclick=\"get_ticket_and_populate_wrapper('3188'); return false;\" title=\"Extract information from userlog with condor_history\">#3188</a></span> (also covers <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3191\" onclick=\"get_ticket_and_populate_wrapper('3191'); return false;\" title=\"condor_q -jobads does not respect -constraint and similar\">#3191</a></span>).  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-29 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33209\">[33209]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3188\" onclick=\"get_ticket_and_populate_wrapper('3188'); return false;\" title=\"Extract information from userlog with condor_history\">#3188</a></span>) add -userlog option to condor_history in preparation to moving -userlog option out of condor_q and into condor_history.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-29 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33208\">[33208]</a></span>: move code that converts userlog to a set of job ads into condor_utils <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3188\" onclick=\"get_ticket_and_populate_wrapper('3188'); return false;\" title=\"Extract information from userlog with condor_history\">#3188</a></span> also implement -constraint for -jobads and -userlog in condor_q <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3191\" onclick=\"get_ticket_and_populate_wrapper('3191'); return false;\" title=\"condor_q -jobads does not respect -constraint and similar\">#3191</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-29 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=33207\">[33207]</a></span>: sfiligoi's initial patch for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3188\" onclick=\"get_ticket_and_populate_wrapper('3188'); return false;\" title=\"Extract information from userlog with condor_history\">#3188</a></span>, ingesting job ads into condor_q from a userlog. + fix for changes to ClassAd::Insert interface + fix for reason-not-null  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Oct-23 09:24", "status": "resolved", "created": "2012-Aug-09 15:58", "fixed_version": "2012-Aug-09 15:58", "broken_version": "v070800", "priority": "2", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "", "creator": "sfiligoi", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "isfiligoi@ucsd.edu,matt@cs.wisc.edu,dan@hep.wisc.edu,tannenba@cs.wisc.edu,tstclair@redhat.com,johnkn@cs.wisc.edu,tannenba@cs.wisc.edu", "due_date": "20120816"}