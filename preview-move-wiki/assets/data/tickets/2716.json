{"id": 2716, "title": "Ticket #2716: Code review new Gratia Condor probe", "description": "<blockquote>\nThe Condor Team owns the Gratia Condor Probe. Historically, the probe has been wacky: it's written in Python and it generates and runs Python code so that it can interact with the Python libraries. There has been one security flaw due to that (since it runs as root), and it's just icky.\n\n<p>Brian Bockelman &lt;bbockelm@cse.unl.edu&gt; needed to make some changes to the probe and ended up rewriting it all in Python. As part of rewriting it, he got rid of code that deals with web services GRAM because it is no longer needed. Brian has tested the code fairly heavily, including:\n\n</p><p></p><ul>\n<li>Running the probe by hand on 10 jobs and comparing the XML output with the old probe. They produced identical output.\n</li><li>Running the probe on a backlog of data (two million jobs) for one site that wasn't running Gratia for a long time (two years?) No problems were found.\n</li></ul>\n\n<p>Gratia is a critical part of the OSG infrastructure: people rely on the Gratia accounting on a daily basis. While we think the probe probably works well, we would like a thoughtful code review by a Condor developer who can think about the corner-edge-fringe-brink cases and suggest possible problems in the code.\n\n</p><p>We'd like this review by early January so we can release an update in mid to late January. Todd suggests that perhaps Nathan is the right person to do the review, so I've assigned the ticket to him. Please reassign if needed.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Dec-14 17:37:46 by bbockelm:</em> <br/>\n\nNot sure how much background Nathan has in Gratia, so I'll leave a few breadcrumbs.  The source code for Gratia probes can be found here:\n\n<p><a class=\"external\" href=\"https://gratia.svn.sourceforge.net/svnroot/gratia/trunk/probe\">https://gratia.svn.sourceforge.net/svnroot/gratia/trunk/probe</a>\n\n</p><p>The condor probe is in the \"condor\" directory; to create the RPM, run \"./build/build_all\".  Specifically, we are reviewing condor_meter.pl versus condor_meter.  You want to create a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeConfig\" title=\"Probe Config\">ProbeConfig</a></span> file and send records to the test collector, gratia-osg-itb.opensciencegrid.org:80.  For comparing outputs, I find it useful to set Debug to 6, which causes the raw XML used to be printed to stdout.\n\n</p><p>To have the probe parse files, put a classad in the directory pointed to by <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DataFolder\" title=\"Data Folder\">DataFolder</a></span> in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeConfig\" title=\"Probe Config\">ProbeConfig</a></span> file and run \"condor_meter\".  The code has initial - but fairly untested - support for multiple classads per file.  You might be able to just drop in the output of \"condor_history -l\" to generate test data (if that doesn't work, let's fix it).\n\n</p><p>Note that condor_meter is meant to be a logic copy of that found in condor_meter.pl.  I fixed two things:\n\n</p><p></p><ul>\n<li>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProcessId\" title=\"Process Id\">ProcessId</a></span> in the original probe appears to have been the UDP port from the ClaimID - whaaa?\n</li><li>Filling in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SubmitHost\" title=\"Submit Host\">SubmitHost</a></span> never worked.\n</li></ul>\n\n<p>Once the review passes, I'd like to fix some long-standing issues with running Gratia at CHTC.  Ask danb for more details.\n\n</p><p>Additionally, I have not ported over WS-GRAM support.  I also do not port over parsing of Condor logfiles, as that code depended on being able to query condor_history, and was no longer reachable in the current perl probe.\n\n</p><p>Hope this helps.  Let me know if there are further questions.\n\n</p><p></p><hr/>\n<em>2012-Jan-04 17:17:46 by roy:</em> <br/>\n\nI'm very interested in seeing this probe reviewed. What's the expected schedule for it? Thanks!\n\n<p></p><hr/>\n<em>2012-Jan-05 16:37:41 by nwp:</em> <br/>\n\nI am reviewing it now.  I need to sit down with Scot to complete the review.\n\n<p></p><hr/>\n<em>2012-Jan-09 16:20:00 by nwp:</em> <br/>\n\nCan I run this without creating an RPM?\n\n<p></p><hr/>\n<em>2012-Jan-09 16:25:09 by nwp:</em> <br/>\n\nWhat is the format of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeConfig\" title=\"Probe Config\">ProbeConfig</a></span> file?  It would be helpful if there were an example in the svn repository.\n\n<p></p><hr/>\n<em>2012-Jan-09 16:30:51 by bbockelm:</em> <br/>\n\n(Working from memory, don't have the code in front of me),\n\n<p>There is a template <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeConfig\" title=\"Probe Config\">ProbeConfig</a></span> (ProbeConfig.osg, if memory serves) in the ./probe/common sub-directory.  You can start with that and customize <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CollectorHost\" title=\"Collector Host\">CollectorHost</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeName\" title=\"Probe Name\">ProbeName</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SiteName\" title=\"Site Name\">SiteName</a></span>.\n\n</p><p>You should be able to run this without creating the RPM.  It's just python code.  To do this:\n</p><ul>\n<li>Place ./probe/common into $PYTHONPATH.\n</li><li>cd to ./probe/condor\n</li><li>run \"./condor_meter -f <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeConfig\" title=\"Probe Config\">ProbeConfig</a></span> &lt;data dir&gt;\", pointing at a sample <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ProbeConfig\" title=\"Probe Config\">ProbeConfig</a></span> (you'll at least want to put the logs in /tmp to make it to run).  &lt;data dir&gt; should be the location pointed to by PER_JOB_HISTORY_DIR in the schedd (see /etc/condor/config.d/99_gratia*).\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Jan-10 15:19:01 by nwp:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>This looks fine to me.  I do not see any problems with the code.\n\n</p><p></p><hr/>\n<em>2015-Feb-11 15:29:05 by bbockelm:</em> <br/>\n\nReviewing old OSG tickets - this appears to be done.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "enhance", "last_change": "2015-Feb-11 15:29", "status": "resolved", "created": "2011-Dec-14 16:27", "fixed_version": "2011-Dec-14 16:27", "broken_version": "", "priority": "1", "subsystem": "Engagement", "assigned_to": "bbockelm", "derived_from": "", "creator": "roy", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "roy@cs.wisc.edu,bbockelm@cse.unl.edu,kronenfe@cs.wisc.edu", "due_date": "20120109"}