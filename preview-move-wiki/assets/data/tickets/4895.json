{"id": 4895, "title": "Ticket #4895: condor_q blacklisting sole collector", "description": "<blockquote>\nThe OSG packaging group is seeing repeated test failures where condor_q blacklists the sole collector that it is trying to contact.\n\n<p>The collector blacklisting feature is meant for pools that have multiple redundant collectors for high availability. If one of those collectors goes down, then daemons will avoid contacting it for queries, and instead use the other collectors.\n\n</p><p>The triggering of blacklisting in OSG's testing is odd for two reasons. First, blacklisting is pointless when there's a single collector. Second, condor_q is blacklisting the collector before it contacts it for the first time.\n\n</p><p>This appears to be a glitch in how the Timeslice object for blacklisting is initialized. So far, the only way I see for this to happen is if the system clock moves backwards while condor_q is running. We are doing some tests with additional debugging to learn more.\n\n</p><p>It's easy to change the code so that blacklisting never happens when there's only one collector. I'm holding off on that change until we understand why this is triggering in OSG's tests.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Feb-18 10:24:10 by blin:</em> <br/>\n\nJaime, I don't believe this is happening when condor_q is contacting the collector for the first time. The condor_ce_run script submits the job with condor_submit and then runs condor_q repeatedly, with a one second delay, until the job completes and then runs condor_transfer_data. Looking at the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CollectorLog\" title=\"Collector Log\">CollectorLog</a></span> for the failed tests, I see multiple 'Got QUERY_SCHEDD_ADS' on one second intervals while the script is supposed to be running, so it doesn't seem like it's failing on the intial condor_q.\n\n<p></p><hr/>\n<em>2015-Feb-18 13:47:08 by jfrey:</em> <br/>\n\nI mean that the blacklisting happens before that specific condor_q process contacts the collector. The blacklisting is completely internal to each process, so there's no history of success/failure talking to the collector between condor_q processes.\n\n<p></p><hr/>\n<em>2015-Feb-18 20:10:20 by bbockelm:</em> <br/>\n\ncondor_ce_run uses the python bindings internally, hence the memory between invocations.\n\n<p></p><hr/>\n<em>2015-Feb-19 09:08:58 by jfrey:</em> <br/>\n\nThe errors are coming from the condor_q binary, which condor_ce_run is executing once a second.\n\n<p></p><hr/>\n<em>2015-Aug-14 10:22:19 by tim:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/869/condor_q-debug.patch\">condor_q-debug.patch</a>\n4238 bytes added by jfrey on 2015-Mar-31 21:12:31 UTC.\n<br/>\nPatch to print debugging info about the collector blacklist timeslice in condor_q's dprintf stream.<br/>\n</li><li><a href=\"../files/870/blacklist.patch\">blacklist.patch</a>\n628 bytes added by jfrey on 2015-Mar-31 21:29:20 UTC.\n<br/>\nPatch to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CollectorList\" title=\"Collector List\">CollectorList</a></span> to always query one collector, even if all are blacklisted.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-07 12:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45521\">[45521]</a></span>: minor edit of 8.2.9 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4895\" onclick=\"get_ticket_and_populate_wrapper('4895'); return false;\" title=\"condor_q blacklisting sole collector\">#4895</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-07 11:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45518\">[45518]</a></span>: Docs for bugfix when all collectors are blacklisted. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4895\" onclick=\"get_ticket_and_populate_wrapper('4895'); return false;\" title=\"condor_q blacklisting sole collector\">#4895</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-07 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45513\">[45513]</a></span>: Always query a collector when all are blacklisted. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4895\" onclick=\"get_ticket_and_populate_wrapper('4895'); return false;\" title=\"condor_q blacklisting sole collector\">#4895</a></span> If all collectors are blacklisted, still try to contact one. This is especially important when there's only one collector.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "incident", "last_change": "2015-Aug-14 10:22", "status": "resolved", "created": "2015-Feb-18 10:18", "fixed_version": "2015-Feb-18 10:18", "broken_version": "", "priority": "4", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "#4555", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "jfrey@cs.wisc.edu,blin@cs.wisc.edu", "due_date": ""}