{"id": 5169, "title": "Ticket #5169: DAGMan does not kill post/pre scripts on shutdown", "description": "<blockquote>\nPOST / PRE scripts are only shutdown by condor_dagman on SIGUSR1.  Any other cases (such as shutting down the schedd) leak running POST/PRE scripts.\n\n<p>This has lead to many irritations in CMS from having two POST scripts running for the same node, leading to complex schedd restart procedures (when we're lucky enough to have an admin restarting the schedd instead of a process segfault or something).</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-26 10:37:14 by wenger:</em> <br/>\n\nHmm -- for me, in a personal condor, doing \"condor_off -master\" or \"condor_off -schedd\" <strong>does</strong> cause DAGMan to kill off running scripts.  I can certainly believe there's some scenario in which this doesn't happen, but it's not the super-simple one of just shutting things down \"properly\".\n\n<p></p><hr/>\n<em>2015-Jul-26 20:42:23 by bbockelm:</em> <br/>\n\nHi,\n\n<p>The simplest way I could trigger this is:\n\n</p><p></p><ul>\n<li>Run a dagman job with a post script which consists of \"sleep 10m\"\n</li><li>condor_hold the dagman job.\n</li></ul>\n\n<p>The post script will continue to run after the job is held.  To get it when the schedd dies - you have to start racing with the condor_procd.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jul-27 09:14:28 by wenger:</em> <br/>\n\nAh, if you do condor_hold and then shut down the schedd, this makes sense, because the DAGMan process is killed on condor_hold, so there's nothing running that knows about the scripts when you shut down the schedd.\n\n<p>I'm kind of wondering at this point whether we should change what happens when you hold a DAGMan job -- maybe make that the same as halting the DAG with a halt file.  That would fix this problem, and various other issues related to holding DAGMan jobs...\n\n</p><p></p><hr/>\n<em>2015-Jul-27 10:14:43 by wenger:</em> <br/>\n\nBrian, if we implement a config knob that causes DAGMan to remove all node jobs and kill all running scripts on a SIGUSR1 (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5175\" onclick=\"get_ticket_and_populate_wrapper('5175'); return false;\" title=\"Have condor_dagman condor_rm jobs on SIGUSR1 (revert #4618)\">#5175</a></span>), would that take care of this, or are you saying you sometimes see the orphaned scripts without holding DAGMan before the shutdown?\n\n<p></p><hr/>\n<em>2015-Jul-27 16:00:43 by bbockelm:</em> <br/>\n\nWe indeed see these scripts leaked on schedd shutdown without holding the jobs (I believe mostly we're racing with the procd) - doing the \"condor_hold\" route was just a simpler way to see it.\n\n<p></p><hr/>\n<em>2015-Jul-29 11:50:29 by wenger:</em> <br/>\n\nJaime says that in 8.2.9 and 8.3.8, the schedd will kill child processes of DAGMan.  I need to look at the DAGMan code and see whether we should change any of the DAGMan code as a result.\n\n<p></p><hr/>\n<em>2015-Aug-04 13:42:46 by wenger:</em> <br/>\n\nOne note on this -- the schedd kills running pre and post scripts on both condor_hold and condor_rm of a DAGMan job.  This may be what we want to do, but it's a change in the behavior of condor_hold, so at minimum that needs to be clearly documented.\n\n<p></p><hr/>\n<em>2015-Aug-04 14:19:39 by wenger:</em> <br/>\n\nNote:  see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5173\" onclick=\"get_ticket_and_populate_wrapper('5173'); return false;\" title=\"Schedd doesn't kill process family of scheduler universe jobs\">#5173</a></span> for the actual schedd changes.\n\n<p></p><hr/>\n<em>2015-Aug-04 15:11:58 by wenger:</em> <br/>\n\nI've tested things out, and I'm going to mark this ticket as resolved, because of the changes in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5173\" onclick=\"get_ticket_and_populate_wrapper('5173'); return false;\" title=\"Schedd doesn't kill process family of scheduler universe jobs\">#5173</a></span>.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=5193\" onclick=\"get_ticket_and_populate_wrapper('5193'); return false;\" title=\"Have DAGMan *not* kill pre/post scripts when condor_rm'ed\">#5193</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nHave DAGMan <strong>not</strong> kill pre/post scripts when condor_rm'ed</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2015-Aug-04 15:46", "status": "resolved", "created": "2015-Jul-21 20:35", "fixed_version": "2015-Jul-21 20:35", "broken_version": "", "priority": "2", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "wenger@cs.wisc.edu, bbockelm@cse.unl.edu", "due_date": ""}