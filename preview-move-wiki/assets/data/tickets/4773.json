{"id": 4773, "title": "Ticket #4773: CLASSAD_USER_LIBS for python", "description": "<blockquote>\nThe CLASSAD_USER_LIBS configuration knob allows sysadmins to implement and expose their own C++ functions to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> library.  This is a powerful tool for implementing functions that represent expressions impractical to write within <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>.\n\n<p>Unfortunately, implementing a C++ function is difficult for the average sysadmin and somewhat underdocumented.  I propose exposing python modules as an alternate mechanism for site-specific <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> functions.\n\n</p><p>Proposal:\n</p><ul>\n<li>If CLASSAD_USER_PYTHON_MODULES is set, it is a string list of python modules allowed to be invoked from <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>.\n</li><li>Introduce the python_invoke <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> function; the first argument is a module name (whitelisted above) and the second a function name (anything starting with \"_\" is forbidden).\n</li><li>Do not add this\u00a0functionality to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> proper, but as part of a C++ shared library.\n</li></ul>\n\n<p>Note that we must whitelist modules to prevent remote users from invoking something from the \"os\" module.  Also note that, as part of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4598\" onclick=\"get_ticket_and_populate_wrapper('4598'); return false;\" title=\"Export python functions to ClassAd library\">#4598</a></span>, the python module may register functions within the top-level namespace of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> as part of the module loading process.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-15 09:25:47 by bbockelm:</em> <br/>\n\nToddT, can I get you to review the design here?  Don't worry too much about the actual implementation - but rather is the UI reasonable?\n\n<p></p><hr/>\n<em>2014-Dec-18 21:02:37 by bbockelm:</em> <br/>\n\nUpdate: Caught ToddT on phone; agreed the general approach was sound as it has the same pros / cons as CLASSAD_USER_LIBS -- just implemented in python.\n\n<p>Will merge once batlab gives this a clean bill of health.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4909\" onclick=\"get_ticket_and_populate_wrapper('4909'); return false;\" title=\"Make tear-down methods safe to call after DaemonCore is deleted\">#4909</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMake tear-down methods safe to call after <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> is deleted</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-22 15:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42321\">[42321]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span>) Add libclassad_python_user.so to unified RPM  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-16 10:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42256\">[42256]</a></span>: improve/complete documentation for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-03 13:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42082\">[42082]</a></span>: Switch RPATH for libclassad_python_user.so to CONDOR_RPATH. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span> Previously, libclassad_python_user.so was linked with PYTHON_RPATH; this is the wrong RPATH as this library is installed into $(LIBEXEC). This resulted in libclassad_python_user.so being unusable unless someone mucked with LD_LIBRARY_PATH.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jan-03 12:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=42081\">[42081]</a></span>: Turn the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerManager\" title=\"Timer Manager\">TimerManager</a></span> into a singleton. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span> Previously, a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerManager\" title=\"Timer Manager\">TimerManager</a></span> instance was a static member of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> class initialized in the static initializers. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TimerManager\" title=\"Timer Manager\">TimerManager</a></span> was not actually a singleton, but EXCEPT'd if the constructor was called twice.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 14:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41987\">[41987]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=41910\">[41910]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=41911\">[41911]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=41975\">[41975]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=41976\">[41976]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=41986\">[41986]</a></span>, Merge branch 'V8_3-gt4773'. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span> Conflicts: doc/version-history/8-3.history.tex  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 13:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41986\">[41986]</a></span>: Make python exception / <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> error behavior consistent. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span> python_invoke and registered functions previously had differing behavior when a python exception is thrown. Now, both functions will <strong>keep</strong> the python exception set and return an error value.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-19 07:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41976\">[41976]</a></span>: Fix build issues from batlab. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-18 20:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41975\">[41975]</a></span>: Documentation and version history for CLASSAD_USER_PYTHON_MODULES. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-14 14:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41911\">[41911]</a></span>: Add protections to python_invoke. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span> This introduces the CLASSAD_USER_PYTHON_MODULES configuration knob. If set, the referenced python modules are loaded and made available to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> library through the \"python_invoke\" function. No other modules are available; further, any functions starting\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-14 14:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41910\">[41910]</a></span>: Allow <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> to invoke python functions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4773\" onclick=\"get_ticket_and_populate_wrapper('4773'); return false;\" title=\"CLASSAD_USER_LIBS for python\">#4773</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Feb-18 15:29", "status": "resolved", "created": "2014-Dec-14 14:33", "fixed_version": "2014-Dec-14 14:33", "broken_version": "", "priority": "4", "subsystem": "Daemons", "assigned_to": "bbockelm", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu", "due_date": ""}