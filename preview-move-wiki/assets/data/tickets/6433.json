{"id": 6433, "title": "Ticket #6433: Condor jobs stuck with spurious OOM", "description": "<blockquote>\nThe thread beginning here (list membership/auth req'd):\n\n<p><a class=\"external\" href=\"http://lists.aei.mpg.de/cgi-bin/mailman/private/condorligo/2017-September/005011.html\">http://lists.aei.mpg.de/cgi-bin/mailman/private/condorligo/2017-September/005011.html</a>\n\n</p><p>outlines cgroups issues that Carsten has had since upgrading from 8.6.3 to 8.6.5. He cannot entirely rule out that the upgrade is unrelated but this change was introduced in 8.6.4:\n\n</p><p><a class=\"external\" href=\"https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=6294\">https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=6294</a>\n\n</p><p>There appear to be 2 issues:\n\n</p><p></p><ol>\n<li>Jobs can get stuck in D state when swapaccount is enabled in the kernel and swap is disabled. (this is an oversimplification of the thread, please read it)\n\n<p></p></li><li>Take a system configured with...\n</li></ol>\n<ul>\n<li>64403MB of RAM and 19530MB of swap (using powers of 2, some RAM lost to BIOS)\n</li><li>swapaccount=1 enabled in the kernel\n</li><li>Condor configured for soft limits and not to book-keep for swap\n<div class=\"verbatim\">\n<pre>BASE_CGROUP = htcondor\nCGROUP_MEMORY_LIMIT_POLICY = soft\n\nslot_type_1 = swap=0\nslot_type_1_partitionable = True\nnum_slots_type_1 = 1\n</pre></div>\n\n\n<p></p></li><li>Outside of condor I set the parent cgroup limits\n<div class=\"verbatim\">\n<pre># enable RAM limit based upon ratio of 2000MB per core\nCONDOR_MEMORY_LIMIT_RAM=$((`nproc`*2000))\nCONDOR_MEMORY_LIMIT_SWAP=0\nCONDOR_MEMORY_LIMIT_SWAP_RAM=$((CONDOR_MEMORY_LIMIT_RAM+CONDOR_MEMORY_LIMIT_SWAP))\n\n# create htcondor cgroup and ensure that subgroups inherit memory limits\n/usr/bin/cgcreate -g blkio,cpu,cpuacct,freezer,memory:htcondor -a root:root -t root:root\n/usr/bin/cgset -r cpu.shares=1000 htcondor\n/usr/bin/cgset -r memory.use_hierarchy=1 htcondor\n/usr/bin/cgset -r memory.limit_in_bytes=${CONDOR_MEMORY_LIMIT_RAM}M htcondor\n/usr/bin/cgset -r memory.memsw.limit_in_bytes=${CONDOR_MEMORY_LIMIT_SWAP_RAM}M htcondor\n/usr/bin/cgset -r memory.swappiness=1 htcondor\n</pre></div>\n\n</li></ul>\n\n<p>... we see these cgroups values for a slot for a job that requested 2GB of memory:\n\n</p><p></p><div class=\"verbatim\">\n<pre>==&gt; memory.limit_in_bytes &lt;== ## this is the cgroups hard limit on RAM (unset because I use soft limits)\n87391088640\n\n==&gt; memory.memsw.limit_in_bytes &lt;== ## this is the cgroups hard limit on combined RAM and swap (no corresponding soft limit)\n87391092736\n\n==&gt; memory.soft_limit_in_bytes &lt;== ## this is the cgroups soft limit on RAM\n2147483648\n</pre></div>\n\n\n<p>The problem here is that memory.memsw.limit_in_bytes has been set to a value that is either exactly or very nearly all of RAM and swap on the system. And, of course, there has been no hard limit placed either (except via the parent cgroup).\n\n</p><p>The upshot is that on a system with no other jobs this job would be allowed to consume all of RAM and swap. My outside-of-Condor magic prevents it from consuming combined RAM+SWAP than there is RAM, but it doesn't prevent swapping.\n\n</p><p>I read what Carsten is saying to mean that memory.memsw.limit_in_bytes is being set to this (very large) value even when he has hard limits configured. This is definitely not right.\n\n</p><p>I would further argue that the hard limits you've set include swap when I've assigned none to the slot. So you're not really doing the right thing for soft limits either. For soft limits, I think you'd be better off (for every job) setting memory.limit_in_bytes=MEMORY and memory.memsw.limit_in_bytes=MEMORY+SWAP_FOR_SLOT. Or, instead of MEMORY, something like N*RequestMemory.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Oct-06 16:12:57 by tpdownes:</em> <br/>\n\nFor completeness, my values for the parent htcondor cgroup\n\n<p></p><div class=\"verbatim\">\n<pre>==&gt; memory.limit_in_bytes &lt;==\n67108864000\n\n==&gt; memory.memsw.limit_in_bytes &lt;==\n67108864000\n\n==&gt; memory.soft_limit_in_bytes &lt;==\n9223372036854771712\n</pre></div>\n\n\n<p></p><hr/>\n<em>2019-Apr-10 15:00:48 by pfc:</em> <br/>\n\nI'm assuming solely based on the age of this ticket that it's safe to demote to priority 5 and defer.  If I'm wrong, please speak up.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "todo", "last_change": "2019-Apr-10 15:00", "status": "defer", "created": "2017-Oct-06 16:03", "fixed_version": "2017-Oct-06 16:03", "broken_version": "", "priority": "5", "subsystem": "", "assigned_to": "", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}