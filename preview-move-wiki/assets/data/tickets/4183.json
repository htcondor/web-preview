{"id": 4183, "title": "Ticket #4183: Preemption due to stale public ads", "description": "<blockquote>\nThere's currently a race condition in the negotiator.  It queries for the startd public ads and, in a separate query, queries for private ads.\n\n<p>It's possible for the startd to update the ads between the two queries - resulting in the negotiator having a copy of the old public ad and new private ad.  Because the old public ad may indicate the slot is unclaimed, it will match jobs to the slot - and the jobs will successfully preempt using the preemption claim from the new private ad.\n\n</p><p>Two fixes are proposed:\n</p><ul>\n<li>(Stable and dev series) Query for private ads first, then public ads.  The race condition is that the negotiator may try to preempt based on a new public ad but the preemption will fail due to a stale private ad.  A bit of waste is an improvement over improper preemption! this is <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4185\" onclick=\"get_ticket_and_populate_wrapper('4185'); return false;\" title=\"Fix negotiator race between fetching public and private ads\">#4185</a></span>\n</li><li>(Dev series only) Have the startd advertise the public claim ID and use this as a foreign key to join with the private ad.  The two should always match if the ads were updated at the same time.  Any slots that would have triggered the race condition will fail to negotiate this round (but work in the next).  While a more thorough solution than above, it also requires the startds to be updated (so we must do this along with the prior suggestion).\n</li></ul>\n\n<p>We want to avoid any fixes that assume the results returned are an atomic snapshot of the collector database (this is true now, but we may want to change this in order to avoid having to fork child collector processes).  This is why we do not query the private ads and public ads at once.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jan-28 16:22:29 by gthain:</em> <br/>\n\n<strong class=\"two\">CODE REVIEW</strong>  let's just add the \"pull private then public\" ads diff to stable, and talk about what to do for master.  In particular, the joining on claimids seems problematic in the face of negotiation-side partitionable slot splitting, where there may be multiple claim ids.\n\n<p></p><hr/>\n<em>2014-Jan-29 10:10:28 by tannenba:</em> <br/>\n\nFYI, link discussion in htcondor-users:\n <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/htcondor-users/2014-January/msg00154.shtml\">https://lists.cs.wisc.edu/archive/htcondor-users/2014-January/msg00154.shtml</a>\n\n<p></p><hr/>\n<em>2014-Jan-29 10:33:10 by bbockelm:</em> <br/>\n\nHi Greg,\n\n<p>W.r.t switching the query order - will do.\n\n</p><p>I thought the patch I pushed handled multiple claim IDs correctly.  Do you see something which concerns you?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Jan-30 17:17:47 by tannenba:</em> <br/>\n\nChanging the target/priority for this ticket, since a minimal patch for this bug is already in the stable series via <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4185\" onclick=\"get_ticket_and_populate_wrapper('4185'); return false;\" title=\"Fix negotiator race between fetching public and private ads\">#4185</a></span>.  So this ticket is the placeholder to discuss the more optimal solution....</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4185\" onclick=\"get_ticket_and_populate_wrapper('4185'); return false;\" title=\"Fix negotiator race between fetching public and private ads\">#4185</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFix negotiator race between fetching public and private ads</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-31 09:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e35b9313c904269c6d39fe218af3d06a3184ba71\">[39278]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4185\" onclick=\"get_ticket_and_populate_wrapper('4185'); return false;\" title=\"Fix negotiator race between fetching public and private ads\">#4185</a></span>) minimal fix of negotiator race between fetching public and private ads. The fix is to fetch private ads before fetching public ads. This is the part of <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=4183\" onclick=\"get_ticket_and_populate_wrapper('4183'); return false;\" title=\"Preemption due to stale public ads\">#4183</a></span> that is fit for stable. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-28 15:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8118877236b578e7022ee41667583dfa14a94f5e\">[39253]</a></span>: Avoid a race condition that can cause preemptions due to stale ads. <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=4183\" onclick=\"get_ticket_and_populate_wrapper('4183'); return false;\" title=\"Preemption due to stale public ads\">#4183</a></span> This includes two fixes: 1) Query for private ads first, then public ads. This way, we don't try to preempt based on the stale public ad (and are successful due to the new private ad). 2) Join the private and public ads together\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-May-21 10:40", "status": "active", "created": "2014-Jan-28 15:37", "fixed_version": "2014-Jan-28 15:37", "broken_version": "v070800", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}