{"id": 3828, "title": "Ticket #3828: HA schedd frequently blocks on dead collector", "description": "<blockquote>\nWhen the first collector in an HA setup is on a dead machine, the schedd frequently blocks for a minute while trying to connect to it.\n\n<p></p><div class=\"verbatim\">\n<pre>07/29/13 22:47:30 Sending RESCHEDULE command to negotiator(s)\n07/29/13 22:47:30 Will use UDP to update collector condor01 &lt;IP1:9618&gt;\n07/29/13 22:47:30 Will use UDP to update collector condor02 &lt;IP2:9618&gt;\n07/29/13 22:47:30 Trying to query collector &lt;IP1:9618&gt;\n07/29/13 22:47:31 attempt to connect to &lt;IP1:9618&gt; failed: No route to host (connect errno = 113).  Will keep trying for 60 total seconds (59 to go).\n\n07/29/13 22:48:30 attempt to connect to &lt;IP1:9618&gt; failed: No route to host (connect errno = 113).\n07/29/13 22:48:30 Will avoid querying collector condor02 &lt;IP2:9618&gt; for 3540s if an alternative succeeds.\n07/29/13 22:48:30 Trying to query collector &lt;IP2:9618&gt;\n</pre></div>\n\n\n<p>Despite the message about avoiding the dead collector for an hour, it hits it again the next time it tries to send the RESCHEDULE command.  The collector list is not being reused in this code.\n\n</p><p>At a lower level, it is not a good idea to keep retrying and blocking on the connection after getting \"No route to host\".</p></blockquote>", "remarks": "<blockquote>\nI should note that the origin of this buggy behavior is much older than 8.0.  It may even be older than 7.0.\n\n<p></p><hr/>\n<em>2013-Jul-31 16:53:40 by danb:</em> <br/>\n\nI have submitted a patch that fixes the low-level problem of trying in a blocking loop to connect to a host that is dead.\n\n<p>The high-level problem still needs to be fixed, because each attempt to connect to a dead host still typically takes a second or two to fail (as opposed to the minimum of one minute it took to fail prior to the low-level fix).  The problem is that each time <code>sendReschedule()</code> is called, a new query is performed to look up the address of the negotiator.  Inside <code>Daemon::getDaemonInfo()</code>, we instantiate a new <code>CollectorList</code>.  Inside there is some code to remember that a particular collector wasted a bunch of our time when we tried to connect to it.  But this knowledge is not preserved, because it is chucked out when the <code>CollectorList</code> is destructed.\n\n</p><p></p><hr/>\n<em>2013-Aug-01 10:01:27 by smoler:</em> <br/>\n\nNote:  Commit on Aug 1 by Karen is cherry pick of 8.0.2 version history item that got committed on master branch.  Cherry pick is into V8_0-branch.\n\n<p></p><hr/>\n<em>2013-Aug-07 20:28:23 by sfiligoi:</em> <br/>\n\nHow about the use case where the Collector is simply not running? E.g. due to the fact that it is undergoing software maintenance?\n\n<p>And what about the use case of completely lost packets? No ICMP reply?\n\n</p><p>Will the HA code switch fast to the next collector in these cases?\n\n</p><p></p><hr/>\n<em>2013-Aug-08 10:01:33 by danb:</em> <br/>\n\nThe low-level fix is indeed still vulnerable to a lengthy connection delay.  It is therefore important to have the higher-level code remember this and failover to the next collector for a while.  That does happen in some parts of condor, but not in the schedd when sending a RESCHEDULE command.\n\n<p></p><hr/>\n<em>2013-Aug-12 17:20:00 by danb:</em> <br/>\n\nI created a patch for the higher-level problem.  Now the record of painfully long collector queries is kept globally in each daemon, rather than only surviving as long as the <code>CollectorList</code> object.  I have committed this to the master branch.  It could be cherry picked back into V8_0-branch if there is strong enough need for it, and it is deemed safe enough.\n\n<p></p><hr/>\n<em>2013-Aug-20 11:30:17 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>This review is for the 8.0.2 patch only (37056), which looks good.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3946\" onclick=\"get_ticket_and_populate_wrapper('3946'); return false;\" title=\"Bad collector name crashes daemons and tools\">#3946</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nBad collector name crashes daemons and tools</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-14 11:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37213\">[37213]</a></span>: minor 8.0.2 version history item edit ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3828\" onclick=\"get_ticket_and_populate_wrapper('3828'); return false;\" title=\"HA schedd frequently blocks on dead collector\">#3828</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-12 17:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37175\">[37175]</a></span>: Keep global history of blacklisted collectors. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3828\" onclick=\"get_ticket_and_populate_wrapper('3828'); return false;\" title=\"HA schedd frequently blocks on dead collector\">#3828</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-01 09:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37059\">[37059]</a></span>: Version history. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3828\" onclick=\"get_ticket_and_populate_wrapper('3828'); return false;\" title=\"HA schedd frequently blocks on dead collector\">#3828</a></span> Committer: Karen Miller  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-31 16:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37057\">[37057]</a></span>: Version history. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3828\" onclick=\"get_ticket_and_populate_wrapper('3828'); return false;\" title=\"HA schedd frequently blocks on dead collector\">#3828</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-31 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37056\">[37056]</a></span>: Do not keep trying in the connect loop when the target host is down. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3828\" onclick=\"get_ticket_and_populate_wrapper('3828'); return false;\" title=\"HA schedd frequently blocks on dead collector\">#3828</a></span>  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Oct-14 15:27", "status": "resolved", "created": "2013-Jul-30 17:27", "fixed_version": "2013-Jul-30 17:27", "broken_version": "v080000", "priority": "4", "subsystem": "", "assigned_to": "tim", "derived_from": "", "creator": "danb", "rust": "a25841", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu, isfiligoi@ucsd.edu", "due_date": ""}