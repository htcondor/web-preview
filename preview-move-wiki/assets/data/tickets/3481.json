{"id": 3481, "title": "Ticket #3481: Different \"idle time\" counts for partitionable slots than normal slots", "description": "<blockquote>\nIn glideinWMS, we have a DAEMON_SHUTDOWN expression that essentially does:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">(TotalTimeUnclaimedIdle &lt; T1) || (TotalTimeClaimedBusy =!= Undefined &amp;&amp; TotalTimeUnclaimedIdle &lt; T2)\n</pre></div>\n\n\n<p>This works fine for non-partitionable slots.  For partitionable slots, the parent slot always remains in the Idle state, no matter the state of the child slots, so this metric doesn't work.  We can hack around it to come up with something usable, but we can't replicate non-partitionable DAEMON_SHUTDOWN behavior with partitionable slots.\n\n</p><p>Something analogous to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalTimeUnclaimedIdle\" title=\"Total Time Unclaimed Idle\">TotalTimeUnclaimedIdle</a></span> may work, but it needs to start counting only when the parent reclaims all the child slot resources (so the entire slot is truly \"idle\").  We'd also want some parameter to let us know if the parent slot has ever created child slots (analogous to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalTimeClaimedBusy\" title=\"Total Time Claimed Busy\">TotalTimeClaimedBusy</a></span> being defined or not).</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Sep-24 17:14:09 by danb:</em> <br/>\n\nIt does still seem useful to have aggregate metrics for slot usage in the startd, but it seems to me the behavior you want is nearly achievable, given the new attributes added in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3712\" onclick=\"get_ticket_and_populate_wrapper('3712'); return false;\" title=\"startd should advertise statistics about preemption\">#3712</a></span>.  For detecting if the parent slot has ever created a child slot, one could use <code>TotalJobStarts</code>.  There is also <code>TotalRecentJobStarts</code> which is the number of jobs started in the past 20 minutes.  One could use that in the DAEMON_SHUTDOWN expression like this:\n\n<p></p><pre>    TotalSlots == 1 &amp;&amp; TotalRecentJobStarts == 0 &amp;&amp; CurrentTime-DaemonStartTime &gt; T1\n</pre>\n\n<p>One problem is a race condition between the time one long-running job ends and the next one begins.  During that time, the above expression could become true.  The race might be solved if we had <code>TotalRecentJobCompletions</code> instead, assuming it is updated before the expression is evaluated.\n\n</p><p></p><hr/>\n<em>2013-Sep-25 14:37:05 by burt:</em> <br/>\n\nWe <em>could</em> implement it this way, but it makes some of the glideinWMS termination knobs useless if T1 or T2 are greater than 20 minutes. (Typical values are shorter).\n\n<p>Would it make sense if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EnteredCurrentState\" title=\"Entered Current State\">EnteredCurrentState</a></span> was reset when the parent slot allocated or deallocated child slots?  It would be ok (preferred, actually) for me to alter the gWMS semantics to use differential idle time rather than aggregate, something like\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">Activity == \"Idle\" &amp;&amp; \\\n (RecentJobStarts == 0) &amp;&amp; (CurrentTime-EnteredCurrentState) &gt; T1 ||\n (CurrentTime-EnteredCurrentState) &gt; T2\n</pre></div>\n\n\n<p>?\n\n</p><p></p><hr/>\n<em>2013-Sep-26 10:44:30 by danb:</em> <br/>\n\nThat seems reasonable to me.  Having an explicit attribute that gives the time of the last change in partitioning might be less elegant but safer from semantic drift.\n\n<p></p><hr/>\n<em>2013-Nov-05 17:06:24 by johnkn:</em> <br/>\n\nI propose that we can solve this problem using the same expression for both static and partitionable slots by using the draining timestamps and the new <code>TotalJobStarts</code> attribute.  Both of these attributes refer to the state of the entire STARTD, which I think is what you want here.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">DAEMON_SHUTDOWN =\n   IfThenElse(TotalJobStarts &gt; 0,\n      (time() - ExpectedMachineGracefulDrainingCompletion) &gt; T2,\n      (time() - DaemonStartTime) &gt; T1))\n</pre></div>\n\n\n<p>Currently <code>ExpectedMachineGracefulDrainingCompletion</code> will continue to advance along with <code>time()</code> when there are no jobs running in the STARTD.  But I propose that we fix this behavior.  If <code>ExpectedMachineGracefulDrainingCompletion</code> represents the time the last job exited when there are no jobs running (actually no active claims), then it can be used to measure how long the STARTD has been idle.\n\n</p><p></p><hr/>\n<em>2013-Nov-06 11:46:27 by burt:</em> <br/>\n\nThat approach seems OK to me.\n\n<p></p><hr/>\n<em>2013-Nov-06 17:15:57 by johnkn:</em> <br/>\n\nI turns out that the <code>DaemonStartTime</code> attribute isn't in the ad a the time the DAEMON_SHUTDOWN expression is evaluated.  (see <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4051\" onclick=\"get_ticket_and_populate_wrapper('4051'); return false;\" title=\"DaemonStartTime can't be used in DAEMON_SHUTDOWN expression\">#4051</a></span>).  Fortunately, <code>SelfMonitorAge</code> has essentially the same information, so we can use that instead.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">DAEMON_SHUTDOWN =\n   IfThenElse(TotalJobStarts &gt; 0,\n      (time() - ExpectedMachineGracefulDrainingCompletion) &gt; T2,\n      SelfMonitorAge &gt; T1)\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Dec-05 10:26:25 by johnkn:</em> <br/>\n\ndraining attributes are:\n\n<p></p><pre>    ExpectedMachineQuickDrainingCompletion = 1386261173\n    ExpectedMachineGracefulDrainingBadput = 14844\n    ExpectedMachineQuickDrainingBadput = 14844\n    ExpectedMachineGracefulDrainingCompletion = 1386261173\n</pre>\n\n<p>badput is the amount of time of completed work that would be lost if we drained now.\n\n</p><p></p><hr/>\n<em>2014-Sep-15 15:23:20 by marco:</em> <br/>\n\nIn the expression mentioned there is the attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TotalJobStarts\" title=\"Total Job Starts\">TotalJobStarts</a></span>. In the Machine <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> I saw only <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStarts\" title=\"Job Starts\">JobStarts</a></span>. Are they the same?</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4051\" onclick=\"get_ticket_and_populate_wrapper('4051'); return false;\" title=\"DaemonStartTime can't be used in DAEMON_SHUTDOWN expression\">#4051</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonStartTime\" title=\"Daemon Start Time\">DaemonStartTime</a></span> can't be used in DAEMON_SHUTDOWN expression</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-05 13:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9025aa7e5ec9810aa7e444dd58fa3a95f0cc5d42\">[38942]</a></span>: minor doc change and 8.1.3 version history item for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3481\" onclick=\"get_ticket_and_populate_wrapper('3481'); return false;\" title='Different \"idle time\" counts for partitionable slots than normal slots'>#3481</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Nov-06 17:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/47db28142fbf5a33cb346a06d618987101761154\">[38116]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3481\" onclick=\"get_ticket_and_populate_wrapper('3481'); return false;\" title='Different \"idle time\" counts for partitionable slots than normal slots'>#3481</a></span>, change <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExpectedMachineGracefulDrainingCompletion\" title=\"Expected Machine Graceful Draining Completion\">ExpectedMachineGracefulDrainingCompletion</a></span>, and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExpectedMachineFastDrainingCompletion\" title=\"Expected Machine Fast Draining Completion\">ExpectedMachineFastDrainingCompletion</a></span> so that they represent the time that draining was completed if the machine has no active claims. Before this patch, these attributes would always contain the current time if there were no active claims.\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Sep-15 15:23", "status": "resolved", "created": "2013-Feb-05 09:51", "fixed_version": "2013-Feb-05 09:51", "broken_version": "v070800", "priority": "2", "subsystem": "Daemons", "assigned_to": "johnkn", "derived_from": "", "creator": "burt", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "burt@fnal.gov, parag@fnal.gov, tannenba@cs.wisc.edu, gthain@cs.wisc.edu", "due_date": "20131108"}