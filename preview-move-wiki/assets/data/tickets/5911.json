{"id": 5911, "title": "Ticket #5911: Invalid security session use by schedd", "description": "<blockquote>\nCMS noticed many many p-slots that were unnecessarily idling.  Investigation showed that negotiation was fine, but, when the schedd attempted to claim the p-slot, it unexpectedly had the socket closed by the remote end.\n\n<p>On the worker node, the corresponding lines were as follows:\n\n</p><p></p><div class=\"verbatim\">\n<pre>09/20/16 14:28:57 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#1, failing; this session was requested by SCHEDD &lt;SCHEDDIP:4080?addrs=SCHEDDIP-4080+[--1]-4080&amp;noUDP&amp;sock=79603_edf1_35&gt; on &lt;SCHEDDIP:64714&gt; with return address &lt;SCHEDDIP:4080?addrs=SCHEDDIP-4080+[--1]-4080&amp;noUDP&amp;sock=79603_edf1_35&gt;\n09/20/16 14:28:57 (pid:5482) Failed to send DC_INVALIDATE_KEY to daemon at &lt;SCHEDDIP:4080&gt;: SECMAN:2009:DENIED authorization of server 'unauthenticated@unmapped/SCHEDDIP' (I am acting as the client): reason: CLIENT authorization policy contains no matching ALLOW entry for this request; identifiers used for this host: SCHEDDIP,SCHEDD.example.com, hostname size = 1, original ip address = SCHEDDIP.\n</pre></div>\n\n\n<p>Note that the timestamp in the session key is 1474378538, which is <code>09/20/16 13:35:38</code> (about the time the <code>startd</code> daemon started up).\n\n</p><p>Looking through the <code>StartdLog</code>, this was the first time the schedd had contacted this worker node.\n\n</p><p>It seems that the <code>DC_INVALIDATE_KEY</code> issue is a glideinWMS misconfiguration: should it even be possible for <code>ALLOW_CLIENT</code> to prevent session invalidation?\n\n</p><p>CMS uses the knobs that allow the secondary collectors to skip the forwarding of updates to the parent collector if it does not think the update is \"significant\":\n\n</p><p></p><div class=\"verbatim\">\n<pre>COLLECTOR_FORWARD_FILTERING = TRUE\nCOLLECTOR_FORWARD_INTERVAL = 600\n</pre></div>\n\n\n<p>Additionally, there were network connectivity issues throughout the day, but none logged between the startd startup and the error message at 14:28..\n\n</p><p>Current working theory is that \"somehow\" a private ad update is being missed, causing an invalid match-based session to be used for authentication.  It's not clear how a public ad update would occur without a private ad update.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Sep-20 15:14:38 by bbockelm:</em> <br/>\n\nPossibly more mysterious:\n\n<p></p><div class=\"verbatim\">\n<pre>09/20/16 14:28:57 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#1, failing; .... SCHEDD &lt;IP.236\n09/20/16 16:19:26 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#32, failing; .... SCHEDD &lt;IP.44\n09/20/16 17:01:01 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#15, failing; ... SCHEDD &lt;IP.227\n09/20/16 17:06:01 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#22, failing; ... SCHEDD &lt;IP.227\n09/20/16 17:16:34 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#1, failing; ... SCHEDD &lt;IP.47\n09/20/16 17:26:40 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#15, failing; ... SCHEDD &lt;IP.214\n09/20/16 17:34:05 (pid:5482) DC_AUTHENTICATE: attempt to open invalid session &lt;WORKERIP:33277&gt;#1474378538#62, failing; ... SCHEDD &lt;IP.214\n</pre></div>\n\n\n<p>Now, session IDs are supposed to be monotonically increasing and unique, no?\n\n</p><p></p><hr/>\n<em>2016-Sep-20 15:29:55 by bbockelm:</em> <br/>\n\nFound the relevant code: <code>newIdString</code> in <code>claim.cpp</code> generates the new Claim ID and, indeed, the ID should be monotonically increasing.  That means there are some bizarre and strange reuse issues going on here.\n\n<p></p><hr/>\n<em>2016-Sep-20 15:42:35 by jfrey:</em> <br/>\n\nUpdate filtering within the collector tree may be contributing (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5913\" onclick=\"get_ticket_and_populate_wrapper('5913'); return false;\" title=\"Consider ClaimId in collector forward filter\">#5913</a></span>).\n\n<p></p><hr/>\n<em>2016-Sep-20 15:47:08 by bbockelm:</em> <br/>\n\nI don't think it's the problem here, but it seems that the assumption the claim ID is unique is dicey.  There's currently zero duplicated claim IDs, but 847 startds have identical IP addresses and startup times.  It seems this is exacerbated by the fact glideins startup frequently and IPs are commonly reused (i.e., at Docker sites or same IP space between different clusters).\n\n<p></p><hr/>\n<em>2016-Sep-20 16:01:45 by bbockelm:</em> <br/>\n\nNote that Claim ID <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=1\" onclick=\"get_ticket_and_populate_wrapper('1'); return false;\" title=\"Another Test\">#1</a></span> was used at13:50:29 by schedd IP *.51, then is attempted to be used again at 17:16:34 by schedd at IP *.47.\n\n<p></p><hr/>\n<em>2016-Sep-20 21:11:43 by bbockelm:</em> <br/>\n\nThere's no bizarre timeouts set.  Here's what I see:\n\n<p></p><div class=\"verbatim\">\n<pre>REQUEST_CLAIM_TIMEOUT = 240\nSEC_DEFAULT_AUTHENTICATION_TIMEOUT = 20\nSTARTD_CONTACT_TIMEOUT = 45\n</pre></div>\n\n\n<p>Not sure which of these apply here, but they all look much less than hours-long.\n\n</p><p></p><hr/>\n<em>2016-Sep-21 11:29:30 by jfrey:</em> <br/>\n\nIf two startds generate the same Claim ID and both end up going to the same schedd, then the two IDs will collide in the schedd's security session ID table. When the schedd attempts to use the second one, it will notice the collision and try to negotiate a new session with that startd. The following lines will appear in the log:\n\n<p></p><div class=\"verbatim\">\n<pre>SECMAN: failed to create session %s (key already exists).\nSECMAN: existing session %s:\n&lt;session policy ad if D_SECURITY enabled&gt;\nSEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION: failed to create security session for %s, so will try to obtain a new security session\n</pre></div>\n\n\n<p></p><hr/>\n<em>2016-Sep-21 16:10:41 by bbockelm:</em> <br/>\n\nI see no instance of that message in the schedd logs.\n\n<p></p><hr/>\n<em>2016-Sep-26 10:05:32 by bbockelm:</em> <br/>\n\nI do see a lot of these:\n\n<p></p><div class=\"verbatim\">\n<pre>09/26/16 17:01:02 (pid:11999) SECMAN: removing lingering non-negotiated security session &lt;IP1:40031&gt;#1474771235#107 because it conflicts with new request\n09/26/16 17:01:02 (pid:11999) SECMAN: removing lingering non-negotiated security session &lt;IP2:34784&gt;#1474771651#172 because it conflicts with new request\n09/26/16 17:01:02 (pid:11999) SECMAN: removing lingering non-negotiated security session &lt;IP3:1853&gt;#1474859376#92 because it conflicts with new request\n09/26/16 17:01:02 (pid:11999) SECMAN: removing lingering non-negotiated security session &lt;IP4:24618&gt;#1474852573#52 because it conflicts with new request\n</pre></div>\n\n\n<p>Are they a similar issue?\n\n</p><p></p><hr/>\n<em>2016-Sep-26 12:19:23 by bbockelm:</em> <br/>\n\nMore oddities from the pool: the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> is very different from the schedd itself.\n\n<p>For example, the <code>MATCH_EXP</code> recorded in the event log don't match the <code>MATCH_EXP</code> recorded in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span>:\n\n</p><p></p><div class=\"verbatim\">\n<pre>[root@HOST ~]# grep MATCH_EXP_JOBGLIDEIN_CMSSite `condor_q 36491.92 -af UserLog` | sort | uniq -c\n     41     &lt;a n=\"MATCH_EXP_JOBGLIDEIN_CMSSite\"&gt;<s>T2_DE_RWTH</s>\n     20     &lt;a n=\"MATCH_EXP_JOBGLIDEIN_CMSSite\"&gt;<s>T2_ES_IFCA</s>\n      1     &lt;a n=\"MATCH_EXP_JOBGLIDEIN_CMSSite\"&gt;<s>T3_US_OSG</s>\n[root@HOST ~]# condor_q 36491.92 -l | sort | grep MATCH_EXP_JOBGLIDEIN_CMSSite\nJobAdInformationAttrs = \"JobStatus,QDate,EnteredCurrentStatus,JobStartDate,DESIRED_Sites,ExtDESIRED_Sites,WMAgent_JobID,MATCH_EXP_JOBGLIDEIN_CMSSite\"\nMATCH_EXP_JOBGLIDEIN_CMSSite = \"T2_US_Nebraska\"\n</pre></div>\n\n\n<p>We're also seeing somewhere around 50% of our <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLogs\" title=\"Event Logs\">EventLogs</a></span> missing the <code>MATCH_EXP</code> lines completely, even if the job is requesting it.  Not sure if that's related.\n\n</p><p></p><hr/>\n<em>2016-Sep-26 12:42:40 by bbockelm:</em> <br/>\n\nWhoops - just uploaded a misleading attachment (didn't realize schedd was at D_FULLDEBUG, meaning the particular message was expected)...\n\n<p></p><hr/>\n<em>2016-Sep-27 15:49:06 by bbockelm:</em> <br/>\n\nNOTE: The above comment about the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> and <code>MATCH_EXP_</code> is now understood to be completely separate and handled in a different ticket (<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5921\" onclick=\"get_ticket_and_populate_wrapper('5921'); return false;\" title=\"MATCH info dropped from user log on claim reuse\">#5921</a></span>).  So, for here, just ignore it.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "", "type": "incident", "last_change": "2016-Sep-27 15:49", "status": "new", "created": "2016-Sep-20 15:07", "fixed_version": "2016-Sep-20 15:07", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "tannenba", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu,jfrey@cs.wisc.edu,zmiller@cs.wisc.edu", "due_date": ""}