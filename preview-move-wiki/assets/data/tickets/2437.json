{"id": 2437, "title": "Ticket #2437: CRON job object state not marked idle after forced termination", "description": "<blockquote>\nThere seems to be a bug in the state handling of the cron object. The cron job\ntakes too long to complete because of the system state. When the startd tries\nto fire off the next periodic cron job, the startd kills the one that is still\nrunning. The state of the cron object for the one still running gets changed to\nCRON_KILL_SENT. The reaper changes this state to CRON_DEAD, but there doesn't\nseem to be a mechanism to transition the state to CRON_IDLE or CRON_READY. In\nthe next periodic cron job, the cron object's state is checked against\nCRON_IDLE and CRON_READY, but since it's CRON_DEAD, CronJob::StartJob returns\nwith the \"not idle!\" message.\n\n<p></p><hr/>\nIt's easily repro'ed with\n\n<p></p><pre>  STARTD_CRON_NAME = CRON\n  STARTD_CRON_HOME = /opt/condor/bin\n  CRON_JOBLIST = JRTCRON\n  CRON_JRTCRON_EXECUTABLE = $(STARTD_CRON_HOME)/jrt\n  CRON_JRTCRON_PERIOD = 5\n  CRON_JRTCRON_RECONFIG = false\n  CRON_JRTCRON_KILL = true\n</pre>\n\n<p></p><pre>  $ cat /opt/condor/bin/jrt\n  #!/bin/sh\n</pre>\n\n<p></p><pre>  /bin/sleep 1d\n====</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-14 15:28:25 by tstclair:</em> <br/>\n\nreviewed by tstclair</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/449/cron.patch\">cron.patch</a>\n969 bytes added by jrt on 2011-Sep-01 20:30:30 UTC.\n<br/>\nPatch for fixing up state in the reaper.\n\n<p>The main problem is that CRON_*_SENT ends up being changed to CRON_DEAD which is a dead end state for the CRON object.  The reaper shouldn't be called unless the process is dead. If that is the case, then the reaper should change the state to CRON_IDLE in all cases. If <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=KillJob\" title=\"Kill Job\">KillJob</a></span> and the reaper is triggered due to the cron destructor, the ending state is irrelevant. But the ending state must be CRON_IDLE for subsequent periodic runs of the job.\n<br/>\n</p></li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-14 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27211\">[27211]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2437\" onclick=\"get_ticket_and_populate_wrapper('2437'); return false;\" title=\"CRON job object state not marked idle after forced termination\">#2437</a></span> CRON job object state not marked idle after forced termination Patch created by jrt, committed by tstclair ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2437\" onclick=\"get_ticket_and_populate_wrapper('2437'); return false;\" title=\"CRON job object state not marked idle after forced termination\">#2437</a></span> ===VersionHistory:None===  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-14 15:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=27210\">[27210]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2437\" onclick=\"get_ticket_and_populate_wrapper('2437'); return false;\" title=\"CRON job object state not marked idle after forced termination\">#2437</a></span> CRON job object state not marked idle after forced termination Patch created by jrt, committed by tstclair ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2437\" onclick=\"get_ticket_and_populate_wrapper('2437'); return false;\" title=\"CRON job object state not marked idle after forced termination\">#2437</a></span> ===VersionHistory:None===  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Sep-14 15:28", "status": "resolved", "created": "2011-Sep-01 15:28", "fixed_version": "2011-Sep-01 15:28", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "jrt", "derived_from": "", "creator": "jrt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu,tstclair@redhat.com,dan@hep.wisc.edu", "due_date": ""}