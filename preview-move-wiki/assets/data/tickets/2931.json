{"id": 2931, "title": "Ticket #2931: Reconfig can cause negotiation cycle failure", "description": "<blockquote>\nReconfigs can take a long time and in some cases cause a disruption in\ncommunication that causes failure in the negotiation cycle. The previous code\nonly blocked the group tree building parts of the cycle and not the daemoncore\npart. Blocking in the cycle has to be selective due to:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">   // Service any interactive commands on our command socket.\n  // This keeps condor_userprio hanging to a minimum when\n  // we are involved in a lot of schedd negotiating.\n  // It also performs the important function of draining out\n  // any reschedule requests queued up on our command socket, so\n  // we do not negotiate over &amp; over unnecesarily.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-10 12:29:36 by eje:</em> <br/>\n\nTest scenario:\n\n<p>Using the following configuration:\n</p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG | D_SECURITY\nNEGOTIATOR_INTERVAL = 30\nNEGOTIATOR_CYCLE_DELAY = 5\n\nCLAIM_WORKLIFE = 0\n\nNUM_CPUS = 20\n\n# easter egg, allows delay/duration to be inserted into negotiator cycles.\nNEG_SLEEP = 30\n</pre></div>\n\n\n<p>Spin up a pool, and follow the negotiator log with the following grep:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e ' Cycle ' -e 'GRANTED.*RECONFIG' -e 'GRANTED.*GetPriority' -e 'begin sleep' -e 'end sleep' -e 'Delaying reconfig' -e 'NEGOTIATOR_INTERVAL ='\n04/10/12 09:49:10 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:10 ---------- Finished Negotiation Cycle ----------\n</pre></div>\n\n\n<p>In a second window, submit a few jobs, like so:\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 30\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup = \"none.user0000\"\nqueue 4\n</pre></div>\n\n\n<p>Watch the negotiator log, until you see the first sleep delay:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e ' Cycle ' -e 'GRANTED.*RECONFIG' -e 'GRANTED.*GetPriority' -e 'begin sleep' -e 'end sleep' -e 'Delaying reconfig' -e 'NEGOTIATOR_INTERVAL ='\n04/10/12 09:49:10 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:10 ---------- Finished Negotiation Cycle ----------\n04/10/12 09:49:15 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:15 begin sleep: 30 seconds\n</pre></div>\n\n\n<p>Now submit the following reconfig + userprio sequence.  This command will initially wait, just let it go:\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_reconfig -neg ; condor_userprio\n</pre></div>\n\n\n<p>The first sleep delay will end, and the reconfig will be serviced, but it will delay.  You should now see the following in your two windows:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e ' Cycle ' -e 'GRANTED.*RECONFIG' -e 'GRANTED.*GetPriority' -e 'begin sleep' -e 'end sleep' -e 'Delaying reconfig' -e 'NEGOTIATOR_INTERVAL ='\n04/10/12 09:49:10 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:10 ---------- Finished Negotiation Cycle ----------\n04/10/12 09:49:15 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:15 begin sleep: 30 seconds\n04/10/12 09:49:45 end sleep: 30 seconds\n04/10/12 09:49:45 PERMISSION GRANTED to unauthenticated@unmapped from host 192.168.1.2 for command 60012 (DC_RECONFIG_FULL), access level WRITE: reason: WRITE authorization policy allows access by anyone\n04/10/12 09:49:45 Delaying reconfig.\n04/10/12 09:49:45 begin sleep: 30 seconds\n</pre></div>\n\n\n<p></p><div class=\"code\">\n<pre class=\"code\">$ condor_reconfig -neg ; condor_userprio\nSent \"Reconfig\" command to negotiator eje@localhost.localdomain\n</pre></div>\n\n\n<p>Next, the second sleep completes, and then the userprio is serviced.  This will not be delayed.  Now you should see the following in your two windows:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e ' Cycle ' -e 'GRANTED.*RECONFIG' -e 'GRANTED.*GetPriority' -e 'begin sleep' -e 'end sleep' -e 'Delaying reconfig' -e 'NEGOTIATOR_INTERVAL ='\n04/10/12 09:49:10 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:10 ---------- Finished Negotiation Cycle ----------\n04/10/12 09:49:15 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:15 begin sleep: 30 seconds\n04/10/12 09:49:45 end sleep: 30 seconds\n04/10/12 09:49:45 PERMISSION GRANTED to unauthenticated@unmapped from host 192.168.1.2 for command 60012 (DC_RECONFIG_FULL), access level WRITE: reason: WRITE authorization policy allows access by anyone\n04/10/12 09:49:45 Delaying reconfig.\n04/10/12 09:49:45 begin sleep: 30 seconds\n04/10/12 09:50:15 end sleep: 30 seconds\n04/10/12 09:50:15 PERMISSION GRANTED to unauthenticated@unmapped from host 192.168.1.2 for command 451 (GetPriority), access level READ: reason: READ authorization policy allows access by anyone\n04/10/12 09:50:16 begin sleep: 30 seconds\n</pre></div>\n\n\n<p>(note, my userprio output was empty since I started with clean condor state)\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_reconfig -neg ; condor_userprio\nSent \"Reconfig\" command to negotiator eje@localhost.localdomain\nLast Priority Update:  4/10 09:49\n                                    Effective\nUser Name                           Priority\n------------------------------      ---------\n------------------------------      ---------\nNumber of users shown: 0\n</pre></div>\n\n\n<p>Now, the remaining sleeps will complete, and after the end of the cycle you should see that the delayed reconfig request actually executes, evidenced by \"NEGOTIATOR_INTERVAL = 30 sec\":\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f NegotiatorLog | grep -e ' Cycle ' -e 'GRANTED.*RECONFIG' -e 'GRANTED.*GetPriority' -e 'begin sleep' -e 'end sleep' -e 'Delaying reconfig' -e 'NEGOTIATOR_INTERVAL ='\n04/10/12 09:49:10 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:10 ---------- Finished Negotiation Cycle ----------\n04/10/12 09:49:15 ---------- Started Negotiation Cycle ----------\n04/10/12 09:49:15 begin sleep: 30 seconds\n04/10/12 09:49:45 end sleep: 30 seconds\n04/10/12 09:49:45 PERMISSION GRANTED to unauthenticated@unmapped from host 192.168.1.2 for command 60012 (DC_RECONFIG_FULL), access level WRITE: reason: WRITE authorization policy allows access by anyone\n04/10/12 09:49:45 Delaying reconfig.\n04/10/12 09:49:45 begin sleep: 30 seconds\n04/10/12 09:50:15 end sleep: 30 seconds\n04/10/12 09:50:15 PERMISSION GRANTED to unauthenticated@unmapped from host 192.168.1.2 for command 451 (GetPriority), access level READ: reason: READ authorization policy allows access by anyone\n04/10/12 09:50:16 begin sleep: 30 seconds\n04/10/12 09:50:46 end sleep: 30 seconds\n04/10/12 09:50:46 begin sleep: 30 seconds\n04/10/12 09:51:16 end sleep: 30 seconds\n04/10/12 09:51:16 begin sleep: 30 seconds\n04/10/12 09:51:46 end sleep: 30 seconds\n04/10/12 09:51:46 ---------- Finished Negotiation Cycle ----------\n04/10/12 09:51:46 NEGOTIATOR_INTERVAL = 30 sec\n</pre></div>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-10 15:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f2a735a8eb332dbfd23911976961a68c1745caf4\">[31606]</a></span>: Removed obsolete delayReinit global ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2931\" onclick=\"get_ticket_and_populate_wrapper('2931'); return false;\" title=\"Reconfig can cause negotiation cycle failure\">#2931</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-10 12:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c15079541a13a2762650010809f69ba1d8cfe646\">[31599]</a></span>: ===VersionHistory:Completed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2931\" onclick=\"get_ticket_and_populate_wrapper('2931'); return false;\" title=\"Reconfig can cause negotiation cycle failure\">#2931</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-10 12:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9455e9daeeedc2b06c724c79a70ef0328fa321de\">[31598]</a></span>: Added facility to delay DC reconfig - applied in the negotiator to delay reconfig requests during the negotiation cycle that can cause blocking ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2931\" onclick=\"get_ticket_and_populate_wrapper('2931'); return false;\" title=\"Reconfig can cause negotiation cycle failure\">#2931</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jul-11 10:23", "status": "resolved", "created": "2012-Apr-09 13:18", "fixed_version": "2012-Apr-09 13:18", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, dan@hep.wisc.edu, tstclair@redhat.com, jthomas@redhat.com", "due_date": ""}