{"id": 6637, "title": "Ticket #6637: 49ec2-instance.sh does not retry or shutdown node on failures", "description": "<blockquote>\nHeath reports that when starting enough instances, the <code>49ec2-instance.sh</code> script will trigger Amazon's DoS defenses:\n\n<p></p><div class=\"verbatim\">\n<pre>I've been deploying 100 instances at a time in\n10-20 minute intervals.\u00a0 One thing I notice on 1% of the instances is that\nthe condor-annex-ec2 service fails with a RequestLimitExceeded error from\nAWS and just gives up.\u00a0 This causes the instance to not join the pool and\njust sit there.\n\nApr 02 20:41:49 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: Note: Forwarding request to 'systemctl is-enabled\ncondor.service'.\nApr 02 20:41:49 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: enabled\nApr 02 20:42:00 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: Configuring HTCondor to be an EC2 annex: waiting for\nSpot Fleet to tag me: OK\nApr 02 20:42:00 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: An error occurred (RequestLimitExceeded) when\ncalling the DescribeSpotFleetRequests o...ceeded.\nApr 02 20:42:02 ip-172-31-23-203.us-east-2.compute.internal\ncondor-annex-ec2[1059]: failed!\n</pre></div>\n\n\n<p></p><ul>\n<li>The script should include several random seconds of splay on start-up to help avoid this problem.\n</li><li>The script should retry (with random and exponential back-off).\n</li><li>The script should [probably] just shut the machine down if it fails.  Think about this carefully, since it will make debugging nightmare.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2018-Apr-04 15:32:10 by tlmiller:</em> <br/>\n\ndup of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6638\" onclick=\"get_ticket_and_populate_wrapper('6638'); return false;\" title=\"49ec2-instance.sh does not retry or shutdown node on failures\">#6638</a></span>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2018-Apr-04 15:32", "status": "abandoned", "created": "2018-Apr-04 11:06", "fixed_version": "2018-Apr-04 11:06", "broken_version": "v080707", "priority": "2", "subsystem": "Annex", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}