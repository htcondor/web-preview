{"id": 6337, "title": "Ticket #6337: If USE_KEYRING_SESSIONS is on, check retval of condor_keyctl_session()", "description": "<blockquote>\nWe don't currently check the return value of <code>condor_keyctl_session()</code> which means we might be failing to actually discard keyrings when switching priv state.\n\n<p>This may fail because the keyring garbage collector seems to not be as aggressive as possible.  In the case it fails, we sleep a tiny amount (1 microsecond) and then try again.  After a default of 20 seconds, we completely give up and <code>EXCEPT()</code>.  The number of seconds can be controlled by <code>KEYRING_SESSION_CREATION_TIMEOUT</code>.\n\n</p><p>Although this is technically a bug, the possibility of sleeping when changing priv state is a fairly major change in behavior, so I have targeted this for the 8.7.X developer series.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Sep-11 12:00:03 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good, would just suggest doing usleep(1000) to sleep a ms instead of usleep(1).  I highly doubt the garbage collector will run within just a usec, so the code as-is is really just calling time(NULL) in a tight loop.\n\n</p><p>FWIW, no real need to call time() in the inner loop, since you could divide the timeout (20 seconds) by the sleep time (1 ms) to find out how many times to sleep before timing out.\n\n</p><p>Patch needs a version history entry, although I do not think the config knob needs to be documented (it is really just for developers).\n\n</p><p></p><hr/>\n<em>2017-Sep-12 13:13:54 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW 2</strong>\n\n<p>Patch  <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7238c42c6fa84101ae77822f77ca5190d1017143\">[52319]</a></span> to address code review looks good, resolving.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-12 11:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7238c42c6fa84101ae77822f77ca5190d1017143\">[52319]</a></span>: Lengthen sleep time, stop calling time(0), as suggested in code review. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6337\" onclick=\"get_ticket_and_populate_wrapper('6337'); return false;\" title=\"If USE_KEYRING_SESSIONS is on, check retval of condor_keyctl_session()\">#6337</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-02 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/44349632a2f1d2e7a0f52ba5e29946591da2a9d9\">[51988]</a></span>: Only sleep and retry on an EDQUOT error. All others are fatal. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6337\" onclick=\"get_ticket_and_populate_wrapper('6337'); return false;\" title=\"If USE_KEYRING_SESSIONS is on, check retval of condor_keyctl_session()\">#6337</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-07 13:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7d5ec0bc814db8749e95eef68fb552457a3daa26\">[51835]</a></span>: Check return value of condor_keyctl_session and sleep/loop until success or timeout. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6337\" onclick=\"get_ticket_and_populate_wrapper('6337'); return false;\" title=\"If USE_KEYRING_SESSIONS is on, check retval of condor_keyctl_session()\">#6337</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Sep-12 13:14", "status": "resolved", "created": "2017-Jul-07 13:36", "fixed_version": "2017-Jul-07 13:36", "broken_version": "v080600", "priority": "2", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "zmiller", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "zmiller@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": "20170710"}