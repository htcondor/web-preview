{"id": 3992, "title": "Ticket #3992: Don't fear the reaper! Reaper events are being starved", "description": "<blockquote>\n<span class=\"subsection\"><h3>Plan </h3></span>\n\n<p>Add knob <code>MAX_REAPS_PER_CYCLE</code> to control how many reaper handlers will get called per daemon core event loop. Default will be 0 - a value of 0 means call as many reapers as are waiting at the time we exit select().\n\n</p><p>Also, currently daemon core invokes reaper handlers very late in the event loop. Instead, it should invoke reapers early, esp before invoking new command handlers that may want to spawn new workers.\n\n</p><p><span class=\"subsection\"></span></p><h3>Motivation and Reasoning</h3>\n\n<p>In CHTC on a busy submit node, observed the shared_port_daemon getting into a state where it literally had 0 child worker processes on the system, and yet the log file claimed it could not spawn any additional workers because it was already at 1000 max worker. This happened over and over, and obviously greatly impacted the performance of the shared port daemon due to limited concurrency. The problem is the shared_port_daemon is spawning very short-lived workers at a much faster rate than it reaps them (note: this is exasperated by the default <code>MAX_ACCEPTS_PER_CYCLE</code> being 8).\n\n</p><p>An exited child means completed work that needs to be committed (in the case of a shadow for instance), or a worker that is ready for more work once we reap (in the case of shared port, collector, etc).  So assuming that a reaper handler will spawn either zero or one new processes at most (usually zero), we have an incentive to prioritize reapers to clean-out the system.\n\n</p><p><em>In the words of Blue Oyster Cult, \"Don't fear the reapers!\"</em>  Yes, I'm old.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Oct-21 10:21:25 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  Code is correct and does what we way.  I do want to record here the verbal decision to not put these knob into the param table or config file, as we hope no one will ever need to set them.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4210\" onclick=\"get_ticket_and_populate_wrapper('4210'); return false;\" title=\"Fear the reaper a bit. Don't reap while selecting\">#4210</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFear the reaper a bit. Don't reap while selecting</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-24 10:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37969\">[37969]</a></span>: minor edit of 8.1.2 version history item and fix typo in a knob defn <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3992\" onclick=\"get_ticket_and_populate_wrapper('3992'); return false;\" title=\"Don't fear the reaper! Reaper events are being starved\">#3992</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-18 16:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37935\">[37935]</a></span>: Call reaper handlers before we deal with incoming commands. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3992\" onclick=\"get_ticket_and_populate_wrapper('3992'); return false;\" title=\"Don't fear the reaper! Reaper events are being starved\">#3992</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-18 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37929\">[37929]</a></span>: Document MAX_REAPS_PER_CYCLE in manual and version history. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3992\" onclick=\"get_ticket_and_populate_wrapper('3992'); return false;\" title=\"Don't fear the reaper! Reaper events are being starved\">#3992</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-18 14:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=37928\">[37928]</a></span>: Implement MAX_REAPS_PER_CYCLE, invoke all pending reapers per cycle. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3992\" onclick=\"get_ticket_and_populate_wrapper('3992'); return false;\" title=\"Don't fear the reaper! Reaper events are being starved\">#3992</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Oct-21 11:14", "status": "resolved", "created": "2013-Oct-18 11:33", "fixed_version": "2013-Oct-18 11:33", "broken_version": "v080000", "priority": "2", "subsystem": "DaemonSharedP", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu gthain@cs.wisc.edu", "due_date": ""}