{"id": 7168, "title": "Ticket #7168: condor_chirp getdir segfaults with empty subdirectories", "description": "<blockquote>\nWhen trying to use \"condor_chirp getdir\" with an empty directory, chirp fails with exit code 134, segfaults and dumps a core file.\n\n<p>Core file can be found below:\n<a class=\"external\" href=\"http://stash.osgconnect.net/+khurtado/chirp_condor/\">http://stash.osgconnect.net/+khurtado/chirp_condor/</a>\n\n</p><p>How to reproduce:\n</p><hr/>\n- In the submit directory on the submit/schedd node, create a directory structure like:\n<div class=\"code\">\n<pre class=\"code\">$ mkdir -p test/empty\n$ touch test/hello\n</pre></div>\n\n\n<p>- Then, condor_ssh_to_job to a sleep job with +WantIOProxy = True and use getdir.\ngetdir will be successfull with test, but will segfault with test/empty\n</p><div class=\"code\">\n<pre class=\"code\">condor_ssh_to_job 70066.0\nWelcome to slot1@d6cneh004.crc.nd.edu!\nYour condor job is running with pid(s) 21419.\nbash-4.2$ condor_chirp getdir test\nhello\nempty\n\nbash-4.2$ condor_chirp getdir test/empty\nchirp: couldn't get response from server: No such file or directory\nAborted (core dumped)\nbash-4.2$ echo $?\n134\n</pre></div>\n\n<hr/>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Jul-29 11:57:00 by jfrey:</em> <br/>\n\nI've found a few bugs in HTCondor's handling of <code>getdir</code> and <code>getlongdir</code> based on your report:\n\n<p></p><ul>\n<li>The condor_shadow treats an empty directory the same as failure to list the directory, but the errno is left unset (so can be any value).\n</li><li>The condor_starter treats a result code of 0 as a failure.\n</li><li>The chirp client code free()s an uninitialized buffer when the server returns an error (causing the crash you observed).\n</li></ul>\n\n<p>These should be easy to fix.\n\n</p><p></p><hr/>\n<em>2019-Aug-06 12:48:36 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> change looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Aug-05 16:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57594\">[57594]</a></span>: Docs for condor_chirp getdir crash fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7168\" onclick=\"get_ticket_and_populate_wrapper('7168'); return false;\" title=\"condor_chirp getdir segfaults with empty subdirectories\">#7168</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Jul-29 15:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57516\">[57516]</a></span>: Fix handling of chirp getdir and getlongdir commands. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7168\" onclick=\"get_ticket_and_populate_wrapper('7168'); return false;\" title=\"condor_chirp getdir segfaults with empty subdirectories\">#7168</a></span> * Distinguish between \"can't get directory listing\" and \"directory is empty\" in the shadow. * Treat a result value of 0 as a success in the starter. * Don't free() an uninitialized pointer on error in the chirp client.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Aug-06 12:49", "status": "resolved", "created": "2019-Jul-26 12:41", "fixed_version": "2019-Jul-26 12:41", "broken_version": "v080408", "priority": "2", "subsystem": "Unknown", "assigned_to": "jfrey", "derived_from": "", "creator": "khurtado", "rust": "", "customer_group": "other", "visibility": "public", "notify": "btovar@nd.edu, khurtado@nd.edu", "due_date": ""}