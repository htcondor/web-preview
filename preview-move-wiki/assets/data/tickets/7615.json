{"id": 7615, "title": "Ticket #7615: New and old schedds and negotiators in 8.9 can't talk with each other", "description": "<blockquote>\nAn 8.9.3 schedd can't talk with an 8.9.4+ negotiator and an 8.9.4+ schedd can't talk with an 8.9.3 negotiator. This is due to the combination of two recent changes. In 8.9.3, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6956\" onclick=\"get_ticket_and_populate_wrapper('6956'); return false;\" title='\"Match password auth\" for schedds'>#6956</a></span> added a non-negotiated security session between the schedd and the negotiator, communicated via the submitter ad. This is similar to the match session between the startd and the schedd. Unlike the startd/schedd match session, when the schedd exports the session info for the negotiator, it doesn't include the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CryptoMethods\" title=\"Crypto Methods\">CryptoMethods</a></span> attribute. In 8.8.6 and 8.9.4, the default encryption method was changed from 3DES to BLOWFISH. Since the schedd doesn't specify which encryption method to use in the schedd/negotiator security session, each side uses its default, which is different between 8.9.3 and 8.9.4+.\n\n<p>When the schedd creates the security session string for the submitter ad, it should use SecMan::ExportSecSessionInfo() to get the security policy ad. This call returns a policy ad that includes the crucial <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CryptoMethods\" title=\"Crypto Methods\">CryptoMethods</a></span> attribute. The schedd should also use the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClaimIdParser\" title=\"Claim Id Parser\">ClaimIdParser</a></span> class to construct the full session string (this doesn't pertain to this bug, but may help avoid future ones).\n\n</p><p>For new negotiators talking to 8.9.3 schedds, we can force the encryption method to be 3DES in the negotiator if the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersion\" title=\"Condor Version\">CondorVersion</a></span> attribute in the submitter ad says it's 8.9.3.\n\n</p><p>This bug will affect Condor versions 8.9.4-8.9.6 if the admin changes the default encryption algorithm for either the negotiator or the schedd.\n\n</p><p>A workaround for this bug is to set NEGOTIATOR.SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION=False in the config for the negotiator. Setting this for the schedd is not be viable for pools with busy schedds (i.e. schedds managing more than a few thousand running jobs), as it affects startd/schedd non-negotiated sessions as well.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-May-18 13:09:58 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>:  Looks good.  Hitting this issue is pretty rare.  Should we add something to version history?  If not, please resolve.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-18 15:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b418c2b99f51b449be2625c7a7c722154292551f\">[59677]</a></span>: Docs for schedd/negotiator crypto mismatch bug in 8.9. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7615\" onclick=\"get_ticket_and_populate_wrapper('7615'); return false;\" title=\"New and old schedds and negotiators in 8.9 can't talk with each other\">#7615</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-28 10:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/77767249599e842ccd675346899bfbd9f8ce88e9\">[59508]</a></span>: Fix policy in security sessions received by negotiator from old schedds <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7615\" onclick=\"get_ticket_and_populate_wrapper('7615'); return false;\" title=\"New and old schedds and negotiators in 8.9 can't talk with each other\">#7615</a></span> When an 8.9.3 schedd creates a non-negotiated security session for use by the negotiator to contact it, the policy it sends out doesn't include the encryption algorithm, and the default algorithm changed in 8.9.4 from 3DES\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-24 12:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/25ac4e38e6ca447f298bbbde68fc51b9d157ef52\">[59475]</a></span>: Fix policy in security sessions sent by schedd to negotiator/collector <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7615\" onclick=\"get_ticket_and_populate_wrapper('7615'); return false;\" title=\"New and old schedds and negotiators in 8.9 can't talk with each other\">#7615</a></span> When the schedd creates a non-negotiated security session for use by the collector and negotiator to contact it, the policy it sends out doesn't include the encryption method or expiration time. This caused breakage when the\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-May-18 15:20", "status": "resolved", "created": "2020-Apr-22 22:00", "fixed_version": "2020-Apr-22 22:00", "broken_version": "v080904", "priority": "1", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tannenba@cs.wisc.edu, zmiller@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}