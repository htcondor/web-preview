{"id": 1398, "title": "Ticket #1398: PREPARE hook invocation failure does not abort job execution", "description": "<blockquote>\n<div class=\"verbatim\">\n<pre>The prepare hook can return non-0, which indicates the job should not be run.\n\nHowever, failure to invoke the prepare hook does not have the same effect.\n\n\n\nSteps to Reproduce:\n1.\n\n$ condor_config_val JUNK_HOOK_PREPARE_JOB\n/opt/junk/prepare_hook.sh\n\n2.\n\n cat /opt/junk/prepare_hook.sh\n#!/bin/sh\n\nid &gt; /tmp/prepare_hook.log\nenv &gt;&gt; /tmp/prepare_hook.log\nls -alR $PWD &gt;&gt; /tmp/prepare_hook.log\n\nexit 1\n\n3.\n\n$ echo -e 'cmd=/bin/sleep\\nargs=1m\\n+hookkeyword=\"junk\"\\nqueue\\n' |\ncondor_submit\n\n4.\n\n$ chmod a+rwx /opt/junk\n\n\nActual results:\n\nFrom the Starter's log...\n\n02/04 14:07:16 Submitting machine is \"localhost.local\"\n02/04 14:07:16 ERROR: path specified for junk_HOOK_PREPARE_JOB\n(/opt/junk/prepare_hook.sh) is a world-writable directory (/opt/junk/)!\nRefusing to use.\n02/04 14:07:16 setting the orig job name in starter\n02/04 14:07:16 setting the orig job iwd in starter\n02/04 14:07:16 Job 138781.0 set to execute immediately\n02/04 14:07:16 Starting a VANILLA universe job with ID: 138781.0\n02/04 14:07:16 IWD: /mnt/pool/gridmonkey\n02/04 14:07:16 About to exec /bin/sleep 1m\n02/04 14:07:16 Create_Process succeeded, pid=23814\n02/04 14:08:16 Process exited, pid=23814, status=0\n02/04 14:08:16 Got SIGQUIT.  Performing fast shutdown.\n02/04 14:08:16 ShutdownFast all jobs.\n02/04 14:08:16 **** condor_starter (condor_STARTER) pid 23798 EXITING WITH\nSTATUS 0\n\n\nExpected results:\n\nFrom the Starter's log...\n\n02/04 14:10:17 Submitting machine is \"localhost.local\"\n02/04 14:10:17 setting the orig job name in starter\n02/04 14:10:17 setting the orig job iwd in starter\n02/04 14:10:17 ERROR in StarterHookMgr::tryHookPrepareJob: HOOK_PREPARE_JOB\n(/opt/junk/prepare_hook.sh) failed (exited with status 1)\n02/04 14:10:17 ShutdownFast all jobs.\n02/04 14:10:17 Got SIGQUIT.  Performing fast shutdown.\n02/04 14:10:17 ShutdownFast all jobs.\n02/04 14:10:17 **** condor_starter (condor_STARTER) pid 9005 EXITING WITH\nSTATUS 0\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2010-May-07 08:41:43 by tstclair:</em> <br/>\n\nIt may be a personal preference but usually the returning argument indicates goodness, and in the previous code there was no way to check for error externally because NULL != failure, maybe an alternative signature might be:\n\n<p>bool validateHookPath( const char* hook_param, char*&amp; pszHookParamVal )\n\n</p><p>The reason I say this is all the logic which calls this function only checks != 0 and the inner part of validateHookPath already logs on failure.\n\n</p><p></p><hr/>\n<em>2010-May-07 09:54:09 by eje:</em> <br/>\n\nThat alternate signature is also the one I would use generally.  I left the return value as-is in the name of minimal alteration to existing design.  Precautionary principle, as it were.   Although in this case the function isn't called in very many places, so a signature change would be low-impact too.\n\n<p></p><hr/>\n<em>2010-May-07 12:46:19 by eje:</em> <br/>\n\nSubmitted revised patch w/ Tim's suggestions for updated function signatures.\n\n<p></p><hr/>\n<em>2010-May-07 13:29:47 by tstclair:</em> <br/>\n\nOnly minor thing, which is rather irrelevant, but I don't think you need:\n\n<p>StartdHookMgr.cpp:\nif (hperr != 0) rip-&gt;dprintf(D_FULLDEBUG, \"Path error for hook %s (hperr=%d)\\n\", _param.Value(), hperr);\n\n</p><p>for the same reason mentioned previously.\n\n</p><p>Looks good.\n\n</p><p></p><hr/>\n<em>2010-May-07 16:12:40 by eje:</em> <br/>\n\nOops.  Submitted 3rd patch that cleans it up.\n\n<p></p><hr/>\n<em>2010-Jun-10 14:43:50 by eje:</em> <br/>\n\nSubmitted yet another patch (rev4) to fix a bug I introduced in rev2-patch.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/169/prepare_hook_abort.patch\">prepare_hook_abort.patch</a>\n7279 bytes added by eje on 2010-May-06 23:37:22 UTC.\n<br/>\nPatch which adds logic to abort jobs with path errors in prepare hook (and update and exit hooks), and send them back to queue in idle.<br/>\n</li><li><a href=\"../files/170/prepare_hook_abort.rev2.patch\">prepare_hook_abort.rev2.patch</a>\n10126 bytes added by eje on 2010-May-07 17:42:24 UTC.\n<br/>\nUpdated version of fix with nicer signatures for a couple functions.<br/>\n</li><li><a href=\"../files/171/prepare_hook_abort.rev3.patch\">prepare_hook_abort.rev3.patch</a>\n9559 bytes added by eje on 2010-May-07 21:11:56 UTC.\n<br/>\nClean up a few bits I should have cleaned in previous rev.<br/>\n</li><li><a href=\"../files/186/prepare_hook_abort.rev4.patch\">prepare_hook_abort.rev4.patch</a>\n9560 bytes added by eje on 2010-Jun-10 19:43:02 UTC.\n<br/>\nYet another patch update: this corrects a bug I introduced in rev2 patch.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-16 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18576\">[18576]</a></span>: Proxy Commit for eje re: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1398\" onclick=\"get_ticket_and_populate_wrapper('1398'); return false;\" title=\"PREPARE hook invocation failure does not abort job execution\">#1398</a></span>: PREPARE hook invocation failure does not abort job execution. It now properly aborts.  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jul-16 15:12", "status": "resolved", "created": "2010-May-06 18:35", "fixed_version": "2010-May-06 18:35", "broken_version": "v070402", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu,eje@redhat.com", "due_date": ""}