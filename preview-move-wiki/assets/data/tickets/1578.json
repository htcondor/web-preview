{"id": 1578, "title": "Ticket #1578: Removing jobs via SOAP interface does not set terminal status on job", "description": "<blockquote>\nThe history file contains jobs with their <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatus\" title=\"Job Status\">JobStatus</a></span> set to non-terminal values if you use the SOAP interface to remove a job the status of the job in the history file remains as it was when the job was removed. It's not set to C or X, which is what happens if you remove a job condor_rm.\n\n<p>Example:\n\n</p><p></p><pre>  &gt;condor_history 48.10\n  ID      OWNER            SUBMITTED     RUN_TIME ST   COMPLETED CMD\n  48.10  Administrator   8/12 22:44   0+00:00:00 I   ???        \\\\htpc\\nas\\jobs\n</pre>\n\n<p>And for a held job:\n\n</p><p></p><pre>  &gt;condor_q 48.16\n  -- Submitter: winxpcm : &lt;192.168.0.173:4501&gt; : winxpcm\n  ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n  48.16  Administrator   8/12 22:44   0+00:00:00 H  0   0.0  run.bat\n</pre>\n\n<p></p><pre>  -- sanity check to make sure there's nothing about job in the history file --\n</pre>\n\n<p></p><pre>  &gt;condor_q 48.16\n  -- Submitter: winxpcm : &lt;192.168.0.173:4501&gt; : winxpcm\n   ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n</pre>\n\n<p></p><pre>   -- job was removed via the SOAP interface --\n</pre>\n\n<p></p><pre>  &gt;condor_history 48.16\n  ID      OWNER            SUBMITTED     RUN_TIME ST   COMPLETED CMD\n  48.16  Administrator   8/12 22:44   0+00:00:00     ???        \\\\htpc\\nas\\jobs\n</pre>\n\n<p>Technically all jobs in the history file should be jobs that are in terminal states.\n\n</p><p>Easy to reproduce: put jobs in queue, issue SOAP calls to remove them when they are in states other than queued. Only tested, reproduced on WinXP so far.\n\n</p><p>Looks like the SOAP remove is just missing:\n\n</p><p></p><pre>  jobStatus = REMOVED;\n  jobAd-&gt;Assign(ATTR_JOB_STATUS, jobStatus);\n</pre>\n\n<p>Before AppendHistory() is called.\n\n</p><p>I'm attaching a history file that shows jobs in states not terminal in it.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Aug-13 06:13:09 by matt:</em> <br/>\n\nDo you see this same problem with jobs removed via <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRemove\" title=\"Periodic Remove\">PeriodicRemove</a></span>?\n\n<p>There are two code path in the code for removing clusters and procs, bad, and they should be unified.\n\n</p><p>Please include the code you are using to call removeJob, or at least the arguments.\n\n</p><p>The Broken Version is meant to reflect the first version this became a problem, going back to as far as 7.0.0. Was this an issue in 7.4.1 or earlier?\n\n</p><p></p><hr/>\n<em>2010-Aug-13 08:56:25 by ichesal:</em> <br/>\n\nMatt, I haven't tried <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PeriodicRemove\" title=\"Periodic Remove\">PeriodicRemove</a></span>, but I can. I'll report back.\n\n<p>The code I'm using to do the remove is:\n\n</p><p></p><pre>  import condor.birdbath.Schedd;\n  import condor.birdbath.Transaction;\n</pre>\n\n<p></p><pre>  public void removeJobs(Transaction transaction, FullJobId[] jobIds, String reason, SchedulerDaemon schedulerDaemon)\n  throws RemoteException\n  {\n      Schedd condorSchedd = new Schedd(new URL(\"http://\" + schedulerDaemon.getDaemonAddress()));\n      Transaction transaction = condorSchedd.createTransaction();\n      transaction.begin(120);\n</pre>\n\n<p></p><pre>      for (int index = 0; index &lt; jobIds.length; ++index)\n      {\n          FullJobId id = jobIds[index];\n          transaction.removeJob(id.cluster, id.job, reason);\n      }\n</pre>\n\n<p></p><pre>      transaction.commit();\n  }\n</pre>\n\n<p>First saw the problem in 7.0.4 but was able to reproduce it in 7.4.2 before filing this ticket.\n\n</p><p></p><hr/>\n<em>2010-Aug-13 10:01:11 by ichesal:</em> <br/>\n\nCorrection: no, I don't see this problem with a periodic_remove statement that removes idle and running jobs.\n\n<p></p><hr/>\n<em>2012-Jun-19 15:54:15 by ichesal:</em> <br/>\n\nThis persists in 7.6.6 -- takes nothing special to cause it to happen. Just try to remove job with the SOAP API.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/214/history.zip\">history.zip</a>\n13627 bytes added by ichesal on 2010-Aug-13 00:04:38 UTC.\n<br/>\nHistory files with jobs in the I and H states.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "", "type": "defect", "last_change": "2012-Oct-17 12:36", "status": "new", "created": "2010-Aug-12 19:04", "fixed_version": "2010-Aug-12 19:04", "broken_version": "v070402", "priority": "2", "subsystem": "Unknown", "assigned_to": "", "derived_from": "", "creator": "ichesal", "rust": "", "customer_group": "other", "visibility": "public", "notify": "ichesal@cyclecomputing.com ialderman@cyclecomputing.com", "due_date": ""}