{"id": 2919, "title": "Ticket #2919: Parallelize classad matchmaking", "description": "<blockquote>\nAs part of my ME964 project, I am working to find points where <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> work can be done in a parallel fashion.  The first step is seeing if matching of classads can be parallelized.\n\n<p>Currently matching is done using the IsAMatch function inside compat_classad_util.  This operation can be parallelized by passing in the classad we want a match for and a list of candidates and, perhaps using openmp, by using a parallel for loop to create <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchClassAd\" title=\"Match Class Ad\">MatchClassAd</a></span> instances for each potential pair.  Because the original classads are modified during the matching operation, we would need to make copies of the target classad, as depending on the classad we are matching against, the change is different.  The original candidate classads can be modified themselves.\n\n</p><p>One possible performance enhancement is to create a pool of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchClassAd\" title=\"Match Class Ad\">MatchClassAd</a></span> instances that the parallel matching algorithm can use instead of constantly creating and destroying <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchClassAd\" title=\"Match Class Ad\">MatchClassAd</a></span> instances, assuming this is ever a problem.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-06 20:58:10 by ziliang:</em> <br/>\n\nSome preliminary numbers where I am trying to find a match for a job from amongst 1136 machines. Note that each pair of numbers is using a different job ad but the same set of machines. Also note that I am not stopping the search the moment I find a match, this is a straight up comparison to see how much time it would take to run a comparison against all the machines.\n\n<p>Job 1:\n</p><ul>\n<li>OpenMP: 1404\n</li><li>Sequential: 1435\n</li></ul>\n\n<p>Job 2:\n</p><ul>\n<li>OpenMP: 1404\n</li><li>Sequential: 2636\n</li></ul>\n\n<p>Job 3:\n</p><ul>\n<li>OpenMP: 2418\n</li><li>Sequential: 4399\n</li></ul>\n\n<p>Job 4:\n</p><ul>\n<li>OpenMP: 1653\n</li><li>Sequential: 5226\n</li></ul>\n\n<p>Comments: This is running with 4 threads for each comparison, since that's how many cores I have on my workstation. My implementation sets that the amount of threads equal to the number of cores. The first job also had to initialize the memory pool used to hold the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchAd\" title=\"Match Ad\">MatchAd</a></span> classes and the copies of the target ad. We need a better way to clean those up. This speedup for the others is also, unfortunately, not linear. That may have something to do with the synchronization that happens to add matching ads to the shared vector. Am open to suggestions of how to make that more efficient. Another possibility is the cost of the copying operation I have to do for the target ad, which is not done in the sequential matching.\n\n</p><p></p><hr/>\n<em>2012-May-15 15:38:16 by ziliang:</em> <br/>\n\nWe'll need to declare openmp as a dependency in the packaging glue if we roll this out.\n\n<p></p><hr/>\n<em>2016-Sep-27 10:40:06 by gthain:</em> <br/>\n\nLet's leave this one undocumented until it has some more mileage under its belt.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/663/ParallelClassadDesignDoc.doc\">ParallelClassadDesignDoc.doc</a>\n32256 bytes added by ziliang on 2012-Dec-19 20:35:42 UTC.\n<br/>\nDesign doc.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-23 14:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8e1287da16af18ad27622050981d15cc4c378c15\">[49063]</a></span>: Add parallel matchmaking to compat_classad <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-23 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/34c55b4b868d47f8ca70a95b6327df2851d4b400\">[49062]</a></span>: Add Cmake support to autodetect compiler openmp support <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-03 08:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f02e102f7921033ea1f3347b4ae3fc27a9e83a9b\">[48933]</a></span>: Add Cmake support to autodetect compiler openmp support <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-15 16:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96502fd92c2f15799541340354e7b248bbea82a6\">[33087]</a></span>: Try stubbing sysapi_n_cpus_raw in libcondorapi. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Aug-15 14:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5398594b222644989964804ef2a13db86794cc47\">[33075]</a></span>: Work of the call chain to convert <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> lists to vectors where feasible. Also modified parallel match function to also perform half matches. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>. (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-15 17:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d5fa4026e882f589bef04a23646486431b1a48f\">[32056]</a></span>: Enable openmp build for Condor parallel matchmaking in cmake. Fix timing code in matchmaking performance test. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-10 16:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cd8028c04b7bbed31060145927e0c387160ef7cd\">[32017]</a></span>: Use parallel matchmaking function inside matchmaker. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-10 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/099d0256a6b0692288b225b63a644c6bdf89da23\">[32012]</a></span>: Abstract away second half of determining best match which is serial in nature. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-13 16:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1d64f654a93aef4705fa1f1198087a48e297d62f\">[31661]</a></span>: Tweak parallel match function to exit early if it gets handed an empty list of candidates. Make test program crossplatform. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-11 11:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/62fd62894f0c0a84d5e5c3d8fc78565f578d0156\">[31621]</a></span>: Commit currently working parallel classad matching code and updated benchmarking program. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-05 17:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5868d54452e09f1f82d402551696243a7d108e40\">[31527]</a></span>: Commit test program. Still need to investigate a potentially illegal operation deep in the bowls of the classad code discovered by VS2010. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-05 17:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/10b3e80d36d820e10855322379c43d9ee245f901\">[31526]</a></span>: Finish initial implementation of multithreaded classad matching. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-04 16:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a2213af8d2eeaafb77b9124faad28a701c508d6d\">[31509]</a></span>: Initial codedump of parallel classad matchmaking. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2919\" onclick=\"get_ticket_and_populate_wrapper('2919'); return false;\" title=\"Parallelize classad matchmaking\">#2919</a></span>.  (By Ziliang Guo )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Sep-27 10:40", "status": "resolved", "created": "2012-Apr-03 16:35", "fixed_version": "2012-Apr-03 16:35", "broken_version": "v070800", "priority": "2", "subsystem": "Libs", "assigned_to": "gthain", "derived_from": "#4490", "creator": "ziliang", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": "20120420"}