{"id": 5665, "title": "Ticket #5665: Custom job ClassAd attributes not used in matchmaking", "description": "<blockquote>\nIf you insert a custom job attribute, it's not visible to the condor_negotiator when matchmaking. For example, with +JobType = \"trading\" and NEGOTIATOR_PRE_JOB_RANK = (TARGET.JobType <code>?</code> \"trading\"), 8.2 gives:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">05/09/16 16:20:56 Classad debug: [0.05603ms] ( TARGET.JobType is \"trading\" ) --&gt; TRUE</pre></div>\n\n\n<p>In 8.4:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">05/09/16 16:31:22 Classad debug: [0.13304ms] ( TARGET.JobType is \"trading\" ) --&gt; FALSE</pre></div>\n\n\n<p>(Note, there is a workaround. If the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobType\" title=\"Job Type\">JobType</a></span> is specified in the ADD_SIGNIFICANT_ATTRIBUTES configuration setting, the attribute is available for matchmaking).</p></blockquote>", "remarks": "<blockquote>\n<em>2016-May-09 14:55:59 by tannenba:</em> <br/>\n\nI think I see the problem in v8.4.\n\n<p>What I fail to understand is why it works in v8.2; the algorithm in matchmaker.cpp looks unchanged between v8.2 and v8.4.\n\n</p><p></p><hr/>\n<em>2016-May-09 15:16:10 by bcotton:</em> <br/>\n\nPerhaps the root cause is in the schedd, since ADD_SIGNIFICANT_ATTRIBUTES works around it and that's a schedd setting?\n\n<p></p><hr/>\n<em>2016-May-09 16:04:21 by tannenba:</em> <br/>\n\nAh yes, the difference is in v8.2 the schedd sent the entire job classad to the negotiator when requesting resources.  In v8.4, instead of sending the entire job ad, only attributes marked as significant are sent.\n\n<p>The root of the problem is that the negotiator adds attributes referenced in PREEMPTION_REQUIREMENTS to the significant attributes, but fails to examine PREEMPTION_RANK and all the other assorted negotiator rank expressions. Why the rank expressions were originally left out is a bit of a mystery, my only guess is there was some attribute referenced in the default negotiator rank expressions that would make the number of autoclusters in the schedd explode.  If this is no longer the case, I'll add a patch for v8.4 for this issue.\n\n</p><p>p.s. Besides the workaround Ben listed above, another workaround that is centralized at the negotiator would be to reference attributes in PREEMPTION_REQUIREMENTS in addition to just rank, e.g.\n\n</p><p></p><pre>   PREEMPTION_RANK = CustomAttrFoo\n   PREEMPTION_REQUIREMENTS = ($(PREEMPTION_REQUIREMENTS)) &amp;&amp; (CustomAttrFoo=?=UNDEFINED || CustomAttrFoo=!=UNDEFINED)</pre>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-08 17:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/771769bd39a9c4067d8479d01980dbfa41839dbb\">[55534]</a></span>: Add PREEMPTION_RANK, NEGOTIATOR_{PRE|POST}_JOB_RANK to sig attrs calculations <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5665\" onclick=\"get_ticket_and_populate_wrapper('5665'); return false;\" title=\"Custom job ClassAd attributes not used in matchmaking\">#5665</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Feb-04 16:37", "status": "resolved", "created": "2016-May-09 11:56", "fixed_version": "2016-May-09 11:56", "broken_version": "v080400", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "gthain", "derived_from": "", "creator": "bcotton", "rust": "", "customer_group": "other", "visibility": "public", "notify": "ben.cotton@cyclecomputing.com, rfutrick@cyclecomputing.com", "due_date": ""}