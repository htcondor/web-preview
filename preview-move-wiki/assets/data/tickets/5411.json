{"id": 5411, "title": "Ticket #5411: Scaling support & testing", "description": "<blockquote>\nAt the scales we envisage testing at, we'll probably need a collector tree.  We'll need to adjust condor_annex to work with collector trees, automate setting them up, or eliminate the need for them.  There's a patch from Brian Bockleman which purports to do the latter.\n\n<p>We could use \"classic\" collector trees as suggested by the <a class=\"external\" href=\"https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=HowToSetUpElasticComputeCloudPools\">wiki</a>; we already have a script running at start-up to configure the startd.\n\n</p><p>We could use the shared port daemon to distribute (to minimize memory usage, by consistent hashing of origin address?) connections to a \"special\" socket name (e.g., \"collector_tree\") among a set of daemons (e.g., with sockets named \"collector_tree_0\", \"collector_tree_1\",..).  This may be out-of-scope for the current work.\n\n</p><p>Brian Bockleman's patch does not appear to handle blocking authentication methods very well, so it may be out of the scope of this work.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Dec-09 22:35:07 by bbockelm:</em> <br/>\n\nBlocking methods should be just fine (in fact, it'll convert things to non-blocking for the parent), but they'll be nowhere nearly as performant as non-blocking methods.\n\n<p>What auth method are you targeting?  Currently non-blocking methods are GSI and FS.  Poking at PASSWD, I'd guess a long afternoon or so for an initial non-blocking server version.\n\n</p><p></p><hr/>\n<em>2015-Dec-11 10:31:52 by tlmiller:</em> <br/>\n\n<div class=\"restricted\"><p><i>Blocking methods should be just fine (in fact, it'll convert things to non-blocking for the parent), but they'll be nowhere nearly as performant as non-blocking methods.</i></p></div>\n<p>By \"handle very well\", I meant performance.  It's not clear that your current architecture -- no explicit queue and strict round-robin amongst a fixed number of workers -- will allow the parent process to handle a whole pool all by its lonesome if it's using a blocking security mechanism.  (As far as I can tell, in fact, the parent process will block during hand-off if the unix domain socket's buffer is full.)\n\n</p><p>By the way, what's the largest pool a single collector has been able to handle with GSI and this patch?\n\n</p><p></p><div class=\"restricted\"><p><i>What auth method are you targeting? Currently non-blocking methods are GSI and FS. Poking at PASSWD, I'd guess a long afternoon or so for an initial non-blocking server version.</i></p></div>PASSWD at the moment, since it's the simplest to work with.\n\n<p></p><hr/>\n<em>2016-Jan-04 15:44:05 by tlmiller:</em> <br/>\n\n<div class=\"restricted\"><i>We could use the shared port daemon to distribute (to minimize memory usage, by consistent hashing of origin address?) connections to a \"special\" socket name (e.g., \"collector_tree\") among a set of daemons (e.g., with sockets named \"collector_tree_0\", \"collector_tree_1\",..). This may be out-of-scope for the current work.</i></div>\n<p>Note that we'd probably want use a hash on something about the client (and because of NATs, probably not from the socket layer) to make sure that ads are update rather than duplicated.\n\n</p><p></p><hr/>\n<em>2016-Jan-08 14:32:27 by tlmiller:</em> <br/>\n\nUnfortunately, we can't use us-west-1 at the moment, because it doesn't support Lambda.  Our friends at AWS point out that a Lambda function isn't limited in effect to the region hosting it, but making use of that fact would require implementing <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=5426\" onclick=\"get_ticket_and_populate_wrapper('5426'); return false;\" title=\"Split admin and user template/tool.\">#5426</a></span> and then some.  It may be possible to work around the same-region-only restriction on custom Lambda resources by indirecting through an SNS resource...\n\n<p>Our friends at AWS say:\n\n</p><p></p><div class=\"verbatim\">\n<pre>&gt; You can't have an SNS topic trigger the execution of a Lambda task in another region.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2016-Aug-25 11:19:13 by tlmiller:</em> <br/>\n\nResolving.  The idea of making collector trees easier to create or unnecessary is more generally applicable, and the problems specific to the annex prototype have been resolved.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-08 14:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/05ba602b44dcca6a1756e49dad53da626a375769\">[47445]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5411\" onclick=\"get_ticket_and_populate_wrapper('5411'); return false;\" title=\"Scaling support &amp; testing\">#5411</a></span>) Add support for specifying the region on the command-line. Change template arguments from AMI IDs to strings because we can't use a mapping to pick the correct AMI based on which region we're in. (<strong>sigh</strong>)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-09 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5f45560237723bb6c62eb2efbb27763425afb753\">[46567]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5411\" onclick=\"get_ticket_and_populate_wrapper('5411'); return false;\" title=\"Scaling support &amp; testing\">#5411</a></span>) Allow a spot price to be specified for each instance. Correct bug where instances which terminated for lack of work did not shrink the size of their ASG.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-04 10:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eeec208f3b32b4ecdbd9a643d450f255af17fe35\">[46566]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5411\" onclick=\"get_ticket_and_populate_wrapper('5411'); return false;\" title=\"Scaling support &amp; testing\">#5411</a></span>) Add the expert-mode options for setting image-ID / instance-type pairs.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-04 10:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0441b494f10c1bf9415b0993ba098fbd5b34af29\">[46565]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5411\" onclick=\"get_ticket_and_populate_wrapper('5411'); return false;\" title=\"Scaling support &amp; testing\">#5411</a></span>) Document the --verbose flag.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-03 17:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/74f7d64dfce90933dbb87eca16c2a63d72342df3\">[46347]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5411\" onclick=\"get_ticket_and_populate_wrapper('5411'); return false;\" title=\"Scaling support &amp; testing\">#5411</a></span>) Stack now generates <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AutoScaling\" title=\"Auto Scaling\">AutoScaling</a></span> Groups for up to 8 (AMI, instance-type) tuples. Update condor_annex to work properly with multiple ASGs.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-02 15:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8a06ec6be81f6ce1d842e56236c03bfbe844ace7\">[46341]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5411\" onclick=\"get_ticket_and_populate_wrapper('5411'); return false;\" title=\"Scaling support &amp; testing\">#5411</a></span>) Implement external <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LaunchConfigurations\" title=\"Launch Configurations\">LaunchConfigurations</a></span>.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "experimental", "last_change": "2016-Aug-25 11:19", "status": "resolved", "created": "2015-Nov-23 14:08", "fixed_version": "2015-Nov-23 14:08", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "tlmiller", "derived_from": "#5324", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}