{"id": 7002, "title": "Ticket #7002: Fix ClassAds lexer to not read unneeded characters", "description": "<blockquote>\nThe <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> lexer always reads one character beyond the last token consumed, even though it often doesn't need to. It frequently pushes these characters back into the input source, then usually re-consumes them when the next token is requested. When a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> is parsed, the character after the end of the ad is pushed back but not re-consumed before the parse method returns.\n\n<p>We'd like to avoid pushing back characters when possible, especially when it happens on the return of a successful parse. Here are two concrete problems that can result:\n\n</p><p></p><ul>\n<li>When a FILE is open in text mode, the file position is undefined until a pushed-back character is re-consumed.\n\n<p></p></li><li>In the Python 3 bindings, each parse call creates a temporary FILE around the file descriptor obtained from Python. If a parse operation finishes with a character pushed back into the stream via ungetc(), it will be lost in subsequent I/O, including another parse call. In particular, if a stream contains two <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> with no intervening whitespace, parsing the second one will fail:\n<div class=\"verbatim\">\n<pre>[ A=3 ][ B=true ]\n</pre></div>\n</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-May-15 14:54:52 by jfrey:</em> <br/>\n\nThe user visibility of this change is pretty obscure. I don't think it needs a version history entry.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-17 09:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56644\">[56644]</a></span>: Make <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> lexer less greedy in reading unneeded characters. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7002\" onclick=\"get_ticket_and_populate_wrapper('7002'); return false;\" title=\"Fix ClassAds lexer to not read unneeded characters\">#7002</a></span> The lexer now fetches characters from the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LexerSource\" title=\"Lexer Source\">LexerSource</a></span> only when it needs them to resolve the current token. This reduces the numbr of places it need to unread a character. This is visible to callers in that after parsing a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span>,\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-May-15 14:54", "status": "resolved", "created": "2019-Apr-16 14:50", "fixed_version": "2019-Apr-16 14:50", "broken_version": "", "priority": "3", "subsystem": "ClassAd", "assigned_to": "jfrey", "derived_from": "#7001", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}