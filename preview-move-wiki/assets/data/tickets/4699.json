{"id": 4699, "title": "Ticket #4699: Allow user prio preemption to work on partitionable slots", "description": "<blockquote>\nIn 8.2 we added support to allow RANK to preempt multiple pslots via setting knob ALLOW_PSLOT_PREEMPTION=True in the config of the central manager.  We now need to add similar support for user prio preemption.\n\n<p>So now with the code added in this ticket ALLOW_PSLOT_PREEMPTION=True works with startd RANK and also PREEMPTION_REQUIREMENTS for user priority preemption. However, even in v8.7.10, some mechanisms that <em>are known to currently not work as expected</em> in conjunction with pslot preemption are:\n\n</p><p></p><ol>\n<li><code>PREEMPTION_RANK</code>\n</li><li><code>MaxVacateTime</code>, so jobs that take a long time to vacate could cause problems on the machine.\n</li><li>concurrency limits\n</li><li>consumption policies\n</li><li>non-fungible custom resources, i.e. resources that cannot be expressed as a number, like GPU device IDs.  So dealing with CPU cores, Memory, and Disk should all work, but not GPUs.\n</li><li>Consider early preemption may be an issue?</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-May-03 11:32:42 by tim:</em> <br/>\n\nMore work needs to be done here.\n\n<p></p><hr/>\n<em>2016-Oct-17 16:58:25 by tannenba:</em> <br/>\n\nSo putting a finer point on what more work still remains -\n\n<p>The issue is PREEMPTION_REQUIREMENTS and PREEMPTION_RANK are still both evaluated in the context of the pslot, not the dslot, so they don't work as expected if they reference attributes about the user who would be preempted. In addition, the special attributes that the negotiator normally adds about the current user/group aren't added for the pslot preemption evaluations.\n\n</p><p>In the case of PREEMPTION_REQUIREMENTS, the commits already made to this ticket get us part way there, in that it is evaluated once for each dslot, with an attribute <code>CandidateSlot</code> set so that the expression can consult rolled-up dslot attributes in the pslot. But this requires that the admin write their PREEMPTION_REQUIREMENTS in a special way that is different for pslots vs static slots, and also requires that the startd does rollup for anything referenced in PREEMPTION_REQUIREMENTS.\n\n</p><p>I admit I am wondering if ignoring the rollup info for now, and simply referencing the dslot in the negotiator, would be better for the time being until we think through the rollup mechanism more.\n\n</p><p>Effort estimate to resolve this ticket is O(2weeks).\n\n</p><p></p><hr/>\n<em>2018-May-07 15:22:47 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n(for the most recent changes by Todd Tannenbaum)\n\n<p></p><ul>\n<li>The map of slot name to ClassAd* can be built once at the start of the negotiation cycle.\n\n<p></p></li><li>Setting a bogus <span class=\"quote\">RemoteUser</span> attribute should be done for all forms of pslot preemption, not just for user priority.\n</li></ul>\n\n<p></p><hr/>\n<em>2018-May-07 16:30:40 by jfrey:</em> <br/>\n\nI've pushed changes that address my code review.\n\n<p></p><hr/>\n<em>2018-May-10 13:52:53 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Greg's changes look good.\n\n</p><p>Todd's changes to clear the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span> cache look good.\n\n</p><p>Todd's changes to remove the hard-coded check on priority for user priority preemption has a couple issues:\n\n</p><p></p><ul>\n<li>The <code>rejPreemptForPrio</code> count is now meaningless.\n</li><li>If a claim takes a while to be preempted (e.g. long retirement time), nothing prevents the negotiator from giving the slot to a different preempting job every negotiation cycle. It could even ping-poing between the same two preempting jobs (or sets of jobs).</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5236\" onclick=\"get_ticket_and_populate_wrapper('5236'); return false;\" title=\"Fix pslot preemption for user priority\">#5236</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFix pslot preemption for user priority</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6793\" onclick=\"get_ticket_and_populate_wrapper('6793'); return false;\" title=\"pslot preemption bug could preempt some dslots in error\">#6793</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\npslot preemption bug could preempt some dslots in error</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-29 14:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96184723eaa3066add7a84c945f2319f1bbda280\">[55638]</a></span>: Add 8.6 to 8.8 upgrade gotcha for PREEMPTION_REQUIREMENTS. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-09 14:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/894831e152a78741d4be157f9a8b13af570adf6c\">[54899]</a></span>: Fix ordering of IsAMatch in pslotMultiMatch to enable optimized ads <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-08 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/82500c5a9077942fbab3a420e0f10557e5caf08a\">[54889]</a></span>: also Unoptimize the job ad for matchmaking, need to learn why <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-08 15:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/962b673cfd773059b8ee63eda92325c4ab613d92\">[54886]</a></span>: Evaluate PREEMPTION_REQUIREMENTS iff job and slot user are different. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> This also fixes problems with commit sha f6ee12bf gittrac <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3fd728a18db1eccc9c10b9e989be7820441be8ad\">[54866]</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-08 10:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9c06113de3424934baf582ac2274c7bdaadeae69\">[54884]</a></span>: Fix syntax error in previous patch <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-08 09:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e851ab86517951cb1a6abf6102e676c0f000b3ad\">[54883]</a></span>: Prevent negotiator segfault - clear matchlist before deleting ads. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-07 16:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bed9363e480c267afdbf5a9bb51cd74a2f5bbd96\">[54881]</a></span>: Don't unoptimize job ad for pslot preemption. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> Also add comment explaing why we unoptimize the machine ad.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-07 15:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/749919ff5ca3f5aeeba9504199013cf05c4c5594\">[54878]</a></span>: Build slotNameToAdMap once per negotiation cycle. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-07 15:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fc1fb1901443b6e6e2ac1e148c2833bc89d9499c\">[54877]</a></span>: Always set bogus <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteUser\" title=\"Remote User\">RemoteUser</a></span> when doing pslot preemption. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> We want <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteUser\" title=\"Remote User\">RemoteUser</a></span> set in the slot ad in all cases where preemption would occur.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-07 13:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6ee12bfafda1b6a3d717e67df95791e5fe07266\">[54869]</a></span>: Remove hardcoded user priority preemption code <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> Now, all preemption requirements should go into PREEMPTION_REQUIREMENTS  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-06 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3fd728a18db1eccc9c10b9e989be7820441be8ad\">[54866]</a></span>: Get rid of negotiator knob PREEMPTION_REQUIREMENTS_PSLOT. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> No longer needed, we now just use PREEMPTION_REQUIREMENTS evaluated in the context of each dslot we are considering for preemption.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-06 15:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5908e1084f7d060ea8e4f60ba9529916ff3cf111\">[54865]</a></span>: For pslot preemption, honor negotiator match sorting rules. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> pslotMultiMatch now propagates <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PreemptState\" title=\"Preempt State\">PreemptState</a></span> to matching algorithm, and matched pslot is modified in the negotiator to i) contain the resources (cpus, memory, etc) that will be present at schedd claim time ii) have a bogus <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteUser\" title=\"Remote User\">RemoteUser</a></span> attribute,\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-May-04 12:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0d262437b1810ff19a578f15949c2790e4dfdd10\">[54864]</a></span>: For pslot preemption, use PREEMPTION_REQUREMENTS against dslot. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> With this commit, admins no longer need to write some special/goofy PREMPTION_REQUIREMENTS_PSLOT expression that references <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CandidateSlot\" title=\"Candidate Slot\">CandidateSlot</a></span>. In addition, all the expected resource utilization information will be available in the PREEMPTION_REQUIREMENTS\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-15 16:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a88ce9b32d1b44ea5deba181b95e0087dbef09ac\">[45073]</a></span>: Allow user prio preemption of partitionable slots <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span> <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=5097\" onclick=\"get_ticket_and_populate_wrapper('5097'); return false;\" title=\"Backport pslot preemption fixes to 8.2\">#5097</a></span> Committer: Jaime Frey  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-05 10:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/230d348f137579c097012922c6d7b9d666ffae53\">[41583]</a></span>: Allow user prio preemption of partitionable slots <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4699\" onclick=\"get_ticket_and_populate_wrapper('4699'); return false;\" title=\"Allow user prio preemption to work on partitionable slots\">#4699</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2018-Dec-20 10:47", "status": "resolved", "created": "2014-Nov-05 10:02", "fixed_version": "2014-Nov-05 10:02", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "#3667", "creator": "gthain", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": "20141104"}