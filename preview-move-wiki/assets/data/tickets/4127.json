{"id": 4127, "title": "Ticket #4127: Disconnection during job cleanup can crash shadow", "description": "<blockquote>\nIf the shadow becomes disconnected from the starter during job cleanup, it can crash as it starts running another job.\n\n<p>I haven't traced the exact course of events, but this is an outline of what I'm seeing:\n</p><ul>\n<li>Transfer of output files completes\n</li><li>shadow becomes disconnected\n</li><li>job termination code executes\n</li><li>shadow is recycled for a new job\n</li><li>shadow crashes\n</li></ul>\n\n<p>At the point of the crash, daemonCore is attempting to call a timer named \"RemoteResource::attemptReconnect()\". The destination of the call is bogus and the process segfaults.\n\n</p><p>It appears that the shadow is in the process of cleaning up the terminated job when the disconnect happens. A timer is registered to attempt a reconnect. Before the timer can fire, the job termination code path completes and the shadow is recycled, including deleting the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteResource\" title=\"Remote Resource\">RemoteResource</a></span> object. The destructor for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteResource\" title=\"Remote Resource\">RemoteResource</a></span> does not cancel the timer. Then the reconnect timer fires, invoking a method on a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteResource\" title=\"Remote Resource\">RemoteResource</a></span> object whose memory has been reused.\n\n</p><p>The destructor for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteResource\" title=\"Remote Resource\">RemoteResource</a></span> should cancel the reconnect timer (the identifier is stored in data member next_reconnect_tid).</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Dec-18 10:59:25 by jfrey:</em> <br/>\n\nBaseShadow::m_cleanup_retry_tid is another timer that should be canceled when the object is destroyed.\n\n<p></p><hr/>\n<em>2014-Jan-24 16:23:50 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good.  Checked for other TIDs missing deregistration, didn't see any.\n\n</p><p>(Resolving, since it looks like the docs are done.)</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-27 12:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fd29d534d91a2406b8c8cbfea80d1cbc70fa4c09\">[39101]</a></span>: minor edit of 8.0.6 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4127\" onclick=\"get_ticket_and_populate_wrapper('4127'); return false;\" title=\"Disconnection during job cleanup can crash shadow\">#4127</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-18 11:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6af1993baba945a79cf87b83a35cf8ce9101a985\">[39040]</a></span>: Docs for shadow crash due to disconnect during job cleanup. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4127\" onclick=\"get_ticket_and_populate_wrapper('4127'); return false;\" title=\"Disconnection during job cleanup can crash shadow\">#4127</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Dec-18 11:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e50adc7938ef8db480b3d0538d322729a01b3f58\">[39039]</a></span>: Cancel timers on object destruction in the shadow. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4127\" onclick=\"get_ticket_and_populate_wrapper('4127'); return false;\" title=\"Disconnection during job cleanup can crash shadow\">#4127</a></span> When the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteResource\" title=\"Remote Resource\">RemoteResource</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BaseShadow\" title=\"Base Shadow\">BaseShadow</a></span> objects are deleted as part of reusing the shadow process, ensure that all related timers are canceled.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jan-24 16:24", "status": "resolved", "created": "2013-Dec-17 20:15", "fixed_version": "2013-Dec-17 20:15", "broken_version": "v080000", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}