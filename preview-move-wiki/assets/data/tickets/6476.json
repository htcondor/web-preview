{"id": 6476, "title": "Ticket #6476: Master self-exec messes up systemd integration", "description": "<blockquote>\nWhen the master detects a new condor_master binary or the admin runs condor_restart -master, the master will shutdown all of the daemons and then call exec() on its own binary. If the master is running under systemd, this can interfere with systemd services. At the moment, these consist of watchdog keep-alive messages and systemd binding the shared port command port. The primary problem is that the master doesn't preserve the environment variables needed for these functions, so the new master image won't use them properly.\n\n<p>As a result, after a master restart, the master will stop sending watchdog alive messages, leading to systemd killing the master after 20 minutes. Also, the shared port daemon will attempt to bind the already-bound condor command port, which will fail. In these situations, the safest course of action is for the master to exit. Systemd will restart it shortly afterwards.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Nov-14 15:27:32 by jfrey:</em> <br/>\n\nSome developers expressed concern about having the master exit if it isn't 100% certain that systemd will restart it. There's another solution: when the master wants to re-exec() itself, it can first restore the systemd-related environment variables and FDs so that the new image sees them.\n\n<p></p><hr/>\n<em>2017-Dec-20 11:03:05 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6482\" onclick=\"get_ticket_and_populate_wrapper('6482'); return false;\" title=\"Google coredumper doesn't work on rhel7\">#6482</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nGoogle coredumper doesn't work on rhel7</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6483\" onclick=\"get_ticket_and_populate_wrapper('6483'); return false;\" title=\"Improve logging when a daemon gets a fatal signal\">#6483</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove logging when a daemon gets a fatal signal</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Dec-20 11:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89dd0cb7ca41ec3d38adea71ed30b86b99efc164\">[53040]</a></span>: Docs for master restart under systemd bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6476\" onclick=\"get_ticket_and_populate_wrapper('6476'); return false;\" title=\"Master self-exec messes up systemd integration\">#6476</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-20 09:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b0382e3106ad06c2096671b48b2fc8ea8bd0ce25\">[52835]</a></span>: Windows doesn't have setenv(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6476\" onclick=\"get_ticket_and_populate_wrapper('6476'); return false;\" title=\"Master self-exec messes up systemd integration\">#6476</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-17 13:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b8fe7b57ab7afbf37b24e0d1be05df58c0b0d188\">[52834]</a></span>: Allow master to exec() itself under systemd when possible. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6476\" onclick=\"get_ticket_and_populate_wrapper('6476'); return false;\" title=\"Master self-exec messes up systemd integration\">#6476</a></span> If the only systemd service the master is using is the watchdog keepalives, then it can safely exec() itself if it first resets the NOTIFY_SOCKET environment variable.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-10 11:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7f3c087997e782d3425663f3646332faededaf37\">[52780]</a></span>: Fix interference between systemd and master restart code. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6476\" onclick=\"get_ticket_and_populate_wrapper('6476'); return false;\" title=\"Master self-exec messes up systemd integration\">#6476</a></span> When the master exec()s itself, information from systemd is lost (primarily environment variables). As a result, the new master image doesn't know that it needs to send watchdog keepalive messages or that it was given a previously-bound\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Dec-20 11:23", "status": "resolved", "created": "2017-Nov-07 15:16", "fixed_version": "2017-Nov-07 15:16", "broken_version": "", "priority": "2", "subsystem": "DaemonMaster", "assigned_to": "tim", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}