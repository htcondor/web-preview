{"id": 514, "title": "Ticket #514: Startd crash can leak VMs", "description": "<blockquote>\n<a class=\"external\" href=\"https://bugzilla.redhat.com/show_bug.cgi?id=498497\">https://bugzilla.redhat.com/show_bug.cgi?id=498497</a>\n\n<p></p><ol>\n<li>submit vm job\n</li><li>see vm running\n</li><li>kill -9 condor_startd\n</li><li>watch condor_master kill condor_startd's children: condor_starter and\ncondor_vm-gahp\n</li><li>watch condor_master restart condor_startd with no memory of the vm\n</li><li>watch vm go back to idle and be re-run\n</li></ol>\n\n<p>The proposed fix for this is to have the startd leave a trail so it can cleanup\nthe vm when it is restarted. This solution fails if the startd is never\nrestarted, e.g. if the master is also killed.\n\n</p><p>If aiming for run-at-most-once semantics, job policy should prevent the job\nfrom re-running.\n\n</p><p>This also occurred in NMI with the VMware tests. The issue there hits the hole in the proposed fix - the startd is not restarted. Jaime suggested a startd could wipe out VMs it does not know about on startup. That can address the NMI issue, but would suffer from the same problems as sharing slot users between startds, and assumes ONLY condor can start VMs on a machine (not necessarily valid even in NMI).</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Jul-09 15:18:54 by jfrey:</em> <br/>\n\nI'm implementing a fix where the starter can write an ad in the execute directory that contains information to cleanup a stranded job in the event of a crash. When the startd starts up, it will look for these cleanup files and take appropriate action. For now, this is only used for VM universe jobs.\n\n<p>This feature could be expanded to other job types, and even allow for recovery of running jobs after a crash.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Jul-14 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2899e615fc693df58522dec5f1079ce51dfbb276\">[15091]</a></span>: Allow cleanup of stranded VM jobs after a crash. The starter can now write a recovery ad to disk with information about the job it's running. For now, this is used to kill VMs that may have been leaked during a crash of the Condor daemons. In the future, this could be used to resume handling of jobs\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2009-Dec-23 12:03", "status": "resolved", "created": "2009-May-26 16:15", "fixed_version": "2009-May-26 16:15", "broken_version": "v070200", "priority": "3", "subsystem": "VM", "assigned_to": "jfrey", "derived_from": "#523", "creator": "matt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu,jfrey@cs.wisc.edu", "due_date": ""}