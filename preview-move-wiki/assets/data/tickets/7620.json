{"id": 7620, "title": "Ticket #7620: ENCRYPT_EXECUTE_DIRECTORY permission denied errors on Windows", "description": "<blockquote>\n<a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2020-April/msg00121.shtml\">Initially reported by Greg H on htcondor-users</a>, it looks like <code>ENCRYPT_EXECUTE_DIRECTORY</code> on Windows 10 is having problems.  ToddT was able easily reproduce the issue on Windows 10 Pro Ver 1909 with HTCondor v8.9.5.  Specifically, if the execute directory is encrypted, the starter receives file permission errors and the job goes on hold.  Perhaps something changed in some Windows 10 update?\n\n<p><span class=\"subsection\"></span></p><h3>run_as_owner is a partial work-around</h3>\n\n<p>We can work around the problem of not having an encryption cert for the slot user by running jobs as the submitting user instead. To do this add this to your submit file.\n\n</p><p></p><pre>   run_as_owner=true\n</pre>\n\n<p>For this to work you will have to use condor_store_cred to store a password for each user on each execute node, or setup a CREDD daemon to hold the password store.\n\n</p><p>Even with run_as_owner enabled, there are still some things that fail with permission denied errors. If you transfer the executable rather than having it already installed on the execute node, then there will be a permission denied error when the condor_starter tries to figure out what kind of executable it is.  There will also always be a error message in the log about failing to create the IOProxy, which means that condor_chirp will not work.\n\n</p><p><span class=\"subsection\"></span></p><h3>Log files showing the problem</h3>\n\n<p>From the <code>StarterLog</code>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">04/24/20 14:37:53 (pid:9456) get_file(): Failed to open file C:\\condor\\execute\\dir_9456\\condor_exec.exe, errno = 13: Permission denied.\n04/24/20 14:37:53 (pid:9456) get_file(): consumed 199 bytes of file transmission\n04/24/20 14:37:53 (pid:9456) DoDownload: consuming rest of transfer and failing after encountering the following error: STARTER at 127.0.0.1 failed to write to file C:\\condor\\execute\\dir_9456\\condor_exec.exe: (errno 13) Permission denied\n04/24/20 14:37:53 (pid:9456) Failed to set execute bit on C:\\condor\\execute\\dir_9456\\condor_exec.exe, errno=2 (No such file or directory)\n04/24/20 14:37:53 (pid:9456) File transfer failed (status=0).\n04/24/20 14:37:53 (pid:9456) ERROR \"Failed to transfer files\" at line 2476 in file C:\\Users\\tannenba\\condor\\CONDOR_SRC_THREE\\src\\condor_starter.V6.1\\jic_shadow.cpp\n04/24/20 14:37:53 (pid:9456) ShutdownFast all jobs.\n04/24/20 14:37:53 (pid:9456) Failed to open '.update.ad' to read update ad: No such file or directory (2).\n04/24/20 14:37:53 (pid:9456) condor_read(): Socket closed abnormally when trying to read 5 bytes from &lt;127.0.0.1:55491&gt;, errno=10054\n04/24/20 14:37:53 (pid:9456) condor_read(): Socket closed abnormally when trying to read 5 bytes from &lt;127.0.0.1:55491&gt;, errno=10054\n04/24/20 14:37:53 (pid:9456) i/o error result is 0, errno is 2\n04/24/20 14:37:53 (pid:9456) Lost connection to shadow, waiting 2400 secs for reconnect\n04/24/20 14:37:53 (pid:9456) All jobs have exited... starter exiting\n04/24/20 14:37:53 (pid:9456) rmdirAttempt using command: C:\\condor\\bin\\condor_rmdir.exe /s  /c \"C:\\condor\\execute\\dir_9456\"\n04/24/20 14:37:53 (pid:9456) rmdirAttempt using command: C:\\condor\\bin\\condor_rmdir.exe /s  /c \"C:\\condor\\execute\\dir_9456\"\n04/24/20 14:37:53 (pid:9456) ERROR: C:\\condor\\execute\\dir_9456 still exists after trying to add Full control to ACLs for PRIV_ROOT\n04/24/20 14:37:53 (pid:9456) **** condor_starter (condor_STARTER) pid 9456 EXITING WITH STATUS 0\n</pre></div>\n\n\n<p>From the <code>ShadowLog</code>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">04/24/20 14:37:53 (23.0) (24736): Job 23.0 going into Hold state (code 12,13): Error from slot1_1@fido.my.edu@TODDS480S: STARTER at 127.0.0.1 failed to write to file C:\\condor\\execute\\dir_9456\\condor_exec.exe: (errno 13) Permission denied\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Apr-28 12:53:34 by johnkn:</em> <br/>\n\nThe issue is not ACLs, I attached a debugger to the starter and stopped it after it created the directory and then after it enabled encryption.  The directory has the correct ACLs, but the encryption CERT for the directory is for the SYSTEM account.  There is an API, <code>AddUsersToEncryptedFile</code> but it expects to be passed a  a CERT (presumably for the slot user),  I have no idea where to get that - do I have to create it?\n\n<p>For reference, sample code to use this API is here <a class=\"external\" href=\"https://docs.microsoft.com/en-us/windows/win32/fileio/adding-users-to-an-encrypted-file\">https://docs.microsoft.com/en-us/windows/win32/fileio/adding-users-to-an-encrypted-file</a>. I have no idea what to use as the \"subject\" argument, or any confidence that there will be a cert for the slot user.\n\n</p><p>A search by hand of the CERTs on my Win10 box leads me to the conclusion that there is no CERT for the slot user.  Perhaps if I encrypt a file as that user Windows it will create one?\n\n</p><p>A google search on the issue of \"multiple users accessing an encrypted folder\" suggests that it is not possible to do this, you must add other users to each file individually - however, this information is not from MS, but rather from various Windows \"help\" sites.\n\n</p><p>In normal operation for HTCondor, files in the encrypted directory will be encrypted to the user,  This happens automatically for run_as_owner jobs, but happens for slot-user jobs only when load_profile=true.\n\n</p><p>There was also a bug in HTcondor where we did not switch users before detecting the executable type, so this will fail if the executable is encrypted. This bug will be fixed as part of this ticket.\n\n</p><p>Files in the sandbox that are created by the Startd will be unencrypted, <code>.job.ad</code> and <code>.machine.ad</code> are created before the directory is set into encrypted mode, and the information in them is public. The <code>.update.ad</code> will also be unencrypted since this is also public information, and setting up the correct user in the Startd to encrypt for would be a lot of new code.\n\n</p><p></p><hr/>\n<em>2020-May-07 10:28:08 by johnkn:</em> <br/>\n\nwith commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/11e62b6460f2a3bfc9827124d1ed620bbcd5fc57\">[59604]</a></span>, it is now possible to use a carefully crafted job to cause Windows to create an encryption cert for the slot user.  The job must not transfer any input files, since that will cause a failure before the cert can be created.\n\n<p>By using <code>load_profile</code> and causing an output file to be created, the job will cause an encryption cert to be created for the slot user.  Thereafter, jobs for that slot user that use load_profile=true should work normally, even if there are input files transferred.\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">submit file for cert-creating job</pre>\n<pre class=\"snip\">executable=c:\\windows\\system32\\findstr.exe\narguments=cmd .job.ad\ntransfer_executable=false\nshould_transfer_files=true\noutput=$(cluster).out\nerror=$(cluster).err\nload_profile=true\nencrypt_execute_directory=true\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Aug-03 14:50:18 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: It looks good in general.  I don't know a lot about the Windows-specific mechanisms used here, though.  However, given that this was completely broken, we should ship this.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-28 11:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/32940cf82628f6e0227cda8ba88b0175af947436\">[60256]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7620\" onclick=\"get_ticket_and_populate_wrapper('7620'); return false;\" title=\"ENCRYPT_EXECUTE_DIRECTORY permission denied errors on Windows\">#7620</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-11 15:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e8f31f57f850834a860d1fa1de356de38f152fac\">[59629]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7620\" onclick=\"get_ticket_and_populate_wrapper('7620'); return false;\" title=\"ENCRYPT_EXECUTE_DIRECTORY permission denied errors on Windows\">#7620</a></span>, put log level back to what it was before  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-11 15:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/edfed07afbe16dba38ddc5188590c8f0ccfb88bb\">[59624]</a></span>: Fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7620\" onclick=\"get_ticket_and_populate_wrapper('7620'); return false;\" title=\"ENCRYPT_EXECUTE_DIRECTORY permission denied errors on Windows\">#7620</a></span>, ENCRYPT_EXECUTE_DIRECTORY causes permission denied errors on Windows. With this change, enabling execute directory on Windows will cause the registry (aka. profile) to be loaded for slot users. This allows the user encryption cert to be found/created for the slot user.\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-May-07 10:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/11e62b6460f2a3bfc9827124d1ed620bbcd5fc57\">[59604]</a></span>: partial fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7620\" onclick=\"get_ticket_and_populate_wrapper('7620'); return false;\" title=\"ENCRYPT_EXECUTE_DIRECTORY permission denied errors on Windows\">#7620</a></span> ENCRYPT_EXECUTE_DIR permission errors on windows jobs that have run_as_owner or load_profile will now partially work. ioproxy still has wrong cert, condor_chirp will not work for these jobs\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Aug-03 14:50", "status": "resolved", "created": "2020-Apr-27 10:52", "fixed_version": "2020-Apr-27 10:52", "broken_version": "v080905", "priority": "3", "subsystem": "Win32", "assigned_to": "johnkn", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "users", "visibility": "public", "notify": "Greg.Hitchen@csiro.au, tannenba@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}