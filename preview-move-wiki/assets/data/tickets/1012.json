{"id": 1012, "title": "Ticket #1012: Schedd putting cluster ads on hold", "description": "<blockquote>\nSchedd sent email stating the following:\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nCondor failed to start your job 9090.-1 because job attribute Args contains $$(VirtualMachineID).\n</td></tr></tbody></table></div>\n\n\n<p>Note the procid of -1 !!!\n\n</p><p>Submitting box is Windows XPSP3, execute nodes are all Windows 2003 Server SP2 x64, everything is running Condor 7.2.4 Jun 15 2009 BuildID: 159529.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Jun-01 15:46:59 by tannenba:</em> <br/>\n\nThere is a bug, and it can be reproduced as follows:\n\n<p></p><ol>\n<li>submit a job that uses $$() macros in the job ad in an attribute other than <code>executable</code>, for instance <code>Arguments = $$(Opsys)</code>\n\n<p></p></li><li>have <code>copy_to_spool=true</code> in the submit file (this is the default in v7.2.x, but <em>not</em> in v7.4.x), which means the executable will be copied into the SPOOL directory as file clusterXXX.ickpt.subproc0.\n</li></ol>\n\n<p>Once a job is submitted as above,  the job will go on hold when condor_preen runs because the ickpt file in SPOOL does not contain the string \".proc\", which preen looks for.  If preen does not find \".proc\", it wants to know if <em>any</em> jobs exist w/ the cluster number found in the filename. Preen does this by trying to fetch the cluster ad from the schedd (job number XXX,-1), which should exist if and only if there is one or more jobs submitted into this cluster number. The problem is the schedd's rpc handler for <span class=\"quote\">GetJobAd</span> in <a class=\"file\" href=\"rlog?f=src/condor_schedd.V6/qmgmt_receivers.cpp\">/src/condor_schedd.V6/qmgmt_receivers.cpp</a> will <em>always</em> try to expand $$() macros, because the <span class=\"quote\">GridManager</span> relies on this behavior.  But cluster ads will never successfully expand, thus the problem.\n\n</p><p>The fix should do the following:\n\n</p><p></p><ol>\n<li><span class=\"quote\">GetJobAd() </span> in qmgmt_receivers should check for valid ranges of cluster and proc, and should invoke <span class=\"quote\">GetJobAd</span> <em>without</em> expansion if and only if the proc requested is -1.  This will still allow preen to quickly check for the existence of a any job in a cluster and yet not setoff this bug.\n\n<p></p></li><li>holdJobRaw() in the schedd should do sanity checking on cluster and proc ids, and disallow proc values of -1.\n</li></ol>\n\n<p>As a tangent, preen is inefficient if the job queue is large - need a subticket to address this.\n\n</p><p></p><hr/>\n<em>2010-Jun-24 11:41:53 by tannenba:</em> <br/>\n\nNote: before the patches created in this ticket, in addition to the bugs above, folks running a CCB broker (collector) on the same machine with a schedd will see all their standard universe jobs and/or spooled jobs go on hold with the same crazy -1 jobid email message.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jun-24 11:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18512\">[18512]</a></span>: Fixed bug that could cause the schedd to segfault when preen discovers a CCB reconnect file in SPOOL, which results in preen requesting cluster -1 to the schedd. Note this patch fixes a bug introduced in patch <span class=\"chng\"><a href=\"chngview?cn=18319\">[18319]</a></span> which was never publically released. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1012\" onclick=\"get_ticket_and_populate_wrapper('1012'); return false;\" title=\"Schedd putting cluster ads on hold\">#1012</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jun-17 12:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18490\">[18490]</a></span>: Fixed bug that could cause the schedd to segfault when preen discovered an ickpt file leftover in SPOOL. Note this patch fixes a bug introduced in patch <span class=\"chng\"><a href=\"chngview?cn=18319\">[18319]</a></span> which was never publically released. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1012\" onclick=\"get_ticket_and_populate_wrapper('1012'); return false;\" title=\"Schedd putting cluster ads on hold\">#1012</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jun-04 16:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18319\">[18319]</a></span>: Fixed bug where job will be wrongly placed on hold when preen runs if the job contains $$() macros and has copy_to_spool=true. Another symptom of this bug is an email from Condor saying \"Condor failed to start your job XXX.-1 because ...\" - note the -1 for the proc id of the job. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1012\" onclick=\"get_ticket_and_populate_wrapper('1012'); return false;\" title=\"Schedd putting cluster ads on hold\">#1012</a></span>)  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jun-24 11:41", "status": "resolved", "created": "2009-Nov-30 13:40", "fixed_version": "2009-Nov-30 13:40", "broken_version": "v070204", "priority": "1", "subsystem": "Daemons", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "s7822", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20100115"}