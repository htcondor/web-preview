{"id": 2781, "title": "Ticket #2781: Log reading code re-reads events", "description": "<blockquote>\n(See the <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/condor-users/2012-January/msg00076.shtml\">\"Dagman \"BAD EVENT\" problems on Windows\" thread on condor-users</a>, starting on Jan. 17, 2012.)\n\n<p>The user's DAGs are getting goofed up because for some reason, the low-level log reading code is re-reading some events (based on looking at the dagman.out file and the node job userlog file).  When events are re-read, it goofs up DAGMan because, for example, it sees a submit event for a job that's already running, and that triggers the \"bad event\" code.\n\n</p><p>At this point I haven't managed to reproduce the problem, but I still need to do a run forced into recovery mode on the log file provided by the user.  So this <strong>could</strong> be something Windows-specific, but that's not clear yet.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Mar-19 16:46:48 by wenger:</em> <br/>\n\nOkay, looking at the code that's dumping out ftells, we <strong>did</strong> go backwards in the log file somehow.\n\n<p></p><hr/>\n<em>2012-Apr-04 13:12:35 by wenger:</em> <br/>\n\nA student of Joe Meehean's has now also seen this (also on Windows).\n\n<p>I've gotten enough debug output to narrow things down -- seems like the problem has to be happening in the m_lock-&gt;obtain() call inside ReadUserLog::readEventOld().\n\n</p><p></p><hr/>\n<em>2012-May-11 14:28:39 by wenger:</em> <br/>\n\nA tar file of all of the dagman.out files, etc., I've gotten from the users who've experience this is at:\n\n<p></p><pre>  /u/w/e/wenger/public/condor/gittrac_2781.tgz\n</pre>\n\n<p>Also, I've committed a ton of extra debug code on this branch:\n\n</p><p></p><pre>  V7_7-gittrac_2781-branch\n</pre>\n\n<p>I've sent the users executables built from that branch -- that's where all the extra debug output in the dagman.out files in the tarball come from.\n\n</p><p>TJ and I worked to try to reproduce this problem here, but we were never successful.\n\n</p><p>The problem is that, for some reason the file pointer on the user log file goes backwards (when it shouldn't).  I've now seen this happen at several different points in the code, so I'm not sure what's going on.\n\n</p><p></p><hr/>\n<em>2012-May-11 14:29:51 by wenger:</em> <br/>\n\nNote: there's no RUST ticket for this because it started via condor-users.  The two users who have experienced it are Thomas Rowe (rowet@metsci.com) and Adam Noll (NOLL_A@students.lynchburg.edu) who is a student of Joe Meehean.\n\n<p></p><hr/>\n<em>2012-Sep-01 09:23:36 by nwp:</em> <br/>\n\nThomas Rowe has built a new DAGMan binary from the same sources and is running it without problems.  Could the runtime we ship on Windows have a bug?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-10 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=35368\">[35368]</a></span>: Gittrac <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=2781\" onclick=\"get_ticket_and_populate_wrapper('2781'); return false;\" title=\"Log reading code re-reads events\">#2781</a></span>: Committing some diagnostic code on the branch.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-04 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=31516\">[31516]</a></span>: More debug code for gittrac <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=2781\" onclick=\"get_ticket_and_populate_wrapper('2781'); return false;\" title=\"Log reading code re-reads events\">#2781</a></span>, seems like the problem is in file locking...  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-30 16:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=31048\">[31048]</a></span>: More debug code for gittrac <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=2781\" onclick=\"get_ticket_and_populate_wrapper('2781'); return false;\" title=\"Log reading code re-reads events\">#2781</a></span>, based on the output of the previous version.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-23 15:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=31002\">[31002]</a></span>: Added more debug code to narrow down the problem in gittrac <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=2781\" onclick=\"get_ticket_and_populate_wrapper('2781'); return false;\" title=\"Log reading code re-reads events\">#2781</a></span>.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Feb-23 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=30684\">[30684]</a></span>: Added a bunch of debug code to try to figure out gittrac <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=2781\" onclick=\"get_ticket_and_populate_wrapper('2781'); return false;\" title=\"Log reading code re-reads events\">#2781</a></span>; added the option to turn off unmonitoring of log files so we can see if that fixes the problem.  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jun-01 13:36", "status": "stalled", "created": "2012-Jan-23 14:54", "fixed_version": "2012-Jan-23 14:54", "broken_version": "v070602", "priority": "2", "subsystem": "Dag", "assigned_to": "", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "users", "visibility": "public", "notify": "wenger@cs.wisc.edu rowet@metsci.com Meehean.J@lynchburg.edu NOLL_A@students.lynchburg.edu", "due_date": ""}