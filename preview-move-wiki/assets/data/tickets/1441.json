{"id": 1441, "title": "Ticket #1441: Move write of submit event from condor_submit to schedd", "description": "<blockquote>\nThe schedd writes every EventLog/UserLog event except for the submit event. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> submit event is written by condor_submit. This can cause synchronization problems, such as having execute/terminate events written first (see, for example, <span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=1422\" onclick=\"get_ticket_and_populate_wrapper('1422'); return false;\" title='dagman assertion: (node-&gt;_queuedNodeJobProcs &gt;= 0)\" at 3200 dag.cpp'>#1422</a></span> ).\n\n<p>If we have the schedd also write the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> submit event, problems like that should vanish.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Jun-10 09:03:27 by tannenba:</em> <br/>\n\nIf implemented correctly, this should require very little code change because the schedd already writes the submit event at the proper time into the schedd's event log.  So it should just be a matter of getting rid of the code that writes the submit event <code>condor_submit</code> and having the schedd always write the submit event into the job event log (if a job log is requested) whenever it writes it into the schedd event log.\n\n<p></p><hr/>\n<em>2010-Jun-10 09:58:20 by cweiss:</em> <br/>\n\nThe change is essentially done. The only difference of the schedd submit event is that it is lacking the submit host information (which is included if condor_submit writes it). Is it crucial to have this information?\n\n<p></p><hr/>\n<em>2010-Jun-22 14:23:43 by matt:</em> <br/>\n\nCan that information be cribbed from the connection the job is coming in on?\n\n<p></p><hr/>\n<em>2010-Jul-01 17:34:36 by cweiss:</em> <br/>\n\nA slight semantic difference introduced by the attached patch: Now the submit event does not say anymore \"submitted from host: &lt;sinful string&gt;\" but \"submitted to host: &lt;sinful string&gt;\", since the schedd we submit to isn't necessarily the same machine from which we call \"condor_submit\".\n\n<p></p><hr/>\n<em>2010-Jul-01 17:55:30 by gthain:</em> <br/>\n\nIt looks like with the new code, we now fsync the user log for every proc for every cluster that's submitted.  In the old code, we only fsync'd in submit once, at the end.  Is there a way to do this in the schedd?\n\n<p></p><hr/>\n<em>2010-Jul-02 16:43:40 by cweiss:</em> <br/>\n\nAs of our previous discussion: I now included the fsync-per-cluster change. However, you can have a submit file like\n\n<p></p><div class=\"code\">\n<pre class=\"code\">...\nlog = log1.log\nqueue\n\nlog = log2.log\nqueue\n\netc...\n</pre></div>\n\n\n<p>In this scenario we have a separate log file for every single job in a cluster (which wouldn't be fsynced and currently aren't by condor_submit!) Thus, we should maybe include a check whether the log filename changed and act accordingly.\n\n</p><p></p><hr/>\n<em>2010-Jul-06 11:51:37 by gthain:</em> <br/>\n\nDoesn't this bug exist today?\n\n<p></p><hr/>\n<em>2010-Jul-06 12:24:18 by cweiss:</em> <br/>\n\nCorrect. As condor_submit is doing it to date, it does only one fsync per cluster, no matter whether there are several different log files to be written to or not.\n\n<p></p><hr/>\n<em>2010-Jul-06 13:21:23 by gthain:</em> <br/>\n\nOK, let's commit this then, as it is no worse than before, and then fix the multiple log problem.\n\n<p></p><hr/>\n<em>2010-Aug-11 09:01:21 by cweiss:</em> <br/>\n\nSome remarks as identified in yesterday's FW meeting:\n\n<p>- The change of the submit event text \".. submitted from host... \" to \".. submitted to host...\" breaks backwards compatibility. Either we stick with the old version (which would semantically be incorrect), or add a compatibility check. The later only works if a newer version of Condor has to deal with an old <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span>. It won't work the other way round. Therefore I propose to accept the slightly incorrect semantics and just leave the old phrasing.\n\n</p><p>- A newer submit should still be able to write the submit event in case it is communicating with an older schedd (version check!)\n\n</p><p>- A newer schedd should omit the writing if it is already written by an older submit.\n\n</p><p>- Last but not least: exhaustive testing needed whether things work as expected in case we are submitting to a remote schedd (e.g. could we end up with an overwritten <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> due to transfer or none)\n\n</p><p></p><hr/>\n<em>2010-Aug-17 16:59:01 by jfrey:</em> <br/>\n\nThe host mentioned in the submit event when condor_submit writes it is the sinful string of the schedd. Even for a remote submit, it's the schedd's address. So there's no problem of that value changing.\n\n<p></p><hr/>\n<em>2010-Aug-18 17:23:41 by jfrey:</em> <br/>\n\nPushed changes to master for 7.5.4. This reworked patch includes backward compatibility checks.\n\n<p></p><hr/>\n<em>2010-Oct-20 14:29:46 by jfrey:</em> <br/>\n\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=924\" onclick=\"get_ticket_and_populate_wrapper('924'); return false;\" title=\"schedd should write submit event\">#924</a></span> is identical to this ticket.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/193/scheddSubmitEvent.patch\">scheddSubmitEvent.patch</a>\n6209 bytes added by cweiss on 2010-Jul-01 22:31:12 UTC.\n<br/>\nThis patch moves the write of the submit even from condor_submit to the schedd. <br/>\n</li><li><a href=\"../files/194/scheddSubmitEventFSync.patch\">scheddSubmitEventFSync.patch</a>\n1723 bytes added by cweiss on 2010-Jul-02 19:40:52 UTC.\n<br/>\nthe additional diff for fsync changes<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-18 16:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18829\">[18829]</a></span>: Schedd now writes the submit event in the user log <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1441\" onclick=\"get_ticket_and_populate_wrapper('1441'); return false;\" title=\"Move write of submit event from condor_submit to schedd\">#1441</a></span> Previously, condor_submit wrote the submit event, but the schedd (or the gridmanager) wrote all other events. The schedd even wrote the submit event to the event log. This can cause synchronization problems, such as having execute/terminate events\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-17 17:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18827\">[18827]</a></span>: Revert \"Move the write of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> submit event from condor_submit to schedd\" This reverts commit dafeb6daaaaee16afc24147dafbc4edf6158b6cb. Portions of this commit will be reapplied in a modified form. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1441\" onclick=\"get_ticket_and_populate_wrapper('1441'); return false;\" title=\"Move write of submit event from condor_submit to schedd\">#1441</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Aug-09 14:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18748\">[18748]</a></span>: Move the write of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> submit event from condor_submit to schedd (which already writes the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> submit event). Due to that, also a slight adaptation of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=UserLog\" title=\"User Log\">UserLog</a></span> submit event printout became necessary: Since we can submit to an arbitrary schedd, we just say <strong>to</strong> which schedd host a job was submitted\u00a0[...]\n (By Cathrin Weiss )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Oct-20 14:29", "status": "resolved", "created": "2010-Jun-09 18:40", "fixed_version": "2010-Jun-09 18:40", "broken_version": "v070000", "priority": "4", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "cweiss", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu , cweiss@cs.wisc.edu", "due_date": ""}