{"id": 3477, "title": "Ticket #3477: Keypairs of EC2 jobs may not be cleaned up.", "description": "<blockquote>\nIt is permissible for an EC2 job to go on hold without deleting its keypair.  (The keypair may belong to the user; or the user may wish to use the keypair; or the keypair should be left active to avoid invalidating a spot request.)\n\n<p>When such a job enters recovery, we correctly avoid recreating the keypair.  However, we do not set the flag which marks the keypair as created; so when the job eventually leaves the queue, we don't clean the keypair up.\n\n</p><p>It is presently problematic to determine from the job ad if we created the keypair.  This fix will have three parts:\n\n</p><p>(1) Prevent the user from specifying both a keypair name and a filename for saving the created keypair.  Since this options are mutually exclusive, this won't cause any problems.\n\n</p><p>(2) Now that we know both keypair name and filename can be set only when we created a keypair, use that information to determine when to remove a keypair from the cloud.\n\n</p><p>(3) If and only if the job we see in GM_DELETE is exiting the queue (for good), delete the on-disk copy of the keypair.  This allows the user to (potentially) access the instance started by the held job.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Feb-20 16:07:19 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>I think the keypair cleanup code in GM_DELETE is too aggressive.\nWhen is it OK to destroy a keypair on the EC2 server without\ninterfering with instances that want to use that keypair? It's entirely\npossible for a job to end up in GM_DELETE state after the instance has\nbeen requested but before the server has started it, and for the job to\nbe healthly and recoverable and will be seen by the gridmanager in the\nnear future.\n</li></ul>\n\n<p></p><hr/>\n<em>2013-Feb-21 15:13:05 by tlmiller:</em> <br/>\n\nAfter discussion with Jaime, the code will be amended to be much less aggressive: only remove keypairs from the server under the same conditions as from disk.  Discussion, however, revealed the problem discussed in the child ticket (<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3508\" onclick=\"get_ticket_and_populate_wrapper('3508'); return false;\" title=\"Jobs which fail to remove their keypairs don't go on hold.\">#3508</a></span>).</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=3508\" onclick=\"get_ticket_and_populate_wrapper('3508'); return false;\" title=\"Jobs which fail to remove their keypairs don't go on hold.\">#3508</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nJobs which fail to remove their keypairs don't go on hold.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Mar-07 17:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db1124562ff4d32a471c267d6d23cc112fffe878\">[35104]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3477\" onclick=\"get_ticket_and_populate_wrapper('3477'); return false;\" title=\"Keypairs of EC2 jobs may not be cleaned up.\">#3477</a></span>) Implement corrections as agreed. Also fixed double-delete bug.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-19 11:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/22b420fc9a46548e031593167fafe4793a3f687b\">[34965]</a></span>: minor edit and spelling correction to 7.9.4 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3477\" onclick=\"get_ticket_and_populate_wrapper('3477'); return false;\" title=\"Keypairs of EC2 jobs may not be cleaned up.\">#3477</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-06 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ab84ef31c1c8a12501546a8f5da1d4e09ffdabef\">[34868]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3477\" onclick=\"get_ticket_and_populate_wrapper('3477'); return false;\" title=\"Keypairs of EC2 jobs may not be cleaned up.\">#3477</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3436\" onclick=\"get_ticket_and_populate_wrapper('3436'); return false;\" title=\"Batch status update requests for EC2 resources.\">#3436</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3367\" onclick=\"get_ticket_and_populate_wrapper('3367'); return false;\" title=\"Condor thinks VMs in OpenStack's &quot;SHUTOFF&quot; state are running\">#3367</a></span>) Document bug fixes and feature.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-06 14:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/53efa9e40b10884ed0b46d9b3af69dfc25bd6ea0\">[34862]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3477\" onclick=\"get_ticket_and_populate_wrapper('3477'); return false;\" title=\"Keypairs of EC2 jobs may not be cleaned up.\">#3477</a></span>) Fix EC2 keypair cleanup.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Feb-05 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/16a666d66798a856cad68efb8b70863df5e5821f\">[34864]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3477\" onclick=\"get_ticket_and_populate_wrapper('3477'); return false;\" title=\"Keypairs of EC2 jobs may not be cleaned up.\">#3477</a></span>) Fix EC2 keypair cleanup.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Jul-09 10:11", "status": "resolved", "created": "2013-Feb-04 13:56", "fixed_version": "2013-Feb-04 13:56", "broken_version": "v070903", "priority": "2", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com tlmiller@cs.wisc.edu", "due_date": ""}