{"id": 5705, "title": "Ticket #5705: Add NumJobCompletions to job ad.", "description": "<blockquote>\nLauren has a customer whose desired job policy is \"for a job to retry if it exits nonzero, but only five times, not counting evictions (which should cause the job to retry as usual).\"\n\n<p>As far as we can tell, this can't actually be done.  It is possible that using <code>NumShadowExceptions</code>  would get a closer approximation, inasmuch as the \"eviction\" above may also refer to a glide-in being killed.\n\n</p><p>However, it shouldn't be too hard to have the shadow track the number of times the starter sent it an actual voluntary exit code and update the job ad appropriately.  (It may be complicated by however it is that we handle the OOM killer and/or hard cgroup (memory) limits; I'm not sure.)\n\n</p><p>This raises a question, however, about what to do about situations where the job's process completes (voluntarily exits) -- successfully or not -- but file transfer does not.  I would assume that this user would like their job to retry, but that's without thinking too hard.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jun-13 15:47:27 by tlmiller:</em> <br/>\n\n<ul>\n<li>The OOM killer puts things on hold, so that won't complicate anything.\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobCompletions\" title=\"Num Job Completions\">NumJobCompletions</a></span> will be initialized to 0 to avoid unfortunate propogation of undefined.\n</li><li>After speaking with Lauren, I confirmed that the user perspective is that if file transfer didn't complete, neither did the job.\n</li><li>Still need to look into hard cgroup memory limits.\n</li></ul>\n\n<p></p><hr/>\n<em>2016-Jun-13 15:50:36 by tlmiller:</em> <br/>\n\nThe testing for this could be rather extensive: for each of 'with file transfer on exit', 'with file transfer on exit or evict', and 'without file transfer', check that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobCompletions\" title=\"Num Job Completions\">NumJobCompletions</a></span> changes by +1 on: exit 0, nonzero exit, and signal exit; and does not change on condor_hold, condor_vacate, condor_vacate_job, kill -9 starter, and kill -9 startd.  (The last two should not depend on anything about file transfer, and so probably only need to be tried once each.)\n\n<p>Not clear that we actually need all that, but it shouldn't be hard to do in the framework.\n\n</p><p></p><hr/>\n<em>2016-Jun-13 16:18:19 by tlmiller:</em> <br/>\n\nSo it turns out that we hold on OOM kills only when using cgroups.  However, having <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobCompetions\" title=\"Num Job Competions\">NumJobCompetions</a></span> incremented by that is consistent with the wrong way the rest of HTCondor treats that case (as a \"normal\" SIGKILL, whatever that would be), so I won't worry about it.\n\n<p>Hard cgroup memory limits also cause a job to go on hold, so that's not anything to be concerned about, either.\n\n</p><p></p><hr/>\n<em>2016-Jun-15 10:24:37 by tlmiller:</em> <br/>\n\nConverted testing needs into a new ticket, <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5731\" onclick=\"get_ticket_and_populate_wrapper('5731'); return false;\" title=\"Add tests for NumJobCompletions.\">#5731</a></span>, to give the student a swing at it.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5731\" onclick=\"get_ticket_and_populate_wrapper('5731'); return false;\" title=\"Add tests for NumJobCompletions.\">#5731</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd tests for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobCompletions\" title=\"Num Job Completions\">NumJobCompletions</a></span>.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-29 14:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48700\">[48700]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5705\" onclick=\"get_ticket_and_populate_wrapper('5705'); return false;\" title=\"Add NumJobCompletions to job ad.\">#5705</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5726\" onclick=\"get_ticket_and_populate_wrapper('5726'); return false;\" title=\"Fix HAD/REPLICATION problems with shared port.\">#5726</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5728\" onclick=\"get_ticket_and_populate_wrapper('5728'); return false;\" title=\"Sinful::addressPointsToMe() can't just compare the primary address.\">#5728</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-13 15:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48550\">[48550]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5705\" onclick=\"get_ticket_and_populate_wrapper('5705'); return false;\" title=\"Add NumJobCompletions to job ad.\">#5705</a></span>) Initialize <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobCompletions\" title=\"Num Job Completions\">NumJobCompletions</a></span> to 0 in the three different places(!) that needed it.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-11 14:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=48549\">[48549]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5705\" onclick=\"get_ticket_and_populate_wrapper('5705'); return false;\" title=\"Add NumJobCompletions to job ad.\">#5705</a></span>) Add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NumJobCompletions\" title=\"Num Job Completions\">NumJobCompletions</a></span> to job ad.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jun-29 14:11", "status": "resolved", "created": "2016-Jun-03 11:01", "fixed_version": "2016-Jun-03 11:01", "broken_version": "", "priority": "4", "subsystem": "DaemonsExecNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "lmichael@wisc.edu, ckoch5@wisc.edu", "due_date": ""}