{"id": 4784, "title": "Ticket #4784: User history file", "description": "<blockquote>\nCurrently, the post-job for CMS CRAB3 has to parse all of the user log to find some simple statistics for the job that just ended (the alternate is to use condor_history, but that's similarly expensive).  This has gotten increasingly expensive as users run a few thousand nodes per DAG.\n\n<p>All of the information we need is in the final <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> dropped in the $PER_JOB_HISTORY_DIR; unfortunately, we need <strong>all</strong> the jobs associated with a node, meaning this approach isn't really going to work.\n\n</p><p>Instead, I'd like to see a top-level submit command:\n\n</p><p></p><div class=\"verbatim\">\n<pre>history = /path/to/file\n</pre></div>\n\n\n<p>This file gets the final job classad appended by the schedd at the same time it writes the final terminate event (so it's always available to the postjob).</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-17 09:47:33 by bbockelm:</em> <br/>\n\nPushed an example implementation.\n\n<p>We'll need to think about the \"naming\" issues of this feature.  If we want a classad available to the postjob script, we must write to this file immediately before updating the user log.  <strong>However</strong>, the job has not yet exited the queue when this occurs - hence, it's not really the same as the ad in condor_history!\n\n</p><p>A pithy example - when the shadow writes the terminate event (meaning that the postjob may fire up 1ms later), the job ad still lists itself as <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatus\" title=\"Job Status\">JobStatus</a></span> = 2 (running).\n\n</p><p>This is sufficient for our use case (even with the \"wrong\" <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobStatus\" title=\"Job Status\">JobStatus</a></span>), but possibly shouldn't be named the \"history\" file.\n\n</p><p>Suggestions?\n\n</p><p></p><hr/>\n<em>2015-Feb-05 19:33:25 by bbockelm:</em> <br/>\n\nOn the HTCondor / CMS call, we came up with an approach that could implement this with existing mechanisms.  We'll try this in CMS - if it makes significant improvements, we'll re-open.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-17 09:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4fca2c88113119e1d0d885b5ee26b52860b331bc\">[41947]</a></span>: Record job ad at abort or terminate time into a file. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4784\" onclick=\"get_ticket_and_populate_wrapper('4784'); return false;\" title=\"User history file\">#4784</a></span> This commit records the job ad at abort / terminate time before the corresponding user log event is logged. This guarantees that the job's final(ish) <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> is available to a DAG's postjob script.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-17 09:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c97748d7fd0a3a9c6ad4f28c39ef172a83b49d8f\">[41946]</a></span>: Allow <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span> to be used for PRIV_USER. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4784\" onclick=\"get_ticket_and_populate_wrapper('4784'); return false;\" title=\"User history file\">#4784</a></span> This commits adds a new constructor to TPS which allows you to set the privilege based on a job ad.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Feb-05 19:33", "status": "defer", "created": "2014-Dec-16 19:56", "fixed_version": "2014-Dec-16 19:56", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "bbockelm", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}