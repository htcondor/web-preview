{"id": 7304, "title": "Ticket #7304: CCB Scaling Improvement", "description": "<blockquote>\nA schedd can overload the Condor Connection Broker if given a large number of matches at once.  The initial bottleneck is that the schedd makes a separate TCP connection to the broker for each connection it wants to reverse.  Clearly, we can do better.</blockquote>", "remarks": "<blockquote>\n<em>2020-Apr-02 08:28:27 by tlmiller:</em> <br/>\n\nPending actually getting everything working, I wrote a\n<a class=\"external\" href=\"https://docs.google.com/document/d/1UxZas9lr2IakvIWofuP028iIhffLu42fpykUOnuf9g0\">\"retro\" design doc</a> to help keep things straight across high-priority interruptions.\n\n<p></p><hr/>\n<em>2020-Dec-07 10:07:12 by tlmiller:</em> <br/>\n\nNow <a class=\"external\" href=\"https://opensciencegrid.atlassian.net/browse/HTCONDOR-113\">HTCONDOR-113</a>.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-30 17:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59537\">[59537]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Actually add the test program (oops). Don't register a socket we know won't be valid after we exit the command handler.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-30 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59535\">[59535]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Fix a client-side memory leak. Change the server side to avoid a daemon core bug (where it segfaults if a handler returns FALSE instead of KEEP_STREAM if the socket might be closed). Steal GregT's ccb/CMakeLists.txt patch to avoid building the test executable twice (and relinking everything).\u00a0[...]\n (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-22 15:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59534\">[59534]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Put off \"the \"last\" FIXME\" for a while.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-22 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59447\">[59447]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Handle wrap-around in request IDs for batched CCB requests as well.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-20 15:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59427\">[59427]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Missed a typo.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-20 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59426\">[59426]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: convert to a connections-per-second limiter rather than always delay ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-09 14:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59291\">[59291]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: deal with some FIXMEs ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-08 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59283\">[59283]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: correctly retry (and forget and destroy, if necessary) clients on broker failures. Do the same for specific failures from the broker ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-08 12:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59282\">[59282]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: commit a few acts of memory management ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-02 08:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59228\">[59228]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Fix some improper indentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-01 11:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59226\">[59226]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: batched requests now actually work! ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-01 08:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59225\">[59225]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: batch requests to the server ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-30 09:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59224\">[59224]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) .. tracking: introduce a callback-based variable delay ..  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-29 18:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59223\">[59223]</a></span>: (<span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=7304\" onclick=\"get_ticket_and_populate_wrapper('7304'); return false;\" title=\"CCB Scaling Improvement\">#7304</a></span>) Split out a code path for handling batchable CCB clients.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Dec-07 10:07", "status": "abandoned", "created": "2019-Oct-08 12:12", "fixed_version": "2019-Oct-08 12:12", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}