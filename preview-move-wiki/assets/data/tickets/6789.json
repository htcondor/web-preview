{"id": 6789, "title": "Ticket #6789: Use instance role credentials when available for EC2", "description": "<blockquote>\n<strong>Problem Statement</strong>\n\n<p>Users running HTCondor in an AWS instance, even if the instance('s role) has the privilege to start new instances, must still copy-and-paste their credentials into the instance.  We regard this as a UX bug.\n\n</p><p><strong>Goals</strong>\n\n</p><p>A user who starts an instance (with a sufficiently-privileged IAM role) should be able to successfully run <code>condor_annex</code> in that instance without additional configuration.\n\n</p><p><strong>Overview</strong>\n\n</p><p>Amazon runs a (mostly?) private webserver for each instance called the metadata server.  This server provides a JSON file at a particular URL that contains the temporary credentials (and their expiration date).  The AWS infrastructure regularly renews these credentials; the documentation recommends checking for new credentials once an hour, or at least fifteen minutes before the specified expiration date.\n\n</p><p>These credentials, unlike the permanent credentials we've been using until now, come in three parts; all three parts are necessary to use them.\n\n</p><p><strong>Specifications</strong>\n\n</p><p>For the specific use-case of <code>condor_annex</code>, we won't concern ourselves with credential caching or renewal; the GAHP will simply obtain the necessary tokens from the meta-data server when it needs them.\n\n</p><p>We also declare it to be acceptable to have to 'sudo' when using <code>condor_annex</code>, in case the machine has been configured (as annex nodes are by default) to limit access to the metadata server to root processes.\n\n</p><p>The GAHP will know to obtain the necessary tokens from the metadata server if given a specific \"magic\" value for access or secret key files, or perhaps if those values are empty, instead.\n\n</p><p>The <code>condor_annex</code> tool will use this mode either because of a command-line flag or if the appropriate config knobs are not set.\n\n</p><p><strong>Future Considerations</strong>\n\n</p><p>For longer-duration and/or larger-scale uses, like with the grid manager, we'll need to worry about caching and renewal.  One possibility is to manage that process in the grid manager, and teach the GAHP to get the three tokens from files.  To avoid rewriting all of the call sites, we could add a GAHP command which associated key filename pairs with the filename of the third token.  (We could also simply use conventions about the naming, but that would prclude the user from naming these files as they see fit.)  This would also allow the user to supply <em>only</em> temporary credential; more research is required to determine how to renew those.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Oct-03 14:57:41 by tlmiller:</em> <br/>\n\nThe attribute for the third security token in the v4 signing protocol is <code>X-Amz-Security-Token</code>; the attribute in the v2 signing protocol is <code>SecurityToken</code>.\n\n<p></p><hr/>\n<em>2018-Oct-03 16:30:16 by tlmiller:</em> <br/>\n\nUseful documentation:\n\n<p><a class=\"external\" href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials\">Using IAM roles from EC2</a>\n\n</p><p><a class=\"external\" href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\">general instance metadata</a>\n\n</p><p><a class=\"external\" href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_use-resources.html\">Using temporary credentials (V4)</a>\n\n</p><p><a class=\"external\" href=\"https://docs.aws.amazon.com/general/latest/gr/signature-version-2.html\">Using temporary credentials (V2)</a>\n\n</p><p></p><hr/>\n<em>2018-Oct-08 16:07:55 by tlmiller:</em> <br/>\n\nForgot to test commit with <code>condor_annex -setup</code> (et alia).\n\n<p>Then think about <code>condor_annex</code> UI -- shouldn't require both access &amp; secret key be 'FROM INSTANCE'... maybe check if one is FROM and the other INSTANCE?  Also, should an unspecified key default to FROM INSTANCE -setup, or to the conventional location for the keys?  (This would require bigger documentation changes.... of course, so would using roles for this purpose at all.)\n\n</p><p></p><hr/>\n<em>2018-Oct-08 16:12:01 by tlmiller:</em> <br/>\n\nPerhaps as another ticket, thoughts on caching the credentials so we don't accidentally overload the meta-data server.  (Cache should expire &gt; 15 minutes before the credentials do, according to the documentation.)  (I guess a cache in the GAHP isn't so unreasonable... if there's not enough activity to keep a GAHP active, it's not like grabbing the credentials one more time for the new GAHP is going to overload the metadata server.)\n\n<p></p><hr/>\n<em>2018-Oct-10 16:07:12 by tlmiller:</em> <br/>\n\nCreated child ticket for caching.\n\n<p>Implemented 'condor_annex -setup from instance', for lack of a better alternative.\n\n</p><p>Need to update documentation.\n\n</p><p></p><hr/>\n<em>2018-Oct-11 16:20:53 by tlmiller:</em> <br/>\n\nShould get the documentation reviewed, since there's quite a bit of it.\n\n<p></p><hr/>\n<em>2019-Feb-08 11:24:16 by tim:</em> <br/>\n\n<strong>Doc Review:</strong> Use different font for \"FROM INSTANCE\" \\Expr{}. Add \"FROM INSTANCE\" to the condor_annex man page.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=6795\" onclick=\"get_ticket_and_populate_wrapper('6795'); return false;\" title='\"FROM INSTANCE\" credentials should be cached'>#6795</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n\"FROM INSTANCE\" credentials should be cached</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-08 13:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56151\">[56151]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6789\" onclick=\"get_ticket_and_populate_wrapper('6789'); return false;\" title=\"Use instance role credentials when available for EC2\">#6789</a></span>) Corrections from the doc review.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-11 16:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55554\">[55554]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6789\" onclick=\"get_ticket_and_populate_wrapper('6789'); return false;\" title=\"Use instance role credentials when available for EC2\">#6789</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-10 16:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55550\">[55550]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6789\" onclick=\"get_ticket_and_populate_wrapper('6789'); return false;\" title=\"Use instance role credentials when available for EC2\">#6789</a></span>) 'condor_annex -setup FROM INSTANCE' configures your annex to use the instance( role)'s credentials.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Oct-08 16:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55532\">[55532]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6789\" onclick=\"get_ticket_and_populate_wrapper('6789'); return false;\" title=\"Use instance role credentials when available for EC2\">#6789</a></span>) When the user specifies FROM INSTANCE for either the access or secret key, obtain it from the EC2 instance meta-data server, if available.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Feb-08 13:46", "status": "resolved", "created": "2018-Oct-03 13:47", "fixed_version": "2018-Oct-03 13:47", "broken_version": "", "priority": "2", "subsystem": "Annex", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu, jfrey@cs.wisc.edu", "due_date": ""}