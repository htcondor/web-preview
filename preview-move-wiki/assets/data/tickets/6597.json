{"id": 6597, "title": "Ticket #6597: Slots can become stuck in Claimed/Busy forever after a job completes", "description": "<blockquote>\nIf the shadow and schedd can't talk to the startd after job completion, then the slot can end up in Claimed/Busy state forever. After changes in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4491\" onclick=\"get_ticket_and_populate_wrapper('4491'); return false;\" title=\"Scalable claim keepalive protocol\">#4491</a></span>, the startd doesn't communicate with the schedd about the health of its claim while the starter is running. It assumes the starter is performing that function with the shadow. But after a job completes, the TCP connection between starter and shadow closes and the starter waits around to be told to exit by the startd. Normally, the shadow sends a deactivate claim message to the startd, and the schedd may send a release claim message. Either of these will cause the startd to tell the starter to exit. But if these messages can't be delivered, the startd and starter end up in a live-lock with each waiting for the other to tell it something about the current active claim.\n\n<p>Killing the starter is sufficient to clear up the condition once it arises. The problem detailed in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6596\" onclick=\"get_ticket_and_populate_wrapper('6596'); return false;\" title=\"Share port daemon hanging on Debian 8\">#6596</a></span> makes this condition very likely to occur.\n\n</p><p>One way to avoid this situation is to have the starter exit once it has no further work to do. This could be after its last RPC to the shadow, or after the connection with the shadow closes.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-30 16:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54637\">[54637]</a></span>: Remove debugging statement. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6597\" onclick=\"get_ticket_and_populate_wrapper('6597'); return false;\" title=\"Slots can become stuck in Claimed/Busy forever after a job completes\">#6597</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-30 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54636\">[54636]</a></span>: Docs for starter exiting when it has no further work to do. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6597\" onclick=\"get_ticket_and_populate_wrapper('6597'); return false;\" title=\"Slots can become stuck in Claimed/Busy forever after a job completes\">#6597</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-30 15:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54635\">[54635]</a></span>: The starter now exits when it's done. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6597\" onclick=\"get_ticket_and_populate_wrapper('6597'); return false;\" title=\"Slots can become stuck in Claimed/Busy forever after a job completes\">#6597</a></span> Before, the starter waited forever to be told to exit by the startd. The startd does this when the claim is deactivated. If a deactivation or release of the claim never comes from the submit machine, then the slot would be stuck in Claimed/Busy state forever.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Apr-09 13:43", "status": "resolved", "created": "2018-Mar-07 11:35", "fixed_version": "2018-Mar-07 11:35", "broken_version": "v080600", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "jfrey", "derived_from": "#4491", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "", "due_date": ""}