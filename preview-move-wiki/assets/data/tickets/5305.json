{"id": 5305, "title": "Ticket #5305: condor_history reports jobs in history log out of order", "description": "<blockquote>\nThe command\n\n<p></p><pre>  [pcdev1:spool] condor_history 1938203\n</pre>\n\n<p>returns results out of order. i.e. this\n\n</p><p></p><pre>  1438541.0   salvatore.vita  9/25 00:01   0+00:00:01 C   9/25 00:01 /usr/bin/../bin/pegasus-kickstart -n pegasus::dirmanager -N null -R local -L lalinference_1127175575-1127175872 -T 2015-09-25T00:00:43-05:\n</pre>\n\n<p></p><pre>  before\n</pre>\n\n<p></p><pre>  [pcdev1:spool] condor_history 1938203\n   ID     OWNER          SUBMITTED   RUN_TIME     ST COMPLETED   CMD\n  1938203.0   salvatore.vita 10/7  13:32   0+00:06:50 C  10/7  13:39   /home/salvatore.vitale/lalsuites/master/ts_opt/bin/lalinference_burst --L1-flow 40 --approx SineGaussianF --quality-min 3 --psdlength 127\n</pre>\n\n<p></p><pre>  [pcdev1:spool] grep 1938203 history.20151008T000035\n  ClusterId = 1938203\n  Err = \"/home/salvatore.vitale/F2Y_pf/SG/NoErrNoMargPerfectPMatch/54/log/lalinference-1938203-0-.err\"\n  Out = \"/home/salvatore.vitale/F2Y_pf/SG/NoErrNoMargPerfectPMatch/54/log/lalinference-1938203-0-.out\"\n  GlobalJobId = \"pcdev1.nemo.phys.uwm.edu#1938203.0#1444242765\"\n  *** Offset = 204924583 ClusterId = 1938203 ProcId = 0 Owner = \"salvatore.vitale\" CompletionDate = 1444243178\n</pre>\n\n<p>Many jobs with similar numbers do appear for this user but they are all over the map. This is not how I have observed conodr_history to behave in the past.\n\n</p><p></p><pre>  ENABLE_HISTORY_ROTATION=TRUE\n  MAX_HISTORY_LOG=1000000000\n  MAX_HISTORY_ROTATIONS=100\n  ROTATE_HISTORY_DAILY=True\n  HISTORY_HELPER_MAX_HISTORY=999999999\n</pre>\n\n<p>You will note that the rotation policy used to be strictly size-based and I reliably saw all jobs reported by condor_history.\n\n</p><p></p><pre>  [pcdev1:spool] ls -lh history.2*\n  -rw-r--r-- 1 condor 954M Jun 23 08:06 history.20150623T080605\n  -rw-r--r-- 1 condor 954M Aug  4 11:04 history.20150804T110427\n  -rw-r--r-- 1 condor 954M Aug 21 18:47 history.20150821T184722\n  -rw-r--r-- 1 condor 954M Sep 17 22:23 history.20150917T222343\n  -rw-r--r-- 1 condor 954M Sep 24 01:41 history.20150924T014114\n  -rw-r--r-- 1 condor 954M Sep 25 05:00 history.20150925T050026\n  -rw-r--r-- 1 condor 954M Sep 26 05:00 history.20150926T050047\n  -rw-r--r-- 1 condor 954M Sep 28 11:26 history.20150928T112624\n  -rw-r--r-- 1 condor 141M Sep 29 23:59 history.20150930T000002\n  -rw-r--r-- 1 condor 318M Sep 30 23:59 history.20151001T000000\n  -rw-r--r-- 1 condor 379M Oct  1 23:59 history.20151002T000000\n  -rw-r--r-- 1 condor 436M Oct  2 23:59 history.20151003T000001\n  -rw-r--r-- 1 condor 432M Oct  3 23:59 history.20151004T000008\n  -rw-r--r-- 1 condor 356M Oct  4 23:59 history.20151005T000000\n  -rw-r--r-- 1 condor 431M Oct  5 23:59 history.20151006T000000\n  -rw-r--r-- 1 condor 424M Oct  6 23:59 history.20151007T000001\n  -rw-r--r-- 1 condor 210M Oct  7 23:58 history.20151008T000035\n  -rw-r--r-- 1 condor  32M Oct  8 23:55 history.20151009T000657\n  -rw-r--r-- 1 condor 236M Oct  9 23:59 history.20151010T000000\n  -rw-r--r-- 1 condor 463M Oct 10 23:59 history.20151011T000000\n  -rw-r--r-- 1 condor 424M Oct 11 23:59 history.20151012T000000\n  -rw-r--r-- 1 condor 428M Oct 12 23:59 history.20151013T000001\n</pre>\n\n<p>The command that points directly to the file succeeds.\n\n</p><p></p><pre>  [pcdev1:~] condor_history -file history.20151008T000035 1938203\n   ID     OWNER          SUBMITTED   RUN_TIME     ST COMPLETED   CMD\n  1938203.0   salvatore.vita 10/7  13:32   0+00:06:50 C  10/7  13:39 /home/salvatore.vitale/lalsuites/master/ts_opt/bin/lalinference_burst --L1-flow 40 --approx SineGaussianF --quality-min 3 --psdlength 127</pre>\n</blockquote>", "remarks": "<blockquote>\nI wrongly made the assumption that condor_history parsed the files in lexical order in the initial report of this bug. It appears to go out of order (of completion times).\n\n<p>Because we use condor_history to plan our hardware needs, it might be helpful to have a better sense of how condor_history works. It would definitely be nicer to be able to craft searches that reliably query a certain time range without parsing every single history file or being forced to supply filenames to condor_history.\n\n</p><p></p><hr/>\n<em>2015-Oct-16 13:18:29 by tpdownes:</em> <br/>\n\nThis has a larger impact than you might guess. As I have daily log rotations enabled, it effectively means that I need to know the date on which a job completed for the search to complete in a reasonable amount of time.\n\n<p>Can someone confirm this behavior on the Condor side?\n\n</p><p></p><hr/>\n<em>2015-Oct-20 15:24:41 by johnkn:</em> <br/>\n\nso the problem is that condor_history always reads the history files with a file extension in the opposite order than it should. so if you have 3 files\n\n<p></p><pre>    history\n    history.yesterday\n    history.day-before-yesterday\n</pre>\n\n<p>It will (by default) read them in this order\n\n</p><p></p><pre>    history\n    history.day-before-yesterday\n    history.yesterday\n</pre>\n\n<p>The problem is that the files with extensions are sorted, then the current file is prefixed to that list.  but the files with extensions are sorted in the wrong order, so things work when there is only a single file with an extension, but not when there are more than one.\n\n</p><p></p><hr/>\n<em>2015-Oct-21 11:46:06 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Approved</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-21 09:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f2367e282b118a7ca23a04d5bc8aaf5bffc4c861\">[46059]</a></span>: fix missing const for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=5305\" onclick=\"get_ticket_and_populate_wrapper('5305'); return false;\" title=\"condor_history reports jobs in history log out of order\">#5305</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-20 16:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/18a0e8e2c7df5a1de520f2e76c72b9c406d001a8\">[46047]</a></span>: version history for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=5305\" onclick=\"get_ticket_and_populate_wrapper('5305'); return false;\" title=\"condor_history reports jobs in history log out of order\">#5305</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Oct-20 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/325ca45419ec93e30de2b156e43e0a9824b93cd5\">[46044]</a></span>: fix for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=5305\" onclick=\"get_ticket_and_populate_wrapper('5305'); return false;\" title=\"condor_history reports jobs in history log out of order\">#5305</a></span>, condor_history reports jobs out of order. the actual problem was that when condor_history sorts the history files it does so with a broken sort function (missing deref), so the resulting sort was essentially random. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Oct-21 11:46", "status": "defer", "created": "2015-Oct-13 10:50", "fixed_version": "2015-Oct-13 10:50", "broken_version": "v080208", "priority": "5", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "downes@uwm.edu, tannenba@cs.wisc.edu, gthain@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}