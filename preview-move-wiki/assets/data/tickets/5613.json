{"id": 5613, "title": "Ticket #5613: how best to transform job classad prior to submission", "description": "<blockquote>\n<strong>NOTE: This ticket abandoned as we ultimately implemented the functionality in  <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5885\" onclick=\"get_ticket_and_populate_wrapper('5885'); return false;\" title=\"enable the schedd to perform job classad transforms upon submission\">#5885</a></span> instead</strong>\n\n<p>It was communicated to LIGO users before O1 that they needed to add \"accounting_group\" and \"accounting_group_user\" values to their submit files to track the consumption of individual users and of search groups. Unfortunately this decision binds you to use the group scheduling system of Condor, something that no LIGO site ultimately chose to do. LIGO users were quite good about adding the right lines to their submit files. These are also easy knobs to turn in Pegasus. So rather than tell them to stop, I wrote a wrapper that transforms:\n\n</p><p>accounting_group = ligo.bla.bla.bla<br/>\n\nto<br/>\n\n+LigoSearchTag = ligo.bla.bla.bla\n\n</p><p>in the submit file before submission by using the \"-dump\" argument to submit and normal shell scripting tools. There are also some rules concerning the values which were being enforced by a Python helper which I have successfully re-implemented using CLASSAD_USER_PYTHON_MODULES and SUBMIT_REQUIREMENT_NAMES.\n\n</p><p>I would like to see the transformation replaced with something that doesn't require replacing condor_submit in the user's PATH. Something like SUBMIT_REQUIREMENT_NAMES would be nice, e.g.:\n\n</p><p>I'd really like to see this look more like SUBMIT_REQUIREMENTs. This is described in greater detail in the ticket. For example,\n\n</p><p></p><pre>  CLASSAD_USER_PYTHON_MODULES = ligojob\n  SUBMIT_TRANSFORM_NAMES = LIGOJOB\n  SUBMIT_TRANSFORM_LIGOJOB = ligoxform(Target.ClassAd)\n</pre>\n\n<p>The last line is not intended to be literal but to evoke the idea. In the meantime, my wrapper solution is below.\n\n</p><p><span class=\"subsection\"></span></p><h3>condor_submit wrapper</h3>\n\n<p></p><pre>  #!/bin/bash\n  CONDOR_SUBMIT_BINARY=/usr/bin/condor_submit\n  CONDOR_SUBMIT_XFORM=/home/tpdownes/wrapper-testing/test.py\n</pre>\n\n<p></p><pre>  if [ $# -eq 0 ]; then\n    ${CONDOR_SUBMIT_BINARY} -dump - - | ${CONDOR_SUBMIT_XFORM}\n  else\n    ${CONDOR_SUBMIT_BINARY} -dump - \"$@\" | ${CONDOR_SUBMIT_XFORM}\n  fi\n</pre>\n\n<p></p><pre>  exit 0\n</pre>\n\n<p><span class=\"subsection\"></span></p><h3>condor_submit transformation</h3>\n\n<p></p><pre>  #!/usr/bin/python\n  import htcondor\n  import classad\n  import sys\n</pre>\n\n<p></p><pre>  adString = sys.stdin.read()\n  ad = classad.parseOne(adString)\n</pre>\n\n<p></p><pre>  ad['LigoSearchTag'] = ad['AcctGroup']\n  ad['LigoSearchUser'] = ad['AcctGroupUser']\n  del ad['AcctGroup']\n  del ad['AcctGroupUser']\n</pre>\n\n<p></p><pre>  htcondor.Schedd().submit(ad)</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Apr-13 12:35:10 by tpdownes:</em> <br/>\n\nFWIW: the above code doesn't seem to work although it is otherwise behaving as expected. It results in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ValueError\" title=\"Value Error\">ValueError</a></span> exceptions at the very last line of the python. The specific value changes around upon re-submission.\n\n<p></p><pre>  ValueError: NumCkpts\n  ValueError: ExitBySignal\n</pre>\n\n<p>The fundamental problem here is that there is no way for a python program to ingest a submit-language file, only classads. I can continue to use shell scripts to transform the job classads at submission but it's hacky by virtue of depending on PATH. I prefer something admin-side only.\n\n</p><p></p><hr/>\n<em>2016-Apr-13 13:03:29 by gthain:</em> <br/>\n\nNote this is similar to <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=4804\" onclick=\"get_ticket_and_populate_wrapper('4804'); return false;\" title=\"Managed condor_submit transforms\">#4804</a></span></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "enhance", "last_change": "2020-Aug-10 11:52", "status": "abandoned", "created": "2016-Apr-08 16:45", "fixed_version": "2016-Apr-08 16:45", "broken_version": "v080503", "priority": "5", "subsystem": "", "assigned_to": "", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}