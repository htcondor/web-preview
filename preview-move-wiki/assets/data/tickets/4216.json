{"id": 4216, "title": "Ticket #4216: Grid jobs can leave local queue without canceling remote job", "description": "<blockquote>\nWhen the gridmanager encounters an error with a job, it may put the job on hold for user intervention and free all data structures related to the job. If the job is later removed but is still submitted to a remote server, the gridmanager receives the job again and cleans up all state on the remote server before letting the job leave the local job queue. We have found a case where the gridmanager takes the removed job out of the queue before attempting to clean up any state on the remote server. This has been observed with EC2 jobs, leaving ssh key pairs created by the gridmanager on the EC2 server. But it can affect any grid job.\n\n<p>Each time the gridmanager connects to the schedd, there are two queries it may perform. The first query is for any jobs that it should be managing but currently isn't. This normally applies to jobs that have just been submitted or released. The gridmanager starts managing the jobs returned by the query. The second query is for jobs that it's managing whose status has changed to the Held, Removed, or Completed state. This usually indicates the user has held or removed a job and the gridmanager needs to cancel the job on the remote server.\n\n</p><p>The first query is done at startup and whenever the schedd sends a signal to the gridmanager indicating there are new jobs for it to manage. The second query is performed on every connection to the schedd. If the second query returns a job in Removed state that the gridmanager isn't currently managing, the gridmanager immediately lets the job leave the queue.\n\n</p><p>Normally, when a held job is removed, the schedd signals the gridmanager that it has new jobs to manager. The gridmanager then connects the schedd and issues the two queries described above. The remove job will be returned for both queries. The first query results in the gridmanager starting to manage the job. The second query tells it that the job is removed (redundant in this case, as the Removed status is part of the job ad returned for the first query).\n\n</p><p>The problem occurs when the gridmanager connects to the schedd after a held job has been removed but before the schedd has sent the signal to the gridmanager about new jobs to manage.\nThe gridmanager will skip the first query (about new jobs) but still issue the second query (about Removed/Held/Completed jobs). The removed job will be returned by the second query but the gridmanager isn't managing it, so the gridmanager lets it leave the queue immediately.\nConnecting to the schedd can be triggered by events other than the signal from the schedd. For example, the gridmanager may need to modify attributes for other jobs in the schedd's queue.\n\n</p><p>Possible solutions:\n</p><ul>\n<li>Combine the two queries, modifying the constraint depending whether the \"new jobs\" signal has been received. The gridmanager would start managing all jobs returned by the query that aren't been managed yet. This would be more efficient for the schedd, but is probably too large a change for the stable series.\n\n<p></p></li><li>When the second query returns jobs that the gridmanager isn't managing, the gridmanager leaves the jobs in the queue, and optionally sends itself the \"new jobs\" signal. This is a small change suitable for the stable series.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Feb-19 10:20:41 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good.\n\n</p><p>(For future reference: this patch delays clean-up of removed jobs that were held, in those cases where the race condition happens, by the length of the interval at which the grid manager polls the schedd.)</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4218\" onclick=\"get_ticket_and_populate_wrapper('4218'); return false;\" title=\"Merge gridmanager's queries of job ads from schedd\">#4218</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMerge gridmanager's queries of job ads from schedd</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-18 17:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39436\">[39436]</a></span>: Docs for removed grid jobs not canceling remote job. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4216\" onclick=\"get_ticket_and_populate_wrapper('4216'); return false;\" title=\"Grid jobs can leave local queue without canceling remote job\">#4216</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-18 17:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39435\">[39435]</a></span>: Grid jobs can leave local queue without canceling remote job. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4216\" onclick=\"get_ticket_and_populate_wrapper('4216'); return false;\" title=\"Grid jobs can leave local queue without canceling remote job\">#4216</a></span> When the gridmanager is querying for held/completed/removed jobs, don't call DestroyProc() on removed jobs that the gridmanager isn't currently managing. These could be valid jobs that have just been removed from the held state and need\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-19 11:00", "status": "resolved", "created": "2014-Feb-18 14:26", "fixed_version": "2014-Feb-18 14:26", "broken_version": "v080000", "priority": "3", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "", "due_date": ""}