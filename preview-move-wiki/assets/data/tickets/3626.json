{"id": 3626, "title": "Ticket #3626: Make default file descriptor limit larger for schedd and collector.", "description": "<blockquote>\nFor improved scalability-by-default, up the defaults for COLLECTOR_MAX_FILE_DESCRIPTORS and SCHEDD_MAX_FILE_DESCRIPTORS to 10240 and 4096, respectively.  Add these defaults to the param table.\n\n<p>The idea of upping in the collector is for CCB and/or TCP updates, and the idea of upping the schedd is for many simultaneous startd claims (i.e. startd claiming is non blocking, and the socket used for claiming may be kept open until <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MaxVacateTime\" title=\"Max Vacate Time\">MaxVacateTime</a></span> expires) and also because each shadow waiting in the file transfer queue will have a connection to the schedd.\n\n</p><p>To quote DanB about schedd FD limits:\n</p><div class=\"verbatim\">\n<pre>There are other things in the schedd that are affected by the FD limit.\n\nThe file transfer queue consumes FDs.  Each shadow waiting to do transfers\nmaintains a TCP connection to the file transfer queue manager, which\ncurrently resides in the schedd.\n\nWhen DaemonCore accepts connections and registers them for a non-blocking\nread, this can also chew up FDs.\n\nWhen the schedd connects to collectors and does a non-blocking security\nhandshake, this requires registering a socket.  Registering a socket will\nfail if the schedd is low on FDs, due to the file descriptor \"safety level\"\nlogic in DaemonCore.  I have seen this result in submitters not being\nadvertised during long periods of time when many claim requests were\npending.\n\nSpeaking of pending claim requests, keep in mind that when claims take a\nwhile to be requested (e.g. because of MaxJobRetirementTime), quite a lot of\nthese request-to-claim connections can exist for long periods of time.\nWe're planning to tweak the defaults so this situation doesn't happen, but\nwe're not yet making it impossible.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-May-15 13:32:24 by tlmiller:</em> <br/>\n\nIs the following change significant?\n\n<p></p><div class=\"code\">\n<pre class=\"code\">- limit(RLIMIT_NOFILE,max_fds,CONDOR_REQUIRED_LIMIT,\"MAX_FILE_DESCRIPTORS\");\n+ limit(RLIMIT_NOFILE,max_fds,CONDOR_HARD_LIMIT,\"MAX_FILE_DESCRIPTORS\");\n</pre></div>\n\n\n<p>Consensus seems to be yes, that despite the name, MAX_FILE_DESCRIPTORS when set is also sort of a minimum -- that there's no point in starting HTCondor if you you not sure you have enough file descriptors.  To preserve this semantic without requiring all personal Condors to change these knobs, only require the limit when running as root.\n\n</p><p></p><hr/>\n<em>2013-May-16 14:05:04 by tlmiller:</em> <br/>\n\nThis seems to do the job.\n\n<p></p><hr/>\n<em>2013-May-16 15:55:05 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\nInitial patch will not work correctly.  The problem is the change in daemon core.  The patch has:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">priv_state priv = set_root_priv();\nif( priv == PRIV_ROOT ) {\n   limit(RLIMIT_NOFILE,max_fds,CONDOR_REQUIRED_LIMIT,\"MAX_FILE_DESCRIPTORS\");\n} else {\n   limit(RLIMIT_NOFILE,max_fds,CONDOR_HARD_LIMIT,\"MAX_FILE_DESCRIPTORS\");\n}\nset_priv(priv);\n</pre></div>\n\n\n<p>The problem is 1) set_root_priv() returns the <em>previous</em> priv state, not the current one, and 2) set_root_priv() will still \"succeed\" even with a personal condor.  I think what you want instead of the above code snippet is:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">priv_state priv = set_root_priv();\nif( is_root() ) {\n   limit(RLIMIT_NOFILE,max_fds,CONDOR_REQUIRED_LIMIT,\"MAX_FILE_DESCRIPTORS\");\n} else {\n   limit(RLIMIT_NOFILE,max_fds,CONDOR_HARD_LIMIT,\"MAX_FILE_DESCRIPTORS\");\n}\nset_priv(priv);\n</pre></div>\n\n\n<p>The method <code>is_root()</code> lives in uids.cpp.\n\n</p><p>Please test again w/ the above and attach a v2 patch (needs to stay as a patch until there is a place in to repo to take v8.1.0 code).\n\n</p><p>Also, this change should go into v8.1.0, not v8.0.0. I will update ticket fields.\n\n</p><p></p><hr/>\n<em>2013-May-16 17:01:01 by bbockelm:</em> <br/>\n\nAlso -you do not want to use set_root_priv.  It's a bad habit to get into.  Rather, you want:\n\n<p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TemporaryPrivSentry\" title=\"Temporary Priv Sentry\">TemporaryPrivSentry</a></span> sentry(PRIV_ROOT)\n\n</p><p>This will automatically undo the change when \"sentry\" falls out of scope.\n\n</p><p></p><hr/>\n<em>2013-May-17 10:17:35 by tlmiller:</em> <br/>\n\nNew patch is testing in the BaTLab (run ID 128441).  I tested the new version of the patch as follows:\n\n<p>(1) In a personal Condor running as a normal user, I tried three values for SCHEDD_MAX_FILE_DESCRIPTORS: unset, lower than the system and HTCondor default (2048), way higher than the default (3000000).  I confirmed that this resulted in no ERROR()s and that /proc/&lt;schedd&gt;/limits had the correct values (4096, 2048, and the system default).\n\n</p><p>(2) In a personal Condor running as root, I tried four values for SCHEDD_MAX_FILE_DESCRIPTORS: unset, lower than the system and HTCondor default (2048), higher than the default (9001), and way higher than the default (3000000).  This resulted in (confirmed as above): 4096, 2048, 9001, and the expected ERROR().\n\n</p><p>I'm mentioning all this since I this repeats the tests I did on the earlier revision of the patch (which shouldn't have worked).\n\n</p><p></p><hr/>\n<em>2013-Jul-09 18:14:35 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Code in proposed patch version 2 looks fine other than documentation update (version history, change description of the two knobs to say the new default).</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/727/gt-3626.diff\">gt-3626.diff</a>\n3297 bytes added by tlmiller on 2013-May-16 19:05:25 UTC.\n<br/>\nProposed patch.<br/>\n</li><li><a href=\"../files/730/gt-3626.diff\">gt-3626.diff</a>\n3188 bytes added by tlmiller on 2013-May-17 15:18:02 UTC.\n<br/>\nProposed patch, version 2.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-25 10:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/031cdb718e3ed9efe34aff0244dee39b63d1f344\">[36993]</a></span>: better wording for change to defaults of the 2 knobs ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3626\" onclick=\"get_ticket_and_populate_wrapper('3626'); return false;\" title=\"Make default file descriptor limit larger for schedd and collector.\">#3626</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-17 13:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ebc92ef12fb3e697eedbd704bffe9a44b652d74\">[36942]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3626\" onclick=\"get_ticket_and_populate_wrapper('3626'); return false;\" title=\"Make default file descriptor limit larger for schedd and collector.\">#3626</a></span>) Document changes to default values for [SCHEDD|COLLECTOR]_MAX_FILE_DESCRIPTORS.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jul-09 18:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dca7558008a7d2f1408daf190b6342314fceb0b9\">[36840]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3626\" onclick=\"get_ticket_and_populate_wrapper('3626'); return false;\" title=\"Make default file descriptor limit larger for schedd and collector.\">#3626</a></span>) Make the default file descriptor limits larger for the collector and the schedd.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-Jul-17 13:32", "status": "resolved", "created": "2013-May-15 13:31", "fixed_version": "2013-May-15 13:31", "broken_version": "", "priority": "1", "subsystem": "Daemons", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}