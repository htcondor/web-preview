{"id": 1114, "title": "Ticket #1114: Improve methods to add/remove Target scope in expressions", "description": "<blockquote>\nThe <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> compatibility layer has a method that takes an ad and modifies all attribute references which don't resolve to a local attribute, adding a 'target' scope. The method is called AddExplicitTargetRefs(). That method creates a new ad that's a copy of the original ad, but with the modifications to the expressions. We want this method to modify the existing ad, rather than creating a new one. Also, we'd like to have a version that can modify an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> that's not in an ad. We also want a companion method that will remove all 'target' scopes from an expression or entire ad.\n\n<p><span class=\"section\"></span></p><h2>Milestones </h2>\n<ul>\n<li>Change public version of compat_classad::ClassAd::AddExplicitTargetRefs() to modify the current ad in-place\n</li><li>Make the private version of compat_classad::ClassAd::AddExplicitTargetRefs() into a free-standing function\n</li><li>Create a wrapper for the free-standing AddExplicitTargetRefs() that takes a ClassAd*, creates a set of attribute names, and calls the real AddExplicitTargetRefs()\n</li><li>Create a parallel set of functions named RemoveExplicitTargetRefs()\n</li></ul>\n\n<p><span class=\"section\"></span></p><h2>Details </h2>\n\n<p>The private version of compat_classad::ClassAd::AddExplicitTargetRefs() should be turned into a free-standing function. That will allow it to be used on <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTrees\" title=\"Expr Trees\">ExprTrees</a></span> that aren't in an ad. Having a second version of the free-standing function which takes a ClassAd* makes it easy for callers to use on a lone <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span>.\n\n</p><p>There will be places where we want to remove 'target.' from attribute references, which the RemoveExplicitTargetRefs() functions will do. They won't need a list of defined attributes, so we will only need one free-standing function, with no second argument.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Jan-19 14:42:30 by jfrey:</em> <br/>\n\nThese commits weren't quite what I was thinking of. I should have been clearer in my description. Here's what I want:\n\n<p></p><ul>\n<li><code>void compat_classad::ClassAd::AddExplicitTargetRefs()</code> - Public method that builds a set of all attribute names in the ad and calls the function immediately below for each of its attributes, inserting the returned <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> into the ad.\n</li><li><code>classad::ExprTree *AddExplicitTargetRefs(classad::ExprTree*, set&lt;string,CaseIgnLTStr&gt;&amp;)</code> - Identical to the former private method of the same name, but now free-standing. It does the real work of modifying an expression.\n</li><li><code>classad::ExprTree *AddExplicitTargetRefs(classad::ExprTree*, classad::ClassAd*)</code> - A convenience function that builds a set of all attribute names in the given ad and calls the function immediately above.\n</li></ul>\n\n<p>The first function looks good to go, but should be tested to make sure the iterator isn't thrown off by the Insert() that's replacing the current item.\n\n</p><p></p><hr/>\n<em>2010-Jan-19 14:50:37 by jfrey:</em> <br/>\n\nAnd here are the signatures for the removal functions:\n<ul>\n<li><code>void compat_classad::ClassAd::RemoveExplicitTargetRefs()</code> - Call the function below for each of the ad's attributes, inserting the returned <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> into the ad.\n</li><li><code>classad::ExprTree *RemoveExplicitTargetRefs(classad::ExprTree*)</code> - Create and return a new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> based on the given one, but without any <code>Target.</code> scoping.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-24 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17331\">[17331]</a></span>: Fix RemoveExplicitTargetRefs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span> It was doing a case-sensitive string compare and creating the wrong the attribute reference incorrectly.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-20 21:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16943\">[16943]</a></span>: Optimize TARGET scope modification methods in compat <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span> When iterating an entire ad looking for expressions whose attribute references may need modifying, skip attributes whose value is a literal. This is a fast check to make and avoids copying and replacing the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> in the common case.\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-20 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16936\">[16936]</a></span>: Removed private functions for Remove- and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AddExplicitTargetRefs\" title=\"Add Explicit Target Refs\">AddExplicitTargetRefs</a></span> entirely; got rid of temporary classad ( <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span> )  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-20 11:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16930\">[16930]</a></span>: Changed <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AddExplicitTargetRefs\" title=\"Add Explicit Target Refs\">AddExplicitTargetRefs</a></span> functions according to <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span> ; added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoveExplicitTargetRefs\" title=\"Remove Explicit Target Refs\">RemoveExplicitTargetRefs</a></span> functions  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-20 09:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16928\">[16928]</a></span>: AddExplicitTargetRefs() now works with functions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span> When this method was originally written, old <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> didn't have functions. Now that they do, we need to handle them when adding Target. scoping references.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-19 13:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16914\">[16914]</a></span>: Minor change for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span>  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-19 13:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16913\">[16913]</a></span>: Modifications according <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1114\" onclick=\"get_ticket_and_populate_wrapper('1114'); return false;\" title=\"Improve methods to add/remove Target scope in expressions\">#1114</a></span>; though no deletion functions added yet  (By Cathrin Weiss )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Feb-05 15:41", "status": "resolved", "created": "2010-Jan-15 14:15", "fixed_version": "2010-Jan-15 14:15", "broken_version": "v070500", "priority": "4", "subsystem": "Libs", "assigned_to": "cweiss", "derived_from": "#1112", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20100119"}