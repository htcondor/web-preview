{"id": 4150, "title": "Ticket #4150: Failure to transfer files larger than 4GB on 32bit platforms, Windows", "description": "<blockquote>\nOn 32bit platforms and ALL Windows platforms (since we always use a 32bit compiler on Windows to build), the shadow would stop the file transfer prematurely at the point when there was less than a multiple of 4 GB remaining to transfer on a file larger than 4 GB.  I was able to reproduce <a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/htcondor-users/2014-January/msg00045.shtml\">an incident report on htcondor-users</a> on Windows.\n\n<p>The issue was a coding bug involving the overflow of a 32bit integer.  Here is the offending line:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">nrd = ::read(fd, buf, (size_t)(bytes_to_send-total) &lt; sizeof(buf) ? bytes_to_send-total : sizeof(buf));\n</pre></div>\n\n\n<p>Note: type size_t is a 32bit integer on 32bit platforms, and \"bytes_to_send\" and \"total\" (total bytes already sent) are 64bit integers.\n\n</p><p>The third parameter to read() is the number of bytes to read. Essentially this line just reads X bytes from the file, where X is either the size of the buffer or the number of bytes left to read in the file, whichever is smaller.  The above code meant to cast the result of the conditional expression to a size_t, but instead due to order of operator precedence, it is just casting the subtraction sub-expression.  This can result in an overflow, resulting in the code passing 0 as the number of bytes to read, resulting in read() returning zero, which is interpreted as end-of-file and thus the transfer stops.  Inserting a couple ()'s fixes the problem.  Here is the fixed line:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">nrd = ::read(fd, buf, (size_t)((bytes_to_send-total) &lt; sizeof(buf) ? bytes_to_send-total : sizeof(buf)));\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Jan-09 17:24:32 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-24 11:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39232\">[39232]</a></span>: add 8.0.6 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4150\" onclick=\"get_ticket_and_populate_wrapper('4150'); return false;\" title=\"Failure to transfer files larger than 4GB on 32bit platforms, Windows\">#4150</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-09 17:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39131\">[39131]</a></span>: fix gcc warning about signed/unsigned comparison <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4150\" onclick=\"get_ticket_and_populate_wrapper('4150'); return false;\" title=\"Failure to transfer files larger than 4GB on 32bit platforms, Windows\">#4150</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-09 17:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39130\">[39130]</a></span>: fix gcc warning about signed/unsigned comparison <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4150\" onclick=\"get_ticket_and_populate_wrapper('4150'); return false;\" title=\"Failure to transfer files larger than 4GB on 32bit platforms, Windows\">#4150</a></span> ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-09 17:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39128\">[39128]</a></span>: Fix bug transferring files larger than 4GB on 32bit builds. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4150\" onclick=\"get_ticket_and_populate_wrapper('4150'); return false;\" title=\"Failure to transfer files larger than 4GB on 32bit platforms, Windows\">#4150</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-03 14:34", "status": "resolved", "created": "2014-Jan-09 16:58", "fixed_version": "2014-Jan-09 16:58", "broken_version": "v080000", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "smoler", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}