{"id": 2088, "title": "Ticket #2088: Dedicated scheduler releases half of claims", "description": "<blockquote>\nIf the parallel shadow for a multi-node (i.e. machine_count &gt; 1) process exits abnormally, the dedicated scheduler only releases half of the claims for that process. This tends to result in a job that appears to move back and forth between the idle and running states, with the shadow exiting each time with status 108. The <code>ShadowLog</code> notes that a particular machine(s) refused to start the job:\n\n<p></p><pre>  Request to run on &lt;XXX.XXX.XXX.XX:56351&gt; &lt;XXX.XXX.XXX.XXX:56351&gt; was REFUSED\n</pre>\n\n<p>The offending <code>StartLog</code> shows\n\n</p><p></p><pre>  Error: can't find resource with ClaimId (&lt;XXX.XXX.XXX.XXX:56351&gt;#1303787222#1#...) -- perhaps this claim was already removed?\n</pre>\n\n<p>For half of the nodes in a process, the dedicated scheduler notes:\n\n</p><p></p><pre>  ERROR in releaseClaim(): NULL m_rec\n</pre>\n\n<p>I believe the problem originates in <code>shutdownMPIJob()</code> in <code>dedicated_scheduler.cpp</code>, which attempts to perform a <code>releaseClaim()</code> on all nodes in a process. The current loop doesn't work because the length of the list continues to change due to calls to <code>DelMrec()</code>. This can be solved by releasing the claims in the opposite order.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-May-27 00:09:38 by eje:</em> <br/>\n\nRepro/test:\n\n<p>using the following configuration:\n</p><div class=\"code\">\n<pre class=\"code\"># dedicated scheduler\nDedicatedScheduler = \"DedicatedScheduler@localhost.localdomain\"\nSTARTD_EXPRS = $(STARTD_EXPRS), DedicatedScheduler\nRANK = 0 + (Scheduler =?= $(DedicatedScheduler))\n\nMPI_CONDOR_RSH_PATH = $(LIBEXEC)\nCONDOR_SSHD = /usr/sbin/sshd\nCONDOR_SSH_KEYGEN = /usr/bin/ssh-keygen\n\n# slots\nNUM_CPUS = 10\n</pre></div>\n\n\n<p>using the following submit file:\n</p><div class=\"code\">\n<pre class=\"code\">universe = parallel\ncmd = /bin/sleep\nargs = 300\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\nmachine_count=4\n+AccountingGroup = \"none.user0000\"\nqueue 1\n</pre></div>\n\n\n<p>Before fix: submit the job, and let it begin running.   Then invoke a \"condor_vacate_job\".\n\n</p><p>You will see null-m_rec errors from the ded-schedd:\n</p><div class=\"code\">\n<pre class=\"code\">$ tail -f SchedLog | grep -e 'ERROR.*NULL m_rec'\n05/26/11 21:54:02 (pid:11721) ERROR in releaseClaim(): NULL m_rec\n05/26/11 21:54:02 (pid:11721) ERROR in releaseClaim(): NULL m_rec\n</pre></div>\n\n\n<p>After the fix, there will be no null m_rec errors.\n\n</p><p></p><hr/>\n<em>2011-Jun-27 13:05:50 by smoler:</em> <br/>\n\nChanges committed to V7_6-branch, which caused this to be released with 7.6.1.  Changing Fixed Version field.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/331/shutdown_mpi_job.patch\">shutdown_mpi_job.patch</a>\n631 bytes added by david.herzfeld on 2011-Apr-26 03:46:39 UTC.\n<br/>\nPatch of dedicated_scheduler.cpp against V7_6-branch<br/>\n</li><li><a href=\"../files/362/gt2088_shutdown_mpi_job.patch2\">gt2088_shutdown_mpi_job.patch2</a>\n1922 bytes added by eje on 2011-May-27 05:03:03 UTC.\n<br/>\nModification of fix that saves match_rec pointers into a vector to keep them safe from destructive modification of the MRecArray during claim deactivation.  This incarnation is safe under any ordering in MRecArray.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-31 15:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f10ecbb09a40c798c2602087bfd8a15ecf47e7a7\">[22052]</a></span>: ===VersionHistory=== Fixed bug in deactivation of claims that improperly referenced a destructively modified MRecArray object. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2088\" onclick=\"get_ticket_and_populate_wrapper('2088'); return false;\" title=\"Dedicated scheduler releases half of claims\">#2088</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jun-27 13:06", "status": "resolved", "created": "2011-Apr-25 22:44", "fixed_version": "2011-Apr-25 22:44", "broken_version": "", "priority": "3", "subsystem": "Parallel", "assigned_to": "gthain", "derived_from": "", "creator": "david.herzfeld", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@redhat.com, david.herzfeld@marquette.edu, tstclair@redhat.com, gthain@cs.wisc.edu", "due_date": "20110601"}