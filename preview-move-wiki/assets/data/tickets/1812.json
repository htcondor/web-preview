{"id": 1812, "title": "Ticket #1812: shorten lifespan of delegated proxies", "description": "<blockquote>\nWhen condor delegates proxies in Condor-G and in vanilla universe, it should shorten the lifespan of the delegated proxy.  This would allow the user to have a long-lived proxy on the submit machine but only send short-lived proxies to the remote sites.\n\n<p>There should be a schedd-wide configuration knob to control the lifespan of delegated proxies.  The job should be able to override this.  The default should be 24h.\n\n</p><p>The proxy will need to be re-delegated periodically to avoid expiration.  This should be done by default at intervals of 1/4 of the delegated lifespan.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Jan-27 17:34:12 by danb:</em> <br/>\n\nI implemented this feature for Condor-C and non-grid universes.\n\n<p>As implemented, there is a new configuration setting DELEGATE_JOB_GSI_CREDENTIALS_LIFETIME which specifies the maximum number of seconds delegated credentials should be good for.  The default is one day.  The job can override this setting with its own setting of <code>DelegateJobGSICredentialsLifetime</code>.  Renewal of the credential is attempted as before (i.e. when the proxy on the submit node is updated) and periodically every 0.25 of the desired lifetime of the delegated proxy.  This schedule is adjustable with DELEGATE_JOB_GSI_CREDENTIALS_REFRESH, which defaults to 0.25.  The precision of the timing (and therefore the maximum rate of updates) can be controlled with SHADOW_CHECKPROXY_INTERVAL, which defaults to 600 (10 minutes).  When the proxy is delegated, the job <code>ClassAd</code> attribute <code>DelegatedProxyExpiration</code> is set to the timestamp when the delegated proxy will expire.\n\n</p><p>Jaime and I looked into adding support for Globus, but we did not see a straightforward way to do it, at least in gt2; the globus interfaces we are using do not support specifying a lifetime, so either we would need to patch the globus library and expose some methods that are not public, or we would need to delegate the credential twice: once internally in the memory of the gahp_server where we would shorten its lifespan, and then the usual delegation to the remote server.  I'm hoping we come up with a better option, because neither of those sounds very good.  If we do, we should open a new ticket for that work.\n\n</p><p>I have not added a built-in mechanism that puts the job on hold when the remote proxy expires.  This could be done with a periodic hold expression that references <code>DelegatedProxyExpiration</code> while the job is running.\n\n</p><p></p><hr/>\n<em>2011-Jan-28 15:22:08 by danb:</em> <br/>\n\nThere is one thing left to understand in this ticket: when using glexec, the shadow delegates a proxy to the startd in order to get things started.  As implemented, this delegation has a limited lifespan, just like the proxy delegated to the job.  However, the proxy delegated to the startd is never updated explicitly by the shadow.  I <em>think</em> this is ok, but I don't fully understand how that proxy is used, so I need to confirm.\n\n<p></p><hr/>\n<em>2011-Jan-28 15:34:53 by danb:</em> <br/>\n\nThe delegation of a proxy to the startd is for the deprecated glexec mode in which the starter is launched via glexec (GLEXEC_STARTER=true).  I don't think I have introduced any new problems in this case, and since it is deprecated, I am not going to spend more time investigating.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-14 12:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21050\">[21050]</a></span>: Avoid a spurious error message for jobs that have no x509 proxy. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1812\" onclick=\"get_ticket_and_populate_wrapper('1812'); return false;\" title=\"shorten lifespan of delegated proxies\">#1812</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-28 13:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25858\">[25858]</a></span>: Improved explanation of tradeoffs in setting SHADOW_CHECKPROXY_INTERVAL. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1812\" onclick=\"get_ticket_and_populate_wrapper('1812'); return false;\" title=\"shorten lifespan of delegated proxies\">#1812</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-28 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25857\">[25857]</a></span>: More documentation of limited proxy lifetime configuration. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1812\" onclick=\"get_ticket_and_populate_wrapper('1812'); return false;\" title=\"shorten lifespan of delegated proxies\">#1812</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-28 13:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=20167\">[20167]</a></span>: Improvemets to limited lifetime proxy delegation. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1812\" onclick=\"get_ticket_and_populate_wrapper('1812'); return false;\" title=\"shorten lifespan of delegated proxies\">#1812</a></span> The job ad attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DelegatedProxyExpiration\" title=\"Delegated Proxy Expiration\">DelegatedProxyExpiration</a></span> now reflects reality in cases where the requested lifetime is greater than allowed by the proxy.\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-27 15:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25855\">[25855]</a></span>: Documented limited lifetime proxy delegation. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1812\" onclick=\"get_ticket_and_populate_wrapper('1812'); return false;\" title=\"shorten lifespan of delegated proxies\">#1812</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-27 15:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=20153\">[20153]</a></span>: Added support for shortening lifespan of delegated proxies. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1812\" onclick=\"get_ticket_and_populate_wrapper('1812'); return false;\" title=\"shorten lifespan of delegated proxies\">#1812</a></span> Currently, support is only added to Condor-C and non-grid jobs. Globus jobs are not supported.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Jan-28 15:35", "status": "resolved", "created": "2010-Dec-16 09:37", "fixed_version": "2010-Dec-16 09:37", "broken_version": "v070500", "priority": "4", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu,sfiligoi@fnal.gov", "due_date": ""}