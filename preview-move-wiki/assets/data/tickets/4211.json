{"id": 4211, "title": "Ticket #4211: Add #ifdef-like mechanism to config file parser", "description": "<blockquote>\nWe would like to be able improve the config file syntax, and add new features with clean and clear syntax.  But we are also reluctant to make changes that make it impossible for lder versions of HTCondor to parse the config files.\n\n<p>If there was a way to mark sections of the config file to be ignored by older versions of HTCondor, then it would be much safer and easier for users to opt-in to new features without having to worry about preventing older daemons or tools from starting.\n\n</p><p>To support this the 8.1.x series (and thus the 8.2.x series) should have the ability to parse something like the C++ #ifdef/#endif to mark off sections of the config file.\n\n</p><p>The config file will be able to parse\n\n</p><p></p><pre>    if &lt;condition1&gt;\n       &lt;config_statements_1&gt;\n    elif &lt;condition2&gt;\n       &lt;config_statements_2&gt;\n    else\n       &lt;config_statements_3&gt;\n    endif\n</pre>\n\n<p>where condition can be\n\n</p><p></p><ul>\n<li>a Boolean value (e.g. <code>0,1,yes,no,true,false</code>). Boolean, Integer and floating point values are allowed. 0 is treated as false, all other numeric values are true. Question: should crufty booleans (t,T,f,F) be allowed?\n\n<p></p></li><li><code>version &lt;compare_operator&gt; &lt;version_string&gt;</code> (e.g. <code>version &gt; [v]8.1</code>). Version literal values must be 2 or 3 integers separated by . and optionally proceeded by v.  The v prefix is to allow for version comparisons to migrate into classads at some point in the future. For the same reason, the keyword version is case-insensitive. Note: HTCondor currently doesn't permit version numbers starting with values &lt; 6.\n\n<p></p></li><li><code>defined &lt;param_name&gt;</code> (e.g. <code>defined SLOT_TYPE_1</code>). Evaluates to true if <code>&lt;param_name&gt;</code> is defined and not empty.  We treat empty as undefined because it isn't possible to undefine built-in params, but they can be overridden with empty values, and because the result of expanding <code>$(param_name)</code> is the same in both cases.\n</li></ul>\n\n<p>In the example above, the config system will parse and insert statements in <code>&lt;config_statements_1&gt;</code> if <code>&lt;condition1&gt;</code> is true, and will ignore (and not parse!) those in <code>&lt;config_statements_2&gt;</code> and <code>&lt;config_statements_3&gt;</code>.  Not parsing is a key requirement, as it allows new syntax to be used inside blocks where <code>&lt;condition&gt;</code> evaluates to false:\n\n</p><p></p><pre>    if version &gt;= 8.3\n       ...config statements not valid to 8.2.x config parser....\n    else\n       ...config statements that 8.2.x can parse...\n    endif\n</pre>\n\n<p>The <code>if/elif/else/endif</code> capability will also be useful when defining meta knobs whose behavior is influenced by user-defined knobs.\n\n</p><p>The <code>&lt;condition&gt;</code> of an if/elif will will first be macro-expanded. Then <code>version</code> and <code>defined</code> expressions will be evaluated and replaced with 0 or 1, and then the final result evaluated for truth. (in theory - the initial implementation will not actually have 3 passes).\n\n</p><p>The initial version of this feature will not support complex conditional expressions, but it is important to get <code>if &lt;bool&gt;</code>, <code>if version</code>, and <code>if defined</code> into the 8.2 series to enable future improvements without breaking compatibility.\n\n</p><p>Some examples:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">if 1\n iftest=one\nelse\n if 0\n  iftest=two\n else\n  iftest=three\n endif\nendif\n# expected result is iftest=three\n\nif defined iftestb\n iftestbd=iftestb defined\nelif defined $(iftest)\n iftestbd=iftest defined\nelif ! defined $(iftestb)\n iftestbd=iftestb not defined\nelse\n iftestbd=four\nendif\n# expected result is iftestbd=four\n\n# test version\niftver_test=8.0.6\nif version &gt;= $(iftver_test)\n  iftestver= version &gt;= $(iftver_test)\nelse\n  iftestver= version &lt; $(iftver_test)\nendif\n# expected result is iftestver=version &lt; 8.0.6\n\n# test version equality\nif version == 8.1.4\n  iftestveris= is 8.1.4\nelse\n  iftestveris=is not 8.1.4\nendif\n# expected result is iftestveris=is not 8.1.4\n\n# test version fuzzy equality\nif version == 8.1\n  iftestveris= is 8.1\nelse\n  iftestveris=is not 8.1\nendif\n# expected result is iftestveris=is 8.1\n\n# test undef==false for references\nif ! $(TESTING_UNDEF)\n   UNDEF_VALUE = 1\nendif\n# expected result is UNDEV_VALUE=1\n\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Feb-13 09:10:06 by bbockelm:</em> <br/>\n\nHi TJ,\n\n<p>Why not have something compatible with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> expressions?  I have a hard time believing that HTCondor needs Yet Another expression language!!!\n\n</p><p>The only tweak needed to the proposal is to remove \"defined\" as a keyword and make it into a function (or simply 'foo isnt null').\n\n</p><p>I think this is very, very important!\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Feb-13 09:57:54 by johnkn:</em> <br/>\n\nActually, I would have loved to use the classad expression parser/evaluator.  But unfortunately, the params aren't in a classad. so their values would be unavailable to the expression parser unless we did param macro substitution before evaluation. That is, you can't do this\n\n<p></p><pre>    if RELEASE_DIR isnt undefined\n</pre>\n\n<p>Because RELEASE_DIR is not a classad attribute, and you can't do this either\n\n</p><p></p><pre>    if $(RELEASE_DIR) isnt undefined\n</pre>\n\n<p>Because this translates into either\n\n</p><p></p><pre>    if c:\\condor isnt undefined\n</pre>\n\n<p>or\n\n</p><p></p><pre>    if  isnt undefined\n</pre>\n\n<p></p><hr/>\n<em>2014-Feb-14 15:07:42 by eje:</em> <br/>\n\nIt would be good to commit any unit testing (and/or other kinds of testing) code.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-29 14:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0c449cdb47c1a521c575873be8f70841d00a289d\">[40270]</a></span>: Correct info about if/else syntax in configuration files. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4211\" onclick=\"get_ticket_and_populate_wrapper('4211'); return false;\" title=\"Add #ifdef-like mechanism to config file parser\">#4211</a></span> This correction is in the 8.2.0 manual, although the original ticket is for 8.1.6.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-21 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3d6787abccedf858c94f772f9323b5ecffc57e49\">[40203]</a></span>: extended 8.1.6 version history item to identify all the new configuration file changes <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3820\" onclick=\"get_ticket_and_populate_wrapper('3820'); return false;\" title=\"Param system improvements for v8.1 series\">#3820</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4325\" onclick=\"get_ticket_and_populate_wrapper('4325'); return false;\" title=\"Strip default condor_config file down to the bare essentials.\">#4325</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3894\" onclick=\"get_ticket_and_populate_wrapper('3894'); return false;\" title=\"condor_config_val -dump should work remotely\">#3894</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4319\" onclick=\"get_ticket_and_populate_wrapper('4319'); return false;\" title=\"add #include like mechanism to config file parser\">#4319</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4031\" onclick=\"get_ticket_and_populate_wrapper('4031'); return false;\" title=\"Add simple meta-params to enable complex features with default\">#4031</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4211\" onclick=\"get_ticket_and_populate_wrapper('4211'); return false;\" title=\"Add #ifdef-like mechanism to config file parser\">#4211</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-21 14:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/221240ca64aa29d75980739636ff81cf87679f65\">[40201]</a></span>: doc for if/else config syntax <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4211\" onclick=\"get_ticket_and_populate_wrapper('4211'); return false;\" title=\"Add #ifdef-like mechanism to config file parser\">#4211</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3820\" onclick=\"get_ticket_and_populate_wrapper('3820'); return false;\" title=\"Param system improvements for v8.1 series\">#3820</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-May-19 14:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/639433cebc68ff194ca3bb7db5840ef4914abce7\">[40176]</a></span>: add placeholder section for where documentation about new if/else configuration file syntax will go <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3820\" onclick=\"get_ticket_and_populate_wrapper('3820'); return false;\" title=\"Param system improvements for v8.1 series\">#3820</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4031\" onclick=\"get_ticket_and_populate_wrapper('4031'); return false;\" title=\"Add simple meta-params to enable complex features with default\">#4031</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4211\" onclick=\"get_ticket_and_populate_wrapper('4211'); return false;\" title=\"Add #ifdef-like mechanism to config file parser\">#4211</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-17 09:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/73c3a1b0bf12509b9d3c5a2f241ef1746ef4cdb9\">[39424]</a></span>: update config if to conform to revised requirements <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4211\" onclick=\"get_ticket_and_populate_wrapper('4211'); return false;\" title=\"Add #ifdef-like mechanism to config file parser\">#4211</a></span>. Fix coverity-found memory leak. Add test for corrrect/incorrect conditionals ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-12 17:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fcb5b3341cf7accb8d17b0771c5430983f29bc8\">[39406]</a></span>: add basic if/elif/else/endif to config file parsing <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4211\" onclick=\"get_ticket_and_populate_wrapper('4211'); return false;\" title=\"Add #ifdef-like mechanism to config file parser\">#4211</a></span> this commit supports if conditions that are boolean, version comparisons or whether a param is/isn't defined ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Aug-01 21:25", "status": "resolved", "created": "2014-Feb-12 17:14", "fixed_version": "2014-Feb-12 17:14", "broken_version": "v080100", "priority": "2", "subsystem": "Libs", "assigned_to": "johnkn", "derived_from": "#3820", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu", "due_date": ""}