{"id": 5568, "title": "Ticket #5568: Enable policy to limit active DAGs per user", "description": "<blockquote>\nIn order to fairly share the SCHEDULER universe slots on the SCHEDD, the CMS global pool would like to have a way to limit the number of active <code>Scheduler</code> universe jobs a given user can have.\n\n<p>There are a variety of ways this could be implemented. Each having significant tradeoffs in ease of development, flexibility, and runtime cost.\n\n</p><p>The options are\n\n</p><p></p><ol>\n<li>Make a new knob that explicitly sets a per-user limit of active dags. Something like <code>MAX_RUNNING_SCHEDULER_JOBS_PER_OWNER</code>.   This is both the easiest to implement, and the least costly in terms of SCHEDD runtime, but it the least flexible.\n\n<p></p></li><li>Put counters for the active submitter into the SCHEDD ad when evaluating <code>START_SCHEDULER_UNIVERSE</code> and <code>START_LOCAL_UNIVERSE</code>.  This is the most work, the  mostly costly in runtime (by quite a lot ).   But it is also the most flexible and consistent with the current design.\n\n<p></p></li><li>Add an additional START expression for scheduler and local universe jobs that is evaluated in the context of the submitter ad rather than the schedd ad. Something like <code>START_SCHEDULER_UNIVERSE_BY_OWNER</code>.  This option is relatively easy to do, and about as flexible as option 2).     Unlike option 2) it adds no overhead to the SCHEDD when the knob is not set, but the runtime cost when the knob is set is about equal to option 2.\n</li></ol>\n\n<p>A rather significant wrinkle to this work is that the SCHEDD currently doesn't actually keep job counters by owner.  It keeps them by submitter, where the contents of the job itself can be used to either set the submitter name or to decorate the owner name to produce a new submitter name.\n\n</p><p>For instance, a job that has\n    <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NiceUser\" title=\"Nice User\">NiceUser</a></span> = true\nWill produce a second submitter record for a user and thus give them an entirely new set of counters and limits.  The submit keywords <code>Accounting_Group</code>\nand <code>Accounting_Group_User</code> can also be used to create a new submitter record.\n\n</p><p>Consequently, as a part of this work.  I am proposing that we change the SCHEDD so that the counters for Scheduler and Local universe jobs will always be applied to the submitter whose name is the same as the jobs's <code>Owner</code> attribute. (Thus ignoring <code>NiceUser</code> and <code>Accounting_xxx</code> keywords in the job).</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Mar-22 15:26:02 by johnkn:</em> <br/>\n\nIncidently, the SCHEDD currently creates a new SCHEDD ad for <strong>each</strong> idle scheduler or local universe job every time it goes looking for scheduler or local universe jobs to start.\n\n<p>There is significant room to optimize this code, but at the risk of having attributes of the SCHEDD ad not be refreshed when a scheduler or local universe job is started.  The current code is wasteful, but does guarantee freshness.\n\n</p><p></p><hr/>\n<em>2016-Jun-21 15:09:45 by johnkn:</em> <br/>\n\nWe will be implementing option 1 above for the 8.5.6 release.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jul-20 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d1cfaf7e5e651d2e0421f95d52480536b3eeea94\">[48813]</a></span>: Version history and doc for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5568\" onclick=\"get_ticket_and_populate_wrapper('5568'); return false;\" title=\"Enable policy to limit active DAGs per user\">#5568</a></span>. a limit on the number of running DAGs per user.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jun-21 19:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d2fd9e920d4c412c038005921e8a7ccf0af4d7c1\">[48610]</a></span>: new config knob. MAX_RUNNING_SCHEDULER_JOBS_PER_OWNER to set a limit on running DAGs per owner. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5568\" onclick=\"get_ticket_and_populate_wrapper('5568'); return false;\" title=\"Enable policy to limit active DAGs per user\">#5568</a></span> this commit also adds a from the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobQueueJob\" title=\"Job Queue Job\">JobQueueJob</a></span> to it's associated <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OwnerData\" title=\"Owner Data\">OwnerData</a></span> structure. the pointer is kept valid by count_jobs. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2016-Jul-20 14:39", "status": "resolved", "created": "2016-Mar-22 11:26", "fixed_version": "2016-Mar-22 11:26", "broken_version": "", "priority": "4", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "#4490", "creator": "johnkn", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}