{"id": 5972, "title": "Ticket #5972: Starter crash during exit()", "description": "<blockquote>\nA post to the htcondor-users list reports a seg-faulting starter. The problem appears to be due to an attempt to send a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> over a socket inside a global destructor, after the global destructors for some internal <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> data structures have already been called.\n\n<p>I can reproduce the crash on linux by having the shadow EXCEPT() immediately after creating its child process for moving the input sandbox. The crash doesn't happen consistently, as there's a race between the starter reaping its child process (and calling EXCEPT() due to the failed transfer) and the starter receiving a SIGTERM from the startd.\n\n</p><p>Here is the sequence of events in the starter:\n</p><ul>\n<li>File transfer of the input sandbox is started (child process created)\n</li><li>Network connections to the shadow are closed on the remote side\n</li><li>SIGTERM received, starter begins a graceful shutdown\n</li><li>With no jobs running, starter calls DC_Exit(), which deletes <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> and then calls exit()\n</li><li>Destructor for classad::specialAttrNames is called\n</li><li>Destructor for CStarter object is called, which causes the following events\n<ul>\n<li>Destructor for JICShadow is called\n</li><li>Destructor for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> is called, which tries to cancel the active transfer\n</li><li>FileTransfer::abortActiveTransfer() ASSERT()s because daemonCore is NULL\n</li><li>The starter's custom exception cleanup function tries to write a log entry and send a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> message to the shadow\n</li><li>Sending the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> message seg-faults because it tries to evaluate <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TargetType\" title=\"Target Type\">TargetType</a></span>, which accesses classad::specialAttrNames, which is already deleted.\n</li></ul>\n</li></ul>\n\n<p>A simple fix for this problem would be for the starter to disable its custom exception cleanup routine (set _EXCEPT_Cleanup to NULL) before calling DC_Exit(). A better fix would be do most of the tear-down of CStarter and its member objects before calling DC_Exit(), probably by making the CStarter object not be a global object, but one that's deleted before DC_Exit().</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Oct-18 16:16:33 by jfrey:</em> <br/>\n\nSetting _EXCEPT_Cleanup to NULL in CStarter::StarterExit() does prevent this crash. But we're still blundering through a minefield of potential crashes. The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransfer\" title=\"File Transfer\">FileTransfer</a></span> destructor called under exit() still causes an EXCEPT() due to daemonCore being NULL. There are surely other pitfalls waiting for us.\n\n<p></p><hr/>\n<em>2016-Oct-18 16:39:24 by jfrey:</em> <br/>\n\nThe original post to htcondor-users was made on October 17, 2016, by Antontio Dorta &lt;adorta@iac.es&gt; with the subject line <code>condor_starter... kernel: NMI watchdog: BUG: soft lockup - CPU stuck for...</code>.\n\n<p></p><hr/>\n<em>2016-Oct-21 10:09:11 by jfrey:</em> <br/>\n\nI initially committed this fix to the master branch, when I had intended it to go into the 8.4 stable series. I then cherry-picked it to V8_4-branch.\n\n<p></p><hr/>\n<em>2016-Nov-23 11:09:21 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> - looks good to me.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/970/starter_log.txt\">starter_log.txt</a>\n6634 bytes added by jfrey on 2016-Oct-18 21:04:37 UTC.\n<br/>\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StarterLog\" title=\"Starter Log\">StarterLog</a></span> from user showing crash.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-23 09:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1260b3a9e58ef2cf50b6a241385dcd119d6b180c\">[49629]</a></span>: Docs for fix of starter crash during file transfer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5972\" onclick=\"get_ticket_and_populate_wrapper('5972'); return false;\" title=\"Starter crash during exit()\">#5972</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-21 10:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bf4779651c7697da5c58034cd60a1662644f50d3\">[49462]</a></span>: Fix starter crash in EXCEPT() handler inside exit(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5972\" onclick=\"get_ticket_and_populate_wrapper('5972'); return false;\" title=\"Starter crash during exit()\">#5972</a></span> Unset the starter's custom EXCEPT() handler, which tries to write a log entry and communicate with the shadow. Once global destructors are being invoked inside exit(), some of the data structures necessary for these actions may already be deleted,\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-21 09:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7dc806715b900b37924fdebd40c4579e9dcfad1d\">[49461]</a></span>: Fix starter crash in EXCEPT() handler inside exit(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5972\" onclick=\"get_ticket_and_populate_wrapper('5972'); return false;\" title=\"Starter crash during exit()\">#5972</a></span> Unset the starter's custom EXCEPT() handler, which tries to write a log entry and communicate with the shadow. Once global destructors are being invoked inside exit(), some of the data structures necessary for these actions may already be deleted,\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Nov-23 11:09", "status": "resolved", "created": "2016-Oct-18 16:03", "fixed_version": "2016-Oct-18 16:03", "broken_version": "v080409", "priority": "4", "subsystem": "DaemonsExecNode", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "users", "visibility": "public", "notify": "", "due_date": ""}