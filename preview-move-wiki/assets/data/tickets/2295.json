{"id": 2295, "title": "Ticket #2295: default job stack size bloats vsize", "description": "<blockquote>\nCheckin <span class=\"chng\"><a href=\"chngview?cn=20867\">[20867]</a></span> sets the stack size rlimit for jobs to 500MB.  When CHTC was upgraded to a pre-release of 7.7.0, CMS jobs failed on CHTC because their vsize was 10 times bigger than it used to be.  These jobs set their own vsize rlimit to a reasonable upper bound to avoid bugs causing problems.  Apparently, they do not set their own stack limit to a reasonable value.  It seems that they just use the max provided by the system.\n\n<p>The workaround is to have the jobs specify a smaller stack size at submit time.  However, it is a little worrisome that for this application, running the job by hand causes it to use 10x less virtual memory than when it runs under Condor using default settings.  It took me a while to consider the possibility that running a job under Condor could significantly impact the amount of memory it allocates.\n\n</p><p>What should we do?  Some ideas:\n\n</p><p></p><ul>\n<li>use a lower default, like 10MB\n\n<p></p></li><li>do not apply a limit by default; only apply a limit when one is set by the user\n\n<p></p></li><li>hope that most applications do not behave like the CMS application</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Jul-12 16:45:12 by danb:</em> <br/>\n\nA simple test seems to show that pthreads uses a default stack size equal to the stack size rlimit.  If the rlimit is unlimited, then pthreads uses a default of 2MB.\n\n<p></p><hr/>\n<em>2011-Jul-13 14:32:46 by nwp:</em> <br/>\n\nThe patch below uses the second option indicated above</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-18 11:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26145\">[26145]</a></span>: edit version history item about new submit cmd stack_size, as well as man page description, given change in default value ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1871\" onclick=\"get_ticket_and_populate_wrapper('1871'); return false;\" title=\"Try to limit stack size on Linux\">#1871</a></span> ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2295\" onclick=\"get_ticket_and_populate_wrapper('2295'); return false;\" title=\"default job stack size bloats vsize\">#2295</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-13 15:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22451\">[22451]</a></span>: Fix problem indicated in review ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2295\" onclick=\"get_ticket_and_populate_wrapper('2295'); return false;\" title=\"default job stack size bloats vsize\">#2295</a></span> The comparison means nothing, and would have had 512 MB by default.  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-13 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26144\">[26144]</a></span>: Stack size is unlimited, not 512 MB This is because of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2295\" onclick=\"get_ticket_and_populate_wrapper('2295'); return false;\" title=\"default job stack size bloats vsize\">#2295</a></span>  (By Nathan W. Panike )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jul-13 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=22447\">[22447]</a></span>: Setting default rlimit size of stack causes problems in CMS ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2295\" onclick=\"get_ticket_and_populate_wrapper('2295'); return false;\" title=\"default job stack size bloats vsize\">#2295</a></span> Set resource limit to RLIM_INFINITY, unless explicitly asked by the user. This basically restores the behavior prior to e4cce69, in that users will not notice a difference, unless they explicitly ask to set the stack size. See\u00a0[...]\n (By Nathan W. Panike )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-04 14:59", "status": "resolved", "created": "2011-Jul-12 16:12", "fixed_version": "2011-Jul-12 16:12", "broken_version": "v070700", "priority": "3", "subsystem": "", "assigned_to": "nwp", "derived_from": "#1871", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu", "due_date": ""}