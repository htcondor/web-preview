{"id": 1490, "title": "Ticket #1490: condor_hold + condor_rm of DAG goofs things up", "description": "<blockquote>\nIf a DAG is held, and then removed without being released, none of the normal \"condor_rm of DAG\" cleanup takes place.\n\n<p>I think fixing this would take changes to the schedd, because it would have to do something special in terms of releasing the DAGMan job before removing it...</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Jul-07 16:33:49 by matt:</em> <br/>\n\nStopping submission of jobs while letting existing jobs complete is a useful feature - one you can implement by holding a dag.\n\n<p></p><hr/>\n<em>2010-Jul-07 16:37:08 by wenger:</em> <br/>\n\nYes, condor_hold as it now exists is useful.  But if the user does condor_hold and then condor_rm without a condor_release in between, the DAG job gets taken out of the queue, but the node jobs continue running, which is probably not the behavior we want.\n\n<p></p><hr/>\n<em>2010-Jul-07 16:39:17 by matt:</em> <br/>\n\nI don't disagree, but it would be sad if the solution was to make dagman rm its children on a hold.\n\n<p></p><hr/>\n<em>2010-Jul-07 16:45:06 by wenger:</em> <br/>\n\nAh, no, my idea is not that the behavior on condor_hold would change; it's something like when the schedd sees the condor_rm, if the job is on hold and it's a DAGMan, the schedd does a condor_release before the condor_rm.  (Or something like that -- it actually would be better if we didn't do a normal condor_release to DAGMan, because that will send it into recovery mode -- maybe we can have some special mode where DAGMan just removes its child jobs before exiting.)  I don't know enough about the schedd to know exactly what the best way is to do this, but I agree that condor_hold on the DAGMan should leave the node jobs alone, as it does now.\n\n<p></p><hr/>\n<em>2011-Jan-15 15:19:50 by wenger:</em> <br/>\n\nI'm doing some tests on this, and one other issue is that if we remove a DAG that's on hold we leave the lock file hanging around -- I'm not sure whether we want to do that or not...\n\n<p></p><hr/>\n<em>2011-Jan-20 15:03:39 by wenger:</em> <br/>\n\nPete and I just met and came up with a more general way of dealing with this: we'd have a bunch of \"job state transition actions\" (e.g., auto_action_remove, auto_action_hold, auto_action_checkpoint, etc.).  Probably initially we'd just implement auto_action_remove to deal with LIGO's DAG issue.  This would be an expression in a job's submit file that would act on <strong>other</strong> jobs when the first job is removed.  The one for DAGMan would be something like this:\n\n<p></p><pre>  auto_action_remove = target.DAGManJobId == my.ClusterId\n</pre>\n\n<p>eventually this could be extended to something like:\n\n</p><p></p><pre>  auto_action_remove = if (expression) job_hold(constraint)\n</pre>\n\n<p>so that removing one job could do something to other jobs besides removing them.\n\n</p><p>The auto_action_remove should be done when a job is removed via condor_rm (but not condor_rm -f), periodic_remove, on_exit_remove, etc.\n\n</p><p>One important consideration is that the auto_action_remove processing must not start until the originally-removed job is in the X state, so that we don't get into cycles if job A's auto_action_remove removes job B, and job B's auto_action_remove removes job A.\n</p><hr/>\n<em>2011-Feb-01 16:08:44 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2011-Feb-02 11:26:46 by wenger:</em> <br/>\n\nI just tested the fix for this with a remove of all running jobs, and a remove by the periodic remove expression.  Removing all jobs worked fine, but periodic_remove didn't -- we must follow a different code path through the schedd in the case of periodic_remove as opposed to a condor_rm from the user.\n\n<p></p><hr/>\n<em>2011-Feb-02 12:45:24 by wenger:</em> <br/>\n\nAh, the current fix doesn't work for nested DAGs, either.  A fix to the fix is on the way...\n\n<p></p><hr/>\n<em>2011-Feb-05 10:24:27 by matt:</em> <br/>\n\nDoes this also fix <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1476\" onclick=\"get_ticket_and_populate_wrapper('1476'); return false;\" title=\"DAGMan leaves node jobs running when held/dag file removed/released\">#1476</a></span>?\n\n<p></p><hr/>\n<em>2011-Feb-05 18:12:16 by wenger:</em> <br/>\n\nRe <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1476\" onclick=\"get_ticket_and_populate_wrapper('1476'); return false;\" title=\"DAGMan leaves node jobs running when held/dag file removed/released\">#1476</a></span>: no, the <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span> fix will not fix that problem, because the DAGMan job isn't actually getting removed, so the new code in the schedd will not be invoked.  I suspect that what's happening in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1476\" onclick=\"get_ticket_and_populate_wrapper('1476'); return false;\" title=\"DAGMan leaves node jobs running when held/dag file removed/released\">#1476</a></span> is that DAGMan is just exiting when it tries to parse the non-existant DAG file.\n\n<p></p><hr/>\n<em>2011-Feb-05 18:28:26 by matt:</em> <br/>\n\nWhat's from keeping this new expression from being evaluated when the job leaves the queue, instead of just being removed and leaving the queue?\n\n<p></p><hr/>\n<em>2011-Feb-05 19:20:54 by wenger:</em> <br/>\n\nAh, yeah, I guess we could set things up so that the DAGMan job doesn't have to be explicitly removed for the \"remove other jobs\" expression to fire.  I'll take a look at that.\n\n<p></p><hr/>\n<em>2011-Feb-08 16:09:11 by psilord:</em> <br/>\n\nI will review the work for this ticket with Kent at 2pm Feb 9th, 2011.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=1880\" onclick=\"get_ticket_and_populate_wrapper('1880'); return false;\" title=\"More flexible actions as the result of job state changes\">#1880</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMore flexible actions as the result of job state changes</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=1910\" onclick=\"get_ticket_and_populate_wrapper('1910'); return false;\" title=\"Error case in the fix for #1490\">#1910</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nError case in the fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span></td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Feb-09 17:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fb8f40c6f6bbe5bc9883e38b0f98b140ab7fd776\">[20363]</a></span>: Changed gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span> fix: minor changes as a direct result of code review with psilord. Also fixed an unrelated typo and unused variable warning.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Feb-03 13:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6305e460ae5942ce89ed0becb10a9ccfdb45094\">[20259]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span>: fixed the implementation of this so that it works with periodic_remove and nested DAGs.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-27 15:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b109f82424fd123ff546a9fe9363fd5648b18fb0\">[20151]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span>: changed the classad attribute name from <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ChildRemoveConstraint\" title=\"Child Remove Constraint\">ChildRemoveConstraint</a></span> to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OtherJobRemoveRequirements\" title=\"Other Job Remove Requirements\">OtherJobRemoveRequirements</a></span> as per request from psilord.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-27 12:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ef6ac440f663a7eed7d657b169e08b7239a7d87f\">[25854]</a></span>: Fixed gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=741\" onclick=\"get_ticket_and_populate_wrapper('741'); return false;\" title=\"Code Cleanup: WIN32 DAGMan hack in schedd.cpp\">#741</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span> -- DAG child job removal code in the schedd now works for all platforms, but only when removing a job, not holding it, etc.; it looks for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ChildRemoveConstraint\" title=\"Child Remove Constraint\">ChildRemoveConstraint</a></span> in the removed job's classad, and removes jobs matching that constraint.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-27 12:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9f20f6a431f21dd39b6791cc97c5339608d750e6\">[20148]</a></span>: Fixed gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=741\" onclick=\"get_ticket_and_populate_wrapper('741'); return false;\" title=\"Code Cleanup: WIN32 DAGMan hack in schedd.cpp\">#741</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1490\" onclick=\"get_ticket_and_populate_wrapper('1490'); return false;\" title=\"condor_hold + condor_rm of DAG goofs things up\">#1490</a></span> -- DAG child job removal code in the schedd now works for all platforms, but only when removing a job, not holding it, etc.; it looks for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ChildRemoveConstraint\" title=\"Child Remove Constraint\">ChildRemoveConstraint</a></span> in the removed job's classad, and removes jobs matching that constraint.  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jun-08 13:31", "status": "resolved", "created": "2010-Jul-07 16:13", "fixed_version": "2010-Jul-07 16:13", "broken_version": "v070503", "priority": "1", "subsystem": "Dag", "assigned_to": "psilord", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "users", "visibility": "public", "notify": "wenger@cs.wisc.edu, psilord@cs.wisc.edu, matt@cs.wisc.edu, tannenba@cs.wisc.edu, tstclair@redhat.com", "due_date": "20110209"}