{"id": 3694, "title": "Ticket #3694: short hostname no longer usable in condor_status", "description": "<blockquote>\n<div class=\"verbatim\">\n<pre>condor_status now requires use of FQHN.\n\n[jrthomas@small BUILD]$ condor_status small\n[jrthomas@small BUILD]$ condor_status small.mydom.com\n\nName               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime\n\nslot1@small.mydom. LINUX      X86_64 Unclaimed Idle     0.000  3828  0+02:44:44\n                     Machines Owner Claimed Unclaimed Matched Preempting\n\n        X86_64/LINUX        1     0       0         1       0          0\n\n               Total        1     0       0         1       0          0\n\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Jun-12 07:50:53 by jrt:</em> <br/>\n\nEarliest version I see this in is 7.8.6, but I also see it in 7.9.1. The change in behavior came out of the switch to ipv6 code.\n\n<p></p><hr/>\n<em>2013-Jun-27 12:31:24 by tannenba:</em> <br/>\n\nDoing <code>condor_status chevre</code> results in the following query going to the collector (note the blank Name and Machine constraints):\n<div class=\"code\">\n<pre class=\"code\">Projection = \"Name Machine Opsys Arch State Activity LoadAvg Memory ActvtyTime MyCurrentTime EnteredCurrentActivity\"\nMyType = \"Query\"\nTargetType = \"Machine\"\nCurrentTime = time()\nRequirements = ( ( ( Name == \"\" ) || ( Machine == \"\" ) ) )\n</pre></div>\n\n\n<p>But try it with <code>condor_status chevre.foo.edu</code>, that is the name is fully-qualified (i.e. it has a period character in it), then a proper query is sent:\n</p><div class=\"code\">\n<pre class=\"code\">Projection = \"Name Machine Opsys Arch State Activity LoadAvg Memory ActvtyTime MyCurrentTime EnteredCurrentActivity\"\nMyType = \"Query\"\nTargetType = \"Machine\"\nCurrentTime = time()\nRequirements = ( ( ( Name == \"chevre.foo.edu\" ) || ( Machine == \"chevre.foo.edu\" ) )\n</pre></div>\n\n\n<p>To make an active connection, the only directory service consulted should be the collector.  Kinda looks like the daemon locate method is using DNS to try and convert a short name into a fully-qualified name before sending a query to the collector - I would love to see this crazy behavior from the dawn of Condor go away.\n\n</p><p>The behavior in HTCondor of the daemon locate method making any calls at all into DNS is, imo, broken design. Instead of leaning on DNS to go from short to fqhn (full qualified host name), why not just send a query to the collector that is appropriate if given a short name?  I.e. a query that uses regular expressions to strip out the short name from <code>Name</code> and <code>Machine</code> if the locate method is only given a short name.\n\n</p><p>I realize the above may be more appropriate for the dev series, and we still need something in the stable series... but I would hate to see DNS used even in v8.0.x....  Thoughts?\n\n</p><p></p><hr/>\n<em>2013-Aug-01 08:07:27 by jrt:</em> <br/>\n\nWe also saw the same behavior with condor_config_val. Further investigation and the original problem is looking like a bug in glibc in RHEL6 using AF_INET.\n\n<p></p><pre>  $python\n  &gt;&gt;&gt; from socket import *\n  &gt;&gt;&gt; getaddrinfo(\"small\", \"80\", AF_INET, 0, 0, AI_CANONNAME)\n  &gt;&gt;&gt; getaddrinfo(\"small\", \"80\", AF_UNSPEC, 0, 0, AI_CANONNAME)\n</pre>\n\n<p>both of the above should return the FQDN.\n\n</p><p></p><hr/>\n<em>2013-Aug-09 18:58:43 by eje:</em> <br/>\n\nRegarding Todd's comments above, I'm personally agnostic about whether expansion is best driven by DNS or from a collector query.\n\n<p>Regarding timing, now our stable series <strong>is</strong> 8.0 -- It would serve my purposes best to get this in as-is for 8.0 series, however it seems reasonable to spawn a ticket for 8.1 for migrating to a collector-based name resolution if there is sufficient interest.\n\n</p><p></p><hr/>\n<em>2013-Aug-12 14:58:42 by eje:</em> <br/>\n\ntopic branch for review: V8_0-gt3694-short-hostnames\n\n<p>TEST:\n\n</p><p>Spin up a pool.  execute condor_status to check behavior:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\"># short hostname\n$ _CONDOR_TOOL_DEBUG=D_HOSTNAME condor_status -debug localhost 2&gt;&amp;1 | grep -e 'Requirements =' -e 'Returning daemon name'\n08/12/13 12:57:09 Returning daemon name: \"localhost.localdomain\"\nRequirements = ( ( ( Name == \"localhost.localdomain\" ) || ( Machine == \"localhost.localdomain\" ) ) )\n\n# long hostname\n$ _CONDOR_TOOL_DEBUG=D_HOSTNAME condor_status -debug localhost.localdomain 2&gt;&amp;1 | grep -e 'Requirements =' -e 'Returning daemon name'\n08/12/13 12:57:24 Returning daemon name: \"localhost.localdomain\"\nRequirements = ( ( ( Name == \"localhost.localdomain\" ) || ( Machine == \"localhost.localdomain\" ) ) )\n\n# no hostname\n$ _CONDOR_TOOL_DEBUG=D_HOSTNAME condor_status -debug  2&gt;&amp;1 | grep -e 'Requirements =' -e 'Returning daemon name'\nRequirements = true\n</pre></div>\n\n\n<p></p><hr/>\n<em>2013-Aug-12 16:25:51 by johnkn:</em> <br/>\n\nI'm not really qualified to review this patch. It appears to me to have the potential for for LOTS of side effects, and I'm quite certain it won't solve the problem for our RUST user.\n\n<p>I'd like to see it actually <strong>work</strong> over some period of time in the developer series before we inflict it on stable.\n\n</p><p>In any case, Alan De Smet needs to be one to review it.\n\n</p><p></p><hr/>\n<em>2013-Aug-12 17:24:02 by adesmet:</em> <br/>\n\nChanging the query to eliminate DNS is the \"right\" answer.  However, that may constitute new behavior and thus be better suited for 8.1.\n\n<p>If we don't want the \"right\" answer in 8.0, this approach seems broadly reasonable... but, it may not fix the case TJ mentions (that will require a proper code review).  And it needs a review.\n\n</p><p>I can review, but it's not happening until the week of the 19th <em>at the earliest</em>, and it may be later as I have a backlog of priority interrupts.\n\n</p><p></p><hr/>\n<em>2013-Aug-22 16:02:39 by jfrey:</em> <br/>\n\nThis patch restores the functionality of the old get_full_hostname() and get_full_hostname_from_hostent() (before Min's ipv6 code went in). We should be checking h_name before h_aliases in the hostent struct.\n\n<p>get_fqdn_and_ip_from_hostname() and get_hostname_with_alias() are similarly broken.\n\n</p><p></p><hr/>\n<em>2013-Aug-22 16:22:59 by jfrey:</em> <br/>\n\nOn closer inspection, it appears get_hostname_with_alias() is ok as-is. The list it builds should already contain the canonical hostname, obtained from get_hostname().\n\n<p></p><hr/>\n<em>2013-Sep-12 15:46:47 by adesmet:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Approved\nhostnamev4.patch is approved with no changes.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/753/hostnamev3.patch\">hostnamev3.patch</a>\n617 bytes added by jrt on 2013-Jun-12 12:48:27 UTC.\n<br/>\nIn some cases, getaddrinfo doesn't get the FQDN in the result addrinfo. Calling it with a short hostname can in some cases return only the short hostname. In these cases, it appears that gethostbyname and subsequent alias check will fail too because there is no FQDN alias. So, get_fqdn_from_hostname will fail on a known hostname. However, it appears that in these cases, the hostent from the gethostbyname call will have the FQDN in it's h_name.\n\n<p>Unsure of exact case where this happens. I see it with dnsmasq as dns server.<br/>\n</p></li><li><a href=\"../files/796/hostnamev4.patch\">hostnamev4.patch</a>\n956 bytes added by jfrey on 2013-Aug-22 22:09:12 UTC.\n<br/>\nUpdated patch for hostname resolution.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-19 10:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d9f96a70078cabcd55892c234ed52b5b8336a567\">[37672]</a></span>: minor 8.0.3 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3694\" onclick=\"get_ticket_and_populate_wrapper('3694'); return false;\" title=\"short hostname no longer usable in condor_status\">#3694</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Sep-12 16:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e6c6c1f86c6d5825480019e720e5e3911bfe33c3\">[37586]</a></span>: Allow short hostnames to identify daemons in collector queries. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3694\" onclick=\"get_ticket_and_populate_wrapper('3694'); return false;\" title=\"short hostname no longer usable in condor_status\">#3694</a></span> In many places, primarily in the command line tools, when given a hostname for a daemon name, we try to turn it into a fully-qualified name. The ipv6 code made these conversions fail when using gethostbyname(). When examining the hostent\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Aug-12 14:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f1cff88aa3b685cd5f257b7c99c1b010521a46fa\">[37168]</a></span>: Restore ability to use short hostname in condor_status ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3694\" onclick=\"get_ticket_and_populate_wrapper('3694'); return false;\" title=\"short hostname no longer usable in condor_status\">#3694</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Sep-13 11:16", "status": "resolved", "created": "2013-Jun-12 07:47", "fixed_version": "2013-Jun-12 07:47", "broken_version": "v070806", "priority": "3", "subsystem": "Tools", "assigned_to": "jfrey", "derived_from": "", "creator": "jrt", "rust": "s8315", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu, zmiller@cs.wisc.edu, adesmet@cs.wisc.edu,jfrey@cs.wisc.edu, eje@cs.wisc.edu", "due_date": ""}