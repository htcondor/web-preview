{"id": 6904, "title": "Ticket #6904: USER_JOB_WRAPPER should execute outside singularity container", "description": "<blockquote>\nIf the administrator defines a USER_JOB_WRAPPER, singularity jobs try to run the wrapper inside the container.  The wrapper should be run from outside the container.</blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-07 12:27:35 by bbockelm:</em> <br/>\n\nCan we document why we think this is the correct decision?\n\n<p>(Not saying that it is wrong, but just would like to leave breadcrumbs for future Brian...)\n\n</p><p></p><hr/>\n<em>2019-Feb-07 12:43:13 by gthain:</em> <br/>\n\nThe administrator who deploys the USER_JOB_WRAPPER, may not know at configuration time, what the image the singularity container will use.  As such, the admin can't put the USER_JOB_WRAPPER into the container.  We could mount the wrapper inside the container, but these things are usually scripts, and we don't know that all the dependencies of the script may be available inside the container.\n\n<p>All these problems go away if the wrapper run outside (and actually runs) the container.  The only other reasonable design is to not run USER_JOB_WRAPPERs for singularity jobs, but we have users who use USER_JOB_WRAPPERs for logging and debugging, and that not work well for them.\n\n</p><p></p><hr/>\n<em>2019-Mar-26 16:52:02 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : looks good.\n\n<p></p><hr/>\n<em>2019-Apr-03 15:04:06 by jfrey:</em> <br/>\n\nThis broke USER_JOB_WRAPPER when the executable isn't transferred. The wrapper would be told that the job's executable is condor_exec.exe. I just pushed a fix to disable argv[0] renaming when a wrapper script is configured.\n\n<p></p><hr/>\n<em>2019-Apr-03 15:30:17 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> fix to pass the correct argv0 and argv1 looks good.  but the comment at line 541 is now wrong/misleading. The comment should be fixed or deleted.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-08 19:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1b310cdb41ba112fb9386ab4fd406266dcddc2d3\">[56532]</a></span>: Added version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6904\" onclick=\"get_ticket_and_populate_wrapper('6904'); return false;\" title=\"USER_JOB_WRAPPER should execute outside singularity container\">#6904</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-03 15:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1f1814501425fb01f2214b6a33d69e4a0ecd59c9\">[56501]</a></span>: Clarify a comment related to USER_JOB_WRAPPER. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6904\" onclick=\"get_ticket_and_populate_wrapper('6904'); return false;\" title=\"USER_JOB_WRAPPER should execute outside singularity container\">#6904</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-03 15:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2fab1d1a130ff829173f3b788c1529f942894bd4\">[56500]</a></span>: Fix USER_JOB_WRAPPER when executable isn't transferred. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6904\" onclick=\"get_ticket_and_populate_wrapper('6904'); return false;\" title=\"USER_JOB_WRAPPER should execute outside singularity container\">#6904</a></span> When a USER_JOB_WRAPPER is configured, don't try to rename argv[0] to condor_exec.exe. This causes failures after the recent changes for singularity.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-07 08:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/70cf037e47b505e67677ce14906cbb0c776b7d18\">[56141]</a></span>: Move USER_JOB_WRAPPER to execute outside singularity containers <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6904\" onclick=\"get_ticket_and_populate_wrapper('6904'); return false;\" title=\"USER_JOB_WRAPPER should execute outside singularity container\">#6904</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Apr-08 19:40", "status": "resolved", "created": "2019-Feb-07 08:24", "fixed_version": "2019-Feb-07 08:24", "broken_version": "v080800", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}