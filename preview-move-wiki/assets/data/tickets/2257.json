{"id": 2257, "title": "Ticket #2257: Remove unnecessary UserLog stat (NFS check)", "description": "<blockquote>\nI want to change the code below to be less file intensive...\n\n<p></p><div class=\"verbatim\">\n<pre>// Check that the log file isn't on NFS\nBOOLEAN nfs_is_error = param_boolean(\"LOG_ON_NFS_IS_ERROR\", false);\nBOOLEAN\tnfs = FALSE;\n\nif ( fs_detect_nfs( ulog.Value(), &amp;nfs ) != 0 ) {\n\tfprintf(stderr,\n\t\t\"\\nWARNING: Can't determine whether log file %s is on NFS\\n\",\n\t\tulog.Value() );\n} else if ( nfs ) {\n\tif ( nfs_is_error ) {\n\n\t\tfprintf(stderr,\n\t\t\t\"\\nERROR: Log file %s is on NFS.\\nThis could cause\"\n\t\t\t\" log file corruption. Condor has been configured to\"\n\t\t\t\" prohibit log files on NFS.\\n\",\n\t\t\tulog.Value() );\n\n\t\tDoCleanup(0,0,NULL);\n\t\texit( 1 );\n\t\t}\n}\n</pre></div>\n\n\n<p>The code always does a check for NFS, but only uses the result if LOG_ON_NFS_IS_ERROR = TRUE (default is FALSE). I want to lift the \"if ( nfs_is_error )\" to avoid fs_detect_nfs if the result is not going to be used. The resulting code is...\n\n</p><p></p><div class=\"verbatim\">\n<pre>// Check that the log file isn't on NFS\nBOOLEAN nfs_is_error = param_boolean(\"LOG_ON_NFS_IS_ERROR\", false);\nBOOLEAN\tnfs = FALSE;\n\nif ( nfs_is_error ) {\n\tif ( fs_detect_nfs( ulog.Value(), &amp;nfs ) != 0 ) {\n\t\tfprintf(stderr,\n\t\t\t\"\\nWARNING: Can't determine whether log file %s is on NFS\\n\",\n\t\t\tulog.Value() );\n\t} else if ( nfs ) {\n\n\t\tfprintf(stderr,\n\t\t\t\"\\nERROR: Log file %s is on NFS.\\nThis could cause\"\n\t\t\t\" log file corruption. Condor has been configured to\"\n\t\t\t\" prohibit log files on NFS.\\n\",\n\t\t\tulog.Value() );\n\n\t\tDoCleanup(0,0,NULL);\n\t\texit( 1 );\n\n\t}\n}\n</pre></div>\n\n\n<p>---\n\n</p><p></p><div class=\"verbatim\">\n<pre>diff --git a/src/condor_submit.V6/submit.cpp b/src/condor_submit.V6/submit.cpp\nindex 57488ec..af58db6 100644\n--- a/src/condor_submit.V6/submit.cpp\n+++ b/src/condor_submit.V6/submit.cpp\n@@ -4659,12 +4659,12 @@ SetUserLog()\n                        BOOLEAN nfs_is_error = param_boolean(\"LOG_ON_NFS_IS_ERROR\", false);\n                        BOOLEAN nfs = FALSE;\n\n-                       if ( fs_detect_nfs( ulog.Value(), &amp;nfs ) != 0 ) {\n-                               fprintf(stderr,\n-                                       \"\\nWARNING: Can't determine whether log file %s is on NFS\\n\",\n-                                       ulog.Value() );\n-                       } else if ( nfs ) {\n-                               if ( nfs_is_error ) {\n+                       if ( nfs_is_error ) {\n+                               if ( fs_detect_nfs( ulog.Value(), &amp;nfs ) != 0 ) {\n+                                       fprintf(stderr,\n+                                               \"\\nWARNING: Can't determine whether log file %s is on NFS\\n\",\n+                                               ulog.Value() );\n+                               } else if ( nfs ) {\n\n                                        fprintf(stderr,\n                                                \"\\nERROR: Log file %s is on NFS.\\nThis could cause\"\n</pre></div>\n\n\n<p>---\n\n</p><p>Testable with strace -\n\n</p><p>Success ...\n\n</p><p></p><div class=\"verbatim\">\n<pre>$ echo 'cmd=/bin/sleep\\nargs=1d\\nlog=log\\nqueue 10' | env _CONDOR_SUBMIT_SKIP_FILECHECKS=TRUE strace -e trace=file condor_submit 2&gt;&amp;1 | grep log | wc -l\n0\n</pre></div>\n\n\n<p>Failure ...\n\n</p><p></p><div class=\"verbatim\">\n<pre>$ echo 'cmd=/bin/sleep\\nargs=1d\\nlog=log\\nqueue 10' | env _CONDOR_SUBMIT_SKIP_FILECHECKS=TRUE strace -e trace=file condor_submit 2&gt;&amp;1 | grep log | wc -l\n10\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jun-21 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb6f04f88c031dcafc5062d771ae64769fc461a6\">[22237]</a></span>: Only check if ulog is on NFS if LOG_ON_NFS_IS_ERROR=TRUE, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2257\" onclick=\"get_ticket_and_populate_wrapper('2257'); return false;\" title=\"Remove unnecessary UserLog stat (NFS check)\">#2257</a></span>  (By Matthew Farrellee )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jun-21 11:44", "status": "resolved", "created": "2011-Jun-21 09:09", "fixed_version": "2011-Jun-21 09:09", "broken_version": "v070000", "priority": "3", "subsystem": "Tools", "assigned_to": "matt", "derived_from": "", "creator": "matt", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu", "due_date": ""}