{"id": 1122, "title": "Ticket #1122: Add methods for adding TARGET scope in expressions based on ad type", "description": "<blockquote>\nThe existing methods to add TARGET scoping to expressions in the new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> compatibility layer are aggressive, adding a 'Target.' scope for any attribute reference that doesn't appear in a provided list. This list is usually all attributes currently in the expression's ad. There are places where this won't work very well, because the ad can change after we modify the expression, or the full ad isn't available when we modify the expression.\n\n<p>We can define a new, less-aggressive set of methods that only modify attribute references that appear in a given list. We can then define lists of attributes known to occur in job and machine ads. Anytime a daemon or tool receives an expression from an external source (either a user or a potentially older Condor binary), it can call one of these methods to modify the expression as appropriate.\n\n</p><p>The lists of job and machine attributes can be built from the following:\n</p><ul>\n<li>Attributes known to be added to these ads by Condor\n</li><li>SUBMIT_EXPRS for job attributes\n</li><li>STARTD_ATTRS for machine attributes\n</li><li>STARTD_JOB_EXPRS  for machine attributes\n</li><li>STARTD_SLOT_ATTRS for machine attributes\n</li><li>NEGOTIATOR_MATCH_EXPRS for job attributes\n</li><li>A pair of new config params to allow admins to add additional attributes\n</li></ul>\n\n<p>We will need some form of pattern matching for some of the attribute entries (e.g. slot attrs). StringList's wildcard matching should be sufficient.\n\n</p><p><span class=\"section\"></span></p><h2>Milestones </h2>\n<ul>\n<li>Define function signatures [DONE]\n</li><li>Write expression modification code [DONE]\n</li><li>Write code to create lists of job and machine attributes</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2010-Jan-27 15:40:40 by jfrey:</em> <br/>\n\nWe may also need a list of Schedd attributes referred to by scheduler and local universe jobs.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6576\" onclick=\"get_ticket_and_populate_wrapper('6576'); return false;\" title=\"Remove code that adds/removes TARGET. scoping in ClassAd expressions\">#6576</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRemove code that adds/removes TARGET. scoping in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> expressions</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-May-11 15:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b9edf4cf46700837c109828f6a3f94f509d6e485\">[17967]</a></span>: Comment out code related to AddTargetRefs() in compat <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> layer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> This code is currently unused and likely to be removed in the future. When left in place, it takes up space and causes compat <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> to be instantiated unnecessarily prior to main().  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Mar-19 11:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb638f23afacedbc4979b0b396f9392fff873378\">[17671]</a></span>: Remove <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersionInfo\" title=\"Condor Version Info\">CondorVersionInfo</a></span> from classad compat layer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1278\" onclick=\"get_ticket_and_populate_wrapper('1278'); return false;\" title=\"Create process check for .exe on file not found\">#1278</a></span> Comment out use of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorVersionInfo\" title=\"Condor Version Info\">CondorVersionInfo</a></span> in the new <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> compatibility layer. The code was disabled, but still being compiled. This caused changes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1278\" onclick=\"get_ticket_and_populate_wrapper('1278'); return false;\" title=\"Create process check for .exe on file not found\">#1278</a></span> to pull more files into libcondorapi. Instead, we now have fewer files in libcondorapi.\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-19 11:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4482c81af46011e9c1a1cef5ba854244cf89e570\">[17293]</a></span>: Disable AddTargetRefs() in compat <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> layer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> Now that we're mimicing old <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>' scoping behavior (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1234\" onclick=\"get_ticket_and_populate_wrapper('1234'); return false;\" title=\"Add implicit target scoping to new ClassAds\">#1234</a></span>), we don't need the expression rewriting done by AddTargetRefs(). We'll keep the code around, as it may still be useful once we want to start enforcing new ClassAd's scoping rules.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-16 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/07b46f48021de33a7ce0634f119ac46c0dceeb8e\">[17254]</a></span>: Add some missing entries to job and machine attribute lists. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> Most of these are attributes that the negotiator inserts into the ads during matchmaking.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-03 11:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/412eb7c12c3142246f59b9f8bb2a9cbbcd4dd884\">[17079]</a></span>: Fix libcondorapi build after compat <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> change. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-01 10:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b1a5ff05b8c451d458bf84604f6f2467820a3a94\">[17049]</a></span>: Add version check to AddTargetRefs() in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> compat layer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> Only check full ads for proper TARGET scoping if they come from a daemon/tool that's not using the compatibility layer.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-28 08:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5446e15fdb469f3d41bc15b2e836b12e8c42f0ae\">[17000]</a></span>: Add an option for schedd ads to AddTargetRefs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> Scheduler and local universe jobs can refer to schedd ad attributes in their requirements and rank expressions. Now, we add TARGET scoping appropriately for these jobs.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-27 14:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bd0c62ec574b53c379861f5c2356b350a3ad7e88\">[16997]</a></span>: Remove <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span> from ads used for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AddTargetRefs\" title=\"Add Target Refs\">AddTargetRefs</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span> is added to all <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> automatically. Remove it from the ads containing job and machines attributes for AddTargetRefs(). Otherwise, we add TARGET. to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CurrentTime\" title=\"Current Time\">CurrentTime</a></span> in expressions.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-25 11:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/968b1f56a527cce0a1eba2332562812aee09e52a\">[16965]</a></span>: Fill out list of machine attrs for AddTargetRefs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-24 23:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5ad4d4a25b2b7190c3824fbc27ff7a60fb0bdb51\">[16956]</a></span>: Optimize AddTargetRefs() <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> Use a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> to store attribute names with no wildcards. Looking up an attribute in a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> is much more efficient than in a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-22 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6efa254f6d6ca919d7ca14014f815eda407abfdb\">[16955]</a></span>: Fill out list of job attrs for AddTargetRefs(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-22 13:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7b7b84dd8089aef4f9f06f2eb81064482e720667\">[16954]</a></span>: Start filling in lists of job and machine attributes for AddTargetRefs() <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jan-20 09:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/40759416ac3f7fc31e6f32b9079ac1c4ecc28a06\">[16929]</a></span>: Add less aggressive methods to add TARGET scoping to expressions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1122\" onclick=\"get_ticket_and_populate_wrapper('1122'); return false;\" title=\"Add methods for adding TARGET scope in expressions based on ad type\">#1122</a></span> New method AddTargetRefs() is similar to AddExplicitTargetRefs(), but adds 'Target.' to attribute references only if the attribute appears in the provided <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span>. Also provided are lists of known job and machine attributes. These\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Feb-05 15:42", "status": "resolved", "created": "2010-Jan-19 14:08", "fixed_version": "2010-Jan-19 14:08", "broken_version": "v070500", "priority": "4", "subsystem": "Libs", "assigned_to": "cweiss", "derived_from": "#1112", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": "20100125"}