{"id": 6240, "title": "Ticket #6240: Setting x509 attributes on file transfer corrupts job queue log", "description": "<blockquote>\nIn 8.5.8, we had the schedd start managing the X.509 attributes in the job ad (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5064\" onclick=\"get_ticket_and_populate_wrapper('5064'); return false;\" title=\"Set x509 job attributes from authenticated socket\">#5064</a></span>). Part of this change was setting the attributes based on the job proxy that's received when the job's input sandbox is spooled to the schedd over the network. The code to modify the job ad in the queue is run in a child process of the schedd, which is a big No-No. The changes won't appear in the schedd's in-memory copy of the job queue. Worse, they can corrupt the on-disk job_queue.log file, due to competing writes from the two processes.\n\n<p>Ben Jones at CERN has reported multiple occurrences of this when attempting to upgrade from 8.5.5 to 8.6 or 8.7.\n\n</p><p>It should be easy to move the problematic code into the main schedd process, in the reaper for the child process doing the file transfer.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-May-05 12:18:44 by jfrey:</em> <br/>\n\nTo prevent this in the future, we should poison <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> log write methods in forked child processes.\n\n<p></p><hr/>\n<em>2017-May-08 11:43:56 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong>: change looks good.  I hate the inefficiency of parsing and unparsing, but this is no worse than any other part of the schedd.\n\n<p></p><hr/>\n<em>2017-May-09 11:18:01 by jfrey:</em> <br/>\n\nFor the updateGSICred() case, we now read the proxy file twice. We should fix that.</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-08 11:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50614\">[50614]</a></span>: Docs for job queue log corrupt on proxy file transfer bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6240\" onclick=\"get_ticket_and_populate_wrapper('6240'); return false;\" title=\"Setting x509 attributes on file transfer corrupts job queue log\">#6240</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-May-01 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=50600\">[50600]</a></span>: Setting x509 attributes on file transfer corrupts job queue log <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6240\" onclick=\"get_ticket_and_populate_wrapper('6240'); return false;\" title=\"Setting x509 attributes on file transfer corrupts job queue log\">#6240</a></span> Don't make changes to the job queue log in the schedd's child process handling input file transfer. The changes won't appear in the in-memory copy of the job queue, and can corrupt the on-disk version. The changes are now done in the\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-May-09 11:18", "status": "resolved", "created": "2017-Apr-28 11:16", "fixed_version": "2017-Apr-28 11:16", "broken_version": "v080508", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#5064", "creator": "jfrey", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "", "due_date": ""}