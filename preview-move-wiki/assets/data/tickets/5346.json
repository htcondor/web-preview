{"id": 5346, "title": "Ticket #5346: procd crash followed by startd", "description": "<blockquote>\nIt appears that the procd crashed followed by the startd... not sure what to make of this.\n\n<p></p><pre>  ## syslog\n  Oct 27 02:04:37 execute1005 kernel: [5909917.214601] BUG: unable to handle kernel paging request at ffffe9fad90517bc\n  Oct 27 02:04:37 execute1005 kernel: [5909917.214652] IP: [&lt;ffffffff810f3f51&gt;] __mem_cgroup_insert_exceeded.isra.32+0x71/0x71\n  Oct 27 02:04:37 execute1005 kernel: [5909917.214711] PGD 0\n  Oct 27 02:04:37 execute1005 kernel: [5909917.214734] Oops: 0000 [#1] SMP\n  Oct 27 02:04:37 execute1005 kernel: [5909917.214763] CPU 14\n  Oct 27 02:04:37 execute1005 kernel: [5909917.214769] Modules linked in: btrfs libcrc32c ufs qnx4 hfsplus hfs minix ntfs vfat msdos fat jfs xfs reiserfs ext3 jbd ext2 fuse cpufreq_stats cpufreq_conservative autofs4 cpufreq_userspace cpufreq_powersave nfsd nfs nfs_\nacl auth_rpcgss fscache lockd sunrpc adm1026 hwmon_vid zfs(P) zunicode(P) zavl(P) zcommon(P) znvpair(P) spl(O) zlib_deflate coretemp i2c_i801 snd_pcm snd_page_alloc crc32c_intel ghash_clmulni_intel aesni_intel aes_x86_64 acpi_cpufreq aes_generic mperf snd_timer s\nnd soundcore pcspkr joydev sb_edac edac_core cryptd evdev processor iTCO_wdt iTCO_vendor_support thermal_sys ioatdma container button acpi_pad ext4 crc16 jbd2 mbcache dm_mod usbhid hid sg sd_mod crc_t10dif ahci libahci igb i2c_algo_bit i2c_core isci dca libsas li\nbata ehci_hcd usbcore scsi_transport_sas scsi_mod usb_common [last unloaded: scsi_wait_scan]\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215314]\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215335] Pid: 29201, comm: condor_procd Tainted: P           O 3.2.0-4-amd64 #1 Debian 3.2.68-1+deb7u3 Supermicro X9DRG-HF/X9DRG-HF\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215397] RIP: 0010:[&lt;ffffffff810f3f51&gt;]  [&lt;ffffffff810f3f51&gt;] __mem_cgroup_insert_exceeded.isra.32+0x71/0x71\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215452] RSP: 0018:ffff880597ecdd50  EFLAGS: 00010286\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215479] RAX: ffff88104d7d5400 RBX: ffff88083d83f800 RCX: 000000000000fc2e\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215523] RDX: ffff88087fffa000 RSI: 0000000000000001 RDI: ffffe9fad90517bc\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215568] RBP: ffff88084c6331a0 R08: ffff88084c516000 R09: 0000000000000001\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215613] R10: 0000000000000f79 R11: ffff88084fc74000 R12: ffff88104d468400\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215658] R13: ffffe9fad90517a0 R14: ffff88058ddc0d80 R15: ffff88104d7d5400\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215703] FS:  00007f542fac1b40(0000) GS:ffff88107fcc0000(0000) knlGS:0000000000000000\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215749] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215777] CR2: ffffe9fad90517bc CR3: 000000104d63b000 CR4: 00000000000406e0\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215822] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215867] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215913] Process condor_procd (pid: 29201, threadinfo ffff880597ecc000, task ffff88083dce1840)\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215963] Stack:\n  Oct 27 02:04:37 execute1005 kernel: [5909917.215984]  ffffffff810f71a8 000000004c0d6dc0 0000000000000001 0000000000000001\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216040]  ffff88087fffc280 0000000000000002 0000000500000001 0000000000000000\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216095]  0000000000000000 0000000000000e00 0000000000000190 ffff88104d7d5420\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216151] Call Trace:\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216178]  [&lt;ffffffff810f71a8&gt;] ? mem_cgroup_force_empty+0x1e8/0x490\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216210]  [&lt;ffffffff8103665c&gt;] ? should_resched+0x5/0x23\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216240]  [&lt;ffffffff81083dc4&gt;] ? cgroup_rmdir+0xa4/0x3ba\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216278]  [&lt;ffffffff8105fe7b&gt;] ? add_wait_queue+0x3c/0x3c\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216307]  [&lt;ffffffff8103665c&gt;] ? should_resched+0x5/0x23\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216339]  [&lt;ffffffff81105847&gt;] ? vfs_rmdir+0x7b/0xce\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216370]  [&lt;ffffffff811067b9&gt;] ? do_rmdir+0xc0/0x10d\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216410]  [&lt;ffffffff810d6390&gt;] ? sys_munmap+0x46/0x52\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216443]  [&lt;ffffffff813561b2&gt;] ? system_call_fastpath+0x16/0x1b\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216480] Code: 98 00 00 00 48 c7 83 a0 00 00 00 00 00 00 00 48 c7 83 a8 00 00 00 00 00 00 00 48 89 38 e8 52 cd 0b 00 c6 83 b8 00 00 00 01 5b c3 &lt;8b&gt; 17 eb 02 89 c2 85 d2 74 0d 8d 0c 32 89 d0 f0 0f b1 0f 39 d0\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216735] RIP  [&lt;ffffffff810f3f51&gt;] __mem_cgroup_insert_exceeded.isra.32+0x71/0x71\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216786]  RSP &lt;ffff880597ecdd50&gt;\n  Oct 27 02:04:37 execute1005 kernel: [5909917.216813] CR2: ffffe9fad90517bc\n  Oct 27 02:04:37 execute1005 kernel: [5909917.217304] ---[ end trace 5c6ef7f561230cf3 ]---\n</pre>\n\n<p></p><pre>  ## MasterLog\n  10/27/15 02:04:37 procd (pid = 29201) exited unexpectedly with status 9\n  10/27/15 02:04:37 attempting to restart the Procd\n  10/27/15 02:04:41 DefaultReaper unexpectedly called on pid 29253, status 1024.\n  10/27/15 02:04:41 The STARTD (pid 29253) exited with status 4\n  10/27/15 02:04:41 Result of \"signal_family\" operation from ProcD: ERROR: No family with the given PID is registered\n  10/27/15 02:04:41 error killing process family of daemon with pid 29253\n  10/27/15 02:04:41 Sending obituary for \"/usr/sbin/condor_startd\"\n  10/27/15 02:04:41 restarting /usr/sbin/condor_startd in 10 seconds\n  10/27/15 02:04:41 Result of \"unregister_family\" operation from ProcD: ERROR: No family with the given PID is registered\n  10/27/15 02:04:41 error unregistering pid 29253 with the procd\n  10/27/15 02:04:51 Started DaemonCore process \"/usr/sbin/condor_startd\", pid and pgroup = 30101\n  10/27/15 03:02:12 ERROR: Child pid 30101 appears hung! Killing it hard.\n  10/27/15 03:02:12 DefaultReaper unexpectedly called on pid 30101, status 9.\n  10/27/15 03:02:12 The STARTD (pid 30101) was killed because it was no longer responding</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Oct-27 16:25:59 by tpdownes:</em> <br/>\n\nIn this case procd is still stuck in D state. Could be related to other procd+NFS problem we saw.\n\n<p></p><hr/>\n<em>2015-Oct-29 22:08:02 by tpdownes:</em> <br/>\n\nSaw the same bug today except that naive reading points more clearly to a problem in code rather than cgroups oom manager.\n\n<p></p><pre>  Oct 29 16:47:46 execute0015 kernel: [6830172.769170] BUG: unable to handle kernel NULL pointer dereference at 0000000000000010\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769220] IP: [&lt;ffffffff810f7eca&gt;] lookup_cgroup_page+0x10/0x2b\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769253] PGD 27d747067 PUD 15ea0a067 PMD 0\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769283] Oops: 0000 [#1] SMP\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769310] CPU 3\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769315] Modules linked in: btrfs libcrc32c ufs qnx4 hfsplus hfs minix ntfs vfat msdos fat jfs xfs reiserfs ext3 jbd ext2 fuse autofs4 cpufreq_userspace cpufreq_powersave cpufreq_stats cpufreq_conservative nfsd nfs nfs_acl auth_rpcgss fscache lockd sunrpc adm1026 hwmon_vid zfs(P) zunicode(P) zavl(P) zcommon(P) znvpair(P) spl(O) zlib_deflate snd_pcm snd_page_alloc acpi_cpufreq snd_timer mperf coretemp crc32c_intel processor button ioatdma dca i7core_edac edac_core snd psmouse soundcore i2c_i801 joydev evdev serio_raw pcspkr i2c_core iTCO_wdt iTCO_vendor_support thermal_sys ext4 crc16 jbd2 mbcache dm_mod sg sd_mod crc_t10dif usbhid hid uhci_hcd ahci libahci libata ehci_hcd scsi_mod usbcore usb_common e1000e [last unloaded: scsi_wait_scan]\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769753]\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769773] Pid: 13985, comm: condor_procd Tainted: P           O 3.2.0-4-amd64 #1 Debian 3.2.68-1+deb7u3 Supermicro X8DTT-H/X8DTT-H\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769829] RIP: 0010:[&lt;ffffffff810f7eca&gt;]  [&lt;ffffffff810f7eca&gt;] lookup_cgroup_page+0x10/0x2b\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769877] RSP: 0018:ffff88030ce49d48  EFLAGS: 00010246\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769903] RAX: 0000000000000000 RBX: ffff880c196801a0 RCX: 0000000000002a21\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769947] RDX: 0000000000000000 RSI: 0000000000000207 RDI: 000000000007fffc\n  Oct 29 16:47:46 execute0015 kernel: [6830172.769990] RBP: ffff880c19e4f5b0 R08: 0000000000000000 R09: ffffffff81690a10\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770033] R10: 0000000000000f7b R11: ffff88061b1fc000 R12: ffff880c1b31b800\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770075] R13: ffffea0020dc8fd8 R14: ffff880c196801a0 R15: ffff880c1b2f9000\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770118] FS:  00007f936965bb40(0000) GS:ffff88063fc60000(0000) knlGS:0000000000000000\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770163] CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770190] CR2: 0000000000000010 CR3: 00000004c2eca000 CR4: 00000000000006e0\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770232] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770275] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770318] Process condor_procd (pid: 13985, threadinfo ffff88030ce48000, task ffff8803eaed7840)\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770364] Stack:\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770383]  0000000000000000 ffffffff810f7186 00000000197141c0 0000000100000001\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770435]  0000000000000002 ffff880c3fffb280 0000000000000002 0000000500000002\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770485]  0000000000000000 0000000000000001 0000000000000e00 0000000000000190\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770535] Call Trace:\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770558]  [&lt;ffffffff810f7186&gt;] ? mem_cgroup_force_empty+0x1c6/0x490\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770588]  [&lt;ffffffff8103665c&gt;] ? should_resched+0x5/0x23\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770616]  [&lt;ffffffff81083dc4&gt;] ? cgroup_rmdir+0xa4/0x3ba\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770645]  [&lt;ffffffff8105fe7b&gt;] ? add_wait_queue+0x3c/0x3c\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770672]  [&lt;ffffffff8103665c&gt;] ? should_resched+0x5/0x23\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770701]  [&lt;ffffffff81105847&gt;] ? vfs_rmdir+0x7b/0xce\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770728]  [&lt;ffffffff811067b9&gt;] ? do_rmdir+0xc0/0x10d\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770757]  [&lt;ffffffff810d6390&gt;] ? sys_munmap+0x46/0x52\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770785]  [&lt;ffffffff813561b2&gt;] ? system_call_fastpath+0x16/0x1b\n  Oct 29 16:47:46 execute0015 kernel: [6830172.770812] Code: 0f e8 af ff ff ff 48 8b 50 10 31 c0 48 85 d2 74 08 48 c1 e3 05 48 8d 04 1a 5b c3 53 48 89 fb 48 8b 3f 48 c1 ef 2d e8 8a ff ff ff &lt;48&gt; 2b 58 10 48 b8 00 00 00 00 00 ea ff ff 48 c1 fb 05 48 6b db\n  Oct 29 16:47:46 execute0015 kernel: [6830172.771012] RIP  [&lt;ffffffff810f7eca&gt;] lookup_cgroup_page+0x10/0x2b\n  Oct 29 16:47:46 execute0015 kernel: [6830172.771042]  RSP &lt;ffff88030ce49d48&gt;\n  Oct 29 16:47:46 execute0015 kernel: [6830172.771064] CR2: 0000000000000010\n  Oct 29 16:47:46 execute0015 kernel: [6830172.771406] ---[ end trace 75a5d624699809f1 ]---\n</pre>\n\n<p></p><hr/>\n<em>2015-Nov-24 11:13:48 by tpdownes:</em> <br/>\n\nI think this is a description of the problem in words:\n\n<p><a class=\"external\" href=\"https://rachelbythebay.com/w/2014/10/27/ps/\">https://rachelbythebay.com/w/2014/10/27/ps/</a>\n\n</p><p></p><hr/>\n<em>2015-Nov-24 11:33:50 by tpdownes:</em> <br/>\n\nWhat is the value for oom_kill_disable that Condor expects in memory.oom_control?\n\n<p></p><hr/>\n<em>2015-Nov-24 15:31:37 by tpdownes:</em> <br/>\n\nMore updates later but this appears to be a problem with condor registering itself as a OOM manager for jobs managed under the condor cgroup while memory.use_hierarchy is enabled. This restriction is lifted in kernels 3.16 and later.\n\n<p><a class=\"external\" href=\"http://lkml.iu.edu/hypermail/linux/kernel/1404.2/00715.html\">http://lkml.iu.edu/hypermail/linux/kernel/1404.2/00715.html</a>\n<a class=\"external\" href=\"http://kernelnewbies.org/Linux_3.16\">http://kernelnewbies.org/Linux_3.16</a>\n\n</p><p>Initial testing with a 3.16 backports kernel suggests the problem is resolved.\n\n</p><p>Tom\n\n</p><p></p><hr/>\n<em>2015-Nov-24 15:46:35 by tpdownes:</em> <br/>\n\nThe line that prints the error about subscribing should probably be changed to D_ALWAYS\n\n<p></p><hr/>\n<em>2015-Nov-24 20:23:25 by tpdownes:</em> <br/>\n\nThese are the 2 issues.\n\n<p></p><ol>\n<li>HTCondor fails to register itself as the OOM killer for HTCondor jobs when memory.use_hierarchy is enabled. The memory hierarchy is integral to putting a firm cap on RAM usage by all Condor jobs and reserving space for the OS and Condor itself. But I believe Condor still attempts to act the OOM killer and gets in the way of kernel OOM killer on rare occasions (the crash that forms the basis for the ticket)\n</li><li>This failure is not properly logged (D_FULLDEBUG rather than D_ALWAYS)\n</li></ol>\n\n<p>They are resolved by upgrading to a 3.16+ kernel as noted in previous remakers. Nevertheless, Condor needs to gracefully handle a failure to register itself as the OOM killer.\n\n</p><p></p><hr/>\n<em>2016-Apr-27 14:08:19 by gthain:</em> <br/>\n\nAs per our phone call today, we're going to close this ticket, as LIGO hasn't seen this since a kernel upgrade.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "incident", "last_change": "2016-Apr-27 14:08", "status": "defer", "created": "2015-Oct-27 16:21", "fixed_version": "2015-Oct-27 16:21", "broken_version": "v080210", "priority": "5", "subsystem": "", "assigned_to": "", "derived_from": "", "creator": "tpdownes", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}