{"id": 6491, "title": "Ticket #6491: Report late materialization hold, resume and failure in the user log", "description": "<blockquote>\nWhen a job factory fails to load on restart of the schedd, or when materialization fails, the Job Factory should be placed into a non-resumable pause state.\n\n<p>when condor_hold is used and the cluster object matches the constraint expression for the hold, the factory should be placed into a resumeable pause state.\n\n</p><p>In both of these cases, the change to a paused state should be reported in the user event log, along with the reason for the pause.\n\n</p><p>When condor_release is use and the cluster object matches the constraint expression, the factory should be unpaused provided that it was paused because of a hold and not because of materialization failure.  This should also be reported in the user event log.\n\n</p><p>Two new event types will be added to the condor event module, one for factory pause and one for factory release.  The factory pause event will include an optional reason, an optional pause code and an optional hold code.\n\n</p><p>In addition, the existing factory remove event will be expanded to report how many jobs had been materialized at the time of removal, whether the materialization was known to be complete or incomplete. If the factory was paused at the time of removal, the pause reason will be reported.  Thus if a factory fails to re-load, when it is removed on completion of all of the existing jobs, the reason for the failure will be reported.\n\n</p><p>Some example event log output, (only some of the events are shown)\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">condor_rm of a cluster containing a job factory</pre>\n<pre class=\"snip\">035 (10701.-01.000) 11/21 13:44:29 Factory submitted from host: &lt;w.x.y.z:6909&gt;\n...\n009 (10701.003.000) 11/21 13:45:01 Job was aborted by the user.\n        via condor_rm (by user johnkn)\n...\n036 (10701.-01.000) 11/21 13:45:01 Factory removed\n        Materialized 8 jobs from 0 items.       Incomplete\n...\n</pre></div>\n\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">hold and release of a cluster</pre>\n<pre class=\"snip\">037 (10700.-01.000) 11/21 13:35:51 Job Materialization Paused\n        because I said so (by user johnkn)\n        PauseCode 1\n        HoldCode 1\n...\n012 (10700.009.000) 11/21 13:35:51 Job was held.\n        because I said so (by user johnkn)\n        Code 1 Subcode 0\n...\n038 (10700.-01.000) 11/21 13:36:35 Job Materialization Resumed\n        It seemed like a good idea at the time (by user johnkn)\n...\n013 (10700.009.000) 11/21 13:36:35 Job was released.\n        It seemed like a good idea at the time (by user johnkn)\n...\n005 (10700.009.000) 11/21 13:36:35 Job terminated.\n        (1) Normal termination (return value 0)\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Run Remote Usage\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Run Local Usage\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Total Remote Usage\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Total Local Usage\n        0  -  Run Bytes Sent By Job\n        0  -  Run Bytes Received By Job\n        0  -  Total Bytes Sent By Job\n        0  -  Total Bytes Received By Job\n...\n036 (10700.-01.000) 11/21 13:36:35 Factory removed\n        Materialized 10 jobs from 0 items.      Complete\n...\n</pre></div>\n\n<div class=\"snip\">\n<pre class=\"sniplabel\">factory reload failure and subsequent removal</pre>\n<pre class=\"snip\">037 (10699.-01.000) 11/21 11:40:18 Job Materialization Paused\n        Failed to open factory submit digest : No such file or directory\n        PauseCode -1\n...\n005 (10699.004.000) 11/21 11:41:53 Job terminated.\n        (1) Normal termination (return value 0)\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Run Remote Usage\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Run Local Usage\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Total Remote Usage\n                Usr 0 00:00:00, Sys 0 00:00:00  -  Total Local Usage\n        0  -  Run Bytes Sent By Job\n        0  -  Run Bytes Received By Job\n        0  -  Total Bytes Sent By Job\n        0  -  Total Bytes Received By Job\n        Partitionable Resources :    Usage  Request Allocated\n           Cpus                 :                 1         1\n           Disk (KB)            :        4        4 155562274\n           Memory (MB)          :        1        1      4065\n...\n036 (10699.-01.000) 11/21 11:41:53 Factory removed\n        Materialized 8 jobs from 0 items.       Error -1\n        Failed to open factory submit digest : No such file or directory\n...\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Nov-21 13:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/516e99f1b4c0a2671bb43906f9850b0a8b0f05a7\">[52847]</a></span>: report materialization failure, pause and resume in user event log <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6491\" onclick=\"get_ticket_and_populate_wrapper('6491'); return false;\" title=\"Report late materialization hold, resume and failure in the user log\">#6491</a></span>. This commit adds two new event types, factory-pause and factory-release and also adds completion status and error reporting to the factory remove event. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Dec-19 11:16", "status": "resolved", "created": "2017-Nov-21 13:38", "fixed_version": "2017-Nov-21 13:38", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "johnkn", "derived_from": "#6457", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}