{"id": 2062, "title": "Ticket #2062: Externals painfully slow to build, no caching, no parallel -j2 builds", "description": "<blockquote>\nThe externals are, as always, painfully slow to build.  About 22 minutes from scratch.  Since the move to cmake, we no longer get the benefits of externals caching.  <div class=\"strike\">\n<strike>ccache isn't compatible with Globus, and so isn't an option.</strike></div>\n  \"make -j2\" doesn't reliably work; there are a variety of potential failures.\n\n<p></p><ol>\n<li>Parallel builds of the externals should be reliable.  If individual externals can't handle it, cmake should know to invoke the sub-make for a given external without any parallel options.\n</li><li>Some sort of caching would be ideal.  Perhaps something like the old system or make ccache work.\n</li></ol>\n\n<p></p><div class=\"strike\">\n<strike>To check: CREAM external hates rebuilds? Doesn't make clean enough?</strike></div>\n CREAM problem moved to <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=2063\" onclick=\"get_ticket_and_populate_wrapper('2063'); return false;\" title=\"make clean fails to remove share/wsdl\">#2063</a></span></blockquote>", "remarks": "<blockquote>\n<em>2011-Apr-13 15:58:56 by tstclair:</em> <br/>\n\nI should get this rolling early next week barring any major issues.\n\n<p></p><hr/>\n<em>2011-Apr-13 16:39:26 by adesmet:</em> <br/>\n\nI swear ccache broke at least one external, and I thought it was Globus.  However, Globus has been revved since then, and initial tests suggest it now works.  It's worth noting that \"ccache make\" does not work; ccache doesn't (it appears) ever get invoked.  Using the symlink solution (ln -s ccache gcc; ln -s ccache g++; PATH=`pwd`:$PATH) appears to work, I'm doing some testing now.  If this does work it may sort out most of the slowness by itself.  Still, the ability to do parallel builds would be nice, especially for fresh builds.\n\n<p></p><hr/>\n<em>2011-Apr-13 16:50:53 by adesmet:</em> <br/>\n\nRelatedly, CREAM's share/wsdl is the bane of my existence.\n\n<p></p><hr/>\n<em>2011-Apr-13 17:06:36 by adesmet:</em> <br/>\n\nForked my complaints about rebuilding CREAM into <span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=2063\" onclick=\"get_ticket_and_populate_wrapper('2063'); return false;\" title=\"make clean fails to remove share/wsdl\">#2063</a></span>.\n\n<p></p><hr/>\n<em>2011-Apr-13 17:14:00 by adesmet:</em> <br/>\n\nccache dropped build time from about 25 minutes to about 20. Nice, but not really enough. Wild guess: lots of time spent downloading tarballs, untarring tarballs, and while I was paying attention running OpenSSL tests.  -j2 might help, but it is an argument for a shared cache of external builds.\n\n<p></p><hr/>\n<em>2011-Apr-14 11:56:47 by tstclair:</em> <br/>\n\n-j2 fails intermittently on OpenSSL tests.\n\n<p></p><hr/>\n<em>2011-Apr-28 08:10:00 by tstclair:</em> <br/>\n\nbranch ready for review:\n\n<p>V7_6-cached-externals-publicbranch\n\n</p><p></p><hr/>\n<em>2011-May-10 10:41:15 by gthain:</em> <br/>\n\nNote that make -j 2 is known broken by the openssl folks.  Apparently some build (test?) steps re-use the same temporary file.\n\n<p>Also, ccache compiles all the externals correctly, but doesn't help much.  The problem is that globus spends most of it's time in configure.  We really need a configurecache I think glibc has the same problem.\n\n</p><p></p><hr/>\n<em>2011-May-10 14:21:44 by gthain:</em> <br/>\n\nBuilds here, builds in nmi, looks basically good to me.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-24 15:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21971\">[21971]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: jfrey request for option specifying cached externals.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-11 12:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21835\">[21835]</a></span>: Change external build from c:/temp to controlled by CONDOR_BLD_EXTERNAL_STAGE environment varible with default to putting externals in condor build directory. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-11 11:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21831\">[21831]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update to only use /scratch when NON-PROPER, otherwise use old loc in BINARY_DIR  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-11 09:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21829\">[21829]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update dependency issue found in nmi  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-10 16:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21825\">[21825]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Move /scratch/condor/externals -&gt; /scratch/condor_externals as not to collide  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-10 14:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21821\">[21821]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update for libcgroup for cached externals  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-10 13:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21818\">[21818]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: remove extra OS/ARCH from /scratch path per gthain  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-10 13:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21817\">[21817]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update scratch location per issues that greg had.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-10 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21816\">[21816]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: update checks on QPID_FOUND  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-10 09:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21807\">[21807]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update for proper post modifications and merge out.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-28 08:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21613\">[21613]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Modifications from nmi runs for cached externals.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-25 09:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21554\">[21554]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Build Complete, onto nmi  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-22 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21553\">[21553]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Almost complete, last bit to hash out are the per-dep includes instead of the mass-include  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-20 15:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21551\">[21551]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: cream mods externals  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-20 11:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21456\">[21456]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update builds several externals on fedora host onto RHEL full test  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-20 10:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21454\">[21454]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Updates for cached externals  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-19 14:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21443\">[21443]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Modifications to *nix externals for caching (pre_test) +cruft removal  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-18 15:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21428\">[21428]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Update for cached externals, windows now fully builds.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-18 11:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21423\">[21423]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Fix for prebuilt cached version check.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-18 11:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21422\">[21422]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Windows builds with cached externals.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-14 11:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21397\">[21397]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2062\" onclick=\"get_ticket_and_populate_wrapper('2062'); return false;\" title=\"Externals painfully slow to build, no caching, no parallel -j2 builds\">#2062</a></span>: Inital update for cached externals  (By Timothy St. Clair )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-May-10 16:05", "status": "resolved", "created": "2011-Apr-13 13:01", "fixed_version": "2011-Apr-13 13:01", "broken_version": "v070505", "priority": "2", "subsystem": "Packaging", "assigned_to": "tstclair", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "matt@cs.wisc.edu, tstclair@redhat.com", "due_date": "20110506"}