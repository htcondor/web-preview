{"id": 2933, "title": "Ticket #2933: refactor dprintf flags to enum + flags", "description": "<blockquote>\nWe need room for new dprintf categories and flags.  And there is a great deal of ambiguity with D_FULLDEBUG which is just as both a modifier for other categories, and as category itself.\n\n<p>Since Most of the dprintf flags are mutually exclusive, they can be converted to an enum, thus freeing up a great many bits for use both as new enum values and as new flags.  Something like this\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">enum {\n   D_CATEGORY_BASE = 0,\n   D_ALWAYS = 0,\n   D_ERROR,\n   D_STATUS,\n   D_GENERAL,\n   D_JOB,\n   D_MACHINE,\n   D_CONFIG,\n   D_PROTOCOL,\n   D_PRIV,\n   D_DAEMONCORE,\n   D_GENERIC_VERBOSE, // (1&lt;&lt;D_GENERIC_VERBOSE) == D_FULLDEBUG\n   D_SECURITY,\n   D_COMMAND,\n   D_MATCH,\n   D_NETWORK,\n   D_KEYBOARD,\n   D_PROCFAMILY,\n   D_IDLE,\n   D_THREADS,\n   D_ACCOUNTANT,\n   D_SYSCALLS,\n   D_CKPT,\n   D_HOSTNAME,\n   D_PERF_TRACE,\n   D_LOAD,\n   D_PROC,\n   D_NFS,\n\n   // this must be last\n   D_CATEGORY_COUNT\n};\n#define D_CATEGORY_MASK\t(0xFF)\n\n#define D_VERBOSE_MASK\t(3&lt;&lt;8)\n#define D_TERSE\t\t(0&lt;&lt;8)\n#define D_VERBOSE\t(1&lt;&lt;8)\n#define D_DIAGNOSTIC\t(2&lt;&lt;8)\n#define D_NEVER\t\t(3&lt;&lt;8)\n\n#define D_FULLDEBUG\t(1&lt;&lt;10) // when or'd with a D_category, it means that category, or (D_ALWAYS|D_VERBOSE)\n#define D_EXPR\t\t(1&lt;&lt;11) // set by condor_submit, used by ??\n#define D_FAILURE       (1&lt;&lt;12) // nearly always mixed with D_ALWAYS\n\n// format-modifying flags to change the appearance of the dprintf line\n#define D_PID           (1&lt;&lt;28)\n#define D_FDS           (1&lt;&lt;29)\n#define D_CAT           (1&lt;&lt;30) // briefly D_LABEL\n#define D_NOHEADER      (1&lt;&lt;31)\n</pre></div>\n\n\n<p>In order to do transition to this, the internal mechanism that the dprintf code uses to determine whether or not a category is enabled will have to change, which in turn means that all of the code outside of dprintf will have to stop directly using the dprintf internal data members (namely the <code>DebugFlags</code> global variable).\n\n</p><p>Refactoring of the dprintf code will have to take place in several stages.\n\n</p><p></p><ol>\n<li>Remove all direct uses of dprintf internal variables from other parts of the code.  In particular, Provide some macros or functions so that code can test whether a particular D_xxxx flag or category is enabled without using <code>DebugFlags</code> directly.  and modify the code to these.\n</li></ol>\n\n<p></p><div class=\"code\">\n<pre class=\"code\">// use this\nif (IsDebugLevel(D_SECURITY)) {}\n// instead of this\nif (DebugFlags &amp; D_SECURITY) {}\n\n// this\nif (IsDebugVerbose(D_SECURITY)) {}\n// instead of this\nif ((DebugFlags &amp; D_FULLDEBUG) &amp;&amp; (DebugFlags &amp; D_SECURITY)) {}\n</pre></div>\n\n\n<p></p><ol>\n<li>Rework the internals of dprintf so that it uses a more complex data structure to track which categories are enabled and at what verbosity level.\nOne simple mechanism would be to add a second set of flags\n</li></ol>\n\n<p></p><div class=\"code\">\n<pre class=\"code\">extern int DebugBasic;\nextern int DebugVerbose;\n#define IsDebugLevel(cat)  (DebugBasic &amp; (1&lt;&lt;(cat&amp;D_CATEGORY_MASK)))\n#define IsDebugVerbose(cat) (DebugVerbose &amp; (1&lt;&lt;(cat&amp;D_CATEGORY_MASK)))\n</pre></div>\n\n\n<p>In the future we could widen these to 64 bits or change to a vector without\ntouching a lot of code.\n\n</p><p></p><ol>\n<li>Enhance the configuration so that verbosity could be specified for each category.\n</li></ol>\n\n<p></p><div class=\"code\">\n<pre class=\"code\">SCHEDD_DEBUG = D_SECURITY:2 D_COMMAND\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-10 10:06:12 by johnkn:</em> <br/>\n\nThese ticket should superceed the following tickets.\n\n<p></p><ul>\n<li><span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=1025\" onclick=\"get_ticket_and_populate_wrapper('1025'); return false;\" title=\"Replace dprintf levels with tags\">#1025</a></span> - Replace dprintf levels with tags\n</li><li><span class=\"ticket\"><a class=\"abandoned\" href=\"/tickets?ticket=2713\" onclick=\"get_ticket_and_populate_wrapper('2713'); return false;\" title=\"RFE: extend dprintf flag parameter to 64-bit integer\">#2713</a></span> - extend dprintf flag parameter to 64-bit integer\n</li></ul>\n\n<p></p><hr/>\n<em>2013-May-21 14:44:20 by johnkn:</em> <br/>\n\nConverting dprintf flags to category enum has been completed, but work remains.  Still need to\n\n<p></p><ul>\n<li>Change implementation to support verbosity levels other than 1 &amp; 2\n</li><li>add configuration for secondary &amp; tertiary log destinations\n</li><li>allow syslog, stdout and/or stderr as a secondary or tertiary destination</li></ul>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3291\" onclick=\"get_ticket_and_populate_wrapper('3291'); return false;\" title=\"Enable syslog output for dprintf\">#3291</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nEnable syslog output for dprintf</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-21 11:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0a43668b9efe6d78d7a415e37d20c1bb954d94d5\">[34168]</a></span>: fix missing space after D_CATEGORY header in dprintf log. <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span> ===VersionHistory:None=== does this even need version history?  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-31 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/26d335aee6d6261beb8834ddfc9d9a925e082e9d\">[32166]</a></span>: normalize syntax in config for declaring D_XXX flags in shared port test. <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-31 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/187ebd56ac69ebcfa2b7fffd8ba1b6a8134bcbac\">[32165]</a></span>: change D_FAILURE from debug category to flag, introduce D_ERROR category to replace D_FAILURE <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span> D_FAILURE|D_ALWAYS is used in many calls to dprintf, which causes those messages to have an effective category of D_FAILURE if D_FAILURE is a category code rather than a flag.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-31 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f5909ef6b5576c78308ea4c809f787f363eb35e0\">[32164]</a></span>: change _condor_set_debug_flags() &amp; dprintf_config so that they merge flags from ALL_DEBUG and subsys_DEBUG this is the old behavior that some tests depend on, and users might also. <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span> output of D_CAT (formerly D_LABEL) changed somewhat by this patch, also some renaming of functions, args for clarity.\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-31 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/596547030e8e012fa9f730788ada2eb3f7b5483f\">[32162]</a></span>: fix bugs in previous patch for dprintf verbosity. <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-31 09:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b000644e1c3511a928cbb1bc57a3a45674b1c3ef\">[32161]</a></span>: remove <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugFlags\" title=\"Debug Flags\">DebugFlags</a></span> global variable and replace with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugBasic\" title=\"Debug Basic\">DebugBasic</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugHeaderOptions\" title=\"Debug Header Options\">DebugHeaderOptions</a></span> that no code except dprintf should touch. New parsing of NNN_DEBUG config variables that understands a verbositly level for each debug flag. (e.g D_SECURITY:2) <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span>\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-11 16:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/95704be82726e61d871761e25a291cad0cb36ad1\">[31638]</a></span>: Remove most of the remaining references to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugFlags\" title=\"Debug Flags\">DebugFlags</a></span> in condor code, including contrib modules and tests <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span> add calls to set_debug_flags() instead in many cases. set_debug_flags() now has a second parameter to facilitate this change. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-10 16:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cc13329dbdaef0a15bb6d451fcd912544a58bc1\">[31610]</a></span>: remove explict references to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DebugFlags\" title=\"Debug Flags\">DebugFlags</a></span> from most condor code, replacing them with macros <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=IsDebugLevel\" title=\"Is Debug Level\">IsDebugLevel</a></span>, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=IsDebugVerbose\" title=\"Is Debug Verbose\">IsDebugVerbose</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=IsFullDebug\" title=\"Is Full Debug\">IsFullDebug</a></span>. <span class=\"ticket\"><a class=\"pending\" href=\"/tickets?ticket=2933\" onclick=\"get_ticket_and_populate_wrapper('2933'); return false;\" title=\"refactor dprintf flags to enum + flags\">#2933</a></span>  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2013-May-21 14:44", "status": "pending", "created": "2012-Apr-10 10:01", "fixed_version": "2012-Apr-10 10:01", "broken_version": "v070700", "priority": "3", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com matt@cs.wisc.edu eje@cs.wisc.edu", "due_date": ""}