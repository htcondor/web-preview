{"id": 7262, "title": "Ticket #7262: Provide ability for collector to receive impersonation tokens", "description": "<blockquote>\nThe collector is a source of trust.  When match sessions are enabled,\n\n<p></p><ul>\n<li>The schedd trusts the set of startds in the collector.\n</li><li>As of 8.9.3, the schedd trusts the set of negotiators in the collector.\n</li><li>The startd trusts the set of schedds in the collector.\n</li></ul>\n\n<p>I'd like to add one more concept -- that the collector is a trusted source of identities.\n\n</p><p>That is, the schedd can rely on the attestation of the collector for user identities.  The collector is trusted to generate identities (i.e., impersonate) on behalf of users.  This way, if the user has a way to authenticate with a collector with a particular identity, the collector is trusted to turn around and get an identity token from the schedd.\n\n</p><p>Applications of this would be running a central submit host at the collector - or, for the OSG, bootstrapping a trust relationship between a CE and the factory (without needing a host certificate).  More on the latter later.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Sep-24 16:57:19 by tlmiller:</em> <br/>\n\nGenerally looks good to me, but I'd like Zach to think about the security implications if he hasn't already.\n\n<p></p><hr/>\n<em>2019-Sep-24 16:57:59 by tlmiller:</em> <br/>\n\nAlso needs documentation.\n\n<p></p><hr/>\n<em>2019-Nov-14 14:49:07 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>:  The ticket says, \"More on the latter later\"...  I believe later is now, and for me to really understand this to review the security implications, I would like more context.  I also generally dislike the idea of running a schedd on the same machine as the collector.  In a lot of existing pools, commands coming from the collector are authorized as ADMINSTRATOR-level commands based on IP alone.  So someone submitting a local/scheduler universe job to said schedd could turn off the pool or wreak other havoc.  Of course, proper configuration of security measures will prevent that, but I'd like to perhaps also add protective code to really restrict the trust relationship to the narrowest set of commands, or perhaps have some default submit_requirements to prevent any bad behavior.  So let's think about that and we'll see what else Brian adds to the ticket.\n\n<p>There is also no documentation for this and I don't know enough about it to write it myself.  I'm fine with this code going out in 8.9.4 but this all needs to be addressed promptly.\n\n</p><p></p><hr/>\n<em>2019-Nov-15 13:18:03 by bbockelm:</em> <br/>\n\nHi Zach --\n\n<p>I think you might have read the ticket the other way around?  The impersonation tokens are issued by the collector (assuming SEC_ENABLE_IMPERSONA&amp;#8203;TION_TOKENS is on (default off) and according to the SEC_IMPERSONATION_TO&amp;#8203;KEN_LIMITS limits) and then honored by the schedd if the security session is from a known collector.\n\n</p><p>I think I missed the documentation because the ticket was listed in the \"review\" state (and hence I missed it in TimT's table).  If you can pop it over, I can start adding this.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2019-Nov-19 13:42:48 by zmiller:</em> <br/>\n\nBrian and I met in person, so I understand the context better.  I will add some docs (version history at a minimum) for the next release.\n<hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-May-20 09:43:49 by zmiller:</em> <br/>\n\nBrian, does this still need specific documentation?  If so I'm going to make a new ticket just for the docs so we can resolve this one with the target version for the commits set correctly.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-30 21:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58782\">[58782]</a></span>: Improve error message for impersonation token. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span> When encryption is disabled, the impersonation token code mistakenly overwrites the error message with one about not finding the schedd ad; this restores the originally-intended error message.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-23 22:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57910\">[57910]</a></span>: Fixup: correct argument parsing in remote mode. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span>.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-23 22:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57909\">[57909]</a></span>: Disable impersonation tokens by config. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span> Also allows the sysadmin to limit the impersonation tokens to specified authorization levels.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-16 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57908\">[57908]</a></span>: Implement collector-based impersonation tokens. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span> This allows the client (`condor_token_fetch`) to have a remote which talks to the collector - and has the collector fetch a token from a named schedd on the client's behalf.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-16 13:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57907\">[57907]</a></span>: Fixup: All these commands require a payload; wait for it to arrive. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-16 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57906\">[57906]</a></span>: Fixup: Always apply max lifetime, even when one is not requested. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-16 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57905\">[57905]</a></span>: Fixup: Pass identity by const reference, not value. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-16 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57904\">[57904]</a></span>: Add a mechanism to walk the hash table with a C++ lambda. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Sep-16 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=57903\">[57903]</a></span>: Refactor the signing key fetch into the utils. <span class=\"ticket\"><a class=\"docpending\" href=\"/tickets?ticket=7262\" onclick=\"get_ticket_and_populate_wrapper('7262'); return false;\" title=\"Provide ability for collector to receive impersonation tokens\">#7262</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-May-20 09:43", "status": "docpending", "created": "2019-Sep-16 13:24", "fixed_version": "2019-Sep-16 13:24", "broken_version": "", "priority": "3", "subsystem": "Security", "assigned_to": "zmiller", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "zmiller@cs.wisc.edu, bbockelman@morgridge.org", "due_date": ""}