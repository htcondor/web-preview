{"id": 6568, "title": "Ticket #6568: Startd always kills jobs after 40 minutes (job lease not renewed)", "description": "<blockquote>\nNormally, the startd will renew the job lease automatically while the starter is alive (see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4491\" onclick=\"get_ticket_and_populate_wrapper('4491'); return false;\" title=\"Scalable claim keepalive protocol\">#4491</a></span>). However, due to startd code refactoring to fix <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6524\" onclick=\"get_ticket_and_populate_wrapper('6524'); return false;\" title=\"startd may delete a starter object before the starter is reaped.\">#6524</a></span>, the startd will no longer do this by default.  Seems like the startd is now confusing the activation ad for the claim ad?  The result is the job gets killed after job_lease_duration seconds (which defaults to 40 minutes).\n\n<p>To reproduce, submit a job like so (note short job_lease_duration):\n\n</p><p></p><pre>   executable = /bin/sleep\n   arguments = 300\n   job_lease_duration = 20\n   queue\n</pre>\n\n<p>And then in the <code>StarterLog</code> you will see the following (note lease expires 20 seconds after going into activity Busy):\n\n</p><p></p><pre>   02/13/18 13:47:27 slot1: Changing activity: Idle -&gt; Busy\n   02/13/18 13:47:47 slot1: State change: claim lease expired (condor_schedd gone?), evicting claim\n   02/13/18 13:47:47 slot1: Changing state and activity: Claimed/Busy -&gt; Preempting/Killing\n   02/13/18 13:47:47 slot1: Got DEACTIVATE_CLAIM while in Preempting state, ignoring.\n   02/13/18 13:47:47 Starter pid 5612 exited with status 0\n</pre>\n\n<p>The problem here is that the changes in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6524\" onclick=\"get_ticket_and_populate_wrapper('6524'); return false;\" title=\"startd may delete a starter object before the starter is reaped.\">#6524</a></span> switched from using the job ad passed from schedd at claim time to using the job ad passed from the shadow at activation time when it was deciding how to setup the keepalive behavior. This is controlled by the SCHEDD via attributes <code>ATTR_STARTD_SENDS_ALIVES</code> and <code>ATTR_STARTER_HANDLES_ALIVES</code>, and these attributes are not set in the job ad that the shadow sees and subsequently sends to the startd at activation time.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Feb-13 15:56:25 by tannenba:</em> <br/>\n\nThe fix for this ticket should also add a regression test for job_lease_duration processing.\n\n<p></p><hr/>\n<em>2018-Mar-01 13:46:46 by johnkn:</em> <br/>\n\nno version history for this bug, it was only ever in the master branch.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6571\" onclick=\"get_ticket_and_populate_wrapper('6571'); return false;\" title=\"test needed for job_lease_duration and lease renewal\">#6571</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ntest needed for job_lease_duration and lease renewal</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Feb-14 10:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=54290\">[54290]</a></span>: fix <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6568\" onclick=\"get_ticket_and_populate_wrapper('6568'); return false;\" title=\"Startd always kills jobs after 40 minutes (job lease not renewed)\">#6568</a></span>, job lease not being renewed because the startd is querying the wrong version of the job ad for keepalive policy. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Mar-01 13:46", "status": "resolved", "created": "2018-Feb-13 15:52", "fixed_version": "2018-Feb-13 15:52", "broken_version": "v080707", "priority": "1", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "#6524", "creator": "tannenba", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "tannenba@cs.wisc.edu johnkn@cs.wisc.edu rynge@isi.edu", "due_date": ""}