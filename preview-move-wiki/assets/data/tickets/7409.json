{"id": 7409, "title": "Ticket #7409: Daisy-chained HTCondor-CE Gridmanager Assertion ERROR", "description": "<blockquote>\nOur friends at PIC and CIEMAT are having issues with their daisy-chained HTCondor-CE setup (the PIC HTCondor-CE/HTCondor setup submits some jobs to the CIEMAT HTCondor-CE/HTCondor setup via Condor-G), where an instance of the job is being removed somewhere along the chain, causing an assertion error:\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nERROR \"Assertion ERROR on (gahp != __null || gmState == 14 || gmState == 12)\" at line 391 in file /slots/10/dir_3391896/userdir/.tmpa8mXuo/BUILD/condor-8.8.1/src/condor_gridmanager/condorjob.cpp\n</td></tr></tbody></table></div>\n\n\n<p>Unfortunately, this kills the Gridmanager meaning that all jobs after the first problematic one don't get status updates.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Dec-09 16:17:20 by jfrey:</em> <br/>\n\nThis is a bug in the gridmanager that affects Condor-C (a.k.a. grid-type condor) jobs. It can trigger when the job's proxy file disappears and the job lease expires. If the gridmanager subsequently resumes managing the job (say after the job is held and released, or the gridmanager restarts), this ASSERT() is hit.\n\n<p>Most of the code in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorJob\" title=\"Condor Job\">CondorJob</a></span> class assumes it has a valid <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GahpClient\" title=\"Gahp Client\">GahpClient</a></span> object. The ASSERT() in question enforces this. If the job's proxy file is missing, then we can't create the appropriate <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GahpClient\" title=\"Gahp Client\">GahpClient</a></span> object. There's a narrow code path to put the job on hold in this situation, which avoids the ASSERT(). The lease expiration handler pushes the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CondorJob\" title=\"Condor Job\">CondorJob</a></span> object out of this narrow code path.\n\n</p><p></p><hr/>\n<em>2019-Dec-12 13:23:56 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-09 16:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58624\">[58624]</a></span>: Docs for gridmanager ASSERT on missing proxy file. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7409\" onclick=\"get_ticket_and_populate_wrapper('7409'); return false;\" title=\"Daisy-chained HTCondor-CE Gridmanager Assertion ERROR\">#7409</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-09 16:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58623\">[58623]</a></span>: Avoid gridmanager ASSERT when proxy file disappears. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7409\" onclick=\"get_ticket_and_populate_wrapper('7409'); return false;\" title=\"Daisy-chained HTCondor-CE Gridmanager Assertion ERROR\">#7409</a></span> For grid-type condor jobs, when the proxy can't be read (and thus the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GahpClient\" title=\"Gahp Client\">GahpClient</a></span> object can't be created), don't allow the lease expiration timer to change the job's gmState. Otherwise, we trip over an ASSERT() that the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=GahpClient\" title=\"Gahp Client\">GahpClient</a></span> object is valid.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Dec-12 13:24", "status": "resolved", "created": "2019-Dec-04 12:06", "fixed_version": "2019-Dec-04 12:06", "broken_version": "v080801", "priority": "2", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu", "due_date": ""}