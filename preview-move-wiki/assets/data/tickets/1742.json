{"id": 1742, "title": "Ticket #1742: Create a sandbox manager to decouple transfers from job completion", "description": "<blockquote>\nCurrently, after a job completes the file transfer back to the submit node is still considered part of the job itself. This means that a slot remains blocked although it is not actually running anything computationally expensive anymore.\n\n<p>A joint effort with Parag Mhashilkar from Fermi will introduce a sandbox manager to decouple the file transfer from the actual job execution: Once the job completes, it will change into a different state (as already introduced by Jaime in ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1641\" onclick=\"get_ticket_and_populate_wrapper('1641'); return false;\" title=\"Add new job status TRANSFERRING_OUTPUT\">#1641</a></span>). After that the sandbox can be requested right away from the startd (invoking the sandbox manager) or at a later point in time. In the meantime, a new job can take over the slot and be run.\n\n</p><p></p><hr/>\nTimeline:\n\n<p></p><ul>\n<li><strong>Milestone 1</strong>\n<ul>\n<li>Startd maintains the slot manager\n</li><li>Old Condor behavior with new implementation, changes are not user-visible: After job execution, execution Starter terminates and transfer Starter starts up to transfer data back (same starter invoked w/ command line argument to skip job execution and go straight to transfer)\n</li><li>terminology:\n<ul>\n<li>data slot holds state for creation time, expiration time, physical location, sandbox id\n</li><li>schedd creates slot id (random-generated 64 byte string) created by schedd. Startd could potentially create the id as well, but would require two-phase commit protocol. Additionally if the schedd creates it, the ids could be tied to a workflow). Also, data slots need to maintain state about themselves: stagein, bound to cpu slot , stageout, expired, unused,\n(no disk space)\n</li></ul>\n</li></ul>\n\n<p></p></li><li><strong>Milestone 2</strong>\n<ul>\n<li>Advertise if a CPU slot is bound to a data slot, require binding in start expression. Advertisement should be minimal for now ('is data slot available?).\n</li></ul>\n\n<p></p></li><li><strong>Milestone 3:</strong>\n<ul>\n<li>schedd should mark claim as deactivated when job assoc w/ that claim goes into job transfer state.\n</li></ul>\n\n<p></p></li><li><strong>Milestone 4:</strong>\n<ul>\n<li>restart semantics : lease renewal, schedd re-attach to stards, startd crash\n</li></ul>\n\n<p></p></li><li><strong>Milestone 5:</strong>\n<ul>\n<li>advertise in classads (of startd? Seperate?)  data slot info\n</li></ul>\n\n<p></p></li><li><strong>Milestone 6:</strong>\n<ul>\n<li>data slot partitioning and characteristics.\n</li></ul>\n\n<p></p></li><li><strong>Future work</strong>\n<ul>\n<li>seperate capability string and claiming protocol for data slot. Right now it is piggy backed on cpu slot capability - this is ok until you want to claim a data slot w/o a cpu slot for data stage in.\n</li><li>data ads seperate from startd ads, gang matching lite</li></ul>\n</li></ul>\n</blockquote>", "remarks": "<blockquote>\nWill need to revise the above milestone description; some parts are no longer accurate. The attached design document, however, describes fairly well what is being done.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2152\" onclick=\"get_ticket_and_populate_wrapper('2152'); return false;\" title=\"Introduce multiple concurrent claim activations\">#2152</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nIntroduce multiple concurrent claim activations</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/305/design_document_sources.zip\">design_document_sources.zip</a>\n65375 bytes added by cweiss on 2011-Mar-29 22:35:36 UTC.\n<br/>\nDesign document sources (.tex file and omnigraffle source)<br/>\n</li><li><a href=\"../files/353/SandboxManagement_rev4.pdf\">SandboxManagement_rev4.pdf</a>\n111453 bytes added by cweiss on 2011-May-20 18:02:40 UTC.\n<br/>\nCurrent state of design<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-04 14:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0044d0ea27bd72a1ae35eb71410bfd5d8b64d004\">[26634]</a></span>: Introduce new job_exited command handler <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-04 14:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3a1e70e212903edf3cffa0d4e3159143b31cade6\">[26633]</a></span>: Claim can receive a new Starter now. Also introduce the message that job has exited (as opposed to Starter) <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-04 14:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9506099b3a6ba2dd10a5b882db8f5c3a09d650bb\">[26632]</a></span>: Modify Starter behavior before file transfer - add some sleep time for debugging <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Aug-04 14:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/74dc19725dfc4b0f21114ac7b14fc74244a972a6\">[26631]</a></span>: Job exited, not Starter, so adjust message <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 13:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/80383f2afdb379160046fc45b31a9ba4d48415b4\">[26630]</a></span>: When job changes state to TRANSFERRING_OUTPUT, write a generic event to user log (mostly for debugging purposes and was used during benchmarking). This may break dagman related things, so this may be reverted again at some point (<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>).  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 13:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1c338118a646de32183437a9cacfc9e7e8195276\">[26629]</a></span>: Don't use call to updateSandboxRecord for now -- the function does not work as it is. (<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>)  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-12 12:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/30fa47bab00a5e867cf25851d46d5eea5a62be20\">[26628]</a></span>: Prepare everything for notifying the startd about a job's termination. This command will be sent after job execution before the output transfer starts such that the startd can adjust its resource state. (<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>)  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-16 16:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2097f4ec5de1f0fade2e10b89b1d249e7ecc848d\">[21096]</a></span>: Store sandbox records so they can be used to make sandbox manager persistant <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-16 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7457db31312c2211ffbed629a329eca35b20fa6f\">[21085]</a></span>: Fix the return type of removeSandboxes <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-10 15:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4be4e8d75dccc4725f2638dc7da1c8acefdb9149\">[21018]</a></span>: Fix various compile problems and undo some changes in order to be compatible with already implemented work ( <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span> ).  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-09 19:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dea961bee579484825e575a9f595ba2d6f252b1a\">[21010]</a></span>: Keep the sandbox object deletion centrally in unregisterSandbox. Call the unregister method were deletion is required <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-09 19:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6d66b40ecca8fd3c376d6dd1483c746ba9bc39bf\">[21009]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7e8e324f89a056122db1d0a04599edf322031f62\">[20989]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/73a06af66146c9022cc041c2417419e74efa64a0\">[20994]</a></span>, Merge branch 'V7_5-SandboxManagement-branch' of /p/condor/repository/CONDOR_SRC into V7_5-SandboxManagement-branch\u00a0[...]\n (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-09 16:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ca3ab00099d69e4d7e1b96e4e79fd1393216b1e7\">[21008]</a></span>: Code now compiles <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-08 18:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/73a06af66146c9022cc041c2417419e74efa64a0\">[20994]</a></span>: fix slot-related files to actually build; added a function to sandbox manager for sandbox cleanup (<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>) .  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-08 16:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c07f4c6240cfff48230c2cd45f80d257c1bf03d4\">[21007]</a></span>: Adding sandbox slot related code. Still a work in progress <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-08 16:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7e8e324f89a056122db1d0a04599edf322031f62\">[20989]</a></span>: Adding sandbox slot related code. Still a work in progress (<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>)  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Mar-02 15:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d17ff3975fe40f393efde9334c401e85483678d\">[20942]</a></span>: Starter separate startup -- partially done (<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>)  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Feb-07 10:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b264f4bc1c959074125cff12f6e92cf1c99e7da3\">[20311]</a></span>: Committing Merged changes <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Dec-20 11:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/db67cec60113f499cae2e6408552bdc646b9ab4f\">[19808]</a></span>: Sandbox Manager changes: communication between Startd and external startd client now takes place -- exchange of Sandbox information ( <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span> )  (By Cathrin Weiss )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Nov-09 14:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1552aec45fc82a245b02cbcfc5ef39db51f500e8\">[19352]</a></span>: Added details to some of the sandbox manager classes. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>  (By Parag Mhashilkar )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Oct-29 12:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9a399b9ea294b5a5883d68121935e41e466adca6\">[19265]</a></span>: Skeleton classes for sandbox_manager and sandbox along with a tool for unit testing (ticket <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=1742\" onclick=\"get_ticket_and_populate_wrapper('1742'); return false;\" title=\"Create a sandbox manager to decouple transfers from job completion\">#1742</a></span>) (By Parag Mhashilkar )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Dec-17 14:00", "status": "defer", "created": "2010-Oct-29 11:50", "fixed_version": "2010-Oct-29 11:50", "broken_version": "v070000", "priority": "2", "subsystem": "", "assigned_to": "zmiller", "derived_from": "", "creator": "cweiss", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu, zmiller@cs.wisc.edu, parag@fnal.gov", "due_date": "20110429"}