{"id": 6817, "title": "Ticket #6817: Invoking python bindings as root changes euid to condor", "description": "<blockquote>\n<span class=\"subsection\"><h3>Bug description and reproduction</h3></span>\n\n<p>If a process running as root invokes the HTCondor Python bindings, the effective user id might change to user 'condor' (or to whatever uid is specified in the environment variable CONDOR_IDS).\n\n</p><p>While this behavior is not a security problem per-se, because the privilege is being reduced instead of escalated, it is certainly unexpected.\n\n</p><p>Here is a simple way to demonstrate the problem... just run python as root, invoke a common API binding, and observe the change in euid:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">[root@localhost build_880]# python\nPython 2.7.5 (default, Jul 13 2018, 13:06:57)\n[GCC 4.8.5 20150623 (Red Hat 4.8.5-28)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; import os\n&gt;&gt;&gt; import htcondor\n&gt;&gt;&gt; os.geteuid()\n0\n&gt;&gt;&gt; htcondor.enable_log()\n&gt;&gt;&gt; os.geteuid()\n994\n</pre></div>\n\n\n<p><span class=\"subsection\"></span></p><h3>Mitigation in this ticket</h3>\n\n<p>While we have discussed potential fixes that are more systemic, this ticket will implement a minimally obtrusive fix for the stable series in order to reduce the chance of regressions.  Specifically, we will introduce a method that causes all set_priv calls to be ignored (just as if the process is running without root access), and the utility library will default to this state.  HTCondor daemons will explicitly enable priv switching in the utility library when they start up, but other processes (python and tools) will run with it disabled.\n\n</p><p><span class=\"subsection\"></span></p><h3>Possible immediate work-around</h3>\n\n<p>If using a version of the HTCondor python bindings earlier v8.8.0 and unable to upgrade (realize only the bindings need to be upgraded, not the HTCondor daemons themselves), a potential workaround for this bug would be for the caller to set environment variable CONDOR_IDS='0.0', which tells the bindings that the euid of user 'condor' is 0.  Behold:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">[root@localhost release_dir]# python\nPython 2.7.5 (default, Jul 13 2018, 13:06:57)\n[GCC 4.8.5 20150623 (Red Hat 4.8.5-28)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; import htcondor\n&gt;&gt;&gt; import os\n&gt;&gt;&gt; os.environ['CONDOR_IDS']='0.0'\n&gt;&gt;&gt; htcondor.enable_log()\n&gt;&gt;&gt; os.geteuid()\n0\n&gt;&gt;&gt; htcondor.version()\n'$CondorVersion: 8.7.9 Jul 31 2018 BuildID: 446081 $'\n&gt;&gt;&gt;\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2018-Nov-19 16:33:42 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : <span class=\"chng\"><a href=\"chngview?cn=55766\">[55766]</a></span> seems like a hack on a hack.  The fix should be that the priv switching code will not switch until the daemon core tells it that it is ok for it to do so.  This should happen early in daemon_core_main.  Priv switching should be never be something that the python htcondor module can either enable disable.\n\n<p></p><hr/>\n<em>2018-Nov-19 22:13:41 by tim:</em> <br/>\n\nThis solution breaks HTCondor CE. And the hack to try to get it to work in daemons does not do the job either.\n\n<p></p><hr/>\n<em>2018-Nov-20 14:56:05 by johnkn:</em> <br/>\n\ncommit <span class=\"chng\"><a href=\"chngview?cn=55792\">[55792]</a></span> disables all priv switching in the utility library by default, and adds a new function that daemons (primarily daemon_core) can use to enable it.  For python and tools, priv switching will remain disabled for the life of the process.\n\n<p></p><hr/>\n<em>2018-Dec-12 14:00:58 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The changes in <span class=\"chng\"><a href=\"chngview?cn=55792\">[55792]</a></span> and <span class=\"chng\"><a href=\"chngview?cn=55829\">[55829]</a></span> look good.\n\n</p><p></p><hr/>\n<em>2018-Dec-12 14:12:50 by jfrey:</em> <br/>\n\nThe following issues are still unresolved, and probably require additional changes. They should get their own tickets if we're concerned about them.\n\n<p></p><ul>\n<li>Python bindings run as root no longer authenticate as the 'condor' user under auth methods FS and REMOTE_FS. This can lead to unexpected authentication failures.\n</li><li>Tools started as root can end up trapped in 'condor' priv. One trigger is using auth method FS or REMOTE_FS.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Dec-04 10:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55829\">[55829]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>, enable priv switching for condor tools that send commands to daemons  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-20 14:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55792\">[55792]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>, disable all priv switching until daemon initialization. this has the effect of permanently disabling priv switching in tools and other non-daemon-core processes like python.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-20 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55789\">[55789]</a></span>: Revert \"Do not change effectuve uid when using python bindings. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>\" This reverts commit 8c3681f381b97cebe4620cdad5f599c9f1f6d543.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-20 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55788\">[55788]</a></span>: Revert \"Do not disable priv switching in a daemonCore daemon. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>\" This reverts commit 7bb508f4065a7c264921023837793e9a40f0b8c7.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-20 10:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55787\">[55787]</a></span>: Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>) Make uids compile for test with a fake daemonCore pointer.\" This reverts commit 3545cc22df91b49080b9f2bd85809b59632f2341.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-16 19:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55769\">[55769]</a></span>: Revert \"(<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>) Ugh, only fake daemonCore pointer when there is none\" This reverts commit 71e6fbac12e5cf05f21b88eb43ad1fa7a242e265.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-16 18:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55768\">[55768]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>) Ugh, only fake daemonCore pointer when there is none  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-16 18:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55767\">[55767]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>) Make uids compile for test with a fake daemonCore pointer.  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-16 17:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55766\">[55766]</a></span>: Do not disable priv switching in a daemonCore daemon. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span> The Python bindings want to disable priv switching in the case they are being used in a client, but NOT in the case the bindings are used by a daemon (ie using COLLECTOR_PLUGIN_PYTHON_MODULES).  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-09 07:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55695\">[55695]</a></span>: Documentation for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Nov-09 07:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=55694\">[55694]</a></span>: Do not change effectuve uid when using python bindings. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6817\" onclick=\"get_ticket_and_populate_wrapper('6817'); return false;\" title=\"Invoking python bindings as root changes euid to condor\">#6817</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Dec-19 10:51", "status": "resolved", "created": "2018-Nov-08 19:04", "fixed_version": "2018-Nov-08 19:04", "broken_version": "v080600", "priority": "3", "subsystem": "PythonBinding", "assigned_to": "jfrey", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "fermi", "visibility": "public", "notify": "tannenba@cs.wisc.edu fkhan@fnal.gov", "due_date": ""}