{"id": 6321, "title": "Ticket #6321: condor_annex status", "description": "<blockquote>\nMiron feels that <code>condor_annex status</code> is less confusing than <code>condor_status -annex</code>, so we should certainly implement the former and possibly remove the latter.  We've also agreed that the unit of interest in annexes is the instance, so the default format should report on that basis.  So far, so easy a pass-through (just add <code>-annex -compact</code>, or <code>-const ... -compact</code>, since <code>condor_status</code> just ANDs together multiple <code>-const</code> flags).\n\n<p>However, the <em>current</em> <code>condor_annex -status</code> also reports on instances in the annex but not in the pool; this is valuable and should not be lost.  So we have to decide how to include this information in the output.</p></blockquote>", "remarks": "<blockquote>\n<em>2017-Jun-27 16:42:50 by tlmiller:</em> <br/>\n\nThe first implementation should probably just invoke <code>condor_status</code> and pass the appropriate arguments through (including most of <code>condor_annex</code> 's).  The missing instances summary should probably be printed at the bottom, so we'd have to fork() rather than exec().  Once <code>condor_status</code> was done, <code>condor_annex</code> would contact EC2 to get the full list of annex instances, and then (have to) contact the collector a second time to get the list of instances in the pool to find the difference (since it couldn't depend on the output format).\n\n<p>One way to avoid making the second collector query would be to enforce the <code>condor_status</code> output format, so that <code>condor_annex</code> could parse it (before printing it out).  This would require people who want better formatting control to use <code>condor_status</code> for that and then call <code>condor_annex</code> for the missing instances summary; even an option to suppress the per-instance data would be still result in two queries being made, so this is distinctly suboptimal.\n\n</p><p>Discussion with TJ revealed four other options:\n\n</p><p></p><ol>\n<li>Call <code>condor_status</code> and get a fixed format output on standard error, but the usual output on standard out; <code>condor_annex</code> could then parse the standard error, instead.  The fixed format could be a compile-time constant, or supplied on the command line (before the other options); in either case, once set, those options would have to be immutable by further command-line options.  Probably not useful for anyone else.\n\n<p></p></li><li>As above, except that the fixed format is printed on standard out, separated from the usual output with a well-known (or given) separator.  This would probably be a little easier to program in <code>condor_annex</code>, but not any more useful.\n\n<p></p></li><li>Pass the data from EC2 about an annex's instances to <code>condor_status</code> via stdin and use a custom summary/footer format function (the ability to specify such does not presently exist) to read from it, compute the difference, and print the summary.  Extremely specific to <code>condor_annex</code>, except, potentially, the part about specifying custom footers.\n\n<p></p></li><li>Extend <code>condor_status</code> with a 'merge' mode: accept ads on standard in, and from the query, and a join condition.  Print three differently-formatted outputs: those ads which were in both the \"left\" and \"right\" sets of ads; those ads only from standard in, and those ads only from the query.  (Be sure to allow for the null format, which prints nothing.)  This would be of general interest and use.  <code>condor_annex</code> would synthesize ads for instances it found and feed them to <code>condor_status</code> 's standard in, specifying the join condition as the <code>AnnexName</code> attribute.\n</li></ol>\n\n<p></p><hr/>\n<em>2017-Jun-28 14:16:01 by tlmiller:</em> <br/>\n\nA use case for point 4:\n\n<p>A user reported (to GregT and/or TJ) that some accounting ads were missing from the list in the collector.  These ads, were, however, available directly from the negotiator, so something like\n\n</p><p></p><div class=\"term\">\n<pre class=\"term\">$ condor_user_prio -negotiator | condor_status -any -const 'MyType == \"Accounting\"' -merge:left-only\n</pre></div>\n\n\n<p>would have been handy to have (where the default join condition would have to be on the Name attribute).\n\n</p><p></p><hr/>\n<em>2017-Jul-03 14:49:57 by tlmiller:</em> <br/>\n\nSince 'condor_annex status' should report on instances that aren't currently in the pool, we need some way to identify those instances.  That is, #6313's third point is actually relevant.\n\n<p>While I'm OK with telling the user not to use an annex name as a client token prefix (that is, ignoring the possibility of mistaken identity when dealing with a name annex), I'm less happy about pulling in any instance (or spot fleet request) which matches the pattern &lt;name&gt;_&lt;guid&gt;, since it seems a pretty obvious one to use.\n\n</p><p>Luckily, all instances can be tagged (max of 50 tags), and since AWS reserves the 'aws:' key prefix for itself, it makes sense to say that our users shouldn't tag things with 'htcondor:AnnexName', and use that, instead.\n\n</p><p>Unluckily, while we can tag at creation time for on-demand instances, we can't yet do so via a spot fleet request.  However, we have reason to believe that this feature will be forthcoming, probably later this year.  So for now, only report on-demand instances that are missing from the collector (and note that the report doesn't include spot instances).\n\n</p><p></p><hr/>\n<em>2017-Aug-16 19:31:49 by tlmiller:</em> <br/>\n\nDon't forget to update clouds/aws.tex when this work is done to reflect the change to using on-creation tags for both on-demand and SFR instances.\n\n<p>Also, don't forget to remove the mention of the v8.7.3 bug w.r.t. SFR instances and condor_annex -status without an annex name when creating the v8.7.4 Wiki pages.\n\n</p><p></p><hr/>\n<em>2017-Aug-28 15:33:14 by tlmiller:</em> <br/>\n\n<div class=\"term\">\n<pre class=\"term\">$ condor_user_prio -negotiator -l -modular | condor_status -any -const 'MyType == \"Accounting\"' -merge\nThe following ads were found in both the left and right -hand ads:\nMyType             TargetType         Name\n\nAccounting         none               &lt;none&gt;\n\nThe following ads were found only in the left-hand ads:\nMyType             TargetType         Name\n\nNone               None               tlmiller@azaphrael.org\n</pre></div>\n\n\n<p></p><hr/>\n<em>2017-Aug-29 15:58:40 by tlmiller:</em> <br/>\n\nFuture work: add a flag so <code>condor_status</code> only outputs left, right, or both.\nWhile a <code>-left-summary</code> flag for <code>condor_status</code> would be interesting and perhaps welcome for <code>condor_annex status</code>, for now I think we need to to include all of the instance IDs in the output, which we can't do in <code>condor_status</code> without generic aggregation operators.\n\n<p></p><hr/>\n<em>2017-Aug-29 16:02:54 by tlmiller:</em> <br/>\n\nDocumentation note: say something along the lines of\n\n<p>\"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AnnexInstance\" title=\"Annex Instance\">AnnexInstance</a></span> ads aren't real Machine ads, so some options you may know from <code>condor_status</code> will behave unexpectedly.  The following options are known to work, although they don't change the presentation of the missing instances: <code>-af</code>, <code>-compact</code>, <code>-json</code>, and <code>-xml</code>.\"\n\n</p><p>Consider checking other, more-useful, options from the list in <code>condor_status -help</code>.\n\n</p><p></p><hr/>\n<em>2017-Sep-04 18:00:40 by tlmiller:</em> <br/>\n\nAs TJ points out, <code>condor_status -merge</code> should take a file argument so that we don't break things when we change it later.\n\n<p></p><hr/>\n<em>2017-Oct-25 16:30:54 by tim:</em> <br/>\n\n<strong>Doc review:</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-15 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52363\">[52363]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-12 16:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52338\">[52338]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Fix -merge -json and -merge -xml to both do something sane.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-12 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52329\">[52329]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Add -merge to -help.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-12 11:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52327\">[52327]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Include the totals for the left and right -only tables. Change the separator text to be match the pending documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-05 14:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52253\">[52253]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Implement [-merge &lt;file&gt;] for condor_status.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Sep-05 13:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52250\">[52250]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Version history entry.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-31 13:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52228\">[52228]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Add the redundant totals line back in; some users might (and our tests do) depend on it, because there's no other way to get those numbers yet.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-30 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52220\">[52220]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Stupider compilers.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-28 15:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52189\">[52189]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Clean up -compact machinery, make -merge less obscure when used for debugging.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-28 12:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52188\">[52188]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Pass the -annex-name flag from annex to status to avoid misleading negatives. Reorder the difference output so that the left-most column is the sorted one.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-28 12:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52187\">[52187]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Only block on stdin if we're doing a -merge.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-25 21:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52183\">[52183]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Unbreak 'condor_status -annex'. Fix 'condor_annex status -af ...'.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-25 20:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52182\">[52182]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) First pass at 'condor_status -merge' and using it to implement 'condor_annex status'.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-16 18:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52163\">[52163]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Purge old SFR-specific code now that SFR instance tagging on creation works.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Aug-16 10:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=52162\">[52162]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Tag all instances created by the SFR with the same tag we use for on-demand instances.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-11 06:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51851\">[51851]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Fix Fedora compiler warning  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-10 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51850\">[51850]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Fix Fedora compiler warnings.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-10 10:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51846\">[51846]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Missed a spot in 8e88febc.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-06 16:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51845\">[51845]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Fix problems with SFRs and condor_annex -status (w/ and w/o -annex). (Better to over- than under- report.)  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-05 21:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51844\">[51844]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Implement 'condor_annex -status -classad', including audit logging.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-05 17:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51843\">[51843]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Add audit log to human-readable summary. Still need to add classads format for when an annex isn't specified.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-05 17:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51842\">[51842]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Add the NAME STATUS INSTANCES table to the summary. Not clear if it should be a table or just a series of lines. Still need to add auditing and classads implementation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jul-05 17:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=51841\">[51841]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6321\" onclick=\"get_ticket_and_populate_wrapper('6321'); return false;\" title=\"condor_annex status\">#6321</a></span>) Pass 'condor_annex status' through to 'condor_status -annex -compact'. Update 'condor_annex -status' to permit operation without an annex name, using tags (on-demand instances only until a new AWS feature arrives). Add new output format (summary) for 'condor_annex -status' w/o an annex name prepatory\u00a0[...]\n (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Oct-25 16:30", "status": "resolved", "created": "2017-Jun-27 11:08", "fixed_version": "2017-Jun-27 11:08", "broken_version": "v080702", "priority": "2", "subsystem": "Annex", "assigned_to": "tlmiller", "derived_from": "#6111", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu", "due_date": ""}