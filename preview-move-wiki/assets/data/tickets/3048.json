{"id": 3048, "title": "Ticket #3048: Condor fails to write abort event after system_periodic_remove", "description": "<blockquote>\nWe're seeing a large LHC Condor site having issues with events missing from the user log.  Because Globus solely uses the user log to get notification of user events, it's causing large inconsistencies between Globus and Condor.  Because the pilot factories stop submitting when there are a sufficient number of idle jobs in queue (and the user log only contains the submit event), this causes the pilot factory to stop submitting and the site to idle.\n\n<p>This is high-priority for OSG, as it is stopping production at the site.\n\n</p><p>Jaime knows most of the details.  I did some detective work and found the following.\n\n</p><p></p><div class=\"verbatim\">\n<pre>06/08/12 10:35:53 (pid:542544) WriteUserLog Failed to convert event type # 9 to classAd.\n06/08/12 10:35:53 (pid:542544) WriteUserLog: user doWriteEvent()!\n06/08/12 10:35:53 (pid:542544) Unable to log ULOG_JOB_ABORTED event for job 1727620.0\n06/08/12 10:35:53 (pid:542544) Failed to write abort event to the user log\n06/08/12 10:35:53 (pid:542544) Job 1727620.0 aborted: The system macro SYSTEM_PERIODIC_REMOVE expression '(User =!= \"XXXX@YYYY\" &amp;&amp; (JobStatus == 2) &amp;&amp; (CurrentTime - EnteredCurrentStatus &gt; 3600) &amp;&amp; ((RemoteSysCpu + RemoteUserCpu) &lt; 61)) || (JobStatus == 1 &amp;&amp; CumulativeSlotTime &gt; 0) || (JobStatus == 5)' evaluated to TRUE\n06/08/12 10:35:53 (pid:542544) WriteUserLog Failed to convert event type # 9 to classAd.\n06/08/12 10:35:53 (pid:542544) WriteUserLog: user doWriteEvent()!\n06/08/12 10:35:53 (pid:542544) Unable to log ULOG_JOB_ABORTED event for job 1727623.0\n</pre></div>\n\n\n<p>I'm on vacation right now, so may not be able to provide follow-ups.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Jun-08 11:03:01 by bbockelm:</em> <br/>\n\nMore relevant logs from that job:\n\n<p></p><div class=\"verbatim\">\n<pre>-bash-3.2$ grep 1727620.0 /var/log/condor/SchedLog\n06/08/12 10:31:13 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:31:13 (pid:542544) Canceling request for claim slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1 1727620.0\n06/08/12 10:31:40 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:31:40 (pid:542544) Canceling request for claim slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1 1727620.0\n06/08/12 10:32:14 (pid:542544) Starting add_shadow_birthdate(1727620.0)\n06/08/12 10:32:14 (pid:542544) Started shadow for job 1727620.0 on slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, (shadow pid = 4118086)\n06/08/12 10:32:17 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:32:17 (pid:542544) Shadow pid 4118086 for job 1727620.0 exited with status 108\n06/08/12 10:32:42 (pid:542544) Starting add_shadow_birthdate(1727620.0)\n06/08/12 10:32:42 (pid:542544) Started shadow for job 1727620.0 on slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, (shadow pid = 4118107)\n06/08/12 10:32:42 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:32:42 (pid:542544) Shadow pid 4118107 for job 1727620.0 exited with status 108\n06/08/12 10:33:27 (pid:542544) Starting add_shadow_birthdate(1727620.0)\n06/08/12 10:33:27 (pid:542544) Started shadow for job 1727620.0 on slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, (shadow pid = 4118278)\n06/08/12 10:33:30 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:33:30 (pid:542544) Shadow pid 4118278 for job 1727620.0 exited with status 108\n06/08/12 10:34:34 (pid:542544) Starting add_shadow_birthdate(1727620.0)\n06/08/12 10:34:34 (pid:542544) Started shadow for job 1727620.0 on slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, (shadow pid = 4118892)\n06/08/12 10:34:37 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:34:37 (pid:542544) Shadow pid 4118892 for job 1727620.0 exited with status 108\n06/08/12 10:35:45 (pid:542544) Starting add_shadow_birthdate(1727620.0)\n06/08/12 10:35:45 (pid:542544) Started shadow for job 1727620.0 on slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, (shadow pid = 4118972)\n06/08/12 10:35:45 (pid:542544) Match record (slot2@uct2-c315.mwt2.org &lt;10.1.4.117:54860&gt; for group_atlasanaly.usatlas1, 1727620.0) deleted\n06/08/12 10:35:45 (pid:542544) Shadow pid 4118972 for job 1727620.0 exited with status 108\n06/08/12 10:35:53 (pid:542544) Unable to log ULOG_JOB_ABORTED event for job 1727620.0\n06/08/12 10:35:53 (pid:542544) Job 1727620.0 aborted: The system macro SYSTEM_PERIODIC_REMOVE expression '(User =!= \"usatlas1@osg-gk.mwt2.org\" &amp;&amp; (JobStatus == 2) &amp;&amp; (CurrentTime - EnteredCurrentStatus &gt; 3600) &amp;&amp; ((RemoteSysCpu + RemoteUserCpu) &lt; 61)) || (JobStatus == 1 &amp;&amp; CumulativeSlotTime &gt; 0) || (JobStatus == 5)' evaluated to TRUE\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Jun-08 11:45:15 by bbockelm:</em> <br/>\n\nGot it!\n\n<p>In src/condor_utils/condor_event.cpp, we have this line:\n\n</p><p></p><div class=\"verbatim\">\n<pre>buf2.sprintf(\"Reason = \\\"%s\\\"\", reason);\nif( !myad-&gt;Insert(buf2.Value()) ) return NULL;\n</pre></div>\n\n\n<p><strong>If</strong> the SYSTEM_PERIODIC_REMOVE macro has a double-quote, the value inserted into the classad is not properly escaped and fails.\n\n</p><p>So, this is OK:\n\n</p><p></p><div class=\"verbatim\">\n<pre>SYSTEM_PERIODIC_REMOVE = Foobar =?= True\n</pre></div>\n\n\n<p>but this is NOT OK:\n\n</p><p></p><div class=\"verbatim\">\n<pre>SYSTEM_PERIODIC_REMOVE = (Foobar =?= True) &amp;&amp; (User =?= \"bbockelm@unl.edu\")\n</pre></div>\n\n\n<p>Isn't there a better API for inserting a string value into the classad?\n\n</p><p>There are a few other cases in this file where escaping is not properly done.  In fact, I bet you could get the whole file to be about 1000 lines shorter and more reliable by using std::string and not raw char * handling.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2012-Jun-08 13:28:53 by jfrey:</em> <br/>\n\nThere is a better API. ClassAd::Assign() should be used instead of ClassAd::Insert(). It's safer and should be faster. I'll fix up all the callsites in this file. The file won't get any shorter, though, because I also should add a pile of <code>delete myad</code> to eliminate memory leaks on error.\n\n<p></p><hr/>\n<em>2012-Jun-12 14:42:21 by jfrey:</em> <br/>\n\nThis bug affects other types of events as well. For any event type that contains a string datamember, an event will be dropped if that string contains a double-quote. This only affects logs written in XML, which uses the <code>toClassAd()</code> method.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-13 08:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32298\">[32298]</a></span>: minor edit to 7.8.1 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3048\" onclick=\"get_ticket_and_populate_wrapper('3048'); return false;\" title=\"Condor fails to write abort event after system_periodic_remove\">#3048</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-12 14:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32281\">[32281]</a></span>: Add missing event log entry bug-fix to version history. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3048\" onclick=\"get_ticket_and_populate_wrapper('3048'); return false;\" title=\"Condor fails to write abort event after system_periodic_remove\">#3048</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jun-08 17:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=32264\">[32264]</a></span>: Fix string quoting in user log writing code. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3048\" onclick=\"get_ticket_and_populate_wrapper('3048'); return false;\" title=\"Condor fails to write abort event after system_periodic_remove\">#3048</a></span> The user event log code does sloppy conversions to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span>, slapping double-quotes around string values and calling ClassAd::Insert(). If one of these string values contains a dobule-quote, the Insert fails and the code returns failure without writing\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jun-13 13:25", "status": "resolved", "created": "2012-Jun-08 10:48", "fixed_version": "2012-Jun-08 10:48", "broken_version": "v070600", "priority": "4", "subsystem": "Daemons", "assigned_to": "jfrey", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "", "due_date": ""}