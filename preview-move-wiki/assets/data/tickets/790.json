{"id": 790, "title": "Ticket #790: locking problem between shadows on windows in user job log", "description": "<blockquote>\nWhen multiple shadows are writing to the same log file, the attached failure to lock is observed.  It looks like locks are not being obtained or respected between shadows.</blockquote>", "remarks": "<blockquote>\n<em>2009-Oct-01 06:39:20 by matt:</em> <br/>\n\nHow reproducible is there? What is the recipe for reproducing this?\n\n<p></p><hr/>\n<em>2009-Oct-01 09:48:55 by dharris:</em> <br/>\n\nThe setup we are using in an all windows (XP/vista/server 2008) setup. About 28 CPU's.\n\n<p>The problem occurs when we submit a series of jobs (about 30) that all take the same amount of time to execute (about 10 minutes each).\n\n</p><p>Each jobs writes to a shared log file so that we can utilize condor_wait for our automation purposes.\n\n</p><p>What appears to happen is that sometimes a shadow ignores the lock (or fails to lock) the log file and the file gets garbled and condor_wait will wait forever. This happens with \"job executing on host\" and \"job completed\" messages occur at the same time as well as \"job size updated\", or so it seems.\n\n</p><p>Unfortunately we cannot consistently recreate this issue as it seems to be luck of the draw when messages get written to the log file.\n\n</p><p></p><hr/>\n<em>2009-Oct-02 06:42:20 by matt:</em> <br/>\n\nI wouldn't be surprised if this also broke DAGMan on Windows.\n\n<p></p><hr/>\n<em>2009-Oct-02 06:53:03 by dharris:</em> <br/>\n\nI will DAGMan today and see if it has an issue as well\n\n<p></p><hr/>\n<em>2009-Oct-02 08:57:46 by nleroy:</em> <br/>\n\nDo you have a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShadowLog\" title=\"Shadow Log\">ShadowLog</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddLog\" title=\"Schedd Log\">ScheddLog</a></span> from a window in which this occurred?  Anything unusual logged?  Can you attach a snippet?\n\n<p></p><hr/>\n<em>2009-Oct-19 15:22:45 by dharris:</em> <br/>\n\nI have been trying to get full debug logs for you but unfortunately since I have turned full debug on the issue hasn't occurred. If the issue happens again I will have be able to produce some logs. Sorry for the delay.\n\n<p></p><hr/>\n<em>2009-Oct-19 16:42:13 by zmiller:</em> <br/>\n\ni believe the problem is now understood.  on windows, files are locked using a kernel mutex where the filename is name of the mutex.  however, if relative paths are involved, this can lead to two different names for the same file.  example partial submit file:\n<div class=\"verbatim\">\n<pre>initial_dir = c:\\path\\to\\subdir_foo\nlog = ..\\common.log\nqueue\n\ninitial_dir = c:\\path\\to\\subdir_bar\nqueue\n</pre></div>\n\nin both cases, the actual log file is c:\\path\\to\\common.log.  however, two differently named mutexes are used to \"lock\" the file because condor simply takes initial_dir and concats a forward slash and the log filename (in classad_helpers.cpp:getPathToUserLog).\n\n<p>suggested fix:  call realdir(), GetFullPathName(), or something along those lines before grabbing the mutex to ensure that different references to the same file end up using the same mutex.\n\n</p><p></p><hr/>\n<em>2009-Oct-19 16:44:58 by dharris:</em> <br/>\n\nThat explanation makes sense with regards to our setup.\n\n<p></p><hr/>\n<em>2009-Oct-20 15:45:47 by psilord:</em> <br/>\n\nPatch afc161be5e4564b1bafc5f82bb6c6fffcfeeacd4 causes the test suite to fail to build. I believe that is checkin: <span class=\"chng\"><a href=\"chngview?cn=16123\">[16123]</a></span>\n\n<p></p><hr/>\n<em>2009-Oct-20 15:48:57 by psilord:</em> <br/>\n\nThe failure happen while building <code>x_write_joblog.cpp</code> and it looks like this:\n\n<p></p><div class=\"verbatim\">\n<pre>../condor_c++_util/write_user_log.h: In member function 'bool WriteUserLog::isGlobalEnabled() const':\n../condor_c++_util/write_user_log.h:234: error: 'FALSE' was not declared in this scope\n</pre></div>\n\n\n<p></p><hr/>\n<em>2009-Oct-20 16:04:23 by psilord:</em> <br/>\n\nOk, nick gave me enough hints on how to fix it, I'll have a patch shortly.\n\n<p></p><hr/>\n<em>2009-Oct-20 17:02:27 by tannenba:</em> <br/>\n\nOk, patch pushed to V7_4-branch, should be released w/ Condor v7.4.1. Resolving.\n\n<p></p><hr/>\n<em>2009-Oct-21 09:30:34 by nleroy:</em> <br/>\n\nI updated my test script to reproduce the original problem and verified that the corruption can be reproduced with test_log_writer.  I further verified that with the fixed <span class=\"quote\">FileLock</span>, the corruption does not occur.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/102/locking_log_example.txt\">locking_log_example.txt</a>\n1095 bytes added by alderman on 2009-Sep-29 21:01:27 UTC.\n<br/>\nShort log snippet that shows problem.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-21 14:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25047\">[25047]</a></span>: Documented the fix for gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=790\" onclick=\"get_ticket_and_populate_wrapper('790'); return false;\" title=\"locking problem between shadows on windows in user job log\">#790</a></span>  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-20 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16144\">[16144]</a></span>: Real fix for file locking on Win32 for cases in which two different paths (aka aliases) to the same file are passed to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileLock\" title=\"File Lock\">FileLock</a></span> object. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=790\" onclick=\"get_ticket_and_populate_wrapper('790'); return false;\" title=\"locking problem between shadows on windows in user job log\">#790</a></span>).  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-20 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16143\">[16143]</a></span>: Revert \"Fixed file locking on Win32 for cases in which the path to the\" This reverts commit 015000d78f819c5781d9a77fa5f8166ee7d005e4. (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=790\" onclick=\"get_ticket_and_populate_wrapper('790'); return false;\" title=\"locking problem between shadows on windows in user job log\">#790</a></span>)  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-20 16:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16140\">[16140]</a></span>: Rmoved the symbol FALSE from usage and replaced it with the more c++ usable false keyword. This was needed because this is a user API header file and the FALSE symbol was needing a symbol namespace not available to third parties who wish to compile with this file. Due to this, our test suite failed compilation.\u00a0[...]\n (By Peter Keller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-20 13:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16131\">[16131]</a></span>: Fixed file locking on Win32 for cases in which the path to the file is different (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=790\" onclick=\"get_ticket_and_populate_wrapper('790'); return false;\" title=\"locking problem between shadows on windows in user job log\">#790</a></span>).  (By nleroy )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Oct-19 14:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=16123\">[16123]</a></span>: Ported the user log writer test to Windows (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=790\" onclick=\"get_ticket_and_populate_wrapper('790'); return false;\" title=\"locking problem between shadows on windows in user job log\">#790</a></span>)  (By Nick <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LeRoy\" title=\"Le Roy\">LeRoy</a></span> )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 13:40", "status": "resolved", "created": "2009-Sep-29 15:59", "fixed_version": "2009-Sep-29 15:59", "broken_version": "v070302", "priority": "2", "subsystem": "Daemons", "assigned_to": "nleroy", "derived_from": "", "creator": "alderman", "rust": "", "customer_group": "other", "visibility": "public", "notify": "ialderman@cyclecomputing.com, dharris@cyclecomputing.com,matt@cs.wisc.edu", "due_date": ""}