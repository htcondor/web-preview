{"id": 4143, "title": "Ticket #4143: Python API mangles Requirements expression", "description": "<blockquote>\nWhen you submit jobs via the Python API, there are two problems with the way it updates the Requirements expression.\n\n<p>(1) Requirements on `FileSystemDomain` and/or `HasFileTransfer` are added for all jobs, but they should not be added for scheduler universe jobs.\n\n</p><p>The correct logic is in src/condor_submit.V6/submit.cpp, where check_requirements() doesn't add any file transfer requirements if mightTransfer(JobUniverse) is false. It only returns true for Vanilla, MPI, Parallel, Java and VM universes.\n\n</p><p>However in the Python API, python-bindings/schedd.cpp make_requirements(), the should_transfer_files requirements (stf) are added regardless of universe.\n\n</p><p>(2) When appending to the Requirements expression, the existing requirements expression is not enclosed in parentheses. This means that you can get some silly situations where for example\n\n</p><p></p><pre>    Requirements = true || false\n</pre>\n\n<p>expands to\n\n</p><p></p><pre>    Requirements = true || false &amp;&amp; TARGET.OPSYS == \"LINUX\" &amp;&amp; TARGET.ARCH == \"X86_64\" &amp;&amp; \\\n    ( TARGET.HasFileTransfer || ( TARGET.FileSystemDomain == MY.FileSystemDomain ) ) &amp;&amp; \\\n    TARGET.Disk &gt;= RequestDisk &amp;&amp; TARGET.Memory &gt;= RequestMemory\n</pre>\n\n<p>and because &amp;&amp; binds more tightly than ||, the additional requirements are cancelled.\n\n</p><p>This behaviour is currently used as a workaround for problem (1):\n<a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/htcondor-users/2013-December/msg00104.shtml\">https://lists.cs.wisc.edu/archive/htcondor-users/2013-December/msg00104.shtml</a>\nso better not fix this before fixing (1).\n\n</p><p>The main driver for fixing (1) is so that you can submit DAGs programmatically. More discussion at\n<a class=\"external\" href=\"https://lists.cs.wisc.edu/archive/htcondor-users/2013-December/msg00108.shtml\">https://lists.cs.wisc.edu/archive/htcondor-users/2013-December/msg00108.shtml</a> and the thread containing it.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "defect", "last_change": "2013-Dec-30 10:05", "status": "new", "created": "2013-Dec-30 10:05", "fixed_version": "2013-Dec-30 10:05", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "", "derived_from": "", "creator": "b.candler", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}