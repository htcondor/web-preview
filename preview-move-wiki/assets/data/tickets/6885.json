{"id": 6885, "title": "Ticket #6885: Allow multifile uploads", "description": "<blockquote>\nThe multi-file transfer plugins provide a richer communication mechanism between the file transfer object and the plugins; we have declared in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6859\" onclick=\"get_ticket_and_populate_wrapper('6859'); return false;\" title=\"End-game for introducing the multifile_curl_plugin\">#6859</a></span> that we want this to replace the single-file plugin as the default mechanism.\n\n<p>The biggest missing piece in the multifile setup in terms of functionality is the ability to upload (e.g., stageout for the <code>condor_starter</code>) using multifile plugins.  This is the ticket to track that work.\n\n</p><p>I propose to keep the existing wire protocol.  Instead of doing the transfers in the order provided by the user, we will first sort transfers to group all the files using the same plugin.  As we loop through files, instead of immediately performing the transfer, we will build up a TODO list of \"deferred\" transfers.\n\n</p><p>Each time we hit a transfer incompatible with the current set of deferred transfers (or make it through the complete transfer list), we will execute the multifile plugin and send all the corresponding communication to the DoDownload-side.  Here, \"transfer incompatible\" is any time where we change the protocol (http to https) <em>or</em> if the binary protocol requires us to do a round-trip and synchronize (see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6884\" onclick=\"get_ticket_and_populate_wrapper('6884'); return false;\" title=\"Do not perform a network turnaround for each file transfer\">#6884</a></span>; we have been recently surprised that for the last 9 years we <strong>always</strong> do a round-trip per file and plan to fix this).</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-09 10:19:21 by bbockelm:</em> <br/>\n\nThis is pushed as\n\n<p><a class=\"external\" href=\"https://github.com/bbockelm/htcondor/tree/V8_9-multifile-upload\">https://github.com/bbockelm/htcondor/tree/V8_9-multifile-upload</a>\n\n</p><p>Waiting on <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6876\" onclick=\"get_ticket_and_populate_wrapper('6876'); return false;\" title=\"Support output file remaps for URLs\">#6876</a></span> before pushing it to gittrac as gittrac doesn't allow force-pushes for rewriting history.\n\n</p><p></p><hr/>\n<em>2019-Feb-15 12:31:07 by tannenba:</em> <br/>\n\nMerged to master after a clean build/test run through BaTLab (build ID 461232)\n\n<p></p><hr/>\n<em>2019-Apr-10 14:52:36 by coatsworth:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p></p><ul>\n<li>The title of this ticket is inconsistent with the description. I don't see anything in the description about uploads. Please update it to better describe the actual work being done here.\n</li><li>file_transfer.cpp:3154 Should reference <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InvokeMultiUploadPlugin\" title=\"Invoke Multi Upload Plugin\">InvokeMultiUploadPlugin</a></span>, not <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DoUpload\" title=\"Do Upload\">DoUpload</a></span>\n</li><li>file_transfer.cpp:3351 Should use DIR_DELIM_CHAR\n</li><li>file_transfer.cpp:3641 What happens here if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InvokeMultiUploadPlugin\" title=\"Invoke Multi Upload Plugin\">InvokeMultiUploadPlugin</a></span> returns 0?\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Apr-11 12:52:39 by bbockelm:</em> <br/>\n\n<ul>\n<li>The title of this ticket is inconsistent with the description. I don't see anything in the description about uploads. Please update it to better describe the actual work being done here.\n<ul>\n<li>Done.\n</li></ul>\n</li><li>file_transfer.cpp:3154 Should reference <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InvokeMultiUploadPlugin\" title=\"Invoke Multi Upload Plugin\">InvokeMultiUploadPlugin</a></span>, not <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DoUpload\" title=\"Do Upload\">DoUpload</a></span>\n<ul>\n<li>Done.\n</li></ul>\n</li><li>file_transfer.cpp:3351 Should use DIR_DELIM_CHAR\n<ul>\n<li>No, this is not a path, it is a URL.  Forward slash is always correct for URL components.\n</li></ul>\n</li><li>file_transfer.cpp:3641 What happens here if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InvokeMultiUploadPlugin\" title=\"Invoke Multi Upload Plugin\">InvokeMultiUploadPlugin</a></span> returns 0?\n<ul>\n<li>I don't understand this comment.  Did you get the incorrect line number?  This is currently a dprintf statement that appears unrelated to upload plugins.\n</li></ul>\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Apr-12 11:47:59 by coatsworth:</em> <br/>\n\nThanks for correction on the URL, somehow I missed that.\n\n<p>As for the last comment, I'm referencing line numbers as seen here: <a class=\"external\" href=\"https://github.com/bbockelm/htcondor/blob/V8_9-multifile-upload/src/condor_utils/file_transfer.cpp\">https://github.com/bbockelm/htcondor/blob/V8_9-multifile-upload/src/condor_utils/file_transfer.cpp</a>\n\n</p><p>At lines 3465-3478, you check if <code>InvokeMultiUploadPlugin()</code> returns either -1 and 0, since these are both valid error codes meaning different things.\n\n</p><p>However at lines 3639-3641, you only check if <code>InvokeMultiUploadPlugin()</code> returns -1. I don't know if you care about a 0 error code, but I assumed if you care about it somewhere else then it probably matters here.\n\n</p><p></p><hr/>\n<em>2019-Apr-15 08:25:18 by bbockelm:</em> <br/>\n\nChatted with Mark on Friday to resolve the last point -\n\n<p></p><ul>\n<li>file_transfer.cpp:3641 What happens here if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InvokeMultiUploadPlugin\" title=\"Invoke Multi Upload Plugin\">InvokeMultiUploadPlugin</a></span> returns 0?\n<ul>\n<li>This case is checked in the ternary operator a few lines later.\n</li></ul>\n</li></ul>\n\n<p>With that, I think I have addressed all the review comments.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6884\" onclick=\"get_ticket_and_populate_wrapper('6884'); return false;\" title=\"Do not perform a network turnaround for each file transfer\">#6884</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDo not perform a network turnaround for each file transfer</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6886\" onclick=\"get_ticket_and_populate_wrapper('6886'); return false;\" title=\"Improve multifile curl plugin to allow uploads\">#6886</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove multifile curl plugin to allow uploads</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-11 12:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b3e95e8cf7fcdcfc975e4f8d772928a2e095e57d\">[56567]</a></span>: Fix function name in dprintf statement. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 15:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/74c2d5d8586f6c728a4eca063f4ac8ab6f69f9fd\">[56193]</a></span>: Fix another build error on Fedora. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 14:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4ff652f8118d1536116178f65e90f19c6ebbb154\">[56191]</a></span>: Use signed size_t cuz <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InvokeMultiFileUploadPlugin\" title=\"Invoke Multi File Upload Plugin\">InvokeMultiFileUploadPlugin</a></span> can return -1 on fail. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-14 14:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/107d0c769bc708a4f9efe8d58ffa33daf4258a18\">[56188]</a></span>: Fix compiler errors and warnings across fedora and windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 17:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fe6f999192289380b6f5c9ce5a62502f35166516\">[56180]</a></span>: Add more documentation for the next maintainer. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 16:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a33689058b9a3cc86f6f8eb0eb4703ec4e8d24d6\">[56178]</a></span>: Finish deferral of the multi-file transfers. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span> This allows the Uploader to defer sending the multifile transfer upload summaries, allowing a single invocation of the plugin to be used for multiple file transfers.\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1d2807b7077c52c2cc49a19c68ddb4002e628469\">[56177]</a></span>: Tweak the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransferItem\" title=\"File Transfer Item\">FileTransferItem</a></span> object to allow upload URL sorting. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span> With this, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=FileTransferItem\" title=\"File Transfer Item\">FileTransferItem</a></span> tracks source and destination URLs separately and sorts accordingly:\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f284f4e5bc6635fcb61b9e4d2c138dcaa2fdb53c\">[56176]</a></span>: Start working the file transfer to support multi-file uploads. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e1c7816851c80a55a648ff06dc256f13b9da8855\">[56175]</a></span>: Have transfer begin / end as time_t. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span> The beginning and end of transfers should be done in seconds in order to preserve accuracy. Total time elapsed should be the only thing kept in double-accuracy.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b207c60fc0c85f55d4b7d60d2e5b50c960a06555\">[56174]</a></span>: Invoke the multifile plugin for upload. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a439c51c465d72b2b0ad7d55a5bad4a48985957\">[56173]</a></span>: Sort the file transfer list. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Feb-12 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8372739b6b6ae73e8092ac360dcc9e794ff209d2\">[56172]</a></span>: Minor modernization of the file transfer object. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6885\" onclick=\"get_ticket_and_populate_wrapper('6885'); return false;\" title=\"Allow multifile uploads\">#6885</a></span> - Make the file transfer item into a more C++-like object. - Centralize all the \"special integers\" into an enum.  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-Apr-15 15:00", "status": "resolved", "created": "2019-Jan-30 15:00", "fixed_version": "2019-Jan-30 15:00", "broken_version": "", "priority": "3", "subsystem": "FileTransfer", "assigned_to": "bbockelm", "derived_from": "#6859", "creator": "coatsworth", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelman@morgridge.org tannenba@cs.wisc.edu", "due_date": ""}