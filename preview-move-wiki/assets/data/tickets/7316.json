{"id": 7316, "title": "Ticket #7316: Poor performance from curl_plugin", "description": "<blockquote>\nI noticed very poor performance when downloading a file using the <code>curl_plugin</code>.  Notably, while the transfer was going at O(10 MB/s), the process was pegged at 100% CPU utilization -- way below the capabilities of <code>curl</code>.\n\n<p>Unfortunately, it appears we got hit by this bug:\n\n</p><p><a class=\"external\" href=\"https://github.com/curl/curl/commit/cacdc27f52\">https://github.com/curl/curl/commit/cacdc27f52</a>\n\n</p><p>(which is not patched in RHEL7), which causes significant performance degradation / significant CPU utilization when low speed timeouts are used.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Oct-18 13:27:49 by coatsworth:</em> <br/>\n\nThe bug was patched in newer versions of libcurl. Brian suggested that we add a version check before setting the low-speed timeouts, similar to what xrootd does here:\n\n<p><a class=\"external\" href=\"https://github.com/xrootd/xrootd/blob/51fe860af8007e4541c17d6f189db027c6bbcc22/src/XrdTpc/XrdTpcState.cc#L75-L82\">https://github.com/xrootd/xrootd/blob/51fe860af8007e4541c17d6f189db027c6bbcc22/src/XrdTpc/XrdTpcState.cc#L75-L82</a>\n\n</p><p>A more robust solution would be to use callbacks to abort the transfer if it's taking too long, but that's too big a change to squeeze in post code-freeze. So for now we're using the version check, and expect to implement the full fix into the 8.9.5 release.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7414\" onclick=\"get_ticket_and_populate_wrapper('7414'); return false;\" title=\"Use callbacks to implement curl_plugin timeout\">#7414</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nUse callbacks to implement curl_plugin timeout</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-25 13:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/58b97b77c40bfccabe837f3865963b59b76aee47\">[58272]</a></span>: Added version history (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7316\" onclick=\"get_ticket_and_populate_wrapper('7316'); return false;\" title=\"Poor performance from curl_plugin\">#7316</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Oct-18 13:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0f6b2c5f5079abb713ce61d4c81f5a02e450e983\">[58203]</a></span>: Added version check to avoid curl_plugin low speed timeout bug (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7316\" onclick=\"get_ticket_and_populate_wrapper('7316'); return false;\" title=\"Poor performance from curl_plugin\">#7316</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Oct-25 13:38", "status": "resolved", "created": "2019-Oct-10 14:19", "fixed_version": "2019-Oct-10 14:19", "broken_version": "", "priority": "2", "subsystem": "FileTransfer", "assigned_to": "coatsworth", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "bbockelman@morgridge.org tannenba@cs.wisc.edu", "due_date": ""}