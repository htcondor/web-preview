{"id": 4456, "title": "Ticket #4456: Shared port daemon steadily leaking file descriptors", "description": "<blockquote>\nWhen SharedPortClient::PassSocket() invokes SharedPortState::Handle() in non-blocking mode, the unix domain socket created by <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortState\" title=\"Shared Port State\">SharedPortState</a></span> is never closed(). This happens when the shared_port daemon sends a child-alive message to the master. Consequently, the share_port daemon leaks a file descriptor every 20 minutes. With the default 1024 fd limit, the daemon run out of fds and crash after 13 days.\n\n<p>The fix is to delete the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> containing the unix domain socket when SharedPortState::Handle() is done and is in blocking mode.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Aug-06 14:33:15 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Patch looks good, thanks.  Would be nice if <code>DaemonCore::SocketIsRegistered()</code>\ndid not do a linear probe, but that is a different issue.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/835/shared_port_leak.patch\">shared_port_leak.patch</a>\n473 bytes added by jfrey on 2014-Jul-09 20:44:03 UTC.\n<br/>\nPatch for shared_port dameon fd leak<br/>\n</li><li><a href=\"../files/836/share_port_leak2.patch\">share_port_leak2.patch</a>\n530 bytes added by jfrey on 2014-Jul-10 14:25:31 UTC.\n<br/>\nImproved patch for shared port daemon leaking file descriptors<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 15:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f03eacf36697d3104dd0460310c941054a114b5f\">[40645]</a></span>: Fix file descriptor leak in condor_shared_port. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4456\" onclick=\"get_ticket_and_populate_wrapper('4456'); return false;\" title=\"Shared port daemon steadily leaking file descriptors\">#4456</a></span> <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortState\" title=\"Shared Port State\">SharedPortState</a></span> assumes <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> will clean up the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> and FD used to pass a socket FD to a daemon. This only happens when the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span> was registered with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> (when <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortState\" title=\"Shared Port State\">SharedPortState</a></span> is in non-blocking mode). If <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SharedPortState\" title=\"Shared Port State\">SharedPortState</a></span> hasn't\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Aug-06 14:34", "status": "resolved", "created": "2014-Jul-09 15:41", "fixed_version": "2014-Jul-09 15:41", "broken_version": "v080104", "priority": "4", "subsystem": "DaemonSharedP", "assigned_to": "tannenba", "derived_from": "#4094", "creator": "jfrey", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "", "due_date": ""}