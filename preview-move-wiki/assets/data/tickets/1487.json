{"id": 1487, "title": "Ticket #1487: document config knob MAX_ACCEPTS_PER_CYCLE", "description": "<blockquote>\nFrom condor-users:\n<div class=\"verbatim\">\n<pre>Could you explain these variables a bit?  I can't find  MAX_ACCEPTS_PER_CYCLE in the condor manual, and a google search only turns up this:\n\nhttps://condor-wiki.cs.wisc.edu/index.cgi/tktview?tn=1348\n\nI gather it has something to do with a shadow persisting after a job exits, and continuing as a shadow for the next job on the resource, vs. just having the shadow exit and respawn for the next job.\n\nPeter\n\n\nOn Jul 1, 2010, at 13:30 , Timothy St. Clair wrote:\n\n&gt; Peter &amp; Dan -\n&gt;\n&gt;     If you're aiming for performance gains that may have a counter affect.\n&gt; You will also want to set MAX_ACCEPTS_PER_CYCLE=4.\n&gt;\n&gt; Cheers,\n&gt; Tim\n&gt;\n&gt; On Thu, 2010-07-01 at 11:22 -0400, Peter Doherty wrote:\n&gt;&gt; Thanks Dan, that did the trick.\n&gt;&gt;\n&gt;&gt; As always, lightning quick diags and solutions.\n&gt;&gt;\n&gt;&gt; Best,\n&gt;&gt; Peter\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; On Jul 1, 2010, at 04:28 , Dan Bradley wrote:\n&gt;&gt;\n&gt;&gt;&gt; Peter,\n&gt;&gt;&gt;\n&gt;&gt;&gt; Please try the following configuration setting:\n&gt;&gt;&gt;\n&gt;&gt;&gt; SHADOW_WORKLIFE = 0\n&gt;&gt;&gt;\n&gt;&gt;&gt; Based on your report, I reproduced the problem in 7.5.3 and\n&gt;&gt;&gt; confirmed that the above setting avoids the problem.\n&gt;&gt;&gt;\n&gt;&gt;&gt; --Dan\n&gt;&gt;&gt;\n&gt;&gt;&gt; Peter Doherty wrote:\n&gt;&gt;&gt;&gt; Hi,\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; So I thought I'd try out 7.5.3.\n&gt;&gt;&gt;&gt; I'm getting errors in my ShadowLog that I didn't have before, and I\n&gt;&gt;&gt;&gt; don't really know exactly what they mean.  It's showing auth\n&gt;&gt;&gt;&gt; failures, but I'm not clear what daemon is trying to authenticate\n&gt;&gt;&gt;&gt; with which other daemon.  I'm using GSI security.  And I've still\n&gt;&gt;&gt;&gt; got jobs running, so I'm not sure what's really a fatal error here.\n&gt;&gt;&gt;&gt; I guess I'll turn on more debugging and see if that makes any\n&gt;&gt;&gt;&gt; sense, but I'd love any tips if you've got them.\n&gt;&gt;&gt;&gt; The log entries are below:\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; thanks,\n&gt;&gt;&gt;&gt; peter\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; (I changed some IPs/hostnames/DNs in these log events.)\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; 06/30/10 21:59:37 (2284464.0) (30749):\n&gt;&gt;&gt;&gt; SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION: failed to create security\n&gt;&gt;&gt;&gt; session for &lt;10.200.4.14:56387&gt;#1277942747#3#..., so will fall back\n&gt;&gt;&gt;&gt; on security negotiation\n&gt;&gt;&gt;&gt; 06/30/10 21:59:37 (2284464.0) (30749):\n&gt;&gt;&gt;&gt; SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION: failed to create security\n&gt;&gt;&gt;&gt; session for filetrans.&lt;10.200.4.14:56387&gt;#1277942747#3#..., so will\n&gt;&gt;&gt;&gt; fall back on security negotiation\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; 06/30/10 21:59:43 (2284464.0) (30749): DC_AUTHENTICATE: required\n&gt;&gt;&gt;&gt; authentication of 200.136.80.9 failed: AUTHENTICATE:1003:Failed to\n&gt;&gt;&gt;&gt; authenticate with any method|AUTHENTICATE:1004:Failed to\n&gt;&gt;&gt;&gt; authenticate using GSI|GSI:5005:Failed to authenticate with\n&gt;&gt;&gt;&gt; client.  Client does not trust our certificate.  You may want to\n&gt;&gt;&gt;&gt; check the GSI_DAEMON_NAME in the condor_config|GSI:5004:Failed to\n&gt;&gt;&gt;&gt; gss_assist_gridmap /DC=org/DC=doegrids/OU=Services/CN=hostname to a\n&gt;&gt;&gt;&gt; local user.  Check the grid-mapfile.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; 06/30/10 21:59:43 (2284464.0) (30749): ERROR \"Error from\n&gt;&gt;&gt;&gt; computer@hostname: Could not initiate file transfer\" at line 658 in\n&gt;&gt;&gt;&gt; file pseudo_ops.cpp\n&gt;&gt;&gt;&gt; _______________________________________________\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2010-Jul-06 11:29:11 by smoler:</em> <br/>\n\nFrom a condor-users post by Tim St. Clair:\n\n<p>MAX_ACCEPTS_PER_CYCLE is a daemon core event loop variable which gives\npriority to connecting sockets in the event loop within condor, which\neffect daemon-core based daemons.  Out of the gate, the schedd can\nspawn more processes then it can handle in it's current architecture.\nSome of this can be partially mitigated with existing variables, but it\ndoes not address the crux of the matter. The primary culprit is that the\nevent loop is rather naive about how/where it spends it's time, so when\nthe schedd spawns a series of shadows it spends a copious amount of time\nhandling internal timers but not enough time talking with it's children,\nwho \"give up\" in trying to communicate with their parent.  As a result\nduring large job bursts we had seen, under certain conditions, condor\nwould enter into a \"death spiral\" of spawning &amp; reaping shadows.  This\nvariable gives priority to the initial socket accept which prevents\nshadow cycling, and helps communications issues in general.\n\n</p><p>We've noticed a significant decrease in the number of shadows which are\nspawned/killed when one tunes this variable, whose sweet spot is between\n3 &amp; 5 depending on your pool.  Not to mention it decreases the number of\noverall communications errors and job restarts which directly affects\npool throughput.\n\n</p><p>e.g. in a oversubscribed pool of 3000 nodes we had seen communications\nerrors in the range of several thousand, go down to less then 50.\n\n</p><p></p><hr/>\n<em>2010-Jul-07 10:22:07 by tstclair:</em> <br/>\n\nI purposefully left it off the radar for 7.5.3 and was planning to set the default to 3 or for 7.5.4.  I wanted to make certain initial changes had no effect in the field, which they shouldn't as the base case == 1, or previous version.\n\n<p></p><hr/>\n<em>2010-Jul-08 10:50:43 by smoler:</em> <br/>\n\nFrom Karen, after obtaining correct information needed to document this variable.\n\n<p>An integer.\nDefaults to 1.\nIt is a limit on the number of accepts of new, incoming, socket connect requests\nper <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DaemonCore\" title=\"Daemon Core\">DaemonCore</a></span> event cycle.\nIt typically only matters to the condor_schedd, and would be given a higher\ninteger value (for tuning purposes) when there is a high number of jobs starting and exiting per second.\n\n</p><p></p><hr/>\n<em>2010-Jul-15 23:19:13 by tstclair:</em> <br/>\n\nper conversations with Todd T, the default has been changed to 4</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-16 11:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25558\">[25558]</a></span>: Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1487\" onclick=\"get_ticket_and_populate_wrapper('1487'); return false;\" title=\"document config knob MAX_ACCEPTS_PER_CYCLE\">#1487</a></span> - updated text for MAX_ACCEPTS_PER_CYCLE, and default is now 4.  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-15 23:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=18571\">[18571]</a></span>: Update for Tickets <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1348\" onclick=\"get_ticket_and_populate_wrapper('1348'); return false;\" title=\"Updating the granularity of accepts per cycle through event loop\">#1348</a></span> &amp; <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1487\" onclick=\"get_ticket_and_populate_wrapper('1487'); return false;\" title=\"document config knob MAX_ACCEPTS_PER_CYCLE\">#1487</a></span> - Update default MAX_ACCEPTS_PER_CYCLE=4  (By Timothy St. Clair )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Jul-08 11:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25556\">[25556]</a></span>: documented config knob MAX_ACCEPTS_PER_CYCLE; gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1487\" onclick=\"get_ticket_and_populate_wrapper('1487'); return false;\" title=\"document config knob MAX_ACCEPTS_PER_CYCLE\">#1487</a></span>  (By Karen Miller )</td></tr>\n</tbody></table>", "type": "doc", "last_change": "2010-Jul-16 11:11", "status": "resolved", "created": "2010-Jul-06 10:57", "fixed_version": "2010-Jul-06 10:57", "broken_version": "v070503", "priority": "4", "subsystem": "Unknown", "assigned_to": "tstclair", "derived_from": "#1348", "creator": "smoler", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}