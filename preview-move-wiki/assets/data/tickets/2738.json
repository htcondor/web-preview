{"id": 2738, "title": "Ticket #2738: condor_ckpt_server is crashing", "description": "<blockquote>\nLIGO is reporting the following problem\n<div class=\"code\">\n<pre class=\"code\">After upgrading the LIGO Caltech condor pool running SL6.1from Condor 7.6.4=\n to 7.6.5 we are now getting a large number of condor_ckpt_server failures =\nwith signal 6 and the following message:\n\nThis is an automated email from the Condor system\non machine \"node376.cluster.ldas.cit\".  Do not reply.\n\n\"/usr/sbin/condor_ckpt_server\" on \"node376.cluster.ldas.cit\" died due to si=\ngnal 6 (Aborted).\nCondor will automatically restart this process in 11 seconds.\n\n*** Last 20 line(s) of file /var/log/condor/CkptServerLog:\n12/31/11 16:08:30     File:    cluster91855896.proc0.subproc0.tmp\n12/31/11 16:08:30     Renaming file: &lt;oldfile&gt; to &lt;newfile&gt;\nStack dump for process 32364 at timestamp 1325376510 (16 frames)\ncondor_ckpt_server(dprintf_dump_stack+0x63)[0x54e753]\ncondor_ckpt_server[0x534582]\n/lib64/libpthread.so.0[0x3a82c0f4a0]\n/lib64/libc.so.6(gsignal+0x35)[0x3a82432885]\n/lib64/libc.so.6(abort+0x175)[0x3a82434065]\n/lib64/libc.so.6[0x3a8246f7a7]\n/lib64/libc.so.6(__fortify_fail+0x37)[0x3a824ff3f7]\n/lib64/libc.so.6[0x3a824fd2e0]\n/lib64/libc.so.6(__strncpy_chk+0x17b)[0x3a824fc5ab]\ncondor_ckpt_server(_ZN4IMDS10RenameFileE7in_addrPKcS2_S2_+0x23d)[0x4b21cd]\ncondor_ckpt_server(_ZN6Server17ProcessServiceReqEiP11FDContext_s7in_addr15s=\nervice_req_pkt+0x8ab)[0x4ac58b]\ncondor_ckpt_server(_ZN6Server13HandleRequestEi12request_type+0x465)[0x4ace5=\n5]\ncondor_ckpt_server(_ZN6Server7ExecuteEv+0x3bd)[0x4ad30d]\ncondor_ckpt_server(main+0x22)[0x4ad662]\n/lib64/libc.so.6(__libc_start_main+0xfd)[0x3a8241ecdd]\ncondor_ckpt_server[0x4a6679]\n*** End of file CkptServerLog\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\nThey go on to report\n<div class=\"code\">\n<pre class=\"code\">After reverting just the condor_ckpt_server binary to x86_64 7.6.4 these\ncrashes stopped.\n\nThanks.\n</pre></div>\n\n\n<p></p><hr/>\n<em>2012-Jan-04 18:57:48 by tannenba:</em> <br/>\n\nThe problem was on rename, the ckpt server copied the new name into the wrong buffer that was undersized (this bug has been around since 1995!).  Because this buffer was undersized, the ckpt server would abort on RHEL6 and above systems because we now compile with FORTIFY_SOURCE enabled <span class=\"chng\"><a href=\"chngview?cn=28587\">[28587]</a></span>.\n\n<p></p><hr/>\n<em>2012-Jan-04 18:59:28 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Greg T reviewed the fix.  Also, ToddT reproduced the crashing ckpt server (on a RHEL6 machine - we failed to catch the problem during beta testing as all production UW-Madison ckpt servers are RHEL5), and then observed it all work after the patch.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-17 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=29125\">[29125]</a></span>: Minor 7.6.6 version history item edits for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2738\" onclick=\"get_ticket_and_populate_wrapper('2738'); return false;\" title=\"condor_ckpt_server is crashing\">#2738</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2736\" onclick=\"get_ticket_and_populate_wrapper('2736'); return false;\" title=\"schedd tries to kill pid 0 and then excepts\">#2736</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2133\" onclick=\"get_ticket_and_populate_wrapper('2133'); return false;\" title=\"[Debian] Modify init script to handle /var/run as tmpfs\">#2133</a></span>.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-04 18:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28986\">[28986]</a></span>: Documented fix for ckpt server aborting. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2738\" onclick=\"get_ticket_and_populate_wrapper('2738'); return false;\" title=\"condor_ckpt_server is crashing\">#2738</a></span> ===VersionHistory:Complete===  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jan-04 18:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=28985\">[28985]</a></span>: Fix buffer overrun in ckpt_server that causes it to abort on RHEL6. Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=2738\" onclick=\"get_ticket_and_populate_wrapper('2738'); return false;\" title=\"condor_ckpt_server is crashing\">#2738</a></span>.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Jan-04 19:07", "status": "defer", "created": "2012-Jan-03 09:25", "fixed_version": "2012-Jan-03 09:25", "broken_version": "v070605", "priority": "5", "subsystem": "Std", "assigned_to": "tannenba", "derived_from": "", "creator": "nwp", "rust": "s8115", "customer_group": "ligo", "visibility": "public", "notify": "pcouvare@caltech.edu", "due_date": ""}