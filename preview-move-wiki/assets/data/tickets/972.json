{"id": 972, "title": "Ticket #972: Fault recovery during cream job submission broken", "description": "<blockquote>\nIf the gridmanager crashes after saving the job id of a Cream job, but before sending the Cream Start command, recovery is handled improperly. On restart, the gridmanager will assume the job has already been started and proceed directly to the GM_SUBMITTED state. Subsequent job status checks will show that the job is in REGISTERED state on the Cream server, but the gridmanager doesn't do anything special when it sees this.\n\n<p>When the gridmanager starts managing a job that has <span class=\"quote\">GridJobId</span> already set, it should check the job's status on the Cream server and send a Start command if the status is REGISTERED.</p></blockquote>", "remarks": "<blockquote>\nPushed a fix to V7_4-branch for 7.4.1.\n\n<p></p><hr/>\n<em>2009-Nov-20 16:31:51 by jfrey:</em> <br/>\n\nThe first attempt to fix fault recovery during job submission tripped over a race condition in the Cream server. A Status command immediately following a Start command can return REGISTERED instead of PENDING or IDLE. REGISTERED means the job hasn't been started with a Start command yet.\n\n<p>As a result, during normal job submission, the gridmanager would issue a second Start command for about 10% of jobs. The Start would fail and the jobs would end up on hold.\n\n</p><p>I've pushed a new fix to V7_4-branch for 7.4.1 that works around the problem by introducing a separate state for doing a job status poll on recovery.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-22 10:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/164628d18c97aeab579fc27bae46288e8796f290\">[16430]</a></span>: Restore connection failure test for recovery poll for cream jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=972\" onclick=\"get_ticket_and_populate_wrapper('972'); return false;\" title=\"Fault recovery during cream job submission broken\">#972</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-22 10:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2d9eeca8ae74194b129d893f504f6dfa430cc3d8\">[16427]</a></span>: Fix build error in cream job fault recovery. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=972\" onclick=\"get_ticket_and_populate_wrapper('972'); return false;\" title=\"Fault recovery during cream job submission broken\">#972</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-20 16:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb6bfbb416cd6dfadf7979622a3465039097d8d3\">[16400]</a></span>: More fixes to cream job fault recovery. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=972\" onclick=\"get_ticket_and_populate_wrapper('972'); return false;\" title=\"Fault recovery during cream job submission broken\">#972</a></span> The previous fault recovery during submission fix tripped over a race condition in the cream server, where a Status command following a Start command can return REGISTERED. REGISTERED means the job hasn't been started with a Start command yet.\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-Nov-17 16:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/81071fea2f6ee352cde4cd4527cbe7e20bcf36ce\">[16364]</a></span>: Fix fault recovery during cream job submission. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=972\" onclick=\"get_ticket_and_populate_wrapper('972'); return false;\" title=\"Fault recovery during cream job submission broken\">#972</a></span> If the gridmanager crashes between saving the cream job id to the schedd and sending the cream Start command, then on recovery, it will now notice that the job is in REGISTERED state and try the Start command again.  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Feb-01 13:22", "status": "resolved", "created": "2009-Nov-17 14:46", "fixed_version": "2009-Nov-17 14:46", "broken_version": "v070400", "priority": "3", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "#897", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}