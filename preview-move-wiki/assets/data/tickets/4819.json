{"id": 4819, "title": "Ticket #4819: \"queue\" for multiple files", "description": "<blockquote>\nOne of the most common user questions we get is \"how do I process a directory of files?\"  Sadly, there's no answer that doesn't involve a perl script.\n\n<p>We should introduce some new semantics for the \"queue\" command in condor_submit files.  Currently,\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">queue N\n</pre></div>\n\n\n<p>Means to queue N jobs, with $(Process) expanding to values 0 through N-1.\n\n</p><p>The expanded queue syntax will be one of the following\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">queue [&lt;int-expr&gt;] [&lt;v&gt;] in &lt;itemlist&gt;\nqueue [&lt;int-expr&gt;] [&lt;v&gt;] matching &lt;globlist&gt;\nqueue [&lt;int-expr&gt;] [&lt;v1&gt;,&lt;v2&gt;,...] from &lt;itemfile&gt;\n\nwhere []   indicates optional parts of the syntax.\n&lt;int-expr&gt; is an expression evaluating to an integer\n&lt;v&gt;        is a submit variable name to be used as the loop variable\n&lt;itemlist&gt; is a list of comma and/or spaces separated literals\n&lt;globlist&gt; is a list of comma and/or space separated glob patterns.\n&lt;itemfile&gt; is the name of a file, - indicates stdin. each line of the file will be tokenized\n           and used to set values for loop variables &lt;v1&gt;,&lt;v2&gt;,etc\n</pre></div>\n\n\n<p></p><ul>\n<li>if <code>&lt;itemlist&gt; or &lt;globlist&gt;</code> begins with '(' then the list continues until ')' even if the closing ')' is on another line. For multi-line lists, a leading '#' can be used to comment out lines, and line continuation using '\\' is supported. (i.e. these lines follow the same rules as other lines  in the submit file.)\n</li><li>if <code>&lt;itemfile&gt;</code> begins with '(' then the content of the itemfile is read from the submit file until the closing '). (this behavior is sometimes called a herefile).\n</li><li>if <code>&lt;itemfile&gt;</code> ends with '|', then it run as a command and it's stdout taken as the file content.\n</li></ul>\n\n<p>design doc here: <a class=\"external\" href=\"https://docs.google.com/a/wisc.edu/document/d/10UKaiu1BkirXP6qUmx9DyEOPPSNqKqmS-2foztKi_zU/edit#\">https://docs.google.com/a/wisc.edu/document/d/10UKaiu1BkirXP6qUmx9DyEOPPSNqKqmS-2foztKi_zU/edit#</a>\n\n</p><p>note: bbockelm's original ticket prose move to remarks section.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Feb-01 00:00:01 by bbockelm:</em> <br/>\n\n[Proposed this to tannenba last year at CERN, but I believe I failed to capture it in a ticket until now - please let me know if it's a dup.]\n\n<p></p><div class=\"verbatim\">\n<pre>queue for FILE matching file1, file2, dir1, dir2, glob1, ...\n</pre></div>\n\n\n<p>Here, we queue a job for matching files, with $(FILE) expanding to the filename that will be copied into the job's working directory.  The file is added to the transfer_input_files.  I propose the following semantics:\n</p><ul>\n<li>For a filename, we create one job specifically for that file.\n</li><li>For a directory, we create on job and transfer the whole directory.  Trailing slash semantics are identical to those for transfer_input_files.\n</li><li>For a glob, we create a job for all matching files and directories.\n</li></ul>\n\n<p>Second:\n\n</p><p></p><div class=\"verbatim\">\n<pre>queue for FILE in dir1, dir2, dir3\n</pre></div>\n\n\n<p>This is similar to \"matching\" above, except that we recurse into directories and create a job for each file in a given directory (including sub-directories).  As with LOCAL_CONFIG_DIR_EXCLUDE_REGEXP, we could have SUBMIT_FILE_EXCLUDE_REGEXP that would default to ignoring any vim / emacs temporary files and hidden files.\n\n</p><p>For each job, we also expand $(Process) to be the proc id; however, we make no guarantees on the <strong>ordering</strong> - we do not sort files (ALTERNATE: sort according to filename).\n\n</p><p></p><hr/>\n<em>2015-Mar-31 09:56:56 by johnkn:</em> <br/>\n\nNote: in 8.3.5 on Windows the globbing does not support globbing of both file and directory at the same time - so\n\n<p></p><pre>    Queue matching */*.dat\n</pre>\n\n<p>does not work.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-15 16:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f064ac94d161bab0d32fe5f3f7526d5630713d6e\">[44627]</a></span>: New features for queuing jobs are grouped together in the 8.3.5 version history, and a <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4944\" onclick=\"get_ticket_and_populate_wrapper('4944'); return false;\" title=\"New $macro expansion functions for submit\">#4944</a></span> version history item is added <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4913\" onclick=\"get_ticket_and_populate_wrapper('4913'); return false;\" title=\"submit files should support if/else and include like config files\">#4913</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-15 15:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8c69d042ffc09e20bc1707d6f6db0bacf2808632\">[44625]</a></span>: fix broken error printf in previous commit for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-15 14:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/76e5781ee713675020cf75be4ea4cc52cffbdf84\">[44622]</a></span>: change condor_submit -dry-run to requrire an output filename <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span> version of -dry-run that did not require a filename never shipped.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-07 13:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1e69b201b4769ea3ea65fa5bfc0f7972957f2239\">[44550]</a></span>: fix bugs in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span> before feature first ships. Q from ( list ) did not work if there was whitespace after ( executable = $(ITEM) did not change the executable as ITEM changed. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Apr-03 16:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/22601f3f70ba557b30e47c4d84c2deb1c3c719d0\">[44528]</a></span>: fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span> before initial release. allow $() substitutions on the queue line don't create files during -dry-run, and make the -dry-run output messages clearer.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-26 12:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5e0b535e4e6c62c87fddb89610d1c2d1f706e207\">[43731]</a></span>: add and correct details to the descriptions of the new queueing functionality <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-24 14:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7f3fbd62836dbcfd479c4965c2daef01ba3c1bc8\">[43689]</a></span>: First pass documentation on new for each features of the queue submit command. Needs lots more, but this will get people started with the feature and includes 3 simple examples. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-23 11:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1cd0e0a05c0ab22c143d618333c5e62e378cc929\">[43668]</a></span>: fix covarity warning for previous commit to <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-20 14:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3951fee6344909549c7fb26eef52299e2f29caab\">[43644]</a></span>: fix handling of comment lines in queue from files <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>, change queue in to always iterate tokens.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-20 10:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dfd2dadd6a194cef4156445fb532df71d72c48b1\">[43635]</a></span>: better control of warnings for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>. use strict : true/false/harsh  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-17 16:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2111fe9341bc2d1b64f209c8b6e63001bab2e1ce\">[43616]</a></span>: solaris doesn't support GLOB_ONLYDIR, so return \"unsupported\" <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-17 15:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9ddbe0ecfa942094a22318985aaa3311b36cc580\">[43615]</a></span>: Add globbing to Queue for multiple files in condor_submit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span> This implements the matching keyword for Queue. globbing works fully on *nix it works for files but not directories on Windows. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-09 23:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d5ea0ae0490073736e4601ec53e34d7f2e6e9256\">[43549]</a></span>: Add queue for multiple files to condor_submit. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4819\" onclick=\"get_ticket_and_populate_wrapper('4819'); return false;\" title='\"queue\" for multiple files'>#4819</a></span> This commit adds support for arguments after the Queue command to specify a list of items, N jobs will be queued for each item in the list. Three flavors of item list are allowed, specified by 'matching', 'in' and 'from' keywords. implemtation of matching\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Apr-16 20:27", "status": "resolved", "created": "2015-Jan-09 12:31", "fixed_version": "2015-Jan-09 12:31", "broken_version": "", "priority": "3", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "#4899", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu", "due_date": ""}