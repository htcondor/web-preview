{"id": 3618, "title": "Ticket #3618: Procd failures can lead to fork-bomb of the system", "description": "<blockquote>\nWhen the procd fails (i.e. the other daemons can no longer communicate with it), the daemon that spawned it will attempt to restart it. It will retry spawning the procd until it can open the procd's named pipe and communicate with it. If the procd can't be restarted successfully due to a permanent error (like the directory to contain the named pipe doesn't exist), the daemon will continue spawning procd processes without reaping them, until fork() fails due to there being too many processes.\n\n<p>The problematic code is in ProcFamilyProxy::recover_from_procd_error().\n\n</p><p>We have seen this happen on one of the macs in the batlab. It was caused by config param $(HOSTNAME) changing value after HTCondor first starts up, and it being used in the name of the LOCK directory. HOSTNAME changed from the fully-qualified hostname to the simple name of the machine (without domain). When HTCondor first started, something ensured that the LOCK directory existed. Later, after HOSTNAME changed, the procd failed and the startd attempted to restart it, but they were then trying to use a directory that didn't exist.\n\n</p><p>There are several changes we could make to fix this problem:\n</p><ul>\n<li>Put a limit on the number of times recover_from_procd_error() tries to restart the procd. The method would then either return failure or EXCEPT().\n</li><li>recover_from_procd_error() can kill and reap procd processes when they fail.\n</li></ul>\n\n<p>Some additional items that need investigation:\n</p><ul>\n<li>In the default HTCondor configuration, why do we include HOSTNAME in the name of the LOCK directory when it's place under /tmp?\n</li><li>Why is HOSTNAME initially the full hostname on the batlab macs, then changing later on to not include the domain?</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-May-14 21:39:30 by bbockelm:</em> <br/>\n\nHi Jaime,\n\n<p>I've noticed that when the master is set to run the procd, if you nuke the procd, then the master is unable to kill daemons (despite restarting the processes).  Have you seen anything similar?  Is it possible this is related?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2013-May-16 10:34:59 by jfrey:</em> <br/>\n\nIs the master failing to kill daemons happening around the time the procd is killed and restarted, or a while afterwards? Once the procd is successfully restarted, I wouldn't expect the master to have any trouble killing daemons.\n\n<p></p><hr/>\n<em>2013-May-22 15:48:45 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> after <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/452534e8f07f28d87f20e22a33236c09eb47ffbf\">[35820]</a></span> it looks good, as far as avoiding an infinite loop.  however it seems there are other potential problems, now in ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3655\" onclick=\"get_ticket_and_populate_wrapper('3655'); return false;\" title=\"restarting procd on failure doesn't retry correctly\">#3655</a></span>.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3620\" onclick=\"get_ticket_and_populate_wrapper('3620'); return false;\" title=\"LOCK directory in /tmp shouldn't include HOSTNAME\">#3620</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nLOCK directory in /tmp shouldn't include HOSTNAME</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3655\" onclick=\"get_ticket_and_populate_wrapper('3655'); return false;\" title=\"restarting procd on failure doesn't retry correctly\">#3655</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nrestarting procd on failure doesn't retry correctly</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-23 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/65d3d5601e8f20b19e37af66075dadada6a3404f\">[35842]</a></span>: Version history for Mac procd fixes. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3617\" onclick=\"get_ticket_and_populate_wrapper('3617'); return false;\" title=\"Gathering pid list on mac os x and bsd can cause crashes\">#3617</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3618\" onclick=\"get_ticket_and_populate_wrapper('3618'); return false;\" title=\"Procd failures can lead to fork-bomb of the system\">#3618</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3620\" onclick=\"get_ticket_and_populate_wrapper('3620'); return false;\" title=\"LOCK directory in /tmp shouldn't include HOSTNAME\">#3620</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-22 13:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/452534e8f07f28d87f20e22a33236c09eb47ffbf\">[35820]</a></span>: Don't except if we successfully restart the procd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3618\" onclick=\"get_ticket_and_populate_wrapper('3618'); return false;\" title=\"Procd failures can lead to fork-bomb of the system\">#3618</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-14 16:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e392f0e6e94f34638a66ba251fd9e063d52c9d94\">[35703]</a></span>: Don't fork-bomb the system when restarting the procd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3618\" onclick=\"get_ticket_and_populate_wrapper('3618'); return false;\" title=\"Procd failures can lead to fork-bomb of the system\">#3618</a></span> When attempting to restart the procd, cap the number of attempts. Otherwise, we can end up creating an unlimited number of procds until we reach a system limit on the number of processes. This is a very simple fix where we suicide on failure,\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-May-23 13:44", "status": "resolved", "created": "2013-May-13 14:59", "fixed_version": "2013-May-13 14:59", "broken_version": "v070900", "priority": "2", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "tstclair@redhat.com, matt@cs.wisc.edu, zmiller@cs.wisc.edu", "due_date": ""}