{"id": 1231, "title": "Ticket #1231: job updates should not result in fsyncs", "description": "<blockquote>\nEvery SHADOW_UPDATE_INTERVAL (default 15 minutes), the shadow sends an update of the job to the schedd, resulting in one call to fsync.  With 1k running jobs, this results in calls to fsync at over 1Hz and with 10k running at over 10Hz.  Such high rates lead to schedd overload, which is frequently followed by the schedd killing shadows because it thinks they are hung (when actually they just can't get through to the schedd to tell it they are alive).  In any case I am aware of, nothing in this job update is so crucial that it needs to be synced immediately to disk.\n\n<p>In addition, if the image size of the job changes, the shadow logs this fact to the user log, generating an additional fsync.  This event is also not crucial in any case I am aware of.  Unlike the job update, this fsync happens from the shadow, but it can still hurt schedd performance indirectly by consuming precious disk bandwidth.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-23 20:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17315\">[17315]</a></span>: Added missing string include (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>)  (By Matthew Farrellee )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-23 18:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17312\">[17312]</a></span>: Fixed problem of multiple submit events in event log. My recent change that moved CloseConnection() into CommitTransaction() (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>) caused some references to old_cluster_num to be made when no qmgmt session was active, and the value of this global variable was not properly maintained outside of a qmgmt\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 16:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=25293\">[25293]</a></span>: Documented fsync optimizations. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17287\">[17287]</a></span>: For performance, do not fsync when logging shadow exceptions. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17288\">[17288]</a></span>: For performance, do not fsync when logging the checkpoint event. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17286\">[17286]</a></span>: For performance, do not fsync when logging disconnect/reconnect events. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17284\">[17284]</a></span>: Add convenience function WriteUserLog::writeEventNoFsync(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17285\">[17285]</a></span>: For performance, do not fsync the image size update event. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17283\">[17283]</a></span>: Periodic jobs updates from the shadow use a NONDURABLE transaction. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span> This is to reduce the fsync load in the schedd when lots of jobs are running.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Feb-18 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=17282\">[17282]</a></span>: Added <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteCommitTransaction\" title=\"Remote Commit Transaction\">RemoteCommitTransaction</a></span> and deprecated <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CloseConnection\" title=\"Close Connection\">CloseConnection</a></span> in qmgmt. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1231\" onclick=\"get_ticket_and_populate_wrapper('1231'); return false;\" title=\"job updates should not result in fsyncs\">#1231</a></span> The new function is better named and also accepts an argument specifying optional flags for the commit. The only currently supported flag is NONDURABLE, which is the motivation for this commit.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Feb-18 16:21", "status": "resolved", "created": "2010-Feb-18 15:16", "fixed_version": "2010-Feb-18 15:16", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu", "due_date": ""}