{"id": 4908, "title": "Ticket #4908: EventLog lock contention", "description": "<blockquote>\nCMS has noticed a high level of contention for the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> lock (we had one schedd which stalled for &gt;5 minutes, which led to the master nuking the process), which led me to poke at the schedd via strace.  A few things that could be cleaned up:\n<ul>\n<li>The event and the corresponding \"job ad information\" are written under separate locks - meaning that a separate event entry could be logged between the two.\n</li><li>Under high contention, the lock deletion code becomes a mess as it tries to obtain the lock in order to delete it.  I observed multiple processes racing in the deletion code - meaning a given process may recreate the lock several times in order to obtain (and delete) it.  :(\n</li><li>I can't see any reason why O_APPEND can't be used here.  The FILE * buffers the events so only one write() call is done on fflush.  I wouldn't want to depend on that for correctness in all cases, but it would be nice to be able to make the tradeoff.  Perhaps O_APPEND is used if EVENT_LOG_LOCKING=false.\n</li><li>We really don't care about job ad updates - we wanted to use the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EventLog\" title=\"Event Log\">EventLog</a></span> for forensics (what got run where).  I don't see a mechanism for doing that - would be useful.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2015-Feb-23 11:09:10 by tannenba:</em> <br/>\n\nAt first blush, I very much like the idea of giving the event log writing code the \"dprintf\" treatment such that a lock is only required on rotation iff the config file disables event log writing, and then set the param table to disable event log locking by default. This change should be at the lower level of the event writing code so we impact not only the schedd event log, but all event log writes (i.e. job event log, dagman event log).  We should be sure that any daemon (except perhaps dagman itself? ie limit it to schedd/shadows that have condor access?) that gets the lock is able to do the rotation, and also investigate the mess surrounding removing the lock file.\n\n<p>Setting to v080304 and assigning to Jaime (since he did the coding for the dprintf log treatment).\n\n</p><p>Not directly related, and should be a separate ticket, but also thinking about the event logs, I am thinking about disabling fsync by default on job and schedd event logs (but keeping it enabled by default on dagman event logs), and also about a way to keep the dagman event logs on an ssd. Ie a knobs like SPOOL=path and SPOOL_HIGH_SPEED=path, and SPOOL_HIGH_SPEED would store just the job_queue.log and DAGMan event log files by default.\n\n</p><p></p><hr/>\n<em>2015-Mar-04 14:03:35 by jfrey:</em> <br/>\n\nI have implemented the following changes for 8.3.5:\n\n<p></p><ul>\n<li>Each event is written with a single write() syscall. This makes it safe to turn off locking of the user log and event log. This doesn't affect the rotation lock for the event log.\n</li><li>For rotation of the event log, the lock file is always a long-lived, explicitly named file, in the LOCK directory by default. This eliminates the need for the schedd to acquire the lock and delete the file every time it writes an event.\n</li></ul>\n\n<p>In a future release, we will make non-locked writing the default.\n\n</p><p></p><hr/>\n<em>2015-Apr-07 08:54:17 by bbockelm:</em> <br/>\n\nRe-opening due to noticing a bug (before 8.3.5 release).\n\n<p>This fails because DAGMan does not have permission to lock the file.  See the following snippet from our dagman log:\n\n</p><p></p><div class=\"verbatim\">\n<pre>04/07/15 15:39:59 Initializing user log writer for /data/srv/glidecondor/condor_local/spool/8776/0/cluster28776.proc0.subproc0/RunJobs.dag.nodes.log, (-1.0.0)\n04/07/15 15:39:59 Warning: WriteUserLog Failed to open event rotation lock file /tmp/condor-lock.0.548474800148146/EventLogLock: 13 (Permission denied)\n</pre></div>\n\n\n<p></p><hr/>\n<em>2015-Apr-07 09:27:51 by jfrey:</em> <br/>\n\nThe <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> object tries to open the event log rotation lock file even if it's told to not write to the event log. That'll be an easy fix.\n\n<p></p><hr/>\n<em>2015-Apr-07 09:46:31 by jfrey:</em> <br/>\n\nIf the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> object fails to open the event log rotation lock file, it will proceed without locking the file on rotation. All events will be written as normal. For dagman, normal means not writing to or rotating the event log, since that is explicitly disabled. This behavior is the same in previous versions of Condor.\n\n<p></p><hr/>\n<em>2015-Apr-08 08:11:37 by bbockelm:</em> <br/>\n\nFor gittrac history - follow-up work is being done in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4989\" onclick=\"get_ticket_and_populate_wrapper('4989'); return false;\" title=\"Don't open event log rotation lock file if not using event log\">#4989</a></span>.\n\n<p>I disagree that this is the same behavior as before.  Previously, this message was only seen if there actually was log contention on startup - probably fairly rare.\n\n</p><p>Now, this warning will be printed for every single DAG.  Further, won't this cause the same lock to be used for all user logs?\n\n</p><p></p><hr/>\n<em>2015-Apr-08 10:17:59 by jfrey:</em> <br/>\n\nIn previous versions of Condor, if you set EVENT_LOG_ROTATION_LOCK in the config file, then you would see those same errors messages in the same situations.\n\n<p>The EVENT_LOG_ROTATION_LOCK file is only used to control rotation of the event log. It's not used at all for writing to the user job log or DAGMan log. Locking for these files, if enabled, is still done via temporary files under LOCAL_DISK_LOCK_DIR.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4922\" onclick=\"get_ticket_and_populate_wrapper('4922'); return false;\" title=\"Disable event log locking by default\">#4922</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDisable event log locking by default</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4989\" onclick=\"get_ticket_and_populate_wrapper('4989'); return false;\" title=\"Don't open event log rotation lock file if not using event log\">#4989</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDon't open event log rotation lock file if not using event log</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5115\" onclick=\"get_ticket_and_populate_wrapper('5115'); return false;\" title=\"Windows drops events when event log locking is disabled.\">#5115</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nWindows drops events when event log locking is disabled.</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-05 09:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/09ff401149bcf7d5c204a5af3bba3cc7f5a47422\">[43515]</a></span>: edit doc for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4908\" onclick=\"get_ticket_and_populate_wrapper('4908'); return false;\" title=\"EventLog lock contention\">#4908</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-04 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1fbc53e17f84b552a6915de4bc7b7092b233f90e\">[43510]</a></span>: Docs for improved lockless job log writing. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4908\" onclick=\"get_ticket_and_populate_wrapper('4908'); return false;\" title=\"EventLog lock contention\">#4908</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-04 10:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/df436534dc750e89f8031fca3ee6e130e193a919\">[43506]</a></span>: Remove unused variable. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4908\" onclick=\"get_ticket_and_populate_wrapper('4908'); return false;\" title=\"EventLog lock contention\">#4908</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-03 16:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/51d5f8173ed01290789c5dc9d2111ca3baff55eb\">[43503]</a></span>: Don't use temporary local file for the event log rotation lock. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4908\" onclick=\"get_ticket_and_populate_wrapper('4908'); return false;\" title=\"EventLog lock contention\">#4908</a></span> Use a permanent, long-lived lock file for the event log rotation lock. This means that the schedd, shadow, and gridmanager don't need to acquire a write lock and delete the lock file every time they delete a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=WriteUserLog\" title=\"Write User Log\">WriteUserLog</a></span> object. The\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Mar-03 11:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7efb535c25c7b066a3f30e3757a4755344cc833b\">[43500]</a></span>: Write job events with a single write(). <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4908\" onclick=\"get_ticket_and_populate_wrapper('4908'); return false;\" title=\"EventLog lock contention\">#4908</a></span> We want to disable locking of the job event logs by default. To do this, we need to ensure that each complete event is written with a single write(), and the file is opened in append mode (except when updating the header event of the event log on rotation).\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Apr-08 10:18", "status": "resolved", "created": "2015-Feb-23 09:55", "fixed_version": "2015-Feb-23 09:55", "broken_version": "", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu tannenba@cs.wisc.edu", "due_date": ""}