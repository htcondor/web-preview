{"id": 7482, "title": "Ticket #7482: Restrict remote files access to a whitelist of directories", "description": "<blockquote>\n<span class=\"subsection\"><h3>Motivation </h3></span>\n\n<p>Many batch systems assume a shared file system between the server where the job is submitted and the server where the job runs.  To remove reliance upon the existence of a shared file system, HTCondor provides its own custom mechanisms for a job running on a remote server to access to the filesystem of the submit host:\n\n</p><p></p><ol>\n<li>HTCondor File Transfer.\n</li><li>Chirp.\n</li><li>Remote System Calls.\n</li><li>Streaming I/O of stdin, out, err.\n</li></ol>\n\n<p>Read/write access in HTCondor is performed as the job's Owner (submitting user), and thus is restricted based on file system permissions.  However, today this is the only restriction.  For example,  when Chirp is enabled today, a client on the execute node can write any file on the submit machine which the user owns.\n\n</p><p>We should restrict this to only allow access to a certain set of predetermined files.\n\n</p><p><span class=\"subsection\"></span></p><h3>Proposed Change</h3>\n\n<p>Implement a configuration knob <code>LIMIT_DIRECTORY_ACCESS</code> that can contain a comma-separated list of sub-directories on the file system of the submit machine.  If specified, this list will act as a whitelist for all read or write access by the <em>condor_shadow</em> for purposes of file transfer, chirp, or remote I/O.  Any file access must happen in one of the listed sub-directories, or in a child sub-directory of the listed directories, or in the SPOOL sub-directory associated with the specific job.  If file access is attempted to an unspecified location, an error message will be written to the <code>ShadowLog</code>, and it will be treated exactly as if the user attempted to access a file owned by a different user... e.g. for File Transfer the job will go on hold with a hold message containing the name of the file, for Chirp the client will receive an errno EACCES.\n\n</p><p>If <code>LIMIT_DIRECTORY_ACCESS</code> is unspecified in the config file, then the job attribute <code>LimitDirectoryAccess</code> is consulted and will behave exactly like the config knob.  This could be very useful in conjunction with a job transform to limit file access to the job's current working directory, for example. If neither is specified, then the current behavior is unchanged (i.e. no whitelist restriction).\n\n</p><p>Note that this whitelist of directories should be canonical,  and may optionally contain one asterisk character as a wild-card.  For example:\n\n</p><p></p><pre>   # Limit access to files by vanilla universe jobs to /export/htcondor_data folder,\n   # or to any folder in a user's home directory that has the name htcondor_data,\n   # or to files in the spool directory.\n   LIMIT_DIRECTORY_ACCESS = /export/htcondor_data,/home/*/htcondor_data\n</pre>\n\n<p>Another example:\n\n</p><p></p><pre>   # Limit access to files by vanilla jobs solely to files in the jobs SPOOL.\n   # We do this by putting only one entry into the whitelist: a directory that\n   # does not exist on the system.\n   LIMIT_DIRECTORY_ACCESS = /THIS_SUBDIR_DOES_NOT_EXIST</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Jan-21 13:18:19 by bbockelm:</em> <br/>\n\n(For what it's worth, the existing behavior is largely why Chirp I/O is disabled by default...)\n\n<p></p><hr/>\n<em>2020-May-12 10:30:38 by pfc:</em> <br/>\n\nTodd says this is 75% done and he just needs to find the time to finish.\n\n<p></p><hr/>\n<em>2020-Sep-04 16:42:42 by tannenba:</em> <br/>\n\nSee code review child ticket <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=7839\" onclick=\"get_ticket_and_populate_wrapper('7839'); return false;\" title=\"Minor code refactor for LIMIT_DIRECTORY_ACCESS support\">#7839</a></span>\n\n<p>See documentation child ticket <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=7841\" onclick=\"get_ticket_and_populate_wrapper('7841'); return false;\" title=\"Document LIMIT_DIRECTORY_ACCESS mechanism\">#7841</a></span></p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=7839\" onclick=\"get_ticket_and_populate_wrapper('7839'); return false;\" title=\"Minor code refactor for LIMIT_DIRECTORY_ACCESS support\">#7839</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMinor code refactor for LIMIT_DIRECTORY_ACCESS support</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=7841\" onclick=\"get_ticket_and_populate_wrapper('7841'); return false;\" title=\"Document LIMIT_DIRECTORY_ACCESS mechanism\">#7841</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDocument LIMIT_DIRECTORY_ACCESS mechanism</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-27 15:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61135\">[61135]</a></span>: Fix linker errors after merging in CMakefile changes in util lib. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7482\" onclick=\"get_ticket_and_populate_wrapper('7482'); return false;\" title=\"Restrict remote files access to a whitelist of directories\">#7482</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-27 13:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61132\">[61132]</a></span>: Restrict remote file access to whitelist of directories. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7482\" onclick=\"get_ticket_and_populate_wrapper('7482'); return false;\" title=\"Restrict remote files access to a whitelist of directories\">#7482</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-27 13:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61131\">[61131]</a></span>: Define realpath() macro on Win32, get rid of code clones. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7482\" onclick=\"get_ticket_and_populate_wrapper('7482'); return false;\" title=\"Restrict remote files access to a whitelist of directories\">#7482</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-27 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61130\">[61130]</a></span>: Add unit tests for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span> prefix() and multiple wildcards. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7482\" onclick=\"get_ticket_and_populate_wrapper('7482'); return false;\" title=\"Restrict remote files access to a whitelist of directories\">#7482</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-27 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=61129\">[61129]</a></span>: Add <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span> methods prefix_withwildcard() and friends. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7482\" onclick=\"get_ticket_and_populate_wrapper('7482'); return false;\" title=\"Restrict remote files access to a whitelist of directories\">#7482</a></span> This commit also allows any <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StringList\" title=\"String List\">StringList</a></span> item to have two askterisks, so long as one of the asterisks is at the end of the string.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Sep-04 16:42", "status": "resolved", "created": "2020-Jan-21 10:52", "fixed_version": "2020-Jan-21 10:52", "broken_version": "v080900", "priority": "2", "subsystem": "", "assigned_to": "tannenba", "derived_from": "#7405", "creator": "gthain", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}