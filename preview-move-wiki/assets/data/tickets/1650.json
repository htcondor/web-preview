{"id": 1650, "title": "Ticket #1650: Submitting multiple VMWare jobs with single submit doesn't work", "description": "<blockquote>\nTrying to submit multiple VMWare vm universe jobs with a single submit file doesn't work when the vmware_dir attribute isn't used. Condor_submit gives this error: <code>ERROR: no vmx file for vmware can be found.</code>\n\n<p>The problem is that the VMware code in condor_submit adds vm-related files to <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TransferInput\" title=\"Transfer Input\">TransferInput</a></span> in the job ad, then searches the list of files in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TransferInput\" title=\"Transfer Input\">TransferInput</a></span> to find .vmx and .vmdk files. This is done as a part of <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1351\" onclick=\"get_ticket_and_populate_wrapper('1351'); return false;\" title=\"Allow file transfer plugins to work with vm universe\">#1351</a></span>, which allows VMware files to be given in <code>vmware_dir</code> or <code>transfer_input_files</code> in the submit file. However, condor_submit's code to collect job attributes with identical values in the cluster ad causes the ads of jobs after the first in a cluster to be mostly empty. So for the second and subsequent jobs in the cluster, the job ad in condor_submit doesn't have a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TransferInput\" title=\"Transfer Input\">TransferInput</a></span> attribute, so the VMware-related code complains that there is no .vmx file.\n\n</p><p>The proposed fix is to improve how condor_submit decides which attributes go into the cluster vs the proc ad. Before, InsertJobExpr() kept a hash table of attribute name/value pairs that went into the cluster ad. For subsequent jobs in the cluster, it would return immediately if the name/value pair was in the hash table. Thus, the job ad would only taken values that differed from the cluster ad. Now, a copy of the cluster ad is saved in memory. InsertJobExpr() always inserts values into the job ad. Then, when SaveClassAd() sends the ad to the schedd, it compares each name/value against the cluster ad and skips those that match.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Sep-24 12:37:19 by jfrey:</em> <br/>\n\nPushed changes to master for 7.5.5.\n\n<p></p><hr/>\n<em>2011-Jan-03 18:19:22 by danb:</em> <br/>\n\nJaime, it appears that commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cf88badb5d692b53eea231286c13a23bf1cc2a1\">[19048]</a></span> causes custom attributes (set with '+' in the submit file) to always belong to the proc ad rather than the cluster ad.  Is this intentional?\n\n<p></p><hr/>\n<em>2011-Jan-05 11:04:39 by jfrey:</em> <br/>\n\nCustom attributes don't always go into the proc ad, although maybe they should. If you set one for the first job in the cluster, it ends up in the cluster ad. But I just noticed that if you set a custom attribute for the first job in the cluster, you can't unset it using the '-' notation for any subsequent jobs in the cluster.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Jan-21 16:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/96f5ba33ee29f5da3d69edc61017498dacf25df9\">[25869]</a></span>: Add some version history entries. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1695\" onclick=\"get_ticket_and_populate_wrapper('1695'); return false;\" title=\"Improve reaction to misbehaving gahps on startup\">#1695</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1761\" onclick=\"get_ticket_and_populate_wrapper('1761'); return false;\" title=\"Local job slow to exit can kill schedd\">#1761</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1747\" onclick=\"get_ticket_and_populate_wrapper('1747'); return false;\" title=\"Improve hold reasons for cream jobs\">#1747</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1641\" onclick=\"get_ticket_and_populate_wrapper('1641'); return false;\" title=\"Add new job status TRANSFERRING_OUTPUT\">#1641</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1650\" onclick=\"get_ticket_and_populate_wrapper('1650'); return false;\" title=\"Submitting multiple VMWare jobs with single submit doesn't work\">#1650</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-24 12:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cf88badb5d692b53eea231286c13a23bf1cc2a1\">[19048]</a></span>: Revamp how submit splits attributes between cluster and proc ads. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1650\" onclick=\"get_ticket_and_populate_wrapper('1650'); return false;\" title=\"Submitting multiple VMWare jobs with single submit doesn't work\">#1650</a></span> Now, when condor_submit builds up each job ad in a cluster, all attributes are inserted into the local copy of the ad. When submit sends the ad to the schedd, it omits attribute/value pairs that are identical to what's in the cluster\u00a0[...]\n (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-16 10:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8368e5be73c899454e6cad42977ec5a60b8a28ee\">[18991]</a></span>: Do cluster check for grid/vm attributes in condor_submit. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1650\" onclick=\"get_ticket_and_populate_wrapper('1650'); return false;\" title=\"Submitting multiple VMWare jobs with single submit doesn't work\">#1650</a></span> Grid and vm universe attributes shouldn't be disabling the cluster ad check in InsertJobExpr().  (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Jan-05 11:04", "status": "resolved", "created": "2010-Sep-13 14:33", "fixed_version": "2010-Sep-13 14:33", "broken_version": "v070400", "priority": "4", "subsystem": "VM", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "purdue", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}