{"id": 4646, "title": "Ticket #4646: DaemonCore::Create_Process() PID collision code core dumps?", "description": "<blockquote>\nLIGO just had a schedd core dump.  This happened in the code that deals with PID collisions, which seems to be pretty infrequently exercised.  I haven't verified so far whether you get a core dump <strong>every</strong> time you hit that code.\n\n<p>Anhow, here's the core dump:\n\n</p><p></p><pre>  10/09/14 03:26:32 (pid:3350) Started shadow for job 5352589.388 on\n    slot2@node343.cluster.ldas.cit &lt;10.14.2.93:40991&gt; for archis,\n    (shadow pid = 9847)\n  10/09/14 03:26:32 (pid:3350) Starting add_shadow_birthdate(5352589.394)\n  10/09/14 03:26:32 (pid:3350) Create_Process(/usr/sbin/condor_shadow):\n    child failed because PID 9848 is still in use by DaemonCore\n  Stack dump for process 3350 at timestamp 1412850392 (14 frames)\n  /usr/lib64/condor/libcondor_utils_8_2_2.so(dprintf_dump_stack+0x12d)\n    [0x7fcd5c7c49ed]\n  /usr/lib64/condor/libcondor_utils_8_2_2.so(_Z18linux_sig_coredumpi+0x40)\n    [0x7fcd5c91d970]\n  /lib64/libpthread.so.0[0x3f0f80f710]\n  /usr/lib64/condor/libcondor_utils_8_2_2.so\n    (_ZN10DaemonCore14Create_ProcessEPKcRK7ArgList10priv_stateiiPK3EnvS1_P10FamilyInfoPP6StreamPiSE_iP10__sigset_tiPmSE_S1_P8MyStringP15FilesystemRemapl+0x39d7)\n    [0x7fcd5c917707]\n  condor_schedd[0x48cd9e]\n  condor_schedd[0x48db57]\n  condor_schedd[0x48e214]\n  condor_schedd[0x48e462]\n  condor_schedd[0x48e5e6]\n  /usr/lib64/condor/libcondor_utils_8_2_2.so\n    (_ZN12TimerManager7TimeoutEPiPd+0x1a1)[0x7fcd5c921e51]\n  /usr/lib64/condor/libcondor_utils_8_2_2.so\n    (_ZN10DaemonCore6DriverEv+0xbf7)[0x7fcd5c909217]\n  /usr/lib64/condor/libcondor_utils_8_2_2.so\n    (_Z7dc_mainiPPc+0x1799)[0x7fcd5c91faf9]\n  /lib64/libc.so.6(__libc_start_main+0xfd)[0x3f0f01ed5d]\n  condor_schedd[0x41b229]\n</pre>\n\n<p>Interestingly, this is the last previous reference to that PID:\n\n</p><p></p><pre>  10/08/14 17:52:05 (pid:3350) Started shadow for job 5352371.0 on\n    slot1@node391.cluster.ldas.cit &lt;10.14.2.141:43119&gt; for sano,\n    (shadow pid = 9848)\n</pre>\n\n<p>(Nothing about the job exiting.)</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Oct-10 16:38:25 by wenger:</em> <br/>\n\nFrom the relevant <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span>:\n\n<p></p><pre>  10/08/14 08:31:07 (pid:3350) ** $CondorVersion: 8.2.2 Aug 07 2014\n    BuildID:265643 $\n  10/08/14 08:31:07 (pid:3350) ** $CondorPlatform: x86_64_RedHat6 $\n</pre>\n\n<p></p><hr/>\n<em>2014-Oct-10 17:08:45 by tannenba:</em> <br/>\n\nLooks like this bug appeared starting in v8.1.6 in commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ac1963f4518be41868c65973b8e0dc4d84a09604\">[38724]</a></span> as part of the IPv6 work, and remained hidden because it only gets triggered if a PID is reused quickly.  And that is a rare event on Linux at least...\n\n<p></p><hr/>\n<em>2014-Oct-10 17:15:21 by tannenba:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Alan <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DeSmet\" title=\"De Smet\">DeSmet</a></span> did a code review (over ToddT's shoulder), and approves.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-06 15:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f8de4dc9ac0d1c369f165ecb8f68d3800522d812\">[41605]</a></span>: minor formatting change to 8.2.4 version history item <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4646\" onclick=\"get_ticket_and_populate_wrapper('4646'); return false;\" title=\"DaemonCore::Create_Process() PID collision code core dumps?\">#4646</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-24 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3282fead2c24d0e8dfbe460a2af2561aebc6ea8b\">[41474]</a></span>: Fix potential core dump on create_process pid collision. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4646\" onclick=\"get_ticket_and_populate_wrapper('4646'); return false;\" title=\"DaemonCore::Create_Process() PID collision code core dumps?\">#4646</a></span> If Create_Process encounters a pid collision, and the child being spawned has a TCP command socket but no UDP command socket, the daemon will likely crash. This bug crashed the schedd, starting shadows with no UDP command port...\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-24 13:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/17f5388aa7ed59f2d8607e11f5083e9e62134d55\">[41475]</a></span>: Added a version history blurb for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4646\" onclick=\"get_ticket_and_populate_wrapper('4646'); return false;\" title=\"DaemonCore::Create_Process() PID collision code core dumps?\">#4646</a></span> Committer: Todd L Miller  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-10 17:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/559c7f9973f909a45a888a8d253fe8fff61c69ad\">[41388]</a></span>: Added a version history blurb for <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4646\" onclick=\"get_ticket_and_populate_wrapper('4646'); return false;\" title=\"DaemonCore::Create_Process() PID collision code core dumps?\">#4646</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-10 17:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/600250fc9a8b92599590f820822cb37917d86143\">[41387]</a></span>: Fix potential core dump on create_process pid collision. <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4646\" onclick=\"get_ticket_and_populate_wrapper('4646'); return false;\" title=\"DaemonCore::Create_Process() PID collision code core dumps?\">#4646</a></span> If Create_Process encounters a pid collision, and the child being spawned has a TCP command socket but no UDP command socket, the daemon will likely crash. This bug crashed the schedd, starting shadows with no UDP command port...  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Oct-10 17:16", "status": "defer", "created": "2014-Oct-10 14:45", "fixed_version": "2014-Oct-10 14:45", "broken_version": "v080106", "priority": "5", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "wenger", "rust": "a27397", "customer_group": "ligo", "visibility": "public", "notify": "wenger@cs.wisc.edu,tannenba@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}