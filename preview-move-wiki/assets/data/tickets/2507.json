{"id": 2507, "title": "Ticket #2507: Partitionable slots devolving into regular slots", "description": "<blockquote>\nSubmitting jobs against some partitionable slots results in the slots transforming into regular slots, instead of peeling new dynamic slots off and leaving the original part. slots intact.\n\n<p>REPRO:\n\n</p><p>use this configuration:\n</p><div class=\"code\">\n<pre class=\"code\">NEGOTIATOR_DEBUG = D_FULLDEBUG\nSCHEDD_INTERVAL\t= 15\n\nNUM_CPUS = 20\nSLOT_TYPE_1 = cpus=4\nSLOT_TYPE_1_PARTITIONABLE = TRUE\nNUM_SLOTS_TYPE_1 = 5\n</pre></div>\n\n\n<p>Start up the pool, and you should see 5 partitionable slots (code \"P\", below):\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_status -for \"%s\" Machine -for \" | %s\" 'ifThenElse(PartitionableSlot =?= TRUE, \"P\", ifThenElse(DynamicSlot =?= TRUE, \"D\", \"S\"))' -for \" | %s\" State -for \" | %s\" Activity -for \" | %s\\n\" Cpus\nrorschach.localdomain | P | Unclaimed | Idle | 4\nrorschach.localdomain | P | Unclaimed | Idle | 4\nrorschach.localdomain | P | Unclaimed | Idle | 4\nrorschach.localdomain | P | Unclaimed | Idle | 4\nrorschach.localdomain | P | Unclaimed | Idle | 4\n</pre></div>\n\n\n<p>(note that the command above can display \"P\" -&gt; \"partitionable\",  \"D\" --&gt; \"dynamic\" and \"S\" --&gt; regular slot)\n\n</p><p>Now submit 10 jobs, which ought to be able to run by peeling off 10 dynamic slots:\n</p><div class=\"code\">\n<pre class=\"code\">universe = vanilla\ncmd = /bin/sleep\nargs = 1800\nshould_transfer_files = if_needed\nwhen_to_transfer_output = on_exit\n+AccountingGroup=\"a.user\"\nqueue 10\n</pre></div>\n\n\n<p>After submitting the job above, and waiting a couple cycles, we would hope to see 5 partitionable slots (\"P\") and 10 dynamic slots (\"D\"), but what we see instead are only 5 regular slots (\"S\") (and only 5 jobs running):\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_submit t.jsub\nSubmitting job(s)..........\n10 job(s) submitted to cluster 2.\n\n# only five jobs ran\n$ condor_q | tail -1\n10 jobs; 5 idle, 5 running, 0 held\n\n# only regular slots!\n$ condor_status -for \"%s\" Machine -for \" | %s\" 'ifThenElse(PartitionableSlot =?= TRUE, \"P\", ifThenElse(DynamicSlot =?= TRUE, \"D\", \"S\"))' -for \" | %s\" State -for \" | %s\" Activity -for \" | %s\\n\" Cpus\nrorschach.localdomain | S | Claimed | Busy | 1\nrorschach.localdomain | S | Claimed | Busy | 1\nrorschach.localdomain | S | Claimed | Busy | 1\nrorschach.localdomain | S | Claimed | Busy | 1\nrorschach.localdomain | S | Claimed | Busy | 1\n</pre></div>\n\n\n<p>Removing the jobs does not return our original slots back:\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_rm -all\nAll jobs marked for removal.\n\n$ condor_q | tail -1\n0 jobs; 0 idle, 0 running, 0 held\n\n$ condor_status -for \"%s\" Machine -for \" | %s\" 'ifThenElse(PartitionableSlot =?= TRUE, \"P\", ifThenElse(DynamicSlot =?= TRUE, \"D\", \"S\"))' -for \" | %s\" State -for \" | %s\" Activity -for \" | %s\\n\" Cpus\nrorschach.localdomain | S | Unclaimed | Idle | 1\nrorschach.localdomain | S | Unclaimed | Idle | 1\nrorschach.localdomain | S | Unclaimed | Idle | 1\nrorschach.localdomain | S | Unclaimed | Idle | 1\nrorschach.localdomain | S | Unclaimed | Idle | 1\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2011-Sep-27 18:18:46 by eje:</em> <br/>\n\nI'm repro-ing on 7.7.1\n\n<p></p><hr/>\n<em>2011-Sep-27 19:10:39 by matt:</em> <br/>\n\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1943\" onclick=\"get_ticket_and_populate_wrapper('1943'); return false;\" title=\"single slot with multiple cpus is names slot1@blah\">#1943</a></span> and sha 7d968fe0 changed Resource's constructor signature, but missed the dynamic slot creation in command.cpp\n\n<p></p><div class=\"code\">\n<pre class=\"code\">diff --git a/src/condor_startd.V6/command.cpp b/src/condor_startd.V6/command.cpp\nindex 3bde265..1f800c5 100644\n--- a/src/condor_startd.V6/command.cpp\n+++ b/src/condor_startd.V6/command.cpp\n@@ -1221,7 +1221,7 @@ request_claim( Resource* rip, Claim *claim, char* id, Stream* stream )\n                        ABORT;\n                }\n\n-               new_rip = new Resource( cpu_attrs, rip-&gt;r_id, rip );\n+               new_rip = new Resource( cpu_attrs, rip-&gt;r_id, true, rip );\n                if( ! new_rip ) {\n                        rip-&gt;dprintf( D_ALWAYS,\n                                                  \"Failed to build new resource for request, aborting\\n\" );\n</pre></div>\n\n\n<p>We need a regression test for dynamic slots.\n\n</p><p></p><hr/>\n<em>2011-Sep-28 08:26:52 by tstclair:</em> <br/>\n\n+1 we should add a test to the suite.\n\n<p></p><hr/>\n<em>2011-Sep-28 12:15:13 by eje:</em> <br/>\n\nTEST:\n\n<p>If you run the repro scenario above with the fix, you should now see dynamic slots correctly appearing (and the parent partitionable slots remaining):\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_status -for \"%s\" Machine -for \" | %s\" 'ifThenElse(PartitionableSlot =?= TRUE, \"P\", ifThenElse(DynamicSlot =?= TRUE, \"D\", \"S\"))' -for \" | %s\" State -for \" | %s\" Activity -for \" | %s\\n\" Cpus\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | D | Claimed | Busy | 1\nrorschach.localdomain | P | Unclaimed | Idle | 2\nrorschach.localdomain | P | Unclaimed | Idle | 2\nrorschach.localdomain | P | Unclaimed | Idle | 2\nrorschach.localdomain | P | Unclaimed | Idle | 2\nrorschach.localdomain | P | Unclaimed | Idle | 2\n</pre></div>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2514\" onclick=\"get_ticket_and_populate_wrapper('2514'); return false;\" title=\"Regression test for partitionable slots\">#2514</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRegression test for partitionable slots</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 12:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0eefcdb4a290f0a8966d92c25eeabb5f285fb16f\">[27449]</a></span>: Fixed bug in the startd that was preventing dynamic slots from being correctly peeled off partitionable slots ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2507\" onclick=\"get_ticket_and_populate_wrapper('2507'); return false;\" title=\"Partitionable slots devolving into regular slots\">#2507</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 12:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2393bd4a6e483785b85c3f724a3c6af723f284cd\">[27450]</a></span>: ===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2507\" onclick=\"get_ticket_and_populate_wrapper('2507'); return false;\" title=\"Partitionable slots devolving into regular slots\">#2507</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 12:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a538784d96cb5b4cd4dfe24b5c18ace70e63446d\">[27448]</a></span>: ===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2507\" onclick=\"get_ticket_and_populate_wrapper('2507'); return false;\" title=\"Partitionable slots devolving into regular slots\">#2507</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-28 12:08</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b03ddd50f440f3d8b7779a3cc081ebf2e5e54e7d\">[27447]</a></span>: Fixed bug in the startd that was preventing dynamic slots from being correctly peeled off partitionable slots ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2507\" onclick=\"get_ticket_and_populate_wrapper('2507'); return false;\" title=\"Partitionable slots devolving into regular slots\">#2507</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2011-Nov-29 10:06", "status": "resolved", "created": "2011-Sep-27 17:57", "fixed_version": "2011-Sep-27 17:57", "broken_version": "v070701", "priority": "1", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, matt@cs.wisc.edu, tstclair@redhat.com, gthain@cs.wisc.edu, dan@hep.wisc.edu", "due_date": ""}