{"id": 2064, "title": "Ticket #2064: Allow Condor to keep the file descriptor open between writing logs", "description": "<blockquote>\nOn Windows when opening files it is possible to deny write access to them.  Many applications do this when reading a file, including Explorer when it is copying files between locations.  This will result in Condor failing when it tries to write its logs out.\n\n<p>The proposed solution is to provide a flag that will keep the file open on Windows, if and only if file locking is not also enabled.  As the shadow is the only daemon that needs file locking and its failure does not bring down all of Condor, the other daemons should not be affected by this.  The current plan is to only offer this on Windows due to a global FD limit on Linux.  The current default is also to turn this off until more testing is done.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Apr-20 15:32:19 by tannenba:</em> <br/>\n\nWithout looking at the code, some high level questions to address during the review:\n\n<p></p><ol>\n<li>How is <code>D_FDS</code> handled?  Seems like if and only if <code>D_FDS</code> is specified, the logging code would need to open a separate file to identify the (highest) active fd number.\n\n<p></p></li><li>Seems like you need to close the file at rotation time, so is the original problem really solved, or is the window of vulnerability just made smaller?  What do we do (and what can we do) if someone opens the daemon log file right between when we close the file and then attempt to rotate it?\n\n<p></p></li><li>While the immediate problem is Windows specific, it might be nice if the functionality of keeping the fd open worked on both Unix and Windows.  By default, perhaps we could keep all daemon logs open on Windows, and on Unix we keep all daemon logs open EXCEPT for the shadow and dagman which should still open/close at each entry (since we don't want to exhaust system or uid wide fd limits on unix).\n\n<p></p></li><li>IF locking on the daemon log is specified (no longer the default anywhere, incl the shadow), I assume we still open/close the log as we always did?\n</li></ol>\n\n<p></p><hr/>\n<em>2011-Apr-21 08:39:41 by tstclair:</em> <br/>\n\nFor the 7.7 series why don't we just look into a pluggable non-blocking logging daemon.... Seriously...?\n\n<p>You could still preserve the base case, but redirect calls if plugin override exists.  I have example code for this which is on my public directory @ UW.\n\n</p><p></p><hr/>\n<em>2011-May-02 15:28:56 by bbockelm:</em> <br/>\n\nTwo thoughts:\n<ol>\n<li>I think the community would prefer a pluggable logging daemon.  The condor logging systems has great things about it, but the lack of choice is frustrating.\n</li><li>The maximum number of file descriptors on the servers I can find are dynamically adjusted based upon the amount of RAM on the machine (maybe it's a RHEL5 thing?  I can't find this documented online anywhere).  It's not possible for <strong>me</strong> to exhaust the FDs this way: the virtual memory system would go first.  Mileage may vary on other distros; something worth investigating.\n</li></ol>\n\n<p></p><div class=\"verbatim\">\n<pre>[bbockelm@red ~]$ cat /proc/sys/fs/file-max\n1600885\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-May-02 15:42:53 by ziliang:</em> <br/>\n\nSo to address the issues so far.\n\n<p>Todd:\n\n</p><p>1. D_FDS is handled by opening the NULL file to get the FD count.\n\n</p><p>2. On Windows, the window of vulnerability still exists, in a much smaller form, during log rotation.  But the rotation code actually has code to do retries whereas the general logging code does not.\n\n</p><p>3. Done, though I need to turn it off for dagman as well.\n\n</p><p>4. Yes.  If locking is enabled, we revert to old behavior.\n\n</p><p>tstclair:\n\n</p><p>Next step, which will be a separate ticket, will be to reverse the order of formatting and opening of log so that we format the log message first.  That way we can direct that message to whatever output we want.  So you'll get at least the framework to build a logging daemon from.\n\n</p><p>bbockelm:\n\n</p><p>1. See what I said to tstclair.\n\n</p><p>2. We have had users that actually ran into the FD limit due to too many shadows running at the same time and keeping their files open.\n\n</p><p></p><hr/>\n<em>2011-May-02 18:06:20 by bbockelm:</em> <br/>\n\nHi Ziliang,\n\n<p>I'm sure we hit the global FD limit in the past due to the shadow.  I just checked: since kernel 2.6.0, the global FD limit defaults to approximately (KB of RAM)/10.\n\n</p><p>Assuming each shadow takes 1MB RAM, we should be fine as long as we stay under ~100 FDs per shadow; I count 18 on a running node.\n\n</p><p>So - I think that, if a decision is made, it shouldn't be made based upon the global FD limit.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2011-May-02 19:37:51 by ziliang:</em> <br/>\n\nRight now the functionality has been added to Linux.  I still need to run my commits through the test suite.  The decision is a question of whether to turn this on by default or not.  On Windows, it is turned on for all daemons.  On Linux, it is turned on by default for all daemons except the shadow, gridmanager, and dagman.\n\n<p></p><hr/>\n<em>2011-May-02 19:40:11 by ziliang:</em> <br/>\n\nI forgot to mention, it is possible to turn it on even for those daemons by simply setting a config knob.  It is just that if no configuration knob is specified, defaults are different for shadow, gridmanager, and dagman on Windows versus Linux.\n\n<p></p><hr/>\n<em>2011-May-13 16:39:39 by ziliang:</em> <br/>\n\nAfter discussions with Kent, he believes that we should be able to safely keep the log files open by default for dagman.\n\n<p></p><hr/>\n<em>2011-May-19 16:10:44 by ziliang:</em> <br/>\n\nCode reviewed by TJ.  Merging into master to be part of 7.7.0 release.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2159\" onclick=\"get_ticket_and_populate_wrapper('2159'); return false;\" title=\"Various daemons are bypassing dprintf for access to the log file\">#2159</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nVarious daemons are bypassing dprintf for access to the log file</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2518\" onclick=\"get_ticket_and_populate_wrapper('2518'); return false;\" title=\"Child processes are inheriting log files on Windows\">#2518</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nChild processes are inheriting log files on Windows</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4575\" onclick=\"get_ticket_and_populate_wrapper('4575'); return false;\" title=\"Daemons with a debug lock file should leave log open\">#4575</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nDaemons with a debug lock file should leave log open</td></tr>\n</tbody></table>", "attachments": "", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-19 16:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=26106\">[26106]</a></span>: Add documentation for keeping daemon logs open between writes and advertising .NET framework versions. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=1930\" onclick=\"get_ticket_and_populate_wrapper('1930'); return false;\" title=\"Add support for advertising .NET on Windows\">#1930</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-19 16:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21921\">[21921]</a></span>: Merged <span class=\"chng\"><a href=\"chngview?cn=21227\">[21227]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21228\">[21228]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21231\">[21231]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21232\">[21232]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21233\">[21233]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21239\">[21239]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21240\">[21240]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21241\">[21241]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21242\">[21242]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21244\">[21244]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21246\">[21246]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21251\">[21251]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21252\">[21252]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21259\">[21259]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21260\">[21260]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21261\">[21261]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21262\">[21262]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21263\">[21263]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21264\">[21264]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21266\">[21266]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21269\">[21269]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21404\">[21404]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21410\">[21410]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21424\">[21424]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21444\">[21444]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21448\">[21448]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21450\">[21450]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21561\">[21561]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21564\">[21564]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21608\">[21608]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21618\">[21618]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21625\">[21625]</a></span>, <span class=\"chng\"><a href=\"chngview?cn=21769\">[21769]</a></span>,\u00a0[...]\n (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-16 11:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21873\">[21873]</a></span>: Make checking if FD is for a log in std univ starter more efficient. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-13 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21867\">[21867]</a></span>: Add the ability to get the FDs of all open log files. Fix the closing of so-called unneeded FDs in the standard universe starter. Fixes closing of log files out from under dprintf. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-04 16:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21786\">[21786]</a></span>: Hackfix for DebugFP usage in the Amazon gahp. Need to resolve in a better way later. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-02 14:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21774\">[21774]</a></span>: Port keeping log open to Linux, turning it on by default for everyone except the shadow. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-01 13:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21771\">[21771]</a></span>: Fix undeclared variable. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-May-01 12:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21770\">[21770]</a></span>: Reinsert some cleanup code. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-29 10:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21625\">[21625]</a></span>: Separate Unix and Windows code correctly in debug_lock. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-27 15:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21608\">[21608]</a></span>: Additional cleanup of dprintf keeping files open. First step in remerging Windows and Unix opening of debug logs. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-25 17:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21564\">[21564]</a></span>: Properly ifdef out Windows specific array for tracking open files. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-25 13:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21561\">[21561]</a></span>: Fix F_FDS debug option when files are kept open. Also delay closing of file during log rotation. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-20 09:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21450\">[21450]</a></span>: Turn on keeping file open by default on Windows for testing purposes. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-19 17:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21448\">[21448]</a></span>: Correctly store the opened FP to avoid trying to constantly open a file over and over again. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-15 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21410\">[21410]</a></span>: ifdef out more of the bookkeeping stuff for keeping logs open on Windows for other platforms. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Apr-14 16:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=21404\">[21404]</a></span>: Reduce reliance on the global variable DebugFP inside functions and use a local variable instead. Add in an array of file pointers for Windows for use when we want to keep files open. Ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2064\" onclick=\"get_ticket_and_populate_wrapper('2064'); return false;\" title=\"Allow Condor to keep the file descriptor open between writing logs\">#2064</a></span>.  (By Ziliang Guo )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2011-Sep-19 17:06", "status": "resolved", "created": "2011-Apr-14 16:59", "fixed_version": "2011-Apr-14 16:59", "broken_version": "v070400", "priority": "3", "subsystem": "Daemons", "assigned_to": "ziliang", "derived_from": "#2476", "creator": "ziliang", "rust": "s8033", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu, tstclair@redhat.com, bbockelm@cse.unl.edu", "due_date": ""}