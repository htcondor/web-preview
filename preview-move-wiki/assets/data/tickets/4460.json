{"id": 4460, "title": "Ticket #4460: Further improvements to negotiation over high latency links", "description": "<blockquote>\n<span class=\"subsection\"><h3>Resource Request Lists</h3></span>\nIn <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3585\" onclick=\"get_ticket_and_populate_wrapper('3585'); return false;\" title=\"Negotiation protocol slow over high latency links\">#3585</a></span>, we added the concept of a <em>resource request count</em>. With resource request counts, when the schedd sends a request to the negotiator, it includes an attribute that says \"I want X number of resources like this\".  This definitely improved the speed of negotiation over high latency links (i.e. the wide-area internet) when making a lot of matches.  However, if the schedd has a large number of autoclusters that do not match, they still are sent to the negotiator one at a time with a round-trip in between.  In CMS, there are schedds sprinkled around the world, and at times there are hundreds of autoclusters that do not match.\n\n<p>The work in this ticket allows the negotiator to ask for a <em>resource request list</em> from the schedd.  A resource request list is a list of sorted resource requests, perhaps each with a resource request count. The negotiation protocol has been enhanced so the negotiator can ask the schedd to send a request list with a specified maximum number of entries.  This maximum is controlled by the negotiator knob <code>NEGOTIATOR_RESOURCE_REQUEST_LIST_SIZE</code> (default value is 20); if set to 1, or if talking to an older schedd that does not implement the enhanced protocol, then the old protocol is used.   Currently, setting this knob to a value greater than 50 or so may result in the schedd blocking on network I/O while sending the requests to the negotiator.  In addition, with the new protocol, the resource requests themselves are no longer the entire job classad - instead, they are just the significant attributes from the job ad plus a few extra attributes (like cluster, proc, etc) that are explicitly examined by the negotiator.  This makes the resource requests themselves much smaller than a job ad, speeding their transfer and minimizing the memory footprint at the negotiator.\n\n</p><p><span class=\"subsection\"></span></p><h3>Potential Future Work</h3>\nThe code in the negotiator that communicates with the schedd has been refactored into its own class in order to enable a variety of options should we need to make further scalability improvements. Some ideas include:\n<ul>\n<li>The schedd could perform non-blocking network I/O when sending the request list, allowing it to send hundreds (thousands?) of requests without worry of impacting schedd performance.\n</li><li>Currently the resource request list in the negotiator is not kept between pie-spins, thereby requiring negotiation to \"start over\" at each pie spin.  The code in the negotiator that communicates with the schedd has been refactored to enable potential caching of this list (keyed by a tuple of user/schedd) across pie spins. Note doing this safely would require i) knowing if autocluster id wrapping has occured in the schedd, and ii) knowing if a match has been refused due to no-match-found or due to priority limits, as in the case of the latter the request must be tried again after a pie spin.\n</li><li>Request lists could be fetched from multiple schedds/submitters in parallel at the start of the cycle.  This probably only makes sense if the negotiator must examine all queued jobs to honor the semantics of preemption or startd rank expressions, i.e. if  <code>NEGOTIATOR_CONSIDER_PREEMPTION=True</code> (in CMS it is currently False).</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-14 13:19:23 by tannenba:</em> <br/>\n\nNote that the resource request list code assumes that <code>USE_RESOURCE_REQUEST_COUNTS</code> has the default value of True.  The code will disable resource request lists if request counts has been explicitly set to false in the config file.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4508\" onclick=\"get_ticket_and_populate_wrapper('4508'); return false;\" title=\"Improve debug log messages for negotiator request lists\">#4508</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nImprove debug log messages for negotiator request lists</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-12 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40945\">[40945]</a></span>: minor edits to 8.3.0 new knob documentation <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-12 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40944\">[40944]</a></span>: Added documentation and version history entry for request lists. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-15 12:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40655\">[40655]</a></span>: Disable resource request lists when talking with an older schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span> Check the schedd version in the submitter ad, and do not use resource request lists if schedd is older than v8.3.0. Also do not use request lists if USE_RESOURCE_REQUEST_COUNTS has been explicitly set to False in the config file.\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-15 09:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40652\">[40652]</a></span>: fix fedora warning for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span>, unused varible  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 15:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40643\">[40643]</a></span>: fix <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span> for new putClassAd with projection functions  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 14:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40639\">[40639]</a></span>: Negotiator-side changes to support resource request list protocol. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span> Added knob NEGOTIATOR_RESOURCE_REQUEST_LIST_SIZE to control the number of requests fetched per round-trip to the schedd; defaults to 20.\u00a0[...]\n (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 13:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=40638\">[40638]</a></span>: schedd-side changes to support resource request list protocol. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4460\" onclick=\"get_ticket_and_populate_wrapper('4460'); return false;\" title=\"Further improvements to negotiation over high latency links\">#4460</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Aug-12 14:03", "status": "resolved", "created": "2014-Jul-14 11:40", "fixed_version": "2014-Jul-14 11:40", "broken_version": "", "priority": "2", "subsystem": "DaemonsCM", "assigned_to": "tannenba", "derived_from": "#3585", "creator": "tannenba", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, isfiligoi@ucsd.edu", "due_date": ""}