{"id": 5175, "title": "Ticket #5175: Have condor_dagman condor_rm jobs on SIGUSR1 (revert #4618)", "description": "<blockquote>\nIn <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4618\" onclick=\"get_ticket_and_populate_wrapper('4618'); return false;\" title=\"Remove DAGMan code that condor_rms node jobs on condor_rm of DAGMan\">#4618</a></span>, the assumption was made that SIGUSR1 implies the schedd is removing the DAGMan job, hence DAGMan no longer needs to do the 'condor_rm' itself.\n\n<p>It seems that we have taken off our suspenders and are living dangerously with only a belt!\n\n</p><p>For CMS, we use SIGUSR1 as the hold signal also (we do this so users can return later and restart the dagman job).  Hence, after upgrading to 8.3.2, DAGMan started leaking jobs.\n\n</p><p>Can we either revert <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4618\" onclick=\"get_ticket_and_populate_wrapper('4618'); return false;\" title=\"Remove DAGMan code that condor_rms node jobs on condor_rm of DAGMan\">#4618</a></span> outright or restore the prior behavior as a config option?</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-27 09:24:45 by wenger:</em> <br/>\n\nI'll think about doing this as a config option -- I don't think we want to go back as the default.  I can't remember how completely the code is torn out -- it may not be too hard to put in a config option for this...\n\n<p>One question, though:  is there a reason you can't do condor_rm instead of condor_hold on the DAG, as a workaround?  Is the DAG you're holding a sub-DAG?  If not, as far as I can tell, you could accomplish pretty much the same thing by condor_rm'ing your DAGMan, and then re-submitting it and having it run the rescue DAG when you want to continue.\n\n</p><p>(I assume that you'd also want to kill running PRE and POST scripts if this option is enabled...)\n\n</p><p></p><hr/>\n<em>2015-Jul-27 15:57:21 by bbockelm:</em> <br/>\n\nHi Kent,\n\n<p>The reason we use condor_hold here is that the DAG and all its related files live in $SPOOL.  If we do a condor_rm, all our state goes away.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jul-30 11:13:41 by tannenba:</em> <br/>\n\nHi Brian,\n\n<p>How are jobs being <em>leaked</em> ?  My definition of leak is there are jobs in the queue submitted by DAGMan, and yet the DAGMan job has been removed.\n\n</p><p>In the current code, if you did a condor_hold of the dagman job, the dagman goes on hold and thus no further progress is made in the workflow, but jobs submitted by dagman up to that point can continue and finish.  If you remove the held DAGMan job, all workflow jobs are removed (covering this case this was a major reason we adopted <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4618\" onclick=\"get_ticket_and_populate_wrapper('4618'); return false;\" title=\"Remove DAGMan code that condor_rms node jobs on condor_rm of DAGMan\">#4618</a></span> and one of the reasons we do not want to revert it).  So I don't see how any jobs are leaked...\n\n</p><p>Sounds like what you want is condor_hold of a dag should not only pause submission of new jobs, but also cancel the already submitted jobs.  Seems like pretty specific behavior.  As such, on your end would it be easy to do the following to get the behavior you want:\n\n</p><p></p><pre>   condor_hold &lt;DAG job&gt;  (assuming SIGUSR1 set as hold signal)\n   condor_rm -cons 'DAGManJobId=?=&lt;DAG job&gt;'\n</pre>\n\n<p>We don't want to revert <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4618\" onclick=\"get_ticket_and_populate_wrapper('4618'); return false;\" title=\"Remove DAGMan code that condor_rms node jobs on condor_rm of DAGMan\">#4618</a></span>, but perhaps we could put in a knob that if True it tells DAGMan to remove its own children via the same condor_rm -cons command above (knob would default to false).\n\n</p><p>Also, should this be a child ticket of <span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=5162\" onclick=\"get_ticket_and_populate_wrapper('5162'); return false;\" title=\"Parent ticket: CMS Global Pool issues July 2015\">#5162</a></span> and thus, as a priority 2 ticket, is this something that must be resolved for v8.3.8?\n\n</p><p>Thanks\n\n</p><p></p><hr/>\n<em>2015-Jul-30 15:12:31 by bbockelm:</em> <br/>\n\nHi Todd,\n\n<p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=HoldKillSig\" title=\"Hold Kill Sig\">HoldKillSig</a></span> for CMS dag jobs is SIGUSR1.  Hence, we expect all jobs are removed when we do condor_hold of the dag job.\n\n</p><p>The problem with <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4618\" onclick=\"get_ticket_and_populate_wrapper('4618'); return false;\" title=\"Remove DAGMan code that condor_rms node jobs on condor_rm of DAGMan\">#4618</a></span> is that, before, SIGUSR1 meant \"cleanup jobs and exit with no rescue DAG\".  Now it means simply \"cleanup jobs\", and it assumes someone else will perform the cleanup (where the assumption certainly does not hold for us!).\n\n</p><p>Having a knob to return to the old behavior is certainly acceptable.  I realize we're not the most common use case.\n\n</p><p>I moved this down to a priority 3 ticket because we have a workaround in place (basically what you suggested, except we do it within the python bindings.  Hence, it's not necessary for 8.3.8.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2016-Feb-01 15:23:45 by wenger:</em> <br/>\n\nAlso see discussion in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4209\" onclick=\"get_ticket_and_populate_wrapper('4209'); return false;\" title=\"DAG final node goofs up node status file\">#4209</a></span>.\n\n<p></p><hr/>\n<em>2016-Apr-12 16:38:43 by wenger:</em> <br/>\n\nNote:  The way to test DAGMan removing its own child jobs is to essentially make a copy of the job_dagman_rm test, except with config to turn on the remove option, and a -append line to condor_submit_dag that unsets the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=OtherJobRemoveRequirements\" title=\"Other Job Remove Requirements\">OtherJobRemoveRequirements</a></span> attribute.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Oct-26 14:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ad94129cf9c677d0d244a4f624c67e68b2c81841\">[49474]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5175\" onclick=\"get_ticket_and_populate_wrapper('5175'); return false;\" title=\"Have condor_dagman condor_rm jobs on SIGUSR1 (revert #4618)\">#5175</a></span>: Improved documentation related to this ticket.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-17 14:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89b5f1536a920dbab08cdceffc79c8babf572d86\">[49026]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=5702\" onclick=\"get_ticket_and_populate_wrapper('5702'); return false;\" title=\"condor_rm on scheduler universe job does not halt submission\">#5702</a></span> / <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5175\" onclick=\"get_ticket_and_populate_wrapper('5175'); return false;\" title=\"Have condor_dagman condor_rm jobs on SIGUSR1 (revert #4618)\">#5175</a></span>: Added new DAGMAN_REMOVE_NODE_JOBS config knob that allows users to enable the old behavior of DAGMan removing its node jobs itself when it is condor_rm'ed.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Aug-17 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ff9adf73170e38f84a755da671a99577c79c03d\">[49025]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5207\" onclick=\"get_ticket_and_populate_wrapper('5207'); return false;\" title=\"Backwards compatibility for pslot preemption\">#5207</a></span> / <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=5175\" onclick=\"get_ticket_and_populate_wrapper('5175'); return false;\" title=\"Have condor_dagman condor_rm jobs on SIGUSR1 (revert #4618)\">#5175</a></span>: Added new DAGMAN_REMOVE_NODE_JOBS config knob that allows users to enable the old behavior of DAGMan removing its node jobs itself when it is condor_rm'ed.  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "incident", "last_change": "2016-Oct-12 15:36", "status": "resolved", "created": "2015-Jul-27 08:06", "fixed_version": "2015-Jul-27 08:06", "broken_version": "", "priority": "1", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "tannenba@cs.wisc.edu, bbockelm@cse.unl.edu, wenger@cs.wisc.edu", "due_date": ""}