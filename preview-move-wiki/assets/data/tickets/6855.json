{"id": 6855, "title": "Ticket #6855: transfer file transfer plugin along with the job", "description": "<blockquote>\nIt should be possible to transfer a file transfer plugin along with a job.  This would allow file transfer plugins to be managed on the submit node, or event to be created by advanced users.  It would also allow for a much faster development cycle for transfer plugins.\n\n<p>The proposed solution is to add an attribute to the job that specifies the name of the plugin, and the URL tags that that plugin supports.  Something like this\n\n</p><p></p><pre>    transfer_plugins = ZKM=/path/to/zkm_plug.exe; HTTP,HTTPS=my_http_plugin.exe\n</pre>\n\n<p>This would add the following to the job.\n\n</p><p></p><pre>    TransferPlugins = \"ZKM=/path/to/zkm_plug.exe; HTTP,HTTPS=my_http_plugin.exe\"\n</pre>\n\n<p>Then when the job has\n\n</p><p></p><pre>    transfer_input_files = ZKM://myfile,  HTTP://stuff, HTTPS://morestuff\n</pre>\n\n<p>Condor submit would NOT add the ZKM and HTTP file transfer plugin tags to the job's requirements expression, but would instead it would add <code>TARGET.HasJobTransferPlugins</code> to the job's requirements expression.  Starters that support file transfer plugins supplied by the job will advertise this attribute.\n\n</p><p>If there are plugin prefixes in the list of files to be transferred that are not included in the <code>TransferPlugins</code> list, then those plugins would still be added to the job's requirements expression. so\n\n</p><p></p><pre>    transfer_plugins = ZKM=/path/to/zkm_plug.exe; HTTP,HTTPS=my_http_plugin.exe\n    transfer_input_files = ZKM://myfile,  HTTP://stuff, HTTPS://morestuff, FTP://file\n</pre>\n\n<p>Would result in a requirements expression that had\n\n</p><p></p><pre>    Requirements = .. &amp;&amp; (TARGET.HasJobTransferPlugins &amp;&amp; stringListIMember(\"FTP\",TARGET.HasFileTransferPluginMethods))\n</pre>\n\n<p>When the file transfer class is initialized, it will be passed the job ad, so after it loads the transfer plugins from configuration, it will then parse the job's <code>TransferPlugins</code> attribute and add the plugins it finds there to the list of available plugins.  Thus plugins transferred by the job will be preferred to plugins available on the execute node.\n\n</p><p>Because there is no way to indicate whether a plugin is single or multi-file, multi-file will be assumed for plugins transferred with the job.\n\n</p><p>Plugins transferred with the job will never be run as root.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Jan-30 12:30:21 by johnkn:</em> <br/>\n\nSee the patch file for an implementation.  The patch works with the following submit file.  The \"transfer plugin\" in this case is myplug.cmd, which I have verified gets transferred to the execute sandbox and then invoked as a multi-file plugin.\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">plug.sub </pre>\n<pre class=\"snip\">executable=simple.bat\ntransfer_executable=true\ntransfer_input_files=payload\\, simple.in, JMK://foo\nTransfer_plugins=JMK:myplug.cmd\narguments = 2\nlog=plug.log\noutput=plug.out\nerror=plug.err\nshould_transfer_files=yes\nwhen_to_transfer_output=ON_EXIT\n\nqueue\n</pre></div>\n\n\n<p>I <strong>think</strong> the patch works when the plugin has an absolute path, but I have not tested that.  Also, I know that the file transfer class is used for spooling input files, but I have not tested that case either.\n\n</p><p>I should have noted in the patch comment, it is for master branch. SHA 3dfdb5dd80988e49ba20feca1a3368fa97dd7e74\n\n</p><p></p><hr/>\n<em>2019-Jan-31 08:48:04 by bbockelm:</em> <br/>\n\nCode comments are here: <a class=\"external\" href=\"https://github.com/htcondor/htcondor/pull/29\">https://github.com/htcondor/htcondor/pull/29</a>\n\n<p>The bigger question is about the format of the map itself in the submit language.  It's unlike how we do <code>transfer_output_remaps</code>; I'd like to see some consistency between the two.\n\n</p><p></p><hr/>\n<em>2019-Jan-31 08:48:46 by bbockelm:</em> <br/>\n\nOh - the other question I had was more general: is there case sensitivity in matching the protocols?  Does the HTTP plugin work with a <a class=\"external\" href=\"http://\">http://</a> URL?\n\n<p></p><hr/>\n<em>2019-Jan-31 08:55:40 by johnkn:</em> <br/>\n\nURL tags are case-insensitive by definition, although the current file transfer code does this wrong, and treats them as case-sensitive. The matchmaking expression that condor_submit emits in the current code correctly does case-insensitive matchmaking, so we will match an HTTP://file to a STARTD that reports \"http\" support, which will then fail (sigh).  We should fix that, but my patch does not since that would be a much more extensive change.\n\n<p></p><hr/>\n<em>2019-Jan-31 09:09:52 by johnkn:</em> <br/>\n\nI see no value in making it consistent with <code>transfer_output_rempaps</code>, these are entirely different things.  On the other hand, swapping the URL tag and the filename and switching from : to = as the separator doesn't really matter either way.\n\n<p></p><hr/>\n<em>2019-Jan-31 09:53:27 by bbockelm:</em> <br/>\n\nRight - I'm not saying that <code>transfer_output_remaps</code> is related, but it's syntactically a list of key-value pairs, just like <code>transfer_plugins</code> is here.  We should use the same separators unless there's a strong reason not to.\n\n<p>Can you open a separate ticket for case sensitivity of the protocol schema?\n\n</p><p></p><hr/>\n<em>2019-Jan-31 11:54:58 by johnkn:</em> <br/>\n\nwe should avoid confusing this with transfer_output_remaps unless there is a strong reason treat them as similar.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/1022/job_tranfer_plugins.diff\">job_tranfer_plugins.diff</a>\n12624 bytes added by johnkn on 2019-Jan-30 18:25:22 UTC.\n<br/>\nThis patch adds basic support for a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TransferPlugins\" title=\"Transfer Plugins\">TransferPlugins</a></span> job attribute into the file transfer class and into submit_utils.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-30 14:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d636b5e5838873f2d484f287995d565bed209b0\">[57013]</a></span>: fix truncated doc change for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6855\" onclick=\"get_ticket_and_populate_wrapper('6855'); return false;\" title=\"transfer file transfer plugin along with the job\">#6855</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-30 14:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7afe3f8a0dbc7b00574fb205e3c8b3a1cab57b94\">[57012]</a></span>: doc and version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6855\" onclick=\"get_ticket_and_populate_wrapper('6855'); return false;\" title=\"transfer file transfer plugin along with the job\">#6855</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-22 11:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e438bd62674d0b808be3c5b9813f67b89252ba7a\">[56689]</a></span>: For <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6855\" onclick=\"get_ticket_and_populate_wrapper('6855'); return false;\" title=\"transfer file transfer plugin along with the job\">#6855</a></span>, per Brian's request, change key,value separator of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TransferPlugins\" title=\"Transfer Plugins\">TransferPlugins</a></span> from : to = ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-22 10:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b692fbd05857f5036c47a8d1909052264c53fd8\">[56686]</a></span>: For <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6855\" onclick=\"get_ticket_and_populate_wrapper('6855'); return false;\" title=\"transfer file transfer plugin along with the job\">#6855</a></span>, allow file tranfer plugins to be supplied by the job. this commit adds a new job attribute <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=TransferPlugins\" title=\"Transfer Plugins\">TransferPlugins</a></span> and a new submit keyword transfer_plugins and the code necessary to make these work when transfer files is set to YES. ===VersionHistory:None===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2019-May-31 10:56", "status": "resolved", "created": "2019-Jan-14 15:39", "fixed_version": "2019-Jan-14 15:39", "broken_version": "", "priority": "3", "subsystem": "FileTransfer", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}