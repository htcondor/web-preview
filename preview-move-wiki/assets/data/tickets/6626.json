{"id": 6626, "title": "Ticket #6626: Final job ad updates missing from history file", "description": "<blockquote>\nWhen a job completes, there is a race condition that can cause the final changes to the job ad performed by the schedd to be missing from the copy of the ad written to the history file. The most noticeable missing change is updating <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span> to include the time from the execution interval just concluded. For many jobs, this can result in a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span> value of 0.\n\n<p>The cause is a race condition when attempting to recycle a shadow when there's no new job available. The schedd sets the job's status to COMPLETED and tells the shadow to exit. The final updates to the job ad (done in delete_shadow_rec()) are deferred until the reaper for the shadow process is called. If the periodic job policy evaluation occurs in between these events, it will call DestroyProc(), triggering the retirement of the job from the queue and into the history file.\n\n</p><p>This probably also affects jobs that the shadow puts on hold.\n\n</p><p>This problem was first reported by the CMS group. It has happened a couple times a day recently in CHTC.\n\n</p><p>A simple fix is to change ResponsibleForPeriodicExprs() to look for a shadow_rec for HELD and COMPLETED jobs and skip policy evaluation if there is one. It already does this for REMOVED jobs.\n\n</p><p>A more robust fix would be to always do the ad modifications of delete_shadow_rec() in RecycleShadow(). This would require more changes to allow a shadow_rec to not have a job associated with it, or an alternate data structure for shadows that don't have a job. These changes are probably not suitable for the stable series.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-27 15:46:04 by jfrey:</em> <br/>\n\nWhen a job is retired from the queue prematurely, this error will appear in the schedd log once the shadow is reaped:\n\n<p></p><div class=\"verbatim\">\n<pre>ERROR fetching job (1096.0) status in check_zombie !\n</pre></div>\n\n\n<p></p><hr/>\n<em>2018-Mar-27 15:50:54 by jfrey:</em> <br/>\n\nA workaround for bad <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span> values is to use <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CommittedTime\" title=\"Committed Time\">CommittedTime</a></span>. This attribute also measures total wallclock time but is updated by the shadow and sent to the schedd before the shadow reports that it's done with the job.\n\n<p></p><hr/>\n<em>2018-May-10 10:10:57 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2021-Feb-10 13:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8f591bd0fb65f5964d6f59b4dac8c6c5f5040910\">[62164]</a></span>: Check return code from sscanf <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6626\" onclick=\"get_ticket_and_populate_wrapper('6626'); return false;\" title=\"Final job ad updates missing from history file\">#6626</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-27 16:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6cab3a898890dac4675f42698937c0729e38bdba\">[54586]</a></span>: Docs for bad <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RemoteWallClockTime\" title=\"Remote Wall Clock Time\">RemoteWallClockTime</a></span> value bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6626\" onclick=\"get_ticket_and_populate_wrapper('6626'); return false;\" title=\"Final job ad updates missing from history file\">#6626</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-27 15:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e45811d3134b970b039b99dc39a99238df987df9\">[54585]</a></span>: Job can leave queue without final ad updates by schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6626\" onclick=\"get_ticket_and_populate_wrapper('6626'); return false;\" title=\"Final job ad updates missing from history file\">#6626</a></span> Don't do periodic job policy evaluation for HELD or COMPLETED jobs if they have a shadow_rec. If a shadow asks to be recycled but there's no new job for it, the old job's status can be changed to HELD or COMPLETED but other updates to the\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-May-10 10:11", "status": "resolved", "created": "2018-Mar-27 15:21", "fixed_version": "2018-Mar-27 15:21", "broken_version": "v080600", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "gthain", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "", "due_date": ""}