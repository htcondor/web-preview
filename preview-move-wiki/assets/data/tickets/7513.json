{"id": 7513, "title": "Ticket #7513: Customized job classads appended to Requirements depending on name", "description": "<blockquote>\nWith 8.9.5 and using the python bindings, customized classads  that start with the word 'Request' and evaluate to numbers are automatically added to the Requirements expression, expecting to find a counterpart in the machine classads. This does not happen with e.g.: 8.8.1 or 8.9.2 for example.\n\n<p>E.g.: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestJobNumber\" title=\"Request Job Number\">RequestJobNumber</a></span> will expect to find 'JobNumber' in the machine classads and\n\n</p><p>(TARGET.JobNumber &gt;= <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestJobNumber\" title=\"Request Job Number\">RequestJobNumber</a></span>)\n\n</p><p>will be automatically added to the job Requirements, preventing the job from matching if <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=JobNumber\" title=\"Job Number\">JobNumber</a></span> is not present in the machine classads.\n\n</p><p>Expected behavior: +RequestJobNumber should be added to the job classads, but not expect anything on the machine classads side.\n\n</p><p>How to reproduce:\n\n</p><p># Results with condor 8.9.5\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_version\n$CondorVersion: 8.9.5 Dec 30 2019 BuildID: 493601 PackageID: 8.9.5-1 $\n$CondorPlatform: x86_64_RedHat7 $\n\n$ cat submit.py\nimport classad\nimport htcondor\n\nschedd = htcondor.Schedd()\nsub = htcondor.Submit(\"\"\"\n\tuniverse = vanilla\n\texecutable = test.sh\n\targuments = 3\n        Output = out.$(Cluster)-$(Process)\n        Log = log.$(Cluster)\n\t\"\"\")\n\nsub['My.JobName'] = classad.quote(\"jobtest1\")\nsub['My.AnotherJobNumber'] = '4'\nsub['My.RequestJobNumber'] = '4'\n\nwith schedd.transaction() as txn:\n    submitRes = sub.queue(txn)\n    print(\"ClusterId: {}\".format(submitRes))\n\n$ python submit.py\nClusterId: 2654\n\n$ condor_q 2654 -l | grep Requirements\nRequirements = (TARGET.Arch == \"X86_64\") &amp;&amp; (TARGET.OpSys == \"LINUX\") &amp;&amp; (TARGET.Disk &gt;= RequestDisk) &amp;&amp; (TARGET.Memory &gt;= RequestMemory) &amp;&amp; (TARGET.JobNumber &gt;= RequestJobNumber) &amp;&amp; ((TARGET.FileSystemDomain == MY.FileSystemDomain) || (TARGET.HasFileTransfer))\n</pre></div>\n\n\n<p>## Results with 8.8.1\n</p><div class=\"code\">\n<pre class=\"code\">$ condor_version\n$CondorVersion: 8.8.1 Feb 18 2019 BuildID: 461773 PackageID: 8.8.1-1 $\n$CondorPlatform: x86_64_RedHat7 $\n\n$ cat submit.py\nimport classad\nimport htcondor\n\nschedd = htcondor.Schedd()\nsub = htcondor.Submit(\"\"\"\n\tuniverse = vanilla\n\texecutable = test.sh\n\targuments = 3\n        Output = out.$(Cluster)-$(Process)\n        Log = log.$(Cluster)\n\t\"\"\")\n\nsub['My.JobName'] = classad.quote(\"jobtest1\")\nsub['My.AnotherJobNumber'] = '4'\nsub['My.RequestJobNumber'] = '4'\n\nwith schedd.transaction() as txn:\n    submitRes = sub.queue(txn)\n    print(\"ClusterId: {}\".format(submitRes))\n$ python submit.py\nClusterId: 774\n$ condor_q 774 -l | grep Requirements\nRequirements = (TARGET.Arch == \"X86_64\") &amp;&amp; (TARGET.OpSys == \"LINUX\") &amp;&amp; (TARGET.Disk &gt;= RequestDisk) &amp;&amp; (TARGET.Memory &gt;= RequestMemory) &amp;&amp; ((TARGET.FileSystemDomain == MY.FileSystemDomain) || (TARGET.HasFileTransfer))\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Feb-20 11:15:42 by khurtado:</em> <br/>\n\nAlso, something I noticed from other test jobs at CERN that also use the \"request_disk\" option is that depending on the schedd configuration (e.g.: SCHEDD_ROUND_ATTR_Disk set), then  not only (TARGET.Disk &gt;= <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestDisk\" title=\"Request Disk\">RequestDisk</a></span>) is added to Requirements but also \"(TARGET.Disk_RAW &gt;= RequestDisk_RAW)\" which doesn't match.\n\n<p>E.g.:\n</p><div class=\"code\">\n<pre class=\"code\">Requirements = (((REQUIRED_OS =?= \"any\") || (GLIDEIN_REQUIRED_OS =?= \"any\") || stringListMember(GLIDEIN_REQUIRED_OS,REQUIRED_OS)) &amp;&amp; (AuthenticatedIdentity =!= \"volunteer-node@cern.ch\")) &amp;&amp; (TARGET.Arch == \"X86_64\") &amp;&amp; (TARGET.OpSys == \"LINUX\") &amp;&amp; (TARGET.Disk &gt;= RequestDisk) &amp;&amp; (TARGET.Memory &gt;= RequestMemory) &amp;&amp; (TARGET.Cpus &gt;= RequestCpus) &amp;&amp; (TARGET.Disk_RAW &gt;= RequestDisk_RAW) &amp;&amp; (TARGET.ResizedCpus &gt;= RequestResizedCpus) &amp;&amp; (TARGET.HasFileTransfer)\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Mar-02 09:12:08 by khurtado:</em> <br/>\n\nOkay, the bug in my comment (when schedd round attributes for Disk and Memory are enabled) only happens with:\n\n<p>Schedd: HTCondor 8.9.2+\nPython bindings: HTCondor 8.8.3\n\n</p><p>It does not happen if I use python bindings 8.9.2+. Is this something that could be fixed with a change just at the schedd level without changing the python bindings version?\n\n</p><p></p><hr/>\n<em>2020-Apr-20 09:18:05 by khurtado:</em> <br/>\n\nHello,\n\n<p>Any news on this?\nThis is still an issue with 8.9.6. There is a few classads in the infrastucture that depend on creating attributes like: \"Requestioslots\", \"<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RequestRepackslots\" title=\"Request Repackslots\">RequestRepackslots</a></span>\", which are not so trivial to change, as it requires changes on other components in CMS.\n\n</p><p></p><hr/>\n<em>2020-Apr-20 09:50:59 by johnkn:</em> <br/>\n\nThis behavior is by design and not a bug, so we will need to think about ways of having the submitter explicitly declare that they want to use all, (or perhaps certain?) Request* attributes in a non-standard way.\n\n<p>The workaround for 8.9.6 and 8.9.7 is to refer to ioslots and repackslots in your Requirements expression in submit,  this will prevent a comparison to TARGET.ioslots and TARGET.repackslots from being added to requirements.\n\n</p><p>We will add a new knob that defaults to true <code>SUBMIT_GENERATE_CUSTOM_RESOURCE_REQUIREMENTS</code>.  setting this to false will disable requirements generation in submit for job attributes starting with <strong>Request</strong> that are not in the list of well-known resources</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-25 13:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6699361502a05ab0497b2b04d47a6b19191111fb\">[59485]</a></span>: add SUBMIT_GENERATE_CUSTOM_RESOURCE_REQUIREMENTS to disable submit requirements generation for job attriburtes that start with Request <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7513\" onclick=\"get_ticket_and_populate_wrapper('7513'); return false;\" title=\"Customized job classads appended to Requirements depending on name\">#7513</a></span>  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-Oct-20 15:17", "status": "resolved", "created": "2020-Feb-19 16:01", "fixed_version": "2020-Feb-19 16:01", "broken_version": "v080905", "priority": "4", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "khurtado", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}