{"id": 4973, "title": "Ticket #4973: Make consumption policies and matchlist caching work together", "description": "<blockquote>\nConsumption policies and matchlist caching don't work well together in the negotiator. When a partitionable slot ad with a consumption policy is matched to a job, it is removed (or is not added) to the matchlist cache. Thus, the pslot ad is only matched to a single job of a schedd's resource request, instead of to multiple jobs.</blockquote>", "remarks": "<blockquote>\n<em>2015-Apr-29 15:22:53 by bbockelm:</em> <br/>\n\nPer phone call -\n\n<p></p><ul>\n<li>This is likely a regression - can be backported to stable.\n</li><li>Given timelines, most likely target is 8.5.0.\n</li></ul>\n\n<p>Brian\n\n</p><p></p><hr/>\n<em>2015-May-28 17:11:05 by tannenba:</em> <br/>\n\nBrian, I don't think <span class=\"chng\"><a href=\"chngview?cn=44903\">[44903]</a></span> does quite the right thing.  Recall that the <code>MatchList</code> is sorted according to all the various negotiator and job rank expressions.  When you put the modified pslot back into the <code>MatchList</code>, it should be inserted into the proper place (ie insertion sort).  The way things stand now, if any rank expressions refer to attributes that are modified when a pslot is split, things will break. For instance, think about a policy where rank expressions refer to the Cpus attribute of the pslot (eg a best-fit type policy like jobad Rank=RequestedCpus-Cpus).\n\n<p></p><hr/>\n<em>2015-May-28 19:31:08 by bbockelm:</em> <br/>\n\nAh, good catch!\n\n<p>I was worried about the approach but couldn't construct a clear counter-example.\n\n</p><p>I wanted to avoid re-sorting the match list, but that appears unavoidable.  If I add a sort in, can you see other potential problems?\n\n</p><p></p><hr/>\n<em>2015-May-29 08:58:55 by bbockelm:</em> <br/>\n\nPushed a fix to re-sort the match list.\n\n<p>This patch was tested by setting up a personal HTCondor instance with 4 partitionable slots, each containing 4 cores, and <code>NEGOTIATOR_PRE_JOB_RANK=Cpus</code> (breadth-first-filling).  A cluster of 8 jobs was submitted; with this patch, each p-slot received two matches (instead of 2 p-slots receiving 4 matches).\n\n</p><p>I additionally used the same setup with <code>NEGOTIATOR_PRE_JOB_RANK=-Cpus</code> to validate that depth-first-filling also works.\n\n</p><p></p><hr/>\n<em>2015-Jun-12 10:50:59 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>Consumption policies, matchlist caching, and pslot preemption can't all be used together. Each pslot will only have one preempting claim handed out per cached match list. This can be considered future work.\n\n<p></p></li><li>Your sorting code in insert_candidate() is overly complex. You only need one loop to move entries up in the list until the space for the new entry is in the right spot.\n\n<p></p></li><li>Using size_t in insert_candidate() is only adding extra casts.</li></ul>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-29 12:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45172\">[45172]</a></span>: edit 8.3.7 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4973\" onclick=\"get_ticket_and_populate_wrapper('4973'); return false;\" title=\"Make consumption policies and matchlist caching work together\">#4973</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-16 11:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45063\">[45063]</a></span>: Docs for consumption policy working with match list cache. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4973\" onclick=\"get_ticket_and_populate_wrapper('4973'); return false;\" title=\"Make consumption policies and matchlist caching work together\">#4973</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-15 12:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=45048\">[45048]</a></span>: More <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span> caching with pslots and consumption policy changes. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4973\" onclick=\"get_ticket_and_populate_wrapper('4973'); return false;\" title=\"Make consumption policies and matchlist caching work together\">#4973</a></span> Simplify code to re-insert pslot into <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span>.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-29 08:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44914\">[44914]</a></span>: Re-sort match list after re-adding p-slot. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4973\" onclick=\"get_ticket_and_populate_wrapper('4973'); return false;\" title=\"Make consumption policies and matchlist caching work together\">#4973</a></span> When using consumption policies, we re-add the smaller p-slot back into the match list. With this commit, we re-sort the match list (using insertion sort).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-28 11:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=44903\">[44903]</a></span>: Add modified slot back to match list when using CP. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4973\" onclick=\"get_ticket_and_populate_wrapper('4973'); return false;\" title=\"Make consumption policies and matchlist caching work together\">#4973</a></span> Previously, when a slot was sent to a schedd, it was removed from the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MatchList\" title=\"Match List\">MatchList</a></span> -- this means a p-slot will be ignored until the match list is recomputed (typically, when a new auto-cluster is considered).\u00a0[...]\n (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Jun-16 11:37", "status": "resolved", "created": "2015-Apr-01 16:07", "fixed_version": "2015-Apr-01 16:07", "broken_version": "", "priority": "3", "subsystem": "DaemonsCM", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "jfrey", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu", "due_date": ""}