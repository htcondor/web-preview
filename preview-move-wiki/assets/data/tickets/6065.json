{"id": 6065, "title": "Ticket #6065: Last DAG status in dagman.out incorrect when final node overrides", "description": "<blockquote>\nWhen a final node overrides the existing DAG status (e.g., an earlier node fails but the final node succeeds) the last DAG status output in the dagman.out file is not correct.  (Note that it looks like the node status file, if there is one, gets the correct status.)\n\n<p>Okay, looks like this only happens when changing failure to success (see job_dagman_abort-final-A and job_dagman_abort-final-B, or job_dagman_final-C and job_dagman_final-D.run).</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Dec-21 14:20:47 by wenger:</em> <br/>\n\nCreated V8_4-gittrac_6065-branch for this.\n\n<p>Also see <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=5373\" onclick=\"get_ticket_and_populate_wrapper('5373'); return false;\" title='Clean up DAGMan \"node ending\" code'>#5373</a></span>: Clean up DAGMan \"node ending\" code.\n\n</p><p></p><hr/>\n<em>2016-Dec-30 17:15:09 by wenger:</em> <br/>\n\nI found some more cases where there are problems with final nodes; I'm going to include them in this ticket.  The problems I've found so far are as follows:\n<ul>\n<li>DAG status file is incorrect when final node has PRE_SKIP, which triggers and overrides previous node failure.  (See job_dagman_final-J test)\n</li><li>DAG status file is incorrect when all submit attempts fail for final node, and the DAG succeeded up until that point.  (See job_dagman_final-K test)\n</li><li>If final node succeeds, overriding previous node failures, the DAG status file is incorrect.  (See job_dagman_final-L.run test)\n</li><li>DAGMan sometimes hangs when final node has multiple job procs, one of which fails, while the others succeed.  (It seems to fail if one of the successful procs finishes just after the unsuccessful one.)  (See job_dagman_final-M test)\n</li></ul>\n\n<p></p><hr/>\n<em>2017-Jan-03 14:02:16 by wenger:</em> <br/>\n\nHmm -- looks like the \"multiple procs with one failing\" problem only applies to final nodes.\n\n<p></p><hr/>\n<em>2017-Jan-03 15:12:55 by wenger:</em> <br/>\n\nHmm -- this is getting more complicated.  I'm kind of wondering whether I should finish up <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=5373\" onclick=\"get_ticket_and_populate_wrapper('5373'); return false;\" title='Clean up DAGMan \"node ending\" code'>#5373</a></span>: Clean up DAGMan \"node ending\" code, and then continue with this...\n\n<p></p><hr/>\n<em>2017-Jan-04 09:30:21 by wenger:</em> <br/>\n\nHmm, interesting -- changes for <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=5373\" onclick=\"get_ticket_and_populate_wrapper('5373'); return false;\" title='Clean up DAGMan \"node ending\" code'>#5373</a></span>: Clean up DAGMan \"node ending\" code (on V8_5-gittrac_5370-branch) seem to fix the \"multiple procs, one fails\" problem...</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"stalled\" href=\"/tickets?ticket=6066\" onclick=\"get_ticket_and_populate_wrapper('6066'); return false;\" title=\"Make additional final node tests\">#6066</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMake additional final node tests</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-04 11:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49914\">[49914]</a></span>: Gittrac <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=6065\" onclick=\"get_ticket_and_populate_wrapper('6065'); return false;\" title=\"Last DAG status in dagman.out incorrect when final node overrides\">#6065</a></span>: Working on these bugs on V8_5-gittrac_5370-branch now -- existing changes on the branch fixed the final-M test; implemented a tentative fix for final-J and final-L (same as on V8_4-gittrac_6065-branch); final-K still fails (also fixed a problem in the test script itself for final-K).  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-03 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49903\">[49903]</a></span>: Gittrac <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=6065\" onclick=\"get_ticket_and_populate_wrapper('6065'); return false;\" title=\"Last DAG status in dagman.out incorrect when final node overrides\">#6065</a></span>: Committing some extra test output; I may try to finish up <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=5373\" onclick=\"get_ticket_and_populate_wrapper('5373'); return false;\" title='Clean up DAGMan \"node ending\" code'>#5373</a></span>: Clean up DAGMan \"node ending\" code before continuing with this...  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-22 09:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=49865\">[49865]</a></span>: Gittrac <span class=\"ticket\"><a class=\"active\" href=\"/tickets?ticket=6065\" onclick=\"get_ticket_and_populate_wrapper('6065'); return false;\" title=\"Last DAG status in dagman.out incorrect when final node overrides\">#6065</a></span>: Added code that tentatively fixes this (but I need to think about whether it's really the right solution).  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2017-Jan-04 09:30", "status": "active", "created": "2016-Dec-21 12:07", "fixed_version": "2016-Dec-21 12:07", "broken_version": "v080410", "priority": "2", "subsystem": "Dag", "assigned_to": "", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "other", "visibility": "public", "notify": "wenger@cs.wisc.edu", "due_date": ""}