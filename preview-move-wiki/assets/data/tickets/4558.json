{"id": 4558, "title": "Ticket #4558: Write out .job.ad for scheduler universe", "description": "<blockquote>\n.job.ad is written for the local universe but not the scheduler universe.\n\n<p>This has resulted in somewhat of a nasty problem in CMS.  For various reasons, we must use the scheduler universe - but our original application design used local universe.  Hence, we currently do a \"condor_q -l $JOB_ID\" to get the local job ad (which is a pretty unreliable operation on a busy schedd - we have many cases where 10 retries is not enough).  This has caused much user unhappiness.\n\n</p><p>We should just have the schedd drop the ad.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Aug-27 13:02:43 by bbockelm:</em> <br/>\n\nPushed an initial implementation to V8_3-gt4558.\n\n<p>I create a temporary directory in $EXECUTE to hold this job ad (similar to the code used by the starter).  Note I don't actually make a full _CONDOR_SCRATCH_DIR here - in fact, it's owned by the condor priv.\n\n</p><p>Should be mostly straightforward to code-review.\n\n</p><p></p><hr/>\n<em>2014-Sep-03 14:49:52 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW THOUGHTS</strong>\n\n<p>Not a code review, but some quick thoughts for whomever performs the code review to keep in mind:\n\n</p><p></p><ul>\n<li>The <code>EXECUTE</code> directory may not be specified in the config file on the submit machine (the schedd never used it before). Similarly, the EXECUTE directory may not exist, even if it is specified.\n</li><li>What cleans up the .job.ad files if the schedd fails to do so due to crash or whatnot?  Are these files cleaned up upon a restart of the schedd?  Does preen do the right thing with these files (i.e. not delete them prematurely)?\n</li><li>Security - check for proper (non root) priv state, proper permissions on created files, are safe open calls used, etc --- we don't want to clobber some random file (or a random file that a malicious user points to via a symlink) with a .job.ad file.\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Sep-26 16:00:09 by tannenba:</em> <br/>\n\nAn alternative idea to writing out the .job.ad - could the submit file pass attribute values of interest to the job via the environment?  So if the scheduler universe job needs the values of foo and bar from the job ad, would something like this work?\n<div class=\"code\">\n<pre class=\"code\">universe = scheduler\nenvironment = \"foo=$$([foo]) bar=$$([bar])\"\nexcutable = x.exe\nqueue\n</pre></div>\n\n\n<p>Of course, this means that you'd have to know every attribute the job wants to inspect at submit time.  But maybe for this specific CMS job, that is already well known.\n\n</p><p></p><hr/>\n<em>2014-Sep-26 16:00:41 by tannenba:</em> <br/>\n\nAssigning code review to Jaime, but Brian, if you could answer above question in parallel that'd be great.\n\n<p></p><hr/>\n<em>2014-Sep-26 16:25:01 by bbockelm:</em> <br/>\n\nHi Todd,\n\n<p>The reason why we can't put this in the environment is we depend on some items not known at submit time.  This is how we pass information from the user to the dagman instance <strong>after</strong> submit.  Basically, we condor_qedit some attributes and then hold/release the dagman job.\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2014-Sep-26 16:31:08 by bbockelm:</em> <br/>\n\nScratch that last comment - just re-read Todd's and I obviously didn't understand it at first.\n\n<p>Something along those lines might work.  The attributes we need from the job ad are numerous but indeed known ahead of time.  I'd still prefer the .job.ad route because we have much better mechanisms to handle the quoting rules -- I don't have any mechanisms to make sure $(([])) is expanded to something that matches the rules for environment strings!\n\n</p><p></p><hr/>\n<em>2014-Sep-29 16:39:22 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>General:\n</p><ul>\n<li>Use Scheduler::LocalUnivExecuteDir instead of EXECUTE.\n</li></ul>\n\n<p>Scheduler::start_sched_universe_job():\n</p><ul>\n<li>Don't use working_dir for name of job's execute directory. Use\n  something like job_execute_dir.\n</li><li>Don't call fPrintAd() when we know the file pointer is NULL.\n</li><li>Use DIR_DELIM_CHAR everywhere.\n</li><li>Why do we chdir() into the directory?\n</li><li>Make \".job.ad\" a constant variable or macro.\n</li></ul>\n\n<p>Scheduler::scheduler_univ_job_exit():\n</p><ul>\n<li>Directory removal must come before all return points in the function.\n</li><li>Since we created the directory as PRIV_CONDOR, shouldn't we remove it\n  with the same access level, not PRIV_ROOT?\n</li><li>I don't see any sign that Directory uses chdir(), so we shouldn't need\n  to chdir() out of the directory.\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Oct-07 15:48:50 by tannenba:</em> <br/>\n\nAssigned back to original developer now that code review (above) is completed.  Brian, do you agree with the code review items above?  If so, can you please address them?  If you don't have time to deal with the results of the review, let me know and we'll pick a victim at UW to deal with it.\n\n<p></p><hr/>\n<em>2014-Oct-07 16:00:07 by bbockelm:</em> <br/>\n\nHi Todd,\n\n<p>No objections to the review suggestions.  However, with HEPiX next week, my time is shot.  If we want to cut the next 8.3.X branch before October 20, we'll need to pick a UW victim.\n\n</p><p>Brian\n\n</p><p><em>NOTE: UW victim picked, Zach will implement the review suggestions and push into master in the next couple days -ToddT</em>\n\n</p><p></p><hr/>\n<em>2014-Oct-10 17:14:30 by zmiller:</em> <br/>\n\n<strong>CODE COMMITTED</strong> I pushed changes to address the issues in Jaime's review.  Assigning back to Jaime for re-review.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Nov-19 12:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41687\">[41687]</a></span>: minor 8.3.2 version history item edit <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4558\" onclick=\"get_ticket_and_populate_wrapper('4558'); return false;\" title=\"Write out .job.ad for scheduler universe\">#4558</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-30 10:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41526\">[41526]</a></span>: Docs for _CONDOR_JOB_AD for scheduler universe jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4558\" onclick=\"get_ticket_and_populate_wrapper('4558'); return false;\" title=\"Write out .job.ad for scheduler universe\">#4558</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-29 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41516\">[41516]</a></span>: Name of .job.ad file for scheduler jobs shouldn't be a config param. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4558\" onclick=\"get_ticket_and_populate_wrapper('4558'); return false;\" title=\"Write out .job.ad for scheduler universe\">#4558</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Oct-10 17:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41386\">[41386]</a></span>: Address issues in code review. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4558\" onclick=\"get_ticket_and_populate_wrapper('4558'); return false;\" title=\"Write out .job.ad for scheduler universe\">#4558</a></span>  (By Zach Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-27 12:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=41055\">[41055]</a></span>: Write out an appropriate $_CONDOR_JOB_AD for the scheduler universe. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4558\" onclick=\"get_ticket_and_populate_wrapper('4558'); return false;\" title=\"Write out .job.ad for scheduler universe\">#4558</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Oct-30 10:00", "status": "resolved", "created": "2014-Aug-26 15:28", "fixed_version": "2014-Aug-26 15:28", "broken_version": "", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu tannenba@cs.wisc.edu jfrey@cs.wisc.edu zmiller@cs.wisc.edu", "due_date": "20141010"}