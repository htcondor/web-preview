{"id": 4575, "title": "Ticket #4575: Daemons with a debug lock file should leave log open", "description": "<blockquote>\nWhen multiple daemons are writing to the same debug log file, we use a lock file during log rotation to avoid race conditions. To ensure that all daemons use the newly-rotated file, each daemon closes the file after every write and reopens it before the next write. This is needlessly inefficient.\n\n<p>Instead, the daemons can leave the log file open, and use the following procedure to ensure rotation happens when necessary and daemons always write to the newest log file:\n</p><ul>\n<li>Use lseek() to find the current file size.\n</li><li>If it's not time to rotate, then write line as usual and skip remaining steps.\n</li><li>Acquire lock.\n</li><li>Fstat() the open file descriptor and stat() the log file using its filename.\n</li><li>Close the file descriptor for the log file.\n</li><li>If the two stat structs identify the same file, then perform rotation.\n</li><li>Open log file.\n</li><li>Release lock.\n</li><li>Now we're ready to write the requested line.\n</li></ul>\n\n<p>On windows (and if LOCK_DEBUG_LOG_TO_APPEND=True on unix), the lock is held the entire time the log file is open. We would need to change that.</p></blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "enhance", "last_change": "2014-Sep-05 16:24", "status": "new", "created": "2014-Sep-05 14:30", "fixed_version": "2014-Sep-05 14:30", "broken_version": "v080000", "priority": "4", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "#2064", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}