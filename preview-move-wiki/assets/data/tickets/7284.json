{"id": 7284, "title": "Ticket #7284: Job route order doesn't reflect configuration", "description": "<blockquote>\nOur friends at CIEMAT/PIC reported on htcondor-users that the job route ordering does not reflect what they've added to the configuration, which causes confusion with how jobs are routed. For example, the following configuration (note the lack of requirements):\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">8.8 configuration fragment</pre>\n<pre class=\"snip\">JOB_ROUTER_ENTRIES @=jre\n[\n  TargetUniverse = 5;\n  name = \"Local_Condor\";\n]\n[\n  TargetUniverse = 5;\n  name = \"Local_Condor2\";\n]\n[\n  TargetUniverse = 5;\n  name = \"Local_Condor3\";\n]\n@jre\n</pre></div>\n\n\n<p>Results in the following ordering that is reflected in the job router log:\n\n</p><p></p><div class=\"term\">\n<pre class=\"term\">Route Name             Submitted/Max        Idle/Max     Throttle Recent: Started Succeeded Failed\nLocal_Condor2                  0/  10000       0/   2000     none               0         0      0\nLocal_Condor                   0/  10000       0/   2000     none               0         0      0\nLocal_Condor3                  0/  10000       0/   2000     none               0         0      0\n</pre></div>\n\n\n<p>And so any submitted jobs actually only match to the <code>Local_Condor2</code> route when we would expect them to route to <code>Local_Condor</code> from our configuration.\n\n</p><p>Unfortunately, the actual situation is more complicated. There is not a single declaration order that we can use.  The job router reads 3 knobs: <code>JOB_ROUTER_ENTRIES</code>, <code>JOB_ROUTER_ENTRIES_FILE</code>, and <code>JOB_ROUTER_ENTRIES_CMD</code> and uses the set of all routes declared there after eliminating duplicates (by name, case sensitively).  The case-sensitive comparison of names is a bug, it should be case insensitive.  Routes are stored in a hashtable, and then applied in hashtable order, which is the source of the problem.\n\n</p><p>If we fix the case-sensitivity bug, that will change the hashtable order; which will potentially break configurations that <strong>happen</strong> to work now because hashtable order is working for them.\n\n</p><p>So we plan to fix this problem by adding a knob <code>JOB_ROUTE_NAMES</code>. This will default to empty.  If it is empty, then routes will be compared in hashtable order using the current case-sensitive hash.  If it is not empty, then only routes listed in this knob will be used, and they will be compared in the order specified in the knob.  Names specified in this knob will be treated as case-*IN*sensitive.\n\n</p><p>in 8.8 We will also change the job router to compare case-*IN*sensitively when eliminating routes with the same name, since this is necessary to make the new knob work correctly.\n\n</p><p>In the 8.9 series, we will add a Schedd style method of declaring routes, where each route will be specified by a knob whose name ends with the route name, something like this\n</p><div class=\"snip\">\n<pre class=\"sniplabel\">8.9 job router configuration fragment</pre>\n<pre class=\"snip\">JOB_ROUTER_ROUTE_NAMES = Local_Condor2, Local_Condor\nJOB_ROUTER_ROUTE_Local_Condor @=end\n[\n  TargetUniverse = 5;\n  name = \"Local_Condor\";\n]\n@end\nJOB_ROUTER_ROUTE_Local_Condor2 @=end\n[\n  TargetUniverse = 5;\n  name = \"Local_Condor2\";\n]\n@end\n</pre></div>\n\n\n<p>Additionally, in 8.9 we will also support the native transform syntax as an alternative to job router syntax for specifying routes. so this will also work\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">8.9 job router configuration fragment</pre>\n<pre class=\"snip\">JOB_ROUTER_ROUTE_NAMES = Local_Condor Local_Condor2\nJOB_ROUTER_ROUTE_Local_Condor @=end\n  NAME Local_Condor\n  Universe Vanilla\n  SET Requirements ($(MY.Requirements)) &amp;&amp; NeedMorePylons\n@end\nJOB_ROUTER_ROUTE_LocalCondor2 @=end\n  Name Local_Condor2\n  TargetUniverse 5\n  Set routedTo \"Local2\"\n@end\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Nov-08 15:54:44 by blin:</em> <br/>\n\nI tested the EL7 RPMs from this build here: <a class=\"external\" href=\"http://submit-3.batlab.org/results/run-details.php?runid=488423\">http://submit-3.batlab.org/results/run-details.php?runid=488423</a>, and things look good to me.\n\n<p></p><ul>\n<li><code>JOB_ROUTE_NAMES</code> appears to be respected to first order\n</li><li>Without setting <code>JOB_ROUTE_NAMES</code>, the route order appears to be the same hash table order as the previous version\n</li><li><code>condor_job_router_info -config</code> now shows the route order without routes that have been excluded by leaving them out of <code>JOB_ROUTE_NAMES</code>\n</li></ul>\n\n<p></p><hr/>\n<em>2019-Dec-09 16:05:32 by blin:</em> <br/>\n\nInitial doc for job router config redesign: <a class=\"external\" href=\"https://docs.google.com/document/d/1IkEV907Jsc2Wu6HIhhrH9QdFTiGkFzuUn5CTVPRZzNs/edit?usp=sharing\">https://docs.google.com/document/d/1IkEV907Jsc2Wu6HIhhrH9QdFTiGkFzuUn5CTVPRZzNs/edit?usp=sharing</a>\n\n<p></p><hr/>\n<em>2019-Dec-10 13:35:30 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>The code looks good.\n\n</p><p></p><hr/>\n<em>2019-Dec-18 17:08:32 by johnkn:</em> <br/>\n\nversion history done. knob still needs to be added to the manual.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7432\" onclick=\"get_ticket_and_populate_wrapper('7432'); return false;\" title=\"Job router should use a list of job transforms for the route\">#7432</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nJob router should use a list of job transforms for the route</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-19 10:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58711\">[58711]</a></span>: Add JOB_ROUTER_ROUTE_NAMES knob to the admin manual and job router example. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7284\" onclick=\"get_ticket_and_populate_wrapper('7284'); return false;\" title=\"Job route order doesn't reflect configuration\">#7284</a></span>.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-18 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58709\">[58709]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7417\" onclick=\"get_ticket_and_populate_wrapper('7417'); return false;\" title=\"python-bindings use after free for transaction object\">#7417</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7429\" onclick=\"get_ticket_and_populate_wrapper('7429'); return false;\" title=\"dprintf calls in python bindings are not thread safe\">#7429</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7284\" onclick=\"get_ticket_and_populate_wrapper('7284'); return false;\" title=\"Job route order doesn't reflect configuration\">#7284</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-08 13:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58416\">[58416]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7284\" onclick=\"get_ticket_and_populate_wrapper('7284'); return false;\" title=\"Job route order doesn't reflect configuration\">#7284</a></span>, change JOB_ROUTE_NAMES to JOB_ROUTER_ROUTE_NAMES and print the names of disabled routes  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Nov-07 17:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=58404\">[58404]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7284\" onclick=\"get_ticket_and_populate_wrapper('7284'); return false;\" title=\"Job route order doesn't reflect configuration\">#7284</a></span>. Job route order doesn't reflect configuration. This change adds a new knob JOB_ROUTE_NAMES which specifies which routes are active and also sets their order. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Dec-20 14:58", "status": "resolved", "created": "2019-Sep-25 05:22", "fixed_version": "2019-Sep-25 05:22", "broken_version": "v080802", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "johnkn", "derived_from": "#4555", "creator": "blin", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "blin@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}