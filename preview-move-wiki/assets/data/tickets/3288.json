{"id": 3288, "title": "Ticket #3288: RFE: expose general_stats 'recent' ring buffer quantization to configu", "description": "<blockquote>\nThe ring buffer used to maintain <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentXxx\" title=\"Recent Xxx\">RecentXxx</a></span> statistics uses a hard-coded quantization level.  To improve quality of statistics as viewed from tools such as cumin, it will be useful to expose this quantization to configuration and allow it to be given increased time resolution.\n\n<p>My plan is to implement a new config param STATISTICS_WINDOW_QUANTUM, and update stats logic to obtain its quantization level from this variable (when it is present).</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Oct-23 15:53:36 by johnkn:</em> <br/>\n\nthe SCHEDD has 2 collections of statistics, the SCHEDD stats and DC stats, it might be wise to make the quantum individually changable for these two sets.\n\n<p>so maybe 2 config knobs.\n\n</p><p>use <code>SCHEDD_STATISTICS_WINDOW_QUANTUM</code> if it is defined, if not, use <code>STATISTICS_WINDOW_QUANTUM</code>.\n\n</p><p>or\n\n</p><p>use <code>DC_STATISTICS_WINDOW_QUANTUM</code> if it is defined if not, use <code>STATISTICS_WINDOW_QUANTUM</code>.\n\n</p><p>note also that a timer needs to be running at the quantum for DC stats, (the SCHEDD stats are opportunistic and accumulate in <code>CountJobs</code> and when a shadow exits).\n\n</p><p></p><hr/>\n<em>2012-Oct-23 16:00:20 by tstclair:</em> <br/>\n\nSo by default the param system already has the\n\n<p>DAEMON.PARAM override, e.g.\n\n</p><p>SCHEDD.STATISTICS_WINDOW_QUANTUM would already work.\n\n</p><p>I'd have to look about DC though.\n\n</p><p></p><hr/>\n<em>2012-Oct-23 16:17:59 by eje:</em> <br/>\n\nFor dealing with named statistics subsets, we might adopt the acct-group convention.\n\n<p></p><ul>\n<li>STATISTICS_WINDOW_QUANTUM  --  \"default for all subsets, all daemons\"\n</li><li>SCHEDD.STATISTICS_WINDOW_QUANTUM  -- \"default for all subsets, schedd daemon\"\n</li><li>STATISTICS_WINDOW_QUANTUM_&lt;name&gt; -- \"used for subset &lt;name&gt; (any daemon)\"\n</li><li>SCHEDD.STATISTICS_WINDOW_QUANTUM_&lt;name&gt; \"subset &lt;name&gt; on schedd daemon\"\n</li></ul>\n\n<p>So, to alter the 'DC' stats, on the schedd only, you'd do:\n\n</p><p></p><div class=\"verbatim\">\n<pre>SCHEDD.STATISTICS_WINDOW_QUANTUM_DC = 10</pre></div>\n\n\n<p>A side benefit would be it would allow me to just focus on STATISTICS_WINDOW_QUANTUM, without precluding named-subset support under that convention, although adding that as well might not be so much effort.\n\n</p><p></p><hr/>\n<em>2012-Oct-23 17:17:59 by eje:</em> <br/>\n\nOne thing about using &lt;name&gt;_STATISTICS_WINDOW_QUANTUM, is that:\n\n<p></p><div class=\"verbatim\">\n<pre>SCHEDD_STATISTICS_WINDOW_QUANTUM</pre></div>\n\n\n<p>would be equivalent to:\n\n</p><p></p><div class=\"verbatim\">\n<pre>SCHEDD.STATISTICS_WINDOW_QUANTUM</pre></div>\n\n\n<p>under the older (although deprecated) config semantic.  In that regard I think it could cause confusion to users.  (it continues to confuse me).  STATISTICS_WINDOW_QUANTUM_&lt;name&gt; should reduce confusion, since it works like the acct group convention.\n\n</p><p></p><hr/>\n<em>2012-Oct-23 17:32:13 by johnkn:</em> <br/>\n\nNo, you're confusing the names of daemons, and the names of statistics collections. If you use <code>SCHEDD.STATISTICS_WINDOW_QUANTUM</code>, then you are setting the quantum for ALL statistics collections in the SCHEDD.\n\n<p>But the SCHEDD has two collections, the so called \"SCHEDD\" collection, and the \"DC\" collection.  We want to be able to set the quantum for ONE of these collections in the SCHEDD-daemon without changing the quantum for all collections in teh SCHEDD-daemon.\n\n</p><p>Thus <code>SCHEDD_STATISTICS_WINDOW_QUANTUM</code> is not the same as <code>SCHEDD.STATISTICS_WINDOW_QUANTUM</code>. You could call it  <code>SCHEDULER_STATISTICS_WINDOW_QUANTUM</code> and <code>DAEMONCORE_STATISTICS_WINDOW_QUANTUM</code> instead of my original suggestion if that makes it less confusing.\n\n</p><p></p><hr/>\n<em>2012-Oct-23 17:49:31 by eje:</em> <br/>\n\nI understand the distinction, I just think that using this:\n\n<p></p><div class=\"verbatim\">\n<pre>STATISTICS_WINDOW_QUANTUM_SCHEDD</pre></div>\n\n\n<p>makes the distinction more clear, and has the added benefit of being consistent with our already-existing naming convention for acct group variables.\n\n</p><p></p><hr/>\n<em>2012-Oct-24 06:45:51 by matt:</em> <br/>\n\n+1 eje's STATISTICS_WINDOW_QUANTUM approach\n\n<p>And &lt;name&gt; -&gt; &lt;collection&gt;, because it is a new concept and should be differentiated.\n\n</p><p>&lt;collection&gt; should not be allowed to share a value with &lt;subsys&gt;, e.g. both SCHEDD, to avoid confusion.\n\n</p><p>We already have confusion between &lt;subsys&gt; and &lt;daemon&gt;, let's not introduce another undifferentiated concept to the mix.\n\n</p><p>IMHO, having &lt;collection&gt; is premature.\n\n</p><p></p><hr/>\n<em>2012-Oct-24 08:57:12 by tstclair:</em> <br/>\n\nSay it's 10 years from now, how would one iterate the collection space in the off shoot that there are multiple collections within a single daemon.\n\n<p>+1 on suffix.\n\n</p><p></p><hr/>\n<em>2012-Nov-06 17:07:47 by eje:</em> <br/>\n\nProposed implementation on topic branch: V7_9-gt3288-stats-window-quantum\n\n<p>the config var STATISTICS_WINDOW_QUANTUM (which currently defaults to 240) is the global default quantum for all stats collections.\n\n</p><p>There are also: STATISTICS_WINDOW_QUANTUM_SCHEDD (synonym: _SCHEDULER), and STATISTICS_WINDOW_QUANTUM_DC (synonym: _DAEMONCORE) that can override the global default for respective collections.\n\n</p><p>You can test the new feature, with visible 'saw-tooth' every 20 seconds using this configuration:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">STATISTICS_TO_PUBLISH = SCHEDD:2 DC:2\n# one minute window for Recent* stats\nSTATISTICS_WINDOW_SECONDS = 60\n# 20-second ring buffer quantization - recent-stats will sawtooth every 20 secs\nSTATISTICS_WINDOW_QUANTUM = 20\n</pre></div>\n\n\n<p>Kick off a script that submits one job per second (or every couple seconds, as long as it's a regular interval &lt;&lt; 20 seconds).\n\n</p><p>Saw-toothing is visible in tools like cumin, or I also tested using 'watch' on a 'recent' stat from \"SCHEDD\" collection and one from \"DC\" collection:\n</p><div class=\"code\">\n<pre class=\"code\">watch -n 5 'condor_status -l -schedd | grep -e RecentJobsSubmitted -e RecentDCSelectWaittime'\n</pre></div>\n\n\n<p>In the above, both of the statistics drop off every 20 seconds, then begin to grow again.\n\n</p><p>If you change STATISTICS_WINDOW_QUANTUM to '1', and restart the scheduler, then you will see both statistics reach steady-state values, with no major drop-offs or visible saw-toothing.\n\n</p><p></p><hr/>\n<em>2012-Nov-08 15:26:20 by tstclair:</em> <br/>\n\nplease review V7_9-gt3288-stats-window-quantum\n\n<p></p><hr/>\n<em>2012-Nov-12 13:58:06 by johnkn:</em> <br/>\n\nwhy is the type of STATISTICS_WINDOW_QANTUM_DC and others set to string?\n\n<p></p><hr/>\n<em>2012-Nov-12 14:34:54 by eje:</em> <br/>\n\nI set STATISTICS_WINDOW_QUANTUM_[name] to string because the 'int' wouldn't let me leave it with no default value.   The name-specific variations need to have no default so they aren't active when the admin doesn't configure a value.\n\n<p></p><hr/>\n<em>2012-Nov-12 14:45:27 by tstclair:</em> <br/>\n\nThat is a general failing in the param system, which is why lots of the defaults which should be 'int' are 'string'\n\n<p></p><hr/>\n<em>2012-Nov-12 14:50:43 by johnkn:</em> <br/>\n\nreviewed by: TJ, 12-Nov-2012.  approved.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-11 10:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34613\">[34613]</a></span>: fix crash caused by incomplete change of STATISTICS_WINDOW_QUANTUM from constant to config knob. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span> quantum value was never set in the schedd stats pools created by SCHEDD_COLLECT_STATS_BY_*. ===VersionHistory:None=== bug never shipped.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-08 12:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34555\">[34555]</a></span>: revise 7.9.3 version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jan-07 13:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34539\">[34539]</a></span>: Rectify definitions for STATISTICS_WINDOW_SECONDS and STATISTICS_WINDOW_QUANTUM ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-13 10:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34100\">[34100]</a></span>: Fix bug in DaemonCore::Stats init logic: <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-12 17:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34097\">[34097]</a></span>: ===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-12 17:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34096\">[34096]</a></span>: Documentation for STATISTICS_WINDOW_QUANTUM[_&lt;collection&gt;] <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-12 17:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=34095\">[34095]</a></span>: Expose ring buffer quantization to configuration: STATISTICS_WINDOW_QUANTUM[_&lt;collection&gt;] ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3288\" onclick=\"get_ticket_and_populate_wrapper('3288'); return false;\" title=\"RFE: expose general_stats 'recent' ring buffer quantization to configu\">#3288</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-Nov-12 17:44", "status": "resolved", "created": "2012-Oct-23 15:11", "fixed_version": "2012-Oct-23 15:11", "broken_version": "v070800", "priority": "2", "subsystem": "Daemons", "assigned_to": "eje", "derived_from": "#2197", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, tstclair@cs.wisc.edu, johnkn@cs.wisc.edu", "due_date": ""}