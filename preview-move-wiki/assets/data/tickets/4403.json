{"id": 4403, "title": "Ticket #4403: Job rank may not always  work as documented - autoclustering bug", "description": "<blockquote>\nThere is a bug in how HTCondor performs autoclustering of job ads. All jobs that get\nassigned the same <code>AutoClusterID</code> job ad attribute by HTCondor are supposed to\nbe identical for purposes of matchmaking.\nFor background, see the <a class=\"external\" href=\"http://goo.gl/f2Yur3\">autoclustering design document</a>.\n\n<p>In the design document, it states\n</p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \n\"...the schedd augments the significant attributes received from the negotiator by adding the job\u2019s Requirements and Rank attributes, as well as any job ClassAd attribute that is referenced by the job\u2019s own Requirements or Rank expression.\"\n</td></tr></tbody></table></div>\n\n\n<p>Unfortunately, the autoclustering implementation fails to inspect the job's rank expression.\nThis bug has existed <a class=\"external\" href=\"https://htcondor-wiki.cs.wisc.edu/index.cgi/fileview?f=src/condor_schedd.V6/autocluster.C&amp;v=ff0f37ffb10cce1a844cacb6744caf117e99fd95\">since autoclustering was initially implemented</a> back in the summer of\nthe year 2006!\n\n</p><p><span class=\"subsection\"></span></p><h3>Demonstrating the Problem</h3>\n\n<p>Here is how I reproduced the issue - just in a personal v8.1.5 HTCondor on my\nWindows 7 laptop, here is what i added to my condor_config.local :\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">NUM_CPUS = 5\nSTARTD_EXPRS = $(STARTD_EXPRS) MachineDataSet\nSLOT1_MachineDataSet = \"S00\"\nSLOT2_MachineDataSet = \"S01\"\nSLOT3_MachineDataSet = \"S02\"\nSLOT4_MachineDataSet = \"S03\"\nSLOT5_MachineDataSet = \"S04\"\n</pre></div>\n\n\n<p>The above gives my test setup fives slots, were each slots advertises a\nunique <code>MachineDataSet</code> attribute\n\n</p><p>Next I submitted the following with condor_submit:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">executable = c:\\utils\\sleep.exe\ntransfer_executable = false\narguments = 6000\n# For easy monitoring, take the MachineDataSet attribute from\n# the slot we match with and add it into\n# the job classad as attribute MachineAttrMachineDataSet0\njob_machine_attrs = MachineDataSet\n# Prefer slots where MachineDataSet attribute in the slot\n# is equal to the JobDataSet attribute in the job\nrank = JobDataSet =?= MachineDataSet\n# Set JobDataSet to be S00, S01, S02, etc.\n+JobDataSet = \"S0$(Process)\"\nqueue 5\n</pre></div>\n\n\n<p>And behold, jobs did not match up as expected based on the job rank expression:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\test&gt;condor_submit lsst.sub\nSubmitting job(s).....\n5 job(s) submitted to cluster 6971.\n\nC:\\condor\\test&gt;condor_q -af ProcId RemoteHost  JobDataSet MachineAttrMachineDataSet0 AutoClusterId\n0 slot1@ToddsThinkpad S00 S00 44\n1 slot5@ToddsThinkpad S01 S04 44\n2 slot4@ToddsThinkpad S02 S03 44\n3 slot2@ToddsThinkpad S03 S01 44\n4 slot3@ToddsThinkpad S04 S02 44\n</pre></div>\n\n\n<p>A key thing to note in the above is all the jobs ended up with the same autoclusterid...\n\n</p><p><span class=\"subsection\"></span></p><h3>Immediate Workaround</h3>\n\n<p>Add a clause to the job requirements expression that will reference all attributes used\nin the job rank expression; an easy/foolproof way to do this is a clause like\n\n</p><p></p><pre>   requirements = Rank =!= UNDEFINED\n</pre>\n\n<p>And indeed, behold that when I add this requirements expression to the submit\nfile above, jobs matched up on slots as expected:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">C:\\condor\\test&gt;type lsst.sub\nexecutable = c:\\utils\\sleep.exe\ntransfer_executable = false\narguments = 6000\njob_machine_attrs = MachineDataSet\nrank = JobDataSet =?= MachineDataSet\nrequirements = Rank =!= UNDEFINED\n+JobDataSet = \"S0$(Process)\"\nqueue 5\n\nC:\\condor\\test&gt;condor_submit lsst.sub\nSubmitting job(s).....\n5 job(s) submitted to cluster 6972.\n\nC:\\condor\\test&gt;condor_q -af ProcId RemoteHost  JobDataSet MachineAttrMachineDataSet0 AutoClusterId\n0 slot1@ToddsThinkpad S00 S00 52\n1 slot2@ToddsThinkpad S01 S01 53\n2 slot3@ToddsThinkpad S02 S02 54\n3 slot4@ToddsThinkpad S03 S03 55\n4 slot5@ToddsThinkpad S04 S04 56\n</pre></div>\n\n\n<p>Note each job is in a different autoclusterid...</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jun-16 14:55:24 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  One line, approved by gthain</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-17 10:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ee340407a830312f3a8e4d1844aa855f5b240478\">[40688]</a></span>: minor edit to 8.2.2 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4403\" onclick=\"get_ticket_and_populate_wrapper('4403'); return false;\" title=\"Job rank may not always  work as documented - autoclustering bug\">#4403</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-14 14:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/765c9b27d4d1f4221ac4a256dfaecf85c09600bd\">[40641]</a></span>: Include value of job rank expression itself in autoclustering. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4403\" onclick=\"get_ticket_and_populate_wrapper('4403'); return false;\" title=\"Job rank may not always  work as documented - autoclustering bug\">#4403</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-16 14:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5581adcd0c9a7c5d3c2b72b1991ab2c33cfd315a\">[40446]</a></span>: Added version history blurb for gt <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4403\" onclick=\"get_ticket_and_populate_wrapper('4403'); return false;\" title=\"Job rank may not always  work as documented - autoclustering bug\">#4403</a></span>.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-16 14:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c709608801584a1abe7b2b584131d3c21b93e5ee\">[40445]</a></span>: Include attributes referenced by job rank in autoclustering. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4403\" onclick=\"get_ticket_and_populate_wrapper('4403'); return false;\" title=\"Job rank may not always  work as documented - autoclustering bug\">#4403</a></span>  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jul-08 10:38", "status": "resolved", "created": "2014-Jun-13 16:49", "fixed_version": "2014-Jun-13 16:49", "broken_version": "v060802", "priority": "2", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "lsst", "visibility": "public", "notify": "daues@illinois.edu", "due_date": ""}