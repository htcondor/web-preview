{"id": 7417, "title": "Ticket #7417: python-bindings use after free for transaction object", "description": "<blockquote>\na python 3 script that has this construction\n<div class=\"snip\">\n<pre class=\"sniplabel\">fragment of python code</pre>\n<pre class=\"snip\">with htcondor.Schedd().transaction() as txn:\n    sub.queue(txn)\n</pre></div>\n\nWill fail with the error<div class=\"term\">\n<pre class=\"term\">RuntimeError: Job queue attempt without active transaction\n</pre></div>\n\nBecause the <code>Schedd()</code> object will be destroyed as soon as the <code>transaction()</code> object is created, which in turn will disconnect from the schedd before <code>sub.queue()</code> is called.\n\n<p>We can fix this by using boost to force the schedd object to be alive as long as the transaction object is.\n\n</p><p>There are also some places in the implementation of <code>sub.queue()</code> that don't properly take the <code>ModuleLock</code> before using the condor API, this could potentially cause failures if multiple threads try and submit at the same time.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-Dec-18 14:50:28 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This patch <em>also</em> fixes one bug (in two different places) where certain attribute values in the cluster ad would fail to round-trip (between being unparsed and being reinserted).\n\n</p><p>We should, at a low priority, decide if we prefer the THROW_EX() macro or the two-line form of generating Python exceptions and stick with it.  But that's no blocker; the code look good.\n\n</p><p></p><hr/>\n<em>2019-Dec-18 14:51:12 by tlmiller:</em> <br/>\n\nShould note this bug fix in the release notes.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-18 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6d957b87563576ab0d1883a7e3b0fa7bbdb1e626\">[58709]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7417\" onclick=\"get_ticket_and_populate_wrapper('7417'); return false;\" title=\"python-bindings use after free for transaction object\">#7417</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7429\" onclick=\"get_ticket_and_populate_wrapper('7429'); return false;\" title=\"dprintf calls in python bindings are not thread safe\">#7429</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7284\" onclick=\"get_ticket_and_populate_wrapper('7284'); return false;\" title=\"Job route order doesn't reflect configuration\">#7284</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Dec-06 16:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/debcd01da1264d044ad1cef6a5f762f6b321efb6\">[58607]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7417\" onclick=\"get_ticket_and_populate_wrapper('7417'); return false;\" title=\"python-bindings use after free for transaction object\">#7417</a></span>, in python-binding use after free for transaction object. also add some missing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ModuleLocks\" title=\"Module Locks\">ModuleLocks</a></span> in submit  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Dec-18 17:06", "status": "resolved", "created": "2019-Dec-06 16:38", "fixed_version": "2019-Dec-06 16:38", "broken_version": "", "priority": "3", "subsystem": "Tools", "assigned_to": "johnkn", "derived_from": "#7359", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}