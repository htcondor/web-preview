{"id": 7549, "title": "Ticket #7549: Negotiator prefetch breaks flocking", "description": "<blockquote>\nCHTC reports that the number of flocking out jobs has almost completely gone to zero.  Investigation shows that with negotiator rrl prefetch on, (now the default), the negotiator sends an END NEGOTIATE command after the prefetch, as well as after the negotiation proper.  When the schedd gets each one, it recalculates the flock level.  After an END NEGOTIATE after prefetch, no jobs have been matched, and none have been sent.  The schedd treats this as if the user has been completely satisfied, and then lowers the flock level.  As a result, the flock level is frequently knocked back to zero, and no jobs flock out.\n\n<p>To fix this, we will notice when the end of negotiation message really means end off rll fetch, and ignore the rest of the end of negotiation processing.  This should also remove some load from the schedd.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Mar-11 13:32:54 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p><code>m_num_resource_reqs_sent</code> is the wrong trigger for this early out in <code>scheduler_handleNegotiationFinished()</code>. The negotiator can and will ask for more resource requests during the main negotiation conversation. The correct trigger is if <code>getNumJobsMatched()</code> and <code>getNumJobsRejected()</code> both return 0. That indicates that the negotiator hasn't sent any results, which should be true if and only if it's in prefetch.\n</p><hr/>\n<em>2020-Apr-10 07:46:37 by tim:</em> <br/>\n\nBulk change of target version from v080906 to v080907 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-Sep-17 11:13:11 by jfrey:</em> <br/>\n\nThis code was back-ported to 8.8.10 (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7754\" onclick=\"get_ticket_and_populate_wrapper('7754'); return false;\" title=\"Backport flocking fixes from Development\">#7754</a></span>).</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7635\" onclick=\"get_ticket_and_populate_wrapper('7635'); return false;\" title=\"Set permissions on docker's volume mount directories correctly\">#7635</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSet permissions on docker's volume mount directories correctly</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-03 09:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60075\">[60075]</a></span>: Fix flocking when negotiator prefetch is on <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7549\" onclick=\"get_ticket_and_populate_wrapper('7549'); return false;\" title=\"Negotiator prefetch breaks flocking\">#7549</a></span> CHTC reports that the number of flocking out jobs has almost completely gone to zero. Investigation shows that with negotiator rrl prefetch on, (now the default), the negotiator sends an END NEGOTIATE command after the prefetch, as well as after the negotiation\u00a0[...]\n (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-03 09:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=60076\">[60076]</a></span>: Fix code review issues in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7549\" onclick=\"get_ticket_and_populate_wrapper('7549'); return false;\" title=\"Negotiator prefetch breaks flocking\">#7549</a></span> Committer: Tim Theisen <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7754\" onclick=\"get_ticket_and_populate_wrapper('7754'); return false;\" title=\"Backport flocking fixes from Development\">#7754</a></span> (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-11 16:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59132\">[59132]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7549\" onclick=\"get_ticket_and_populate_wrapper('7549'); return false;\" title=\"Negotiator prefetch breaks flocking\">#7549</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-11 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59131\">[59131]</a></span>: Fix code review issues in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7549\" onclick=\"get_ticket_and_populate_wrapper('7549'); return false;\" title=\"Negotiator prefetch breaks flocking\">#7549</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-10 20:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=59126\">[59126]</a></span>: Fix flocking when negotiator prefetch is on <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=7549\" onclick=\"get_ticket_and_populate_wrapper('7549'); return false;\" title=\"Negotiator prefetch breaks flocking\">#7549</a></span> CHTC reports that the number of flocking out jobs has almost completely gone to zero. Investigation shows that with negotiator rrl prefetch on, (now the default), the negotiator sends an END NEGOTIATE command after the prefetch, as well as after the negotiation\u00a0[...]\n (By Greg Thain )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Sep-17 11:13", "status": "resolved", "created": "2020-Mar-10 20:20", "fixed_version": "2020-Mar-10 20:20", "broken_version": "v080501", "priority": "1", "subsystem": "DaemonsSubmitNode", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": ""}