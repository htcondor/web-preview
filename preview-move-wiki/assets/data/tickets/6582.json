{"id": 6582, "title": "Ticket #6582: ReadUserLog class fails to detect file overwrites", "description": "<blockquote>\nThe <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadUserLog\" title=\"Read User Log\">ReadUserLog</a></span> class is responsible for tracking log files and retrieving information from them. This is used by DAGMan to track the .nodes.log file which coordinates DAG events with the schedd.\n\n<p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReadUserLog\" title=\"Read User Log\">ReadUserLog</a></span> uses a file descriptor to reference whichever file it is tracking. If that file gets overwritten, however, the file descriptor continues pointing to the old file (which doesn't actually get deleted until the last handle is closed). So we never notice that the file has been overwritten or its size has changed.\n\n</p><p>We need to find a reliable method to detect file overwrites. I'm not sure what that looks like at the moment, will update this ticket later. If anybody has suggestions I'd love to hear them!</p></blockquote>", "remarks": "<blockquote>\nWe can detect file overwrites by looking at the number of hard links on the open file descriptor. There should be exactly one link (the file itself) to the open descriptor; if the file gets erased or overwritten, this number drops to 0.\n\n<p></p><hr/>\n<em>2018-Mar-12 16:53:22 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-15 16:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1365f8fd3814d3994a3d327df89d01eaac361dd4\">[54523]</a></span>: Added documentation (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6579\" onclick=\"get_ticket_and_populate_wrapper('6579'); return false;\" title=\"DAGMan does not check for .nodes.log integrity\">#6579</a></span>) (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6582\" onclick=\"get_ticket_and_populate_wrapper('6582'); return false;\" title=\"ReadUserLog class fails to detect file overwrites\">#6582</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-14 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6c0ed1ce1749d86cc3d4db59feaf795e18404b28\">[54510]</a></span>: Fixed a couple of lingering bugs (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6579\" onclick=\"get_ticket_and_populate_wrapper('6579'); return false;\" title=\"DAGMan does not check for .nodes.log integrity\">#6579</a></span>) (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6582\" onclick=\"get_ticket_and_populate_wrapper('6582'); return false;\" title=\"ReadUserLog class fails to detect file overwrites\">#6582</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-09 11:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c5349bf174caebf6c051c900b922b6b0a9f7177c\">[54473]</a></span>: DAGMan now exits with error when log file gets corrupted (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6579\" onclick=\"get_ticket_and_populate_wrapper('6579'); return false;\" title=\"DAGMan does not check for .nodes.log integrity\">#6579</a></span>) (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6582\" onclick=\"get_ticket_and_populate_wrapper('6582'); return false;\" title=\"ReadUserLog class fails to detect file overwrites\">#6582</a></span>)  (By Mark Coatsworth )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-05 17:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7f24eb3ca208e4b9a391cfeb306a5dfb51a870d3\">[54470]</a></span>: Added check for overwritten or deleted log files (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6582\" onclick=\"get_ticket_and_populate_wrapper('6582'); return false;\" title=\"ReadUserLog class fails to detect file overwrites\">#6582</a></span>)  (By Mark Coatsworth )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Mar-15 16:03", "status": "resolved", "created": "2018-Feb-26 12:24", "fixed_version": "2018-Feb-26 12:24", "broken_version": "", "priority": "2", "subsystem": "Libs", "assigned_to": "coatsworth", "derived_from": "", "creator": "coatsworth", "rust": "", "customer_group": "other", "visibility": "public", "notify": "coatsworth@cs.wisc.edu, zmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}