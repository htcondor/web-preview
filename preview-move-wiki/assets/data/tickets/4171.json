{"id": 4171, "title": "Ticket #4171: Condor_submit_dag crash on 2.2 GB DAG file", "description": "<blockquote>\nFrom Tom Downes' email:\n\n<p>A Nemo user is trying to submit a \"large\" DAG file (2.2G). The\ncondor_submit_dag tool is crashing immediately upon attempting to submit it.\n\n</p><p>Should I expect this behavior? Are there suggested workarounds to the DAG\nstructure that might enable its execution? Can I validate the DAG file in\nsome alternate way?\n\n</p><p>DAG file here:\n\n</p><p><a class=\"external\" href=\"https://pantherfile.uwm.edu/downes/public/trigger_pipe.dag.gz\">https://pantherfile.uwm.edu/downes/public/trigger_pipe.dag.gz</a>\n\n</p><p>Command line:\n\n</p><p></p><pre>  [pcdev2:nsbh_test_4_recolored] condor_submit_dag -no_submit trigger_pipe.dag\nterminate called after throwing an instance of 'std::bad_alloc'\n\u00a0 what(): \u00a0std::bad_alloc\n  Stack dump for process 9806 at timestamp 1390496348 (19 frames)\n  /usr/lib/condor/libcondor_utils_8_0_5.so(dprintf_dump_stack+0x12d)[0x7fb771\n1f026d]\n  /usr/lib/condor/libcondor_utils_8_0_5.so(+0x15c032)[0x7fb7711ce032]\n  /lib/libpthread.so.0(+0xeff0)[0x7fb76cf22ff0]\n  /lib/libc.so.6(gsignal+0x35)[0x7fb76cbe41b5]\n  /lib/libc.so.6(abort+0x180)[0x7fb76cbe6fc0]\n  /usr/lib/libstdc++.so.6(_ZN9__gnu_cxx27__verbose_terminate_handlerEv+0x115)\n[0x7fb76d694dc5]\n  /usr/lib/libstdc++.so.6(+0xcb166)[0x7fb76d693166]\n  /usr/lib/libstdc++.so.6(+0xcb193)[0x7fb76d693193]\n  /usr/lib/libstdc++.so.6(+0xcb28e)[0x7fb76d69328e]\n  /usr/lib/libstdc++.so.6(_Znwm+0x7d)[0x7fb76d69371d]\n  /usr/lib/libstdc++.so.6(_Znam+0x9)[0x7fb76d6937d9]\n  /usr/lib/condor/libcondor_utils_8_0_5.so(_ZN13MultiLogFiles16readFileToStri\nngERK8MyString+0xd0)[0x7fb77116af60]\n  /usr/lib/condor/libcondor_utils_8_0_5.so(_ZN13MultiLogFiles22fileNameToLogi\ncalLinesERK8MyStringR10StringList+0x4d)[0x7fb77116c4ed]\n  /usr/lib/condor/libcondor_utils_8_0_5.so(_ZN13MultiLogFiles17getValuesFromF\nileERK8MyStringS2_R10StringListi+0x62)[0x7fb77116c702]\n  condor_submit_dag(_Z13GetConfigFileR10StringListbR8MyStringS2_+0x112)[0x408\nb92]\n  condor_submit_dag(_Z12setUpOptionsR20SubmitDagDeepOptionsR23SubmitDagShallo\nwOptions+0x3ae)[0x40597e]\n  condor_submit_dag(main+0x187)[0x407ab7]\n  /lib/libc.so.6(__libc_start_main+0xfd)[0x7fb76cbd0c8d]\n  condor_submit_dag[0x4042e9]</pre>\n</blockquote>", "remarks": "<blockquote>\n<em>2014-Jan-23 12:39:25 by wenger:</em> <br/>\n\nCreated V8_0-gittrac_4171-branch for this.\n\n<p></p><hr/>\n<em>2014-Jan-23 16:00:07 by wenger:</em> <br/>\n\nAlso see <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3843\" onclick=\"get_ticket_and_populate_wrapper('3843'); return false;\" title=\"DAGMan:  don't look for log file names in submit files\">#3843</a></span>.\n\n<p></p><hr/>\n<em>2014-Jan-29 13:23:31 by wenger:</em> <br/>\n\nThe basic problem was this:  condor_submit_dag needs to read the DAG file to find any per-DAG config files that are specified in the DAG file.  Unfortunately, it was doing this by calling a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MultiLogFiles\" title=\"Multi Log Files\">MultiLogFiles</a></span> method that read the entire file into a string in memory.  So the main fix to this bug was changing the condor_submit_dag code to use a new method that reads the DAG file line-by-line.  (This is also an improvement because it now uses the same line continuation code that the actual DAG parsing uses.)\n\n<p>There were a bunch of other places where the code used the \u201cread a whole file into a string\u201d functionality; I got rid of all of these except where it's extracting log files from Stork submit files.  I figure this isn't much of a problem for the following reasons:\n</p><ul>\n<li>It's a pretty rare case.\n</li><li>Stork submit files shouldn't ever be huge.\n</li></ul>\n\n<p>As part of this fix, I also cleaned up the various cases of log file modes somewhat.  There had been three cases, as follows (for Condor jobs; Stork jobs are somewhat different):\n</p><ol>\n<li>DAGMan not using workflow log, job submit file defines log file -&gt; events written to the job's log file, DAGMan reads that log file.\n</li><li>DAGMan not using workflow log, job submit file does <em>not</em> define a log file -&gt; events written to workflow/default log file <em>without</em> event mask.\n</li><li>DAGMan using workflow log -&gt; events written to workflow/default log file <em>with</em> event mask.\n</li></ol>\n\n<p>(The three cases were implemented in the order they're listed.)  Anyhow, as part of the fix to <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>, I made case # 2 the same as case # 3.\n\n</p><p>I also did a few other cleanups:\n</p><ul>\n<li>In the DAGMan job submission code, we only generate the event mask string once, instead of re-generating it for every submit (the string is the same every time anyhow).\n</li><li>I added a bunch of continuation lines to job_dagman_jobstate_log.dag so that we test the line continuation code in DAGMan.\n</li><li>If we're in workflow log mode, we no longer look at Condor node job submit files at all, since we don't care if they specify a log file; previously we read the submit file even if we didn't care about the log file (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3843\" onclick=\"get_ticket_and_populate_wrapper('3843'); return false;\" title=\"DAGMan:  don't look for log file names in submit files\">#3843</a></span>).\n</li><li>Various small cleanups in the log file-related DAGMan code.\n</li></ul>\n\n<p></p><hr/>\n<em>2014-Jan-30 10:50:56 by tannenba:</em> <br/>\n\nFYI, Chad mentioned the following in an email about why his DAGs grew so large.\n\n<p></p><div class=\"blockquote\">\n<table width=\"95%\"><tbody><tr><td>\u00a0</td><td>\n  \nThis is a \"normal outcome\" though maybe I should redefine normal. It is not\nfrom Pegasus.  It is testing a rather large advanced detector workflow,\nhowever.  The dag actually doesn't have an excessive number of jobs. I\nsuspect its bloated size is due to the number of input and output files\nlisted explicitly with full paths.  I am tracking each one of them rather\nthan using shortcuts such as cache files or regular expressions.   I think\nit is best to have all of them listed.\n\nAnyway, it is possible that I can make this dag have a smaller footprint.\n But even if I cut out an order of magnitude (which I am not sure that I\ncan), someday I will want to try an order of magnitude larger workflow :)\n</td></tr></tbody></table></div>\n\n\n<p></p><hr/>\n<em>2014-Jan-30 16:37:40 by johnkn:</em> <br/>\n\nCODE_REVIEW: the changes to condor_submit_dag and the new file reader class are approved for stable, but to be safe. I would prefer to be able to enable and disable the use of the new log reader class using a config knob in condor_submit_dag.\n\n<p>All of the rest of the changes should go into the development branch rather than into stable.\n\n</p><p></p><hr/>\n<em>2014-Jan-30 17:12:29 by wenger:</em> <br/>\n\nOkay, I'm planning to add a config knob: DAGMAN_USE_OLD_DAG_READER to cause condor_submit_dag to use the old \"read the file into a string\" code.  My current plan is to have this default to false.  Also, as per discussion with TJ, we want to remove this in 8.1.5 assuming nobody runs into problems with the new code.\n\n<p></p><hr/>\n<em>2014-Jan-31 14:19:18 by johnkn:</em> <br/>\n\nCODE_REVIEW: new patch is good for stable.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/tickets?ticket=4182\" onclick=\"get_ticket_and_populate_wrapper('4182'); return false;\" title=\"More cleanup of read_multiple_logs.cpp\">#4182</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nMore cleanup of read_multiple_logs.cpp</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4186\" onclick=\"get_ticket_and_populate_wrapper('4186'); return false;\" title=\"Remove DAGMAN_USE_OLD_DAG_READER config knob\">#4186</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRemove DAGMAN_USE_OLD_DAG_READER config knob</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4189\" onclick=\"get_ticket_and_populate_wrapper('4189'); return false;\" title=\"Finish merging DAGMan log file improvements\">#4189</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nFinish merging DAGMan log file improvements</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/820/gittrac_4171_diff\">gittrac_4171_diff</a>\n38619 bytes added by wenger on 2014-Jan-29 19:16:52 UTC.\n<br/>\nThis is a diff of all of the changes on the V8_0-gittrac_4171-branch.  Note:  at some points the way git comes up with the diffs are kind of confusing, and it may be easier to just look at the code directly.<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Feb-03 12:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39298\">[39298]</a></span>: edits to 8.0.6 version history item and new knob definition for DAGMAN_USE_OLD_DAG_READER <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-31 14:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39281\">[39281]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>: Committed the \"basic\" fix to V8_0-branch with new DAGMAN_USE_OLD_DAG_READER knob as requested by TJ in code review.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-29 14:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39255\">[39255]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span> /gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=3843\" onclick=\"get_ticket_and_populate_wrapper('3843'); return false;\" title=\"DAGMan:  don't look for log file names in submit files\">#3843</a></span>: Added version history items for these bug fixes.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-28 11:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39251\">[39251]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>: Should be pretty much finished up -- DAGMan no longer uses any of the \"read a whole file into a string\" methods, except for finding the log file for a Stork submit file; removed a bunch of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MultiLogFile\" title=\"Multi Log File\">MultiLogFile</a></span> methods that used or implemented the \"read a whole file into a string\" functionality.\u00a0[...]\n (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-24 14:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39242\">[39242]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>: Cleaned up and documented the MultiLogFiles::FileReader class.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-23 17:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39231\">[39231]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>: Fixed the basic problem, but lots of cleanup needed (including other places that use the \"read a whole file into a string\" functionality).  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jan-23 16:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=39230\">[39230]</a></span>: Gittrac <span class=\"ticket\"><a class=\"defer\" href=\"/tickets?ticket=4171\" onclick=\"get_ticket_and_populate_wrapper('4171'); return false;\" title=\"Condor_submit_dag crash on 2.2 GB DAG file\">#4171</a></span>: Split a bunch of lines with continuation characters to make sure that works properly.  (By Kent Wenger )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Feb-03 11:56", "status": "defer", "created": "2014-Jan-23 11:32", "fixed_version": "2014-Jan-23 11:32", "broken_version": "v080005", "priority": "5", "subsystem": "Dag", "assigned_to": "wenger", "derived_from": "", "creator": "wenger", "rust": "", "customer_group": "ligo", "visibility": "public", "notify": "wenger@cs.wisc.edu, tpdownes@gravity.phys.uwm.edu, johnkn@cs.wisc.edu,pcouvare@caltech.edu", "due_date": ""}