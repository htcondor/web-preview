{"id": 4803, "title": "Ticket #4803: Allow tools to contact starter when CCB and shared port are in use", "description": "<blockquote>\nSome client tools need to contact the starter (condor_ssh_to_job and condor_tail).  However, this may be impossible if the following two conditions are true:\n<ul>\n<li>Startd uses CCB.  This means the starter must connect to the client tool.\n</li><li>Client host uses shared_port.  This means the client must be able to write to the shared port directory (or the shared_port otherwise leaks the secret cookie).\nThis fact is the remaining reason (known to me, at least) that shared_port is not default.\n</li></ul>\n\n<p>I propose that, when the DCSched::getJobConnectInfo is invoked (and we're in the above situation), the schedd will send back a socket already connected to the starter.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Dec-30 22:01:23 by bbockelm:</em> <br/>\n\nNote to reviewers - branch V8_3-gt4803 includes branch V8_3-gt4800; however, probably only <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0eb1a90f5d4f706f6c67177da7f62326e54023c3\">[42042]</a></span> is needed.\n\n<p></p><hr/>\n<em>2015-Jan-13 10:45:50 by tlmiller:</em> <br/>\n\n<strong>Design Review</strong>\n\n<p>These patches implement the following algorithm:\n\n</p><p>1) If HTCondor is configured to use shared port, but the ssh-to-job client can not, request socket forwarding when connecting to the schedd to get the starter's security session.\n\n</p><p>2) If the schedd sees a request for socket forwarding, it connects to the starter itself, and then passes that connection's FD to the client.  This pass is accomplished by using an abstract unix domain socket.  (\"Abstract\" means that it does not appear in the file system, which neatly avoids the permission problem which prevents the client from using registering with the shared port daemon itself.)  The schedd adds the domain socket's name (address) and a random number, used as a capability, to the usual reply.\n\n</p><p>3) The client connects to the named unix domain socket and writes the capability; if it matches what the schedd sent, the schedd will reply by sending the FD of the connection it previously established to the starter.\n\n</p><p>I have a number of questions about this design.\n\n</p><p>A) We only care about shared port if the target starter uses CCB.  Why don't we check the target address to see if it uses CCB?\n\n</p><p>B) Do abstract domain sockets exist on any of our platforms other than Linux?  (The autogenerated \"address\" may also be Linux-specific.)  It's still worthwhile to do this even if they don't, we just need to be careful with our #ifdefs.\n\n</p><p>C) The schedd and the ssh-to-job process are not necessarily on the same machine.  We believe this configuration would normally work, but if shared port is configured on the ssh-to-job process's machine, we can't possibly pass it an FD.  We should probably warn the user, or automatically try something else.\n\n</p><p></p><hr/>\n<em>2015-Jan-13 11:07:57 by bbockelm:</em> <br/>\n\nHi ToddM,\n\n<p>Thanks for the review!  To address a few of your items:\n\n</p><p>(a) We actually do check for CCB use in the target address.  When the schedd returns the starter's address, there's another round-trip in the protocol where the client informs the server whether it wants the socket.  Look for the following line:\n\n</p><p></p><div class=\"verbatim\">\n<pre>bool still_want_socket = rsock &amp;&amp; sin.getCCBContact() &amp;&amp; cant_use_shared_port;\n</pre></div>\n\n\n<p>NOTE - this is only done by the client if the schedd appears to support FD passing.\n\n</p><p>So, in cases where the client can use the shared port - or the target does not use CCB - the client tool is responsible for connecting.\n\n</p><p>(b) Abstract name sockets are Linux-specific.  It's actually important to note we use two Linux-specific features: abstract domain sockets <strong>and</strong> auto-bind sockets.  This allows us to create a new listener socket without worrying about race conditions or otherwise stomping on pre-existing sockets.  Autobind is what guarantees this (kind of like a mkstemp for domain sockets).\n\n</p><p>(c) Yup - that's a limitation of this approach.  I don't see any way around this without a whole lot of complexity.  I'm willing to simply state this is a limitation we can't work around.\n\n</p><p></p><hr/>\n<em>2015-Jan-13 11:22:52 by tlmiller:</em> <br/>\n\n(A) Ah, OK.  I'd missed that.  Sorry.\n\n<p>(B) I guess that simplifies the #ifdefs?\n\n</p><p>(C) I might, but it requires a totally different approach to the problem.  For this approach, we (HTCondor) will just have to think about how to warn/help users who try to do this.\n\n</p><p></p><hr/>\n<em>2015-Jan-13 13:54:14 by tlmiller:</em> <br/>\n\nDesign doc draft here, which includes a brief section about the different approach:\n\n<p><a class=\"external\" href=\"https://docs.google.com/a/wisc.edu/document/d/1rJpKNl-ack0F_Y_lfAEWi46Yml7aj9DcH34TDb5Yb4Q\">https://docs.google.com/a/wisc.edu/document/d/1rJpKNl-ack0F_Y_lfAEWi46Yml7aj9DcH34TDb5Yb4Q</a>\n\n</p><p>Brian notes that even if this approach fails (like his and ToddT's previous attempts), the problems should be recorded for posterity (especially since AFAIK, we haven't retrodesign-doc'd shared port).\n\n</p><p></p><hr/>\n<em>2015-Jan-22 21:02:44 by bbockelm:</em> <br/>\n\nHi Todd,\n\n<p>What's the next step here?  This ticket ready to roll?\n\n</p><p>Brian\n\n</p><p></p><hr/>\n<em>2015-Jan-23 11:09:26 by tlmiller:</em> <br/>\n\nIt's still in design review.  I have another (new) proposal that I haven't gotten a chance to write up yet.\n\n<p></p><hr/>\n<em>2015-Feb-12 14:54:34 by tlmiller:</em> <br/>\n\nI wrote up two new ideas: \"Known-Connection Forwarding\" and \"Trusted Broker.\"  Both assume that an administrator is willing to allow inbound connections to processes on their machine if they come from daemons they already trust, e.g., the startd/starter.  The first proposal does this directly, the second via the trust relationship already established in the CCB.\n\n<p></p><hr/>\n<em>2015-Mar-12 16:32:04 by tannenba:</em> <br/>\n\nHow about this idea:\n\n<p>Client tools that may need to accept a reversed CCB connection are installed setgid to some group (perhaps just group condor?), and that group has write permission to the DAEMON_SOCKET_DIR.\n\n</p><p>This solution is simple to code/understand, no special handling required if ssh-to-job and schedd are not co-located, and is not specific to ssh-to-job (i.e. it would work for condor_config_val, condor_fetchlog, etc).  I <em>think</em> it is also as secure or more secure than any other idea we've had, assuming we audit each tool to make certain tools do not fork/exec a pathname provided by the user and/or always drop setgid upon fork/exec.  This would be a good exercise regardless of this ticket.  We could easily proceed one tool at a time, and only setgid the tools we anticipate requiring a reverse connection (e.g. condor_who would not need to be setgid).\n\n</p><p>Thoughts?\n\n</p><p></p><hr/>\n<em>2015-May-29 11:39:16 by tlmiller:</em> <br/>\n\nCurrent plan is for Linux:\n\n<p>We know that connections forwarded via an abstract domain socket are safe, because we control the (secret, random) name required to find/use them; only the daemons can use the abstract domain socket.\n\n</p><p>Therefore, only tools will need to use the \"daemon\" socket directory.  We think, then, that it will suffice to (audit) log connections made via the \"daemon\" socket directory; this won't prevent abuse, but it will make the guilty party clear(er).\n\n</p><p></p><hr/>\n<em>2015-Jun-04 10:38:23 by tlmiller:</em> <br/>\n\nAuditing code should be reviewed, since it's a little more sensitive than normal for a new feature.\n\n<p>Also, we'll need to edit the shared port section of the manual, and talk about possible consequences from allowing users to write to the daemon socket directory, maybe suggest alternatives (group writable).\n\n</p><p></p><hr/>\n<em>2015-Jun-25 16:17:28 by jfrey:</em> <br/>\n\nI made a minor change to the audit calls. If we want audit messages to be enabled by default, we'll need to add some entries to the param table.\n\n<p></p><hr/>\n<em>2015-Jun-29 11:44:28 by tlmiller:</em> <br/>\n\nLeaving the audit log off by default, since using the directory is only anomalous off Linux, and we don't presently have the ability to specify Linux-specific defaults.  We should rethink that decision if we enable shared port by default anywhere.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-15 14:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d87ad3ab915d60852932f1ccdbc7fc784dc4afb7\">[45315]</a></span>: improve documentation for new shared_port audit log <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-13 16:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0879bce0f42c79da1d1c45cd9f712c96430781f9\">[45293]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>) Documentation.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-25 11:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f61f94579cf22db9bc32533447c3bc1a04a5f4b9\">[45162]</a></span>: Change shared port audit messages to use socket unique id. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jun-01 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/257386f3bb7d43f1499dc906042ce611a92cb338\">[44929]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>) The shared port daemon will now write audit log entries for connections forwarded via the daemon socket dir.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-30 21:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d185a66b00ad443857c24d0e2dd5915d2567f805\">[42067]</a></span>: Upgrade client tools to use socket returned by schedd. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-30 21:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/eeffb52ff10a3aed97c68d24e86eb9dfb1b95e2d\">[42066]</a></span>: Allow the DCStarter object to be fed an already connected socket. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-30 21:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f8bacf93f331dc2b86b79b66035ef5d394c1e362\">[42065]</a></span>: Allow client to receive starter socket from schedd if necessary. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-30 21:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7c9dc730540ca6726ac9d4dd9630a3a927922eed\">[42064]</a></span>: Send back starter socket if requested. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-30 21:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d064f106348359f1e5b0dfaa3e7c90477133d4d6\">[42063]</a></span>: Do not try to delete abstract sockets. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Dec-30 21:46</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0250bce1128c1930e95889ca43fef35239355bd9\">[42062]</a></span>: Allow CEDAR to send/recv FDs between processes over a <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSock\" title=\"Reli Sock\">ReliSock</a></span>. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=4803\" onclick=\"get_ticket_and_populate_wrapper('4803'); return false;\" title=\"Allow tools to contact starter when CCB and shared port are in use\">#4803</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2015-Jul-13 16:44", "status": "resolved", "created": "2014-Dec-30 21:46", "fixed_version": "2014-Dec-30 21:46", "broken_version": "", "priority": "4", "subsystem": "DaemonSharedP", "assigned_to": "tlmiller", "derived_from": "#3813", "creator": "bbockelm", "rust": "", "customer_group": "other", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}