{"id": 6911, "title": "Ticket #6911: scitokens: starter leaks credential directories", "description": "<blockquote>\nAfter running a few \"hello world\" jobs with <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SciTokens\" title=\"Sci Tokens\">SciTokens</a></span> last night, I was surprised to see that the credential directories are still present this morning - around 8 hours after the jobs had exited successfully.\n\n<p>Since this is a root-level personal condor, the credmon is also trying to renew credentials <strong>in the starter-owned directories</strong> given that the semantics are to renew tokens for tokens matching the form <code>$SEC_CREDENTIAL_DIRECTORY/*/*.use</code>.\n\n</p><p>When we are in \"OAuth mode\",\n</p><ol>\n<li>The starter should cleanup after itself\n</li><li>The startd should cleanup after starters\n</li><li>The starter should place this directory in a location the credmon isn't scanning.</li></ol>\n</blockquote>", "remarks": "<blockquote>\n<em>2019-Feb-09 08:18:12 by bbockelm:</em> <br/>\n\nTodd was incredulous that HTCondor would be doing this, so I spent a bit of time tracking this down.\n\n<p>First, when the starter decides renew / acquire credentials, it calls this:\n\n</p><p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/master/src/condor_starter.V6.1/jic_shadow.cpp#L2974\">https://github.com/htcondor/htcondor/blob/master/src/condor_starter.V6.1/jic_shadow.cpp#L2974</a>\n\n</p><p>This calls a remote API to fetch the credentials and writes it into <code>SEC_CREDENTIAL_DIRECTORY</code>:\n\n</p><p><a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/master/src/condor_starter.V6.1/NTsenders.cpp#L2262\">https://github.com/htcondor/htcondor/blob/master/src/condor_starter.V6.1/NTsenders.cpp#L2262</a>\n\n</p><p>At this point, we have a directory created per job.  There simply doesn't appear anything that deletes these directories.\n\n</p><p>NOTE 1: At no point does the starter log it is moving these credentials or creating the directory.  Probably worth fixing.\n\n</p><p>NOTE 2: The directory creation is done unconditionally if <code>CREDD_OAUTH_MODE</code> is set to <code>true</code>, even if the job contains no credentials.\n\n</p><p></p><hr/>\n<em>2019-Apr-09 15:39:43 by jpatton:</em> <br/>\n\nThe first commit caused two regressions, which have been resolved by <span class=\"chng\"><a href=\"chngview?cn=56536\">[56536]</a></span> and <span class=\"chng\"><a href=\"chngview?cn=56537\">[56537]</a></span>:\n<ol>\n<li>When reading the list of token names from the <code>OAuthServicesNeeded</code> attr in the job ad (introduced in <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6891\" onclick=\"get_ticket_and_populate_wrapper('6891'); return false;\" title=\"job ads do not specify which tokens should be transferred\">#6891</a></span>), the \"*\" was not being changed to \"_\", which resulted in the starter asking for the wrong filename.\n</li><li>Tokens were being written in the sandbox as owner root (or condor) instead of the slot user, which resulted in preventing the slot user from reading their tokens.\n</li></ol>\n\n<p>These issues have been addressed, as well as a minor issue (starter tried to remove the leaky dirs this ticket addressed, even though they no longer exist).\n\n</p><p></p><hr/>\n<em>2019-Apr-09 15:40:04 by jpatton:</em> <br/>\n\n<strong>CODE REVIEW</strong>: Looks good to me.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-09 12:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56539\">[56539]</a></span>: OAuth creds are now stored in the sandbox and so already get cleaned up automatically. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6911\" onclick=\"get_ticket_and_populate_wrapper('6911'); return false;\" title=\"scitokens: starter leaks credential directories\">#6911</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-09 10:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56537\">[56537]</a></span>: Fetch creds into the sandbox as the user, not as root. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6911\" onclick=\"get_ticket_and_populate_wrapper('6911'); return false;\" title=\"scitokens: starter leaks credential directories\">#6911</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Apr-09 10:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56536\">[56536]</a></span>: Convert the '*' to an '_' if present since that's how it's stored in the Job Ad. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6911\" onclick=\"get_ticket_and_populate_wrapper('6911'); return false;\" title=\"scitokens: starter leaks credential directories\">#6911</a></span>  (By zmiller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-Mar-15 15:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"chngview?cn=56375\">[56375]</a></span>: Fetch OAuth tokens directly into the job sandbox instead of the SEC_CREDENTIAL_DIR. this makes sure they are cleaned up properly. <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=6911\" onclick=\"get_ticket_and_populate_wrapper('6911'); return false;\" title=\"scitokens: starter leaks credential directories\">#6911</a></span>  (By zmiller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Apr-09 15:40", "status": "resolved", "created": "2019-Feb-08 08:53", "fixed_version": "2019-Feb-08 08:53", "broken_version": "", "priority": "2", "subsystem": "DaemonsExecNode", "assigned_to": "jpatton", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "bbockelman@morgridge.org; tannenba@cs.wisc.edu", "due_date": ""}