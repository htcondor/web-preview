{"id": 2291, "title": "Ticket #2291: Parallel reconnection failing", "description": "<blockquote>\nThis may not be a problem yet, this is a preliminary investigation.  In the following, a parallel job was started, then the schedd sent SIGSEGV.\n\n<p>The reconnect appears to work, but a minute or so later the startd announces, \"claim no longer recognized by the schedd\" and hangs up.  A vanilla job submitted from the same schedd to the same startd reconnected and ran without problem.\n\n</p><p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StartLog\" title=\"Start Log\">StartLog</a></span>:\n</p><div class=\"code\">\n<pre class=\"code\">07/08/11 17:15:28 slot1: State change: claim no longer recognized by the schedd - removing claim\n07/08/11 17:15:28 slot1: Changing state and activity: Claimed/Busy -&gt; Preempting/Killing\n07/08/11 17:15:28 slot2: State change: claim no longer recognized by the schedd - removing claim\n07/08/11 17:15:28 slot2: Changing state and activity: Claimed/Busy -&gt; Preempting/Killing\n07/08/11 17:15:28 slot3: State change: claim no longer recognized by the schedd - removing claim\n07/08/11 17:15:28 slot3: Changing state and activity: Claimed/Busy -&gt; Preempting/Killing\n07/08/11 17:15:28 slot4: State change: claim no longer recognized by the schedd - removing claim\n07/08/11 17:15:28 slot4: Changing state and activity: Claimed/Busy -&gt; Preempting/Killing\n</pre></div>\n\n\n<p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ScheddLog\" title=\"Schedd Log\">ScheddLog</a></span>:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/08/11 17:14:23 (pid:29075) 3.0: JobLeaseDuration remaining: 863\n07/08/11 17:14:23 (pid:29075) DedicatedScheduler found machine slot1@puffin.cs.wisc.edu for possibly reconnection for job (3.0)\n07/08/11 17:14:23 (pid:29075) DedicatedScheduler found machine slot2@puffin.cs.wisc.edu for possibly reconnection for job (3.0)\n07/08/11 17:14:23 (pid:29075) DedicatedScheduler found machine slot3@puffin.cs.wisc.edu for possibly reconnection for job (3.0)\n07/08/11 17:14:23 (pid:29075) DedicatedScheduler found machine slot4@puffin.cs.wisc.edu for possibly reconnection for job (3.0)\n07/08/11 17:14:23 (pid:29075) DedicatedScheduler creating Allocations for reconnected job (3.0)\n07/08/11 17:14:23 (pid:29075) Starting add_shadow_birthdate(4.0)\n07/08/11 17:14:23 (pid:29075) Started shadow for job 4.0 on &lt;128.105.185.14:50537&gt; for adesmet, (shadow pid = 29080)\n07/08/11 17:14:23 (pid:29075) Starting add_shadow_birthdate(3.0)\n07/08/11 17:14:23 (pid:29075) Started shadow for job 3.0 on slot1@puffin.cs.wisc.edu &lt;128.105.185.14:50537&gt; for DedicatedScheduler, (shadow pid = 29081)\n07/08/11 17:14:29 (pid:29075) TransferQueueManager stats: active up=0/10 down=0/10; waiting up=0 down=0; wait time up=0s down=0s\n07/08/11 17:14:29 (pid:29075) Sent ad to central manager for adesmet@cs.wisc.edu\n07/08/11 17:14:29 (pid:29075) Sent ad to 1 collectors for adesmet@cs.wisc.edu\n07/08/11 17:15:29 (pid:29075) In DedicatedScheduler::reaper pid 29081 has status 27392\n07/08/11 17:15:29 (pid:29075) Shadow pid 29081 exited with status 107\n07/08/11 17:15:29 (pid:29075) Dedicated job abnormally ended, releasing claim\n07/08/11 17:15:29 (pid:29075) Dedicated job abnormally ended, releasing claim\n07/08/11 17:15:29 (pid:29075) Dedicated job abnormally ended, releasing claim\n07/08/11 17:15:29 (pid:29075) Dedicated job abnormally ended, releasing claim\n</pre></div>\n\n\n<p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ShadowLog\" title=\"Shadow Log\">ShadowLog</a></span>\n</p><div class=\"code\">\n<pre class=\"code\">07/08/11 17:14:24 (3.0) (29081): Trying to reconnect to disconnected job\n07/08/11 17:14:24 (3.0) (29081): LastJobLeaseRenewal: 1310162926 Fri Jul  8 17:08:46 2011\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration: 1200 seconds\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration remaining: 862\n07/08/11 17:14:24 (3.0) (29081): Trying to reconnect to disconnected job\n07/08/11 17:14:24 (3.0) (29081): LastJobLeaseRenewal: 1310163263 Fri Jul  8 17:14:23 2011\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration: 1200 seconds\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration remaining: 1199\n07/08/11 17:14:24 (3.0) (29081): Trying to reconnect to disconnected job\n07/08/11 17:14:24 (3.0) (29081): LastJobLeaseRenewal: 1310163263 Fri Jul  8 17:14:23 2011\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration: 1200 seconds\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration remaining: 1199\n07/08/11 17:14:24 (3.0) (29081): Trying to reconnect to disconnected job\n07/08/11 17:14:24 (3.0) (29081): LastJobLeaseRenewal: 1310163263 Fri Jul  8 17:14:23 2011\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration: 1200 seconds\n07/08/11 17:14:24 (3.0) (29081): JobLeaseDuration remaining: 1199\n07/08/11 17:14:24 (3.0) (29081): Attempting to locate disconnected starter\n07/08/11 17:14:24 (3.0) (29081): Found starter: &lt;128.105.185.14:39472&gt;\n07/08/11 17:14:24 (3.0) (29081): Attempting to reconnect to starter &lt;128.105.185.14:39472&gt;\n07/08/11 17:14:24 (3.0) (29081): Reconnect SUCCESS: connection re-established\n07/08/11 17:14:24 (3.0) (29081): Attempting to locate disconnected starter\n07/08/11 17:14:24 (3.0) (29081): Found starter: &lt;128.105.185.14:54201&gt;\n07/08/11 17:14:24 (3.0) (29081): Attempting to reconnect to starter &lt;128.105.185.14:54201&gt;\n07/08/11 17:14:24 (3.0) (29081): Reconnect SUCCESS: connection re-established\n07/08/11 17:14:24 (3.0) (29081): Attempting to locate disconnected starter\n07/08/11 17:14:24 (3.0) (29081): Found starter: &lt;128.105.185.14:48772&gt;\n07/08/11 17:14:24 (3.0) (29081): Attempting to reconnect to starter &lt;128.105.185.14:48772&gt;\n07/08/11 17:14:24 (3.0) (29081): Reconnect SUCCESS: connection re-established\n07/08/11 17:14:24 (3.0) (29081): Attempting to locate disconnected starter\n07/08/11 17:14:24 (3.0) (29081): Found starter: &lt;128.105.185.14:35331&gt;\n07/08/11 17:14:24 (3.0) (29081): Attempting to reconnect to starter &lt;128.105.185.14:35331&gt;\n07/08/11 17:14:24 (3.0) (29081): Reconnect SUCCESS: connection re-established\n07/08/11 17:15:29 (3.0) (29081): Job 3.0 is being evicted\n07/08/11 17:15:29 (3.0) (29081): **** condor_shadow (condor_SHADOW) pid 29081 EXITING WITH STATUS 107\n</pre></div>\n\n\n<p><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StarterLog\" title=\"Starter Log\">StarterLog</a></span>\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">07/08/11 17:08:49 ******************************************************\n07/08/11 17:08:49 ** condor_starter (CONDOR_STARTER) STARTING UP\n07/08/11 17:08:49 ** /scratch/adesmet/master/release_dir/sbin/condor_starter\n07/08/11 17:08:49 ** SubsystemInfo: name=STARTER type=STARTER(8) class=DAEMON(1)\n07/08/11 17:08:49 ** Configuration: subsystem:STARTER local:&lt;NONE&gt; class:DAEMON\n07/08/11 17:08:49 ** $CondorVersion: 7.7.1 Jul 07 2011 BuildID: UW_development PRE-RELEASE-UWCS $\n07/08/11 17:08:49 ** $CondorPlatform: I686-RedHat_5.6 $\n07/08/11 17:08:49 ** PID = 28124\n07/08/11 17:08:49 ** Log last touched 7/8 17:08:38\n07/08/11 17:08:49 ******************************************************\n07/08/11 17:08:49 Using config source: /scratch/adesmet/master/release_dir/etc/condor_config\n07/08/11 17:08:49 Using local config sources:\n07/08/11 17:08:49    /scratch/adesmet/master/release_dir/local.puffin/condor_config.local\n07/08/11 17:08:49 DaemonCore: command socket at &lt;128.105.185.14:35331&gt;\n07/08/11 17:08:49 DaemonCore: private command socket at &lt;128.105.185.14:35331&gt;\n07/08/11 17:08:49 Setting maximum accepts per cycle 4.\n07/08/11 17:08:49 Communicating with shadow &lt;128.105.185.14:56236?noUDP&gt;\n07/08/11 17:08:49 Submitting machine is \"puffin.cs.wisc.edu\"\n07/08/11 17:08:49 setting the orig job name in starter\n07/08/11 17:08:49 setting the orig job iwd in starter\n07/08/11 17:08:49 Job has WantIOProxy=true\n07/08/11 17:08:49 Initialized IO Proxy.\n07/08/11 17:08:49 Done setting resource limits\n07/08/11 17:08:49 File transfer completed successfully.\n07/08/11 17:08:50 Job 3.0 set to execute immediately\n07/08/11 17:08:50 Starting a PARALLEL universe job with ID: 3.0\n07/08/11 17:08:50 IWD: /scratch/adesmet/master/release_dir/local.puffin/execute/dir_28124\n07/08/11 17:08:50 Output file: /scratch/adesmet/master/release_dir/local.puffin/execute/dir_28124/_condor_stdout\n07/08/11 17:08:50 Error file: /scratch/adesmet/master/release_dir/local.puffin/execute/dir_28124/_condor_stderr\n07/08/11 17:08:50 About to exec /scratch/adesmet/master/release_dir/local.puffin/execute/dir_28124/condor_exec.exe\n07/08/11 17:08:50 Create_Process succeeded, pid=28137\n07/08/11 17:14:24 Accepted request to reconnect from &lt;128.105.185.14:42715&gt;\n07/08/11 17:14:24 Ignoring old shadow &lt;128.105.185.14:56236?noUDP&gt;\n07/08/11 17:14:24 Communicating with shadow &lt;128.105.185.14:47058?noUDP&gt;\n07/08/11 17:15:28 Got SIGQUIT.  Performing fast shutdown.\n07/08/11 17:15:28 ShutdownFast all jobs.\n07/08/11 17:15:28 Process exited, pid=28137, signal=15\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Dec-17 11:57:49 by tannenba:</em> <br/>\n\nThis ticket is old, and may no longer reflect reality.  Assigning to Sam to first verify if indeed this bug still exists.\n\n<p></p><hr/>\n<em>2013-Apr-22 16:53:54 by gthain:</em> <br/>\n\nI've started up a parallel job, killed the schedd in a bunch of ways, and reconnect always seems to work.  Note this was on a 7.7.1 schedd, I'm leaning to closing out this ticket unless there's a better reproducer.\n\n<p></p><hr/>\n<em>2013-Apr-23 14:34:46 by tannenba:</em> <br/>\n\nAccording to the ticket, reconnect did always work.  What failed was claim keep alives from startds (above rank 0) after the reconnect occurred. Did you set the job lease low, kill the schedd, perform a reconnect, and watch a startd on machine rank &gt; 0 successfully update the claim lease after the reconnect?\n\n<p></p><hr/>\n<em>2013-Apr-24 13:52:25 by gthain:</em> <br/>\n\nSet job_lease_duration to 60, set up two startds, started parallel job across both, waited two minutes, killed schedd.  restarted schedd, job reconnected and ran to completion correctly.\n\n<p></p><hr/>\n<em>2013-Apr-24 13:53:07 by gthain:</em> <br/>\n\nBut note that schedd wasn't writing <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastJobLeaseRenewalDate\" title=\"Last Job Lease Renewal Date\">LastJobLeaseRenewalDate</a></span> correctly, so I'm pushing a patch for that to this ticket.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-16 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/21a973f351a77ff26f30b8891821543315e84c57\">[35714]</a></span>: Version history items for #3239,#3240, and <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2291\" onclick=\"get_ticket_and_populate_wrapper('2291'); return false;\" title=\"Parallel reconnection failing\">#2291</a></span> ended up in 7.9.5 section instead of 7.9.6. All moved.  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-24 14:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/88ff44b7b0ae226e6bc1e8b8b1c489683a5ad1a6\">[35541]</a></span>: Document version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2291\" onclick=\"get_ticket_and_populate_wrapper('2291'); return false;\" title=\"Parallel reconnection failing\">#2291</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Apr-24 14:17</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/66503ca636ed4486dcfc382865ca9e0ccda56621\">[35539]</a></span>: Fix bug where ded sched did not persist job lease times <span class=\"ticket\"><a class=\"resolved\" href=\"/tickets?ticket=2291\" onclick=\"get_ticket_and_populate_wrapper('2291'); return false;\" title=\"Parallel reconnection failing\">#2291</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Oct-07 10:47", "status": "resolved", "created": "2011-Jul-08 17:41", "fixed_version": "2011-Jul-08 17:41", "broken_version": "v070701", "priority": "2", "subsystem": "Parallel", "assigned_to": "gthain", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tstclair@redhat.com, eje@cs.wisc.edu, tannenba@cs.wisc.edu, gthain@cs.wisc.edu, samf@cs.wisc.edu", "due_date": ""}