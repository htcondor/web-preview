{"id": 3292, "title": "Ticket #3292: condor_master crashes after reconfig with controller changes", "description": "<blockquote>\nWhen changing a daemon's configuration from non-controller to controller and issuing a reconfig, the daemons are started correctly.  However, when reversing the process (going from controller to non-controller) setup the master crashes.  This can be reproduced by setting:\n\n<p></p><pre>  MAX_HAD_LOG=640000\n  MASTER_NEGOTIATOR_CONTROLLER=HAD\n  HAD_LIST=$(IP_ADDRESS):$(HAD_PORT)\n  DAEMON_LIST = MASTER HAD NEGOTIATOR\n  STATE_FILE=$(SPOOL)/Accountantnew.log\n  HAD_CONNECTION_TIMEOUT=2\n  HAD_PORT=51450\n  HAD_LOG=$(LOG)/HADLog\n  HAD_ARGS=-p $(HAD_PORT)\n</pre>\n\n<p>Start condor.  Now edit the config by removing HAD from D_L:\n\n</p><p></p><pre>  DAEMON_LIST = MASTER NEGOTIATOR\n</pre>\n\n<p>Then issue a condor_reconfig.</p></blockquote>", "remarks": "<blockquote>\n<hr/>\n<em>2012-Oct-25 17:52:16 by johnkn:</em> <br/>\n\nBulk change of target version from v070806 to v070807 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2012-Oct-29 14:25:51 by jfrey:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p></p><ul>\n<li>The HA code in the master is completely unprepared for changes in what\ndaemons are under HAD control after startup. This patch doesn't fix\nthings completely. I'm not sure how much of an improvement it is, but\nit's no worse than before, with the exception of a controllee being\nadded to a controller's list multiple times (mentioned below).\n\n<p></p></li><li>It appears a daemon with a controller gets added to the controler's\ncontrollee list on every reconfig. There's no check on whether the\ndaemon is already in the list, so it will be added multiple times.\nOnce the list fills, RegisterControllee() will start to fail.\n\n<p></p></li><li>The one place you call your new DeregisterDaemon() method is\nunnecessary. We know from the preceeding call that the daemon isn't in\nDaemons::daemon_ptr.\n\n<p></p></li><li>To minimize lookups, I'd expect DeregisterDaemon() to either delete\nthe daemon* that's being unregistered or return the pointer to the\ncaller to handle cleanup.\n\n<p></p></li><li>There's no code to remove a daemon from the controler's controllee\nlist.\n\n<p></p></li><li>If a controller and controllee are both removed from the list, I\nbelieve the object for the controllee is now leaked.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Oct-30 16:01:56 by rrati:</em> <br/>\n\nCode Review Updates:\n<ul>\n<li>Daemons will now deregister from their controllers on a reconfig\n</li><li>It's not possible for a controllee to register multiple times with a controller\n</li><li>Removed <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DeregisterDaemon\" title=\"Deregister Daemon\">DeregisterDaemon</a></span>, it wasn't needed anymore\n</li><li>I don't believe there is a memory leak in the case where the controller and controllee are both removed.  There are 2 cases to this:\n<ol>\n<li>The controllee is running.   When they are both removed in this case, <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StopDaemon\" title=\"Stop Daemon\">StopDaemon</a></span> is called in main_config:956 because the daemon is no longer in DAEMON_LIST.  <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StopDaemon\" title=\"Stop Daemon\">StopDaemon</a></span> will see the daemon running and mark it as ok to exit and be cleaned up.  When the daemon exits, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DefaultReaper\" title=\"Default Reaper\">DefaultReaper</a></span> or <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=AllReaper\" title=\"All Reaper\">AllReaper</a></span> will delete the daemon.\n</li><li>The controllee is not running.  In this case, the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=StopDaemon\" title=\"Stop Daemon\">StopDaemon</a></span> is called like in case 1, but the daemon is seen as not running and is removed from the running daemon list (and deregistered from the controller) and deleted.\n</li></ol>\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-07 13:50:48 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>In daemon::DeregisterControllee(), the compacting of the controllees\nlist doesn't work properly if there's more than one controllee after the removed\none in the list. It also doesn't work properly if there's a duplicate entry in the controllees list, though hopefully that wouldn't happen.\n\n<p></p></li><li>In daemon::DeregisterControllee(), why use strncmp() instead of strcmp()? You'll get false matches if one controllee's name matches the start of another controllee's name.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-08 14:03:27 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p></p><ul>\n<li>Scratch the comment about problems in daemon::DeregisterControllee() when there are multiple entries after the controllee being removed. I was misreading the code.\n</li></ul>\n\n<p></p><hr/>\n<em>2012-Nov-28 14:55:57 by smoler:</em> <br/>\n\nMinimum documentation of a version history item in the 7.8.7 manual is needed for this bug fix.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-17 11:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5943c93af5367f2bd2a246c84a6b1bde5147ea29\">[34413]</a></span>: Minor edit to 7.8.7 version history item ===GT=== <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=3292\" onclick=\"get_ticket_and_populate_wrapper('3292'); return false;\" title=\"condor_master crashes after reconfig with controller changes\">#3292</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Dec-17 11:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0b629941df28a259a9979a9e7883636db192cd1b\">[34400]</a></span>: Version history for <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=3292\" onclick=\"get_ticket_and_populate_wrapper('3292'); return false;\" title=\"condor_master crashes after reconfig with controller changes\">#3292</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Nov-08 14:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/769df63d9e825e6cd24630ad81af7e5543756f9e\">[34052]</a></span>: Changed strncmp to strcmp in <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=DeregisterControllee\" title=\"Deregister Controllee\">DeregisterControllee</a></span> <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=3292\" onclick=\"get_ticket_and_populate_wrapper('3292'); return false;\" title=\"condor_master crashes after reconfig with controller changes\">#3292</a></span>  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-30 15:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6a69268a991f2581b07231333fb4519918f66292\">[33944]</a></span>: On a reconfig, daemons deregister from their controllers to allow for a DAEMON_LIST or other configuration change to impact the daemon's setup. It's also no longer possible for a controllee to register multiple times with a controller. <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=3292\" onclick=\"get_ticket_and_populate_wrapper('3292'); return false;\" title=\"condor_master crashes after reconfig with controller changes\">#3292</a></span>  (By Robert Rati )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Oct-25 11:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/462ff5423e2fec64986a0e017563761bb9da650b\">[33761]</a></span>: Fixed the condor_master crashed caused by switching between controller and non-controller daemon configurations. Changes to DAEMON_LIST can now include controller or non-controller setups. <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=3292\" onclick=\"get_ticket_and_populate_wrapper('3292'); return false;\" title=\"condor_master crashes after reconfig with controller changes\">#3292</a></span>  (By Robert Rati )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Nov-28 14:56", "status": "docpending", "created": "2012-Oct-25 11:22", "fixed_version": "2012-Oct-25 11:22", "broken_version": "v070503", "priority": "2", "subsystem": "Daemons", "assigned_to": "rrati", "derived_from": "", "creator": "rrati", "rust": "", "customer_group": "other", "visibility": "public", "notify": "johnkn@cs.wisc.edu,smoler@cs.wisc.edu,rrati@redhat.com, tstclair@redhat.com", "due_date": ""}