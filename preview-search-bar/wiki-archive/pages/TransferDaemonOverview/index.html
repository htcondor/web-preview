<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="HTCondor Homepage">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="date" content="2021-10-20 20:49:32 +0000" />

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/web-preview/preview-search-bar/assets/images/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/web-preview/preview-search-bar/assets/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/web-preview/preview-search-bar/assets/images/favicons/favicon-16x16.png">
    <link rel="manifest" href="/web-preview/preview-search-bar/assets/images/favicons/site.webmanifest">
    <link rel="mask-icon" href="/web-preview/preview-search-bar/assets/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/web-preview/preview-search-bar/assets/images/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/web-preview/preview-search-bar/assets/images/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!-- Primary Meta Tags -->
    <meta name="title" content="HTCondor">
    <meta name="description" content="HTCondor is a specialized workload management system for compute-intensive jobs. Built to be flexible, expressive, and compatible with Grid and Cloud computing environments HTCondor made to increase your Computational Throughput.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://htcondor.org/">
    <meta property="og:title" content="HTCondor">
    <meta property="og:description" content="HTCondor is a specialized workload management system for compute-intensive jobs. Built to be flexible, expressive, and compatible with Grid and Cloud computing environments HTCondor made to increase your Computational Throughput.">
    <meta property="og:image" content="https://htcondor.org/assets/images/HTC.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://htcondor.org/">
    <meta property="twitter:title" content="HTCondor">
    <meta property="twitter:description" content="HTCondor is a specialized workload management system for compute-intensive jobs. Built to be flexible, expressive, and compatible with Grid and Cloud computing environments HTCondor made to increase your Computational Throughput.">
    <meta property="twitter:image" content="https://htcondor.org/assets/images/HTC.png">

    <title>Transfer Daemon Overview</title>

    <script src="/web-preview/preview-search-bar/assets/js/sitewide.js" type="text/javascript" defer></script>
    <script src="/web-preview/preview-search-bar/assets/js/bootstrap.js" type="text/javascript"></script>
    <script src="/web-preview/preview-search-bar/assets/js/lunr.js" type="text/javascript" async></script>
    <script src="/web-preview/preview-search-bar/assets/js/search_bar.js" type="text/javascript" async></script>
    <script src="/web-preview/preview-search-bar/assets/js/default.js" type="text/javascript" defer></script>

    

    

    <meta name="robots" content="noindex">

    

    <link href="/web-preview/preview-search-bar/assets/css/style-v1.css" media="screen, tv, projection" title="Default" rel="stylesheet">
    

</head>
<body class="vh-100 d-flex flex-column">

<!-- For non-visual user agents: -->
<a id="skip-link" href="#main-copy">Skip to main content.</a>

<header id="header">
    <div class="mb-4 container">
        <div class="row">
            <div class="col-12">
                <nav class="navbar navBar navbar-expand-lg navbar-light w-100">
                    <a href="/web-preview/preview-search-bar/index.html" class="d-none d-md-inline"><img height="75" alt="Condor High Throughput Computing" src="/web-preview/preview-search-bar/assets/images/CondorTitle.png" style="border:0"></a>
                    <a href="/web-preview/preview-search-bar/index.html" class="d-inline d-md-none"><img height="65" alt="Condor High Throughput Computing" src="/web-preview/preview-search-bar/assets/images/HTCondor_red_blk.svg" style="border:0"></a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mb-2 mb-lg-0 ms-auto mt-auto">
                            <li class="nav-item">
                                <a class="nav-link " href="/web-preview/preview-search-bar/">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="/web-preview/preview-search-bar/new">News</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="/web-preview/preview-search-bar/downloads">Downloads</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="/web-preview/preview-search-bar/publications">Publications</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="mailto:htcondor-admin@cs.wisc.edu">Contact Us</a>
                            </li>
                            <li class="nav-item">
                                <div id="main-search-bar" class="search-bar">
                                    <input type="text" class="form-control" placeholder="Loading..." aria-describedby="button-addon2">
                                    <div class="results-dropdown" class="results-dropdown w-100">
                                        <div class="search-results" ></div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</header>
<main id="main-copy" tabindex="-1">
    <div class="container mb-4">
    <h1>Transfer Daemon Overview</h1>
<div id="content">
 <div class="verbatim">
  <pre>The "TransferDaemon" feature of HTCondor exists in four major parts:

1. A standalone daemon called the TransferD which wraps the FileTransfer object.
2. A "transfer daemon manager" which is an object in the schedd, but could
   be (and probably should be) converted to another standalone daemon. It is
   responsible for starting, stopping, and maintaining the status of each
   transfer daemon associated with a single user.
3. A daemon client object which is used to talk to the TransferDaemon.
4. A TransferRequest object which describes a request to transfer a sandbox.

The Purpose
-----------

The purpose of this feature was three fold:

1. To be able to transfer files to and from HTCondor controlled endpoints
  (which might not be the actual submit machine) asynchronously and under
  priviledge separation scenarios.

2. To decentralize the storage of job sandboxes, spool directories, etc.

3. To actually figure out and be able to schedule network I/O, disk bandwidth,
  etc so we don't crush machines when moving files around.

Overall Design
--------------

Job Submission:

[This functionality is implemented, but turned off suibmit.cpp by the
default value of the STMethod variable.]

When condor_submit connects to the schedd, the schedd uses the TDMan
oject to create/locate a TransferDaemon for that user. The address of the
TD is given back to condor_submit. condor_submit will first up a DaemonClient
to the TD and use the interface to move the sandbox over to it.

Job Execution:

[This is not implemented, but had worked in demo mode when I did it
"by hand". The pieces are present and it would be about 1 month of
coding/integration/testing work before it would function in a production
environment.]

When the schedd starts a job, it starts/locates a TD and tells the shadow
of its location. The shadow contacts the startd as normal and a starter
is created.  The shadow gives the starter the location of the TD instead
of (currently) itself as to where to find the job's files. The starter
then starts its own TD (as the uid/gid of the job itself) and tells it the
location of the TD on the submit side and that it should download the sandbox
to the current working directory.

Additional Facts:

All communication between the transferd and anything else happens with
message packets which are exactly classads.

When TransferRequests are sent to the transferd, either via stdin or via
the control connection, they are enclosed in an envelope called the
"encapsulation method". The envelope is a single ASCII newline delimited
line that is converted to an encapsulation enumeration. Currently, there is
only one, which represents the format of old classads. The additional data
on the fd is in whatever form the encapsulation method dictated it to be.

The call/response ordering of the network communications allows
notification of success/failure at the correct points to the client
for all operations. Reasons for success or failure of a portion of the
protcol are embedded in the return ads.  This method of using classads
for all communication and having correct call/response locations will make
protocol versioning and backwards compatibility much easier to perform.

The TD can be configured to exit if no tranfer requests have been asked
of it.

The TD doesn't have to be long living. It only has to be alive while there
are TransferRequests that need to be handled.

TransferRequest Object (treq)
----------------------

This object, whose defintion and implementation are found in:

condor_includes/condor_transfer_request.h
condor_utils/transfer_request.cpp

is a fundamental object in the design that represents a concrete
desire for transfering files to/from a location. It represents a unit
of work. The treq is used by different parts of the system and so often
only a subset of the API to the object is generally used at any one time.

Notably, the treq contains a SimpleList of classads that are all
associated with the transfer desired. Depending upon the file transfer
protocol specified, they could be jobads or some other kind of ad
describing what to do to some backend of the TransferD. Since the code
only supports the "HTCondor File Transfer Protocol" as defined by the
FileTransfer object, these ads are just a list of jobads.

The class' constructor can take a classad (whose schema is enforced
in TransferRequest::check_schema()) which will initialize all of the
internal variables. This is useful when the treq comes in over the network.

A feature of the treq object that is heavily used by the schedd are
callbacks which can be associated with a TransferRequest. The schedd,
while it is processing the treq, can interpose behavioral changes to the
treq via these callbacks:

pre_push
post_push
update
reaper


These mean, respectively:

pre_push
  Just before giving the treq to a transferd, yoiu have the ability to
  just in time modify the information in the treq. An example is modification
  of the jobads to mark the start time of the transfer.

post_push
  Just after the treq is pushed, call this callback. An example is
  when the schedd tells the client concrete information about the treq
  that the TransferDaemon provided to the schedd after accepting it.

update
  When a transferd finished transferring some files, it sends an update to
  the schedd, this is the callback which gets called in that scenario.
  An example is removing the job off of hold on a successful transfer.

reaper
  When the transferd exits, this will be the associated callback for the
  pending treq.

The behavioral changes that callbacks can decide in the processing of
the treq can be:

TREQ_ACTION_CONTINUE
 Keep processing the treq to the next stage.

TREQ_ACTION_FORGET
 Stop processing the treq, remove it from all structures, but don't free it.
 This assumes the callback took control of the memory.

TREQ_ACTION_TERMINATE
 Remove the treq from all consideration and then free it.
</pre>
 </div>
</div>

</div>
</main>
<div id="footer" class="border-top mt-auto">
    <div class="container py-4">
        <div class="row">
            <div class="col text-center">
                For comments or questions about this website, please email
                <a href="mailto:htcondor-admin@cs.wisc.edu">htcondor-admin@cs.wisc.edu</a><br />
                This work is supported by <a href="https://www.nsf.gov/div/index.jsp?div=OAC">NSF</a> under Cooperative Agreement <a href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=2030508">OAC-2030508</a> as part of the <a href="https://path-cc.io/">PATh Project</a>. <br />
                <script type="text/javascript">
                    document.write("Updated &raquo; "+lastMod(document.lastModified))
                </script>
            </div>
        </div>
    </div>
</div>



</body>
</html>
