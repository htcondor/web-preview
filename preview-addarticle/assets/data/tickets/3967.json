{"id": 3967, "title": "Ticket #3967: ClassAd quantize() can fail when in a cached expression", "description": "<blockquote>\nDuring evaluation of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> quantize() function, if the second argument is a list, we evaluate each element of the list. We use a variant of ExprTree::Evaluate() that looks up the parent scope in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> of the list element. If the whole exprTree has been cached, this parent scope isn't set and the evaluation fails. We should be using the ExprTree::Evaluate() variant that takes an <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EvalState\" title=\"Eval State\">EvalState</a></span> object, which contains the necessary scope information.\n\n<p>The incorrect behavior can be observed with this command:\n</p><div class=\"code\">\n<pre class=\"code\">condor_status -af '[a = quantize(3, {2})].a'\n</pre></div>\n\n\n<p>This should print '4' for each machine ad in the collector. If <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> caching is enabled, blank lines are printed instead.</p></blockquote>", "remarks": "<blockquote>\n<em>2013-Oct-15 09:48:17 by johnkn:</em> <br/>\n\nCODE REVIEW: looks good to me -tj</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-15 11:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0946c89929ca728b78688d8acffbe1b3223a8624\">[37862]</a></span>: minor edit of 8.0.4 version history item, to put the description of the fixed bug in past tense. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3967\" onclick=\"get_ticket_and_populate_wrapper('3967'); return false;\" title=\"ClassAd quantize() can fail when in a cached expression\">#3967</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-03 16:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/798099b2c1d7c4139d6b56058e83926005db509b\">[37761]</a></span>: Version history for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> quantize() bug. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3967\" onclick=\"get_ticket_and_populate_wrapper('3967'); return false;\" title=\"ClassAd quantize() can fail when in a cached expression\">#3967</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Oct-03 16:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/febdb2f787c4cb2169621afffdbb57986408f10c\">[37760]</a></span>: <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAd\" title=\"Class Ad\">ClassAd</a></span> quantize() can fail when in a cached expression. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3967\" onclick=\"get_ticket_and_populate_wrapper('3967'); return false;\" title=\"ClassAd quantize() can fail when in a cached expression\">#3967</a></span> When the second argument to quantize() is a list, we call Evaluate() on each element in the list. The variant of Evaluate() we use looks up the parent scope of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> for resolving any attribute references. If the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ExprTree\" title=\"Expr Tree\">ExprTree</a></span> is part of\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-Oct-15 09:48", "status": "resolved", "created": "2013-Oct-03 16:09", "fixed_version": "2013-Oct-03 16:09", "broken_version": "v080000", "priority": "3", "subsystem": "ClassAd", "assigned_to": "johnkn", "derived_from": "#2856", "creator": "jfrey", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}