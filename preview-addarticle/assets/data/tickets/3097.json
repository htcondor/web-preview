{"id": 3097, "title": "Ticket #3097: fix vulnerability to DNS-lookup delays", "description": "<blockquote>\nBen Cotton observed a case where a schedd melted down (i.e. failed to keep up with shadows) because an entry in the flocking list was not a valid DNS name.  Presumably, the failing lookup kept taking a lot of time, but the schedd just kept doing it anyway.\n\n<p>The death spiral began when a lot of these delays happened in a row.  We saw this in the logs:\n\n</p><p></p><div class=\"verbatim\">\n<pre>06/28/12 16:50:02 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:50:51 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:51:44 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:52:39 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:53:29 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:54:23 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:55:06 (pid:18733) Failed to start non-blocking update to unknown.\n06/28/12 16:56:02 (pid:18733) Failed to start non-blocking update to unknown.\n</pre></div>\n\n\n<p>Condor daemons already do some blacklisting of collectors that take a long time to fail.  That is when querying.  Perhaps the same needs to happen when publishing.\n\n</p><p>A deeper fix would be to never block on DNS lookups.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Jun-29 09:52:48 by bcotton:</em> <br/>\n\nI would also add that it would be beneficial if the log message were more clear about what's going wrong (e.g. which host name is failing to resolve). This could make identification of the problem quicker. Although it's less important if things continue working, it is useful information for administrators to have.\n\n<p></p><hr/>\n<em>2012-Jul-02 11:22:44 by tannenba:</em> <br/>\n\nBen - What specifically did you have in your flocking list that caused the DNS blocking?  Could you add it to the ticket (or just email it to me if you don't want it publicly visible) ?\n\n<p>I ask because typically DNS NXDOMAIN errors (i.e. domain or host does not exist) do not cause any blocking, and are also typically cached by the resolver, so I am wondering how to easily reproduce this bug.  Maybe some DNS servers have some sort of denial of service protection and slows down responses about non-existent hosts...\n\n</p><p></p><hr/>\n<em>2012-Jul-02 15:49:00 by bcotton:</em> <br/>\n\nThe host in question is condor.calumet.purdue.edu\n\n<p></p><hr/>\n<em>2012-Jul-02 16:10:41 by danb:</em> <br/>\n\nI tried adding condor.calumet.purdue.edu to FLOCK_TO and I observed the following stack trace in the schedd while it was blocked.\n\n<p></p><div class=\"verbatim\">\n<pre>#0  0x00007fff878b8c0a in kevent ()\n#1  0x00007fff878f79fa in _mdns_query_mDNSResponder ()\n#2  0x00007fff878f6c61 in _mdns_search ()\n#3  0x00007fff878f5ffc in _mdns_addrinfo ()\n#4  0x00007fff878f5059 in search_addrinfo ()\n#5  0x00007fff878f4a7a in si_addrinfo ()\n#6  0x00007fff878f448d in getaddrinfo ()\n#7  0x0000000100371615 in ipv6_getaddrinfo (node=0x100d31750 \"condor.calumet.purdue.edu\", service=0x0, ai=@0x7fff5fbfe060, hint=@0x7fff5fbfdfd0) at /Users/danb/condor/CONDOR_SRC/src/condor_utils/ipv6_addrinfo.cpp:134\n#8  0x0000000100372499 in get_fqdn_and_ip_from_hostname (hostname=@0x7fff5fbfe300, fqdn=@0x7fff5fbfe330, addr=@0x7fff5fbfe3e0) at /Users/danb/condor/CONDOR_SRC/src/condor_utils/ipv6_hostname.cpp:215\n#9  0x000000010044a1ef in Daemon::findCmDaemon (this=0x100d31590, cm_name=0x100d28550 \"condor.calumet.purdue.edu\") at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/daemon.cpp:1461\n#10 0x000000010044aa52 in Daemon::getCmInfo (this=0x100d31590, subsys=0x1004fba24 \"COLLECTOR\") at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/daemon.cpp:1380\n#11 0x000000010044bd40 in Daemon::locate (this=0x100d31590) at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/daemon.cpp:939\n#12 0x0000000100454596 in DCCollector::reconfig (this=0x100d31590) at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/dc_collector.cpp:173\n#13 0x0000000100454706 in DCCollector::init (this=0x100d31590, needs_reconfig=true) at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/dc_collector.cpp:59\n#14 0x0000000100454868 in DCCollector::DCCollector (this=0x100d31590, dcName=0x100d30c10 \"condor.calumet.purdue.edu\", uType=DCCollector::CONFIG) at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/dc_collector.cpp:38\n#15 0x0000000100450b48 in DaemonList::buildDaemon (this=0x100d30ac0, type=DT_COLLECTOR, host=0x100d30c10 \"condor.calumet.purdue.edu\", pool=0x0) at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/daemon_list.cpp:80\n#16 0x0000000100450cb3 in DaemonList::init (this=0x100d30ac0, type=DT_COLLECTOR, host_list=0x100d31100 \"condor.calumet.purdue.edu\", pool_list=0x0) at /Users/danb/condor/CONDOR_SRC/src/condor_daemon_client/daemon_list.cpp:68\n#17 0x0000000100053fae in Scheduler::Init (this=0x10018cba0) at /Users/danb/condor/CONDOR_SRC/src/condor_schedd.V6/schedd.cpp:10412\n</pre></div>\n\n\n<p>I also tested DNS lookups from the command-line:\n\n</p><p></p><div class=\"verbatim\">\n<pre>[danb@tonic:~]$ time host condor.calumet.purdue.edu\n;; connection timed out; trying next origin\nHost condor.calumet.purdue.edu not found: 3(NXDOMAIN)\n\nreal\t0m14.162s\nuser\t0m0.004s\nsys\t0m0.004s\n[danb@tonic:~]$ time host condor.calumet.purdue.edu\n;; connection timed out; trying next origin\nHost condor.calumet.purdue.edu not found: 3(NXDOMAIN)\n\nreal\t0m14.151s\nuser\t0m0.002s\nsys\t0m0.005s\n</pre></div>\n\n<hr/>\n<em>2012-Dec-11 16:38:39 by johnkn:</em> <br/>\n\nBulk change of target version from v070902 to v070903 using ./ticket-target-mover.\n<hr/>\n<em>2013-Jan-22 10:54:51 by johnkn:</em> <br/>\n\nBulk change of target version from v070903 to v070904 using ./ticket-target-mover.\n<hr/>\n<em>2013-Mar-05 10:58:27 by johnkn:</em> <br/>\n\nBulk change of target version from v070904 to v070905 using ./ticket-target-mover.\n<hr/>\n<em>2013-Apr-22 11:10:10 by johnkn:</em> <br/>\n\nBulk change of target version from v070905 to v070906 using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2014-May-27 14:22:56 by tannenba:</em> <br/>\n\nAbandoning this ticket, as ticket <span class=\"ticket\"><a class=\"active\" href=\"/wiki-archive/tickets/?ticket=4050\" onclick=\"get_ticket_and_populate_wrapper('4050'); return false;\" title=\"detect and attempt to avoid problems caused by DNS lookup delays\">#4050</a></span> essentially is a duplicate.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "enhance", "last_change": "2014-May-27 14:23", "status": "abandoned", "created": "2012-Jun-29 09:34", "fixed_version": "2012-Jun-29 09:34", "broken_version": "v070607", "priority": "2", "subsystem": "Daemons", "assigned_to": "zmiller", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "purdue", "visibility": "public", "notify": "dan@hep.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}