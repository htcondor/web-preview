{"id": 127, "title": "Ticket #127: condor.boot.generic init script will kill wrong condor_master", "description": "<blockquote>\n<a class=\"file\" href=\"rlog?f=src/condor_examples/condor.boot.generic\">/src/condor_examples/condor.boot.generic</a> will kill (with QUIT) the wrong condor_master.\n\n<p>This script just uses ps|grep to find any process with \"condor_master\" in its name (or anywhere else in the ps output) and kill -QUIT's the lot of them.  If there are more than one copy of Condor running, this will kill all of them.  So, for example, if a user is running a personal Condor, and the admin runs \"condor stop\" in preparation for an change, the user's personal Condor also goes away.\n\n</p><p>VDT users are actually hitting this case.  An admin will \"/etc/init.d/condor stop\" while working on the \"main\" Condor install, and in the process kill off unrelated Condor installs installed by the VDT.\n\n</p><p><a class=\"file\" href=\"rlog?f=src/condor_examples/condor.init\">/src/condor_examples/condor.init</a> doesn't have this problem, and generally works better.  Unfortunately it relies on Linux LSBisms (and perhaps Red-Hatisms).\n\n</p><p>Possible improvements:\n\n</p><p>Option 1: Warn users that condor.boot.generic is dangerous.  Simple, but users will likely ignore it, install it as is, and get surprises if a second Condor instance even ends up on the machine.\n\n</p><p>Option 2: Drop condor.boot.generic.  If condor.init doesn't work for you, you have to work it out for yourself.  Depending on how portable condor.init proves to be, this may be Good Enough.\n\n</p><p>Option 3: Make condor.boot.generic safer.  Possibly port condor.init to be more portable (will simply inlining the \"functions\" file be good enough?)  Possibly set CONDOR_CONFIG (default to empty) and use condor_off -master?  (While imperfect, since Condor may not have shut down by the time the script exists, the current condor.boot.generic suffers from this same bug.  There is a risk is that ALLOW_ADMINISTRATOR won't allow localhost's root to issue this command, and so it will be silently ignored.  condor.boot.generic's current implementation can't be ignored by the security layer.)\n\n</p><p>No matter what we do, we'll have users using the old scripts, so it may be worth publicizing that better options are available. The release notes are an obvious location.\n\n</p><p><a class=\"external\" href=\"http://crt.cs.wisc.edu/Ticket/Display.html?id=4328\">VDT ticket 4328</a> tracks this from the VDT's point of view.\n\n</p><p><strong>To do</strong>\n\n</p><p>This is a todo list for condor.boot.2.generic (attached)\n</p><ul>\n<li>If stop() times out, it might try harsher (kill -KILL) measures.\n</li><li>More fully comply with <a class=\"external\" href=\"http://refspecs.freestandards.org/LSB_3.1.0/LSB-Core-generic/LSB-Core-generic/initscrcomconv.html\">LSB comment guidelines</a>\n</li><li>If we can find the LSB /lib/lsb/init-functions we should use their functions.\n  <a class=\"external\" href=\"http://refspecs.freestandards.org/LSB_3.1.0/LSB-Core-generic/LSB-Core-generic/iniscrptfunc.html\">spec</a>\n</li><li>If we can find Red Hat's /etc/init.d/functions, we should use their functions (preferring the LSB ones if both are present)\n</li><li>Review chkconfig defaults\n</li><li>start() should wait \"a bit\" to confirm that `condor_pid` returns a PID.  If more than \"a bit\" passes without it, report failure.\n</li><li>status() should report more cases: pid file exists, but pid is gone.\n</li><li>Known to not work on:\n<ul>\n<li>Mac OS X: Condor apparently fails to drop a PID file?  May be failing to start?\n</li><li>HPUX: not investigated.\n</li></ul>\n</li><li>When the test is committed, add a new ticket to factor out the log watching code into a proper Perl class and add it to be shared testing library for general use.</li></ul>\n</blockquote>", "remarks": "<blockquote>\nIf one were to overhaul it in a portable way, some things to consider:\n\n<p></p><ul>\n<li>How portable is /etc/init.d/functions?  I don't know.\n</li><li>How portable is /lib/lsb/init-functions?  Probably reasonably so on modern Linux distributions, probably nowhere else as it's part of the LSB guidelines.  (For those interested in the LSB init script guidelines: <a class=\"external\" href=\"http://refspecs.linux-foundation.org/LSB_3.2.0/LSB-Core-generic/LSB-Core-generic/iniscrptact.html\">How an init script should behave</a> and <a class=\"external\" href=\"http://refspecs.linux-foundation.org/LSB_3.2.0/LSB-Core-generic/LSB-Core-generic/iniscrptfunc.html\">functionality ou ger from init-functions</a>.\n</li></ul>\n\n<p></p><hr/>\n<em>2009-Jan-26 18:32:25 by matt:</em> <br/>\n\nYou can look at condor.init's the commit log for a discussion of many of these issues. To address to indiscriminate condor_master killing you should use a pidfile, and condor.init has good examples of how to do that.\n\n<p>If you decide to modify condor.init so that it is no longer LSB-ish please let me know. I want to maintain an LSM version.\n\n</p><p></p><hr/>\n<em>2009-Jan-28 14:12:14 by adesmet:</em> <br/>\n\nI'm hacking on this because the VDT needs a solution sooner than later.  My goal: write something that will make the VDT happy that can also be adopted directly by Condor.  The VDT won't have to maintain a fork (they currently do), and Condor will get a better portable(ish) init script.\n\n<p></p><hr/>\n<em>2009-Feb-12 14:27:31 by adesmet:</em> <br/>\n\nAttached is a new boot script with matching test.\n\n<p>New features:\n</p><ul>\n<li>Implements all of the commands in <a class=\"external\" href=\"http://refspecs.linux-foundation.org/LSB_3.2.0/LSB-Core-generic/LSB-Core-generic/iniscrptact.html\">the LSB</a>\n</li><li>Should never shut down an unrelated Condor.  Tries to use a pidfile whenever possible, falling back on condor_off if necessary.\n</li><li>Aggressively tries to check for possible problems and reports them.\n</li><li>Tries to auto detect several platform-specific details.  In particular, detects the required arguments to ps, and if we use -n or \\c in echo to not emit a newline.\n</li><li>Better behaved.  Waits a bit for the master to shut down so it can report success or failure.\n</li></ul>\n\n<p>I'm adding a todo list to the ticket's base, since it should be more wiki-like in that things can be removed as implemented.\n\n</p><p></p><hr/>\n<em>2009-Feb-19 17:48:17 by adesmet:</em> <br/>\n\nTenative MacOS X theory: Condor was still running, second Condor started, failed to get the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InstanceLock\" title=\"Instance Lock\">InstanceLock</a></span>, <em>clobbered the pid file</em>.\n\n<p></p><hr/>\n<em>2009-Mar-23 14:38:50 by adesmet:</em> <br/>\n\nThe relevant bits from a failed Mac test:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">03/13 13:49:38 ** condor_master (CONDOR_MASTER) STARTING UP\n03/13 13:49:38 ** PID = 17580\n\nFri Mar 13 13:49:55 2009: CT:system(\"condor_off\", \"-master\")\n\n03/13 13:49:55 **** condor_master (condor_MASTER) pid 17580 EXITING WITH \\\n  STATUS 0\n\nFri Mar 13 13:49:56 2009: CT:system(\"./cmd_core_boot-script.init\", \"start\")\n\n03/13 13:49:57 ** condor_master (CONDOR_MASTER) STARTING UP\n03/13 13:49:57 ** PID = 17632\n\nFri Mar 13 13:50:07 2009: CT:system(\"./cmd_core_boot-script.init\", \"restart\")\nShutting down Condor (fast-shutdown mode)...using condor_off...Failed to stop \\\n  Condor (non-0 exit).\nStarting up Condor...done.\n\n03/13 13:50:07 ** condor_master (CONDOR_MASTER) STARTING UP\n03/13 13:50:07 ** PID = 17672\n03/13 13:50:07 ERROR \"Can't get lock on \"/Users/condor/execute/dir_13049/\\\n  userdir/src/condor_tests/cmd_core_boot-script.saveme/17561/17561local/\\\n  log/InstanceLock\"\" at line 961 in file master.cpp\n03/13 13:50:07 **** condor_master (condor_MASTER) pid 17632 EXITING WITH \\\n  STATUS 0\n</pre></div>\n\n\n<p></p><ul>\n<li>13:49:56: PID 17632 starts.\n</li><li>13:50:07: Tries to shut down.  The pidfile is missing or is inaccessible, so we fall back to using condor_off.  <em>Why is it missing?</em>\n</li><li>13:50:07: condor_off can't tell when the shutdown is successful, so the init script immediately tries condor_master.  PID 17672 starts.\n</li><li>13:50:07 17672 failed to get the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=InstanceLock\" title=\"Instance Lock\">InstanceLock</a></span> and EXCEPTs.\n</li><li>13:50:07 17632 finally shuts down.\n</li></ul>\n\n<p>Problems:\n\n</p><p></p><ol>\n<li>The pidfile either wasn't written, or is inaccessible.\n\n<p></p></li><li>If condor_restart is forced to fall back to condor_off, it should wait for a few seconds before attempting condor_master.  (If it's using kill, that means there is a valid pidfile, and it will correctly wait for Condor to exit.)\n</li></ol>\n\n<p></p><hr/>\n<em>2009-Jul-14 14:42:41 by adesmet:</em> <br/>\n\nThe pidfile clobbering problem has its own ticket: <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=343\" onclick=\"get_ticket_and_populate_wrapper('343'); return false;\" title=\"condor_master -pidfile will stomp pidfile of running master\">#343</a></span>\n<hr/>\n<em>2010-Oct-20 15:59:08 by jfrey:</em> <br/>\n\nBulk change of target version from v070504 to v070505 using ./ticket-target-mover.\n<hr/>\n<em>2011-Jan-27 14:21:33 by danb:</em> <br/>\n\nBulk change of target version from v070505 to v070506 using ./ticket-target-mover.\n<hr/>\n<em>2011-Feb-01 14:49:30 by tannenba:</em> <br/>\n\nBulk change of target version from v070506 to NULL using ./ticket-target-mover.\n\n<p></p><hr/>\n<em>2011-Aug-12 10:21:31 by adesmet:</em> <br/>\n\nTodo: investigate nleroy's work. Did he just contribute the condor.boot.rpm version?  Is there still a need/value to this version?</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/23/condor.boot.2.generic\">condor.boot.2.generic</a>\n11209 bytes added by adesmet on 2009-Feb-12 20:16:53 UTC.\n<br/>\nReplacement init script. Should be placed in src/condor_examples/<br/>\n</li><li><a href=\"../files/24/cmd_core_boot-script.run\">cmd_core_boot-script.run</a>\n13839 bytes added by adesmet on 2009-Feb-12 20:18:09 UTC.\n<br/>\nTest script for new init script.  Relies on cmd_core_boot-script.pcconf. Should be placed in src/condor_tests, and suitable lines added to src/condor_tests/Imakefile<br/>\n</li><li><a href=\"../files/25/cmd_core_boot-script.pcconf\">cmd_core_boot-script.pcconf</a>\n106 bytes added by adesmet on 2009-Feb-12 20:18:38 UTC.\n<br/>\nSupport file for cmd_core_boot-script.run.  Should be placed in src/condor_tests<br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "", "type": "defect", "last_change": "2012-Oct-16 13:14", "status": "stalled", "created": "2009-Jan-26 16:50", "fixed_version": "2009-Jan-26 16:50", "broken_version": "", "priority": "4", "subsystem": "", "assigned_to": "adesmet", "derived_from": "", "creator": "adesmet", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}