{"id": 6837, "title": "Ticket #6837: Schedd leaks memory when flocking to a non-existent pool", "description": "<blockquote>\nMWT2 reports that one of their schedds is leaking .5Gb memory a day, and has been since at least May.\n\n<p>Inspection of the logs reveals that the schedd is trying to flock to several pools, one of which doesn't exist anymore, and the other two have security settings which are blocking the RESCHEDULE command.\n\n</p><p>It turns out that the dc_collector object supports non-blocking connects.  When an update is send to a collector that is not yet connected, or whose connection is in flight, we queue up the ads to be sent to the collector.  If the non-blocking connect then fails to connect for any reason, we delete the pending ad.  If there are any more outstanding updates, we initiate one new non-blocking connect and send the next ad in the queue.\n\n</p><p>The problem is that updates happen with a much faster frequency than the non-blocking connect timeout.  So, if the non-blocking timeout is set to 20 seconds, we can frequently have several updates in the interim.  Thus, this pending update queue can grow without bounds.\n\n</p><p>For 8.8, we'll fix this by clearing the queue of pending updates.\n\n</p><p>For 8.9, there's no reason to keep more than one update for the same command and instance of ad.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Dec-12 13:54:31 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This change looks good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Dec-05 21:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/402b5f6f5945b6f53086eb03f25b4b4b51032b7f\">[55841]</a></span>: Fix memory leak in schedd when it can't flock to foreign pools <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6837\" onclick=\"get_ticket_and_populate_wrapper('6837'); return false;\" title=\"Schedd leaks memory when flocking to a non-existent pool\">#6837</a></span> Really a memory leak when any daemon is unable to send any ad to any collector.\u00a0[...]\n (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-Jan-03 13:05", "status": "resolved", "created": "2018-Dec-05 14:52", "fixed_version": "2018-Dec-05 14:52", "broken_version": "v080600", "priority": "1", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "atlas", "visibility": "public", "notify": "", "due_date": ""}