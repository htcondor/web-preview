{"id": 5989, "title": "Ticket #5989: condor_gpu_discovery -config should not write to stderr", "description": "<blockquote>\nWhen no GPUs are discovered, sometimes condor_gpu_discovery writes an error message to stderr.  This is benign when it is used in the normal way, but when it is used as a config include script, this causes spurious error messages to be written by tools.\n\n<p>Instead when the -config argument is passed, error messages should be written to stdout and prefixed with a comment, so you get something like this:\n\n</p><p></p><div class=\"term\">\n<pre class=\"term\">$ condor_gpu_discovery -config\n#Error libnvcuda.so: cannot open shared object file: No such file or directory: Cant open library: libcudart.so\nDetectedGPUs=0\nNUM_DETECTED_GPUs=0\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2016-Nov-04 13:40:27 by johnkn:</em> <br/>\n\nTest by\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">config fragment</pre>\n<pre class=\"snip\">include command : $(LIBEXEC)/condor_gpu_discovery -config\n</pre></div>\n\n\n<p></p><hr/>\n<em>2016-Nov-07 08:32:33 by mvpelletier:</em> <br/>\n\nSince NUM_DETECTED_GPUS doesn't change type, it seems like that's the more useful value to have in the config, and should be included even when zero.\n\n<p></p><hr/>\n<em>2016-Nov-30 09:38:01 by johnkn:</em> <br/>\n\nreverted commit <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a467b462f12e382160d23b133a59e1b997dabfae\">[49526]</a></span>, condor_gpu_discovery -config will now write NUM_DETECTED_GPUS=0 to stdout when an error prevents it from detecting any gpus.\n\n<p></p><hr/>\n<em>2016-Dec-05 16:17:16 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Looks good, except for the error message in the new code if the fixed-size buffer overflows; in that unlikely event, condor_gpu_discovery -config will still print something to stderr.  The one-character fix is to insert a '#' character before the error message to make sure it's a comment; a move-involved but better fix would be to malloc (and free) a large enough buffer in case of an overflow.  (Although I guess you'd still need an error message in case the malloc() failed, so maybe that's not much of a win.)\n\n</p><p></p><hr/>\n<em>2016-Dec-08 11:12:35 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Updated code looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-08 12:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f6a07b77b35a3d0d28c63b9e15522d318c52415e\">[49764]</a></span>: fix segfault on *nix with previous commit to <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-08 09:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/701a39a878ccf151ce4f8873b3ade084712114ab\">[49756]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>, don't write to stdout even for internal errors.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-29 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5c36ce66b380c81f7c835df203fb41b17cc0d416\">[49675]</a></span>: Added test to make sure when no GPUs are discovered, doesn't write an error message to stderr. ticket <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>  (By shuyangwang )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-28 15:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/744b351771369b3c1846ddb67378ba1dceadc472\">[49657]</a></span>: Revert \"change for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>, don't start printing NUM_DETECTED_GPUS=0 when no GPUs detected. (possible backward compat issue)\" This reverts commit a467b462f12e382160d23b133a59e1b997dabfae.  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-23 11:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3b30a6b53f2adcb4889e2b13b2dfccade6045cd5\">[49631]</a></span>: Version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5946\" onclick=\"get_ticket_and_populate_wrapper('5946'); return false;\" title=\"MAX_JOBS_PER_OWNER broken if job specifies an accounting_group\">#5946</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5983\" onclick=\"get_ticket_and_populate_wrapper('5983'); return false;\" title=\"REMOVE_SIGNIFICANT_ATTRIBUTES should not require a restart\">#5983</a></span>, and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-02 16:39</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a467b462f12e382160d23b133a59e1b997dabfae\">[49526]</a></span>: change for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>, don't start printing NUM_DETECTED_GPUS=0 when no GPUs detected. (possible backward compat issue)  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-02 16:22</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ac5fb740d3198bb3b80dd52fd3a2ffd37ee8a576\">[49524]</a></span>: fix for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5989\" onclick=\"get_ticket_and_populate_wrapper('5989'); return false;\" title=\"condor_gpu_discovery -config should not write to stderr\">#5989</a></span>, condor_gpu_discovery -config should not write to stderr. ===VersionHistory:Pending===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Dec-08 11:12", "status": "resolved", "created": "2016-Nov-02 16:19", "fixed_version": "2016-Nov-02 16:19", "broken_version": "v080409", "priority": "4", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "michael.v.pelletier@raytheon.com", "due_date": ""}