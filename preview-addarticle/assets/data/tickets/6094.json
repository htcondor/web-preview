{"id": 6094, "title": "Ticket #6094: Profile collector UPDATE_STARTD_AD handler", "description": "<blockquote>\nProfiling results of the UPDATE_STARTD_AD handler for the Collector - with an eye toward finding areas that we can improve.\n\n<p>The strategy will be to have several processes running long-lived condor_advertise that will read ads from stdin and send them on to the Collector.  The processes pushing to stdin will send a burst of ads periodically then sleep for a few milliseconds and send some more ads.\n\n</p><p>This will result in ads arriving in the collector on multiple sockets in a bursty way, which should be a pretty good simulation of actual operation.\n\n</p><p>The UPDATE_STARTD_AD command handler will be instrumented to that it keeps track of calls and time for itself and various subtasks.  That will guide modifications that will in turn be measured until we have a clear set of optimization tasks to choose from.\n\n</p><p>The performance tables below were captured using 5 <code>condor_advertise</code> processes, each simulating 20 machines that each have 11 slots (1 partitional &amp; 10 dynamic).  300 updates were sent for each ad for a total of 330,0000 updates\n\n</p><p>See below for the raw data.\n\n</p><p><strong>Executive summary</strong>\n<br/>\n<br/>\n\nThe clear implcation of the data is that the Classad parser is very slow, and a new parser optimized for speed could achieve significant gains - I believe the performance of Classad parsing could easily be doubled. Of lesser importance, but still significant would to speed up or avoid allocation and freeing of the exprtree nodes during updates in the Collector.\n\n</p><p><strong>Findings</strong>\n<br/>\n<br/>\n\nWhen handling STARTD Updates, the Collector spends 75% of the time in the function that gets a classad from a Cedar socket.  Most of the remaining time is spent deleting the old ad.\n\n</p><p>If we change the getAd function so that it doesn't parse the lines of the classad as it reads them off the Cedar socket, but instead stores them for later parsing (if needed), we can save about 1/2 of the time for that function and speed up handling of updates about 40%. Athough this strategy will make -constraint queries more expensive. This is evident in the fact that this strategy doubles the cost of generating the hashkey for the ad - it goes from 1% of the overall time to about 3%.\n\n</p><p>If we instead change getad to do its own parsing of all of the simple values (numeric and string literals), and pass only the complex expressions to the normal Classad parser, we can achieve most of the same performance speedup (roughly 35%) while avoiding the increased cost of -constraint queries.\n\n</p><p><strong>Raw Data</strong>\n\n</p><p></p><div class=\"snip\">\n<pre class=\"sniplabel\">Baseline 8.6.0 Collector</pre>\n<pre class=\"snip\">SysCpu:           8        UserCpu:      198\nMemory:      172924        RSS:        33256\nDuty Cycle:      41.57 %   Ops/second:   606.927\n\nRuntime  Inst Avg    Avg    Count/Min    Count      Max  Item\n\n  204.2     0.001  0.001     41251.38   330011    0.002  Socket_DCCommandHandler\n  189.9     0.001  0.001     41251.25   330010    0.002   Command_UPDATE_STARTD_AD\n  189.2     0.001  0.001     41251.38   330011    0.002    CollectorEngine_receive_update\n  188.7     0.001  0.001     41251.38   330011    0.002     CollectorEngine_ru_collect\n  188.6     0.001  0.001     41251.38   330011    0.002      CollectorEngine_ruc\n  148.3     0.000  0.000     41251.38   330011    0.002      CollectorEngine_ruc_getAd\n   38.2     0.000  0.000     41251.38   330011    0.001      CollectorEngine_ruc_collect\n   38.0     0.000  0.000     41251.38   330012    0.001       CollectorEngine_rucc\n   34.6     0.000  0.000     41113.75   328910    0.001       CollectorEngine_rucc_updateAd\n    2.6     0.000  0.000     41251.25   330010    0.001       CollectorEngine_rucc_makeHashKey\n    1.9     0.000  0.000     41251.38   330011    0.001      CollectorEngine_ruc_authid\n    0.6     0.080  0.064         1.00       10    0.634  Timer_dc_touch_log_file\n    0.3     0.000  0.000    713101.88  5705729    0.000  DprintfSkipped\n    0.3     0.000  0.000     41251.38   330011    0.000     CollectorEngine_ru_pre_collect\n    0.1     0.000  0.000     41251.38   330011    0.000     CollectorEngine_ru_stash_socket\n    0.1     0.000  0.000     41251.38   330011    0.000     CollectorEngine_ru_plugins\n    0.1     0.000  0.000       137.50     1100    0.000       CollectorEngine_rucc_insertAd\n    0.0     0.000  0.000     41251.38   330011    0.000     CollectorEngine_ru_forward\n    0.0     0.007  0.015         0.25        3    0.031  Timer_self_monitor\n    0.0     0.000  0.000     41251.38   330012    0.000       CollectorEngine_rucc_validateAd\n    0.0     0.000  0.000       138.13     1140    0.000  DprintfLogged\n    0.0     0.000  0.000         0.25       14    0.000  NameResolveFast\n    0.0     0.000  0.000         0.25       14    0.000  NameResolve\n    0.0     0.000  0.000         0.25       14    0.000  RecentDCNameResolveFast\n    0.0     0.000  0.000         0.25       14    0.000  RecentDCNameResolve\n    0.0     0.000  0.001         0.00        1    0.001  Timer_DaemonCoreSendAliveToParent\n    0.0     0.000  0.001         0.00        1    0.001  Timer_sendCollectorAd\n    0.0     0.000  0.000         0.13        1    0.000  Timer_SharedPortEndpointRetryInitRemoteAddress\n    0.0     0.000  0.000         3.13       29    0.000  Timer_CCBServerPollSockets\n    0.0     0.000  0.000         0.13        2    0.000       CollectorEngine_rucc_other\n    0.0     0.000  0.000         0.13        2    0.000  Timer_check_session_cache\n    0.0     0.000  0.000         0.13        2    0.000  Command_QUERY_COLLECTOR_ADS\n    0.0     0.000  0.000         0.13        1    0.000  Command_UPDATE_MASTER_AD\n    0.0     0.000  0.000         0.63        5    0.000  Command_DC_NOP\n    0.0     0.000  0.000         0.00        1    0.000  Timer_dc_touch_lock_files\n    0.0     0.000  0.000         0.00        1    0.000  Timer_handle_cookie_refresh\n</pre></div>\n\nBaseline results are from tj's alt/collector_CacheQuery3_*.ad\n\n<p>Next are the results from Greg's Lazy parse test branch. This shows nice performance, but ads are in a form that can will make -constraint queries more costly - something not measured in this test.\n</p><div class=\"snip\">\n<pre class=\"sniplabel\">V8_5-lazy_parsing-branch </pre>\n<pre class=\"snip\">SysCpu:          10        UserCpu:      135\nMemory:      182980        RSS:        38652\nDuty Cycle:      27.09 %   Ops/second:   658.871\n\nRuntime  Inst Avg    Avg    Count/Min    Count      Max  Item\n\n  124.1     0.000  0.000     41251.38   330011    0.002  Socket_DCCommandHandler\n  112.2     0.000  0.000     41251.25   330010    0.002   Command_UPDATE_STARTD_AD\n  111.0     0.000  0.000     41251.38   330011    0.002    CollectorEngine_ru_collect\n  110.9     0.000  0.000     41251.38   330011    0.002     CollectorEngine_ruc\n   70.3     0.000  0.000     41251.38   330011    0.001     CollectorEngine_ruc_getAd\n   39.3     0.000  0.000     41251.38   330011    0.002     CollectorEngine_ruc_collect\n   39.1     0.000  0.000     41251.38   330012    0.002      CollectorEngine_rucc\n   32.8     0.000  0.000     41113.75   328910    0.002      CollectorEngine_rucc_updateAd\n    5.6     0.000  0.000     41251.25   330010    0.000      CollectorEngine_rucc_makeHashKey\n    1.2     0.000  0.000     41251.38   330011    0.000     CollectorEngine_ruc_authid\n    0.4     0.000  0.000    854860.88  6840129    0.000  DprintfSkipped\n    0.2     0.000  0.000     41251.38   330011    0.000    CollectorEngine_ru_pre_collect\n    0.1     0.000  0.000     41251.38   330011    0.000    CollectorEngine_ru_stash_socket\n    0.1     0.000  0.000     41251.38   330011    0.000    CollectorEngine_ru_plugins\n    0.1     0.000  0.000       137.50     1100    0.000       CollectorEngine_rucc_insertAd\n    0.1     0.000  0.000     41251.38   330011    0.000    CollectorEngine_ru_forward\n    0.0     0.006  0.013         0.25        3    0.026  Timer_self_monitor\n    0.0     0.000  0.000       138.25     1141    0.000  DprintfLogged\n    0.0     0.000  0.000     41251.38   330012    0.000  CollectorEngine_rucc_validateAd\n    0.0     0.000  0.000         1.00       10    0.002  Timer_dc_touch_log_file\n    0.0     0.000  0.004         0.00        1    0.004  Timer_DaemonCoreSendAliveToParent\n    0.0     0.000  0.000         0.25       14    0.000  RecentDCNameResolve\n    0.0     0.000  0.000         0.25       14    0.000  NameResolveFast\n    0.0     0.000  0.000         0.25       14    0.000  NameResolve\n    0.0     0.000  0.000         0.25       14    0.000  RecentDCNameResolveFast\n    0.0     0.000  0.000         0.00        1    0.000  Timer_sendCollectorAd\n    0.0     0.000  0.000         0.13        1    0.000  Timer_SharedPortEndpointRetryInitRemoteAddress\n    0.0     0.000  0.000         3.13       29    0.000  Timer_CCBServerPollSockets\n    0.0     0.000  0.000         0.13        2    0.000  CollectorEngine_rucc_other\n    0.0     0.000  0.000         0.13        2    0.000  Timer_check_session_cache\n    0.0     0.000  0.000         0.13        2    0.000  Command_QUERY_COLLECTOR_ADS\n    0.0     0.000  0.000         0.13        1    0.000  Command_UPDATE_MASTER_AD\n    0.0     0.000  0.000         0.63        5    0.000  Command_DC_NOP\n    0.0     0.000  0.000         0.00        1    0.000  Timer_dc_touch_lock_files\n    0.0     0.000  0.000         0.00        1    0.000  Timer_handle_cookie_refresh\n</pre></div>\n\nResults from tj's master/collector_LazyParse3_*.ad\n\n<p>Next an experimental collector with the code organized in a way that permits an overall reduction in the number of copies of a single line of the classad as it is parsed and the key generated. This is combined with a special version of <code>getClassAd</code> that parses the literals itself rather than calling the classad parser.\n</p><div class=\"snip\">\n<pre class=\"sniplabel\">Experimental Collector</pre>\n<pre class=\"snip\">SysCpu:          10        UserCpu:      131\nMemory:      178708        RSS:        35608\nDuty Cycle:      24.81 %   Ops/second:   570.631\n\nRuntime  Inst Avg    Avg    Count/Min    Count      Max  Item\n\n  138.2     0.000  0.000         0.00   330011    0.006  Socket_DCCommandHandler\n  124.6     0.000  0.000         0.00   330010    0.006   Command_UPDATE_STARTD_AD\n  123.9     0.000  0.000         0.00   330011    0.006    ReceiveUpdate\n   88.1     0.000  0.000         0.00   330011    0.006     ReceiveUpdateGetAd\n   87.4     0.000  0.000         0.00   330010    0.006      getClassAdEx2\n   56.3     0.000  0.000         0.00 45391310    0.006       getClassAdEx2Literal\n   32.0     0.000  0.000         0.00   330011    0.002     ReceiveUpdateCollect\n   29.6     0.000  0.000         0.00  7860275    0.002       getClassAdEx2Cache\n    1.5     0.000  0.000         0.00   330011    0.001     ReceiveUpdateAuthId\n    0.9     0.000  0.000         0.00   330011    0.000     ReceiveUpdateIntro\n    0.8     0.000  0.000         0.00   330010    0.001     ReceiveUpdateGetPrivateAd\n    0.3     0.000  0.000         0.00   330010    0.000     ReceiveUpdateForwardAds\n    0.1     0.012  0.034         0.00        3    0.076  Timer_self_monitor\n    0.0     0.001  0.001         0.00       12    0.006  Timer_dc_touch_log_file\n    0.0     0.001  0.000         0.00       13    0.000  RecentDCNameResolve\n    0.0     0.001  0.000         0.00       13    0.000  NameResolve\n    0.0     0.001  0.000         0.00       13    0.000  RecentDCNameResolveFast\n    0.0     0.001  0.000         0.00       13    0.000  NameResolveFast\n    0.0     0.000  0.005         0.00        1    0.005  Timer_DaemonCoreSendAliveToParent\n    0.0     0.001  0.001         0.00        2    0.001  Timer_SharedPortEndpointRetryInitRemoteAddress\n    0.0     0.000  0.000         0.00        1    0.000  Timer_send_collector_ad\n    0.0     0.000  0.000         0.00       35    0.000  Timer_CCBServerPollSockets\n    0.0     0.000  0.000         0.00        3    0.000  Timer_check_session_cache\n    0.0     0.000  0.000         0.00        2    0.000  Command_QUERY_COLLECTOR_ADS\n    0.0     0.000  0.000         0.00        1    0.000  Command_UPDATE_MASTER_AD\n    0.0     0.000  0.000         0.00        1    0.000  Timer_dc_touch_lock_files\n    0.0     0.000  0.000         0.00        5    0.000  Command_DC_NOP\n    0.0     0.000  0.000         0.00        1    0.000  Timer_handle_cookie_refresh\n    0.0     0.000  0.000         0.00  6918825    0.000  ClassadCacheHits\n    0.0     0.000  0.000         0.00  7860564    0.000  ClassadCacheQuerys\n    0.0     0.000  0.000         0.00   581679    0.000  ClassadCacheMisses\n    0.0     0.000  0.000         0.00   579626    0.000  ClassadCacheRemovals</pre></div>\n\nthis is from tj's clerk/collector_getClassAdEx2_PreParseStrtol28_*.ad\n\n<p></p><div class=\"snip\">\n<pre class=\"sniplabel\">8.7.0 results with fast literals and lazy expressions</pre>\n<pre class=\"snip\">SysCpu:          10        UserCpu:      117\nMemory:      178944        RSS:        35100\nDuty Cycle:      23.93 %   Ops/second:   635.453\n\n  Runtime  Inst Avg    Avg    Count/Min      Count      Max  Item\n\n    106.6     0.000  0.000     41251.38     330011    0.002  Socket_DCCommandHandler\n     94.6     0.000  0.000     41251.25     330010    0.002  Command_UPDATE_STARTD_AD\n     93.3     0.000  0.000     41251.38     330011    0.002  CollectorEngine_ru_collect\n     93.3     0.000  0.000     41251.38     330011    0.002  CollectorEngine_ruc\n     57.1     0.000  0.000     41251.38     330011    0.002  CollectorEngine_ruc_getAd\n     33.4     0.000  0.000     41251.38     330011    0.001  CollectorEngine_ruc_collect\n     33.2     0.000  0.000     41251.38     330012    0.001  CollectorEngine_rucc\n     30.0     0.000  0.000     41113.75     328910    0.001  CollectorEngine_rucc_updateAd\n      2.6     0.000  0.000     41251.38     330011    0.000  CollectorEngine_ruc_authid\n      2.4     0.000  0.000     41251.25     330010    0.000  CollectorEngine_rucc_makeHashKey\n      0.3     0.000  0.000     41251.38     330011    0.000  CollectorEngine_ru_pre_collect\n      0.1     0.000  0.000     41251.38     330011    0.000  CollectorEngine_ru_stash_socket\n      0.1     0.000  0.000     41251.38     330011    0.000  CollectorEngine_ru_plugins\n      0.1     0.012  0.026         0.25          3    0.055  Timer_self_monitor\n      0.1     0.000  0.000       137.50       1100    0.000  CollectorEngine_rucc_insertAd\n      0.1     0.000  0.000     41251.38     330011    0.000  CollectorEngine_ru_forward\n      0.1     0.000  0.000     41251.38     330012    0.000  CollectorEngine_rucc_validateAd\n      0.0     0.001  0.001         1.00         10    0.002  Timer_dc_touch_log_file\n      0.0     0.001  0.000         0.25         14    0.000  RecentDCNameResolve\n      0.0     0.001  0.000         0.25         14    0.000  NameResolve\n      0.0     0.001  0.000         0.25         14    0.000  NameResolveFast\n      0.0     0.001  0.000         0.25         14    0.000  RecentDCNameResolveFast\n      0.0     0.000  0.004         0.00          1    0.004  Timer_DaemonCoreSendAliveToParent\n      0.0     0.000  0.000         0.00          1    0.000  Timer_sendCollectorAd\n      0.0     0.000  0.000         0.13          1    0.000  Timer_SharedPortEndpointRetryInitRemoteAddress\n      0.0     0.000  0.000         3.25         29    0.000  Timer_CCBServerPollSockets\n      0.0     0.000  0.000         0.13          2    0.000  Timer_check_session_cache\n      0.0     0.000  0.000         0.13          2    0.000  CollectorEngine_rucc_other\n      0.0     0.000  0.000         0.13          2    0.000  Command_QUERY_COLLECTOR_ADS\n      0.0     0.000  0.000         0.13          1    0.000  Command_UPDATE_MASTER_AD\n      0.0     0.000  0.000         0.63          5    0.000  Command_DC_NOP\n      0.0     0.000  0.000         0.00          1    0.000  Timer_dc_touch_lock_files\n      0.0     0.000  0.000         0.00          1    0.000  Timer_handle_cookie_refresh\n</pre></div>\n\nResults from tj's alt/collector_Validate_*.ad</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "todo", "last_change": "2017-Apr-03 14:31", "status": "resolved", "created": "2017-Jan-18 17:57", "fixed_version": "2017-Jan-18 17:57", "broken_version": "", "priority": "4", "subsystem": "DaemonsCM", "assigned_to": "johnkn", "derived_from": "#6093", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}