{"id": 7696, "title": "Ticket #7696: GPU discovery should report stable GPU ids", "description": "<blockquote>\nWe have discovered that when a GPU goes bad on a machine with multiple GPUs, Docker will refuse to use <strong>any</strong> of the GPUs until that GPU is taken offline (via nvidia-smi drain).  Once a GPU is taken offline, however, it disappears from GPU enumeration, and the GPUs after it move down 1 index.\n\n<p>Since GPU ids are currently GPU indices, this essentially shuffles the GPUs behind the Startd's back causing who knows what problems.\n\n</p><p>We need to change <code>condor_gpu_discovery</code> so that it reports stable identifiers for the GPUs.  This can be done by using the GPU uuid instead of the GPU index.  Also NVIDIA allows the uuid prefix to be used, so long as it is not ambiguous. So we will use either the first 8 characters of the uuid, or the whole uuid.  <code>DetectedGPUs</code> then becomes\n\n</p><p></p><pre>    DetectedGPUs=\"GPU-5498e439, GPU-bc8c14c7, GPU-112d9b26, GPU-d298c6e0\"\n</pre>\n\n<p>instead of\n\n</p><p></p><pre>    DetectedGPUs=\"CUDA0, CUDA1, CUDA2, CUDA3\"\n</pre>\n\n<p>And GPU specific attributes become\n\n</p><p></p><pre>    GPU_5498e439DevicePciBusId=\"0000:3E:00.0\"\n    GPU_5498e439DeviceUuid=\"5498e439-bec3-fa72-ed65-a45d5f53e1b5\"\n    GPU_bc8c14c7DevicePciBusId=\"0000:60:00.0\"\n    GPU_bc8c14c7DeviceUuid=\"bc8c14c7-ad51-371f-de8e-36ae559b39ed\"\n</pre>\n\n<p>instead of\n\n</p><p></p><pre>    CUDA0DevicePciBusId=\"0000:3E:00.0\"\n    CUDA0DeviceUuid=\"5498e439-bec3-fa72-ed65-a45d5f53e1b5\"\n    CUDA1DevicePciBusId=\"0000:60:00.0\"\n    CUDA1DeviceUuid=\"bc8c14c7-ad51-371f-de8e-36ae559b39ed\"</pre>\n</blockquote>", "remarks": "<blockquote>\n</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-01 10:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7ec0c3e1e6ccb46e94b81c193a5aa6fffbaa5478\">[60042]</a></span>: docs and version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7696\" onclick=\"get_ticket_and_populate_wrapper('7696'); return false;\" title=\"GPU discovery should report stable GPU ids\">#7696</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7651\" onclick=\"get_ticket_and_populate_wrapper('7651'); return false;\" title=\"OFFLINE_MACHINE_RESOURCE_&lt;tag&gt; should work on reconfig for d-slots\">#7651</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jun-19 17:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5d8b8a661ea36606c4d924ec992a95bf0fb4d293\">[59935]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7696\" onclick=\"get_ticket_and_populate_wrapper('7696'); return false;\" title=\"GPU discovery should report stable GPU ids\">#7696</a></span>, add -uuid and -short-uuid options to condor_gpu_discovery. these options report stable ids for the gpus. change condor_gpu_utilization to work with either CUDA&lt;N&gt; indices, or stable GPU ids change metaknob and startd environment config of CUDA_VISIBLE_DEVICES to work with stable GPU ids fix\u00a0[...]\n (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Jul-01 10:28", "status": "resolved", "created": "2020-Jun-19 14:26", "fixed_version": "2020-Jun-19 14:26", "broken_version": "", "priority": "1", "subsystem": "DaemonsExecNode", "assigned_to": "johnkn", "derived_from": "", "creator": "johnkn", "rust": "", "customer_group": "other", "visibility": "public", "notify": "", "due_date": ""}