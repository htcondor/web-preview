{"id": 1602, "title": "Ticket #1602: shadow exception due to failed checkpoint should contain hostname", "description": "<blockquote>\nThis is destined for the <strong>V7_4-branch</strong>\n\n<p>Quoth a CHTC admin:\n\n</p><p></p><div class=\"verbatim\">\n<pre>I need a small change to the output in the condor log when a shadow exception\noccurs due to a ckpt store fail. I just want to know what the hostname was of\nthe failed store.\n\nThis is what I see currently:\n\n\n000 (1433617.000.000) 08/24 02:18:15 Job submitted from host:\n&lt;128.104.55.9:51854&gt;\n...\n001 (1433617.000.000) 08/24 02:24:47 Job executing on host:\n&lt;128.104.58.44:41541&gt;\n...\n006 (1433617.000.000) 08/24 04:14:51 Image size of job updated: 167252\n...\n007 (1433617.000.000) 08/24 05:40:30 Shadow exception!\n        ckpt server store failed\n        68542520  -  Run Bytes Sent By Job\n        5096905  -  Run Bytes Received By Job\n...\n001 (1433617.000.000) 08/24 05:42:17 Job executing on host:\n&lt;128.104.58.15:58343&gt;\n...\n006 (1433617.000.000) 08/24 07:42:21 Image size of job updated: 167248\n...\n007 (1433617.000.000) 08/24 09:07:48 Shadow exception!\n        ckpt server store failed\n        91463352  -  Run Bytes Sent By Job\n        6109579  -  Run Bytes Received By Job\n...\n001 (1433617.000.000) 08/24 09:07:56 Job executing on host:\n&lt;128.104.58.15:58343&gt;\n\nThis is what I'd like:\n\n000 (1433617.000.000) 08/24 02:18:15 Job submitted from host:\n&lt;128.104.55.9:51854&gt;\n...\n001 (1433617.000.000) 08/24 02:24:47 Job executing on host:\n&lt;128.104.58.44:41541&gt;\n...\n006 (1433617.000.000) 08/24 04:14:51 Image size of job updated: 167252\n...\n007 (1433617.000.000) 08/24 05:40:30 Shadow exception!\n        ckpt server store to 123.456.789.0 failed\n        68542520  -  Run Bytes Sent By Job\n        5096905  -  Run Bytes Received By Job\n...\n001 (1433617.000.000) 08/24 05:42:17 Job executing on host:\n&lt;128.104.58.15:58343&gt;\n...\n006 (1433617.000.000) 08/24 07:42:21 Image size of job updated: 167248\n...\n007 (1433617.000.000) 08/24 09:07:48 Shadow exception!\n        ckpt server store to 123.456.789.1 failed\n        91463352  -  Run Bytes Sent By Job\n        6109579  -  Run Bytes Received By Job\n...\n001 (1433617.000.000) 08/24 09:07:56 Job executing on host:\n&lt;128.104.58.15:58343&gt;\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2010-Aug-24 13:51:57 by psilord:</em> <br/>\n\nIn the function <code>pseudo_put_file_stream()</code> in <code>condor_shadow.std/pseudo_ops.cpp</code>, there are <code>EXCEPT</code> calls like:\n<div class=\"code\">\n<pre class=\"code\">EXCEPT(\"ckpt server store failed\");\n</pre></div>\n\n\n<p>and\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">EXCEPT(\"ckpt server restore failed\");\n</pre></div>\n\n\n<p>Make those also have the ip address of the server in them which are known in the code surrounding them. Then it should end up in the shadow exception event in the user log.\n\n</p><p></p><hr/>\n<em>2010-Sep-02 13:19:05 by psilord:</em> <br/>\n\nAlso, Josh, when you finish this ticket MUST be code reviewed by me. Anything going into a stable series must get a code review.\n\n<p></p><hr/>\n<em>2010-Sep-02 13:56:22 by psilord:</em> <br/>\n\nNotice that when debugging this and testing it, you'll have to wait for a full hour to have the problem happen due to a hard coded constant in the shadow code used near the EXCEPTS. If you fix this to a smaller constant for testing, please don't check it in that way! :)\n\n<p></p><hr/>\n<em>2010-Sep-15 16:21:18 by psilord:</em> <br/>\n\nWhat's the status on this ticket? Stuck, need review, still working on it?\n\n<p></p><hr/>\n<em>2010-Sep-15 17:17:05 by slauson:</em> <br/>\n\nI think I've got it implemented correctly now, so it just needs a review.\n\n<p></p><hr/>\n<em>2010-Sep-16 10:51:46 by psilord:</em> <br/>\n\nCan you append the patch to the ticket so I can see it?\n\n<p></p><hr/>\n<em>2010-Sep-16 12:22:54 by slauson:</em> <br/>\n\n<div class=\"verbatim\">\n<pre>diff --git a/src/condor_shadow.std/pseudo_ops.cpp b/src/condor_shadow.std/pseudo_ops.cpp\nindex c1be2f0..81583aa 100644\n--- a/src/condor_shadow.std/pseudo_ops.cpp\n+++ b/src/condor_shadow.std/pseudo_ops.cpp\n@@ -727,7 +727,10 @@ pseudo_get_file_stream(\n                sleep(retry_wait);\n                retry_wait *= 2;\n                if (retry_wait &gt; MaxRetryWait) {\n-                   EXCEPT(\"ckpt server restore failed\");\n+                   char buf[256];\n+                   snprintf(buf, 255, inet_ntoa(*(struct in_addr*)ip_addr));\n+                   buf[256] = 0;\n+                   EXCEPT(\"ckpt server restore to %s failed\", buf);\n                }\n            }\n        } while (rval);\n@@ -854,7 +857,10 @@ pseudo_put_file_stream(\n                sleep(retry_wait);\n                retry_wait *= 2;\n                if (retry_wait &gt; MaxRetryWait) {\n-                   EXCEPT(\"ckpt server store failed\");\n+                   char buf[256];\n+                   snprintf(buf, 255, inet_ntoa(*(struct in_addr*)ip_addr));\n+                   buf[256] = 0;\n+                   EXCEPT(\"ckpt server store to %s failed\", buf);\n                }\n            }\n        } while (rval);\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Sep-16 13:02:14 by psilord:</em> <br/>\n\nChange the snprintf et al. codepath to use <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MyString\" title=\"My String\">MyString</a></span>, and please ensure that inet_ntoa() actually produces the correct ip-address (like it isn't reversed). I forget if ip_addr is in network byte order there or not.\n\n<p></p><hr/>\n<em>2010-Sep-20 18:04:45 by slauson:</em> <br/>\n\nI made the changes you suggested. I found that ip_addr in in host byte order, so it will have to be converted. I think that htonl should work for this.\n\n<p>I'm stuck at properly testing this conversion though. I was doing testing on a temporary unsigned int and not the actual ip_addr variable. ip_addr is only set when <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastCkptServer\" title=\"Last Ckpt Server\">LastCkptServer</a></span> is defined. I guess I don't quite understand the case when <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastCkptServer\" title=\"Last Ckpt Server\">LastCkptServer</a></span> is not NULL. The source code says that it is not NULL when the last checkpoint file was stored on the checkpoint server.\n\n</p><p></p><hr/>\n<em>2010-Sep-23 10:59:04 by slauson:</em> <br/>\n\n<div class=\"verbatim\">\n<pre>diff --git a/src/condor_shadow.std/pseudo_ops.cpp b/src/condor_shadow.std/pseudo_ops.cpp\nindex c1be2f0..7fe90af 100644\n--- a/src/condor_shadow.std/pseudo_ops.cpp\n+++ b/src/condor_shadow.std/pseudo_ops.cpp\n@@ -727,7 +727,10 @@ pseudo_get_file_stream(\n                sleep(retry_wait);\n                retry_wait *= 2;\n                if (retry_wait &gt; MaxRetryWait) {\n-                   EXCEPT(\"ckpt server restore failed\");\n+                   struct in_addr taddr;\n+                   taddr.s_addr = *ip_addr;\n+                   MyString buf(inet_ntoa(taddr));\n+                   EXCEPT(\"ckpt server restore to %s failed\", buf.Value());\n                }\n            }\n        } while (rval);\n@@ -854,7 +857,10 @@ pseudo_put_file_stream(\n                sleep(retry_wait);\n                retry_wait *= 2;\n                if (retry_wait &gt; MaxRetryWait) {\n-                   EXCEPT(\"ckpt server store failed\");\n+                   struct in_addr taddr;\n+                   taddr.s_addr = *ip_addr;\n+                   MyString buf(inet_ntoa(taddr));\n+                   EXCEPT(\"ckpt server store to %s failed\", buf.Value());\n                }\n            }\n        } while (rval);\n</pre></div>\n\n\n<p></p><hr/>\n<em>2010-Sep-23 11:12:56 by psilord:</em> <br/>\n\nI verified that RestoreRequest() (where ip_addr is gotten) will return it in network byte order.\n\n<p>Thus, I am satisfied with this patch. Check it into V7_4-branch, merge to master, document in the V7_4-branch in the CONDOR_DOC repo. Push everything.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-23 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/09ebd01ffa9858cce15bfb40c099d7ccfcd82e0e\">[19036]</a></span>: Added hostname to exception message when a checkpoint fails. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1602\" onclick=\"get_ticket_and_populate_wrapper('1602'); return false;\" title=\"shadow exception due to failed checkpoint should contain hostname\">#1602</a></span> Committer: Peter Keller  (By Josh Slauson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-23 11:44</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9658bbb75ce2f2ce1af6ba7af4d6128b3e59e972\">[19032]</a></span>: Added ip address to exception message when a checkpoint fails. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1602\" onclick=\"get_ticket_and_populate_wrapper('1602'); return false;\" title=\"shadow exception due to failed checkpoint should contain hostname\">#1602</a></span>  (By Josh Slauson )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2010-Sep-23 11:51", "status": "resolved", "created": "2010-Aug-24 10:19", "fixed_version": "2010-Aug-24 10:19", "broken_version": "v070000", "priority": "4", "subsystem": "Std", "assigned_to": "slauson", "derived_from": "", "creator": "psilord", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "psilord@cs.wisc.edu mick@cs.wisc.edu slauson@cs.wisc.edu", "due_date": ""}