{"id": 1031, "title": "Ticket #1031: condor_kbdd is unable to write to the log file and excepting", "description": "<blockquote>\nAll of the daemons currently write to the log folder in C:\\condor, which actually requires elevated privileges to do as that location does not belong to a regular user account.  Since condor_kbdd is a daemon, it tries to do the same.  Unfortunately, since it's starting up as a regular user account, this means the daemon core code will actually except from what I've seen because it can't access the file in that directory.  Thus idle checking on Vista and higher is broken again.  It's actually also broken on XP, but there's a quickie fix that involves having master start up condor_kbdd, which will get Condor back to doing the same incorrect thing it does previously, but it's better than nothing.\n\n<p>Current fix involves redirecting the kbdd log location to the temp directory.  The attempt to do this with environment variables failed and is described in ticket <span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1120\" onclick=\"get_ticket_and_populate_wrapper('1120'); return false;\" title=\"Environment variable not overriding value in config file\">#1120</a></span>.  A way around the issue would be to get the path to the temp directory and pass it dc_main as an argument, thereby forcefully setting the path we want the kbdd to use.</p></blockquote>", "remarks": "<blockquote>\n<em>2009-Dec-09 10:18:24 by matt:</em> <br/>\n\nWhy is it bad to have the kbdd run by the master. That's the architecture.\n\n<p>It is a dangerous decision to work around the issue by disabling logging.\n\n</p><p></p><hr/>\n<em>2009-Dec-09 18:18:43 by ziliang:</em> <br/>\n\nNot on Windows.  On Windows, the kbdd is run under regular user accounts and are auto-started at logon.  This is due to the segregation of services and logged on accounts that MS started more strictly enforcing.  The functions used to detect keyboard activity will not work if they're used from master or anything else started by the condor service that isn't injected into another user's context.  Even if they're injected, they're now running under that user's security context, so they still can't write to the logs.  Short of elevating and running condor_kbdd with administrative privileges, which quite frankly isn't good practice, we need to either route the log writing to the user's temporary file or disable the logging.\n\n<p></p><hr/>\n<em>2009-Dec-10 23:31:23 by zmiller:</em> <br/>\n\nwe definitely don't want to throw away the log, so keeping it in a user-writable tmp dir seems like the better bet.\n\n<p>Z and i discussed this for a while today, and he's going to update this ticket with the new planned implementation (for v070402).\n\n</p><p></p><hr/>\n<em>2009-Dec-11 10:37:35 by matt:</em> <br/>\n\nSounds good. That's the model the gridmanager used to take.\n\n<p></p><hr/>\n<em>2010-Mar-04 07:56:47 by tstclair:</em> <br/>\n\nI personally think many of the previous assertions require further explanation.  What are the functions which fail in a service env to detect keyboard activity, why is this a problem?\n\n<p>How come there are umpteen keyboard loggers and corporate-spybots which run as services and can detect keyboard activity across user sessions...?\n</p><hr/>\n<em>2010-Aug-23 17:07:50 by adesmet:</em> <br/>\n\nBulk change of target version from v070402 to v070404 using ./ticket_target_mover.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1033\" onclick=\"get_ticket_and_populate_wrapper('1033'); return false;\" title=\"Quickfix to have the master run kbdd on Windows on an execute node\">#1033</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nQuickfix to have the master run kbdd on Windows on an execute node</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=1120\" onclick=\"get_ticket_and_populate_wrapper('1120'); return false;\" title=\"Environment variable not overriding value in config file\">#1120</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nEnvironment variable not overriding value in config file</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body><blockquote>\n<ul>\n<li><a href=\"../files/223/tj1031.v1.diff\">tj1031.v1.diff</a>\n4618 bytes added by johnkn on 2010-Sep-21 19:32:13 UTC.\n<br/>\nproposed fix. dprintf_config sets a global variable when in KBDD, this variable changes open_debug_file to return NULL rather than exiting, then dprintf_config sets the log file to /dev/nul (NUL in windows). changes mostly inside ifdef WIN32 blocks. \nWhen daemon_core_main tests the log directory to see if it could create a core dump there, KBDD will continue if unable to write to the log directory.<br/>\n</li><li><a href=\"../files/224/tj1031.v2.diff\">tj1031.v2.diff</a>\n5620 bytes added by johnkn on 2010-Sep-21 22:13:36 UTC.\n<br/>\nrefinement to proposed fix. add a function to dprintf_config.c that allows the KBDD to request the continue on failure behavior, removed the special case for KBDD from the dprintf_config function. <br/>\n</li></ul>\n</blockquote></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-23 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b1ee2299350bc7f4dfdcc0a5d1c16ab12d9a1d0c\">[19040]</a></span>: On Win32 allow the kbdd to keep running even if it cannot write to the log directory. added a flag to dprintf that controls this behavior and a call in kbdd to turn it on. (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1031\" onclick=\"get_ticket_and_populate_wrapper('1031'); return false;\" title=\"condor_kbdd is unable to write to the log file and excepting\">#1031</a></span>);  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Oct-05 15:38", "status": "resolved", "created": "2009-Dec-08 22:36", "fixed_version": "2009-Dec-08 22:36", "broken_version": "v070400", "priority": "3", "subsystem": "Win32", "assigned_to": "cweiss", "derived_from": "#714", "creator": "ziliang", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tannenba@cs.wisc.edu matt@cs.wisc.edu tstclair@redhat.com", "due_date": "20100201"}