{"id": 4440, "title": "Ticket #4440: cream_gahp fails at startup due to lt_dlopen() search path", "description": "<blockquote>\nWhen the Globus threading model is set to something other than \"none\", Globus uses lt_dlopen() to load a Globus library with relevant functions. In the cream_gahp, we set the threading model to \"pthread\" because we use Globus and OpenSSL functions in multiple threads and need the proper synchronization.\n\n<p>Unlike the system dlopen() on linux, lt_dlopen() ignores the program's RPATH when searching the requested library. Therefore, it won't find the Globus libraries that we include with the UW release of HTCondor. Thus, the cream_gahp fails at startup with an error like this: <code>dlopen libglobus_thread_pthread: file not found</code>\n\n</p><p>There are a couple workarounds for this problem:\n</p><ul>\n<li>Install native Globus packages. lt_dlopen() will then find the library in the standard system location.\n</li><li>Set LD_LIBRARY_PATH to \"$ORIGIN/../lib/condor\".\n</li></ul>\n\n<p>One way to fix this is to use dlopen() to load the library at the top of main(), before Globus's call to lt_dlopen().\n\n</p><p>Setting LD_LIBRARY_PATH in the environment at the top of main() does not work. The ltdl library is probably checking the environment variables when it's loaded, before main().</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-02 16:54:08 by tlmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Approved.  Two notes:\n\n</p><p></p><pre>  # the hard-coded library name is OK because the CREAM gahp only runs on Linux\n  # we don't need to dlclose() the handle after calling the globus initializers because the CREAM gahp never closes/unloads Globus.</pre>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4464\" onclick=\"get_ticket_and_populate_wrapper('4464'); return false;\" title=\"Setting GLOBUS_THREAD_MODEL causes GSI failures\">#4464</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nSetting GLOBUS_THREAD_MODEL causes GSI failures</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"abandoned\" href=\"/wiki-archive/tickets/?ticket=4673\" onclick=\"get_ticket_and_populate_wrapper('4673'); return false;\" title=\"cream_gahp should dlopen versioned library filename\">#4673</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncream_gahp should dlopen versioned library filename</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4865\" onclick=\"get_ticket_and_populate_wrapper('4865'); return false;\" title=\"cream_gahp fails at startup due to native package Globus\">#4865</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncream_gahp fails at startup due to native package Globus</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-17 10:49</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4e6c7ec9406a678a723607629687fbc1a5b8089f\">[40691]</a></span>: super minor edits to version history items for 2 tickets: <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4416\" onclick=\"get_ticket_and_populate_wrapper('4416'); return false;\" title=\"Cream gahp may allocate insufficient memory for threads\">#4416</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4440\" onclick=\"get_ticket_and_populate_wrapper('4440'); return false;\" title=\"cream_gahp fails at startup due to lt_dlopen() search path\">#4440</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-15 15:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1340a89ad18193c519d059ec7652f83a72a2266d\">[40660]</a></span>: Docs for cream_gahp bug fixes. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4416\" onclick=\"get_ticket_and_populate_wrapper('4416'); return false;\" title=\"Cream gahp may allocate insufficient memory for threads\">#4416</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4440\" onclick=\"get_ticket_and_populate_wrapper('4440'); return false;\" title=\"cream_gahp fails at startup due to lt_dlopen() search path\">#4440</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-02 16:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/97adcaec7f6e42fd09b67aba066f8c3de4de202f\">[40534]</a></span>: cream_gahp fails at startup due to lt_dlopen() search path. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4440\" onclick=\"get_ticket_and_populate_wrapper('4440'); return false;\" title=\"cream_gahp fails at startup due to lt_dlopen() search path\">#4440</a></span> Globus uses lt_dlopen() to load its thread library, globus_thread_pthread. This function appears to ignore the program's RPATH, so it doesn't find the copy of the library that we include in UW builds of Condor. We can work around this\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jul-15 15:44", "status": "resolved", "created": "2014-Jul-02 16:05", "fixed_version": "2014-Jul-02 16:05", "broken_version": "v080200", "priority": "1", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "#4406", "creator": "jfrey", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "", "due_date": ""}