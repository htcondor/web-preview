{"id": 3617, "title": "Ticket #3617: Gathering pid list on mac os x and bsd can cause crashes", "description": "<blockquote>\nOn Mac OS X and BSD, the procapi code uses sysctl() to get a list of all processes on the system. In ProcAPI::buildPidList(), it calls sysctl() with a NULL pointer to determine how much space is required to hold the information, allocates a buffer of that size, then calls sysctl() again with that buffer. If either call fails, buildPidList() returns failure and leaves the ProcAPI::pidList linked list containing one entry with uninitialized data. The callers ignore the return value and always assume pidList contains all pids on the system. Depending on the uninitialized contents of pidList, this can cause ProcAPI to crash or to think only one random pid is left on the system. This can cause the behavior seen in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2537\" onclick=\"get_ticket_and_populate_wrapper('2537'); return false;\" title=\"Procd / Master crash on MacOS in batlabs\">#2537</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3549\" onclick=\"get_ticket_and_populate_wrapper('3549'); return false;\" title=\"Leaked job processes on MacOS in Batlab\">#3549</a></span>.\n\n<p>The first call to sysctl() returns a size that's a little larger than required, to account for new processes showing up between calls. But if enough new processes are born in that short time, the buffer may be too small when sysctl() is called the second time. If this happens, it will return ENOMEM and a new buffer size estimate.\n\n</p><p>By making the following changes, we can make this code more robust and easier to debug on failure:\n</p><ul>\n<li>On ENOMEM failures, retry sysctl() several times, increasing the buffer size appropriately\n</li><li>If sysctl() still fails after retries, log the error\n</li><li>When buildPidList() returns failure, always leave pidList as an empty list.\n</li><li>Callers to buildPidList() should be prepared for it to fail, either checking the return value or otherwise reacting appropriately to an empty pidList.</li></ul>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-May-22 16:38:29 by zmiller:</em> <br/>\n\n<strong>CODE REVIEW</strong> looks good.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3725\" onclick=\"get_ticket_and_populate_wrapper('3725'); return false;\" title=\"Really fix gathering pid list on mac os x\">#3725</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nReally fix gathering pid list on mac os x</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-28 13:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7fcc301e70e016494cc2fa290fd1377da36e674a\">[35893]</a></span>: very minor version history item change to add spaces in 'OS X'. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3617\" onclick=\"get_ticket_and_populate_wrapper('3617'); return false;\" title=\"Gathering pid list on mac os x and bsd can cause crashes\">#3617</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-23 13:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/65d3d5601e8f20b19e37af66075dadada6a3404f\">[35842]</a></span>: Version history for Mac procd fixes. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3617\" onclick=\"get_ticket_and_populate_wrapper('3617'); return false;\" title=\"Gathering pid list on mac os x and bsd can cause crashes\">#3617</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3618\" onclick=\"get_ticket_and_populate_wrapper('3618'); return false;\" title=\"Procd failures can lead to fork-bomb of the system\">#3618</a></span> <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3620\" onclick=\"get_ticket_and_populate_wrapper('3620'); return false;\" title=\"LOCK directory in /tmp shouldn't include HOSTNAME\">#3620</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-May-13 16:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8f721271c2932d61d2dc2d239a905936d497b400\">[35694]</a></span>: Fix ProcAPI::buildPidList() on mac os x and bsd. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3617\" onclick=\"get_ticket_and_populate_wrapper('3617'); return false;\" title=\"Gathering pid list on mac os x and bsd can cause crashes\">#3617</a></span> When retrieving the full list of pids on the system, be more resilient to recoverable errors and don't return junk on failure. * Retry sysctl() several times on ENOMEM failures. * Don't return unitialized data when returning with failure. * Improve\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2013-May-23 13:44", "status": "resolved", "created": "2013-May-13 14:36", "fixed_version": "2013-May-13 14:36", "broken_version": "v070900", "priority": "2", "subsystem": "Libs", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "batlab", "visibility": "public", "notify": "zmiller@cs.wisc.edu", "due_date": ""}