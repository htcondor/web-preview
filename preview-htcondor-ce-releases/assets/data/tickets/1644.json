{"id": 1644, "title": "Ticket #1644: machine invalidation ads match ads from all machines", "description": "<blockquote>\nI now understand what is causing the CMS glideinWMS machine ads to get invalidated unexpectedly.  The collector is 7.4.  The startds are a mix of 7.4 and 7.5.\n\n<p>The problem is that the collector is receiving ads from 7.5 startds, which insert some extra attributes into the invalidation request.  Those extra attributes are used by the 7.5 collector to do the invalidation more efficiently (hash-table lookup rather than query evaluation).  The 7.4 collector does the old inefficient method of evaluating a query against all ads to see which ads to invalidate.  It is supposed to ignore the extra attributes.  Unfortunately, the extra attributes unintentionally change the meaning of the query so that it matches all ads!\n\n</p><p>Observe:\n\n</p><p></p><div class=\"verbatim\">\n<pre>09/06 14:48:00 Got INVALIDATE_STARTD_ADS\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_2180@node200 , 172.16.1.200 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_32077@node156 , 172.16.1.156 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_19637@sbgwn91.in2p3.fr , 193.48.85.141 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_29548@farm012.ts.infn.it , 140.105.222.82 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_5254@wn-a3-09.brunel.ac.uk , 172.30.1.151 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_9936@wn-b1-06.brunel.ac.uk , 172.30.1.183 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_23569@polgrid130.in2p3.fr , 134.158.132.30 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_30735@grid-wn0849.desy.de , 131.169.162.192 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_16706@cabinet-4-4-13.t2.ucsd.edu , 169.228.131.93 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_17988@cabinet-3-3-0.t2.ucsd.edu , 169.228.131.143 &gt;\"\n09/06 14:48:00          **** Removing invalidated ad: \"&lt; glidein_14761@cabinet-7-7-31.t2.ucsd.edu , 169.228.130.187 &gt;\"\n09/06 14:48:00 (Invalidated 11 ads)\n09/06 14:48:00 The invalidation query was this:\nMyType = \"Query\"\nTargetType = \"Machine\"\nUpdateSequenceNumber = 0\nName = \"glidein_15000@wn182.lcg.cscs.ch\"\nRequirements = (Name == \"glidein_15000@wn182.lcg.cscs.ch\")\nDaemonStartTime = 1283808198\nMyAddress = \"&lt;148.187.66.182:45970?CCBID=169.228.130.23:9677#751&gt;\"\n</pre></div>\n\n\n<p>See how the Requirements refers to Name?  That is intended to refer to the Name attribute in the machine ad, but instead it refers to the Name attribute in the invalidation query!\n\n</p><p><span class=\"subsection\"></span></p><h3>How to Fix</h3>\n\n<p>The startd needs to be fixed to specify target scope explicitly in the query.  However, there is still the problem of what to do about 7.5.3 startds that generate the dangerous invalidation queries.  Perhaps if attributes for generating a hash key are present, we should never evaluate the query, even if no ad is found with a matching hash key.  Then the question is whether the 7.4 collector needs to be patched as well.  I'm waiting to hear whether CMS is willing to upgrade to a 7.5 collector or not.</p></blockquote>", "remarks": "<blockquote>\n<em>2010-Sep-07 16:00:11 by danb:</em> <br/>\n\nIt turns out that <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1579\" onclick=\"get_ticket_and_populate_wrapper('1579'); return false;\" title=\"Fix collector query expressions\">#1579</a></span> intentionally removed explicit TARGET scoping in the invalidation queries and made the 7.5 collector force TARGET scope when evaluating such queries.  So it was really a combination of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1579\" onclick=\"get_ticket_and_populate_wrapper('1579'); return false;\" title=\"Fix collector query expressions\">#1579</a></span> and <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1316\" onclick=\"get_ticket_and_populate_wrapper('1316'); return false;\" title=\"Dyanamic Slot INVALIDATE_STARTD_ADS causes collector pegging\">#1316</a></span> that caused the compatibility problem with 7.4.\n\n<p>After discussing with Jaime, we agreed that TARGET scope should be added back to the invalidation queries.  The longer-term goal of getting rid of TARGET rewriting can still be achieved by getting rid of the invalidation query altogether.  Instead, we should always send enough information to build a hash key for the ad to be invalidated.  It may be useful for admins to have a way to invalidate multiple ads via a constraint, but this should probably just be a separate command (maybe ADMINISTRATOR-level).\n\n</p><p></p><hr/>\n<em>2010-Sep-07 17:27:39 by danb:</em> <br/>\n\nI have created patches for 7.5 that address the problem.  Also, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1342\" onclick=\"get_ticket_and_populate_wrapper('1342'); return false;\" title=\"Update INVALIDATE_*_ADS to pass Name and MyAddress for O(1) invalidate\">#1342</a></span> has been resolved so that we can eventually phase out the use an invalidation query expression by Condor daemons.  I am closing this ticket.  If it turns out that somebody has a pressing need for a 7.4 patch, we will have to revisit the issue.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1634\" onclick=\"get_ticket_and_populate_wrapper('1634'); return false;\" title=\"unexplained mass invalidation of ads in collector\">#1634</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nunexplained mass invalidation of ads in collector</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-07 17:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/174db658214e2e4014847127655e9f5ed42a7d8a\">[25663]</a></span>: Documented fix for startd and master ad invalidation. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1644\" onclick=\"get_ticket_and_populate_wrapper('1644'); return false;\" title=\"machine invalidation ads match ads from all machines\">#1644</a></span>  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-07 17:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/75f7243f07ddba56f904f0560fb1c156ed21238a\">[18942]</a></span>: If a hash key is specified in an invalidation command, ignore the requirements. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1644\" onclick=\"get_ticket_and_populate_wrapper('1644'); return false;\" title=\"machine invalidation ads match ads from all machines\">#1644</a></span> This avoids expensive query evaluation when receiving an invalidation request for a specific ad that has already been removed (e.g. because it was stale).  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2010-Sep-07 17:05</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/22e5e2a851fa27ff5e77b34571eb4eb71a0f9f26\">[18941]</a></span>: Specify TARGET scope in invalidation query. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=1644\" onclick=\"get_ticket_and_populate_wrapper('1644'); return false;\" title=\"machine invalidation ads match ads from all machines\">#1644</a></span> This prevents us from accidentally referring to attributes of the query ad rather than attributes of the ad to be invalidated when talking to collectors older than 7.5.2.  (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Sep-08 09:40", "status": "resolved", "created": "2010-Sep-07 12:41", "fixed_version": "2010-Sep-07 12:41", "broken_version": "v070503", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "#1316", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "dan@hep.wisc.edu tannenba@cs.wisc.edu tstclair@redhat.com sfiligoi@fnal.gov matt@cs.wisc.edu", "due_date": ""}