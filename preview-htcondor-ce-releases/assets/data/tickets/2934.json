{"id": 2934, "title": "Ticket #2934: Add line number info to log output of job que parse failures", "description": "<blockquote>\nIf the job queue log becomes corrupt such as might occur in a bad HA failover,\nthe log will not be parsed. You might see errors like this in the schedd log:\n\n<p></p><div class=\"code\">\n<pre class=\"code\">01/21/12 08:18:12 (pid:16854) ERROR \"Error: bad record with op=103 in corrupt\nlogfile\" at line 1060 in file\n/builddir/build/BUILD/condor-7.6.1/src/condor_utils/classad_log.cpp</pre></div>\n\n\n<p>It would be useful to have the actual line number or the line that has the\nproblem also put in the log in order to help recover.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-Apr-12 17:18:46 by eje:</em> <br/>\n\nA note on testing for parsing failures/corruption in classad log files.  Certain kinds of corruption are not currently detectable.  For example, the 'key' field (the 2nd field) is somewhat arbitrary, and so a corruption that only alters a key will not be detected.  Similarly, a corruption that only alters an attribute name will not be detected.\n\n<p>Any corruption that results in parse failure for a RHS classad expression (log op-code 103: set-attribute) is detectable.  Any corruption that causes a failure to read the op-code (1st field), such as insertion or deletion of a token on a previous record line, will be detected.\n\n</p><p></p><hr/>\n<em>2012-Apr-12 17:45:07 by eje:</em> <br/>\n\nTESTING:\n\n<p>No special configuration or job submission is required to test the new feature.  It is sufficient to start up the pool with a schedd and check the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> output to verify that errors are being detected and the location of error is being output.\n\n</p><p>There are two corruption scenarios.  The first is when a log record is corrupted inside a complete transaction (ocurring before an end-of-transaction record, code 106).  Parse errors inside a complete transaction result in a fatal exception.  the second scenario is when an error is detected in an incomplete transaction at the end of the log.  In this case, the last transaction is ignored and only a warning is logged.\n\n</p><p>Some testing job_queue.log files are shown below, with different errors.  To test an error, halt the condor pool, copy the test file into path/to/job_queue.log, and restart:\n\n</p><p>NOTE: when copying the test job_queue.log files below, you need to make sure you have a space after all type codes, for example \"105 \" and not just \"105\", because the classad log parser is picky about that.  Gittrac is removing my trailing spacees, so you may need to insert them after \"105\" and \"106\"\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ condor_master ; tail -f SchedLog</pre></div>\n\n\n<p>First testing file, has a classad-expr syntax error in record 5:\n</p><div class=\"code\">\n<pre class=\"code\">107 1 CreationTimestamp 1334245749\n101 0.0 Job Machine\n103 0.0 NextClusterNum 1\n105\n103 1.0 JobStatus 2  ZOMG!\n103 1.0 EnteredCurrentStatus 1334245771\n103 1.0 LastSuspensionTime 0\n103 1.0 CurrentHosts 1\n106\n105\n103 1.1 LastJobStatus 1\n103 1.1 JobStatus 2\n</pre></div>\n\n\n<p>When you copy this file to path/to/job_queue.log, and restart, you should see the following in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span>:\n</p><div class=\"code\">\n<pre class=\"code\">04/12/12 15:28:23 WARNING: Encountered corrupt log record 5 (byte offset 89)\n04/12/12 15:28:23 Lines following corrupt log record 5 (up to 3):\n04/12/12 15:28:23     103 1.0 EnteredCurrentStatus 1334245771\n04/12/12 15:28:23     103 1.0 LastSuspensionTime 0\n04/12/12 15:28:23     103 1.0 CurrentHosts 1\n04/12/12 15:28:23 ERROR \"Error: corrupt log record 5 (byte offset 89) occurred inside closed transaction, recovery failed\" at line 1136 in file /home/eje/git/grid/src/condor_utils/classad_log.cpp\n</pre></div>\n\n\n<p>The 2nd test log has a bad op-code in record 5:\n</p><div class=\"code\">\n<pre class=\"code\">107 1 CreationTimestamp 1334245749\n101 0.0 Job Machine\n103 0.0 NextClusterNum 1\n105\nZMG 1.0 JobStatus 2\n103 1.0 EnteredCurrentStatus 1334245771\n103 1.0 LastSuspensionTime 0\n103 1.0 CurrentHosts 1\n106\n105\n103 1.1 LastJobStatus 1\n103 1.1 JobStatus 2\n</pre></div>\n\n\n<p>When the pool starts up with this log file, you should see the following output (similar to above)\n</p><div class=\"code\">\n<pre class=\"code\">04/12/12 15:30:35 WARNING: Encountered corrupt log record 5 (byte offset 89)\n04/12/12 15:30:35 Lines following corrupt log record 5 (up to 3):\n04/12/12 15:30:35     103 1.0 EnteredCurrentStatus 1334245771\n04/12/12 15:30:35     103 1.0 LastSuspensionTime 0\n04/12/12 15:30:35     103 1.0 CurrentHosts 1\n04/12/12 15:30:35 ERROR \"Error: corrupt log record 5 (byte offset 89) occurred inside closed transaction, recovery failed\" at line 1136 in file /home/eje/git/grid/src/condor_utils/classad_log.cpp\n</pre></div>\n\n\n<p>The 3rd test log file has an integer op-code, but not a recognized code, in record 5:\n</p><div class=\"code\">\n<pre class=\"code\">107 1 CreationTimestamp 1334245749\n101 0.0 Job Machine\n103 0.0 NextClusterNum 1\n105\n142 1.0 JobStatus 2\n103 1.0 EnteredCurrentStatus 1334245771\n103 1.0 LastSuspensionTime 0\n103 1.0 CurrentHosts 1\n106\n105\n103 1.1 LastJobStatus 1\n103 1.1 JobStatus 2\n</pre></div>\n\n\n<p>Again, the output of the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> should be similar:\n</p><div class=\"code\">\n<pre class=\"code\">04/12/12 15:33:35 WARNING: Encountered corrupt log record 5 (byte offset 89)\n04/12/12 15:33:35 Lines following corrupt log record 5 (up to 3):\n04/12/12 15:33:35     103 1.0 EnteredCurrentStatus 1334245771\n04/12/12 15:33:35     103 1.0 LastSuspensionTime 0\n04/12/12 15:33:35     103 1.0 CurrentHosts 1\n04/12/12 15:33:35 ERROR \"Error: corrupt log record 5 (byte offset 89) occurred inside closed transaction, recovery failed\" at line 1136 in file /home/eje/git/grid/src/condor_utils/classad_log.cpp\n</pre></div>\n\n\n<p>The 4th test file shows a missing expression, that corrupts parsing across two record lines:\n</p><div class=\"code\">\n<pre class=\"code\">107 1 CreationTimestamp 1334245749\n101 0.0 Job Machine\n103 0.0 NextClusterNum 1\n105\n103 1.0 JobStatus\n103 1.0 EnteredCurrentStatus 1334245749\n103 1.0 LastSuspensionTime 0\n103 1.0 CurrentHosts 1\n106\n105\n103 1.1 LastJobStatus 1\n103 1.1 JobStatus 2\n</pre></div>\n\n\n<p>The output from the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> should be:\n</p><div class=\"code\">\n<pre class=\"code\">04/12/12 15:37:45 WARNING: Encountered corrupt log record 5 (byte offset 89)\n04/12/12 15:37:45 Lines following corrupt log record 5 (up to 3):\n04/12/12 15:37:45     103 1.0 LastSuspensionTime 0\n04/12/12 15:37:45     103 1.0 CurrentHosts 1\n04/12/12 15:37:45     106\n04/12/12 15:37:45 ERROR \"Error: corrupt log record 5 (byte offset 89) occurred inside closed transaction, recovery failed\" at line 1136 in file /home/eje/git/grid/src/condor_utils/classad_log.cpp\n</pre></div>\n\n\n<p>The 5th test log file has an error in the final (incomplete) transaction.  This should result in a nonfatal warning:\n</p><div class=\"code\">\n<pre class=\"code\">107 1 CreationTimestamp 1334245749\n101 0.0 Job Machine\n103 0.0 NextClusterNum 1\n105\n103 1.0 JobStatus 2\n103 1.0 EnteredCurrentStatus 1334245749\n103 1.0 LastSuspensionTime 0\n103 1.0 CurrentHosts 1\n106\n105\n103 1.1 LastJobStatus 1 + eek!\n103 1.1 JobStatus 2\n</pre></div>\n\n\n<p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> output with nonfatal warning:\n</p><div class=\"code\">\n<pre class=\"code\">04/12/12 15:43:29 WARNING: Encountered corrupt log record 11 (byte offset 211)\n04/12/12 15:43:29 Lines following corrupt log record 11 (up to 3):\n04/12/12 15:43:29     103 1.1 JobStatus 2\n04/12/12 15:43:29 Detected unterminated log entry in ClassAd Log /home/eje/condor/local/spool/job_queue.log. Forcing rotation.\n</pre></div>\n</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=3069\" onclick=\"get_ticket_and_populate_wrapper('3069'); return false;\" title=\"RFE: config setting to enable/disable strict classad log exprs\">#3069</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nRFE: config setting to enable/disable strict classad log exprs</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Jul-11 12:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/55e49836b160d49e1428c7c217e1391dd53a5fab\">[32705]</a></span>: Improved wording on version history item ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-19 11:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3c3f0c0ffb5e0ec0f17b10cb8c3e1d76b315982b\">[31747]</a></span>: ===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-19 11:29</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dfda698f1c2b7fec8467e14f55590caa55b45f2b\">[31746]</a></span>: Added logic to report record number in record parse failures in the classad log file system, along with improved detection of parse failures ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-13 16:31</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/66c41f9c2f6b933c3592b09453dc426c6924b714\">[31667]</a></span>: Added logic to report record number in record parse failures in the classad log file system, along with improved detection of parse failures ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-13 12:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f442fa01b8be9cdbd7722a59477bb25ed3b569ee\">[31656]</a></span>: Revert \"Added logic to report record number in record parse failures in the classad log file system, along with improved detection of parse failures ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>\" This reverts commit 5b8051a8f0edeb8fdd4e053ad01f6f3c3bb4f41a.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-13 12:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/af391e1a47b851c968ef5d229025c312c70abf58\">[31655]</a></span>: Revert \"===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>\" This reverts commit 055602ae2759737e9e50221b2a31fd22befc7de8.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-12 18:37</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/055602ae2759737e9e50221b2a31fd22befc7de8\">[31654]</a></span>: ===VersionHistory:Completed=== ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>  (By Erik Erlandson )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Apr-12 18:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5b8051a8f0edeb8fdd4e053ad01f6f3c3bb4f41a\">[31653]</a></span>: Added logic to report record number in record parse failures in the classad log file system, along with improved detection of parse failures ===GT:Fixed=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2934\" onclick=\"get_ticket_and_populate_wrapper('2934'); return false;\" title=\"Add line number info to log output of job que parse failures\">#2934</a></span>  (By Erik Erlandson )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2012-May-07 16:04", "status": "resolved", "created": "2012-Apr-10 14:23", "fixed_version": "2012-Apr-10 14:23", "broken_version": "", "priority": "2", "subsystem": "Libs", "assigned_to": "gthain", "derived_from": "", "creator": "eje", "rust": "", "customer_group": "other", "visibility": "public", "notify": "eje@cs.wisc.edu, tstclair@redhat.com, jthomas@redhat.com, matt@cs.wisc.edu", "due_date": ""}