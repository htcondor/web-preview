{"id": 450, "title": "Ticket #450: deadlock errors in quill", "description": "<blockquote>\nIf quill tries to init the job queue while dbmsd is calling quill_reindextables() or (possibly) quill_purgehistory(), there is a deadlock.  Postgres was detecting the deadlock and aborting one of the transactions, but this was causing the job_quill_basic test to fail.\n\n<p>Similar errors may exist with other types of updates done by quill.  It may be the case that all such errors are recoverable, so the main problem is just when they cause real performance problems or cause the nightly test to fail.\n\n</p><p>I have observed this problem after switching quill over to using buffered i/o when reading job_queue.log.  Apparently this changed the timing of some things so that quill's initial update to the db happened at the same time as dbmsd's initial call to the mentioned PL/SQL functions.  The two platforms where I observed the problem were ppc64_sles9 and ps3_ydl_5.0.  Why only these platforms had problems is likely just a matter of how fast certain operations happened to run on these systems during the test.</p></blockquote>", "remarks": "<blockquote>\nThe deadlock problem has been addressed for the specific case that was affecting the job_quill_basic test.  I have therefore reapplied the patch to switch quill over to buffered i/o when reading the job queue.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-01 18:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/38d9e636196b365ebd575d275d3cba1b182c5c13\">[14630]</a></span>: Revert the revert of buffered i/o in quill's job queue reader. The underlying problem hit by the job_quill_basic test has been understood and fixed. It was not caused by a bug in this patch. It was caused by changes in the timing of events, which changed the result of a race condition. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=450\" onclick=\"get_ticket_and_populate_wrapper('450'); return false;\" title=\"deadlock errors in quill\">#450</a></span>\u00a0[...]\n (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2009-May-01 18:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3aee4df2e8805732023a4fc3c0acf8a83da9a96a\">[14629]</a></span>: Fixed a case of DB deadlock between dbmsd and quill when using postgres. If quill tries to init the job queue while dbmsd is calling quill_reindextables() or quill_purgehistory(), there is a deadlock. Postgres was detecting the deadlock and aborting one of the transactions, but this was causing the job_quill_basic\u00a0[...]\n (By Dan Bradley )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2010-Jan-31 13:40", "status": "resolved", "created": "2009-May-01 18:38", "fixed_version": "2009-May-01 18:38", "broken_version": "v070300", "priority": "4", "subsystem": "", "assigned_to": "danb", "derived_from": "", "creator": "danb", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "gthain@cs.wisc.edu", "due_date": ""}