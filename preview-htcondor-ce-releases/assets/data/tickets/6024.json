{"id": 6024, "title": "Ticket #6024: Update/create MPI helper scripts for parallel universe jobs", "description": "<blockquote>\nNewer versions of MPICH (2 and 3) and Open MPI have broken the helper scripts we have provided for running MPI jobs in the parallel universe. Specifically, MPICH has changed its launcher from MPD to hydra, which expects a list of machines that it can SSH into to set up the worker processes. This is similar to how Open MPI's orte launcher works. Recent versions of orte (orterun/orted) do not look in the current working directory for the user's executable (i.e. it assumes a location shared by all execute nodes), so this also must be worked around as we do not want to assume a shared filesystem in HTCondor.\n\n<p>Both hydra and orte need some updates to the sshd.sh and condor_ssh helper scripts that reside in $(LIBEXEC). sshd.sh will be updated to use SSH2, condor_ssh will be updated to be compatible with both Open MPI and MPICH jobs.</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Dec-14 16:19:22 by jpatton:</em> <br/>\n\nJust iterating the main issues with OpenMPI to make the text above more clear:\n\n<p></p><ol>\n<li>Recent versions of OpenMPI changed the behavior of ompi_info,\n</li><li>Recent versions of SSHD default to SSHv2,\n</li><li>Recent versions of OpenMPI send arguments to ssh differently, and\n</li><li>Recent versions of OpenMPI look for the user's executable in a static dir (presuming a shared fs) -or- in $HOME.\n</li></ol>\n\n<p></p><hr/>\n<em>2016-Dec-21 14:51:38 by mvpelletier:</em> <br/>\n\nValidating the required configuration values CONDOR_SSH_KEYGEN and CONDOR_SSHD will make it easier for a new pool administrator to get started.\n\n<p>It may also be worthwhile to insure that both of those values are executable with a similar \"! -x\" test, since they're user supplied values which may be subject to typos.\n\n</p><p>--- a/sshd.sh\n+++ b/sshd.sh\n@@ -33,6 +33,13 @@ KEYGEN=`condor_config_val CONDOR_SSH_KEYGEN`\n CONDOR_CHIRP=`condor_config_val libexec`\n CONDOR_CHIRP=$CONDOR_CHIRP/condor_chirp\n\n</p><p>+if [ -z \"$SSHD\" -o -z \"$KEYGEN\" ]\n+then\n+    echo CONDOR_SSHD and/or CONDOR_SSH_KEYGEN are not configured, exiting\n+    exit 255\n+fi\n+\n PORT=4444\n\n</p><p> _CONDOR_REMOTE_SPOOL_DIR=$_CONDOR_REMOTE_SPOOL_DIR\n\n</p><p></p><hr/>\n<em>2016-Dec-21 14:59:59 by mvpelletier:</em> <br/>\n\nSorry about the mangled diff, I forgot to use a code block.\n\n<p></p><div class=\"code\">\n<pre class=\"code\">diff --git a/sshd.sh b/sshd.sh\nindex 6d1b2e4..3254756 100755\n--- a/sshd.sh\n+++ b/sshd.sh\n@@ -33,6 +33,13 @@ KEYGEN=`condor_config_val CONDOR_SSH_KEYGEN`\n CONDOR_CHIRP=`condor_config_val libexec`\n CONDOR_CHIRP=$CONDOR_CHIRP/condor_chirp\n\n+if [ -z \"$SSHD\" -o -z \"$KEYGEN\" ]\n+then\n+       echo CONDOR_SSHD and/or CONDOR_SSH_KEYGEN are not configured, exiting\n+       exit 255\n+fi\n+\n+\n PORT=4444\n\n _CONDOR_REMOTE_SPOOL_DIR=$_CONDOR_REMOTE_SPOOL_DIR\n</pre></div>\n\n\n<p>One additional item - if MOUNT_UNDER_SCRATCH = /tmp is configured, the mkdir $_CONDOR_SCRATCH_DIR/tmp throws an error since the directory already exists. It should either test for the directory and refrain from mkdir if it exists, or simply redirect the mkdir stderr to /dev/null.\n\n</p><p></p><hr/>\n<em>2016-Dec-21 15:08:51 by jpatton:</em> <br/>\n\nThinking about MOUNT_UNDER_SCRATCH, alternatively, we could make MOUNT_UNDER_SCRATCH=/tmp a requirement (or check for it being set), and instead of using the less-than-ideal $HOME workaround for OpenMPI, move the user's mpi executable to /tmp and have mpirun use /tmp as its working dir. This would also prevent the proxies running on the same machine as node 0 from looking in node 0's scratch dir.\n\n<p></p><hr/>\n<em>2016-Dec-21 16:27:13 by mvpelletier:</em> <br/>\n\nSomething other than $HOME would be beneficial in the long run. For example, I've observed that the Ansys Remote Solve Manager can wind up with its own $HOME environment variable, namely /root, in the job submission for the engine startup, and you can wind up with \"cannot create /root/rsm.out: permission denied\" unless things are handled properly - that is, you can't have $ENV(HOME) in your submit description or $ENV{HOME} in your Perl submit wrapper, etc.\n\n<p></p><hr/>\n<em>2017-Jan-20 13:45:50 by jpatton:</em> <br/>\n\nPer Check-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5127e21cd808ed21125c2e097a648eeb2a3b53ae\">[50027]</a></span> (see below), I have disabled the tree spawn feature of orterun in the openmpiscript. This caused jobs with machines &gt; 5 to break because the ssh keys for all of the sshds are not chirped to every node, just node 0. This code change forces all proxies to be initiated by node 0.\n\n<p>However, another problem occurs when machines &gt; 16. Jobs will run at 100% cpu and never finish. This seems to be related to how job data is cached by orterun. It will store 16 nodes worth of data on node 0, but after that, it starts storing on node 1. The hypothesis is that this behavior breaks our script because of some communication issue, however, even if all the nodes are chirped all the sshd key and contact information, the problem still persists.\n\n</p><p>I have tried increasing every parameter value I could find in ompi_info where the parameter defaults to a value of 16 with no luck. May need to contact savvy OpenMPI users/devs to troubleshoot.\n\n</p><p>On the plus side, the updated scripts do run for machines &lt;= 16 now.\n\n</p><p></p><hr/>\n<em>2017-Jan-23 16:01:03 by jpatton:</em> <br/>\n\nCommunication was the issue, fixed in Check-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41590c49b4a3a9a399ca2801a43f65fecd6655d2\">[50044]</a></span>. Open MPI tries to (potentially) use all network interfaces available to communicate node-to-node. See <a class=\"external\" href=\"https://www.open-mpi.org/faq/?category=tcp\">https://www.open-mpi.org/faq/?category=tcp</a>\n\n<p></p><hr/>\n<em>2017-Jan-24 13:38:23 by tannenba:</em> <br/>\n\nCongrats on discovering the issue in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41590c49b4a3a9a399ca2801a43f65fecd6655d2\">[50044]</a></span> ! However, is there something we can do in this script to enable more \"zero configuration\" support by default?  It would be nice if things typically worked out of the box (albeit perhaps sub-optimally) by configuring openmpi to use whatever interface the HTCondor daemons determined was the \"public\" one, and the admin would only need to customize/tweak the script if they wanted it to use a specific interface.\n\n<p>Ditto for things like finding the \"prefix dir\" for OpenMPI - can we look in the path, look in the three most common places, etc, before requiring the attention of the admin?\n\n</p><p>Finally, if you do need some parameters (like the prefix dir for opempi), perhaps they could be condor_config knobs, and the script examines them via condor_config_val which could be assumed to be in the path.  This way an admin could specify an interface or prefix path, etc, via configuration and not worry about the openmpi script being overwritten the next time HTCondor is updated.\n\n</p><p></p><hr/>\n<em>2017-Feb-06 15:06:42 by jpatton:</em> <br/>\n\nCreated a mpich3-specific ticket: <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=6129\" onclick=\"get_ticket_and_populate_wrapper('6129'); return false;\" title=\"Create mpich3 (hydra) scripts compatible with parallel universe\">#6129</a></span>\n\n<p></p><hr/>\n<em>2017-Mar-01 09:49:45 by wenger:</em> <br/>\n\n<strong>REVIEW DOC</strong>\n\n<p>Looks good!\n\n</p><p></p><hr/>\n<em>2017-Mar-01 16:40:23 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>So far, so good, but I will review more for the next release.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=6129\" onclick=\"get_ticket_and_populate_wrapper('6129'); return false;\" title=\"Create mpich3 (hydra) scripts compatible with parallel universe\">#6129</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCreate mpich3 (hydra) scripts compatible with parallel universe</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6194\" onclick=\"get_ticket_and_populate_wrapper('6194'); return false;\" title=\"Add signal handler to openmpiscript\">#6194</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nAdd signal handler to openmpiscript</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-01 14:19</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/99ac3f1744d5b71a0a41730259896a154a21f8da\">[50246]</a></span>: Add version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span>  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Mar-01 09:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/76a7c5a73f7e86ee17ee5a6571ce756a36790668\">[50238]</a></span>: Gittrac <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span>: Very minor doc fixes.  (By Kent Wenger )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-13 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c993f6f97a4ef83ae87119823befea16a2eadee2\">[50145]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span>) Jason Patton's OpenMPI work (squashed commit)  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-13 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2f778a12fa7bbda7fad62c01230b7edff47be03f\">[50142]</a></span>: More document additions and fixes for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-08 09:45</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5a1a60c5b80b4bba45b6332cb28ce062a11d9eea\">[50120]</a></span>: Modified documentation for running Open MPI/MPICH under parallel universe <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Feb-01 09:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a91e4247ae76f149a154684810aeb6aad1275735\">[50090]</a></span>: Small fix for mpich2 <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-30 15:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/970ce3093aecb1776f301ef21d97ca1be31d59d0\">[50076]</a></span>: Cleanup scripts and add knobs <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span> openmpiscript now looks for config-defined values for OpenMPI install dir and excluded network interfaces, these knobs have been added to param_info.in  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-23 15:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41590c49b4a3a9a399ca2801a43f65fecd6655d2\">[50044]</a></span>: Disable communication over unused TCP networks <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span> orterun is greedy and tries to communicate over any network interface it finds, so I have added a parameter that must be modified by the user. Docker and other virtual interfaces have a tendency to hang communications between MPI nodes otherwise.  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2017-Jan-20 13:34</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5127e21cd808ed21125c2e097a648eeb2a3b53ae\">[50027]</a></span>: Disable mpirun ssh tree spawn <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span> When the number of nodes are large, mpirun tries to initiate its proxies using a tree (e.g. node 0 launches proxies on nodes 1 and 2, node 1 launches on nodes 3 and 4, and so on). Without chirping ssh keys to every node, this breaks our script, so disable it.  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Dec-22 09:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3588952cc7181d9f9d5845b1bbb31396721aa190\">[49866]</a></span>: Adding check for CONDOR_SSHD and CONDOR_SSH_KEYGEN <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span> suggested by mvpelletier  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Nov-30 09:18</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8d433d77fe5de5dc7494b282a46e97f3446a30a2\">[49681]</a></span>: Update Open MPI helper scripts for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6024\" onclick=\"get_ticket_and_populate_wrapper('6024'); return false;\" title=\"Update/create MPI helper scripts for parallel universe jobs\">#6024</a></span> Updates sshd.sh to use SSH2 (DSA and RSA keygen) Updates condor_ssh to use proc number instead of hostname and set HOME to scratch dir Updates openmpiscript to be compatible with newer versions of Open MPI  (By Jason Patton )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2017-Mar-01 16:40", "status": "resolved", "created": "2016-Nov-29 10:32", "fixed_version": "2016-Nov-29 10:32", "broken_version": "", "priority": "3", "subsystem": "Parallel", "assigned_to": "gthain", "derived_from": "", "creator": "jpatton", "rust": "", "customer_group": "other", "visibility": "public", "notify": "gthain@cs.wisc.edu, michael.v.pelletier@raytheon.com, tannenba@cs.wisc.edu, tim@cs.wisc.edu, wenger@cs.wisc.edu", "due_date": ""}