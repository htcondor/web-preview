{"id": 2887, "title": "Ticket #2887: Collector leaks sockets, leaves them in CLOSE_WAIT state", "description": "<blockquote>\nNote this isn't in a released version of condor yet.\n\n<p>Reproduce by starting condor, wait a few seconds, note the number of sockets in CLAIM_WAIT state:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">$ netstat -a | grep CLOSE\ntcp        1      0 chevre.cs.wisc.edu:4210     chevre.cs.wisc.edu:49000    CLOSE_WAIT\ntcp        1      0 chevre.cs.wisc.edu:45677    chevre.cs.wisc.edu:49964    CLOSE_WAIT\ntcp        1      0 chevre.cs.wisc.edu:45677    chevre.cs.wisc.edu:46637    CLOSE_WAIT\ntcp        1      0 chevre.cs.wisc.edu:4210     chevre.cs.wisc.edu:33445    CLOSE_WAIT\ntcp        1      0 chevre.cs.wisc.edu:45677    chevre.cs.wisc.edu:57458    CLOSE_WAIT\n</pre></div>\n\n\n<p>git bisect shows the bad commit is\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">git bisect good\n486eeed65a836c4fd6678768089ab258d641f744 is the first bad commit\ncommit 486eeed65a836c4fd6678768089ab258d641f744\nAuthor: Dan Bradley &lt;dan@hep.wisc.edu&gt;\nDate:   Tue Mar 6 18:29:11 2012 -0600\n\n    Fixed a bug in DaemonCommand. #2817\n\n    In some cases, the accepted socket was being deleted twice.\n\n:040000 040000 ae139643a7fb9db1f7eba5aa1c138fb5d2ad1c2d 311b54f05dce2856782f22c17a916ca8e898d3c6 M      src\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2012-Mar-15 22:46:19 by danb:</em> <br/>\n\nI just pushed a fix.  I simplified the logic in daemon_command that had been carried over from the original <code>HandleReq()</code>.  It just has one socket to keep track of now.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-15 22:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/39feb45f84e3a6901f6b683b876e855ccec76809\">[30933]</a></span>: Revert \"Fix leakning sockets in CLOSE_WAIT <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=2887\" onclick=\"get_ticket_and_populate_wrapper('2887'); return false;\" title=\"Collector leaks sockets, leaves them in CLOSE_WAIT state\">#2887</a></span>\" This reverts commit 77aa2c68f5eccdfb5eee8c2ebd4a9badadff6163.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-15 22:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9ea622f4981671e6b9d3a17c5b42ff055f8e5313\">[30934]</a></span>: Fix for leaking sockets. <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=2887\" onclick=\"get_ticket_and_populate_wrapper('2887'); return false;\" title=\"Collector leaks sockets, leaves them in CLOSE_WAIT state\">#2887</a></span> The problem was introduced in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2817\" onclick=\"get_ticket_and_populate_wrapper('2817'); return false;\" title=\"deadlock between the schedd and collector\">#2817</a></span>.  (By Dan Bradley )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-Mar-15 15:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/77aa2c68f5eccdfb5eee8c2ebd4a9badadff6163\">[30920]</a></span>: Fix leakning sockets in CLOSE_WAIT <span class=\"ticket\"><a class=\"review\" href=\"/wiki-archive/tickets/?ticket=2887\" onclick=\"get_ticket_and_populate_wrapper('2887'); return false;\" title=\"Collector leaks sockets, leaves them in CLOSE_WAIT state\">#2887</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Mar-15 22:46", "status": "review", "created": "2012-Mar-12 17:30", "fixed_version": "2012-Mar-12 17:30", "broken_version": "v070706", "priority": "1", "subsystem": "Daemons", "assigned_to": "danb", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tstclair@redhat.com", "due_date": ""}