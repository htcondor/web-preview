{"id": 3679, "title": "Ticket #3679: MPI Universe makes Schedd unresponsive", "description": "<blockquote>\nWhen an MPI universe job is submitted, it causes problems with the Schedd. The job will claim resources, but never use them. It will cause a Shadow to start up, but then immediately stop and start up a new Shadow; this continues ad infinitum.\n\n<p>To replicate this, I started up a personal HTCondor with the following submit file (which works as expected when <code>universe = parallel</code>):\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#############################################\n##   submit description file for a parallel program\n#############################################\nuniverse = mpi\nexecutable = openmpiscript\ngetenv=true\narguments = open_mpi_hw\n\nshould_transfer_files = yes\nwhen_to_transfer_output = on_exit_or_evict\n\ntransfer_input_files = open_mpi_hw\n\noutput = o.$(NODE)\nerror  = e.$(NODE)\nlog    = l\n\nnotification = never\nmachine_count = 2\n\nqueue\n</pre></div>\n\n\n<p><code>condor_q</code> for the job returns\n</p><div class=\"code\">\n<pre class=\"code\">-- Submitter: samf@beaver.cs.wisc.edu : &lt;128.105.14.140:56214&gt; : beaver.cs.wisc.edu\n ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD\n 178.0   samf            6/5  14:00   0+00:01:02 I  0   0.0  openmpiscript open\n</pre></div>\n\n\n<p><code>condor_status</code> returns\n</p><div class=\"code\">\n<pre class=\"code\">Name               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime\n\nslot10@beaver.cs.w LINUX      X86_64 Claimed   Idle      0.000  491  0+00:16:02\nslot11@beaver.cs.w LINUX      X86_64 Claimed   Idle      0.000  491  0+00:16:03\nslot12@beaver.cs.w LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:07\nslot13@beaver.cs.w LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:08\nslot14@beaver.cs.w LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:09\nslot15@beaver.cs.w LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:10\nslot16@beaver.cs.w LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:03\nslot1@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.180  491  0+00:29:43\nslot2@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:05\nslot3@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:06\nslot4@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:07\nslot5@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:08\nslot6@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:09\nslot7@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:10\nslot8@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:03\nslot9@beaver.cs.wi LINUX      X86_64 Unclaimed Idle      0.000  491  0+00:30:04\n                     Total Owner Claimed Unclaimed Matched Preempting Backfill\n\n        X86_64/LINUX    16     0       2        14       0          0        0\n\n               Total    16     0       2        14       0          0        0\n</pre></div>\n\n\n<p>The Shadow Log says (over and over again) the following. Note it says \"Universe not supported\" in the log.\n</p><div class=\"code\">\n<pre class=\"code\">06/05/13 14:20:44 Using IDs: 4 processors, 2 CPUs, 2 HTs\n06/05/13 14:20:44 Enumerating interfaces: lo 127.0.0.1 up\n06/05/13 14:20:44 Enumerating interfaces: em1 128.105.14.140 up\n06/05/13 14:20:44 Enumerating interfaces: vmnet1 192.168.1.1 up\n06/05/13 14:20:44 Enumerating interfaces: vmnet8 192.168.8.1 up\n06/05/13 14:20:44 Initializing Directory: curr_dir = /scratch/samf/personal-condor/config\n06/05/13 14:20:44 ******************************************************\n06/05/13 14:20:44 ** condor_shadow (CONDOR_SHADOW) STARTING UP\n06/05/13 14:20:44 ** /scratch/samf/oos_build_condor/release_dir/sbin/condor_shadow\n06/05/13 14:20:44 ** SubsystemInfo: name=SHADOW type=SHADOW(6) class=DAEMON(1)\n06/05/13 14:20:44 ** Configuration: subsystem:SHADOW local:&lt;NONE&gt; class:DAEMON\n06/05/13 14:20:44 ** $CondorVersion: 8.1.0 May 31 2013 BuildID: UW_development PRE-RELEASE-UWCS $\n06/05/13 14:20:44 ** $CondorPlatform: X86_64-RedHat_6.4 $\n06/05/13 14:20:44 ** PID = 19003\n06/05/13 14:20:44 ** Log last touched 6/5 14:20:42\n06/05/13 14:20:44 ******************************************************\n06/05/13 14:20:44 Using config source: /scratch/samf/personal-condor/condor_config\n06/05/13 14:20:44 Using local config sources:\n06/05/13 14:20:44    /scratch/samf/personal-condor/condor_config.local\n06/05/13 14:20:44 Not using shared port because USE_SHARED_PORT=false\n06/05/13 14:20:44 DaemonCore: command socket at &lt;128.105.14.140:49111?noUDP&gt;\n06/05/13 14:20:44 DaemonCore: private command socket at &lt;128.105.14.140:49111&gt;\n06/05/13 14:20:44 DaemonCore: UDP Command socket not created.\n06/05/13 14:20:44 Setting maximum accepts per cycle 8.\n06/05/13 14:20:44 Will use UDP to update collector beaver.cs.wisc.edu &lt;128.105.14.140:11000&gt;\n06/05/13 14:20:44 Not using shared port because USE_SHARED_PORT=false\n06/05/13 14:20:44 Spool format version requires &gt;= 1 (I support version 1)\n06/05/13 14:20:44 Spool format version is 1 (I require version &gt;= 1)\n06/05/13 14:20:44 Reading job ClassAd from STDIN\n06/05/13 14:20:44 Initializing a MPI shadow for job 178.0\n06/05/13 14:20:44 This version of the shadow cannot support universe 8 (MPI)\n06/05/13 14:20:44 ERROR \"Universe not supported\" at line 259 in file /scratch/samf/CONDOR_SRC/src/condor_shadow.V6.1/shadow_v61_main.cpp\n06/05/13 14:20:44 WriteUserLog: not initialized @ writeEvent()\n</pre></div>\n\n\n<p>The <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SchedLog\" title=\"Sched Log\">SchedLog</a></span> keeps repeating the following over and over:\n</p><div class=\"code\">\n<pre class=\"code\">06/05/13 14:23:19 (pid:17395) -------- Begin starting jobs --------\n06/05/13 14:23:19 (pid:17395) -------- Done starting jobs --------\n06/05/13 14:23:19 (pid:17395) DaemonCore: No more children processes to reap.\n06/05/13 14:23:19 (pid:17395) In DedicatedScheduler::reaper pid 19162 has status 1024\n06/05/13 14:23:19 (pid:17395) Started timer (1307) to call handleDedicatedJobs() in 2 secs\n06/05/13 14:23:19 (pid:17395) Shadow pid 19162 exited with status 4\n06/05/13 14:23:19 (pid:17395) ERROR: Shadow exited with job exception code!\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::shutdownMpiJob, cluster 178\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deactivateClaim\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deallocMatchRec\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deactivateClaim\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deallocMatchRec\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::removeAllocation, cluster 178\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deallocMatchRec\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deallocMatchRec\n06/05/13 14:23:19 (pid:17395) Deleting shadow rec for PID 19162, job (178.0)\n06/05/13 14:23:19 (pid:17395) Entered check_zombie( 19162, 0x0x3b53ed4, st=2 )\n06/05/13 14:23:19 (pid:17395) Marked job 178.0 as IDLE\n06/05/13 14:23:19 (pid:17395) Exited check_zombie( 19162, 0x0x3b53ed4 )\n06/05/13 14:23:19 (pid:17395) DedicatedScheduler::deallocMatchRec\n06/05/13 14:23:19 (pid:17395) Exited delete_shadow_rec( 19162 )\n06/05/13 14:23:21 (pid:17395) Starting DedicatedScheduler::handleDedicatedJobs\n06/05/13 14:23:21 (pid:17395) Inserting new attribute Scheduler into non-active cluster cid=178 acid=-1\n06/05/13 14:23:21 (pid:17395) Found 1 idle dedicated job(s)\n06/05/13 14:23:21 (pid:17395) DedicatedScheduler: Listing all dedicated jobs -\n06/05/13 14:23:21 (pid:17395) Dedicated job: 178.0 samf\n06/05/13 14:23:21 (pid:17395) Trying to query collector &lt;128.105.14.140:11000&gt;\n06/05/13 14:23:21 (pid:17395) Found 16 potential dedicated resources\n06/05/13 14:23:21 (pid:17395) idle resource list\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot10@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot11@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395) limbo resource list\n06/05/13 14:23:21 (pid:17395)  ************ empty ************\n06/05/13 14:23:21 (pid:17395) unclaimed resource list\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot12@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot13@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot14@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot15@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot16@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot1@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot2@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot3@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot4@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot5@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot6@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot7@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot8@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395)    LINUX  X86_64  slot9@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395) busy resource list\n06/05/13 14:23:21 (pid:17395)  ************ empty ************\n06/05/13 14:23:21 (pid:17395) Trying to find 2 resource(s) for dedicated job 178.0\n06/05/13 14:23:21 (pid:17395) satisfyJobs: testing 2 jobs against 2 slots\n06/05/13 14:23:21 (pid:17395) satisfyJobs: finding resources for 178.0\n06/05/13 14:23:21 (pid:17395) Entering ded-schedd concurrency limit check...\n06/05/13 14:23:21 (pid:17395) job limit: \"\"\n06/05/13 14:23:21 (pid:17395) candidate limit: \"\"\n06/05/13 14:23:21 (pid:17395) ConcurrencyLimits match, can reuse claim\n06/05/13 14:23:21 (pid:17395) Leaving ded-schedd concurrency limit check...\n06/05/13 14:23:21 (pid:17395) satisfyJobs:     178.0 satisfied with slot slot10@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395) satisfyJobs: finding resources for 178.0\n06/05/13 14:23:21 (pid:17395) Entering ded-schedd concurrency limit check...\n06/05/13 14:23:21 (pid:17395) job limit: \"\"\n06/05/13 14:23:21 (pid:17395) candidate limit: \"\"\n06/05/13 14:23:21 (pid:17395) ConcurrencyLimits match, can reuse claim\n06/05/13 14:23:21 (pid:17395) Leaving ded-schedd concurrency limit check...\n06/05/13 14:23:21 (pid:17395) satisfyJobs:     178.0 satisfied with slot slot11@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395) satisfyJobs: jobs were satisfied\n06/05/13 14:23:21 (pid:17395) Satisfied job 178 with 2 idle resources\n06/05/13 14:23:21 (pid:17395) Allocation for job 178.0, nprocs: 1\n06/05/13 14:23:21 (pid:17395) 178.0.0: LINUX    X86_64  slot10@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395) 178.0.1: LINUX    X86_64  slot11@beaver.cs.wisc.edu\n06/05/13 14:23:21 (pid:17395) DedicateScheduler::spawnJobs() - job=178.0 on &lt;128.105.14.140:45681&gt;\n06/05/13 14:23:21 (pid:17395) Queueing job 178.0 in runnable job queue\n06/05/13 14:23:21 (pid:17395) start next job after 0 sec, JobsThisBurst 0\n06/05/13 14:23:21 (pid:17395) In DedicatedScheduler::publishRequestAd()\n06/05/13 14:23:21 (pid:17395) Trying to update collector &lt;128.105.14.140:11000&gt;\n06/05/13 14:23:21 (pid:17395) Attempting to send update via UDP to collector beaver.cs.wisc.edu &lt;128.105.14.140:11000&gt;\n06/05/13 14:23:21 (pid:17395) Entering DedicatedScheduler::checkSanity()\n06/05/13 14:23:21 (pid:17395) Finished DedicatedScheduler::handleDedicatedJobs\n06/05/13 14:23:21 (pid:17395) Job prep for 178.0 will not block, calling aboutToSpawnJobHandler() directly\n06/05/13 14:23:21 (pid:17395) aboutToSpawnJobHandler() completed for job 178.0, attempting to spawn job handler\n06/05/13 14:23:21 (pid:17395) Starting add_shadow_birthdate(178.0)\n06/05/13 14:23:21 (pid:17395) Create_Process: using fast clone() to create child process.\n06/05/13 14:23:21 (pid:17395) Added shadow record for PID 19164, job (178.0)\n06/05/13 14:23:21 (pid:17395) Started shadow for job 178.0 on slot10@beaver.cs.wisc.edu &lt;128.105.14.140:45681&gt;#1370457997#10#... for DedicatedScheduler@samf, (shadow pid = 19164)\n06/05/13 14:23:21 (pid:17395) Cleared dirty attributes for job 178.0\n06/05/13 14:23:21 (pid:17395) Expedited call to StartJobs()\n06/05/13 14:23:21 (pid:17395) DaemonCore: No more children processes to reap.\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2013-Jun-05 16:01:11 by samf:</em> <br/>\n\nQuick fix added to prevent submission of mpi universe jobs.\n\n<p></p><hr/>\n<em>2013-Jun-05 16:22:11 by johnkn:</em> <br/>\n\nuse of match_prefix() with \"-force-mpi-universe\" means that -f will match it.\nuse is_arg_prefix() with a minimum length (maybe 7?) instead of match_prefix().\n\n<p></p><hr/>\n<em>2013-Jun-05 16:38:05 by tstclair:</em> <br/>\n\nMPI universe is dead and should be removed.  IIRC TT sent an email about it.\n\n<p></p><hr/>\n<em>2013-Jun-13 15:14:12 by samf:</em> <br/>\n\nI've applied a patch to the 8.0 and 8.1 branches prohibiting <code>condor_submit</code> from submitting jobs with <code>universe = mpi</code>. The next goals are\n\n<p></p><ol>\n<li>To create a whitelist and/or blacklist of universes.\n</li><li>To remove jobs already in the queue with mpi universe.\n</li><li>To prevent mpi universe jobs from claiming resources.\n</li><li>To put on hold or remove from the queue jobs given to an 8.X schedd from a prior version of <code>condor_submit</code>.\n</li></ol>\n\n<p>Currently, the attached patch will remove any mpi universe jobs in the job queue when HTCondor starts, will prevent mpi universe jobs from claiming resources, prevents mpi universe jobs from being considered runnable, does not count mpi universe jobs when counting jobs in the job queue, and also says that condor_ssh_to_job will not connect to an mpi universe job.\n\n</p><p></p><hr/>\n<em>2013-Jun-14 10:48:16 by samf:</em> <br/>\n\nThe patch is now a branch. <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4e97c75653338837f71d5045f9376cca64c6449f\">[36573]</a></span> V8_1-gt3679-remove-mpi-universe</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-13 15:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4e97c75653338837f71d5045f9376cca64c6449f\">[36573]</a></span>: Ticket <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=3679\" onclick=\"get_ticket_and_populate_wrapper('3679'); return false;\" title=\"MPI Universe makes Schedd unresponsive\">#3679</a></span>. Preventing mpi universe jobs from running, claiming resources, and causing other havoc. mpi universe jobs already in a queue will be removed when HTCondor starts. ===VersionHistory:Pending===  (By Samuel Friedman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2013-Jun-05 15:57</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/19f8cde868c7cd0c671116d10657a6748729b2be\">[35997]</a></span>: Ticket <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=3679\" onclick=\"get_ticket_and_populate_wrapper('3679'); return false;\" title=\"MPI Universe makes Schedd unresponsive\">#3679</a></span>. Preventing submission of mpi universe jobs.  (By Samuel Friedman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Feb-04 10:13", "status": "new", "created": "2013-Jun-05 14:25", "fixed_version": "2013-Jun-05 14:25", "broken_version": "v080000", "priority": "2", "subsystem": "Parallel", "assigned_to": "gthain", "derived_from": "", "creator": "samf", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "samf@cs.wisc.edu, johnkn@cs.wisc.edu, tannenba@cs.wisc.edu", "due_date": ""}