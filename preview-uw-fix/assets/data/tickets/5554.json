{"id": 5554, "title": "Ticket #5554: Have docker universe report wall, CPU, and memory usage", "description": "<blockquote>\nAt the European HTCondor Workshop, Andrew Lahiff from RAL noted that they couldn't use the Docker universe more widely because it does not report wall or CPU usage - a requirement for WLCG reporting.\n\n<p>Wall time is fairly straightforward to derive (if nothing else, from <code>docker inspect</code>).  Further, <code>docker stats</code> will get all the cgroup statistics from the container (which is a lot easier than trying to find the cgroup in a portable manner!).\n\n</p><p>I have copied a sample interaction below.\n\n</p><p><strong>NOTE</strong>:  This query takes about 2 seconds to perform.  If you shutdown the unix socket after the HTTP GET request is sent - but before the response is received from the Docker daemon - the daemon will immediately return a HTTP 200 response with 0 length content.\n\n</p><p>Hence, if you're working with the raw API (which may be the only option as <code>docker stats</code> doesn't have a raw formatting option), you <em>must not</em> shutdown the client end of the Unix socket.\n\n</p><p>This shutdown issue is why the following example does not work with modern docker:\n\n</p><p></p><div class=\"verbatim\">\n<pre>echo -ne 'GET /v1.20/containers/fervent_poincare/stats?stream=0 HTTP/1.1\\r\\n\\r\\n' | nc -U /var/run/docker.sock\n</pre></div>\n\n\n<p>It does seem that very recent versions of `curl` (7.40 and later) can talk to a Unix socket directly; the version on RHEL7 appears to be too old.\n\n</p><p>Brian\n\n</p><p></p><div class=\"verbatim\">\n<pre>cat - | nc -U /var/run/docker.sock\nGET /v1.20/containers/fervent_poincare/stats?stream=0 HTTP/1.1\n\nHTTP/1.1 200 OK\nContent-Type: application/json\nServer: Docker/1.8.2-el7.centos (linux)\nDate: Tue, 08 Mar 2016 21:24:06 GMT\nTransfer-Encoding: chunked\n\n868\n{\"read\":\"2016-03-08T15:24:06.488775637-06:00\",\"network\":{\"rx_bytes\":648,\"rx_packets\":8,\"rx_errors\":0,\"rx_dropped\":0,\"tx_bytes\":648,\"tx_packets\":8,\"tx_errors\":0,\"tx_dropped\":0},\"precpu_stats\":{\"cpu_usage\":{\"total_usage\":28887785,\"percpu_usage\":[5858312,0,17944655,5084818],\"usage_in_kernelmode\":10000000,\"usage_in_usermode\":10000000},\"system_cpu_usage\":1129878740000000,\"throttling_data\":{\"periods\":0,\"throttled_periods\":0,\"throttled_time\":0}},\"cpu_stats\":{\"cpu_usage\":{\"total_usage\":28887785,\"percpu_usage\":[5858312,0,17944655,5084818],\"usage_in_kernelmode\":10000000,\"usage_in_usermode\":10000000},\"system_cpu_usage\":1129882750000000,\"throttling_data\":{\"periods\":0,\"throttled_periods\":0,\"throttled_time\":0}},\"memory_stats\":{\"usage\":3039232,\"max_usage\":3108864,\"stats\":{\"active_anon\":90112,\"active_file\":98304,\"cache\":2949120,\"hierarchical_memory_limit\":9223372036854775807,\"hierarchical_memsw_limit\":9223372036854775807,\"inactive_anon\":0,\"inactive_fil! e\":2850816 ,\"mapped_file\":475136,\"pgfault\":1422,\"pgmajfault\":4,\"pgpgin\":1050,\"pgpgout\":308,\"rss\":90112,\"rss_huge\":0,\"swap\":0,\"total_active_anon\":90112,\"total_active_file\":98304,\"total_cache\":2949120,\"total_inactive_anon\":0,\"total_inactive_file\":2850816,\"total_mapped_file\":475136,\"total_pgfault\":1422,\"total_pgmajfault\":4,\"total_pgpgin\":1050,\"total_pgpgout\":308,\"total_rss\":90112,\"total_rss_huge\":0,\"total_swap\":0,\"total_unevictable\":0,\"unevictable\":0},\"failcnt\":0,\"limit\":8203231232},\"blkio_stats\":{\"io_service_bytes_recursive\":[{\"major\":253,\"minor\":5,\"op\":\"Read\",\"value\":2924544},{\"major\":253,\"minor\":5,\"op\":\"Write\",\"value\":0},{\"major\":253,\"minor\":5,\"op\":\"Sync\",\"value\":0},{\"major\":253,\"minor\":5,\"op\":\"Async\",\"value\":2924544},{\"major\":253,\"minor\":5,\"op\":\"Total\",\"value\":2924544}],\"io_serviced_recursive\":[{\"major\":253,\"minor\":5,\"op\":\"Read\",\"value\":188},{\"major\":253,\"minor\":5,\"op\":\"Write\",\"value\":0},{\"major\":253,\"minor\":5,\"op\":\"Sync\",\"value\":0},{\"major\":253,\"minor\":5,\"op\":\"Async\",\"value\":188},{\"m! ajor\":253, \"minor\":5,\"op\":\"Total\",\"value\":188}],\"io_queue_recursive\":[],\"io_service_time_recursive\":[],\"io_wait_time_recursive\":[],\"io_merged_recursive\":[],\"io_time_recursive\":[],\"sectors_recursive\":[]}}\n\n0\n\n^C\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\nduplicate of <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5609\" onclick=\"get_ticket_and_populate_wrapper('5609'); return false;\" title=\"Docker universe should advertise cpu usage\">#5609</a></span></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "", "type": "enhance", "last_change": "2020-Jul-20 14:36", "status": "abandoned", "created": "2016-Mar-08 21:39", "fixed_version": "2016-Mar-08 21:39", "broken_version": "", "priority": "3", "subsystem": "", "assigned_to": "gthain", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "osg", "visibility": "public", "notify": "bbockelm@cse.unl.edu", "due_date": ""}