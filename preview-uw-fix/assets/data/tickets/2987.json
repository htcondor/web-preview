{"id": 2987, "title": "Ticket #2987: Hard links in sandbox cause privsep to fail, and job goes on hold", "description": "<blockquote>\nWhen the execute node is running in privsep mode, the privsep switchboard attempts to chown the sandbox back to the condor user after the job exits.  When chowning files, the privsep code attempts to detect attempts to chown hard-links outside the sandbox by only chowning files with the correct source (i.e. \"from\") uid.\n\n<p>However, if the job has hardlinked two filenames together in the sandbox, the privsep switchboard will only correctly chown the first one.  When it stats the second one, it will see that it has already been chown'd, and thus is owned by the target uid.  In this case, it exits with an error, and the job goes on hold.\n\n</p><p>It should be safe to detect that the target file is already owned by the target uid, and skip this chown.</p></blockquote>", "remarks": "<blockquote>\n<em>2012-May-11 08:26:58 by bbockelm:</em> <br/>\n\nWouldn't glexec cause a similar issue?\n\n<p>I don't use privsep, but the starter typically appears ANGRY when there are files owned by multiple unix users in the sandbox.\n\n</p><p>The log looks something like this:\n\n</p><p></p><div class=\"verbatim\">\n<pre>04/27/12 01:29:52 Can't open directory \"/var/lib/condor/execute/dir_1706/tmp/glexec_mount_under_scratch_j6uNy0\" as owner, errno: 13 (Permission denied)04/27/12 01:29:52 Can't open directory \"/var/lib/condor/execute/dir_1706/tmp/glexec_mount_under_scratch_cvZ6C3\" as owner, errno: 13 (Permission denied)04/27/12 01:29:52 Can't open directory \"/var/lib/condor/execute/dir_1706/tmp/glexec_mount_under_scratch_cvZ6C3\" as owner, errno: 13 (Permission denied)04/27/12 01:29:52 Can't open directory \"/var/lib/condor/execute/dir_1706/tmp/glexec_mount_under_scratch_VztoZr\" as owner, errno: 13 (Permission denied)04/27/12 01:29:52 Can't open directory \"/var/lib/condor/execute/dir_1706/tmp/glexec_mount_under_scratch_VztoZr\" as owner, errno: 13 (Permission denied)\n</pre></div>\n\n\n<p>(I removed the remaining 142,000 characters in that line for clarity.  Also, newlines are great.)\n\n</p><p></p><hr/>\n<em>2012-May-11 10:12:48 by gthain:</em> <br/>\n\nNote:  ToddT code reviewed this small patch.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-17 12:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ce349ae4c6882144ad17c7d83ebbe7a8c54d41b2\">[32063]</a></span>: edit of version history item, and used this commit to also correct spelling throughout 7.8 version history. ===GT=== <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2987\" onclick=\"get_ticket_and_populate_wrapper('2987'); return false;\" title=\"Hard links in sandbox cause privsep to fail, and job goes on hold\">#2987</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-11 10:11</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8dfe5e83a3df14c60fdeee20397cbc742b6021b1\">[32028]</a></span>: Document <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2987\" onclick=\"get_ticket_and_populate_wrapper('2987'); return false;\" title=\"Hard links in sandbox cause privsep to fail, and job goes on hold\">#2987</a></span>  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-11 10:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/21008e9875c2b86c7721805f019e0373ca75f9b8\">[32026]</a></span>: Don't error out of the privsep switchboard when chowning <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2987\" onclick=\"get_ticket_and_populate_wrapper('2987'); return false;\" title=\"Hard links in sandbox cause privsep to fail, and job goes on hold\">#2987</a></span> If the target file is already owned by the target user, don't error out.  (By Greg Thain )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2012-May-11 09:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b318a42507d9374acb888fe98dc8c0a7a9f69640\">[32025]</a></span>: Brian says \"newlines are great\" <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2987\" onclick=\"get_ticket_and_populate_wrapper('2987'); return false;\" title=\"Hard links in sandbox cause privsep to fail, and job goes on hold\">#2987</a></span>  (By Greg Thain )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-May-11 10:13", "status": "resolved", "created": "2012-May-11 08:23", "fixed_version": "2012-May-11 08:23", "broken_version": "v070800", "priority": "2", "subsystem": "Daemons", "assigned_to": "gthain", "derived_from": "", "creator": "gthain", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "", "due_date": "20120518"}