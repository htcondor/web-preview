{"id": 2381, "title": "Ticket #2381: Condor only detects 32 out of 40 physical cores on a Win2k8 R2 machine", "description": "<blockquote>\nThe condor_startd only lists out 32 processors for the machine on start up. It stops at 32 CPUs every time when it's listing them out at the start of its log.\n\n<p>You can force it to 40 by setting NUM_CPUS.\n\n</p><p>OS is 64-bit Windows 2008 Server Enterprise Edition R2.\n\n</p><p>TJ's Note - this is a consequence of the fact that we are a 32 bit app.  As a 32 bit app on a 64 bit machine we need to call <span class=\"quote\">GetNativeSystemInfo</span> to get the actual number of CPUs.</p></blockquote>", "remarks": "<blockquote>\n<em>2011-Aug-22 13:19:42 by ichesal:</em> <br/>\n\n\n<p>FWIW I had never intended this ticket to be for discussing the comm issues. Just the failure of the code that's used to detect physical cores in Windows. This sample program uses the same struct as Condor and it also returns on 32-cores for the machine (despite Windows reporting 40 cores in the 'About Machine' UI).\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#include &lt;Windows.h&gt;\n#include &lt;iostream&gt;\nusing namespace std;\n\nint _tmain(int argc, _TCHAR* argv[])\n{\n\tSYSTEM_INFO si;\n\tGetSystemInfo(&amp;si);\n\tcout &lt;&lt; \"System Processor Information:\" &lt;&lt; endl;\n\tcout &lt;&lt; \"  dwNumberOfProcessors = \" &lt;&lt; si.dwNumberOfProcessors &lt;&lt; endl;\n\tcout &lt;&lt; \"  dwProcessorType      = \" &lt;&lt; si.dwProcessorType &lt;&lt; endl;\n\tcout &lt;&lt; \"  wProcessorLevel      = \" &lt;&lt; si.wProcessorLevel &lt;&lt; endl;\n\tcout &lt;&lt; \"  wProcessorRevision   = \" &lt;&lt; si.wProcessorRevision &lt;&lt; endl;\n\tcout &lt;&lt; endl;\n\treturn 0;\n}\n{/code}\n\nCompiled as a 32-bit console application and run on the 40-core box in question has dwNumberOfProcessors set to 32.\n\n----\n_2011-Aug-22 13:21:14 by ichesal:_ {linebreak}\nLet me try that code snippet again:\n\n{code}\n#include &lt;Windows.h&gt;\n#include &lt;iostream&gt;\nusing namespace std;\nint _tmain(int argc, _TCHAR* argv[]) {\n  SYSTEM_INFO si;\n  GetSystemInfo(&amp;si);\n  cout &lt;&lt; \"System Processor Information:\" &lt;&lt; endl;\n  cout &lt;&lt; \" dwNumberOfProcessors = \" &lt;&lt; si.dwNumberOfProcessors &lt;&lt; endl;\n  cout &lt;&lt; \" dwProcessorType = \" &lt;&lt; si.dwProcessorType &lt;&lt; endl;\n  cout &lt;&lt; \" wProcessorLevel = \" &lt;&lt; si.wProcessorLevel &lt;&lt; endl;\n  cout &lt;&lt; \" wProcessorRevision = \" &lt;&lt; si.wProcessorRevision &lt;&lt; endl;\n  cout &lt;&lt; endl;\n  return 0;\n}\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Aug-24 11:00:18 by ichesal:</em> <br/>\n\nI'll try and get you that output today.\n\n<p></p><hr/>\n<em>2011-Aug-24 12:41:14 by ichesal:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">GetSystemInfo Information:\ndwNumberOfProcessors = 32\ndwProcessorType = 586\nwProcessorLevel = 6\nwProcessorRevision = 12034\n\nGetNativeSystemInfo Information:\ndwNumberOfProcessors = 40\ndwProcessorType = 8664\nwProcessorLevel = 6\nwProcessorRevision = 12034\n</pre></div>\n\n\n<p>32-bit console app with:\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">#include &lt;Windows.h&gt;\n#include &lt;iostream&gt;\nusing namespace std;\n\nint _tmain(int argc, _TCHAR* argv[])\n{\n\tSYSTEM_INFO si, sj;\n\tGetSystemInfo(&amp;si);\n\tcout &lt;&lt; \"GetSystemInfo Information:\" &lt;&lt; endl;\n\tcout &lt;&lt; \"  dwNumberOfProcessors = \" &lt;&lt; si.dwNumberOfProcessors &lt;&lt; endl;\n\tcout &lt;&lt; \"  dwProcessorType      = \" &lt;&lt; si.dwProcessorType &lt;&lt; endl;\n\tcout &lt;&lt; \"  wProcessorLevel      = \" &lt;&lt; si.wProcessorLevel &lt;&lt; endl;\n\tcout &lt;&lt; \"  wProcessorRevision   = \" &lt;&lt; si.wProcessorRevision &lt;&lt; endl;\n\tcout &lt;&lt; endl;\n\n\tGetNativeSystemInfo(&amp;sj);\n\tcout &lt;&lt; \"GetNativeSystemInfo Information:\" &lt;&lt; endl;\n\tcout &lt;&lt; \"  dwNumberOfProcessors = \" &lt;&lt; sj.dwNumberOfProcessors &lt;&lt; endl;\n\tcout &lt;&lt; \"  dwProcessorType      = \" &lt;&lt; sj.dwProcessorType &lt;&lt; endl;\n\tcout &lt;&lt; \"  wProcessorLevel      = \" &lt;&lt; sj.wProcessorLevel &lt;&lt; endl;\n\tcout &lt;&lt; \"  wProcessorRevision   = \" &lt;&lt; sj.wProcessorRevision &lt;&lt; endl;\n\tcout &lt;&lt; endl;\n\n\treturn 0;\n}\n\n\n</pre></div>\n\n\n<p></p><hr/>\n<em>2011-Aug-24 13:19:31 by ichesal:</em> <br/>\n\nAlso: not the R2 release of Win2k8. Sorry about that. It's Win2k8 Enterprise Server SP2.\n\n<p>I blame Microsoft's failure to name OS revisions well for that one. :)\n\n</p><p></p><hr/>\n<em>2012-Feb-13 13:00:47 by tannenba:</em> <br/>\n\n<strong>CODE REVIEW</strong>\n\n<p>Looks good, thanks.</p></blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2441\" onclick=\"get_ticket_and_populate_wrapper('2441'); return false;\" title=\"Condor startd on Windows can't run more than 8 jobs simultaneously\">#2441</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCondor startd on Windows can't run more than 8 jobs simultaneously</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-07 15:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3dc5a310da1dd9505716301e6029870766c531ae\">[27119]</a></span>: Fixed CPU detection on Windows so that &gt; 32 CPUs are detected correctly. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2381\" onclick=\"get_ticket_and_populate_wrapper('2381'); return false;\" title=\"Condor only detects 32 out of 40 physical cores on a Win2k8 R2 machine\">#2381</a></span> ===VersionHistory:Complete===  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2011-Sep-07 14:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/68a347cf2510b55101e73598a6c47d432ba4ca27\">[27117]</a></span>: Fixed CPU detection on Windows so that &gt; 32 CPUs are detected correctly. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=2381\" onclick=\"get_ticket_and_populate_wrapper('2381'); return false;\" title=\"Condor only detects 32 out of 40 physical cores on a Win2k8 R2 machine\">#2381</a></span> ===VersionHistory:Complete===  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2012-Feb-13 13:01", "status": "resolved", "created": "2011-Aug-12 15:57", "fixed_version": "2011-Aug-12 15:57", "broken_version": "v070601", "priority": "2", "subsystem": "Win32", "assigned_to": "tannenba", "derived_from": "", "creator": "ichesal", "rust": "a22489", "customer_group": "support", "visibility": "public", "notify": "tstclair@redhat.com, tannenba@cs.wisc.edu, ichesal@cyclecomputing.com", "due_date": ""}