{"id": 4658, "title": "Ticket #4658: EC2 jobs \"running\" without corresponding instance.", "description": "<blockquote>\nWhen HTCondor asks an EC2 service to report on the status of all its instances (or spot instance requests), it finds the job corresponding to that instance (or spot instance request) and notifies it of its new status.  If a job is not notified by this process, we conclude that it's been purged from the service, and we notify the job about <em>that</em>.\n\n<p>When we request a spot instance, we get a spot instance request ID.  It is (briefly) possible to have an ID for a spot instance request that exists but isn't listed when we ask about all of them.  For that reason, HTCondor presently ignores the purge notification for spot instance requests.\n\n</p><p>The bug is that we accidentally also ignore the purge notification for spot <em>instances</em>, which can lead to a \"running\" EC2 job that has no corresponding instance.\n\n</p><p>In addition, we should think about whether ignoring purge notifications for spot instance requests is the right thing to do.\n\n</p><p></p><hr/>\nFor future reference: this ticket turned into a two-parter:\n\n<p></p><ul>\n<li>fixing problems introduced by the conversion to an asynchronous notification-based system for status updates; and\n</li><li>eliminating the two remaining synchronous queries.\n</li></ul>\n\n<p>Because the synchronous queries were for individual jobs, the latter fix should also reduce the overall number of queries that the EC2 GAHP makes.  Instance-specific calls remain for starting (including, for example, tagging, key creation, networking, and storage) and stopping jobs (including, for example, key destruction).</p></blockquote>", "remarks": "<blockquote>\n<em>2016-Jan-04 11:00:29 by tlmiller:</em> <br/>\n\nIt's possible that this is (mostly?) an illusion.  The code to handle batched status updates asks the cloud service for all instances first, and then tries to match each instance to a job.  Any left-over instances are logged, but any left-over jobs are notified that they've been purged.  Obviously, a spot job may not have (may never have) an instance, and will thus be notified that it's been purged.  In most cases, that will immediately be followed by an update with the spot job's real state, which explains why ignoring purge notifications generally seemed to work.\n\n<p>At the moment, we work around this problem by requiring that two updates in a row declare a job purged.  It would be better, of course, to fix the batch status update problem, but that would require quite a bit of additional cleverness in the batch update code (or somewhere) to distinguish between the two types of jobs.  (Spot jobs, of course, eventually do gain instances -- that being the whole point -- so it's not as simple as checking if a job is a spot job to determine if it should be notified of a(n apparent) purge.)\n\n</p><p></p><hr/>\n<em>2016-Jan-04 11:04:08 by tlmiller:</em> <br/>\n\nThis investigation also revealed a few places where we didn't handle the fact that batch status updates occur asynchronously with respect to the evolution of the state machine; those have been fixed.\n\n<p>This investigation also revealed two cases where batch status updates could fail to trigger a state machine transition (and thus cause, for instance, a job's grid status to be running and its Condor status to be idle).  Those cases have been removed.\n\n</p><p>This investigation also revealed two places where we called the GAHP to get status information for an individual job.  These calls have been removed in favor of waiting for the next batch status update, which has had the happy side-effect of making their job state code much smaller.\n\n</p><p></p><hr/>\n<em>2016-Jan-04 11:06:32 by tlmiller:</em> <br/>\n\nThe aforementioned fixes are going in on the <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5442\" onclick=\"get_ticket_and_populate_wrapper('5442'); return false;\" title=\"grid manager and EC2 GAHP hang under load.\">#5442</a></span> branch so Fermi can help test them.  (Build ID 352913.)\n\n<p>John, if you'd like to test these changes before the next release, I'd be happy send along a build (patched from whatever version).\n\n</p><p></p><hr/>\n<em>2016-Feb-02 15:38:47 by tlmiller:</em> <br/>\n\nMerged to 8.4 after successful Fermi testing.\n\n<p></p><hr/>\n<em>2016-Feb-03 14:34:45 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>These changes look fine.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Feb-03 14:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/9aed10fa5ff0f76d94d51327cf08ae74063a82dc\">[47548]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4658\" onclick=\"get_ticket_and_populate_wrapper('4658'); return false;\" title='EC2 jobs \"running\" without corresponding instance.'>#4658</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5442\" onclick=\"get_ticket_and_populate_wrapper('5442'); return false;\" title=\"grid manager and EC2 GAHP hang under load.\">#5442</a></span>) Add release notes for this branch. Document new configuration knob.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-07 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/69ea99c512491865cd4bcf4d98599fd6a1ebf6e3\">[47443]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4658\" onclick=\"get_ticket_and_populate_wrapper('4658'); return false;\" title='EC2 jobs \"running\" without corresponding instance.'>#4658</a></span>) Always accept the first status update (to help crash recovery). Improve D_FULLDEBUG messages.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2016-Jan-04 10:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/6ed01cbf7cac5631afda406d63286fac05372da5\">[47409]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4658\" onclick=\"get_ticket_and_populate_wrapper('4658'); return false;\" title='EC2 jobs \"running\" without corresponding instance.'>#4658</a></span>) Fix a bug where spot instances could ignore a state transition. Explained things better in the comments.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-31 18:00</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/cb60118b447baddb4330db0a06f9c61f43128fcf\">[47408]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4658\" onclick=\"get_ticket_and_populate_wrapper('4658'); return false;\" title='EC2 jobs \"running\" without corresponding instance.'>#4658</a></span>) Fix bugs with previous commit. Remove case where GM_SUBMITTED would not proceed to GM_PROBE_JOB, causing the job's HTCondor and grid statuses to diverge.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-31 15:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8359f4caf7190a66f7213158273fc43fc48ddf71\">[47407]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4658\" onclick=\"get_ticket_and_populate_wrapper('4658'); return false;\" title='EC2 jobs \"running\" without corresponding instance.'>#4658</a></span>) Stop ignoring purged spot instances. (However, because of race conditions, required them to be purged twice.) Remove final remaining individual-job status queries.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Dec-31 15:14</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a070d0ddaa154376f25a1df1d0051f152e7eaaa5\">[47406]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4658\" onclick=\"get_ticket_and_populate_wrapper('4658'); return false;\" title='EC2 jobs \"running\" without corresponding instance.'>#4658</a></span>) Fix compiler warnings.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2016-Mar-14 16:42", "status": "resolved", "created": "2014-Oct-15 10:58", "fixed_version": "2014-Oct-15 10:58", "broken_version": "", "priority": "4", "subsystem": "Grid", "assigned_to": "tlmiller", "derived_from": "", "creator": "tlmiller", "rust": "", "customer_group": "other", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, jhover@cs.wisc.edu", "due_date": ""}