{"id": 4997, "title": "Ticket #4997: Infinite loop in condor_ssh_to_job", "description": "<blockquote>\nCMS operations reported the following:\n\n<p></p><div class=\"verbatim\">\n<pre>Hi All,\n\nI was collecting information about ~2weeks ago about condor_ssh_to_job to each site. Seems whenever\ncondor_ssh_to_job fails due to site blocking (/sbin/nologin, sshd blocking, internal ACL or putting sshd in\n/etc/hosts.deny with line sshd: ALL) process stays running on our machine and consuming CPU [1]. After killing\n[2] all condor_ssh_to_job pids, cpu usage decreased from 40% to %3. How to reproduce [3].\n\nCheers,\nJustas\n\n[1] Please see a drop of User cpu when I killed all condor_ssh_to_job pids\nhttp://hcc-ganglia.unl.edu/graph_all_periods.php?h=vocms095.cern.ch&amp;m=load_report&amp;r=hour&amp;s=by%20name&amp;hc=4&amp;mc=2&amp;st=1427093165&amp;g=cpu_report&amp;z=large&amp;c=crab-infrastructure\n\n[2]\n[root@vocms095 ~]# echo $(ps aux | grep 'condor_ssh_to_job' | awk '{print $2}')\n859634 859641 859651 859657 859663 859669 859679 860201 863703 863720 863975 864017 865298 865369 865379 1314386\n1314464 1314518 1314557 1315457 1316103 3489257 3489817 3490141 3490816 3592473 3869784\n[root@vocms095 ~]# kill $(ps aux | grep 'condor_ssh_to_job' | awk '{print $2}')\n\n[3]\n[root@vocms095 ~]# ps aux | grep condor_ssh_to_job\nroot     3885791  0.0  0.0  10504   724 pts/5    S+   08:00   0:00 grep condor_ssh_to_job\n[root@vocms095 ~]# condor_q -const 'MATCH_GLIDEIN_CMSSite=?=\"T2_US_Wisconsin\"'\n#Select any running job ID (T2_US_Wisconsin is one of the sites which does not allow ssh connection)\n[root@vocms095 ~]# condor_ssh_to_job 2371542.0\nssh_exchange_identification: Connection closed by remote host\n[root@vocms095 ~]# ps aux | grep condor_ssh_to_job\nroot     3886657 84.3  0.0  43544  4208 pts/5    R    08:02   0:27 condor_ssh_to_job -proxy\n/tmp/root.condor_ssh_to_job_52598b59/fdpass\nroot     3887028  0.0  0.0  10508   760 pts/5    S+   08:02   0:00 grep condor_ssh_to_job\n\n#condor_ssh_to_job process will stay all the time\n</pre></div>\n\n\n<p>Poking around, I found a live specimen and got a stack trace:\n\n</p><p></p><div class=\"verbatim\">\n<pre>(gdb) bt\n#0  0x00007f263558d098 in poll () from /lib64/libc.so.6\n#1  0x00007f2636e1498b in Selector::execute() () from /usr/lib64/condor/libcondor_utils_8_3_2.so\n#2  0x00007f2636e55a0c in SocketProxy::execute() () from /usr/lib64/condor/libcondor_utils_8_3_2.so\n#3  0x00000000004044c0 in SSHToJob::execute_proxy() ()\n#4  0x000000000040672a in main ()\n</pre></div>\n\n\n<p>Strace just has this repeating:\n\n</p><p></p><div class=\"verbatim\">\n<pre>poll([{fd=0, events=POLLIN}], 1, -1)    = 1 ([{fd=0, revents=POLLHUP}])\n</pre></div>\n\n\n<p>I think the single-shot mode of the selector is improperly ignoring POLLHUP, causing a logic issue in the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SocketProxy\" title=\"Socket Proxy\">SocketProxy</a></span> class.</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Apr-29 15:10:03 by bbockelm:</em> <br/>\n\ntlmiller - any updates here (or your other condor_ssh_to_job ticket)?\n\n<p></p><hr/>\n<em>2015-Apr-29 15:12:01 by tannenba:</em> <br/>\n\nRelated at all to <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5014\" onclick=\"get_ticket_and_populate_wrapper('5014'); return false;\" title=\"ssh-to-job hangs schedd?\">#5014</a></span> ?\n\n<p></p><hr/>\n<em>2015-Apr-29 15:47:28 by tlmiller:</em> <br/>\n\nThis appears to be unrelated to <span class=\"ticket\"><a class=\"new\" href=\"/wiki-archive/tickets/?ticket=5014\" onclick=\"get_ticket_and_populate_wrapper('5014'); return false;\" title=\"ssh-to-job hangs schedd?\">#5014</a></span>.\n\n<p></p><hr/>\n<em>2015-May-27 13:34:29 by tlmiller:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>This change looks good (since I apparently forgot to write this down earlier).</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-14 14:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1a8935e12ccaaabe115f3d9105773cea385a8f0a\">[44863]</a></span>: Docs for condor_ssh_to_job hang bug fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4997\" onclick=\"get_ticket_and_populate_wrapper('4997'); return false;\" title=\"Infinite loop in condor_ssh_to_job\">#4997</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-14 10:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d4988f5c3c3f7c26d68fd65c55d69f78256fe919\">[44857]</a></span>: Add missing macro for faking poll() on windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4997\" onclick=\"get_ticket_and_populate_wrapper('4997'); return false;\" title=\"Infinite loop in condor_ssh_to_job\">#4997</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-May-13 16:32</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1509f2698a6ffd5bbf42b895e7d434a3606eaac7\">[44848]</a></span>: Fix wait-forever bug when socket closed while waiting to read/write <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4997\" onclick=\"get_ticket_and_populate_wrapper('4997'); return false;\" title=\"Infinite loop in condor_ssh_to_job\">#4997</a></span> When the Selector class is used to wait for a single socket to become available for reading or writing, we use poll() but fail to check for the POLLHUP result, which indicates that the connection has been closed. This can result\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Jun-04 14:48", "status": "resolved", "created": "2015-Apr-09 14:43", "fixed_version": "2015-Apr-09 14:43", "broken_version": "", "priority": "2", "subsystem": "Tools", "assigned_to": "jfrey", "derived_from": "#4490", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "jfrey@cs.wisc.edu tannenba@cs.wisc.edu", "due_date": ""}