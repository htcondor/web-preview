{"id": 7732, "title": "Ticket #7732: Metrics to measure avoidance of repeated drains.", "description": "<blockquote>\nAdded the following attribute to the machine ad to implement the corresponding metrics:\n\n<p></p><ul>\n<li><em>LastDrainStopTime</em>, which records when the last (unix epoch) time when draining stopped (was cancelled), as distinct from the last time draining completed.\n</li></ul>\n\n<p>Added the following attributes to the defrag daemon's ad:\n\n</p><p></p><ul>\n<li><em>RecentDrainsList</em>, which is a list of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> describing the 10 most-recent drain commands sent by the defrag daemon; and\n<ul>\n<li><strong>when</strong> -- the Unix epoch time the command was issued,\n</li><li><strong>who</strong> -- the name of the slot being drained, and\n</li><li><strong>what</strong> -- one of \"graceful\", \"quick\", or \"fast\".\n</li></ul>\n</li><li><em>RecentCancelsList</em>, which is a list of <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ClassAds\" title=\"Class Ads\">ClassAds</a></span> describing the 10 most-recent drains cancel commands sent by the defrag daemon.\n<ul>\n<li><strong>when</strong> -- the Unix epoch time the command was issue,\n</li><li><strong>who</strong> -- the name of the slot whose drain is being cancelled.\n</li></ul>\n</li></ul>\n\n<p>Added the recent_counter_timer stats \"Drain\" to the machine ad, resulting in the usual set of attributes, list below.\n\n</p><p></p><ul>\n<li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentResMgrDrain\" title=\"Recent Res Mgr Drain\">RecentResMgrDrain</a></span>\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentResMgrDrainRuntime\" title=\"Recent Res Mgr Drain Runtime\">RecentResMgrDrainRuntime</a></span>\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResMgrDrain\" title=\"Res Mgr Drain\">ResMgrDrain</a></span>\n</li><li><span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ResMgrDrainRuntime\" title=\"Res Mgr Drain Runtime\">ResMgrDrainRuntime</a></span>\n</li></ul>\n\n<p>These attributes may be read from a startd in the usual ways, including\n\n</p><p></p><div class=\"code\">\n<pre class=\"code\">condor_status -l -statistics ALL:2 -direct &lt;slot-name&gt;\n</pre></div>\n\n\n<p></p><hr/>\n<em>original ticket body</em>\n\n<p>Context: the CHTC uses the default DEFRAG_RANK, which is -ExpectedMachineGracefulDrainingBadput.  If a machine has no jobs, and doesn't get any (because it's been dedicated to a user who's idle right now), it will repeatedly sort to the top of the DEFRAG_RANK.  It would not normally be drained more than once, but the CHTC has DEFGRAG_WHOLE_MACHINE_EXPR constructed in such a way that this machine is never considered \"whole.\"\n\n</p><p>Before we can talk about solving the problem, we need to define (and implement as necessary) some metrics so we can know what success means.\n\n</p><p>We came up three simple metrics during our discussion:\n\n</p><p>(a)  Add an explicit attribute in the machine ad for when a startd most recently finished draining.  (We have <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EnteredCurrentState\" title=\"Entered Current State\">EnteredCurrentState</a></span>, but that's super-obscure.)  To match <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=EnteredCurrentState\" title=\"Entered Current State\">EnteredCurrentState</a></span>, this should include cancellations.\n\n</p><p>(b)  Add an attribute to the machine ad, perhaps using the \"stats\" implementation, for number of \"recent\" drains.\n\n</p><p>(c)  The defrag daemon should record and advertise the last ?? draining commands it issued, specifically when and to whom.\n\n</p><p>Recording draining metrics in both the defrag daemon and the startd allow us to account for manually-issued drain commands.  We don't know right now if the difference between a daemon- and admin- issued drain will be important, so don't distinguish in (a) for now.\n\n</p><p>It would be nice to know, to see if we're draining efficiently, if the job(s) which ran on the just-drained machines would not have run without the draining.  This seems like a rather complicated (and configuration-specific) question to answer directly in one of the daemons, so think about what would be required and how to gather it.</p></blockquote>", "remarks": "<blockquote>\n<em>2020-Jul-21 14:55:26 by tlmiller:</em> <br/>\n\n<strong>EnteredCurrentState</strong> only changes after a drain without auto-resume is cancelled, not when it completes.  We can have <strong>LastDrainStopTime</strong> report when the drain actually stopped (possibly even preserving it against the drain being cancelled), if we feel that would be more useful.\n\n<p></p><hr/>\n<em>2020-Jul-22 16:01:19 by tlmiller:</em> <br/>\n\nI'm making <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentDrainsList\" title=\"Recent Drains List\">RecentDrainsList</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentCancelsList\" title=\"Recent Cancels List\">RecentCancelsList</a></span> reverse-chronological, so that the most recent drain or cancel is always index 0.\n\n<p></p><hr/>\n<em>2020-Jul-24 15:45:28 by tlmiller:</em> <br/>\n\n<div class=\"code\">\n<pre class=\"code\">ResMgrDrain\nResMgrDrainRuntime\nRecentResMgrDrain\nRecentResMgrDrainRuntime\n</pre></div>\n\n\n<p></p><hr/>\n<em>2020-Jul-24 15:49:27 by tlmiller:</em> <br/>\n\nThe ResgMgrDrain* attributes are part of the usual statistics package; I don't know if that's desirable or not.\n\n<p></p><hr/>\n<em>2020-Oct-19 16:18:11 by tannenba:</em> <br/>\n\n<strong>Design Review</strong>\n\n<p>Attribute names seem fine, but would be helpful if the ticket description was updated to reflect what actually got implemented.  Ie I should not have to look at the source code to figure out attributes names, and what bullets in the description ended up as brainstorm future work -vs- actually committed.  Thanks!\n\n</p><p>p.s. instead of literal attribute names sprinkled everywhere, we try to consolidate them into <a class=\"file\" href=\"rlog?f=src/condor_includes/condor_attributes.h\">/src/condor_includes/condor_attributes.h</a>\n\n</p><p></p><hr/>\n<em>2020-Oct-20 16:29:47 by tlmiller:</em> <br/>\n\nThe <code>ResMgr</code> statistics don't generally appear to be document, so I'll pass on doing so as well.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Oct-20 16:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/75c50b8842da9998e89ef81f02ea20621c600412\">[61536]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7732\" onclick=\"get_ticket_and_populate_wrapper('7732'); return false;\" title=\"Metrics to measure avoidance of repeated drains.\">#7732</a></span>) Documentation and a release note.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-24 15:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/156f3e04fae332947815de02b5f363541893aca0\">[60218]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7732\" onclick=\"get_ticket_and_populate_wrapper('7732'); return false;\" title=\"Metrics to measure avoidance of repeated drains.\">#7732</a></span>) Implement draining frequency and timing statistics.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-22 16:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5602fb80c281ed82a1383fd627eca07eacd1ea24\">[60217]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7732\" onclick=\"get_ticket_and_populate_wrapper('7732'); return false;\" title=\"Metrics to measure avoidance of repeated drains.\">#7732</a></span>) Implement <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentDrainsList\" title=\"Recent Drains List\">RecentDrainsList</a></span> and <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=RecentCancelsList\" title=\"Recent Cancels List\">RecentCancelsList</a></span> in the defrag daemon ad.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-21 15:02</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a0169c27b6484af5f0547e7f74c0a3b79a66c4a8\">[60215]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7732\" onclick=\"get_ticket_and_populate_wrapper('7732'); return false;\" title=\"Metrics to measure avoidance of repeated drains.\">#7732</a></span>) Implement <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LastDrainStopTime\" title=\"Last Drain Stop Time\">LastDrainStopTime</a></span>.  (By Todd L Miller )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Oct-20 16:37", "status": "resolved", "created": "2020-Jul-08 14:05", "fixed_version": "2020-Jul-08 14:05", "broken_version": "", "priority": "2", "subsystem": "Daemons", "assigned_to": "tlmiller", "derived_from": "", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tlmiller@cs.wisc.edu, tannenba@cs.wisc.edu, wiscmoate@gmail.com, bbockelman@morgridge.org", "due_date": ""}