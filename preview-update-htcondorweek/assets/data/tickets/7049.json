{"id": 7049, "title": "Ticket #7049: MemoryUsage attribute in Docker Universe jobs ads incorrect", "description": "<blockquote>\nThe <code>MemoryUsage</code> attribute in the job classAd for Docker Universe jobs can be incorrect.  Specifically, it represents the immediate memory usage, and not the maximum memory used.  The result it can end up being set to zero in the job event log and in the history file if HTCondor polls Docker for memory usage after the job completes and the container is shutting down or output files are being transferred.\n\n<p>This ticket patches this problem surgically for the stable series, by have the shadow take the max of the <code>MemoryUsage</code> attribute from the starter update ad if it is a literal (which is the case for Docker universe).  For the developer series, we should clean up the cooking of the update ad so that the starter always sends raw values which are then cooked/aggregated in the shadow and startd.\n\n</p><p>This issue reported by CHTC in CHTC RT 97188.  Thank you to Graham Banes for reporting the issue.</p></blockquote>", "remarks": "<blockquote>\n<em>2019-May-13 15:41:05 by johnkn:</em> <br/>\n\n<strong>CODE_REVIEW</strong> : change looks good.</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7527\" onclick=\"get_ticket_and_populate_wrapper('7527'); return false;\" title=\"MemoryUsage in Docker Universe does not show maximum observed\">#7527</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MemoryUsage\" title=\"Memory Usage\">MemoryUsage</a></span> in Docker Universe does not show maximum observed</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-14 10:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b224328db55c944a9f57877089ac0bf85b4b863\">[60124]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7207\" onclick=\"get_ticket_and_populate_wrapper('7207'); return false;\" title=\"Disk High Watermark not recorded in history\">#7207</a></span>) Duplicate the fix from <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7049\" onclick=\"get_ticket_and_populate_wrapper('7049'); return false;\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span> for disk usage, as well. Note that the CPU usage attributes don't end in 'Usage', so we shouldn't have to fix this again.  (By Todd L Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-16 18:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8b30e7d94897d372e532b3071a090ea0dcc1a562\">[59167]</a></span>: fix patch in <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7049\" onclick=\"get_ticket_and_populate_wrapper('7049'); return false;\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span> to shadow keep max memusage for docker universe. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7527\" onclick=\"get_ticket_and_populate_wrapper('7527'); return false;\" title=\"MemoryUsage in Docker Universe does not show maximum observed\">#7527</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-12 06:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7441e94cd91fe547bfbb524812c6c9e79c19b5ae\">[56866]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7049\" onclick=\"get_ticket_and_populate_wrapper('7049'); return false;\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span>) Really fix the merge  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-12 06:16</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1e77dad84c8efa283c07b90b0ee6a428d91e18d8\">[56865]</a></span>: (<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7049\" onclick=\"get_ticket_and_populate_wrapper('7049'); return false;\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span>) Fixup merge to master  (By Tim Theisen )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-10 14:42</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b6cac93dfeb3fff7a6566100628a77cc40abd1d5\">[56851]</a></span>: Version history blurb for bug fix <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7049\" onclick=\"get_ticket_and_populate_wrapper('7049'); return false;\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2019-May-10 14:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/865e2ca3716a63575f8cc7ac97d051bd5c819da9\">[56849]</a></span>: Fix <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MemoryUsage\" title=\"Memory Usage\">MemoryUsage</a></span> job attribute to be the max value seen. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7049\" onclick=\"get_ticket_and_populate_wrapper('7049'); return false;\" title=\"MemoryUsage attribute in Docker Universe jobs ads incorrect\">#7049</a></span> This fixes a bug in Docker Universe, where the starter was sending over literal values for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=MemoryUsage\" title=\"Memory Usage\">MemoryUsage</a></span> in the update ad which were not maxed.  (By Todd Tannenbaum )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2019-May-16 11:33", "status": "resolved", "created": "2019-May-10 14:35", "fixed_version": "2019-May-10 14:35", "broken_version": "v080502", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "tannenba", "derived_from": "#5456", "creator": "tannenba", "rust": "", "customer_group": "chtc", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}