{"id": 6625, "title": "Ticket #6625: X509_USER_PROXY not set properly for singularity jobs", "description": "<blockquote>\nWhen the config param SINGULARITY_TARGET_DIR is used to mount the starter's job scratch directory in the singularity container of the job, the starter updates the job environment variables that it sets so that they refer to the location of the scratch directory within the container. X509_USER_PROXY isn't being updated but it should be.\n\n<p>Proposed solution: If X509_USER_PROXY points to a file that's under the starter's scratch directory, it should be rewritten like the other environment variables. Otherwise, it should be left alone.\n\n</p><p>First <a class=\"external\" href=\"https://www-auth.cs.wisc.edu/lists/htcondor-users/2018-March/msg00131.shtml\">reported in htcondor-users</a>.</p></blockquote>", "remarks": "<blockquote>\n<em>2018-Mar-27 15:02:57 by tpdownes:</em> <br/>\n\nPlease ensure that your solution is compatible with whatever development path is chosen for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6587\" onclick=\"get_ticket_and_populate_wrapper('6587'); return false;\" title=\"proxy delegation without file transfer\">#6587</a></span>\n\n<p></p><hr/>\n<em>2018-Mar-27 17:22:31 by tannenba:</em> <br/>\n\nLooks to me like we need to add code to deal with updating the x509 environment variable in the starter <a class=\"external\" href=\"https://github.com/htcondor/htcondor/blob/master/src/condor_starter.V6.1/singularity.cpp#L202-L211\">here</a>.\n\n<p></p><hr/>\n<em>2018-Mar-28 13:59:23 by gthain:</em> <br/>\n\n<strong>CODE REVIEW</strong>  As per our discussion, looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-28 10:28</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/41885d41673b29e79624fd70580e7889d3d373ef\">[54590]</a></span>: Docs for updating X509_USER_PROXY for a singularity container. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6625\" onclick=\"get_ticket_and_populate_wrapper('6625'); return false;\" title=\"X509_USER_PROXY not set properly for singularity jobs\">#6625</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2018-Mar-28 10:23</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c1963c45f386ff052f56332aa58099993a769174\">[54589]</a></span>: Update X509_USER_PROXY for singularity jobs. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=6625\" onclick=\"get_ticket_and_populate_wrapper('6625'); return false;\" title=\"X509_USER_PROXY not set properly for singularity jobs\">#6625</a></span> When using SINGULARITY_TARGET_DIR to bind mount the job scratch directory into the singularity container, if the job has a proxy in the scratch directory, rewrite X509_USER_PROXY in the job's environment to point at the proxy's location inside the container.\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2018-Mar-28 13:59", "status": "resolved", "created": "2018-Mar-27 14:31", "fixed_version": "2018-Mar-27 14:31", "broken_version": "v080508", "priority": "3", "subsystem": "DaemonsExecNode", "assigned_to": "gthain", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "users", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}