{"id": 4406, "title": "Ticket #4406: cream_gahp crashes under load", "description": "<blockquote>\nWe have reports from multiple sources that the cream_gahp crashes frequently when used to managed more than a handful of jobs. The GlideinWMS folks at UCSD say this has been a problem since at least 8.0.x, but didn't prevent them from running the number of jobs they needed because the cream_gahp is stateless and was automatically restarted by HTCondor whenever it crashed.\n\n<p>The problem is that the cream_gahp creates multiple worker threads to perform CREAM commands in parallel. But the Globus libraries were never told that multiple threads are in use. Thus, they optimize mutex lock/unlock into noops. In particular, they set OpenSSL's locking callback to a noop.</p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jun-19 10:52:01 by jfrey:</em> <br/>\n\nHaving only one worker thread fixes the crashes for GlideinWMS. I'm now testing a fix with multiple worker threads and setting the Globus thread model to \"pthread\", so that it actually does pthread operations.\n\n<p></p><hr/>\n<em>2014-Jun-19 15:10:07 by jfrey:</em> <br/>\n\nGlobus and gsoap initialization functions for setting up threads and openssl need to be called from the main thread before any other threads are created.\n\n<p></p><hr/>\n<em>2014-Jun-25 08:44:16 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Bad: allocates memory based on worker_cnt and then updates worker count to new value.\n\n<p></p><hr/>\n<em>2014-Jun-25 10:07:17 by tannenba:</em> <br/>\n\nIssues in code review addressed in derived ticket....</blockquote>", "derived_tickets": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4416\" onclick=\"get_ticket_and_populate_wrapper('4416'); return false;\" title=\"Cream gahp may allocate insufficient memory for threads\">#4416</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\nCream gahp may allocate insufficient memory for threads</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">\n<span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4440\" onclick=\"get_ticket_and_populate_wrapper('4440'); return false;\" title=\"cream_gahp fails at startup due to lt_dlopen() search path\">#4440</a></span></td>\n<td align=\"center\" valign=\"center\" width=\"30\">\n<span class=\"icon ptr1\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\">\ncream_gahp fails at startup due to lt_dlopen() search path</td></tr>\n</tbody></table>", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-19 15:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1a3e87c856874bb3f271d37dad375efaef73a388\">[40478]</a></span>: Version history for cream_gahp crash fix. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4406\" onclick=\"get_ticket_and_populate_wrapper('4406'); return false;\" title=\"cream_gahp crashes under load\">#4406</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-19 15:30</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f47fa3d9918be10159f3e51e4ca0660e5ed3ffca\">[40477]</a></span>: Make number of cream_gahp worker threads configurable. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4406\" onclick=\"get_ticket_and_populate_wrapper('4406'); return false;\" title=\"cream_gahp crashes under load\">#4406</a></span> CREAM_GAHP_WORKER_THREADS can be set in the config file or the environment to set the number of worker threads created by the cream_gahp. The default remains 6, as before.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jun-19 15:27</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4a5791a90f236d3d0b4c674e6ac5462d701ae88c\">[40476]</a></span>: Ensure thread safety for Globus and OpenSSL in cream_gahp. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4406\" onclick=\"get_ticket_and_populate_wrapper('4406'); return false;\" title=\"cream_gahp crashes under load\">#4406</a></span> Since we're creating multiple worker threads in the cream_gahp, we need to call certain initialization functions for Globus and gsoap in the main thread before any new threads are created. Otherwise, OpenSSL and Globus functions/data are\u00a0[...]\n (By Jaime Frey )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2014-Jun-25 10:07", "status": "resolved", "created": "2014-Jun-19 10:51", "fixed_version": "2014-Jun-19 10:51", "broken_version": "v080000", "priority": "1", "subsystem": "Grid", "assigned_to": "jfrey", "derived_from": "", "creator": "jfrey", "rust": "", "customer_group": "cern", "visibility": "public", "notify": "tannenba@cs.wisc.edu", "due_date": ""}