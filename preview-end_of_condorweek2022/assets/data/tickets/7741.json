{"id": 7741, "title": "Ticket #7741: Merge OAuth Credmon", "description": "<blockquote>\nNow that the code has matured and because upgrading with a separate credmon package is annoying (at best), let's merge the OAuth Credmon in to the main source tree and release it as a condor package.\n\n<p>To do:\n</p><ol>\n<li>Merge code under <code>src/condor_credd/condor_credmon_oauth</code>\n</li><li>Merge examples under <code>src/condor_examples</code>\n</li><li>Figure out how we want to run library code shared between the WSGI application and <code>condor_credmon_oauth</code> (put in <code>libexec</code> and modify <code>PYTHONPATH</code>?)\n</li><li>Add <code>CMakeLists.txt</code>\n</li><li>Update RPM/DEB specs\n</li></ol>\n\n<p><a class=\"external\" href=\"https://docs.google.com/document/d/1HQyfKIcG2Y209GgpdkhCzaZ2uMuWNMPCYkTmbxzwMcY/edit?usp=sharing\">Link to design doc</a></p></blockquote>", "remarks": "<blockquote>\n<em>2020-Aug-17 09:11:23 by jpatton:</em> <br/>\n\nThe code has been merged into <code>master</code> now, the biggest caveat right now being that it's only natively packaged in CentOS 7 (as \"condor-credmon-oauth\"). The necessary scripts and examples to get it running are still in the tarball (mostly under <code>$(LIBEXEC)</code>), at least with how we generate the tarball now.\n\n<p>Next steps are to document and figure out how to package for other systems. The latter will require figuring out how to test the credmon using Python 3.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-23 14:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c558257028dec7157e84744ec73ac5a1c0c00ec6\">[61331]</a></span>: Fix a couple of bugs related to the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=LocalCredmon\" title=\"Local Credmon\">LocalCredmon</a></span> <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Sep-09 06:59</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4982bc9ed7e95d1d392b3f99f8b63abe3a1c1be2\">[61244]</a></span>: Add a ton of credmon docs for <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-31 10:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/06f05eb8abefa7f08564cb04a93fff7d981576cd\">[61172]</a></span>: Fix stalled oauth credmon after condor_off <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span> The subprocess that held the scan_tokens loop now returns when SIGTERM/SIGINT/SIGQUIT is caught by the parent process rather than keep running and keeping the parent process alive.\u00a0[...]\n (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-28 07:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f87c34050d0efaa961b2740541ee3f94806a93f4\">[61141]</a></span>: Fix credmon to work with Python 3 <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-25 07:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/85f7b1bbc87b55becf4e64bf4b1248d236644a42\">[60525]</a></span>: Fix OAuthCredmonWebserver for newer requests-oauthlib <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-17 08:54</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/191c8424e25bdf6fdd9d4c488025e32433691f08\">[60466]</a></span>: Merge the <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=SciTokens\" title=\"Sci Tokens\">SciTokens</a></span> OAuth <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=CredMon\" title=\"Cred Mon\">CredMon</a></span> into HTCondor <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span> - Currently hardcoded to use Python 2 in the daemon scripts - Shared Python code is now stored in $(LIBEXEC)/credmon - Daemon scripts are now installed to $(SBIN) - RPM (builds on CentOS 7 only at the moment) is called \"condor-credmon-oauth\" - RPM\u00a0[...]\n (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-14 14:04</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/19f194727e41346308900146a07e22ca5a4cde07\">[60461]</a></span>: Typoed the version comparison <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-14 11:40</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b64d27456ea83afa6ce1fb0d0f9775d09cc4c313\">[60459]</a></span>: Remove oauth credmon from buildroot for non-EL7 <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-14 06:53</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/15de151f190cb47fa9150f9669a8ba92b620acae\">[60449]</a></span>: Don't move files to buildroot unless packaging <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-13 15:26</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4addc766d137412a9719a0bb9f1b6f970eeafa93\">[60448]</a></span>: Force python2 in shebang for condor_credmon_oauth for now <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-13 07:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/01ab7c16b1d8db23daca8d1fee6f5ffc72241ddc\">[60445]</a></span>: More package naming fixes <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-13 07:50</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8c6fdccf8eeef69131a9152e8c167313e9fb0d23\">[60444]</a></span>: Do not use -n for credmon package <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-13 07:48</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5284933679be55f67bf0cd4f19bde2073556f842\">[60443]</a></span>: Fix ordering of symlink args <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-13 06:33</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/917aa25dff418fe682968e5898fc30e5e9d9101d\">[60442]</a></span>: Point symlinks to installed paths, not buildroot <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 10:47</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d3e5bee097a528827c45821c1703511e24e8c0ae\">[60434]</a></span>: Fix another typo <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-12 08:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/a51a94ef2768d6f636458a2590a96fa27a8f5c1d\">[60432]</a></span>: Fix example directory path <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-11 16:21</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89d6173badbb996f973538bec33476c29ba7ed77\">[60423]</a></span>: Standardize credmon naming and support previous configs <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span> - Dropped scitokens and other naming of files (except for local issuer) in favor of \"condor_credmon_oauth\" everywhere. - Updated SRPM spec to support previous configurations of the credmon  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-04 07:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/759709242c4e8aff69519a66d31148b8d0931886\">[60332]</a></span>: Fix rpm spec <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-04 07:15</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/15ca5cb7db7693e562b9ca7f81669aebef4d5ff0\">[60331]</a></span>: Fix cmake/rpm spec <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-04 05:41</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/338bc74e6536afc01b9e946c4225d753fd201e28\">[60329]</a></span>: Remove redundant oauth credmon spec file <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-03 07:38</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b59c9335a3cff6cf56ac49038b69cf0888e58a04\">[60307]</a></span>: Add condor-credmon-oauth to RPM <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span> Created new RPM package: condor-credmon-oauth This package installs: - the Python credmon package into LIBEXEC - the WSGI script into /var/www/wsgi-scripts/scitokens-credmon - the credmon script into SBIN - a readme file into /var/lib/condor/oauth_credentials/README.credentials\u00a0[...]\n (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-03 06:55</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4544b7b3bac2a53cc46482c838b0eed8a2a4e9f6\">[60306]</a></span>: Update example credmon config to use metaknob <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Aug-03 06:36</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b26bf9ca8fefa2fff015d9f3a078d63b991b4e07\">[60304]</a></span>: Install oauth credmon, use libexec <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span> Added CMakeLists.txt to install condor_credmon_oauth and scitokens_credential_producer to SBIN and put everything else in LIBEXEC. Updated Python scripts to use credmon library out of LIBEXEC.  (By Jason Patton )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Jul-20 16:12</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/af6df31d0d3b07d611643372aabbb8700610efea\">[60158]</a></span>: Initial copy of oauth credmon into src <span class=\"ticket\"><a class=\"docpending\" href=\"/wiki-archive/tickets/?ticket=7741\" onclick=\"get_ticket_and_populate_wrapper('7741'); return false;\" title=\"Merge OAuth Credmon\">#7741</a></span>  (By Jason Patton )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2020-Oct-12 14:47", "status": "docpending", "created": "2020-Jul-20 07:32", "fixed_version": "2020-Jul-20 07:32", "broken_version": "", "priority": "3", "subsystem": "DaemonsSubmitNode", "assigned_to": "zmiller", "derived_from": "", "creator": "jpatton", "rust": "", "customer_group": "scitokens", "visibility": "public", "notify": "", "due_date": ""}