{"id": 4453, "title": "Ticket #4453: Improve scalability of CCB", "description": "<blockquote>\nThere are three somewhat-wacky things we do in the CCB that could be improved:\n\n<p></p><ol>\n<li>CCB has a timer which, when fires, calls select() individually on every socket for every target.  10,000 targets connected?  That's 10,000 invocations of select().  DanB left a message saying that, because CCB has so many targets registered, we keep things out of DC.  Instead, we can register a single epoll FD with DC and add all the targets to the epoll watch for an O(1) operation.\n\n<p></p></li><li>CCB blocks on reading off the initial CEDAR message.  This is similar to what we've hit before - if we change readReady for <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=ReliSocks\" title=\"Reli Socks\">ReliSocks</a></span> to reflect whether there is a CEDAR message to read instead of bytes on the sock, then we should only invoke the registered callback when a complete message has arrived.  This should greatly decrease the chance we block on the network in the CCB.\n\n<p></p></li><li>When we read from a socket, we typically call select() with one file descriptor in order to have the desired timeout behavior.  The runtime of select is a function of the largest passed file descriptor number.  If we switch to poll for this situation (relatively unobtrusive change), the runtime is O(1).\n</li></ol>\n\n<p>Branch posted: <a class=\"external\" href=\"https://github.com/bbockelm/htcondor/tree/ccb_epoll\">https://github.com/bbockelm/htcondor/tree/ccb_epoll</a></p></blockquote>", "remarks": "<blockquote>\n<em>2014-Jul-24 11:05:25 by bbockelm:</em> <br/>\n\nReview was done on the phone with Jaime.  Merged this.\n\n<p></p><hr/>\n<em>2014-Jul-29 14:24:20 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>* The two variants of Selector::set_timeout() now behave differently\nwith respect to using poll() and a timeout with sub-second granularity.\nThey should behave the same.\n\n</p><p>* Why the addition of USE_POLL in the Selector files? I'd prefer a more\nspecific name for a macro defined in selector.h, like SELECTOR_USE_POLL.\nI don't like defining dummy poll macros and structs in the Selector\nheader file. I'd prefer that to be confined to selector.cpp and not\naffect other source files that include selector.h.\n\n</p><p>* I don't like the trickery of the epoll fd masquerading as a pipe to\ndaemon-core. But I also don't want to add an array for yet another type\nof handler in daemon-core just for this one use.\n\n</p><p>* This is in the existing code, but I hate that for the object named\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BlockingModeGuard\" title=\"Blocking Mode Guard\">BlockingModeGuard</a></span>, a value of true means non-blocking. That's backwards.\nThe meaning should be reversed or there should be an enum or typedef\nthat provides more explicit names (like <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=BlockingMode\" title=\"Blocking Mode\">BlockingMode</a></span> and\n<span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=NonBlockingMode\" title=\"Non Blocking Mode\">NonBlockingMode</a></span>).\n\n</p><p></p><hr/>\n<em>2014-Jul-29 15:09:44 by jfrey:</em> <br/>\n\n<strong>Code Review (cont.)</strong>\n\n<p>Coverity found another issue:\n\n</p><p>* In Selector::execute(), if a timeout hasn't been set, then the poll() call will dereference a NULL pointer when computing the timeout value. The fix is to pass a negative value to poll() when tp is NULL.\n\n</p><p></p><hr/>\n<em>2014-Aug-01 09:44:43 by bbockelm:</em> <br/>\n\nOk, review items are fixed and things check out in batlab.  Closing ticket; Jaime, feel free to reopen if there's something I missed.\n\n<p></p><hr/>\n<em>2014-Aug-04 11:07:33 by jfrey:</em> <br/>\n\n<strong>Code Review</strong>\n\n<p>Your changes look good.</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-20 13:06</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/33ea67eff6077725ed61186ce92163e0757c8813\">[41000]</a></span>: add 8.3.1 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-06 15:24</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/4d8698e92d24387b652bc2f7dd7510fb8cfaf403\">[40868]</a></span>: Fix badly-placed variable declarations in InitAndReconfig(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Aug-06 13:56</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c98d1290df628fcc8e953950ca0d3c866ed40102\">[40867]</a></span>: Fix creation of epoll fd in CCBServer::InitAndReconfig(). <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span> Don't create a new epoll fd on reconfig. Fix error detection and handling when creating the epoll fd.  (By Jaime Frey )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-31 20:52</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2d74e5e904f69dcbbeb6eecae9f15cc27d3ca79b\">[40820]</a></span>: Fix issues from review. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-23 21:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c40526dc1874d3242cbe9049efeaf93dac0937b4\">[40746]</a></span>: Allow single-shot mode to include multiple events. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-22 09:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1ff957dd6c1320e6932c74fed4f06810cd9104c5\">[40743]</a></span>: Stub out poll for windows. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-21 20:35</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/45c695d2b48a7cef2dd0ddbc4dae694f7c8b1717\">[40742]</a></span>: Fix constant not defined on RHEL5. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-21 20:20</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/e07598365973500573a29527bce8cc239e43d059\">[40741]</a></span>: Merged <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/295c78963c50be7d9e85bd1cfa1f45286556a9ce\">[40584]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d29055f0a088b05e9f03bd2670174516aeb499ae\">[40585]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5fc346e427e398ae66a6b1818bc55577ac3712f7\">[40586]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/61fa66f9a4cfe712321864ce7e286ed4b5e4ec82\">[40587]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ada38cc01877cf33dcb6803e7724337beba0a549\">[40589]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/975720ed59fa09593fe63eea9dda80e2cc8bc18a\">[40593]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/830fa0c48eecf9a1d2b302fc73cc2a83dcae3d28\">[40594]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f9d5376911bd75b7a49f6f5447d4e5193698a40b\">[40596]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2720e9d47bca6f4145d50a3fd0dd679842a3c5c6\">[40598]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/b364c74307b108fef9e9b1277c22a7c51bd0e867\">[40601]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/c6645446bda914f28eaaf581d5d7176350cde7fa\">[40602]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/0f7d567080c57b35adbe4191b75561fb310ed005\">[40612]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/74ff7ac52f3325831aa895128fa5bd649580a756\">[40613]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bdd4c29e3fc29f3bd24ece3c2913089011c38f1c\">[40615]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/646dea8b9b528497d888063eb36d8906df8df4fc\">[40622]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/dfd19c5faf27012f8977551a52b727f1299b954b\">[40623]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/bb521e7ecf62daa5ee45d35351b679feaaf14c27\">[40624]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/f47b432db7e485cce8089c8b51950ea69f6a9af9\">[40626]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/89aae5f78bf36883f576be9b08906df4bcb035dd\">[40627]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/7f858a84745f184395f642b920eac4c02195c516\">[40633]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/1030c7b4f1c9f0ccbeae80750e71f29b2754ed64\">[40635]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/8cb6b9c3c75b1c2a4235284e45db512b5ceee6e3\">[40644]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/ecb2faa8ec29196c3e158094c39f44b274b6bbd6\">[40647]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/994c6a75aecb6bdb49b8a8973dea8ac95027c53c\">[40651]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/d0b33f1d040d6c8dbf8447c50b19c74dfffc5bb5\">[40665]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3e96c37b4cf1e053033c0ad28a42028da263bcc5\">[40666]</a></span>, <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/afe3f0233a8244d582cac2319c707df350b7c72b\">[40667]</a></span>, Merge branch 'master' into ccb_epoll. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>\u00a0[...]\n (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2014-Jul-09 20:09</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2cf19801b66a8396b39e1335779d70cfad7bbfeb\">[40740]</a></span>: Still call <span class=\"wiki\"><a class=\"missing\" href=\"wiki?p=PollSockets\" title=\"Poll Sockets\">PollSockets</a></span> so we sweep reconnect info when in epoll mode. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=4453\" onclick=\"get_ticket_and_populate_wrapper('4453'); return false;\" title=\"Improve scalability of CCB\">#4453</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "enhance", "last_change": "2014-Sep-08 13:46", "status": "resolved", "created": "2014-Jul-09 14:35", "fixed_version": "2014-Jul-09 14:35", "broken_version": "", "priority": "3", "subsystem": "CCB", "assigned_to": "bbockelm", "derived_from": "", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "bbockelm@cse.unl.edu, tannenba@cs.wisc.edu", "due_date": ""}