{"id": 7360, "title": "Ticket #7360: macro default does not allow - character and workaround is broken", "description": "<blockquote>\nMichael Pelletier reports: \"The following leaves the trailing \")\" at the end of the BASENAME macro's output when expanding.\"\n\n<p></p><div class=\"code\">\n<pre class=\"code\">IMAGE_FILE = $(IMAGE_FILE:/user/1127883/DOCKER/singularity/c5-tf-container.simg)\nIMAGE_BASE = $BASENAME(IMAGE_FILE)\n\nMY.ImageBasename = \"$(IMAGE_BASE)\"\n\nhold = true\n\nexecutable = /bin/sleep\narguments = $(IMAGE_BASE)\n\nqueue\n</pre></div>\n\n<div class=\"code\">\n<pre class=\"code\">:!condor_q 29243 -af args ImageBasename\nc5-tf-container.simg)\nc5-tf-container.simg)\n</pre></div>\n</blockquote>", "remarks": "<blockquote>\n<em>2020-Mar-09 16:12:08 by johnkn:</em> <br/>\n\nThe problem here is that IMAGE_FILE is not self-substituting in the first line\nso it's value ends up being <div class=\"code\">\n<pre class=\"code\">$(IMAGE_FILE:/user/1127883/DOCKER/singularity/c5-tf-container.simg)</pre></div>\n\nwhich looks to the <code>$BASENAME</code> function like file with a URL prefix of <code>$(IMAGE_FILE:</code> and a file extension of <code>.simg)</code>\n\n<p>It turns out the actual problem here is the use of - in the filename.  This is not a legal character to follow the : in the $(name:default) pattern, the use of - causes the parser to skip over the entire $() expansion thinking that it is not actually a $() expansion.\n\n</p><p>There is an intended work-around </p><div class=\"code\">\n<pre class=\"code\">DEF_IMAGE=/user/1127883/DOCKER/singularity/c5-tf-container.simg\nIMAGE_FILE=$(IMAGE_FILE:$(DEF_IMAGE))</pre></div>\n\n\n<p>But there is a bug that prevents that from working.\n\n</p><p>For now, your workaround should be </p><div class=\"code\">\n<pre class=\"code\">if !defined IMAGE_FILE\n  IMAGE_FILE = /user/1127883/DOCKER/singularity/c5-tf-container.simg\nendif</pre></div>\n\n<hr/>\n<em>2020-Apr-10 07:42:27 by tim:</em> <br/>\n\nBulk change of target version from v080808 to v080809 using ticket-target-mover.\n\n<p></p><hr/>\n<em>2020-May-06 12:17:52 by tim:</em> <br/>\n\n<strong>CODE REVIEW:</strong> Looks good.</blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Apr-21 12:03</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/aaa85b7edad7854308d925d88a799982217e2bfa\">[59431]</a></span>: version history for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7553\" onclick=\"get_ticket_and_populate_wrapper('7553'); return false;\" title=\"Collector can hang when a port scanner probes it\">#7553</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7521\" onclick=\"get_ticket_and_populate_wrapper('7521'); return false;\" title=\"p-slot child rollup should contain evaluated d-slot values\">#7521</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7542\" onclick=\"get_ticket_and_populate_wrapper('7542'); return false;\" title=\"SLOT_TYPE_N configuration works START, not for RANK, etc\">#7542</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7605\" onclick=\"get_ticket_and_populate_wrapper('7605'); return false;\" title=\"condor_gpu_discovery crashes on PowerPC\">#7605</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7360\" onclick=\"get_ticket_and_populate_wrapper('7360'); return false;\" title=\"macro default does not allow - character and workaround is broken\">#7360</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7591\" onclick=\"get_ticket_and_populate_wrapper('7591'); return false;\" title=\"preempting claim in a GPU slot attempts to add another GPU and fails\">#7591</a></span>, <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7479\" onclick=\"get_ticket_and_populate_wrapper('7479'); return false;\" title=\"MAX_PROCD_LOG does not honor units suffix\">#7479</a></span>  (By John (TJ) Knoeller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2020-Mar-10 15:07</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/25fa172877bd1a6b69ed270db8a91ea5df1a1f3a\">[59122]</a></span>: for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=7360\" onclick=\"get_ticket_and_populate_wrapper('7360'); return false;\" title=\"macro default does not allow - character and workaround is broken\">#7360</a></span>, fix bug where $(foo:$(bar)) is not recognised as a $() expansion, and thus does not expand  (By John (TJ) Knoeller )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2020-May-06 12:18", "status": "resolved", "created": "2019-Nov-06 11:37", "fixed_version": "2019-Nov-06 11:37", "broken_version": "v080800", "priority": "2", "subsystem": "", "assigned_to": "johnkn", "derived_from": "", "creator": "tim", "rust": "s99005", "customer_group": "support", "visibility": "public", "notify": "michael.v.pelletier@raytheon.com", "due_date": ""}