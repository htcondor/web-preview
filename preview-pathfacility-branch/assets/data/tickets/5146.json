{"id": 5146, "title": "Ticket #5146: MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint", "description": "<blockquote>\nWe are seeing severe priority inversion on some CMS schedds under load.  It's taking ~45 seconds for condor_submit to get to the schedd, despite the fact that there's a DC cycle every 200ms or so.\n\n<p>Looking into the issue, it appears to be because MAX_ACCEPTS_PER_CYCLE is not respected when shared_port is in use.\n\n</p><p>This is priority inversion because new sockets (condor_submit) are at a pretty significant disadvantage compared to others.  I'd like all clients to be considered equally (here, I mean 'one callback processed per duty cycle on ready sockets').</p></blockquote>", "remarks": "<blockquote>\n<em>2015-Jul-14 15:26:16 by tannenba:</em> <br/>\n\nTo achieve what you want, could you just set MAX_ACCEPTS_PER_CYCLE=1 ? ;-)\n\n<p>But I agree the shared_port_endpoint should honor MAX_ACCEPTS_PER_CYCLE, thanks for the patch!\n\n</p><p>Re the patch, looks like the loop logic needs a quick change to honor the knob semantics  - documentation that says if MAX_ACCEPTS_PER_CYCLE has value of zero or less, it means no limit.\n\n</p><p>Please post the results of your before/after observations and tests as remarks to this ticket.  Ie with the same workload, schedd was taking ~45 seconds per submit, after change ~X seconds.  Assuming the testing and before/after observations look good, please merge for inclusion into v8.3.8.\n\n</p><p>Final comment - as these are all developer tuning knobs, it may be interesting for our own benchmarking/experimentation purposes to have a SHARED_ENDPOINT_MAX_ACCEPTS_PER_CYCLE knob that, if defined, overrides MAX_ACCEPTS_PER_CYCLE in the shared_port endpoint code.\n\n</p><p></p><hr/>\n<em>2015-Jul-15 10:16:40 by bbockelm:</em> <br/>\n\nI did some performance tests last night.\n\n<p>At the worst, the schedd took 8 minutes to respond to <code>condor_q -const false</code>; the negotiator timed out waiting on response for every negotiation cycle (negotiation timeout is set to 10).  The average was somewhere in the 30s range.\n\n</p><p>After the change, the average query time when using <code>condor_shared_port</code> was &lt;5 seconds (identical performance to using the TCP port opened for the shadows).</p></blockquote>", "derived_tickets": "", "attachments": "<html><head></head><body></body></html>", "check_ins": "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody><tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-06 11:58</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/90ff855d4246342e4594deaef0ff4871d88f1166\">[45496]</a></span>: edit 8.3.8 version history item <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span>  (By Karen Miller )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 17:51</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/25a743a01ab83ccace7247c7ead648aacc52b28c\">[45483]</a></span>: Added version history blurb for <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/5c57898016e4885cef72da9722127634df7d863a\">[45482]</a></span>: Fix param-table shared-port bug for MAX_ACCEPTS_PER_CYCLE. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/23f3f5d885054b4e33783b474c3ac5dfa3b2a9c7\">[45481]</a></span>: Address code-review comments. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span> - Move param-table interaction to reconfig. - Introduce SHARED_ENDPOINT_MAX_ACCEPTS_PER_CYCLE, which takes precedence over MAX_ACCEPTS_PER_CYCLE. Committer: Todd Tannenbaum  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 17:43</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/2167ea318b8564b11e0338e3899793f9423fdec3\">[45480]</a></span>: Implement MAX_ACCEPTS_PER_CYCLE for shared port endpoints. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span> Committer: Todd Tannenbaum  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 17:25</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/3dc4a5a92bd785f99781dec3ccb63a2a39d9ef99\">[45479]</a></span>: Added version history blurb. No other documentation is needed. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span> Specifically we do not need to document knob SHARED_ENDPOINT_MAX_ACCEPTS_PER_CYCLE because it is just for use by developers for tuning purposes.  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Aug-05 17:10</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/470cd6089f317b49412a5797fb628f6acf574614\">[45478]</a></span>: Fix param-table shared-port bug for MAX_ACCEPTS_PER_CYCLE. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span>  (By Todd Tannenbaum )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-15 10:01</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/14141734156b5583e1c9f2346968817388f2e0ce\">[45307]</a></span>: Address code-review comments. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span> - Move param-table interaction to reconfig. - Introduce SHARED_ENDPOINT_MAX_ACCEPTS_PER_CYCLE, which takes precedence over MAX_ACCEPTS_PER_CYCLE.  (By Brian Bockelman )</td></tr>\n<tr><td align=\"right\" valign=\"top\" width=\"160\">2015-Jul-14 11:13</td>\n<td align=\"center\" valign=\"top\" width=\"30\">\n<span class=\"icon dot\">\u00a0</span></td>\n<td align=\"left\" valign=\"top\"> \nCheck-in <span class=\"chng\"><a href=\"https://github.com/htcondor/htcondor/commit/fe855fad9f50f4c6150e954c1061de3ad665be67\">[45299]</a></span>: Implement MAX_ACCEPTS_PER_CYCLE for shared port endpoints. <span class=\"ticket\"><a class=\"resolved\" href=\"/wiki-archive/tickets/?ticket=5146\" onclick=\"get_ticket_and_populate_wrapper('5146'); return false;\" title=\"MAX_ACCEPTS_PER_CYCLE not respected by shared port endpoint\">#5146</a></span>  (By Brian Bockelman )</td></tr>\n</tbody></table>", "type": "defect", "last_change": "2015-Aug-05 17:54", "status": "resolved", "created": "2015-Jul-14 09:31", "fixed_version": "2015-Jul-14 09:31", "broken_version": "v080200", "priority": "2", "subsystem": "DaemonSharedP", "assigned_to": "tannenba", "derived_from": "#5162", "creator": "bbockelm", "rust": "", "customer_group": "cms", "visibility": "public", "notify": "gthain@cs.wisc.edu tannenba@cs.wisc.edu bbockelm@cse.unl.edu tim@cs.wisc.edu", "due_date": ""}